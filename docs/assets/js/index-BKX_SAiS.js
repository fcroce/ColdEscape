const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/kernelBlur.fragment-DBgXQgrZ.js","assets/js/kernelBlurVaryingDeclaration-DOL0jmdb.js","assets/js/kernelBlur.vertex-CvUNVGTR.js","assets/js/kernelBlur.fragment-DM8Kv_4_.js","assets/js/kernelBlurVaryingDeclaration-C75ijuk-.js","assets/js/kernelBlur.vertex-C9g5aE1A.js","assets/js/EXT_lights_image_based-BXtXbwmT.js","assets/js/glTFLoader-B7_AMTvd.js","assets/js/glTFLoaderAnimation-DQnBhtdO.js","assets/js/EXT_mesh_gpu_instancing-BdK1RPxx.js","assets/js/EXT_meshopt_compression-BY1gvITJ.js","assets/js/EXT_texture_avif-BWQDy1I2.js","assets/js/EXT_texture_webp-BLxzoyPr.js","assets/js/KHR_animation_pointer-BY_XIjyS.js","assets/js/gltfPathToObjectConverter-CGviXP77.js","assets/js/KHR_draco_mesh_compression-DdOCu7Ee.js","assets/js/KHR_interactivity-Bpa1RbAP.js","assets/js/KHR_lights_punctual-DKo7P0M-.js","assets/js/KHR_materials_anisotropy-O_NWomUV.js","assets/js/KHR_materials_clearcoat-B10mzFrn.js","assets/js/KHR_materials_diffuse_transmission-CWTqM16l.js","assets/js/KHR_materials_dispersion-a-0dUGc7.js","assets/js/KHR_materials_emissive_strength-D8T7E2Vt.js","assets/js/KHR_materials_ior-Bz-lHwYH.js","assets/js/KHR_materials_iridescence-B4Y2EIQH.js","assets/js/KHR_materials_pbrSpecularGlossiness-CY6gkaov.js","assets/js/KHR_materials_sheen-CFTfKxJT.js","assets/js/KHR_materials_specular-C0ftJ22M.js","assets/js/KHR_materials_transmission-CY2uUqX6.js","assets/js/KHR_materials_unlit-Cu_tyu4N.js","assets/js/KHR_materials_variants-DEefU7QB.js","assets/js/KHR_materials_volume-BIv3qF34.js","assets/js/KHR_texture_basisu-DKlCUxb0.js","assets/js/KHR_texture_transform-DYAJBtwv.js","assets/js/MSFT_audio_emitter-DbHbt2M2.js","assets/js/MSFT_lod-BmLsfyy4.js","assets/js/MSFT_minecraftMesh-DpAde5U_.js","assets/js/MSFT_sRGBFactors-BTegmd7F.js"])))=>i.map(i=>d[i]);
var W0=Object.defineProperty;var H0=(n,e,t)=>e in n?W0(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Fs=(n,e,t)=>H0(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();/**
* @vue/shared v3.5.12
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**//*! #__NO_SIDE_EFFECTS__ */function Md(n){const e=Object.create(null);for(const t of n.split(","))e[t]=1;return t=>t in e}const Bi={},Oo=[],pn=()=>{},X0=()=>!1,Hu=n=>n.charCodeAt(0)===111&&n.charCodeAt(1)===110&&(n.charCodeAt(2)>122||n.charCodeAt(2)<97),Dd=n=>n.startsWith("onUpdate:"),Rr=Object.assign,Od=(n,e)=>{const t=n.indexOf(e);t>-1&&n.splice(t,1)},Y0=Object.prototype.hasOwnProperty,gi=(n,e)=>Y0.call(n,e),Bt=Array.isArray,No=n=>Xu(n)==="[object Map]",Iv=n=>Xu(n)==="[object Set]",zt=n=>typeof n=="function",xr=n=>typeof n=="string",xa=n=>typeof n=="symbol",nr=n=>n!==null&&typeof n=="object",yv=n=>(nr(n)||zt(n))&&zt(n.then)&&zt(n.catch),bv=Object.prototype.toString,Xu=n=>bv.call(n),$0=n=>Xu(n).slice(8,-1),Rv=n=>Xu(n)==="[object Object]",Nd=n=>xr(n)&&n!=="NaN"&&n[0]!=="-"&&""+parseInt(n,10)===n,Ol=Md(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),Yu=n=>{const e=Object.create(null);return t=>e[t]||(e[t]=n(t))},K0=/-(\w)/g,ga=Yu(n=>n.replace(K0,(e,t)=>t?t.toUpperCase():"")),j0=/\B([A-Z])/g,no=Yu(n=>n.replace(j0,"-$1").toLowerCase()),Pv=Yu(n=>n.charAt(0).toUpperCase()+n.slice(1)),ef=Yu(n=>n?`on${Pv(n)}`:""),fa=(n,e)=>!Object.is(n,e),tf=(n,...e)=>{for(let t=0;t<n.length;t++)n[t](...e)},Mv=(n,e,t,i=!1)=>{Object.defineProperty(n,e,{configurable:!0,enumerable:!1,writable:i,value:t})},q0=n=>{const e=parseFloat(n);return isNaN(e)?n:e};let G_;const $u=()=>G_||(G_=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});function Ld(n){if(Bt(n)){const e={};for(let t=0;t<n.length;t++){const i=n[t],r=xr(i)?eR(i):Ld(i);if(r)for(const s in r)e[s]=r[s]}return e}else if(xr(n)||nr(n))return n}const Z0=/;(?![^(]*\))/g,Q0=/:([^]+)/,J0=/\/\*[^]*?\*\//g;function eR(n){const e={};return n.replace(J0,"").split(Z0).forEach(t=>{if(t){const i=t.split(Q0);i.length>1&&(e[i[0].trim()]=i[1].trim())}}),e}function Yl(n){let e="";if(xr(n))e=n;else if(Bt(n))for(let t=0;t<n.length;t++){const i=Yl(n[t]);i&&(e+=i+" ")}else if(nr(n))for(const t in n)n[t]&&(e+=t+" ");return e.trim()}const tR="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",iR=Md(tR);function Dv(n){return!!n||n===""}const Ov=n=>!!(n&&n.__v_isRef===!0),Nv=n=>xr(n)?n:n==null?"":Bt(n)||nr(n)&&(n.toString===bv||!zt(n.toString))?Ov(n)?Nv(n.value):JSON.stringify(n,Lv,2):String(n),Lv=(n,e)=>Ov(e)?Lv(n,e.value):No(e)?{[`Map(${e.size})`]:[...e.entries()].reduce((t,[i,r],s)=>(t[rf(i,s)+" =>"]=r,t),{})}:Iv(e)?{[`Set(${e.size})`]:[...e.values()].map(t=>rf(t))}:xa(e)?rf(e):nr(e)&&!Bt(e)&&!Rv(e)?String(e):e,rf=(n,e="")=>{var t;return xa(n)?`Symbol(${(t=n.description)!=null?t:e})`:n};/**
* @vue/reactivity v3.5.12
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let vs;class rR{constructor(e=!1){this.detached=e,this._active=!0,this.effects=[],this.cleanups=[],this._isPaused=!1,this.parent=vs,!e&&vs&&(this.index=(vs.scopes||(vs.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){this._isPaused=!0;let e,t;if(this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].pause();for(e=0,t=this.effects.length;e<t;e++)this.effects[e].pause()}}resume(){if(this._active&&this._isPaused){this._isPaused=!1;let e,t;if(this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].resume();for(e=0,t=this.effects.length;e<t;e++)this.effects[e].resume()}}run(e){if(this._active){const t=vs;try{return vs=this,e()}finally{vs=t}}}on(){vs=this}off(){vs=this.parent}stop(e){if(this._active){let t,i;for(t=0,i=this.effects.length;t<i;t++)this.effects[t].stop();for(t=0,i=this.cleanups.length;t<i;t++)this.cleanups[t]();if(this.scopes)for(t=0,i=this.scopes.length;t<i;t++)this.scopes[t].stop(!0);if(!this.detached&&this.parent&&!e){const r=this.parent.scopes.pop();r&&r!==this&&(this.parent.scopes[this.index]=r,r.index=this.index)}this.parent=void 0,this._active=!1}}}function sR(){return vs}let Li;const sf=new WeakSet;class Fv{constructor(e){this.fn=e,this.deps=void 0,this.depsTail=void 0,this.flags=5,this.next=void 0,this.cleanup=void 0,this.scheduler=void 0,vs&&vs.active&&vs.effects.push(this)}pause(){this.flags|=64}resume(){this.flags&64&&(this.flags&=-65,sf.has(this)&&(sf.delete(this),this.trigger()))}notify(){this.flags&2&&!(this.flags&32)||this.flags&8||Bv(this)}run(){if(!(this.flags&1))return this.fn();this.flags|=2,z_(this),Vv(this);const e=Li,t=ks;Li=this,ks=!0;try{return this.fn()}finally{Uv(this),Li=e,ks=t,this.flags&=-3}}stop(){if(this.flags&1){for(let e=this.deps;e;e=e.nextDep)Bd(e);this.deps=this.depsTail=void 0,z_(this),this.onStop&&this.onStop(),this.flags&=-2}}trigger(){this.flags&64?sf.add(this):this.scheduler?this.scheduler():this.runIfDirty()}runIfDirty(){kf(this)&&this.run()}get dirty(){return kf(this)}}let wv=0,Nl,Ll;function Bv(n,e=!1){if(n.flags|=8,e){n.next=Ll,Ll=n;return}n.next=Nl,Nl=n}function Fd(){wv++}function wd(){if(--wv>0)return;if(Ll){let e=Ll;for(Ll=void 0;e;){const t=e.next;e.next=void 0,e.flags&=-9,e=t}}let n;for(;Nl;){let e=Nl;for(Nl=void 0;e;){const t=e.next;if(e.next=void 0,e.flags&=-9,e.flags&1)try{e.trigger()}catch(i){n||(n=i)}e=t}}if(n)throw n}function Vv(n){for(let e=n.deps;e;e=e.nextDep)e.version=-1,e.prevActiveLink=e.dep.activeLink,e.dep.activeLink=e}function Uv(n){let e,t=n.depsTail,i=t;for(;i;){const r=i.prevDep;i.version===-1?(i===t&&(t=r),Bd(i),nR(i)):e=i,i.dep.activeLink=i.prevActiveLink,i.prevActiveLink=void 0,i=r}n.deps=e,n.depsTail=t}function kf(n){for(let e=n.deps;e;e=e.nextDep)if(e.dep.version!==e.version||e.dep.computed&&(kv(e.dep.computed)||e.dep.version!==e.version))return!0;return!!n._dirty}function kv(n){if(n.flags&4&&!(n.flags&16)||(n.flags&=-17,n.globalVersion===$l))return;n.globalVersion=$l;const e=n.dep;if(n.flags|=2,e.version>0&&!n.isSSR&&n.deps&&!kf(n)){n.flags&=-3;return}const t=Li,i=ks;Li=n,ks=!0;try{Vv(n);const r=n.fn(n._value);(e.version===0||fa(r,n._value))&&(n._value=r,e.version++)}catch(r){throw e.version++,r}finally{Li=t,ks=i,Uv(n),n.flags&=-3}}function Bd(n,e=!1){const{dep:t,prevSub:i,nextSub:r}=n;if(i&&(i.nextSub=r,n.prevSub=void 0),r&&(r.prevSub=i,n.nextSub=void 0),t.subs===n&&(t.subs=i,!i&&t.computed)){t.computed.flags&=-5;for(let s=t.computed.deps;s;s=s.nextDep)Bd(s,!0)}!e&&!--t.sc&&t.map&&t.map.delete(t.key)}function nR(n){const{prevDep:e,nextDep:t}=n;e&&(e.nextDep=t,n.prevDep=void 0),t&&(t.prevDep=e,n.nextDep=void 0)}let ks=!0;const Gv=[];function Ca(){Gv.push(ks),ks=!1}function Aa(){const n=Gv.pop();ks=n===void 0?!0:n}function z_(n){const{cleanup:e}=n;if(n.cleanup=void 0,e){const t=Li;Li=void 0;try{e()}finally{Li=t}}}let $l=0;class aR{constructor(e,t){this.sub=e,this.dep=t,this.version=t.version,this.nextDep=this.prevDep=this.nextSub=this.prevSub=this.prevActiveLink=void 0}}class Vd{constructor(e){this.computed=e,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0}track(e){if(!Li||!ks||Li===this.computed)return;let t=this.activeLink;if(t===void 0||t.sub!==Li)t=this.activeLink=new aR(Li,this),Li.deps?(t.prevDep=Li.depsTail,Li.depsTail.nextDep=t,Li.depsTail=t):Li.deps=Li.depsTail=t,zv(t);else if(t.version===-1&&(t.version=this.version,t.nextDep)){const i=t.nextDep;i.prevDep=t.prevDep,t.prevDep&&(t.prevDep.nextDep=i),t.prevDep=Li.depsTail,t.nextDep=void 0,Li.depsTail.nextDep=t,Li.depsTail=t,Li.deps===t&&(Li.deps=i)}return t}trigger(e){this.version++,$l++,this.notify(e)}notify(e){Fd();try{for(let t=this.subs;t;t=t.prevSub)t.sub.notify()&&t.sub.dep.notify()}finally{wd()}}}function zv(n){if(n.dep.sc++,n.sub.flags&4){const e=n.dep.computed;if(e&&!n.dep.subs){e.flags|=20;for(let i=e.deps;i;i=i.nextDep)zv(i)}const t=n.dep.subs;t!==n&&(n.prevSub=t,t&&(t.nextSub=n)),n.dep.subs=n}}const Gf=new WeakMap,Ya=Symbol(""),zf=Symbol(""),Kl=Symbol("");function Br(n,e,t){if(ks&&Li){let i=Gf.get(n);i||Gf.set(n,i=new Map);let r=i.get(t);r||(i.set(t,r=new Vd),r.map=i,r.key=t),r.track()}}function wn(n,e,t,i,r,s){const a=Gf.get(n);if(!a){$l++;return}const o=l=>{l&&l.trigger()};if(Fd(),e==="clear")a.forEach(o);else{const l=Bt(n),c=l&&Nd(t);if(l&&t==="length"){const u=Number(i);a.forEach((h,f)=>{(f==="length"||f===Kl||!xa(f)&&f>=u)&&o(h)})}else switch((t!==void 0||a.has(void 0))&&o(a.get(t)),c&&o(a.get(Kl)),e){case"add":l?c&&o(a.get("length")):(o(a.get(Ya)),No(n)&&o(a.get(zf)));break;case"delete":l||(o(a.get(Ya)),No(n)&&o(a.get(zf)));break;case"set":No(n)&&o(a.get(Ya));break}}wd()}function mo(n){const e=mi(n);return e===n?e:(Br(e,"iterate",Kl),Gs(n)?e:e.map(jr))}function Ud(n){return Br(n=mi(n),"iterate",Kl),n}const oR={__proto__:null,[Symbol.iterator](){return nf(this,Symbol.iterator,jr)},concat(...n){return mo(this).concat(...n.map(e=>Bt(e)?mo(e):e))},entries(){return nf(this,"entries",n=>(n[1]=jr(n[1]),n))},every(n,e){return bn(this,"every",n,e,void 0,arguments)},filter(n,e){return bn(this,"filter",n,e,t=>t.map(jr),arguments)},find(n,e){return bn(this,"find",n,e,jr,arguments)},findIndex(n,e){return bn(this,"findIndex",n,e,void 0,arguments)},findLast(n,e){return bn(this,"findLast",n,e,jr,arguments)},findLastIndex(n,e){return bn(this,"findLastIndex",n,e,void 0,arguments)},forEach(n,e){return bn(this,"forEach",n,e,void 0,arguments)},includes(...n){return af(this,"includes",n)},indexOf(...n){return af(this,"indexOf",n)},join(n){return mo(this).join(n)},lastIndexOf(...n){return af(this,"lastIndexOf",n)},map(n,e){return bn(this,"map",n,e,void 0,arguments)},pop(){return Cl(this,"pop")},push(...n){return Cl(this,"push",n)},reduce(n,...e){return W_(this,"reduce",n,e)},reduceRight(n,...e){return W_(this,"reduceRight",n,e)},shift(){return Cl(this,"shift")},some(n,e){return bn(this,"some",n,e,void 0,arguments)},splice(...n){return Cl(this,"splice",n)},toReversed(){return mo(this).toReversed()},toSorted(n){return mo(this).toSorted(n)},toSpliced(...n){return mo(this).toSpliced(...n)},unshift(...n){return Cl(this,"unshift",n)},values(){return nf(this,"values",jr)}};function nf(n,e,t){const i=Ud(n),r=i[e]();return i!==n&&!Gs(n)&&(r._next=r.next,r.next=()=>{const s=r._next();return s.value&&(s.value=t(s.value)),s}),r}const lR=Array.prototype;function bn(n,e,t,i,r,s){const a=Ud(n),o=a!==n&&!Gs(n),l=a[e];if(l!==lR[e]){const h=l.apply(n,s);return o?jr(h):h}let c=t;a!==n&&(o?c=function(h,f){return t.call(this,jr(h),f,n)}:t.length>2&&(c=function(h,f){return t.call(this,h,f,n)}));const u=l.call(a,c,i);return o&&r?r(u):u}function W_(n,e,t,i){const r=Ud(n);let s=t;return r!==n&&(Gs(n)?t.length>3&&(s=function(a,o,l){return t.call(this,a,o,l,n)}):s=function(a,o,l){return t.call(this,a,jr(o),l,n)}),r[e](s,...i)}function af(n,e,t){const i=mi(n);Br(i,"iterate",Kl);const r=i[e](...t);return(r===-1||r===!1)&&Wd(t[0])?(t[0]=mi(t[0]),i[e](...t)):r}function Cl(n,e,t=[]){Ca(),Fd();const i=mi(n)[e].apply(n,t);return wd(),Aa(),i}const cR=Md("__proto__,__v_isRef,__isVue"),Wv=new Set(Object.getOwnPropertyNames(Symbol).filter(n=>n!=="arguments"&&n!=="caller").map(n=>Symbol[n]).filter(xa));function uR(n){xa(n)||(n=String(n));const e=mi(this);return Br(e,"has",n),e.hasOwnProperty(n)}class Hv{constructor(e=!1,t=!1){this._isReadonly=e,this._isShallow=t}get(e,t,i){const r=this._isReadonly,s=this._isShallow;if(t==="__v_isReactive")return!r;if(t==="__v_isReadonly")return r;if(t==="__v_isShallow")return s;if(t==="__v_raw")return i===(r?s?SR:Kv:s?$v:Yv).get(e)||Object.getPrototypeOf(e)===Object.getPrototypeOf(i)?e:void 0;const a=Bt(e);if(!r){let l;if(a&&(l=oR[t]))return l;if(t==="hasOwnProperty")return uR}const o=Reflect.get(e,t,kr(e)?e:i);return(xa(t)?Wv.has(t):cR(t))||(r||Br(e,"get",t),s)?o:kr(o)?a&&Nd(t)?o:o.value:nr(o)?r?jv(o):Gd(o):o}}class Xv extends Hv{constructor(e=!1){super(!1,e)}set(e,t,i,r){let s=e[t];if(!this._isShallow){const l=Qa(s);if(!Gs(i)&&!Qa(i)&&(s=mi(s),i=mi(i)),!Bt(e)&&kr(s)&&!kr(i))return l?!1:(s.value=i,!0)}const a=Bt(e)&&Nd(t)?Number(t)<e.length:gi(e,t),o=Reflect.set(e,t,i,kr(e)?e:r);return e===mi(r)&&(a?fa(i,s)&&wn(e,"set",t,i):wn(e,"add",t,i)),o}deleteProperty(e,t){const i=gi(e,t);e[t];const r=Reflect.deleteProperty(e,t);return r&&i&&wn(e,"delete",t,void 0),r}has(e,t){const i=Reflect.has(e,t);return(!xa(t)||!Wv.has(t))&&Br(e,"has",t),i}ownKeys(e){return Br(e,"iterate",Bt(e)?"length":Ya),Reflect.ownKeys(e)}}class hR extends Hv{constructor(e=!1){super(!0,e)}set(e,t){return!0}deleteProperty(e,t){return!0}}const fR=new Xv,dR=new hR,pR=new Xv(!0);const Wf=n=>n,Gc=n=>Reflect.getPrototypeOf(n);function _R(n,e,t){return function(...i){const r=this.__v_raw,s=mi(r),a=No(s),o=n==="entries"||n===Symbol.iterator&&a,l=n==="keys"&&a,c=r[n](...i),u=t?Wf:e?Hf:jr;return!e&&Br(s,"iterate",l?zf:Ya),{next(){const{value:h,done:f}=c.next();return f?{value:h,done:f}:{value:o?[u(h[0]),u(h[1])]:u(h),done:f}},[Symbol.iterator](){return this}}}}function zc(n){return function(...e){return n==="delete"?!1:n==="clear"?void 0:this}}function mR(n,e){const t={get(r){const s=this.__v_raw,a=mi(s),o=mi(r);n||(fa(r,o)&&Br(a,"get",r),Br(a,"get",o));const{has:l}=Gc(a),c=e?Wf:n?Hf:jr;if(l.call(a,r))return c(s.get(r));if(l.call(a,o))return c(s.get(o));s!==a&&s.get(r)},get size(){const r=this.__v_raw;return!n&&Br(mi(r),"iterate",Ya),Reflect.get(r,"size",r)},has(r){const s=this.__v_raw,a=mi(s),o=mi(r);return n||(fa(r,o)&&Br(a,"has",r),Br(a,"has",o)),r===o?s.has(r):s.has(r)||s.has(o)},forEach(r,s){const a=this,o=a.__v_raw,l=mi(o),c=e?Wf:n?Hf:jr;return!n&&Br(l,"iterate",Ya),o.forEach((u,h)=>r.call(s,c(u),c(h),a))}};return Rr(t,n?{add:zc("add"),set:zc("set"),delete:zc("delete"),clear:zc("clear")}:{add(r){!e&&!Gs(r)&&!Qa(r)&&(r=mi(r));const s=mi(this);return Gc(s).has.call(s,r)||(s.add(r),wn(s,"add",r,r)),this},set(r,s){!e&&!Gs(s)&&!Qa(s)&&(s=mi(s));const a=mi(this),{has:o,get:l}=Gc(a);let c=o.call(a,r);c||(r=mi(r),c=o.call(a,r));const u=l.call(a,r);return a.set(r,s),c?fa(s,u)&&wn(a,"set",r,s):wn(a,"add",r,s),this},delete(r){const s=mi(this),{has:a,get:o}=Gc(s);let l=a.call(s,r);l||(r=mi(r),l=a.call(s,r)),o&&o.call(s,r);const c=s.delete(r);return l&&wn(s,"delete",r,void 0),c},clear(){const r=mi(this),s=r.size!==0,a=r.clear();return s&&wn(r,"clear",void 0,void 0),a}}),["keys","values","entries",Symbol.iterator].forEach(r=>{t[r]=_R(r,n,e)}),t}function kd(n,e){const t=mR(n,e);return(i,r,s)=>r==="__v_isReactive"?!n:r==="__v_isReadonly"?n:r==="__v_raw"?i:Reflect.get(gi(t,r)&&r in i?t:i,r,s)}const gR={get:kd(!1,!1)},ER={get:kd(!1,!0)},vR={get:kd(!0,!1)};const Yv=new WeakMap,$v=new WeakMap,Kv=new WeakMap,SR=new WeakMap;function TR(n){switch(n){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function xR(n){return n.__v_skip||!Object.isExtensible(n)?0:TR($0(n))}function Gd(n){return Qa(n)?n:zd(n,!1,fR,gR,Yv)}function CR(n){return zd(n,!1,pR,ER,$v)}function jv(n){return zd(n,!0,dR,vR,Kv)}function zd(n,e,t,i,r){if(!nr(n)||n.__v_raw&&!(e&&n.__v_isReactive))return n;const s=r.get(n);if(s)return s;const a=xR(n);if(a===0)return n;const o=new Proxy(n,a===2?i:t);return r.set(n,o),o}function Fl(n){return Qa(n)?Fl(n.__v_raw):!!(n&&n.__v_isReactive)}function Qa(n){return!!(n&&n.__v_isReadonly)}function Gs(n){return!!(n&&n.__v_isShallow)}function Wd(n){return n?!!n.__v_raw:!1}function mi(n){const e=n&&n.__v_raw;return e?mi(e):n}function AR(n){return!gi(n,"__v_skip")&&Object.isExtensible(n)&&Mv(n,"__v_skip",!0),n}const jr=n=>nr(n)?Gd(n):n,Hf=n=>nr(n)?jv(n):n;function kr(n){return n?n.__v_isRef===!0:!1}function ta(n){return IR(n,!1)}function IR(n,e){return kr(n)?n:new yR(n,e)}class yR{constructor(e,t){this.dep=new Vd,this.__v_isRef=!0,this.__v_isShallow=!1,this._rawValue=t?e:mi(e),this._value=t?e:jr(e),this.__v_isShallow=t}get value(){return this.dep.track(),this._value}set value(e){const t=this._rawValue,i=this.__v_isShallow||Gs(e)||Qa(e);e=i?e:mi(e),fa(e,t)&&(this._rawValue=e,this._value=i?e:jr(e),this.dep.trigger())}}function bR(n){return kr(n)?n.value:n}const RR={get:(n,e,t)=>e==="__v_raw"?n:bR(Reflect.get(n,e,t)),set:(n,e,t,i)=>{const r=n[e];return kr(r)&&!kr(t)?(r.value=t,!0):Reflect.set(n,e,t,i)}};function qv(n){return Fl(n)?n:new Proxy(n,RR)}class PR{constructor(e,t,i){this.fn=e,this.setter=t,this._value=void 0,this.dep=new Vd(this),this.__v_isRef=!0,this.deps=void 0,this.depsTail=void 0,this.flags=16,this.globalVersion=$l-1,this.next=void 0,this.effect=this,this.__v_isReadonly=!t,this.isSSR=i}notify(){if(this.flags|=16,!(this.flags&8)&&Li!==this)return Bv(this,!0),!0}get value(){const e=this.dep.track();return kv(this),e&&(e.version=this.dep.version),this._value}set value(e){this.setter&&this.setter(e)}}function MR(n,e,t=!1){let i,r;return zt(n)?i=n:(i=n.get,r=n.set),new PR(i,r,t)}const Wc={},Eu=new WeakMap;let Ba;function DR(n,e=!1,t=Ba){if(t){let i=Eu.get(t);i||Eu.set(t,i=[]),i.push(n)}}function OR(n,e,t=Bi){const{immediate:i,deep:r,once:s,scheduler:a,augmentJob:o,call:l}=t,c=A=>r?A:Gs(A)||r===!1||r===0?aa(A,1):aa(A);let u,h,f,d,p=!1,_=!1;if(kr(n)?(h=()=>n.value,p=Gs(n)):Fl(n)?(h=()=>c(n),p=!0):Bt(n)?(_=!0,p=n.some(A=>Fl(A)||Gs(A)),h=()=>n.map(A=>{if(kr(A))return A.value;if(Fl(A))return c(A);if(zt(A))return l?l(A,2):A()})):zt(n)?e?h=l?()=>l(n,2):n:h=()=>{if(f){Ca();try{f()}finally{Aa()}}const A=Ba;Ba=u;try{return l?l(n,3,[d]):n(d)}finally{Ba=A}}:h=pn,e&&r){const A=h,T=r===!0?1/0:r;h=()=>aa(A(),T)}const g=sR(),E=()=>{u.stop(),g&&Od(g.effects,u)};if(s&&e){const A=e;e=(...T)=>{A(...T),E()}}let v=_?new Array(n.length).fill(Wc):Wc;const x=A=>{if(!(!(u.flags&1)||!u.dirty&&!A))if(e){const T=u.run();if(r||p||(_?T.some((C,y)=>fa(C,v[y])):fa(T,v))){f&&f();const C=Ba;Ba=u;try{const y=[T,v===Wc?void 0:_&&v[0]===Wc?[]:v,d];l?l(e,3,y):e(...y),v=T}finally{Ba=C}}}else u.run()};return o&&o(x),u=new Fv(h),u.scheduler=a?()=>a(x,!1):x,d=A=>DR(A,!1,u),f=u.onStop=()=>{const A=Eu.get(u);if(A){if(l)l(A,4);else for(const T of A)T();Eu.delete(u)}},e?i?x(!0):v=u.run():a?a(x.bind(null,!0),!0):u.run(),E.pause=u.pause.bind(u),E.resume=u.resume.bind(u),E.stop=E,E}function aa(n,e=1/0,t){if(e<=0||!nr(n)||n.__v_skip||(t=t||new Set,t.has(n)))return n;if(t.add(n),e--,kr(n))aa(n.value,e,t);else if(Bt(n))for(let i=0;i<n.length;i++)aa(n[i],e,t);else if(Iv(n)||No(n))n.forEach(i=>{aa(i,e,t)});else if(Rv(n)){for(const i in n)aa(n[i],e,t);for(const i of Object.getOwnPropertySymbols(n))Object.prototype.propertyIsEnumerable.call(n,i)&&aa(n[i],e,t)}return n}/**
* @vue/runtime-core v3.5.12
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/function dc(n,e,t,i){try{return i?n(...i):n()}catch(r){Ku(r,e,t)}}function mn(n,e,t,i){if(zt(n)){const r=dc(n,e,t,i);return r&&yv(r)&&r.catch(s=>{Ku(s,e,t)}),r}if(Bt(n)){const r=[];for(let s=0;s<n.length;s++)r.push(mn(n[s],e,t,i));return r}}function Ku(n,e,t,i=!0){const r=e?e.vnode:null,{errorHandler:s,throwUnhandledErrorInProduction:a}=e&&e.appContext.config||Bi;if(e){let o=e.parent;const l=e.proxy,c=`https://vuejs.org/error-reference/#runtime-${t}`;for(;o;){const u=o.ec;if(u){for(let h=0;h<u.length;h++)if(u[h](n,l,c)===!1)return}o=o.parent}if(s){Ca(),dc(s,null,10,[n,l,c]),Aa();return}}NR(n,t,r,i,a)}function NR(n,e,t,i=!0,r=!1){if(r)throw n;console.error(n)}const qr=[];let Zs=-1;const Lo=[];let ra=null,yo=0;const Zv=Promise.resolve();let vu=null;function LR(n){const e=vu||Zv;return n?e.then(this?n.bind(this):n):e}function FR(n){let e=Zs+1,t=qr.length;for(;e<t;){const i=e+t>>>1,r=qr[i],s=jl(r);s<n||s===n&&r.flags&2?e=i+1:t=i}return e}function Hd(n){if(!(n.flags&1)){const e=jl(n),t=qr[qr.length-1];!t||!(n.flags&2)&&e>=jl(t)?qr.push(n):qr.splice(FR(e),0,n),n.flags|=1,Qv()}}function Qv(){vu||(vu=Zv.then(eS))}function wR(n){Bt(n)?Lo.push(...n):ra&&n.id===-1?ra.splice(yo+1,0,n):n.flags&1||(Lo.push(n),n.flags|=1),Qv()}function H_(n,e,t=Zs+1){for(;t<qr.length;t++){const i=qr[t];if(i&&i.flags&2){if(n&&i.id!==n.uid)continue;qr.splice(t,1),t--,i.flags&4&&(i.flags&=-2),i(),i.flags&4||(i.flags&=-2)}}}function Jv(n){if(Lo.length){const e=[...new Set(Lo)].sort((t,i)=>jl(t)-jl(i));if(Lo.length=0,ra){ra.push(...e);return}for(ra=e,yo=0;yo<ra.length;yo++){const t=ra[yo];t.flags&4&&(t.flags&=-2),t.flags&8||t(),t.flags&=-2}ra=null,yo=0}}const jl=n=>n.id==null?n.flags&2?-1:1/0:n.id;function eS(n){try{for(Zs=0;Zs<qr.length;Zs++){const e=qr[Zs];e&&!(e.flags&8)&&(e.flags&4&&(e.flags&=-2),dc(e,e.i,e.i?15:14),e.flags&4||(e.flags&=-2))}}finally{for(;Zs<qr.length;Zs++){const e=qr[Zs];e&&(e.flags&=-2)}Zs=-1,qr.length=0,Jv(),vu=null,(qr.length||Lo.length)&&eS()}}let un=null,tS=null;function Su(n){const e=un;return un=n,tS=n&&n.type.__scopeId||null,e}function BR(n,e=un,t){if(!e||n._n)return n;const i=(...r)=>{i._d&&Q_(-1);const s=Su(e);let a;try{a=n(...r)}finally{Su(s),i._d&&Q_(1)}return a};return i._n=!0,i._c=!0,i._d=!0,i}function La(n,e,t,i){const r=n.dirs,s=e&&e.dirs;for(let a=0;a<r.length;a++){const o=r[a];s&&(o.oldValue=s[a].value);let l=o.dir[i];l&&(Ca(),mn(l,t,8,[n.el,o,n,e]),Aa())}}const VR=Symbol("_vte"),UR=n=>n.__isTeleport;function Xd(n,e){n.shapeFlag&6&&n.component?(n.transition=e,Xd(n.component.subTree,e)):n.shapeFlag&128?(n.ssContent.transition=e.clone(n.ssContent),n.ssFallback.transition=e.clone(n.ssFallback)):n.transition=e}/*! #__NO_SIDE_EFFECTS__ */function Yd(n,e){return zt(n)?Rr({name:n.name},e,{setup:n}):n}function iS(n){n.ids=[n.ids[0]+n.ids[2]+++"-",0,0]}function Xf(n,e,t,i,r=!1){if(Bt(n)){n.forEach((p,_)=>Xf(p,e&&(Bt(e)?e[_]:e),t,i,r));return}if(wl(i)&&!r)return;const s=i.shapeFlag&4?qd(i.component):i.el,a=r?null:s,{i:o,r:l}=n,c=e&&e.r,u=o.refs===Bi?o.refs={}:o.refs,h=o.setupState,f=mi(h),d=h===Bi?()=>!1:p=>gi(f,p);if(c!=null&&c!==l&&(xr(c)?(u[c]=null,d(c)&&(h[c]=null)):kr(c)&&(c.value=null)),zt(l))dc(l,o,12,[a,u]);else{const p=xr(l),_=kr(l);if(p||_){const g=()=>{if(n.f){const E=p?d(l)?h[l]:u[l]:l.value;r?Bt(E)&&Od(E,s):Bt(E)?E.includes(s)||E.push(s):p?(u[l]=[s],d(l)&&(h[l]=u[l])):(l.value=[s],n.k&&(u[n.k]=l.value))}else p?(u[l]=a,d(l)&&(h[l]=a)):_&&(l.value=a,n.k&&(u[n.k]=a))};a?(g.id=-1,Es(g,t)):g()}}}$u().requestIdleCallback;$u().cancelIdleCallback;const wl=n=>!!n.type.__asyncLoader,rS=n=>n.type.__isKeepAlive;function kR(n,e){sS(n,"a",e)}function GR(n,e){sS(n,"da",e)}function sS(n,e,t=Zr){const i=n.__wdc||(n.__wdc=()=>{let r=t;for(;r;){if(r.isDeactivated)return;r=r.parent}return n()});if(ju(e,i,t),t){let r=t.parent;for(;r&&r.parent;)rS(r.parent.vnode)&&zR(i,e,t,r),r=r.parent}}function zR(n,e,t,i){const r=ju(e,n,i,!0);aS(()=>{Od(i[e],r)},t)}function ju(n,e,t=Zr,i=!1){if(t){const r=t[n]||(t[n]=[]),s=e.__weh||(e.__weh=(...a)=>{Ca();const o=pc(t),l=mn(e,t,n,a);return o(),Aa(),l});return i?r.unshift(s):r.push(s),s}}const qn=n=>(e,t=Zr)=>{(!Zl||n==="sp")&&ju(n,(...i)=>e(...i),t)},WR=qn("bm"),nS=qn("m"),HR=qn("bu"),XR=qn("u"),YR=qn("bum"),aS=qn("um"),$R=qn("sp"),KR=qn("rtg"),jR=qn("rtc");function qR(n,e=Zr){ju("ec",n,e)}const ZR=Symbol.for("v-ndc"),Yf=n=>n?bS(n)?qd(n):Yf(n.parent):null,Bl=Rr(Object.create(null),{$:n=>n,$el:n=>n.vnode.el,$data:n=>n.data,$props:n=>n.props,$attrs:n=>n.attrs,$slots:n=>n.slots,$refs:n=>n.refs,$parent:n=>Yf(n.parent),$root:n=>Yf(n.root),$host:n=>n.ce,$emit:n=>n.emit,$options:n=>$d(n),$forceUpdate:n=>n.f||(n.f=()=>{Hd(n.update)}),$nextTick:n=>n.n||(n.n=LR.bind(n.proxy)),$watch:n=>vP.bind(n)}),of=(n,e)=>n!==Bi&&!n.__isScriptSetup&&gi(n,e),QR={get({_:n},e){if(e==="__v_skip")return!0;const{ctx:t,setupState:i,data:r,props:s,accessCache:a,type:o,appContext:l}=n;let c;if(e[0]!=="$"){const d=a[e];if(d!==void 0)switch(d){case 1:return i[e];case 2:return r[e];case 4:return t[e];case 3:return s[e]}else{if(of(i,e))return a[e]=1,i[e];if(r!==Bi&&gi(r,e))return a[e]=2,r[e];if((c=n.propsOptions[0])&&gi(c,e))return a[e]=3,s[e];if(t!==Bi&&gi(t,e))return a[e]=4,t[e];$f&&(a[e]=0)}}const u=Bl[e];let h,f;if(u)return e==="$attrs"&&Br(n.attrs,"get",""),u(n);if((h=o.__cssModules)&&(h=h[e]))return h;if(t!==Bi&&gi(t,e))return a[e]=4,t[e];if(f=l.config.globalProperties,gi(f,e))return f[e]},set({_:n},e,t){const{data:i,setupState:r,ctx:s}=n;return of(r,e)?(r[e]=t,!0):i!==Bi&&gi(i,e)?(i[e]=t,!0):gi(n.props,e)||e[0]==="$"&&e.slice(1)in n?!1:(s[e]=t,!0)},has({_:{data:n,setupState:e,accessCache:t,ctx:i,appContext:r,propsOptions:s}},a){let o;return!!t[a]||n!==Bi&&gi(n,a)||of(e,a)||(o=s[0])&&gi(o,a)||gi(i,a)||gi(Bl,a)||gi(r.config.globalProperties,a)},defineProperty(n,e,t){return t.get!=null?n._.accessCache[e]=0:gi(t,"value")&&this.set(n,e,t.value,null),Reflect.defineProperty(n,e,t)}};function X_(n){return Bt(n)?n.reduce((e,t)=>(e[t]=null,e),{}):n}let $f=!0;function JR(n){const e=$d(n),t=n.proxy,i=n.ctx;$f=!1,e.beforeCreate&&Y_(e.beforeCreate,n,"bc");const{data:r,computed:s,methods:a,watch:o,provide:l,inject:c,created:u,beforeMount:h,mounted:f,beforeUpdate:d,updated:p,activated:_,deactivated:g,beforeDestroy:E,beforeUnmount:v,destroyed:x,unmounted:A,render:T,renderTracked:C,renderTriggered:y,errorCaptured:P,serverPrefetch:D,expose:F,inheritAttrs:W,components:H,directives:ue,filters:ae}=e;if(c&&eP(c,i,null),a)for(const ge in a){const Ee=a[ge];zt(Ee)&&(i[ge]=Ee.bind(t))}if(r){const ge=r.call(t,t);nr(ge)&&(n.data=Gd(ge))}if($f=!0,s)for(const ge in s){const Ee=s[ge],ne=zt(Ee)?Ee.bind(t,t):zt(Ee.get)?Ee.get.bind(t,t):pn,j=!zt(Ee)&&zt(Ee.set)?Ee.set.bind(t):pn,L=GP({get:ne,set:j});Object.defineProperty(i,ge,{enumerable:!0,configurable:!0,get:()=>L.value,set:Y=>L.value=Y})}if(o)for(const ge in o)oS(o[ge],i,t,ge);if(l){const ge=zt(l)?l.call(t):l;Reflect.ownKeys(ge).forEach(Ee=>{aP(Ee,ge[Ee])})}u&&Y_(u,n,"c");function oe(ge,Ee){Bt(Ee)?Ee.forEach(ne=>ge(ne.bind(t))):Ee&&ge(Ee.bind(t))}if(oe(WR,h),oe(nS,f),oe(HR,d),oe(XR,p),oe(kR,_),oe(GR,g),oe(qR,P),oe(jR,C),oe(KR,y),oe(YR,v),oe(aS,A),oe($R,D),Bt(F))if(F.length){const ge=n.exposed||(n.exposed={});F.forEach(Ee=>{Object.defineProperty(ge,Ee,{get:()=>t[Ee],set:ne=>t[Ee]=ne})})}else n.exposed||(n.exposed={});T&&n.render===pn&&(n.render=T),W!=null&&(n.inheritAttrs=W),H&&(n.components=H),ue&&(n.directives=ue),D&&iS(n)}function eP(n,e,t=pn){Bt(n)&&(n=Kf(n));for(const i in n){const r=n[i];let s;nr(r)?"default"in r?s=ru(r.from||i,r.default,!0):s=ru(r.from||i):s=ru(r),kr(s)?Object.defineProperty(e,i,{enumerable:!0,configurable:!0,get:()=>s.value,set:a=>s.value=a}):e[i]=s}}function Y_(n,e,t){mn(Bt(n)?n.map(i=>i.bind(e.proxy)):n.bind(e.proxy),e,t)}function oS(n,e,t,i){let r=i.includes(".")?TS(t,i):()=>t[i];if(xr(n)){const s=e[n];zt(s)&&cf(r,s)}else if(zt(n))cf(r,n.bind(t));else if(nr(n))if(Bt(n))n.forEach(s=>oS(s,e,t,i));else{const s=zt(n.handler)?n.handler.bind(t):e[n.handler];zt(s)&&cf(r,s,n)}}function $d(n){const e=n.type,{mixins:t,extends:i}=e,{mixins:r,optionsCache:s,config:{optionMergeStrategies:a}}=n.appContext,o=s.get(e);let l;return o?l=o:!r.length&&!t&&!i?l=e:(l={},r.length&&r.forEach(c=>Tu(l,c,a,!0)),Tu(l,e,a)),nr(e)&&s.set(e,l),l}function Tu(n,e,t,i=!1){const{mixins:r,extends:s}=e;s&&Tu(n,s,t,!0),r&&r.forEach(a=>Tu(n,a,t,!0));for(const a in e)if(!(i&&a==="expose")){const o=tP[a]||t&&t[a];n[a]=o?o(n[a],e[a]):e[a]}return n}const tP={data:$_,props:K_,emits:K_,methods:Pl,computed:Pl,beforeCreate:Xr,created:Xr,beforeMount:Xr,mounted:Xr,beforeUpdate:Xr,updated:Xr,beforeDestroy:Xr,beforeUnmount:Xr,destroyed:Xr,unmounted:Xr,activated:Xr,deactivated:Xr,errorCaptured:Xr,serverPrefetch:Xr,components:Pl,directives:Pl,watch:rP,provide:$_,inject:iP};function $_(n,e){return e?n?function(){return Rr(zt(n)?n.call(this,this):n,zt(e)?e.call(this,this):e)}:e:n}function iP(n,e){return Pl(Kf(n),Kf(e))}function Kf(n){if(Bt(n)){const e={};for(let t=0;t<n.length;t++)e[n[t]]=n[t];return e}return n}function Xr(n,e){return n?[...new Set([].concat(n,e))]:e}function Pl(n,e){return n?Rr(Object.create(null),n,e):e}function K_(n,e){return n?Bt(n)&&Bt(e)?[...new Set([...n,...e])]:Rr(Object.create(null),X_(n),X_(e??{})):e}function rP(n,e){if(!n)return e;if(!e)return n;const t=Rr(Object.create(null),n);for(const i in e)t[i]=Xr(n[i],e[i]);return t}function lS(){return{app:null,config:{isNativeTag:X0,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let sP=0;function nP(n,e){return function(i,r=null){zt(i)||(i=Rr({},i)),r!=null&&!nr(r)&&(r=null);const s=lS(),a=new WeakSet,o=[];let l=!1;const c=s.app={_uid:sP++,_component:i,_props:r,_container:null,_context:s,_instance:null,version:zP,get config(){return s.config},set config(u){},use(u,...h){return a.has(u)||(u&&zt(u.install)?(a.add(u),u.install(c,...h)):zt(u)&&(a.add(u),u(c,...h))),c},mixin(u){return s.mixins.includes(u)||s.mixins.push(u),c},component(u,h){return h?(s.components[u]=h,c):s.components[u]},directive(u,h){return h?(s.directives[u]=h,c):s.directives[u]},mount(u,h,f){if(!l){const d=c._ceVNode||zs(i,r);return d.appContext=s,f===!0?f="svg":f===!1&&(f=void 0),h&&e?e(d,u):n(d,u,f),l=!0,c._container=u,u.__vue_app__=c,qd(d.component)}},onUnmount(u){o.push(u)},unmount(){l&&(mn(o,c._instance,16),n(null,c._container),delete c._container.__vue_app__)},provide(u,h){return s.provides[u]=h,c},runWithContext(u){const h=Fo;Fo=c;try{return u()}finally{Fo=h}}};return c}}let Fo=null;function aP(n,e){if(Zr){let t=Zr.provides;const i=Zr.parent&&Zr.parent.provides;i===t&&(t=Zr.provides=Object.create(i)),t[n]=e}}function ru(n,e,t=!1){const i=Zr||un;if(i||Fo){const r=Fo?Fo._context.provides:i?i.parent==null?i.vnode.appContext&&i.vnode.appContext.provides:i.parent.provides:void 0;if(r&&n in r)return r[n];if(arguments.length>1)return t&&zt(e)?e.call(i&&i.proxy):e}}const cS={},uS=()=>Object.create(cS),hS=n=>Object.getPrototypeOf(n)===cS;function oP(n,e,t,i=!1){const r={},s=uS();n.propsDefaults=Object.create(null),fS(n,e,r,s);for(const a in n.propsOptions[0])a in r||(r[a]=void 0);t?n.props=i?r:CR(r):n.type.props?n.props=r:n.props=s,n.attrs=s}function lP(n,e,t,i){const{props:r,attrs:s,vnode:{patchFlag:a}}=n,o=mi(r),[l]=n.propsOptions;let c=!1;if((i||a>0)&&!(a&16)){if(a&8){const u=n.vnode.dynamicProps;for(let h=0;h<u.length;h++){let f=u[h];if(qu(n.emitsOptions,f))continue;const d=e[f];if(l)if(gi(s,f))d!==s[f]&&(s[f]=d,c=!0);else{const p=ga(f);r[p]=jf(l,o,p,d,n,!1)}else d!==s[f]&&(s[f]=d,c=!0)}}}else{fS(n,e,r,s)&&(c=!0);let u;for(const h in o)(!e||!gi(e,h)&&((u=no(h))===h||!gi(e,u)))&&(l?t&&(t[h]!==void 0||t[u]!==void 0)&&(r[h]=jf(l,o,h,void 0,n,!0)):delete r[h]);if(s!==o)for(const h in s)(!e||!gi(e,h))&&(delete s[h],c=!0)}c&&wn(n.attrs,"set","")}function fS(n,e,t,i){const[r,s]=n.propsOptions;let a=!1,o;if(e)for(let l in e){if(Ol(l))continue;const c=e[l];let u;r&&gi(r,u=ga(l))?!s||!s.includes(u)?t[u]=c:(o||(o={}))[u]=c:qu(n.emitsOptions,l)||(!(l in i)||c!==i[l])&&(i[l]=c,a=!0)}if(s){const l=mi(t),c=o||Bi;for(let u=0;u<s.length;u++){const h=s[u];t[h]=jf(r,l,h,c[h],n,!gi(c,h))}}return a}function jf(n,e,t,i,r,s){const a=n[t];if(a!=null){const o=gi(a,"default");if(o&&i===void 0){const l=a.default;if(a.type!==Function&&!a.skipFactory&&zt(l)){const{propsDefaults:c}=r;if(t in c)i=c[t];else{const u=pc(r);i=c[t]=l.call(null,e),u()}}else i=l;r.ce&&r.ce._setProp(t,i)}a[0]&&(s&&!o?i=!1:a[1]&&(i===""||i===no(t))&&(i=!0))}return i}const cP=new WeakMap;function dS(n,e,t=!1){const i=t?cP:e.propsCache,r=i.get(n);if(r)return r;const s=n.props,a={},o=[];let l=!1;if(!zt(n)){const u=h=>{l=!0;const[f,d]=dS(h,e,!0);Rr(a,f),d&&o.push(...d)};!t&&e.mixins.length&&e.mixins.forEach(u),n.extends&&u(n.extends),n.mixins&&n.mixins.forEach(u)}if(!s&&!l)return nr(n)&&i.set(n,Oo),Oo;if(Bt(s))for(let u=0;u<s.length;u++){const h=ga(s[u]);j_(h)&&(a[h]=Bi)}else if(s)for(const u in s){const h=ga(u);if(j_(h)){const f=s[u],d=a[h]=Bt(f)||zt(f)?{type:f}:Rr({},f),p=d.type;let _=!1,g=!0;if(Bt(p))for(let E=0;E<p.length;++E){const v=p[E],x=zt(v)&&v.name;if(x==="Boolean"){_=!0;break}else x==="String"&&(g=!1)}else _=zt(p)&&p.name==="Boolean";d[0]=_,d[1]=g,(_||gi(d,"default"))&&o.push(h)}}const c=[a,o];return nr(n)&&i.set(n,c),c}function j_(n){return n[0]!=="$"&&!Ol(n)}const pS=n=>n[0]==="_"||n==="$stable",Kd=n=>Bt(n)?n.map(rn):[rn(n)],uP=(n,e,t)=>{if(e._n)return e;const i=BR((...r)=>Kd(e(...r)),t);return i._c=!1,i},_S=(n,e,t)=>{const i=n._ctx;for(const r in n){if(pS(r))continue;const s=n[r];if(zt(s))e[r]=uP(r,s,i);else if(s!=null){const a=Kd(s);e[r]=()=>a}}},mS=(n,e)=>{const t=Kd(e);n.slots.default=()=>t},gS=(n,e,t)=>{for(const i in e)(t||i!=="_")&&(n[i]=e[i])},hP=(n,e,t)=>{const i=n.slots=uS();if(n.vnode.shapeFlag&32){const r=e._;r?(gS(i,e,t),t&&Mv(i,"_",r,!0)):_S(e,i)}else e&&mS(n,e)},fP=(n,e,t)=>{const{vnode:i,slots:r}=n;let s=!0,a=Bi;if(i.shapeFlag&32){const o=e._;o?t&&o===1?s=!1:gS(r,e,t):(s=!e.$stable,_S(e,r)),a=e}else e&&(mS(n,e),a={default:1});if(s)for(const o in r)!pS(o)&&a[o]==null&&delete r[o]},Es=yP;function dP(n){return pP(n)}function pP(n,e){const t=$u();t.__VUE__=!0;const{insert:i,remove:r,patchProp:s,createElement:a,createText:o,createComment:l,setText:c,setElementText:u,parentNode:h,nextSibling:f,setScopeId:d=pn,insertStaticContent:p}=n,_=(z,K,he,Ce=null,ye=null,be=null,Je=void 0,qe=null,Ge=!!K.dynamicChildren)=>{if(z===K)return;z&&!Al(z,K)&&(Ce=Me(z),Y(z,ye,be,!0),z=null),K.patchFlag===-2&&(Ge=!1,K.dynamicChildren=null);const{type:Le,ref:mt,shapeFlag:it}=K;switch(Le){case Zu:g(z,K,he,Ce);break;case Ja:E(z,K,he,Ce);break;case hf:z==null&&v(K,he,Ce,Je);break;case tn:H(z,K,he,Ce,ye,be,Je,qe,Ge);break;default:it&1?T(z,K,he,Ce,ye,be,Je,qe,Ge):it&6?ue(z,K,he,Ce,ye,be,Je,qe,Ge):(it&64||it&128)&&Le.process(z,K,he,Ce,ye,be,Je,qe,Ge,ft)}mt!=null&&ye&&Xf(mt,z&&z.ref,be,K||z,!K)},g=(z,K,he,Ce)=>{if(z==null)i(K.el=o(K.children),he,Ce);else{const ye=K.el=z.el;K.children!==z.children&&c(ye,K.children)}},E=(z,K,he,Ce)=>{z==null?i(K.el=l(K.children||""),he,Ce):K.el=z.el},v=(z,K,he,Ce)=>{[z.el,z.anchor]=p(z.children,K,he,Ce,z.el,z.anchor)},x=({el:z,anchor:K},he,Ce)=>{let ye;for(;z&&z!==K;)ye=f(z),i(z,he,Ce),z=ye;i(K,he,Ce)},A=({el:z,anchor:K})=>{let he;for(;z&&z!==K;)he=f(z),r(z),z=he;r(K)},T=(z,K,he,Ce,ye,be,Je,qe,Ge)=>{K.type==="svg"?Je="svg":K.type==="math"&&(Je="mathml"),z==null?C(K,he,Ce,ye,be,Je,qe,Ge):D(z,K,ye,be,Je,qe,Ge)},C=(z,K,he,Ce,ye,be,Je,qe)=>{let Ge,Le;const{props:mt,shapeFlag:it,transition:dt,dirs:xt}=z;if(Ge=z.el=a(z.type,be,mt&&mt.is,mt),it&8?u(Ge,z.children):it&16&&P(z.children,Ge,null,Ce,ye,lf(z,be),Je,qe),xt&&La(z,null,Ce,"created"),y(Ge,z,z.scopeId,Je,Ce),mt){for(const Ht in mt)Ht!=="value"&&!Ol(Ht)&&s(Ge,Ht,null,mt[Ht],be,Ce);"value"in mt&&s(Ge,"value",null,mt.value,be),(Le=mt.onVnodeBeforeMount)&&Ks(Le,Ce,z)}xt&&La(z,null,Ce,"beforeMount");const bt=_P(ye,dt);bt&&dt.beforeEnter(Ge),i(Ge,K,he),((Le=mt&&mt.onVnodeMounted)||bt||xt)&&Es(()=>{Le&&Ks(Le,Ce,z),bt&&dt.enter(Ge),xt&&La(z,null,Ce,"mounted")},ye)},y=(z,K,he,Ce,ye)=>{if(he&&d(z,he),Ce)for(let be=0;be<Ce.length;be++)d(z,Ce[be]);if(ye){let be=ye.subTree;if(K===be||CS(be.type)&&(be.ssContent===K||be.ssFallback===K)){const Je=ye.vnode;y(z,Je,Je.scopeId,Je.slotScopeIds,ye.parent)}}},P=(z,K,he,Ce,ye,be,Je,qe,Ge=0)=>{for(let Le=Ge;Le<z.length;Le++){const mt=z[Le]=qe?sa(z[Le]):rn(z[Le]);_(null,mt,K,he,Ce,ye,be,Je,qe)}},D=(z,K,he,Ce,ye,be,Je)=>{const qe=K.el=z.el;let{patchFlag:Ge,dynamicChildren:Le,dirs:mt}=K;Ge|=z.patchFlag&16;const it=z.props||Bi,dt=K.props||Bi;let xt;if(he&&Fa(he,!1),(xt=dt.onVnodeBeforeUpdate)&&Ks(xt,he,K,z),mt&&La(K,z,he,"beforeUpdate"),he&&Fa(he,!0),(it.innerHTML&&dt.innerHTML==null||it.textContent&&dt.textContent==null)&&u(qe,""),Le?F(z.dynamicChildren,Le,qe,he,Ce,lf(K,ye),be):Je||Ee(z,K,qe,null,he,Ce,lf(K,ye),be,!1),Ge>0){if(Ge&16)W(qe,it,dt,he,ye);else if(Ge&2&&it.class!==dt.class&&s(qe,"class",null,dt.class,ye),Ge&4&&s(qe,"style",it.style,dt.style,ye),Ge&8){const bt=K.dynamicProps;for(let Ht=0;Ht<bt.length;Ht++){const Ut=bt[Ht],yi=it[Ut],Ct=dt[Ut];(Ct!==yi||Ut==="value")&&s(qe,Ut,yi,Ct,ye,he)}}Ge&1&&z.children!==K.children&&u(qe,K.children)}else!Je&&Le==null&&W(qe,it,dt,he,ye);((xt=dt.onVnodeUpdated)||mt)&&Es(()=>{xt&&Ks(xt,he,K,z),mt&&La(K,z,he,"updated")},Ce)},F=(z,K,he,Ce,ye,be,Je)=>{for(let qe=0;qe<K.length;qe++){const Ge=z[qe],Le=K[qe],mt=Ge.el&&(Ge.type===tn||!Al(Ge,Le)||Ge.shapeFlag&70)?h(Ge.el):he;_(Ge,Le,mt,null,Ce,ye,be,Je,!0)}},W=(z,K,he,Ce,ye)=>{if(K!==he){if(K!==Bi)for(const be in K)!Ol(be)&&!(be in he)&&s(z,be,K[be],null,ye,Ce);for(const be in he){if(Ol(be))continue;const Je=he[be],qe=K[be];Je!==qe&&be!=="value"&&s(z,be,qe,Je,ye,Ce)}"value"in he&&s(z,"value",K.value,he.value,ye)}},H=(z,K,he,Ce,ye,be,Je,qe,Ge)=>{const Le=K.el=z?z.el:o(""),mt=K.anchor=z?z.anchor:o("");let{patchFlag:it,dynamicChildren:dt,slotScopeIds:xt}=K;xt&&(qe=qe?qe.concat(xt):xt),z==null?(i(Le,he,Ce),i(mt,he,Ce),P(K.children||[],he,mt,ye,be,Je,qe,Ge)):it>0&&it&64&&dt&&z.dynamicChildren?(F(z.dynamicChildren,dt,he,ye,be,Je,qe),(K.key!=null||ye&&K===ye.subTree)&&ES(z,K,!0)):Ee(z,K,he,mt,ye,be,Je,qe,Ge)},ue=(z,K,he,Ce,ye,be,Je,qe,Ge)=>{K.slotScopeIds=qe,z==null?K.shapeFlag&512?ye.ctx.activate(K,he,Ce,Je,Ge):ae(K,he,Ce,ye,be,Je,Ge):le(z,K,Ge)},ae=(z,K,he,Ce,ye,be,Je)=>{const qe=z.component=FP(z,Ce,ye);if(rS(z)&&(qe.ctx.renderer=ft),wP(qe,!1,Je),qe.asyncDep){if(ye&&ye.registerDep(qe,oe,Je),!z.el){const Ge=qe.subTree=zs(Ja);E(null,Ge,K,he)}}else oe(qe,z,K,he,ye,be,Je)},le=(z,K,he)=>{const Ce=K.component=z.component;if(AP(z,K,he))if(Ce.asyncDep&&!Ce.asyncResolved){ge(Ce,K,he);return}else Ce.next=K,Ce.update();else K.el=z.el,Ce.vnode=K},oe=(z,K,he,Ce,ye,be,Je)=>{const qe=()=>{if(z.isMounted){let{next:it,bu:dt,u:xt,parent:bt,vnode:Ht}=z;{const di=vS(z);if(di){it&&(it.el=Ht.el,ge(z,it,Je)),di.asyncDep.then(()=>{z.isUnmounted||qe()});return}}let Ut=it,yi;Fa(z,!1),it?(it.el=Ht.el,ge(z,it,Je)):it=Ht,dt&&tf(dt),(yi=it.props&&it.props.onVnodeBeforeUpdate)&&Ks(yi,bt,it,Ht),Fa(z,!0);const Ct=uf(z),Mi=z.subTree;z.subTree=Ct,_(Mi,Ct,h(Mi.el),Me(Mi),z,ye,be),it.el=Ct.el,Ut===null&&IP(z,Ct.el),xt&&Es(xt,ye),(yi=it.props&&it.props.onVnodeUpdated)&&Es(()=>Ks(yi,bt,it,Ht),ye)}else{let it;const{el:dt,props:xt}=K,{bm:bt,m:Ht,parent:Ut,root:yi,type:Ct}=z,Mi=wl(K);if(Fa(z,!1),bt&&tf(bt),!Mi&&(it=xt&&xt.onVnodeBeforeMount)&&Ks(it,Ut,K),Fa(z,!0),dt&&xe){const di=()=>{z.subTree=uf(z),xe(dt,z.subTree,z,ye,null)};Mi&&Ct.__asyncHydrate?Ct.__asyncHydrate(dt,z,di):di()}else{yi.ce&&yi.ce._injectChildStyle(Ct);const di=z.subTree=uf(z);_(null,di,he,Ce,z,ye,be),K.el=di.el}if(Ht&&Es(Ht,ye),!Mi&&(it=xt&&xt.onVnodeMounted)){const di=K;Es(()=>Ks(it,Ut,di),ye)}(K.shapeFlag&256||Ut&&wl(Ut.vnode)&&Ut.vnode.shapeFlag&256)&&z.a&&Es(z.a,ye),z.isMounted=!0,K=he=Ce=null}};z.scope.on();const Ge=z.effect=new Fv(qe);z.scope.off();const Le=z.update=Ge.run.bind(Ge),mt=z.job=Ge.runIfDirty.bind(Ge);mt.i=z,mt.id=z.uid,Ge.scheduler=()=>Hd(mt),Fa(z,!0),Le()},ge=(z,K,he)=>{K.component=z;const Ce=z.vnode.props;z.vnode=K,z.next=null,lP(z,K.props,Ce,he),fP(z,K.children,he),Ca(),H_(z),Aa()},Ee=(z,K,he,Ce,ye,be,Je,qe,Ge=!1)=>{const Le=z&&z.children,mt=z?z.shapeFlag:0,it=K.children,{patchFlag:dt,shapeFlag:xt}=K;if(dt>0){if(dt&128){j(Le,it,he,Ce,ye,be,Je,qe,Ge);return}else if(dt&256){ne(Le,it,he,Ce,ye,be,Je,qe,Ge);return}}xt&8?(mt&16&&ve(Le,ye,be),it!==Le&&u(he,it)):mt&16?xt&16?j(Le,it,he,Ce,ye,be,Je,qe,Ge):ve(Le,ye,be,!0):(mt&8&&u(he,""),xt&16&&P(it,he,Ce,ye,be,Je,qe,Ge))},ne=(z,K,he,Ce,ye,be,Je,qe,Ge)=>{z=z||Oo,K=K||Oo;const Le=z.length,mt=K.length,it=Math.min(Le,mt);let dt;for(dt=0;dt<it;dt++){const xt=K[dt]=Ge?sa(K[dt]):rn(K[dt]);_(z[dt],xt,he,null,ye,be,Je,qe,Ge)}Le>mt?ve(z,ye,be,!0,!1,it):P(K,he,Ce,ye,be,Je,qe,Ge,it)},j=(z,K,he,Ce,ye,be,Je,qe,Ge)=>{let Le=0;const mt=K.length;let it=z.length-1,dt=mt-1;for(;Le<=it&&Le<=dt;){const xt=z[Le],bt=K[Le]=Ge?sa(K[Le]):rn(K[Le]);if(Al(xt,bt))_(xt,bt,he,null,ye,be,Je,qe,Ge);else break;Le++}for(;Le<=it&&Le<=dt;){const xt=z[it],bt=K[dt]=Ge?sa(K[dt]):rn(K[dt]);if(Al(xt,bt))_(xt,bt,he,null,ye,be,Je,qe,Ge);else break;it--,dt--}if(Le>it){if(Le<=dt){const xt=dt+1,bt=xt<mt?K[xt].el:Ce;for(;Le<=dt;)_(null,K[Le]=Ge?sa(K[Le]):rn(K[Le]),he,bt,ye,be,Je,qe,Ge),Le++}}else if(Le>dt)for(;Le<=it;)Y(z[Le],ye,be,!0),Le++;else{const xt=Le,bt=Le,Ht=new Map;for(Le=bt;Le<=dt;Le++){const Di=K[Le]=Ge?sa(K[Le]):rn(K[Le]);Di.key!=null&&Ht.set(Di.key,Le)}let Ut,yi=0;const Ct=dt-bt+1;let Mi=!1,di=0;const Wr=new Array(Ct);for(Le=0;Le<Ct;Le++)Wr[Le]=0;for(Le=xt;Le<=it;Le++){const Di=z[Le];if(yi>=Ct){Y(Di,ye,be,!0);continue}let Pr;if(Di.key!=null)Pr=Ht.get(Di.key);else for(Ut=bt;Ut<=dt;Ut++)if(Wr[Ut-bt]===0&&Al(Di,K[Ut])){Pr=Ut;break}Pr===void 0?Y(Di,ye,be,!0):(Wr[Pr-bt]=Le+1,Pr>=di?di=Pr:Mi=!0,_(Di,K[Pr],he,null,ye,be,Je,qe,Ge),yi++)}const Ki=Mi?mP(Wr):Oo;for(Ut=Ki.length-1,Le=Ct-1;Le>=0;Le--){const Di=bt+Le,Pr=K[Di],In=Di+1<mt?K[Di+1].el:Ce;Wr[Le]===0?_(null,Pr,he,In,ye,be,Je,qe,Ge):Mi&&(Ut<0||Le!==Ki[Ut]?L(Pr,he,In,2):Ut--)}}},L=(z,K,he,Ce,ye=null)=>{const{el:be,type:Je,transition:qe,children:Ge,shapeFlag:Le}=z;if(Le&6){L(z.component.subTree,K,he,Ce);return}if(Le&128){z.suspense.move(K,he,Ce);return}if(Le&64){Je.move(z,K,he,ft);return}if(Je===tn){i(be,K,he);for(let it=0;it<Ge.length;it++)L(Ge[it],K,he,Ce);i(z.anchor,K,he);return}if(Je===hf){x(z,K,he);return}if(Ce!==2&&Le&1&&qe)if(Ce===0)qe.beforeEnter(be),i(be,K,he),Es(()=>qe.enter(be),ye);else{const{leave:it,delayLeave:dt,afterLeave:xt}=qe,bt=()=>i(be,K,he),Ht=()=>{it(be,()=>{bt(),xt&&xt()})};dt?dt(be,bt,Ht):Ht()}else i(be,K,he)},Y=(z,K,he,Ce=!1,ye=!1)=>{const{type:be,props:Je,ref:qe,children:Ge,dynamicChildren:Le,shapeFlag:mt,patchFlag:it,dirs:dt,cacheIndex:xt}=z;if(it===-2&&(ye=!1),qe!=null&&Xf(qe,null,he,z,!0),xt!=null&&(K.renderCache[xt]=void 0),mt&256){K.ctx.deactivate(z);return}const bt=mt&1&&dt,Ht=!wl(z);let Ut;if(Ht&&(Ut=Je&&Je.onVnodeBeforeUnmount)&&Ks(Ut,K,z),mt&6)Ve(z.component,he,Ce);else{if(mt&128){z.suspense.unmount(he,Ce);return}bt&&La(z,null,K,"beforeUnmount"),mt&64?z.type.remove(z,K,he,ft,Ce):Le&&!Le.hasOnce&&(be!==tn||it>0&&it&64)?ve(Le,K,he,!1,!0):(be===tn&&it&384||!ye&&mt&16)&&ve(Ge,K,he),Ce&&te(z)}(Ht&&(Ut=Je&&Je.onVnodeUnmounted)||bt)&&Es(()=>{Ut&&Ks(Ut,K,z),bt&&La(z,null,K,"unmounted")},he)},te=z=>{const{type:K,el:he,anchor:Ce,transition:ye}=z;if(K===tn){De(he,Ce);return}if(K===hf){A(z);return}const be=()=>{r(he),ye&&!ye.persisted&&ye.afterLeave&&ye.afterLeave()};if(z.shapeFlag&1&&ye&&!ye.persisted){const{leave:Je,delayLeave:qe}=ye,Ge=()=>Je(he,be);qe?qe(z.el,be,Ge):Ge()}else be()},De=(z,K)=>{let he;for(;z!==K;)he=f(z),r(z),z=he;r(K)},Ve=(z,K,he)=>{const{bum:Ce,scope:ye,job:be,subTree:Je,um:qe,m:Ge,a:Le}=z;q_(Ge),q_(Le),Ce&&tf(Ce),ye.stop(),be&&(be.flags|=8,Y(Je,z,K,he)),qe&&Es(qe,K),Es(()=>{z.isUnmounted=!0},K),K&&K.pendingBranch&&!K.isUnmounted&&z.asyncDep&&!z.asyncResolved&&z.suspenseId===K.pendingId&&(K.deps--,K.deps===0&&K.resolve())},ve=(z,K,he,Ce=!1,ye=!1,be=0)=>{for(let Je=be;Je<z.length;Je++)Y(z[Je],K,he,Ce,ye)},Me=z=>{if(z.shapeFlag&6)return Me(z.component.subTree);if(z.shapeFlag&128)return z.suspense.next();const K=f(z.anchor||z.el),he=K&&K[VR];return he?f(he):K};let Re=!1;const Pe=(z,K,he)=>{z==null?K._vnode&&Y(K._vnode,null,null,!0):_(K._vnode||null,z,K,null,null,null,he),K._vnode=z,Re||(Re=!0,H_(),Jv(),Re=!1)},ft={p:_,um:Y,m:L,r:te,mt:ae,mc:P,pc:Ee,pbc:F,n:Me,o:n};let Wt,xe;return{render:Pe,hydrate:Wt,createApp:nP(Pe,Wt)}}function lf({type:n,props:e},t){return t==="svg"&&n==="foreignObject"||t==="mathml"&&n==="annotation-xml"&&e&&e.encoding&&e.encoding.includes("html")?void 0:t}function Fa({effect:n,job:e},t){t?(n.flags|=32,e.flags|=4):(n.flags&=-33,e.flags&=-5)}function _P(n,e){return(!n||n&&!n.pendingBranch)&&e&&!e.persisted}function ES(n,e,t=!1){const i=n.children,r=e.children;if(Bt(i)&&Bt(r))for(let s=0;s<i.length;s++){const a=i[s];let o=r[s];o.shapeFlag&1&&!o.dynamicChildren&&((o.patchFlag<=0||o.patchFlag===32)&&(o=r[s]=sa(r[s]),o.el=a.el),!t&&o.patchFlag!==-2&&ES(a,o)),o.type===Zu&&(o.el=a.el)}}function mP(n){const e=n.slice(),t=[0];let i,r,s,a,o;const l=n.length;for(i=0;i<l;i++){const c=n[i];if(c!==0){if(r=t[t.length-1],n[r]<c){e[i]=r,t.push(i);continue}for(s=0,a=t.length-1;s<a;)o=s+a>>1,n[t[o]]<c?s=o+1:a=o;c<n[t[s]]&&(s>0&&(e[i]=t[s-1]),t[s]=i)}}for(s=t.length,a=t[s-1];s-- >0;)t[s]=a,a=e[a];return t}function vS(n){const e=n.subTree.component;if(e)return e.asyncDep&&!e.asyncResolved?e:vS(e)}function q_(n){if(n)for(let e=0;e<n.length;e++)n[e].flags|=8}const gP=Symbol.for("v-scx"),EP=()=>ru(gP);function cf(n,e,t){return SS(n,e,t)}function SS(n,e,t=Bi){const{immediate:i,deep:r,flush:s,once:a}=t,o=Rr({},t),l=e&&i||!e&&s!=="post";let c;if(Zl){if(s==="sync"){const d=EP();c=d.__watcherHandles||(d.__watcherHandles=[])}else if(!l){const d=()=>{};return d.stop=pn,d.resume=pn,d.pause=pn,d}}const u=Zr;o.call=(d,p,_)=>mn(d,u,p,_);let h=!1;s==="post"?o.scheduler=d=>{Es(d,u&&u.suspense)}:s!=="sync"&&(h=!0,o.scheduler=(d,p)=>{p?d():Hd(d)}),o.augmentJob=d=>{e&&(d.flags|=4),h&&(d.flags|=2,u&&(d.id=u.uid,d.i=u))};const f=OR(n,e,o);return Zl&&(c?c.push(f):l&&f()),f}function vP(n,e,t){const i=this.proxy,r=xr(n)?n.includes(".")?TS(i,n):()=>i[n]:n.bind(i,i);let s;zt(e)?s=e:(s=e.handler,t=e);const a=pc(this),o=SS(r,s.bind(i),t);return a(),o}function TS(n,e){const t=e.split(".");return()=>{let i=n;for(let r=0;r<t.length&&i;r++)i=i[t[r]];return i}}const SP=(n,e)=>e==="modelValue"||e==="model-value"?n.modelModifiers:n[`${e}Modifiers`]||n[`${ga(e)}Modifiers`]||n[`${no(e)}Modifiers`];function TP(n,e,...t){if(n.isUnmounted)return;const i=n.vnode.props||Bi;let r=t;const s=e.startsWith("update:"),a=s&&SP(i,e.slice(7));a&&(a.trim&&(r=t.map(u=>xr(u)?u.trim():u)),a.number&&(r=t.map(q0)));let o,l=i[o=ef(e)]||i[o=ef(ga(e))];!l&&s&&(l=i[o=ef(no(e))]),l&&mn(l,n,6,r);const c=i[o+"Once"];if(c){if(!n.emitted)n.emitted={};else if(n.emitted[o])return;n.emitted[o]=!0,mn(c,n,6,r)}}function xS(n,e,t=!1){const i=e.emitsCache,r=i.get(n);if(r!==void 0)return r;const s=n.emits;let a={},o=!1;if(!zt(n)){const l=c=>{const u=xS(c,e,!0);u&&(o=!0,Rr(a,u))};!t&&e.mixins.length&&e.mixins.forEach(l),n.extends&&l(n.extends),n.mixins&&n.mixins.forEach(l)}return!s&&!o?(nr(n)&&i.set(n,null),null):(Bt(s)?s.forEach(l=>a[l]=null):Rr(a,s),nr(n)&&i.set(n,a),a)}function qu(n,e){return!n||!Hu(e)?!1:(e=e.slice(2).replace(/Once$/,""),gi(n,e[0].toLowerCase()+e.slice(1))||gi(n,no(e))||gi(n,e))}function uf(n){const{type:e,vnode:t,proxy:i,withProxy:r,propsOptions:[s],slots:a,attrs:o,emit:l,render:c,renderCache:u,props:h,data:f,setupState:d,ctx:p,inheritAttrs:_}=n,g=Su(n);let E,v;try{if(t.shapeFlag&4){const A=r||i,T=A;E=rn(c.call(T,A,u,h,d,f,p)),v=o}else{const A=e;E=rn(A.length>1?A(h,{attrs:o,slots:a,emit:l}):A(h,null)),v=e.props?o:xP(o)}}catch(A){Vl.length=0,Ku(A,n,1),E=zs(Ja)}let x=E;if(v&&_!==!1){const A=Object.keys(v),{shapeFlag:T}=x;A.length&&T&7&&(s&&A.some(Dd)&&(v=CP(v,s)),x=Ko(x,v,!1,!0))}return t.dirs&&(x=Ko(x,null,!1,!0),x.dirs=x.dirs?x.dirs.concat(t.dirs):t.dirs),t.transition&&Xd(x,t.transition),E=x,Su(g),E}const xP=n=>{let e;for(const t in n)(t==="class"||t==="style"||Hu(t))&&((e||(e={}))[t]=n[t]);return e},CP=(n,e)=>{const t={};for(const i in n)(!Dd(i)||!(i.slice(9)in e))&&(t[i]=n[i]);return t};function AP(n,e,t){const{props:i,children:r,component:s}=n,{props:a,children:o,patchFlag:l}=e,c=s.emitsOptions;if(e.dirs||e.transition)return!0;if(t&&l>=0){if(l&1024)return!0;if(l&16)return i?Z_(i,a,c):!!a;if(l&8){const u=e.dynamicProps;for(let h=0;h<u.length;h++){const f=u[h];if(a[f]!==i[f]&&!qu(c,f))return!0}}}else return(r||o)&&(!o||!o.$stable)?!0:i===a?!1:i?a?Z_(i,a,c):!0:!!a;return!1}function Z_(n,e,t){const i=Object.keys(e);if(i.length!==Object.keys(n).length)return!0;for(let r=0;r<i.length;r++){const s=i[r];if(e[s]!==n[s]&&!qu(t,s))return!0}return!1}function IP({vnode:n,parent:e},t){for(;e;){const i=e.subTree;if(i.suspense&&i.suspense.activeBranch===n&&(i.el=n.el),i===n)(n=e.vnode).el=t,e=e.parent;else break}}const CS=n=>n.__isSuspense;function yP(n,e){e&&e.pendingBranch?Bt(n)?e.effects.push(...n):e.effects.push(n):wR(n)}const tn=Symbol.for("v-fgt"),Zu=Symbol.for("v-txt"),Ja=Symbol.for("v-cmt"),hf=Symbol.for("v-stc"),Vl=[];let Is=null;function wo(n=!1){Vl.push(Is=n?null:[])}function bP(){Vl.pop(),Is=Vl[Vl.length-1]||null}let ql=1;function Q_(n){ql+=n,n<0&&Is&&(Is.hasOnce=!0)}function AS(n){return n.dynamicChildren=ql>0?Is||Oo:null,bP(),ql>0&&Is&&Is.push(n),n}function Ul(n,e,t,i,r,s){return AS(Dn(n,e,t,i,r,s,!0))}function RP(n,e,t,i,r){return AS(zs(n,e,t,i,r,!0))}function IS(n){return n?n.__v_isVNode===!0:!1}function Al(n,e){return n.type===e.type&&n.key===e.key}const yS=({key:n})=>n??null,su=({ref:n,ref_key:e,ref_for:t})=>(typeof n=="number"&&(n=""+n),n!=null?xr(n)||kr(n)||zt(n)?{i:un,r:n,k:e,f:!!t}:n:null);function Dn(n,e=null,t=null,i=0,r=null,s=n===tn?0:1,a=!1,o=!1){const l={__v_isVNode:!0,__v_skip:!0,type:n,props:e,key:e&&yS(e),ref:e&&su(e),scopeId:tS,slotScopeIds:null,children:t,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetStart:null,targetAnchor:null,staticCount:0,shapeFlag:s,patchFlag:i,dynamicProps:r,dynamicChildren:null,appContext:null,ctx:un};return o?(jd(l,t),s&128&&n.normalize(l)):t&&(l.shapeFlag|=xr(t)?8:16),ql>0&&!a&&Is&&(l.patchFlag>0||s&6)&&l.patchFlag!==32&&Is.push(l),l}const zs=PP;function PP(n,e=null,t=null,i=0,r=null,s=!1){if((!n||n===ZR)&&(n=Ja),IS(n)){const o=Ko(n,e,!0);return t&&jd(o,t),ql>0&&!s&&Is&&(o.shapeFlag&6?Is[Is.indexOf(n)]=o:Is.push(o)),o.patchFlag=-2,o}if(kP(n)&&(n=n.__vccOpts),e){e=MP(e);let{class:o,style:l}=e;o&&!xr(o)&&(e.class=Yl(o)),nr(l)&&(Wd(l)&&!Bt(l)&&(l=Rr({},l)),e.style=Ld(l))}const a=xr(n)?1:CS(n)?128:UR(n)?64:nr(n)?4:zt(n)?2:0;return Dn(n,e,t,i,r,a,s,!0)}function MP(n){return n?Wd(n)||hS(n)?Rr({},n):n:null}function Ko(n,e,t=!1,i=!1){const{props:r,ref:s,patchFlag:a,children:o,transition:l}=n,c=e?OP(r||{},e):r,u={__v_isVNode:!0,__v_skip:!0,type:n.type,props:c,key:c&&yS(c),ref:e&&e.ref?t&&s?Bt(s)?s.concat(su(e)):[s,su(e)]:su(e):s,scopeId:n.scopeId,slotScopeIds:n.slotScopeIds,children:o,target:n.target,targetStart:n.targetStart,targetAnchor:n.targetAnchor,staticCount:n.staticCount,shapeFlag:n.shapeFlag,patchFlag:e&&n.type!==tn?a===-1?16:a|16:a,dynamicProps:n.dynamicProps,dynamicChildren:n.dynamicChildren,appContext:n.appContext,dirs:n.dirs,transition:l,component:n.component,suspense:n.suspense,ssContent:n.ssContent&&Ko(n.ssContent),ssFallback:n.ssFallback&&Ko(n.ssFallback),el:n.el,anchor:n.anchor,ctx:n.ctx,ce:n.ce};return l&&i&&Xd(u,l.clone(u)),u}function DP(n=" ",e=0){return zs(Zu,null,n,e)}function J_(n="",e=!1){return e?(wo(),RP(Ja,null,n)):zs(Ja,null,n)}function rn(n){return n==null||typeof n=="boolean"?zs(Ja):Bt(n)?zs(tn,null,n.slice()):IS(n)?sa(n):zs(Zu,null,String(n))}function sa(n){return n.el===null&&n.patchFlag!==-1||n.memo?n:Ko(n)}function jd(n,e){let t=0;const{shapeFlag:i}=n;if(e==null)e=null;else if(Bt(e))t=16;else if(typeof e=="object")if(i&65){const r=e.default;r&&(r._c&&(r._d=!1),jd(n,r()),r._c&&(r._d=!0));return}else{t=32;const r=e._;!r&&!hS(e)?e._ctx=un:r===3&&un&&(un.slots._===1?e._=1:(e._=2,n.patchFlag|=1024))}else zt(e)?(e={default:e,_ctx:un},t=32):(e=String(e),i&64?(t=16,e=[DP(e)]):t=8);n.children=e,n.shapeFlag|=t}function OP(...n){const e={};for(let t=0;t<n.length;t++){const i=n[t];for(const r in i)if(r==="class")e.class!==i.class&&(e.class=Yl([e.class,i.class]));else if(r==="style")e.style=Ld([e.style,i.style]);else if(Hu(r)){const s=e[r],a=i[r];a&&s!==a&&!(Bt(s)&&s.includes(a))&&(e[r]=s?[].concat(s,a):a)}else r!==""&&(e[r]=i[r])}return e}function Ks(n,e,t,i=null){mn(n,e,7,[t,i])}const NP=lS();let LP=0;function FP(n,e,t){const i=n.type,r=(e?e.appContext:n.appContext)||NP,s={uid:LP++,vnode:n,type:i,parent:e,appContext:r,root:null,next:null,subTree:null,effect:null,update:null,job:null,scope:new rR(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:e?e.provides:Object.create(r.provides),ids:e?e.ids:["",0,0],accessCache:null,renderCache:[],components:null,directives:null,propsOptions:dS(i,r),emitsOptions:xS(i,r),emit:null,emitted:null,propsDefaults:Bi,inheritAttrs:i.inheritAttrs,ctx:Bi,data:Bi,props:Bi,attrs:Bi,slots:Bi,refs:Bi,setupState:Bi,setupContext:null,suspense:t,suspenseId:t?t.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return s.ctx={_:s},s.root=e?e.root:s,s.emit=TP.bind(null,s),n.ce&&n.ce(s),s}let Zr=null,xu,qf;{const n=$u(),e=(t,i)=>{let r;return(r=n[t])||(r=n[t]=[]),r.push(i),s=>{r.length>1?r.forEach(a=>a(s)):r[0](s)}};xu=e("__VUE_INSTANCE_SETTERS__",t=>Zr=t),qf=e("__VUE_SSR_SETTERS__",t=>Zl=t)}const pc=n=>{const e=Zr;return xu(n),n.scope.on(),()=>{n.scope.off(),xu(e)}},em=()=>{Zr&&Zr.scope.off(),xu(null)};function bS(n){return n.vnode.shapeFlag&4}let Zl=!1;function wP(n,e=!1,t=!1){e&&qf(e);const{props:i,children:r}=n.vnode,s=bS(n);oP(n,i,s,e),hP(n,r,t);const a=s?BP(n,e):void 0;return e&&qf(!1),a}function BP(n,e){const t=n.type;n.accessCache=Object.create(null),n.proxy=new Proxy(n.ctx,QR);const{setup:i}=t;if(i){Ca();const r=n.setupContext=i.length>1?UP(n):null,s=pc(n),a=dc(i,n,0,[n.props,r]),o=yv(a);if(Aa(),s(),(o||n.sp)&&!wl(n)&&iS(n),o){if(a.then(em,em),e)return a.then(l=>{tm(n,l,e)}).catch(l=>{Ku(l,n,0)});n.asyncDep=a}else tm(n,a,e)}else RS(n,e)}function tm(n,e,t){zt(e)?n.type.__ssrInlineRender?n.ssrRender=e:n.render=e:nr(e)&&(n.setupState=qv(e)),RS(n,t)}let im;function RS(n,e,t){const i=n.type;if(!n.render){if(!e&&im&&!i.render){const r=i.template||$d(n).template;if(r){const{isCustomElement:s,compilerOptions:a}=n.appContext.config,{delimiters:o,compilerOptions:l}=i,c=Rr(Rr({isCustomElement:s,delimiters:o},a),l);i.render=im(r,c)}}n.render=i.render||pn}{const r=pc(n);Ca();try{JR(n)}finally{Aa(),r()}}}const VP={get(n,e){return Br(n,"get",""),n[e]}};function UP(n){const e=t=>{n.exposed=t||{}};return{attrs:new Proxy(n.attrs,VP),slots:n.slots,emit:n.emit,expose:e}}function qd(n){return n.exposed?n.exposeProxy||(n.exposeProxy=new Proxy(qv(AR(n.exposed)),{get(e,t){if(t in e)return e[t];if(t in Bl)return Bl[t](n)},has(e,t){return t in e||t in Bl}})):n.proxy}function kP(n){return zt(n)&&"__vccOpts"in n}const GP=(n,e)=>MR(n,e,Zl),zP="3.5.12";/**
* @vue/runtime-dom v3.5.12
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/let Zf;const rm=typeof window<"u"&&window.trustedTypes;if(rm)try{Zf=rm.createPolicy("vue",{createHTML:n=>n})}catch{}const PS=Zf?n=>Zf.createHTML(n):n=>n,WP="http://www.w3.org/2000/svg",HP="http://www.w3.org/1998/Math/MathML",On=typeof document<"u"?document:null,sm=On&&On.createElement("template"),XP={insert:(n,e,t)=>{e.insertBefore(n,t||null)},remove:n=>{const e=n.parentNode;e&&e.removeChild(n)},createElement:(n,e,t,i)=>{const r=e==="svg"?On.createElementNS(WP,n):e==="mathml"?On.createElementNS(HP,n):t?On.createElement(n,{is:t}):On.createElement(n);return n==="select"&&i&&i.multiple!=null&&r.setAttribute("multiple",i.multiple),r},createText:n=>On.createTextNode(n),createComment:n=>On.createComment(n),setText:(n,e)=>{n.nodeValue=e},setElementText:(n,e)=>{n.textContent=e},parentNode:n=>n.parentNode,nextSibling:n=>n.nextSibling,querySelector:n=>On.querySelector(n),setScopeId(n,e){n.setAttribute(e,"")},insertStaticContent(n,e,t,i,r,s){const a=t?t.previousSibling:e.lastChild;if(r&&(r===s||r.nextSibling))for(;e.insertBefore(r.cloneNode(!0),t),!(r===s||!(r=r.nextSibling)););else{sm.innerHTML=PS(i==="svg"?`<svg>${n}</svg>`:i==="mathml"?`<math>${n}</math>`:n);const o=sm.content;if(i==="svg"||i==="mathml"){const l=o.firstChild;for(;l.firstChild;)o.appendChild(l.firstChild);o.removeChild(l)}e.insertBefore(o,t)}return[a?a.nextSibling:e.firstChild,t?t.previousSibling:e.lastChild]}},YP=Symbol("_vtc");function $P(n,e,t){const i=n[YP];i&&(e=(e?[e,...i]:[...i]).join(" ")),e==null?n.removeAttribute("class"):t?n.setAttribute("class",e):n.className=e}const nm=Symbol("_vod"),KP=Symbol("_vsh"),jP=Symbol(""),qP=/(^|;)\s*display\s*:/;function ZP(n,e,t){const i=n.style,r=xr(t);let s=!1;if(t&&!r){if(e)if(xr(e))for(const a of e.split(";")){const o=a.slice(0,a.indexOf(":")).trim();t[o]==null&&nu(i,o,"")}else for(const a in e)t[a]==null&&nu(i,a,"");for(const a in t)a==="display"&&(s=!0),nu(i,a,t[a])}else if(r){if(e!==t){const a=i[jP];a&&(t+=";"+a),i.cssText=t,s=qP.test(t)}}else e&&n.removeAttribute("style");nm in n&&(n[nm]=s?i.display:"",n[KP]&&(i.display="none"))}const am=/\s*!important$/;function nu(n,e,t){if(Bt(t))t.forEach(i=>nu(n,e,i));else if(t==null&&(t=""),e.startsWith("--"))n.setProperty(e,t);else{const i=QP(n,e);am.test(t)?n.setProperty(no(i),t.replace(am,""),"important"):n[i]=t}}const om=["Webkit","Moz","ms"],ff={};function QP(n,e){const t=ff[e];if(t)return t;let i=ga(e);if(i!=="filter"&&i in n)return ff[e]=i;i=Pv(i);for(let r=0;r<om.length;r++){const s=om[r]+i;if(s in n)return ff[e]=s}return e}const lm="http://www.w3.org/1999/xlink";function cm(n,e,t,i,r,s=iR(e)){i&&e.startsWith("xlink:")?t==null?n.removeAttributeNS(lm,e.slice(6,e.length)):n.setAttributeNS(lm,e,t):t==null||s&&!Dv(t)?n.removeAttribute(e):n.setAttribute(e,s?"":xa(t)?String(t):t)}function um(n,e,t,i,r){if(e==="innerHTML"||e==="textContent"){t!=null&&(n[e]=e==="innerHTML"?PS(t):t);return}const s=n.tagName;if(e==="value"&&s!=="PROGRESS"&&!s.includes("-")){const o=s==="OPTION"?n.getAttribute("value")||"":n.value,l=t==null?n.type==="checkbox"?"on":"":String(t);(o!==l||!("_value"in n))&&(n.value=l),t==null&&n.removeAttribute(e),n._value=t;return}let a=!1;if(t===""||t==null){const o=typeof n[e];o==="boolean"?t=Dv(t):t==null&&o==="string"?(t="",a=!0):o==="number"&&(t=0,a=!0)}try{n[e]=t}catch{}a&&n.removeAttribute(r||e)}function JP(n,e,t,i){n.addEventListener(e,t,i)}function eM(n,e,t,i){n.removeEventListener(e,t,i)}const hm=Symbol("_vei");function tM(n,e,t,i,r=null){const s=n[hm]||(n[hm]={}),a=s[e];if(i&&a)a.value=i;else{const[o,l]=iM(e);if(i){const c=s[e]=nM(i,r);JP(n,o,c,l)}else a&&(eM(n,o,a,l),s[e]=void 0)}}const fm=/(?:Once|Passive|Capture)$/;function iM(n){let e;if(fm.test(n)){e={};let i;for(;i=n.match(fm);)n=n.slice(0,n.length-i[0].length),e[i[0].toLowerCase()]=!0}return[n[2]===":"?n.slice(3):no(n.slice(2)),e]}let df=0;const rM=Promise.resolve(),sM=()=>df||(rM.then(()=>df=0),df=Date.now());function nM(n,e){const t=i=>{if(!i._vts)i._vts=Date.now();else if(i._vts<=t.attached)return;mn(aM(i,t.value),e,5,[i])};return t.value=n,t.attached=sM(),t}function aM(n,e){if(Bt(e)){const t=n.stopImmediatePropagation;return n.stopImmediatePropagation=()=>{t.call(n),n._stopped=!0},e.map(i=>r=>!r._stopped&&i&&i(r))}else return e}const dm=n=>n.charCodeAt(0)===111&&n.charCodeAt(1)===110&&n.charCodeAt(2)>96&&n.charCodeAt(2)<123,oM=(n,e,t,i,r,s)=>{const a=r==="svg";e==="class"?$P(n,i,a):e==="style"?ZP(n,t,i):Hu(e)?Dd(e)||tM(n,e,t,i,s):(e[0]==="."?(e=e.slice(1),!0):e[0]==="^"?(e=e.slice(1),!1):lM(n,e,i,a))?(um(n,e,i),!n.tagName.includes("-")&&(e==="value"||e==="checked"||e==="selected")&&cm(n,e,i,a,s,e!=="value")):n._isVueCE&&(/[A-Z]/.test(e)||!xr(i))?um(n,ga(e),i,s,e):(e==="true-value"?n._trueValue=i:e==="false-value"&&(n._falseValue=i),cm(n,e,i,a))};function lM(n,e,t,i){if(i)return!!(e==="innerHTML"||e==="textContent"||e in n&&dm(e)&&zt(t));if(e==="spellcheck"||e==="draggable"||e==="translate"||e==="form"||e==="list"&&n.tagName==="INPUT"||e==="type"&&n.tagName==="TEXTAREA")return!1;if(e==="width"||e==="height"){const r=n.tagName;if(r==="IMG"||r==="VIDEO"||r==="CANVAS"||r==="SOURCE")return!1}return dm(e)&&xr(t)?!1:e in n}const cM=Rr({patchProp:oM},XP);let pm;function uM(){return pm||(pm=dP(cM))}const hM=(...n)=>{const e=uM().createApp(...n),{mount:t}=e;return e.mount=i=>{const r=dM(i);if(!r)return;const s=e._component;!zt(s)&&!s.render&&!s.template&&(s.template=r.innerHTML),r.nodeType===1&&(r.textContent="");const a=t(r,!1,fM(r));return r instanceof Element&&(r.removeAttribute("v-cloak"),r.setAttribute("data-v-app","")),a},e};function fM(n){if(n instanceof SVGElement)return"svg";if(typeof MathMLElement=="function"&&n instanceof MathMLElement)return"mathml"}function dM(n){return xr(n)?document.querySelector(n):n}class G{}G.AUTOSAMPLERSUFFIX="Sampler";G.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS";G.ALPHA_DISABLE=0;G.ALPHA_ADD=1;G.ALPHA_COMBINE=2;G.ALPHA_SUBTRACT=3;G.ALPHA_MULTIPLY=4;G.ALPHA_MAXIMIZED=5;G.ALPHA_ONEONE=6;G.ALPHA_PREMULTIPLIED=7;G.ALPHA_PREMULTIPLIED_PORTERDUFF=8;G.ALPHA_INTERPOLATE=9;G.ALPHA_SCREENMODE=10;G.ALPHA_ONEONE_ONEONE=11;G.ALPHA_ALPHATOCOLOR=12;G.ALPHA_REVERSEONEMINUS=13;G.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;G.ALPHA_ONEONE_ONEZERO=15;G.ALPHA_EXCLUSION=16;G.ALPHA_LAYER_ACCUMULATE=17;G.ALPHA_EQUATION_ADD=0;G.ALPHA_EQUATION_SUBSTRACT=1;G.ALPHA_EQUATION_REVERSE_SUBTRACT=2;G.ALPHA_EQUATION_MAX=3;G.ALPHA_EQUATION_MIN=4;G.ALPHA_EQUATION_DARKEN=5;G.DELAYLOADSTATE_NONE=0;G.DELAYLOADSTATE_LOADED=1;G.DELAYLOADSTATE_LOADING=2;G.DELAYLOADSTATE_NOTLOADED=4;G.NEVER=512;G.ALWAYS=519;G.LESS=513;G.EQUAL=514;G.LEQUAL=515;G.GREATER=516;G.GEQUAL=518;G.NOTEQUAL=517;G.KEEP=7680;G.ZERO=0;G.REPLACE=7681;G.INCR=7682;G.DECR=7683;G.INVERT=5386;G.INCR_WRAP=34055;G.DECR_WRAP=34056;G.TEXTURE_CLAMP_ADDRESSMODE=0;G.TEXTURE_WRAP_ADDRESSMODE=1;G.TEXTURE_MIRROR_ADDRESSMODE=2;G.TEXTURE_CREATIONFLAG_STORAGE=1;G.TEXTUREFORMAT_ALPHA=0;G.TEXTUREFORMAT_LUMINANCE=1;G.TEXTUREFORMAT_LUMINANCE_ALPHA=2;G.TEXTUREFORMAT_RGB=4;G.TEXTUREFORMAT_RGBA=5;G.TEXTUREFORMAT_RED=6;G.TEXTUREFORMAT_R=6;G.TEXTUREFORMAT_RG=7;G.TEXTUREFORMAT_RED_INTEGER=8;G.TEXTUREFORMAT_R_INTEGER=8;G.TEXTUREFORMAT_RG_INTEGER=9;G.TEXTUREFORMAT_RGB_INTEGER=10;G.TEXTUREFORMAT_RGBA_INTEGER=11;G.TEXTUREFORMAT_BGRA=12;G.TEXTUREFORMAT_DEPTH24_STENCIL8=13;G.TEXTUREFORMAT_DEPTH32_FLOAT=14;G.TEXTUREFORMAT_DEPTH16=15;G.TEXTUREFORMAT_DEPTH24=16;G.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;G.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;G.TEXTUREFORMAT_STENCIL8=19;G.TEXTUREFORMAT_UNDEFINED=4294967295;G.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;G.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;G.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;G.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;G.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;G.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;G.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;G.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;G.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;G.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;G.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;G.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;G.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;G.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;G.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;G.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;G.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;G.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;G.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;G.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;G.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;G.TEXTURETYPE_UNSIGNED_BYTE=0;G.TEXTURETYPE_UNSIGNED_INT=0;G.TEXTURETYPE_FLOAT=1;G.TEXTURETYPE_HALF_FLOAT=2;G.TEXTURETYPE_BYTE=3;G.TEXTURETYPE_SHORT=4;G.TEXTURETYPE_UNSIGNED_SHORT=5;G.TEXTURETYPE_INT=6;G.TEXTURETYPE_UNSIGNED_INTEGER=7;G.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;G.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;G.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;G.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;G.TEXTURETYPE_UNSIGNED_INT_24_8=12;G.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;G.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;G.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;G.TEXTURETYPE_UNDEFINED=16;G.TEXTURE_2D=3553;G.TEXTURE_2D_ARRAY=35866;G.TEXTURE_CUBE_MAP=34067;G.TEXTURE_CUBE_MAP_ARRAY=3735928559;G.TEXTURE_3D=32879;G.TEXTURE_NEAREST_SAMPLINGMODE=1;G.TEXTURE_NEAREST_NEAREST=1;G.TEXTURE_BILINEAR_SAMPLINGMODE=2;G.TEXTURE_LINEAR_LINEAR=2;G.TEXTURE_TRILINEAR_SAMPLINGMODE=3;G.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;G.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;G.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;G.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;G.TEXTURE_NEAREST_LINEAR=7;G.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;G.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;G.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;G.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;G.TEXTURE_LINEAR_NEAREST=12;G.TEXTURE_EXPLICIT_MODE=0;G.TEXTURE_SPHERICAL_MODE=1;G.TEXTURE_PLANAR_MODE=2;G.TEXTURE_CUBIC_MODE=3;G.TEXTURE_PROJECTION_MODE=4;G.TEXTURE_SKYBOX_MODE=5;G.TEXTURE_INVCUBIC_MODE=6;G.TEXTURE_EQUIRECTANGULAR_MODE=7;G.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;G.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;G.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;G.TEXTURE_FILTERING_QUALITY_HIGH=64;G.TEXTURE_FILTERING_QUALITY_MEDIUM=16;G.TEXTURE_FILTERING_QUALITY_LOW=8;G.SCALEMODE_FLOOR=1;G.SCALEMODE_NEAREST=2;G.SCALEMODE_CEILING=3;G.MATERIAL_TextureDirtyFlag=1;G.MATERIAL_LightDirtyFlag=2;G.MATERIAL_FresnelDirtyFlag=4;G.MATERIAL_AttributesDirtyFlag=8;G.MATERIAL_MiscDirtyFlag=16;G.MATERIAL_PrePassDirtyFlag=32;G.MATERIAL_AllDirtyFlag=63;G.MATERIAL_TriangleFillMode=0;G.MATERIAL_WireFrameFillMode=1;G.MATERIAL_PointFillMode=2;G.MATERIAL_PointListDrawMode=3;G.MATERIAL_LineListDrawMode=4;G.MATERIAL_LineLoopDrawMode=5;G.MATERIAL_LineStripDrawMode=6;G.MATERIAL_TriangleStripDrawMode=7;G.MATERIAL_TriangleFanDrawMode=8;G.MATERIAL_ClockWiseSideOrientation=0;G.MATERIAL_CounterClockWiseSideOrientation=1;G.ACTION_NothingTrigger=0;G.ACTION_OnPickTrigger=1;G.ACTION_OnLeftPickTrigger=2;G.ACTION_OnRightPickTrigger=3;G.ACTION_OnCenterPickTrigger=4;G.ACTION_OnPickDownTrigger=5;G.ACTION_OnDoublePickTrigger=6;G.ACTION_OnPickUpTrigger=7;G.ACTION_OnPickOutTrigger=16;G.ACTION_OnLongPressTrigger=8;G.ACTION_OnPointerOverTrigger=9;G.ACTION_OnPointerOutTrigger=10;G.ACTION_OnEveryFrameTrigger=11;G.ACTION_OnIntersectionEnterTrigger=12;G.ACTION_OnIntersectionExitTrigger=13;G.ACTION_OnKeyDownTrigger=14;G.ACTION_OnKeyUpTrigger=15;G.PARTICLES_BILLBOARDMODE_Y=2;G.PARTICLES_BILLBOARDMODE_ALL=7;G.PARTICLES_BILLBOARDMODE_STRETCHED=8;G.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;G.MESHES_CULLINGSTRATEGY_STANDARD=0;G.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;G.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;G.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;G.SCENELOADER_NO_LOGGING=0;G.SCENELOADER_MINIMAL_LOGGING=1;G.SCENELOADER_SUMMARY_LOGGING=2;G.SCENELOADER_DETAILED_LOGGING=3;G.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;G.PREPASS_POSITION_TEXTURE_TYPE=1;G.PREPASS_VELOCITY_TEXTURE_TYPE=2;G.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;G.PREPASS_COLOR_TEXTURE_TYPE=4;G.PREPASS_DEPTH_TEXTURE_TYPE=5;G.PREPASS_NORMAL_TEXTURE_TYPE=6;G.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;G.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8;G.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9;G.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10;G.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11;G.PREPASS_ALBEDO_TEXTURE_TYPE=12;G.BUFFER_CREATIONFLAG_READ=1;G.BUFFER_CREATIONFLAG_WRITE=2;G.BUFFER_CREATIONFLAG_READWRITE=3;G.BUFFER_CREATIONFLAG_UNIFORM=4;G.BUFFER_CREATIONFLAG_VERTEX=8;G.BUFFER_CREATIONFLAG_INDEX=16;G.BUFFER_CREATIONFLAG_STORAGE=32;G.BUFFER_CREATIONFLAG_INDIRECT=64;G.RENDERPASS_MAIN=0;G.INPUT_ALT_KEY=18;G.INPUT_CTRL_KEY=17;G.INPUT_META_KEY1=91;G.INPUT_META_KEY2=92;G.INPUT_META_KEY3=93;G.INPUT_SHIFT_KEY=16;G.SNAPSHOTRENDERING_STANDARD=0;G.SNAPSHOTRENDERING_FAST=1;G.PERSPECTIVE_CAMERA=0;G.ORTHOGRAPHIC_CAMERA=1;G.FOVMODE_VERTICAL_FIXED=0;G.FOVMODE_HORIZONTAL_FIXED=1;G.RIG_MODE_NONE=0;G.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;G.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;G.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;G.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;G.RIG_MODE_STEREOSCOPIC_INTERLACED=14;G.RIG_MODE_VR=20;G.RIG_MODE_CUSTOM=22;G.MAX_SUPPORTED_UV_SETS=6;G.GL_ALPHA_EQUATION_ADD=32774;G.GL_ALPHA_EQUATION_MIN=32775;G.GL_ALPHA_EQUATION_MAX=32776;G.GL_ALPHA_EQUATION_SUBTRACT=32778;G.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;G.GL_ALPHA_FUNCTION_SRC=768;G.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;G.GL_ALPHA_FUNCTION_SRC_ALPHA=770;G.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;G.GL_ALPHA_FUNCTION_DST_ALPHA=772;G.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;G.GL_ALPHA_FUNCTION_DST_COLOR=774;G.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;G.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;G.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;G.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;G.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;G.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;G.GL_ALPHA_FUNCTION_SRC1_COLOR=35065;G.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066;G.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185;G.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067;G.SnippetUrl="https://snippet.babylonjs.com";G.FOGMODE_NONE=0;G.FOGMODE_EXP=1;G.FOGMODE_EXP2=2;G.FOGMODE_LINEAR=3;G.BYTE=5120;G.UNSIGNED_BYTE=5121;G.SHORT=5122;G.UNSIGNED_SHORT=5123;G.INT=5124;G.UNSIGNED_INT=5125;G.FLOAT=5126;G.PositionKind="position";G.NormalKind="normal";G.TangentKind="tangent";G.UVKind="uv";G.UV2Kind="uv2";G.UV3Kind="uv3";G.UV4Kind="uv4";G.UV5Kind="uv5";G.UV6Kind="uv6";G.ColorKind="color";G.ColorInstanceKind="instanceColor";G.MatricesIndicesKind="matricesIndices";G.MatricesWeightsKind="matricesWeights";G.MatricesIndicesExtraKind="matricesIndicesExtra";G.MatricesWeightsExtraKind="matricesWeightsExtra";class pM{constructor(e,t=!1,i,r){this.initialize(e,t,i,r)}initialize(e,t=!1,i,r){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this}}class _M{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class Q{static FromPromise(e,t){const i=new Q;return e.then(r=>{i.notifyObservers(r)}).catch(r=>{if(t)t.notifyObservers(r);else throw r}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new pM(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,r=null,s=!1){if(!e)return null;const a=new _M(e,t,r);return a.unregisterOnNextCall=s,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(a,this._lastNotifiedValue),a._remove=()=>{this.remove(a)},a}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const r=this._observers[i];if(!r._willBeUnregistered&&r.callback===e&&(!t||t===r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,r,s){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const a=this._eventState;a.mask=t,a.target=i,a.currentTarget=r,a.skipNextObservers=!1,a.lastReturnValue=e,a.userInfo=s;for(const o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.unregisterOnNextCall&&this._deferUnregister(o),o.scope?a.lastReturnValue=o.callback.apply(o.scope,[e,a]):a.lastReturnValue=o.callback(e,a)),a.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new Q;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class $e{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}$e.Instances=[];$e.OnEnginesDisposedObservable=new Q;$e._LastCreatedScene=null;$e.UseFallbackTexture=!0;$e.FallbackTexture="";class w{static _CheckLimit(e,t){let i=w._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},w._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){const i=w._LogLimitOutputs[e];if(!i||!w.MessageLimitReached)return;const r=this._Levels[t];i.current===i.limit&&w[r.name](w.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,r.name??""))}static _AddLogEntry(e){w._LogCache=e+w._LogCache,w.OnNewCacheEntry&&w.OnNewCacheEntry(e)}static _FormatMessage(e){const t=r=>r<10?"0"+r:""+r,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const r=Array.isArray(t)?t[0]:t;if(i!==void 0&&!w._CheckLimit(r,i))return;const s=w._FormatMessage(r),a=this._Levels[e],o=Array.isArray(t)?t.slice(1):[];a.logFunc&&a.logFunc("BJS - "+s,...o);const l=`<div style='color:${a.color}'>${s}</div><br>`;w._AddLogEntry(l),w._GenerateLimitMessage(r,e)}static get LogCache(){return w._LogCache}static ClearLogCache(){w._LogCache="",w._LogLimitOutputs={},w.errorsCount=0}static set LogLevels(e){w.Log=w._LogDisabled,w.Warn=w._LogDisabled,w.Error=w._LogDisabled,[w.MessageLogLevel,w.WarningLogLevel,w.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];w[i.name]=w._LogEnabled.bind(w,t)}})}}w.NoneLogLevel=0;w.MessageLogLevel=1;w.WarningLogLevel=2;w.ErrorLogLevel=4;w.AllLogLevel=7;w.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";w._LogCache="";w._LogLimitOutputs={};w._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];w.errorsCount=0;w.Log=w._LogEnabled.bind(w,w.MessageLogLevel);w.Warn=w._LogEnabled.bind(w,w.WarningLogLevel);w.Error=w._LogEnabled.bind(w,w.ErrorLogLevel);class V{static GetShadersRepository(e=0){return e===0?V.ShadersRepository:V.ShadersRepositoryWGSL}static GetShadersStore(e=0){return e===0?V.ShadersStore:V.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return e===0?V.IncludesShadersStore:V.IncludesShadersStoreWGSL}}V.ShadersRepository="src/Shaders/";V.ShadersStore={};V.IncludesShadersStore={};V.ShadersRepositoryWGSL="src/ShadersWGSL/";V.ShadersStoreWGSL={};V.IncludesShadersStoreWGSL={};function Yi(){return typeof window<"u"}function Ro(){return typeof navigator<"u"}function kl(){return typeof document<"u"}function Zd(n){let e="",t=n.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}class mM{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,i,r,s,a,o,l){const c=this.engine;if(c.supportsUniformBuffers)for(const f in t)e.bindUniformBlock(f,t[f]);this.engine.getUniforms(this,i).forEach((f,d)=>{r[i[d]]=f}),this._uniforms=r;let h;for(h=0;h<s.length;h++)e.getUniform(s[h])==null&&(s.splice(h,1),h--);s.forEach((f,d)=>{a[f]=d});for(const f of c.getAttributes(this,o))l.push(f)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r||r.length!==2)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s||s.length!==3)return s=[t,i,r],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==i&&(s[1]=i,a=!0),s[2]!==r&&(s[2]=r,a=!0),a}_cacheFloat4(e,t,i,r,s){let a=this._valueCache[e];if(!a||a.length!==4)return a=[t,i,r,s],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==r&&(a[2]=r,o=!0),a[3]!==s&&(a[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this.engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}const _m={};function rt(n,e=!1){if(!(e&&_m[n]))return _m[n]=!0,`${n} needs to be imported before as it contains a side-effect required by your code.`}const Cu={};function MS(n,e,t=""){return t+(e?e+`
`:"")+n}function DS(n,e,t,i,r,s,a){const o=a||Cu.loadFile;if(o)return o(n,e,t,i,r,s);throw rt("FileTools")}function OS(n,e,t,i){if(n){e?n.IS_NDC_HALF_ZRANGE="":delete n.IS_NDC_HALF_ZRANGE,t?n.USE_REVERSE_DEPTHBUFFER="":delete n.USE_REVERSE_DEPTHBUFFER,i?n.USE_EXACT_SRGB_CONVERSIONS="":delete n.USE_EXACT_SRGB_CONVERSIONS;return}else{let r="";return e&&(r+="#define IS_NDC_HALF_ZRANGE"),t&&(r&&(r+=`
`),r+="#define USE_REVERSE_DEPTHBUFFER"),i&&(r&&(r+=`
`),r+="#define USE_EXACT_SRGB_CONVERSIONS"),r}}function Qf(n,e,t=!1,i){switch(n){case 3:{const s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&s.set(new Int8Array(i)),s}case 0:{const s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&s.set(new Uint8Array(i)),s}case 4:{const s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&s.set(new Int16Array(i)),s}case 5:case 8:case 9:case 10:case 2:{const s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&s.set(new Uint16Array(i)),s}case 6:{const s=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&s.set(new Int32Array(i)),s}case 7:case 11:case 12:case 13:case 14:case 15:{const s=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&s.set(new Uint32Array(i)),s}case 1:{const s=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&s.set(new Float32Array(i)),s}}const r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}const Jf=new WeakMap,gM={_webGLVersion:2,cachedPipelines:{}};function As(n){let e=Jf.get(n);if(!e){if(!n)return gM;e={_webGLVersion:n.TEXTURE_BINDING_3D?2:1,_context:n,cachedPipelines:{}},Jf.set(n,e)}return e}function EM(n){Jf.delete(n)}function NS(n,e,t,i,r,s){const a=As(i);s||(s=a._createShaderProgramInjection??Qd);const o=ed(e,"vertex",i,a._contextWasLost),l=ed(t,"fragment",i,a._contextWasLost);return s(n,o,l,i,r,a.validateShaderPrograms)}function LS(n,e,t,i,r,s=null,a){const o=As(r);a||(a=o._createShaderProgramInjection??Qd);const l=o._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",c=mm(e,"vertex",i,l,r,o._contextWasLost),u=mm(t,"fragment",i,l,r,o._contextWasLost);return a(n,c,u,r,s,o.validateShaderPrograms)}function vM(n,e){const t=new mM,i=As(n);return i.parallelShaderCompile&&(t.isParallelCompiled=!0),t.context=i._context,t}function Qd(n,e,t,i,r=null,s){const a=i.createProgram();if(n.program=a,!a)throw new Error("Unable to create program");return i.attachShader(a,e),i.attachShader(a,t),i.linkProgram(a),n.context=i,n.vertexShader=e,n.fragmentShader=t,n.isParallelCompiled||FS(n,i,s),a}function FS(n,e,t){const i=n.context,r=n.vertexShader,s=n.fragmentShader,a=n.program;if(!i.getProgramParameter(a,i.LINK_STATUS)){if(!e.getShaderParameter(r,e.COMPILE_STATUS)){const c=e.getShaderInfoLog(r);if(c)throw n.vertexCompilationError=c,new Error("VERTEX SHADER "+c)}if(!e.getShaderParameter(s,e.COMPILE_STATUS)){const c=e.getShaderInfoLog(s);if(c)throw n.fragmentCompilationError=c,new Error("FRAGMENT SHADER "+c)}const l=i.getProgramInfoLog(a);if(l)throw n.programLinkError=l,new Error(l)}if(t&&(i.validateProgram(a),!i.getProgramParameter(a,i.VALIDATE_STATUS))){const c=i.getProgramInfoLog(a);if(c)throw n.programValidationError=c,new Error(c)}i.deleteShader(r),i.deleteShader(s),n.vertexShader=void 0,n.fragmentShader=void 0,n.onCompiled&&(n.onCompiled(),n.onCompiled=void 0)}function SM(n,e,t,i,r,s,a,o,l,c="",u,h,f){const d=As(n.context);h||(h=d.createRawShaderProgramInjection??NS),f||(f=d.createShaderProgramInjection??LS);const p=n;i?p.program=h(p,e,t,p.context,l):p.program=f(p,e,t,o,p.context,l),p.program.__SPECTOR_rebuildProgram=a,u()}function mm(n,e,t,i,r,s){return ed(MS(n,t,i),e,r,s)}function ed(n,e,t,i){const r=t.createShader(e==="vertex"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(!r){let s=t.NO_ERROR,a=t.NO_ERROR;for(;(a=t.getError())!==t.NO_ERROR;)s=a;throw new Error(`Something went wrong while creating a gl ${e} shader object. gl error=${s}, gl isContextLost=${t.isContextLost()}, _contextWasLost=${i}`)}return t.shaderSource(r,n),t.compileShader(r),r}function TM(n,e){e.useProgram(n)}function xM(n,e){const t=n;if(!t.isParallelCompiled){e(n);return}const i=t.onCompiled;t.onCompiled=()=>{i==null||i(),e(n)}}const CM="attribute",AM="varying";class _c{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var r,s,a,o,l,c;let i="";if(this.line){let u=this.line;const h=t.processor;if(h){h.lineProcessor&&(u=h.lineProcessor(u,t.isFragment,t.processingContext));const f=((r=t.processor)==null?void 0:r.attributeKeywordName)??CM,d=t.isFragment&&((s=t.processor)!=null&&s.varyingFragmentKeywordName)?(a=t.processor)==null?void 0:a.varyingFragmentKeywordName:!t.isFragment&&((o=t.processor)!=null&&o.varyingVertexKeywordName)?(l=t.processor)==null?void 0:l.varyingVertexKeywordName:AM;!t.isFragment&&h.attributeProcessor&&this.line.startsWith(f)?u=h.attributeProcessor(this.line,e,t.processingContext):h.varyingProcessor&&((c=h.varyingCheck)!=null&&c.call(h,this.line,t.isFragment)||!h.varyingCheck&&this.line.startsWith(d))?u=h.varyingProcessor(this.line,t.isFragment,e,t.processingContext):h.uniformProcessor&&h.uniformRegexp&&h.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&h.uniformBufferRegexp&&h.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):h.textureProcessor&&h.textureRegexp&&h.textureRegexp.test(this.line)?u=h.textureProcessor(this.line,t.isFragment,e,t.processingContext):(h.uniformProcessor||h.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?h.uniformProcessor&&(u=h.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):h.uniformBufferProcessor&&(u=h.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,h.endOfUniformBufferProcessor&&(u=h.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=u+`
`}return this.children.forEach(u=>{i+=u.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i}}class IM{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}const i=t.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(t);continue}const r=i.indexOf(";");if(r===-1)this._lines.push(i);else if(r===i.length-1)i.length>1&&this._lines.push(i);else{const s=t.split(";");for(let a=0;a<s.length;a++){let o=s[a];o&&(o=o.trim(),o&&this._lines.push(o+(a!==s.length-1?";":"")))}}}}}class pf extends _c{process(e,t){for(let i=0;i<this.children.length;i++){const r=this.children[i];if(r.isValid(e))return r.process(e,t)}return""}}class yM extends _c{isValid(e){return this.testExpression.isTrue(e)}}class Ri{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(Ri._OperatorPriority[i]===void 0)t.push(i);else{const r=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${r})`)}return t[t.length-1]}static infixToPostfix(e){const t=Ri._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const i=[];let r=-1;const s=()=>{u=u.trim(),u!==""&&(i.push(u),u="")},a=h=>{r<Ri._Stack.length-1&&(Ri._Stack[++r]=h)},o=()=>Ri._Stack[r],l=()=>r===-1?"!!INVALID EXPRESSION!!":Ri._Stack[r--];let c=0,u="";for(;c<e.length;){const h=e.charAt(c),f=c<e.length-1?e.substring(c,2+c):"";if(h==="(")u="",a(h);else if(h===")"){for(s();r!==-1&&o()!=="(";)i.push(l());l()}else if(Ri._OperatorPriority[f]>1){for(s();r!==-1&&Ri._OperatorPriority[o()]>=Ri._OperatorPriority[f];)i.push(l());a(f),c++}else u+=h;c++}for(s();r!==-1;)o()==="("?l():i.push(l());return Ri._InfixToPostfixCache.size>=Ri.InfixToPostfixCacheLimitSize&&Ri.ClearCache(),Ri._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(Ri._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<Ri.InfixToPostfixCacheCleanupSize;t++)Ri._InfixToPostfixCache.delete(e[t][0])}}Ri.InfixToPostfixCacheLimitSize=5e4;Ri.InfixToPostfixCacheCleanupSize=25e3;Ri._InfixToPostfixCache=new Map;Ri._OperatorPriority={")":0,"(":1,"||":2,"&&":3};Ri._Stack=["","","","","","","","","","","","","","","","","","","",""];class Au extends Ri{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class bM extends Ri{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class RM extends Ri{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class PM extends Ri{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const r=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":i=r>s;break;case"<":i=r<s;break;case"<=":i=r<=s;break;case">=":i=r>=s;break;case"==":i=r===s;break;case"!=":i=r!==s;break}return i}}const MM=/defined\s*?\((.+?)\)/g,_f=/defined\s*?\[(.+?)\]/g,DM=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,OM=/__decl__/,gm=/light\{X\}.(\w*)/g,Em=/\{X\}/g,Hc=[],NM=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function Jd(n){n.processor&&n.processor.initializeShaders&&n.processor.initializeShaders(n.processingContext)}function Iu(n,e,t,i){var r;(r=e.processor)!=null&&r.preProcessShaderCode&&(n=e.processor.preProcessShaderCode(n,e.isFragment)),Ql(n,e,s=>{e.processCodeAfterIncludes&&(s=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",s,e.defines));const a=BM(s,e,i);t(a,s)})}function LM(n,e,t,i){var r;(r=e.processor)!=null&&r.preProcessShaderCode&&(n=e.processor.preProcessShaderCode(n,e.isFragment)),Ql(n,e,s=>{e.processCodeAfterIncludes&&(s=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",s,e.defines));const a=VM(s,e,i);t(a,s)})}function ep(n,e,t){return!t.processor||!t.processor.finalizeShaders?{vertexCode:n,fragmentCode:e}:t.processor.finalizeShaders(n,e,t.processingContext)}function FM(n,e){var i;if((i=e.processor)!=null&&i.noPrecision)return n;const t=e.shouldUseHighPrecisionShader;return n.indexOf("precision highp float")===-1?t?n=`precision highp float;
`+n:n=`precision mediump float;
`+n:t||(n=n.replace("precision highp float","precision mediump float")),n}function mf(n){const t=/defined\((.+)\)/.exec(n);if(t&&t.length)return new Au(t[1].trim(),n[0]==="!");const i=["==","!=",">=","<=","<",">"];let r="",s=0;for(r of i)if(s=n.indexOf(r),s>-1)break;if(s===-1)return new Au(n);const a=n.substring(0,s).trim(),o=n.substring(s+r.length).trim();return new PM(a,r,o)}function wM(n){n=n.replace(MM,"defined[$1]");const e=Ri.infixToPostfix(n),t=[];for(const r of e)if(r!=="||"&&r!=="&&")t.push(r);else if(t.length>=2){let s=t[t.length-1],a=t[t.length-2];t.length-=2;const o=r=="&&"?new RM:new bM;typeof s=="string"&&(s=s.replace(_f,"defined($1)")),typeof a=="string"&&(a=a.replace(_f,"defined($1)")),o.leftOperand=typeof a=="string"?mf(a):a,o.rightOperand=typeof s=="string"?mf(s):s,t.push(o)}let i=t[t.length-1];return typeof i=="string"&&(i=i.replace(_f,"defined($1)")),typeof i=="string"?mf(i):i}function au(n,e){const t=new yM,i=n.substring(0,e);let r=n.substring(e);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i==="#ifdef"?t.testExpression=new Au(r):i==="#ifndef"?t.testExpression=new Au(r,!0):t.testExpression=wM(r),t}function gf(n,e,t){let i=n.currentLine;for(;td(n,t);){i=n.currentLine;const r=i.substring(0,5).toLowerCase();if(r==="#else"){const s=new _c;e.children.push(s),td(n,s);return}else if(r==="#elif"){const s=au(i,5);e.children.push(s),t=s}}}function td(n,e){for(;n.canRead;){n.lineIndex++;const t=n.currentLine;if(t.indexOf("#")>=0){const r=NM.exec(t);if(r&&r.length){switch(r[0]){case"#ifdef":{const a=new pf;e.children.push(a);const o=au(t,6);a.children.push(o),gf(n,a,o);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const a=new pf;e.children.push(a);const o=au(t,7);a.children.push(o),gf(n,a,o);break}case"#if":{const a=new pf,o=au(t,3);e.children.push(a),a.children.push(o),gf(n,a,o);break}}continue}}const i=new _c;if(i.line=t,e.children.push(i),t[0]==="#"&&t[1]==="d"){const r=t.replace(";","").split(" ");i.additionalDefineKey=r[1],r.length===3&&(i.additionalDefineValue=r[2])}}return!1}function wS(n,e,t){const i=new _c,r=new IM;return r.lineIndex=-1,r.lines=n.split(`
`),td(r,i),i.process(e,t)}function BS(n,e){var r;const t=n.defines,i={};for(const s of t){const o=s.replace("#define","").replace(";","").trim().split(" ");i[o[0]]=o.length>1?o[1]:""}return((r=n.processor)==null?void 0:r.shaderLanguage)===0&&(i.GL_ES="true"),i.__VERSION__=n.version,i[n.platformName]="true",OS(i,e==null?void 0:e.isNDCHalfZRange,e==null?void 0:e.useReverseDepthBuffer,e==null?void 0:e.useExactSrgbConversions),i}function BM(n,e,t){let i=FM(n,e);if(!e.processor||e.processor.shaderLanguage===0&&i.indexOf("#version 3")!==-1&&(i=i.replace("#version 300 es",""),!e.processor.parseGLES3))return i;const r=e.defines,s=BS(e,t);return e.processor.preProcessor&&(i=e.processor.preProcessor(i,r,s,e.isFragment,e.processingContext)),i=wS(i,s,e),e.processor.postProcessor&&(i=e.processor.postProcessor(i,r,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{})),t!=null&&t._features.needShaderCodeInlining&&(i=t.inlineShaderCode(i)),i}function VM(n,e,t){var a,o;let i=n;const r=e.defines,s=BS(e,t);return(a=e.processor)!=null&&a.preProcessor&&(i=e.processor.preProcessor(i,r,s,e.isFragment,e.processingContext)),i=wS(i,s,e),(o=e.processor)!=null&&o.postProcessor&&(i=e.processor.postProcessor(i,r,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{})),t._features.needShaderCodeInlining&&(i=t.inlineShaderCode(i)),i}function Ql(n,e,t){Hc.length=0;let i;for(;(i=DM.exec(n))!==null;)Hc.push(i);let r=String(n),s=[n],a=!1;for(const o of Hc){let l=o[1];if(l.indexOf("__decl__")!==-1&&(l=l.replace(OM,""),e.supportsUniformBuffers&&(l=l.replace("Vertex","Ubo").replace("Fragment","Ubo")),l=l+"Declaration"),e.includesShadersStore[l]){let c=e.includesShadersStore[l];if(o[2]){const h=o[3].split(",");for(let f=0;f<h.length;f+=2){const d=new RegExp(h[f],"g"),p=h[f+1];c=c.replace(d,p)}}if(o[4]){const h=o[5];if(h.indexOf("..")!==-1){const f=h.split(".."),d=parseInt(f[0]);let p=parseInt(f[1]),_=c.slice(0);c="",isNaN(p)&&(p=e.indexParameters[f[1]]);for(let g=d;g<p;g++)e.supportsUniformBuffers||(_=_.replace(gm,(E,v)=>v+"{X}")),c+=_.replace(Em,g.toString())+`
`}else e.supportsUniformBuffers||(c=c.replace(gm,(f,d)=>d+"{X}")),c=c.replace(Em,h)}const u=[];for(const h of s){const f=h.split(o[0]);for(let d=0;d<f.length-1;d++)u.push(f[d]),u.push(c);u.push(f[f.length-1])}s=u,a=a||c.indexOf("#include<")>=0||c.indexOf("#include <")>=0}else{const c=e.shadersRepository+"ShadersInclude/"+l+".fx";VS.loadFile(c,u=>{e.includesShadersStore[l]=u,Ql(s.join(""),e,t)});return}}Hc.length=0,r=s.join(""),a?Ql(r.toString(),e,t):t(r)}const VS={loadFile:(n,e,t,i,r,s)=>{throw rt("FileTools")}};function UM(n,e){return As(e).cachedPipelines[n]}function tp(n){const e=n._name,t=n.context;if(e&&t){const i=As(t),r=i.cachedPipelines[e];r==null||r.dispose(),delete i.cachedPipelines[e]}}function kM(n,e,t,i,r,s,a){let o,l;const c=Yi()?s==null?void 0:s.getHostDocument():null;typeof e=="string"?o=e:e.vertexSource?o="source:"+e.vertexSource:e.vertexElement?o=(c==null?void 0:c.getElementById(e.vertexElement))||e.vertexElement:o=e.vertex||e,typeof e=="string"?l=e:e.fragmentSource?l="source:"+e.fragmentSource:e.fragmentElement?l=(c==null?void 0:c.getElementById(e.fragmentElement))||e.fragmentElement:l=e.fragment||e;const u=[void 0,void 0],h=()=>{if(u[0]&&u[1]){n.isFragment=!0;const[f,d]=u;Iu(d,n,(p,_)=>{a&&(a._fragmentSourceCodeBeforeMigration=_),t&&(p=t("fragment",p));const g=ep(f,p,n);n=null;const E=GM(g.vertexCode,g.fragmentCode,e,r);i==null||i(E.vertexSourceCode,E.fragmentSourceCode)},s)}};vm(o,"Vertex","",f=>{Jd(n),Iu(f,n,(d,p)=>{a&&(a._rawVertexSourceCode=f,a._vertexSourceCodeBeforeMigration=p),t&&(d=t("vertex",d)),u[0]=d,h()},s)},r),vm(l,"Fragment","Pixel",f=>{a&&(a._rawFragmentSourceCode=f),u[1]=f,h()},r)}function vm(n,e,t,i,r,s){if(typeof HTMLElement<"u"&&n instanceof HTMLElement){const l=Zd(n);i(l);return}if(n.substring(0,7)==="source:"){i(n.substring(7));return}if(n.substring(0,7)==="base64:"){const l=window.atob(n.substring(7));i(l);return}const a=V.GetShadersStore(r);if(a[n+e+"Shader"]){i(a[n+e+"Shader"]);return}if(t&&a[n+t+"Shader"]){i(a[n+t+"Shader"]);return}let o;if(n[0]==="."||n[0]==="/"||n.indexOf("http")>-1?o=n:o=V.GetShadersRepository(r)+n,s=s||DS,!s)throw new Error("loadFileInjection is not defined");s(o+"."+e.toLowerCase()+".fx",i)}function GM(n,e,t,i){if(t){const r=t.vertexElement||t.vertex||t.spectorName||t,s=t.fragmentElement||t.fragment||t.spectorName||t;return{vertexSourceCode:(i===1?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+n,fragmentSourceCode:(i===1?"//":"")+"#define SHADER_NAME fragment:"+s+`
`+e}}else return{vertexSourceCode:n,fragmentSourceCode:e}}const zM=(n,e,t,i)=>{try{const r=n.existingPipelineContext||e(n.shaderProcessingContext);if(r._name=n.name,n.name&&n.context){const s=As(n.context);s.cachedPipelines[n.name]=r}return t(r,n.vertex,n.fragment,!!n.createAsRaw,"","",n.rebuildRebind,n.defines,n.transformFeedbackVaryings,"",()=>{i(r,()=>{var s;(s=n.onRenderingStateCompiled)==null||s.call(n,r)})}),r}catch(r){throw w.Error("Error compiling effect"),r}};class ei{static get ShadersRepository(){return V.ShadersRepository}static set ShadersRepository(e){V.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Q),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r=null,s,a=null,o=null,l=null,c=null,u,h="",f=0,d){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new Q,this.onErrorObservable=new Q,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=h;const p=this._key.replace(/\r/g,"").replace(/\n/g,"|");let _;if(t.attributes){const g=t;if(this._engine=i,this._attributesNames=g.attributes,this._uniformsNames=g.uniformsNames.concat(g.samplers),this._samplerList=g.samplers.slice(),this.defines=g.defines,this.onError=g.onError,this.onCompiled=g.onCompiled,this._fallbacks=g.fallbacks,this._indexParameters=g.indexParameters,this._transformFeedbackVaryings=g.transformFeedbackVaryings||null,this._multiTarget=!!g.multiTarget,this._shaderLanguage=g.shaderLanguage??0,g.uniformBuffersNames){this._uniformBuffersNamesList=g.uniformBuffersNames.slice();for(let E=0;E<g.uniformBuffersNames.length;E++)this._uniformBuffersNames[g.uniformBuffersNames[E]]=E}this._processFinalCode=g.processFinalCode??null,this._processCodeAfterIncludes=g.processCodeAfterIncludes??void 0,_=g.existingPipelineContext}else this._engine=s,this.defines=a??"",this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=f,this.onError=c,this.onCompiled=l,this._indexParameters=u,this._fallbacks=o;this._engine.shaderPlatformName==="WEBGL2"&&(_=UM(p,this._engine._gl)??_),this._attributeLocationByName={},this.uniqueId=ei._UniqueIdSeed++,_?(this._pipelineContext=_,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,d)}async _processShaderCodeAsync(e=null,t=!1,i=null,r){r&&await r(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);const s={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:V.GetShadersRepository(this._shaderLanguage),includesShadersStore:V.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};kM(s,this.name,this._processFinalCode,(a,o)=>{this._vertexSourceCode=a,this._fragmentSourceCode=o,this._prepareEffect(t)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._engine.isDisposed||this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}get vertexSourceCode(){var e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:((e=this._pipelineContext)==null?void 0:e._getVertexShaderCode())??this._vertexSourceCode}get fragmentSourceCode(){var e;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:((e=this._pipelineContext)==null?void 0:e._getFragmentShaderCode())??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(s,a)=>{r&&r(a)},this.onCompiled=()=>{var a,o;const s=this.getEngine().scenes;if(s)for(let l=0;l<s.length;l++)s[l].markAllMaterialsAsDirty(63);(o=(a=this._pipelineContext)._handlesSpectorRebuildCallback)==null||o.call(a,i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let t=0;t<this._attributesNames.length;t++){const i=this._attributesNames[t];this._attributeLocationByName[i]=this._attributes[t]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),ei.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(e=!1){const t=this._pipelineContext;this._isReady=!1;try{const i=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),r=i?null:this.defines,s=i?this._vertexSourceCodeOverride:this._vertexSourceCode,a=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,o=this._engine;this._pipelineContext=zM({existingPipelineContext:e?t:null,vertex:s,fragment:a,context:o.shaderPlatformName==="WEBGL2"?o._gl:void 0,rebuildRebind:(l,c,u,h)=>this._rebuildProgram(l,c,u,h),defines:r,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,parallelShaderCompile:o._caps.parallelShaderCompile,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:l=>{t&&!e&&this._engine._deletePipelineContext(t),l&&this._onRenderingStateCompiled(l)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContext.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_getShaderCodeAndErrorLine(e,t,i){const r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const a=t.match(r);if(a&&a.length===2){const o=parseInt(a[1]),l=e.split(`
`,-1);l.length>=o&&(s=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var a,o,l;this._compilationError=e.message;const i=this._attributesNames,r=this._fallbacks;if(w.Error("Unable to compile effect:"),w.Error("Uniforms: "+this._uniformsNames.map(function(c){return" "+c})),w.Error("Attributes: "+i.map(function(c){return" "+c})),w.Error(`Defines:
`+this.defines),ei.LogShaderCodeOnCompilationError){let c=null,u=null,h=null;(a=this._pipelineContext)!=null&&a._getVertexShaderCode()&&([h,c]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),h&&(w.Error("Vertex code:"),w.Error(h))),(o=this._pipelineContext)!=null&&o._getFragmentShaderCode()&&([h,u]=this._getShaderCodeAndErrorLine((l=this._pipelineContext)==null?void 0:l._getFragmentShaderCode(),this._compilationError,!0),h&&(w.Error("Fragment code:"),w.Error(h))),c&&w.Error(c),u&&w.Error(u)}w.Error("Error: "+this._compilationError);const s=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,s()),r?(this._pipelineContext=null,r.hasMoreFallbacks?(this._allFallbacksProcessed=!1,w.Error("Trying next fallback."),this.defines=r.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,s(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||s())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const r=this._samplerList.indexOf(e);for(let a=1;a<t.length;a++){const o=i+(a-1).toString();this._samplerList.splice(r+a,0,o)}let s=0;for(const a of this._samplerList)this._samplers[a]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||ei._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(ei._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this}setInt4(e,t,i,r,s){return this._pipelineContext.setInt4(e,t,i,r,s),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,r){return this._pipelineContext.setUInt3(e,t,i,r),this}setUInt4(e,t,i,r,s){return this._pipelineContext.setUInt4(e,t,i,r,s),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,r){return this._pipelineContext.setFloat3(e,t,i,r),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,r,s){return this._pipelineContext.setFloat4(e,t,i,r,s),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(){this._refCount--,!(this._refCount>0)&&(this._pipelineContext&&tp(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(e,t,i,r=0){t&&(V.GetShadersStore(r)[`${e}PixelShader`]=t),i&&(V.GetShadersStore(r)[`${e}VertexShader`]=i)}static ResetCache(){ei._BaseCache={}}}ei.LogShaderCodeOnCompilationError=!0;ei.AutomaticallyClearCodeCache=!1;ei._UniqueIdSeed=0;ei._BaseCache={};ei.ShadersStore=V.ShadersStore;ei.IncludesShadersStore=V.IncludesShadersStore;class lr{static SetMatrixPrecision(e){if(lr.MatrixTrackPrecisionChange=!1,e&&!lr.MatrixUse64Bits&&lr.MatrixTrackedMatrices)for(let t=0;t<lr.MatrixTrackedMatrices.length;++t){const i=lr.MatrixTrackedMatrices[t],r=i._m;i._m=new Array(16);for(let s=0;s<16;++s)i._m[s]=r[s]}lr.MatrixUse64Bits=e,lr.MatrixCurrentType=lr.MatrixUse64Bits?Array:Float32Array,lr.MatrixTrackedMatrices=null}}lr.MatrixUse64Bits=!1;lr.MatrixTrackPrecisionChange=!0;lr.MatrixCurrentType=Float32Array;lr.MatrixTrackedMatrices=[];class Tr{static get Now(){return Yi()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class US{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class kS{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)==null||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var i;if(!e)return;const t=!this.useStencilGlobalOnly&&!!((i=this.stencilMaterial)!=null&&i.enabled);this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class Bn{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=Bn.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=Bn.KEEP,this.opDepthFail=Bn.KEEP,this.opStencilDepthPass=Bn.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}Bn.ALWAYS=519;Bn.KEEP=7680;Bn.REPLACE=7681;class WM{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class GS{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,r=1,s=2,a=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=s,this._comparisonFunction=a,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var Sm;(function(n){n[n.Unknown=0]="Unknown",n[n.Url=1]="Url",n[n.Temp=2]="Temp",n[n.Raw=3]="Raw",n[n.Dynamic=4]="Dynamic",n[n.RenderTarget=5]="RenderTarget",n[n.MultiRenderTarget=6]="MultiRenderTarget",n[n.Cube=7]="Cube",n[n.CubeRaw=8]="CubeRaw",n[n.CubePrefiltered=9]="CubePrefiltered",n[n.Raw3D=10]="Raw3D",n[n.Raw2DArray=11]="Raw2DArray",n[n.DepthStencil=12]="DepthStencil",n[n.CubeRawRGBD=13]="CubeRawRGBD",n[n.Depth=14]="Depth"})(Sm||(Sm={}));class Yt extends GS{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new Q,this.onErrorObservable=new Q,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._engine=e,this._source=t,this._uniqueId=Yt._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const t=this.onRebuildCallback(this),i=r=>{r._swapAndDie(this,!1),this.isReady=t.isReady};t.isAsync?t.proxy.then(i):i(t.proxy);return}let e;switch(this.source){case 2:break;case 1:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,t=>{t._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,t=>{t&&t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var s;(s=this._hardwareTexture)==null||s.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const i=this._engine.getLoadedTexturesCache();let r=i.indexOf(this);r!==-1&&i.splice(r,1),r=i.indexOf(e),r===-1&&i.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}Yt._Counter=0;const HM="modulepreload",XM=function(n){return"/ColdEscape/"+n},Tm={},re=function(e,t,i){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));r=Promise.allSettled(t.map(l=>{if(l=XM(l),l in Tm)return;Tm[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":HM,c||(h.as="script"),h.crossOrigin="",h.href=l,o&&h.setAttribute("nonce",o),document.head.appendChild(h),c)return new Promise((f,d)=>{h.addEventListener("load",f),h.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${l}`)))})}))}function s(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return r.then(a=>{for(const o of a||[])o.status==="rejected"&&s(o.reason);return e().catch(s)})},yu=new Map;function ia(n,e){YM(n)&&w.Warn(`Extension with the name '${name}' already exists`),yu.set(n,e)}function YM(n){return yu.delete(n)}function ip(n,e){(e==="image/ktx"||e==="image/ktx2")&&(n=".ktx"),yu.has(n)||(n.endsWith(".dds")&&ia(".dds",()=>re(()=>import("./ddsTextureLoader-BJYgFvBE.js"),[]).then(i=>new i._DDSTextureLoader)),n.endsWith(".basis")&&ia(".basis",()=>re(()=>import("./basisTextureLoader-DFpwcioM.js"),[]).then(i=>new i._BasisTextureLoader)),n.endsWith(".env")&&ia(".env",()=>re(()=>import("./envTextureLoader-B-tJPmmr.js"),[]).then(i=>new i._ENVTextureLoader)),n.endsWith(".hdr")&&ia(".hdr",()=>re(()=>import("./hdrTextureLoader-D577sPPY.js"),[]).then(i=>new i._HDRTextureLoader)),(n.endsWith(".ktx")||n.endsWith(".ktx2"))&&(ia(".ktx",()=>re(()=>import("./ktxTextureLoader-DvRFmhpC.js"),[]).then(i=>new i._KTXTextureLoader)),ia(".ktx2",()=>re(()=>import("./ktxTextureLoader-DvRFmhpC.js"),[]).then(i=>new i._KTXTextureLoader))),n.endsWith(".tga")&&ia(".tga",()=>re(()=>import("./tgaTextureLoader-CEgW0Hp_.js"),[]).then(i=>new i._TGATextureLoader)),n.endsWith(".exr")&&ia(".exr",()=>re(()=>import("./exrTextureLoader-Dk01QRgC.js"),[]).then(i=>new i._ExrTextureLoader)));const t=yu.get(n);return t?Promise.resolve(t(e)):null}function zS(n,e){if(Yi()){const{requestAnimationFrame:t}=e||window;if(typeof t=="function")return t(n)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(n);return setTimeout(n,16)}class q{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}ei.ResetCache()}_rebuildGraphicsResources(){var e;this.wipeCaches(!0),this._rebuildEffects(),(e=this._rebuildComputeEffects)==null||e.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){w.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout(async()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,s=this._stencilState.stencilTest;await e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=s,this._flagContextRestored()},0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){const e=this._frameHandler;if(this._frameHandler=0,Yi()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if(typeof t=="function")return t(e)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let e=!0;(this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderViews(){return!1}_queueNewFrame(e,t){return zS(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return Yi()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){const r=t||this.getRenderWidth(),s=i||this.getRenderHeight(),a=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(a*r,o*s,r*e.width,s*e.height)}createCanvasImage(){return document.createElement("img")}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,r,s=3,a=null,o=null,l,c,u=null,h=null,f=null,d=null,p,_,g){e=e||"";const E=e.substr(0,5)==="data:",v=e.substr(0,5)==="blob:",x=E&&e.indexOf(";base64,")!==-1,A=h||new Yt(this,1);A!==h&&(A.label=e.substring(0,60));const T=e;this._transformTextureUrl&&!x&&!h&&!u&&(e=this._transformTextureUrl(e)),T!==e&&(A._originalUrl=T);const C=e.lastIndexOf(".");let y=d||(C>-1?e.substring(C).toLowerCase():"");y.indexOf("?")>-1&&(y=y.split("?")[0]);const D=ip(y,p);r&&r.addPendingData(A),A.url=e,A.generateMipMaps=!t,A.samplingMode=s,A.invertY=i,A._useSRGBBuffer=this._getUseSRGBBuffer(!!g,t),this._doNotHandleContextLost||(A._buffer=u);let F=null;a&&!h&&(F=A.onLoadedObservable.add(a)),h||this._internalTexturesCache.push(A);const W=(H,ue)=>{r&&r.removePendingData(A),e===T?(F&&A.onLoadedObservable.remove(F),$e.UseFallbackTexture&&e!==$e.FallbackTexture&&this._createTextureBase($e.FallbackTexture,t,A.invertY,r,s,null,o,l,c,u,A),H=(H||"Unknown error")+($e.UseFallbackTexture?" - Fallback texture was used":""),A.onErrorObservable.notifyObservers({message:H,exception:ue}),o&&o(H,ue)):(w.Warn(`Failed to load ${e}, falling back to ${T}`),this._createTextureBase(T,t,A.invertY,r,s,a,o,l,c,u,A,f,d,p,_,g))};if(D){const H=async ue=>{(await D).loadData(ue,A,(le,oe,ge,Ee,ne,j)=>{j?W("TextureLoader failed to load data"):l(A,y,r,{width:le,height:oe},A.invertY,!ge,Ee,()=>(ne(),!1),s)},_)};u?u instanceof ArrayBuffer?H(new Uint8Array(u)):ArrayBuffer.isView(u)?H(u):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,ue=>H(new Uint8Array(ue)),void 0,r?r.offlineProvider:void 0,!0,(ue,ae)=>{W("Unable to load "+(ue&&ue.responseURL,ae))})}else{const H=ue=>{v&&!this._doNotHandleContextLost&&(A._buffer=ue),l(A,y,r,ue,A.invertY,t,!1,c,s)};!E||x?u&&(typeof u.decoding=="string"||u.close)?H(u):q._FileToolsLoadImage(e||"",H,W,r?r.offlineProvider:null,p,A.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof u=="string"||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?q._FileToolsLoadImage(u,H,W,r?r.offlineProvider:null,p,A.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):u&&H(u)}return A}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:kl()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@7.34.1"}static get Version(){return"7.34.1"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){var a,o;this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new US,this._stencilStateComposer=new kS,this._stencilState=new Bn,this._alphaState=new WM,this._alphaMode=1,this._alphaEquation=0,this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new Q,this.onCanvasFocusObservable=new Q,this.onNewSceneAddedObservable=new Q,this.onResizeObservable=new Q,this.onCanvasPointerOutObservable=new Q,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new Q,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=()=>this._renderLoop(),this.onBeforeShaderCompilationObservable=new Q,this.onAfterShaderCompilationObservable=new Q,this.onBeginFrameObservable=new Q,this.onEndFrameObservable=new Q,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new Q,this.onContextRestoredObservable=new Q,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new Q,$e.Instances.push(this),this.startTime=Tr.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,lr.SetMatrixPrecision(!!t.useHighPrecisionMatrix),Ro()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.audioEngine=t.audioEngine??!0,t.stencil=t.stencil??!0,this._audioContext=((a=t.audioEngineOptions)==null?void 0:a.audioContext)??null,this._audioDestination=((o=t.audioEngineOptions)==null?void 0:o.audioDestination)??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;const r=Yi()&&window.devicePixelRatio||1,s=t.limitDeviceRatio||r;i=i||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(s,r):1,this._lastDevicePixelRatio=r,this._creationOptions=t}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const r=Yi()&&window.devicePixelRatio||1,s=this._lastDevicePixelRatio/r;this._lastDevicePixelRatio=r,this._hardwareScalingLevel*=s}if(Yi()&&kl())if(this._renderingCanvas){const r=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||r.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||r.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){if(!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t))return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let r=0;r<this.scenes.length;r++){const s=this.scenes[r];for(let a=0;a<s.cameras.length;a++){const o=s.cameras[a];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,i,r,s,a,o,l,c,u,h){throw rt("engine.rawTexture")}createRawCubeTexture(e,t,i,r,s,a,o,l){throw rt("engine.rawTexture")}createRawTexture3D(e,t,i,r,s,a,o,l,c,u,h){throw rt("engine.rawTexture")}createRawTexture2DArray(e,t,i,r,s,a,o,l,c,u,h){throw rt("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&kl()&&"ontouchend"in document},this._checkForMobile(),Yi()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){var t;(t=this._drawCalls)==null||t.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return q._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,r,s,a){throw rt("FileTools")}_loadFile(e,t,i,r,s,a){const o=DS(e,t,i,r,s,a);return this._activeRequests.push(o),o.onCompleteObservable.add(()=>{const l=this._activeRequests.indexOf(o);l!==-1&&this._activeRequests.splice(l,1)}),o}static _FileToolsLoadFile(e,t,i,r,s,a){if(Cu.loadFile)return Cu.loadFile(e,t,i,r,s,a);throw rt("FileTools")}dispose(){var t;for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();(t=this.releaseComputeEffects)==null||t.call(this),ei.ResetCache();for(const i of this._activeRequests)i.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),Yi()&&window.removeEventListener("resize",this._checkForMobile);const e=$e.Instances.indexOf(this);e>=0&&$e.Instances.splice(e,1),$e.Instances.length||($e.OnEnginesDisposedObservable.notifyObservers(this),$e.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw rt("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<$e.Instances.length;i++){const r=$e.Instances[i];for(let s=0;s<r.scenes.length;s++)r.scenes[s].markAllMaterialsAsDirty(e,t)}}}q._RenderPassIdCounter=0;q._RescalePostProcessFactory=null;q.CollisionsEpsilon=.001;q.QueueNewFrame=zS;function WS(n){return n.getPipelineContext===void 0}class $M{constructor(){this.shaderLanguage=0}postProcessor(e,t,i,r,s){if(s.drawBuffersExtensionDisabled){const a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(a,"")}return e}}const KM=/(flat\s)?\s*varying\s*.*/;class jM{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return KM.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,s=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(s,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const a=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r||a?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class ao{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=ao._Counter++}}ao._Counter=0;class Jl extends ao{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}function ec(n){let e=1;do e*=2;while(e<n);return e===n}function id(n,e,t){return n*(1-t)+e*t}function HS(n){const e=XS(n),t=rp(n);return e-n>n-t?t:e}function XS(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}function rp(n){return n=n|n>>1,n=n|n>>2,n=n|n>>4,n=n|n>>8,n=n|n>>16,n-(n>>1)}function Wn(n,e,t=2){let i;switch(t){case 1:i=rp(n);break;case 2:i=HS(n);break;case 3:default:i=XS(n);break}return Math.min(i,e)}class YS{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){var t;return((t=this._MSAARenderBuffers)==null?void 0:t[e])??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class qM{}class st extends q{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return ei.ShadersRepository}static set ShadersRepository(e){ei.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,i,r){if(i=i||{},super(t??i.antialias,i,r),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let s=null;if(e.getContext){if(s=e,this._renderingCanvas=s,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const l=navigator.userAgent;for(const c of st.ExceptionList){const u=c.key,h=c.targets;if(new RegExp(u).test(l)){if(c.capture&&c.captureConstraint){const d=c.capture,p=c.captureConstraint,g=new RegExp(d).exec(l);if(g&&g.length>0&&parseInt(g[g.length-1])>=p)continue}for(const d of h)switch(d){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=l=>{l.preventDefault(),this._contextWasLost=!0,w.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},s.addEventListener("webglcontextlost",this._onContextLost,!1),s.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=s.getContext("webgl2",i)||s.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!s)throw new Error("The provided canvas is null or undefined.");try{this._gl=s.getContext("webgl",i)||s.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const l=this._gl.getContextAttributes();l&&(i.stencil=l.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let l=0;l<this._caps.maxVertexAttribs;l++)this._currentBufferPointers[l]=new qM;this._shaderProcessor=this.webGLVersion>1?new jM:new $M;const a=`Babylon.js v${st.Version}`;w.Log(a+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",a);const o=As(this._gl);o.validateShaderPrograms=this.validateShaderPrograms,o.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");if(e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const t=this._gl.getExtension("WEBGL_draw_buffers");if(t!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._caps.maxDrawBuffers=this._gl.getParameter(t.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let i=0;i<16;i++)this._gl["COLOR_ATTACHMENT"+i+"_WEBGL"]=t["COLOR_ATTACHMENT"+i+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const t=this._gl.getExtension("WEBGL_depth_texture");t!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const t=this._gl.getExtension("OES_vertex_array_object");t!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=t.createVertexArrayOES.bind(t),this._gl.bindVertexArray=t.bindVertexArrayOES.bind(t),this._gl.deleteVertexArray=t.deleteVertexArrayOES.bind(t))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const t=this._gl.getExtension("ANGLE_instanced_arrays");t!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this._gl.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this._gl.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const t=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),i=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);t&&i&&(this._caps.highPrecisionShaderSupported=t.precision!==0&&i.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const t=this._gl.getExtension("EXT_blend_minmax");t!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=t.MAX_EXT,this._gl.MIN=t.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const t=this._gl.getExtension("EXT_sRGB");t!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:t.SRGB_EXT,SRGB8:t.SRGB_ALPHA_EXT,SRGB8_ALPHA8:t.SRGB_ALPHA_EXT})}if(this._creationOptions){const t=this._creationOptions.forceSRGBBufferSupportState;t!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&t)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let t=0;t<this._maxSimultaneousTextures;t++)this._nextFreeTextureSlots.push(t);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,r=!1){var o,l;const s=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=s;let a=0;if(t&&e){let c=!0;if(this._currentRenderTarget){const u=(o=this._currentRenderTarget.texture)==null?void 0:o.format;if(u===8||u===9||u===10||u===11){const h=(l=this._currentRenderTarget.texture)==null?void 0:l.type;h===7||h===5?(st._TempClearColorUint32[0]=e.r*255,st._TempClearColorUint32[1]=e.g*255,st._TempClearColorUint32[2]=e.b*255,st._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,st._TempClearColorUint32),c=!1):(st._TempClearColorInt32[0]=e.r*255,st._TempClearColorInt32[1]=e.g*255,st._TempClearColorInt32[2]=e.b*255,st._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,st._TempClearColorInt32),c=!1)}}c&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),a|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)}_viewport(e,t,i,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,r,s,a=0,o=0){var h,f,d,p,_,g;const l=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);const c=this._gl;e.isMulti||(e.is2DArray||e.is3D?(c.framebufferTextureLayer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,(h=e.texture._hardwareTexture)==null?void 0:h.underlyingResource,a,o),l._currentLOD=a):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,(f=e.texture._hardwareTexture)==null?void 0:f.underlyingResource,a):l._currentLOD!==a&&(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,(d=e.texture._hardwareTexture)==null?void 0:d.underlyingResource,a),l._currentLOD=a));const u=e._depthStencilTexture;if(u){e.is3D&&(e.texture.width!==u.width||e.texture.height!==u.height||e.texture.depth!==u.depth)&&w.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");const E=e._depthStencilTextureWithStencil?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?c.framebufferTextureLayer(c.FRAMEBUFFER,E,(p=u._hardwareTexture)==null?void 0:p.underlyingResource,a,o):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,E,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,(_=u._hardwareTexture)==null?void 0:_.underlyingResource,a):c.framebufferTexture2D(c.FRAMEBUFFER,E,c.TEXTURE_2D,(g=u._hardwareTexture)==null?void 0:g.underlyingResource,a)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),r||(r=e.height,a&&(r=r/Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}setState(e,t=0,i,r=!1,s,a,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const l=this.cullBackFaces??s??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==l||i)&&(this._depthCullingState.cullFace=l),this.setZOffset(t),this.setZOffsetUnits(o);const c=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=a}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t=!1,i){var a;const r=e;this._currentRenderTarget=null;const s=this._gl;if(r._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}s.bindFramebuffer(s.READ_FRAMEBUFFER,r._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,r._framebuffer),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s.COLOR_BUFFER_BIT,s.NEAREST)}(a=e.texture)!=null&&a.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const r=new Jl(i);return this.bindArrayBuffer(r),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),r.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),r.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),r.capacity=e),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const r=this._gl.createBuffer(),s=new Jl(r);if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);const a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),s.references=1,s.is32Bits=a.BYTES_PER_ELEMENT===4,s}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const r=e.program,s=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,s,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,r,s,a,o){const l=this._currentBufferPointers[t];if(!l)return;let c=!1;l.active?(l.buffer!==e&&(l.buffer=e,c=!0),l.size!==i&&(l.size=i,c=!0),l.type!==r&&(l.type=r,c=!0),l.normalized!==s&&(l.normalized=s,c=!0),l.stride!==a&&(l.stride=a,c=!0),l.offset!==o&&(l.offset=o,c=!0)):(c=!0,l.active=!0,l.index=t,l.size=i,l.type=r,l.normalized=s,l.stride=a,l.offset=o,l.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,i,r,a,o):this._gl.vertexAttribPointer(t,i,r,s,a,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let s=0;s<r.length;s++){const a=t.getAttributeLocation(s);if(a>=0){const o=r[s];let l=null;if(i&&(l=i[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);const c=l.getBuffer();c&&(this._vertexAttribPointer(c,a,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(c))))}}}recordVertexArrayObject(e,t,i,r){const s=this._gl.createVertexArray();if(!s)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(s),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),s}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,r,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;const a=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let l=0;l<a;l++)if(l<i.length){const c=s.getAttributeLocation(l);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(e,c,i[l],this._gl.FLOAT,!1,r,o)),o+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const r=this._currentInstanceBuffers[t];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let r=0;r<4;r++){const s=i[r];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,r*16),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let r=0;if(i)for(let s=0;s<t.length;s++){const a=t[s];r+=a.attributeSize*4}for(let s=0;s<t.length;s++){const a=t[s];a.index===void 0&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,r,a.offset),this._gl.vertexAttribDivisor(a.index,a.divisor===void 0?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)}drawElementsType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(s,i,a,t*o,r):this._gl.drawElements(s,i,a,t*o)}drawArraysType(e,t,i,r){this.applyStates(),this._reportDrawCall();const s=this._drawMode(e);r?this._gl.drawArraysInstanced(s,t,i,r):this._gl.drawArrays(s,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,tp(t),this._gl.deleteProgram(t.program))}_getGlobalDefines(e){return OS(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,r,s,a,o,l,c,u=0,h){const f=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines();let _=s??t.defines??"";p&&(_+=p);const g=f+"+"+d+"@"+_;if(this._compiledEffects[g]){const v=this._compiledEffects[g];return o&&v.isReady()&&o(v),v._refCount++,v}this._gl&&As(this._gl);const E=new ei(e,t,i,r,this,s,a,o,l,c,g,t.shaderLanguage??u,t.extraInitializationsAsync??h);return this._compiledEffects[g]=E,E}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,r,s=null){const a=As(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,NS(e,t,i,r||this._gl,s)}createShaderProgram(e,t,i,r,s,a=null){const o=As(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,LS(e,t,i,r,s||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){const i=As(this._gl);i.parallelShaderCompile=this._caps.parallelShaderCompile}const t=vM(this._gl);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return FS(e,this._gl,this.validateShaderPrograms)}_preparePipelineContext(e,t,i,r,s,a,o,l,c,u,h){const f=As(this._gl);return f._contextWasLost=this._contextWasLost,f.validateShaderPrograms=this.validateShaderPrograms,f._createShaderProgramInjection=this._createShaderProgram.bind(this),f.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),f.createShaderProgramInjection=this.createShaderProgram.bind(this),f.loadFileInjection=this._loadFile.bind(this),SM(e,t,i,r,s,a,o,l,c,u,h)}_createShaderProgram(e,t,i,r,s=null){return Qd(e,t,i,r,s)}_isRenderingStateCompiled(e){const t=e;return this._isDisposed||t._isDisposed?!1:this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){xM(e,t)}getUniforms(e,t){const i=new Array,r=e;for(let s=0;s<t.length;s++)i.push(this._gl.getUniformLocation(r.program,t[s]));return i}getAttributes(e,t){const i=[],r=e;for(let s=0;s<t.length;s++)try{i.push(this._gl.getAttribLocation(r.program,t[s]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&WS(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,r){return e?(this._gl.uniform3i(e,t,i,r),!0):!1}setInt4(e,t,i,r,s){return e?(this._gl.uniform4i(e,t,i,r,s),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,r){return e?(this._gl.uniform3ui(e,t,i,r),!0):!1}setUInt4(e,t,i,r,s){return e?(this._gl.uniform4ui(e,t,i,r,s),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,r){return e?(this._gl.uniform3f(e,t,i,r),!0):!1}setFloat4(e,t,i,r,s){return e?(this._gl.uniform4f(e,t,i,r,s),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let r=i.NEAREST,s=i.NEAREST;switch(e){case 11:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 3:r=i.LINEAR,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 8:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 4:r=i.NEAREST,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 5:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_NEAREST:s=i.LINEAR;break;case 6:r=i.NEAREST,t?s=i.LINEAR_MIPMAP_LINEAR:s=i.LINEAR;break;case 7:r=i.NEAREST,s=i.LINEAR;break;case 1:r=i.NEAREST,s=i.NEAREST;break;case 9:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_NEAREST:s=i.NEAREST;break;case 10:r=i.LINEAR,t?s=i.NEAREST_MIPMAP_LINEAR:s=i.NEAREST;break;case 2:r=i.LINEAR,s=i.LINEAR;break;case 12:r=i.LINEAR,s=i.NEAREST;break}return{min:s,mag:r}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new YS(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,r=0){let s=!1,a=0,o=3,l=5,c=!1,u=1,h;t!==void 0&&typeof t=="object"?(s=!!t.generateMipMaps,a=t.type===void 0?0:t.type,o=t.samplingMode===void 0?3:t.samplingMode,l=t.format===void 0?5:t.format,c=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=t.samples??1,h=t.label):s=!!t,c&&(c=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(o=1),a===1&&!this._caps.textureFloat&&(a=0,w.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=this._gl,d=new Yt(this,r),p=e.width||e,_=e.height||e,g=e.depth||0,E=e.layers||0,v=this._getSamplingParameters(o,s),x=E!==0?f.TEXTURE_2D_ARRAY:g!==0?f.TEXTURE_3D:f.TEXTURE_2D,A=this._getRGBABufferInternalSizedFormat(a,l,c),T=this._getInternalFormat(l),C=this._getWebGLTextureType(a);return this._bindTextureDirectly(x,d),E!==0?(d.is2DArray=!0,f.texImage3D(x,0,A,p,_,E,0,T,C,null)):g!==0?(d.is3D=!0,f.texImage3D(x,0,A,p,_,g,0,T,C,null)):f.texImage2D(x,0,A,p,_,0,T,C,null),f.texParameteri(x,f.TEXTURE_MAG_FILTER,v.mag),f.texParameteri(x,f.TEXTURE_MIN_FILTER,v.min),f.texParameteri(x,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(x,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),s&&this._gl.generateMipmap(x),this._bindTextureDirectly(x,null),d._useSRGBBuffer=c,d.baseWidth=p,d.baseHeight=_,d.width=p,d.height=_,d.depth=E,d.isReady=!0,d.samples=u,d.generateMipMaps=s,d.samplingMode=o,d.type=a,d.format=l,d.label=h,this._internalTexturesCache.push(d),d}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,r,s=3,a=null,o=null,l=null,c=null,u=null,h=null,f,d,p,_){return this._createTextureBase(e,t,i,r,s,a,o,(...g)=>this._prepareWebGLTexture(...g,u),(g,E,v,x,A,T)=>{const C=this._gl,y=v.width===g&&v.height===E;A._creationFlags=p??0;const P=this._getTexImageParametersForCreateTexture(A.format,A._useSRGBBuffer);if(y)return C.texImage2D(C.TEXTURE_2D,0,P.internalFormat,P.format,P.type,v),!1;const D=this._caps.maxTextureSize;if(v.width>D||v.height>D||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=g,this._workingCanvas.height=E,this._workingContext.drawImage(v,0,0,v.width,v.height,0,0,g,E),C.texImage2D(C.TEXTURE_2D,0,P.internalFormat,P.format,P.type,this._workingCanvas),A.width=g,A.height=E),!1;{const F=new Yt(this,2);this._bindTextureDirectly(C.TEXTURE_2D,F,!0),C.texImage2D(C.TEXTURE_2D,0,P.internalFormat,P.format,P.type,v),this._rescaleTexture(F,A,r,P.format,()=>{this._releaseTexture(F),this._bindTextureDirectly(C.TEXTURE_2D,A,!0),T()})}return!0},l,c,u,h,f,d,_)}_getTexImageParametersForCreateTexture(e,t){let i,r;return this.webGLVersion===1?(i=this._getInternalFormat(e,t),r=i):(i=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:r,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,r,s){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const r=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,s.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,i,r=1){}updateTextureWrappingMode(e,t,i=null,r=null){const s=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(s,null)}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,a=0,o=0){const l=this._gl;let c=l.TEXTURE_2D;if(e.isCube&&(c=l.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,o,t,i,r,0,s)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,a=!1){const o=this._gl,l=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),u=s===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(s,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let h=o.TEXTURE_2D;e.isCube&&(h=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const f=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),p=a?e.width:Math.pow(2,Math.max(f-r,0)),_=a?e.height:Math.pow(2,Math.max(d-r,0));o.texImage2D(h,r,u,p,_,0,c,l,t)}updateTextureData(e,t,i,r,s,a,o=0,l=0,c=!1){const u=this._gl,h=this._getWebGLTextureType(e.type),f=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let d=u.TEXTURE_2D,p=u.TEXTURE_2D;e.isCube&&(p=u.TEXTURE_CUBE_MAP_POSITIVE_X+o,d=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,!0),u.texSubImage2D(p,l,i,r,s,a,f,h,t),c&&this._gl.generateMipmap(p),this._bindTextureDirectly(d,null)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){const s=this._gl,a=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,i,r,s){const a=this._gl;if(!a)return;const o=this._getSamplingParameters(s,!i);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,o.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,o.min),!i&&!r&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,r,s,a,o,l,c,u){const h=this.getCaps().maxTextureSize,f=Math.min(h,this.needPOTTextures?Wn(r.width,h):r.width),d=Math.min(h,this.needPOTTextures?Wn(r.height,h):r.height),p=this._gl;if(p){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(p.TEXTURE_2D,e,!0),this._unpackFlipY(s===void 0?!0:!!s),e.baseWidth=r.width,e.baseHeight=r.height,e.width=f,e.height=d,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:u??(t===".jpg"&&!e._useSRGBBuffer?4:5),!l(f,d,r,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,a,o,c)})&&this._prepareWebGLTextureContinuation(e,i,a,o,c)}}_getInternalFormatFromDepthTextureFormat(e,t,i){const r=this._gl;if(!t)return r.STENCIL_INDEX8;let a=i?r.DEPTH_STENCIL:r.DEPTH_COMPONENT;return this.webGLVersion>1?e===15?a=r.DEPTH_COMPONENT16:e===16?a=r.DEPTH_COMPONENT24:e===17||e===13?a=i?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24:e===14?a=r.DEPTH_COMPONENT32F:e===18&&(a=i?r.DEPTH32F_STENCIL8:r.DEPTH_COMPONENT32F):a=r.DEPTH_COMPONENT16,a}_setupFramebufferDepthAttachments(e,t,i,r,s=1,a){const o=this._gl;a=a??(e?13:14);const l=this._getInternalFormatFromDepthTextureFormat(a,t,e);return e&&t?this._createRenderBuffer(i,r,s,o.DEPTH_STENCIL,l,o.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,r,s,l,l,o.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,r,s,l,l,o.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,r,s,a,o=!0){const c=this._gl.createRenderbuffer();return this._updateRenderBuffer(c,e,t,i,r,s,a,o)}_updateRenderBuffer(e,t,i,r,s,a,o,l=!0){const c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,a,t,i):c.renderbufferStorage(c.RENDERBUFFER,s,t,i),c.framebufferRenderbuffer(c.FRAMEBUFFER,o,c.RENDERBUFFER,e),l&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e==null||e.release()}_setProgram(e){this._currentProgram!==e&&(TM(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let r=0;r<i.length;r++){const s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,r=!1){var l;let s=!1;const a=t&&t._associatedChannel>-1;if(i&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw w.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,((l=t==null?void 0:t._hardwareTexture)==null?void 0:l.underlyingResource)??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(s=!0,this._activateCurrentTexture());return a&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),s}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,r=!1,s=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const c=t.getInternalTexture();c&&(c._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;r?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,!i&&a&&(a._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===a&&(i||this._bindSamplerUniformToChannel(a._associatedChannel,e),o=!1),this._activeChannel=e;const l=this._getTextureTarget(a);if(o&&this._bindTextureDirectly(l,a,i),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;const c=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=c,t.wrapV=c}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(l,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let s=0;s<i.length;s++){const a=i[s].getInternalTexture();a?(this._textureUnits[s]=e+s,a._associatedChannel=e+s):this._textureUnits[s]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let s=0;s<i.length;s++)this._setTexture(this._textureUnits[s],i[s],!0)}}_setAnisotropicLevel(e,t,i){const r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){const e=Object.keys(this._compiledEffects);for(const t of e)this._compiledEffects[t].dispose();this._compiledEffects={}}dispose(){var e;Yi()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&((e=this._gl.getExtension("WEBGL_lose_context"))==null||e.loseContext()),EM(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);const a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&a===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const o=t.RGBA,l=t.UNSIGNED_BYTE,c=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,c),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,r,s=!0,a=!0){const o=s?4:3,l=s?this._gl.RGBA:this._gl.RGB,c=new Uint8Array(r*i*o);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,l,this._gl.UNSIGNED_BYTE,c),Promise.resolve(c)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=q._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=q._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}st._TempClearColorUint32=new Uint32Array(4);st._TempClearColorInt32=new Int32Array(4);st.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];st._ConcatenateShader=MS;st._IsSupported=null;st._HasMajorPerformanceCaveat=null;const ZM=Object.freeze(Object.defineProperty({__proto__:null,ThinEngine:st},Symbol.toStringTag,{value:"Module"}));class $S{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new QM(e)}sampleFrame(e=Tr.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class QM{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}st.prototype.setAlphaMode=function(n,e=!1){if(this._alphaMode===n){if(!e){const t=n===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(n){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=n===0),this._alphaMode=n};st.prototype.updateRawTexture=function(n,e,t,i,r=null,s=0,a=!1){if(!n)return;const o=this._getRGBABufferInternalSizedFormat(s,t,a),l=this._getInternalFormat(t),c=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(n._bufferView=e,n.format=t,n.type=s,n.invertY=i,n._compression=r),n.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],n.width,n.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,n.width,n.height,0,l,c,e),n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),n.isReady=!0};st.prototype.createRawTexture=function(n,e,t,i,r,s,a,o=null,l=0,c=0,u=!1){const h=new Yt(this,3);h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=r,h.samplingMode=a,h.invertY=s,h._compression=o,h.type=l,h._useSRGBBuffer=this._getUseSRGBBuffer(u,!r),this._doNotHandleContextLost||(h._bufferView=n),this.updateRawTexture(h,n,i,s,o,l,h._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0);const f=this._getSamplingParameters(a,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,f.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,f.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(h),h};st.prototype.createRawCubeTexture=function(n,e,t,i,r,s,a,o=null){const l=this._gl,c=new Yt(this,8);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=n);const u=this._getWebGLTextureType(i);let h=this._getInternalFormat(t);h===l.RGB&&(h=l.RGBA),u===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(r=!1,a=1,w.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,a=1,w.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===l.FLOAT&&!this._caps.textureFloatRender?(r=!1,w.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):u===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(r=!1,w.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const f=e,d=f;if(c.width=f,c.height=d,c.invertY=s,c._compression=o,!this.needPOTTextures||ec(c.width)&&ec(c.height)||(r=!1),n)this.updateRawCubeTexture(c,n,t,i,s,o);else{const g=this._getRGBABufferInternalSizedFormat(i),E=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let v=0;v<6;v++)o?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+v,E,this.getCaps().s3tc[o],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+v,E,g,c.width,c.height,0,h,u,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),n&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(a,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=r,c.samplingMode=a,c.isReady=!0,c};st.prototype.updateRawCubeTexture=function(n,e,t,i,r,s=null,a=0){n._bufferViewArray=e,n.format=t,n.type=i,n.invertY=r,n._compression=s;const o=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);const u=this._getRGBABufferInternalSizedFormat(i);let h=!1;c===o.RGB&&(c=o.RGBA,h=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,n,!0),this._unpackFlipY(r===void 0?!0:!!r),n.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let d=0;d<6;d++){let p=e[d];s?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,this.getCaps().s3tc[s],n.width,n.height,0,p):(h&&(p=KS(p,n.width,n.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,u,n.width,n.height,0,c,l,p))}(!this.needPOTTextures||ec(n.width)&&ec(n.height))&&n.generateMipMaps&&a===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),n.isReady=!0};st.prototype.createRawCubeTextureFromUrl=function(n,e,t,i,r,s,a,o,l=null,c=null,u=3,h=!1){const f=this._gl,d=this.createRawCubeTexture(null,t,i,r,!s,h,u,null);e==null||e.addPendingData(d),d.url=n,d.isReady=!1,this._internalTexturesCache.push(d);const p=(g,E)=>{e==null||e.removePendingData(d),c&&g&&c(g.status+" "+g.statusText,E)},_=g=>{const E=d.width,v=a(g);if(v){if(o){const x=this._getWebGLTextureType(r);let A=this._getInternalFormat(i);const T=this._getRGBABufferInternalSizedFormat(r);let C=!1;A===f.RGB&&(A=f.RGBA,C=!0),this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,d,!0),this._unpackFlipY(!1);const y=o(v);for(let P=0;P<y.length;P++){const D=E>>P;for(let F=0;F<6;F++){let W=y[P][F];C&&(W=KS(W,D,D,r)),f.texImage2D(F,P,T,D,D,0,A,x,W)}}this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(d,v,i,r,h);d.isReady=!0,e==null||e.removePendingData(d),d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),l&&l()}};return this._loadFile(n,g=>{_(g)},void 0,e==null?void 0:e.offlineProvider,!0,p),d};function KS(n,e,t,i){let r,s=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),s=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){const l=(o*e+a)*3,c=(o*e+a)*4;r[c+0]=n[l+0],r[c+1]=n[l+1],r[c+2]=n[l+2],r[c+3]=s}return r}function jS(n){return function(e,t,i,r,s,a,o,l,c=null,u=0){const h=n?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=n?10:11,d=new Yt(this,f);d.baseWidth=t,d.baseHeight=i,d.baseDepth=r,d.width=t,d.height=i,d.depth=r,d.format=s,d.type=u,d.generateMipMaps=a,d.samplingMode=l,n?d.is3D=!0:d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),n?this.updateRawTexture3D(d,e,s,o,c,u):this.updateRawTexture2DArray(d,e,s,o,c,u),this._bindTextureDirectly(h,d,!0);const p=this._getSamplingParameters(l,a);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,p.min),a&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(d),d}}st.prototype.createRawTexture2DArray=jS(!1);st.prototype.createRawTexture3D=jS(!0);function qS(n){return function(e,t,i,r,s=null,a=0){const o=n?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),c=this._getInternalFormat(i),u=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,u,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}st.prototype.updateRawTexture2DArray=qS(!1);st.prototype.updateRawTexture3D=qS(!0);st.prototype._readTexturePixelsSync=function(n,e,t,i=-1,r=0,s=null,a=!0,o=!1,l=0,c=0){var f,d;const u=this._gl;if(!u)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=u.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),i>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+i,(f=n._hardwareTexture)==null?void 0:f.underlyingResource,r):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,(d=n._hardwareTexture)==null?void 0:d.underlyingResource,r);let h=n.type!==void 0?this._getWebGLTextureType(n.type):u.UNSIGNED_BYTE;if(o)s||(s=Qf(n.type,4*e*t));else switch(h){case u.UNSIGNED_BYTE:s||(s=new Uint8Array(4*e*t)),h=u.UNSIGNED_BYTE;break;default:s||(s=new Float32Array(4*e*t)),h=u.FLOAT;break}return a&&this.flushFramebuffer(),u.readPixels(l,c,e,t,u.RGBA,h,s),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),s};st.prototype._readTexturePixels=function(n,e,t,i=-1,r=0,s=null,a=!0,o=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(n,e,t,i,r,s,a,o,l,c))};st.prototype.updateDynamicIndexBuffer=function(n,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(n);let i;n.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};st.prototype.updateDynamicVertexBuffer=function(n,e,t,i){this.bindArrayBuffer(n),t===void 0&&(t=0);const r=e.byteLength||e.length;i===void 0||i>=r&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};st.prototype._createDepthStencilCubeTexture=function(n,e){const t=new Yt(this,12);if(t.isCube=!0,this.webGLVersion===1)return w.Error("Depth cube texture is not supported by WebGL 1."),t;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,t,!0),this._setupDepthStencilTexture(t,n,i.bilinearFiltering,i.comparisonFunction);for(let s=0;s<6;s++)i.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,r.DEPTH24_STENCIL8,n,n,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,r.DEPTH_COMPONENT24,n,n,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(t),t};st.prototype._setCubeMapTextureParams=function(n,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),n.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),n._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};st.prototype.createCubeTexture=function(n,e,t,i,r=null,s=null,a,o=null,l=!1,c=0,u=0,h=null,f,d=!1,p=null){const _=this._gl;return this.createCubeTextureBase(n,e,t,!!i,r,s,a,o,l,c,u,h,g=>this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,g,!0),(g,E)=>{const v=this.needPOTTextures?Wn(E[0].width,this._caps.maxCubemapTextureSize):E[0].width,x=v,A=[_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,g,!0),this._unpackFlipY(!1);const T=a?this._getInternalFormat(a,g._useSRGBBuffer):g._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:_.RGBA;let C=a?this._getInternalFormat(a):_.RGBA;g._useSRGBBuffer&&this.webGLVersion===1&&(C=T);for(let y=0;y<A.length;y++)if(E[y].width!==v||E[y].height!==x){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){w.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=v,this._workingCanvas.height=x,this._workingContext.drawImage(E[y],0,0,E[y].width,E[y].height,0,0,v,x),_.texImage2D(A[y],0,T,C,_.UNSIGNED_BYTE,this._workingCanvas)}else _.texImage2D(A[y],0,T,C,_.UNSIGNED_BYTE,E[y]);i||_.generateMipmap(_.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(g,!i),g.width=v,g.height=x,g.isReady=!0,a&&(g.format=a),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),r&&r()},!!d,p)};st.prototype.generateMipMapsForCubemap=function(n,e=!0){if(n.generateMipMaps){const t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,n,!0),t.generateMipmap(t.TEXTURE_CUBE_MAP),e&&this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}};class sp{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){var e;return((e=this._textures)==null?void 0:e[0])??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(e){var s,a;if(!this._textures)return-1;const t=this._textures[e],i=((s=this._layerIndices)==null?void 0:s[e])??0,r=((a=this._faceIndices)==null?void 0:a[e])??0;return t.isCube?i*6+r:t.is3D?0:i}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const r=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,r}constructor(e,t,i,r,s){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=r,this._depthStencilTexture=null,this.label=s}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),i!==void 0&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,a){var o;return(o=this._depthStencilTexture)==null||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=a,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:r,depthTextureFormat:s,label:a},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var t,i,r,s,a;let e=null;if(this._isMulti){const o=this.textures;if(o&&o.length>0){let l=!1,c=o.length,u=-1;const h=o[o.length-1]._source;(h===14||h===12)&&(l=!0,u=o[o.length-1].format,c--);const f=[],d=[],p=[],_=[],g=[],E=[],v=[],x={};for(let C=0;C<c;++C){const y=o[C];f.push(y.samplingMode),d.push(y.type),p.push(y.format),x[y.uniqueId]!==void 0?(_.push(-1),v.push(0)):(x[y.uniqueId]=C,y.is2DArray?(_.push(35866),v.push(y.depth)):y.isCube?(_.push(34067),v.push(0)):y.is3D?(_.push(32879),v.push(y.depth)):(_.push(3553),v.push(0))),this._faceIndices&&g.push(this._faceIndices[C]??0),this._layerIndices&&E.push(this._layerIndices[C]??0)}const A={samplingModes:f,generateMipMaps:o[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:l,depthTextureFormat:u,types:d,formats:p,textureCount:c,targetTypes:_,faceIndex:g,layerIndex:E,layerCounts:v,label:this.label},T={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(T,A);for(let C=0;C<c;++C){if(_[C]!==-1)continue;const y=x[o[C].uniqueId];e.setTexture(e.textures[y],C)}}}else{const o={};if(o.generateDepthBuffer=this._generateDepthBuffer,o.generateMipMaps=((t=this.texture)==null?void 0:t.generateMipMaps)??!1,o.generateStencilBuffer=this._generateStencilBuffer,o.samplingMode=(i=this.texture)==null?void 0:i.samplingMode,o.type=(r=this.texture)==null?void 0:r.type,o.format=(s=this.texture)==null?void 0:s.format,o.noColorAttachment=!this._textures,o.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,o);else{const l={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?(a=this.texture)==null?void 0:a.depth:void 0};e=this._engine.createRenderTargetTexture(l,o)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,r=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e;if(this._textures)for(let t=0;t<((e=this._textures)==null?void 0:e.length);++t)this._textures[t].dispose();this._textures=null}dispose(e=!1){var t;e||((t=this._depthStencilTexture)==null||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class JM extends sp{constructor(e,t,i,r,s){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=s}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,a){if(this._depthStencilBuffer){const o=this._engine,l=o._currentFramebuffer,c=this._context;o._bindUnboundFramebuffer(this._framebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.STENCIL_ATTACHMENT,c.RENDERBUFFER,null),o._bindUnboundFramebuffer(l),c.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,i,r,s,a)}shareDepth(e){super.shareDepth(e);const t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer,s=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const a=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;s._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,i),s._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,r=0){var l,c;if(!e._hardwareTexture)return;const s=this._framebuffer,a=this._engine,o=a._currentFramebuffer;if(a._bindUnboundFramebuffer(s),a.webGLVersion>1){const u=this._context,h=u["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=i??((l=this.layerIndices)==null?void 0:l[t])??0,u.framebufferTextureLayer(u.FRAMEBUFFER,h,e._hardwareTexture.underlyingResource,r,i)):e.isCube?(i=i??((c=this.faceIndices)==null?void 0:c[t])??0,u.framebufferTexture2D(u.FRAMEBUFFER,h,u.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,r)):u.framebufferTexture2D(u.FRAMEBUFFER,h,u.TEXTURE_2D,e._hardwareTexture.underlyingResource,r)}else{const u=this._context,h=u["COLOR_ATTACHMENT"+t+"_WEBGL"],f=i!==void 0?u.TEXTURE_CUBE_MAP_POSITIVE_X+i:u.TEXTURE_2D;u.framebufferTexture2D(u.FRAMEBUFFER,h,f,e._hardwareTexture.underlyingResource,r)}a._bindUnboundFramebuffer(o)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var r;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const i=((r=this._attachments)==null?void 0:r.length)??this.textures.length;for(let s=0;s<i;s++){const a=this.textures[s];a&&(a.is2DArray||a.is3D?this._bindTextureRenderTarget(a,s,this.layerIndices[s]):a.isCube?this._bindTextureRenderTarget(a,s,this.faceIndices[s]):this._bindTextureRenderTarget(a,s))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=this.textures[e];r.is2DArray||r.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):r.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}q.prototype.createDepthStencilTexture=function(n,e,t){if(e.isCube){const i=n.width||n;return this._createDepthStencilCubeTexture(i,e)}else return this._createDepthStencilTexture(n,e,t)};st.prototype._createHardwareRenderTargetWrapper=function(n,e,t){const i=new JM(n,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};st.prototype.createRenderTargetTexture=function(n,e){const t=this._createHardwareRenderTargetWrapper(!1,!1,n);let i=!0,r=!1,s=!1,a,o=1,l;e!==void 0&&typeof e=="object"&&(i=e.generateDepthBuffer??!0,r=!!e.generateStencilBuffer,s=!!e.noColorAttachment,a=e.colorAttachment,o=e.samples??1,l=e.label);const c=a||(s?null:this._createInternalTexture(n,e,!0,5)),u=n.width||n,h=n.height||n,f=this._currentFramebuffer,d=this._gl,p=d.createFramebuffer();if(this._bindUnboundFramebuffer(p),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r,i,u,h),c&&!c.is2DArray&&!c.is3D&&d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),t.label=l??"RenderTargetWrapper",t._framebuffer=p,t._generateDepthBuffer=i,t._generateStencilBuffer=r,t.setTextures(c),!a)this.updateRenderTargetTextureSampleCount(t,o);else if(t._samples=a.samples,a.samples>1){const _=a._hardwareTexture.getMSAARenderBuffer(0);t._MSAAFramebuffer=d.createFramebuffer(),this._bindUnboundFramebuffer(t._MSAAFramebuffer),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.RENDERBUFFER,_),this._bindUnboundFramebuffer(null)}return t};st.prototype._createDepthStencilTexture=function(n,e,t){const i=this._gl,r=n.layers||0,s=n.depth||0;let a=i.TEXTURE_2D;r!==0?a=i.TEXTURE_2D_ARRAY:s!==0&&(a=i.TEXTURE_3D);const o=new Yt(this,12);if(o.label=e.label,!this._caps.depthTextureExtension)return w.Error("Depth texture is not supported by your browser or hardware."),o;const l={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(a,o,!0),this._setupDepthStencilTexture(o,n,l.comparisonFunction===0?!1:l.bilinearFiltering,l.comparisonFunction,l.samples),l.depthTextureFormat!==void 0){if(l.depthTextureFormat!==15&&l.depthTextureFormat!==16&&l.depthTextureFormat!==17&&l.depthTextureFormat!==13&&l.depthTextureFormat!==14&&l.depthTextureFormat!==18)return w.Error(`Depth texture ${l.depthTextureFormat} format is not supported.`),o;o.format=l.depthTextureFormat}else o.format=l.generateStencil?13:16;const c=o.format===17||o.format===13||o.format===18;let u=i.UNSIGNED_INT;o.format===15?u=i.UNSIGNED_SHORT:o.format===17||o.format===13?u=i.UNSIGNED_INT_24_8:o.format===14?u=i.FLOAT:o.format===18&&(u=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const h=c?i.DEPTH_STENCIL:i.DEPTH_COMPONENT,f=this._getInternalFormatFromDepthTextureFormat(o.format,!0,c);return o.is2DArray?i.texImage3D(a,0,f,o.width,o.height,r,0,h,u,null):o.is3D?i.texImage3D(a,0,f,o.width,o.height,s,0,h,u,null):i.texImage2D(a,0,f,o.width,o.height,0,h,u,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(o),t._depthStencilBuffer&&(i.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=null),this._bindUnboundFramebuffer(t._MSAAFramebuffer??t._framebuffer),t._generateStencilBuffer=c,t._depthStencilTextureWithStencil=c,t._depthStencilBuffer=this._setupFramebufferDepthAttachments(t._generateStencilBuffer,t._generateDepthBuffer,t.width,t.height,t.samples,o.format),this._bindUnboundFramebuffer(null),o};st.prototype.updateRenderTargetTextureSampleCount=function(n,e){var s;if(this.webGLVersion<2||!n)return 1;if(n.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),n._depthStencilBuffer&&(t.deleteRenderbuffer(n._depthStencilBuffer),n._depthStencilBuffer=null),n._MSAAFramebuffer&&(t.deleteFramebuffer(n._MSAAFramebuffer),n._MSAAFramebuffer=null);const i=(s=n.texture)==null?void 0:s._hardwareTexture;if(i==null||i.releaseMSAARenderBuffers(),n.texture&&e>1&&typeof t.renderbufferStorageMultisample=="function"){const a=t.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");n._MSAAFramebuffer=a,this._bindUnboundFramebuffer(n._MSAAFramebuffer);const o=this._createRenderBuffer(n.texture.width,n.texture.height,e,-1,this._getRGBABufferInternalSizedFormat(n.texture.type,n.texture.format,n.texture._useSRGBBuffer),t.COLOR_ATTACHMENT0,!1);if(!o)throw new Error("Unable to create multi sampled framebuffer");i==null||i.addMSAARenderBuffer(o)}this._bindUnboundFramebuffer(n._MSAAFramebuffer??n._framebuffer),n.texture&&(n.texture.samples=e),n._samples=e;const r=n._depthStencilTexture?n._depthStencilTexture.format:void 0;return n._depthStencilBuffer=this._setupFramebufferDepthAttachments(n._generateStencilBuffer,n._generateDepthBuffer,n.width,n.height,e,r),this._bindUnboundFramebuffer(null),e};st.prototype._setupDepthStencilTexture=function(n,e,t,i,r=1){const s=e.width??e,a=e.height??e,o=e.layers||0,l=e.depth||0;n.baseWidth=s,n.baseHeight=a,n.width=s,n.height=a,n.is2DArray=o>0,n.depth=o||l,n.isReady=!0,n.samples=r,n.generateMipMaps=!1,n.samplingMode=t?2:1,n.type=0,n._comparisonFunction=i;const c=this._gl,u=this._getTextureTarget(n),h=this._getSamplingParameters(n.samplingMode,!1);c.texParameteri(u,c.TEXTURE_MAG_FILTER,h.mag),c.texParameteri(u,c.TEXTURE_MIN_FILTER,h.min),c.texParameteri(u,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(u,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this.webGLVersion>1&&(i===0?(c.texParameteri(u,c.TEXTURE_COMPARE_FUNC,515),c.texParameteri(u,c.TEXTURE_COMPARE_MODE,c.NONE)):(c.texParameteri(u,c.TEXTURE_COMPARE_FUNC,i),c.texParameteri(u,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE)))};st.prototype.setDepthStencilTexture=function(n,e,t,i){n!==void 0&&(e&&(this._boundUniforms[n]=e),!t||!t.depthStencilTexture?this._setTexture(n,null,void 0,void 0,i):this._setTexture(n,t,!1,!0,i))};st.prototype.createRenderTargetCubeTexture=function(n,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,n),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const r=this._gl,s=new Yt(this,5);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,s,!0);const a=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,w.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,a.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,a.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let l=0;l<6;l++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),n,n,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const o=r.createFramebuffer();return this._bindUnboundFramebuffer(o),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,n,n),i.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=o,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,s.width=n,s.height=n,s.isReady=!0,s.isCube=!0,s.samples=1,s.generateMipMaps=i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,this._internalTexturesCache.push(s),t.setTextures(s),t};const ou=1/2.2,lu=2.2,Hi=(1+Math.sqrt(5))/2,pt=.001;function ms(n,e){const t=[];for(let i=0;i<n;++i)t.push(e());return t}function Ia(n,e){return ms(n,e)}function eD(n,e,t){const i=n[e];if(typeof i!="function")return null;const r=function(){const s=n.length,a=r.previous.apply(n,arguments);return t(e,s),a};return i.next=r,r.previous=i,n[e]=r,()=>{const s=r.previous;if(!s)return;const a=r.next;a?(s.next=a,a.previous=s):(s.next=void 0,n[e]=s),r.next=void 0,r.previous=void 0}}const tD=["push","splice","pop","shift","unshift"];function ZS(n,e){const t=tD.map(i=>eD(n,i,e));return()=>{t.forEach(i=>{i==null||i()})}}const QS={};function $(n,e){QS[n]=e}function Ai(n){return QS[n]}function iD(n){return parseInt(n.toString().replace(/\W/g,""))}function Qt(n,e,t=1401298e-51){return Math.abs(n-e)<=t}function Qe(n,e){return n===e?n:Math.random()*(e-n)+n}function ar(n,e,t){return n+(e-n)*t}function rD(n,e,t){let i=Qu(e-n,360);return i>180&&(i-=360),n+i*vt(t)}function sD(n,e,t){let i=0;return n!=e?i=vt((t-n)/(e-n)):i=0,i}function JS(n,e,t,i,r){const s=r*r,a=r*s,o=2*a-3*s+1,l=-2*a+3*s,c=a-2*s+r,u=a-s;return n*o+t*l+e*c+i*u}function nD(n,e,t,i,r){const s=r*r;return(s-r)*6*n+(3*s-4*r+1)*e+(-s+r)*6*t+(3*s-2*r)*i}function vt(n,e=0,t=1){return Math.min(t,Math.max(e,n))}function eT(n){return n-=Math.PI*2*Math.floor((n+Math.PI)/(Math.PI*2)),n}function Vs(n){const e=n.toString(16);return n<=15?("0"+e).toUpperCase():e.toUpperCase()}function mc(n){if(Math.log2)return Math.floor(Math.log2(n));if(n<0)return NaN;if(n===0)return-1/0;let e=0;if(n<1){for(;n<1;)e++,n=n*2;e=-e}else if(n>1)for(;n>1;)e++,n=Math.floor(n/2);return e}function Qu(n,e){return n-Math.floor(n/e)*e}function aD(n,e,t){return(n-e)/(t-e)}function oD(n,e,t){return n*(t-e)+e}function tT(n,e){let t=Qu(e-n,360);return t>180&&(t-=360),t}function lD(n,e){const t=Qu(n,e*2);return e-Math.abs(t-e)}function cD(n,e,t){let i=vt(t);return i=-2*i*i*i+3*i*i,e*i+n*(1-i)}function iT(n,e,t){let i=0;return Math.abs(e-n)<=t?i=e:i=n+Math.sign(e-n)*t,i}function uD(n,e,t){const i=tT(n,e);let r=0;return-t<i&&i<t?r=e:(e=n+i,r=iT(n,e,t)),r}function hD(n,e,t){return(n-e)/(t-e)}function fD(n,e,t){return(t-e)*n+e}function tc(n,e){const t=n%e;return t===0?e:tc(e,t)}const dD=Object.freeze(Object.defineProperty({__proto__:null,Clamp:vt,DeltaAngle:tT,Denormalize:oD,ExtractAsInt:iD,Hermite:JS,Hermite1stDerivative:nD,HighestCommonFactor:tc,ILog2:mc,InverseLerp:sD,Lerp:ar,LerpAngle:rD,MoveTowards:iT,MoveTowardsAngle:uD,Normalize:aD,NormalizeRadians:eT,PercentToRange:fD,PingPong:lD,RandomRange:Qe,RangeToPercent:hD,Repeat:Qu,SmoothStep:cD,ToHex:Vs,WithinEpsilon:Qt},Symbol.toStringTag,{value:"Module"})),Qr=n=>parseInt(n.toString().replace(/\W/g,""));class se{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=Qr(this.x),t=Qr(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return se.FromArrayToRef(e,t,this),this}asArray(){return[this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new se(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new se(this.x+e.x,this.y+e.y)}subtract(e){return new se(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new se(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new se(this.x*e,this.y*t)}divide(e){return new se(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new se(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,i){return i.x=this.x-e,i.y=this.y-t,i}negate(){return new se(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new se(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=pt){return e&&Qt(this.x,e.x,t)&&Qt(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new se(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new se(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotateToRef(e,t){const i=Math.cos(e),r=Math.sin(e),s=i*this.x-r*this.y,a=r*this.x+i*this.y;return t.x=s,t.y=a,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new se;return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new se(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new se(0,0)}static One(){return new se(1,1)}static Random(e=0,t=1){return new se(Qe(e,t),Qe(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(Qe(e,t),Qe(e,t))}static get ZeroReadOnly(){return se._ZeroReadOnly}static FromArray(e,t=0){return new se(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static FromFloatsToRef(e,t,i){return i.copyFromFloats(e,t),i}static CatmullRom(e,t,i,r,s){const a=s*s,o=s*a,l=.5*(2*t.x+(-e.x+i.x)*s+(2*e.x-5*t.x+4*i.x-r.x)*a+(-e.x+3*t.x-3*i.x+r.x)*o),c=.5*(2*t.y+(-e.y+i.y)*s+(2*e.y-5*t.y+4*i.y-r.y)*a+(-e.y+3*t.y-3*i.y+r.y)*o);return new se(l,c)}static ClampToRef(e,t,i,r){return r.x=vt(e.x,t.x,i.x),r.y=vt(e.y,t.y,i.y),r}static Clamp(e,t,i){const r=vt(e.x,t.x,i.x),s=vt(e.y,t.y,i.y);return new se(r,s)}static Hermite(e,t,i,r,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a,f=e.x*l+i.x*c+t.x*u+r.x*h,d=e.y*l+i.y*c+t.y*u+r.y*h;return new se(f,d)}static Hermite1stDerivative(e,t,i,r,s){return this.Hermite1stDerivativeToRef(e,t,i,r,s,new se)}static Hermite1stDerivativeToRef(e,t,i,r,s,a){const o=s*s;return a.x=(o-s)*6*e.x+(3*o-4*s+1)*t.x+(-o+s)*6*i.x+(3*o-2*s)*r.x,a.y=(o-s)*6*e.y+(3*o-4*s+1)*t.y+(-o+s)*6*i.y+(3*o-2*s)*r.y,a}static Lerp(e,t,i){return se.LerpToRef(e,t,i,new se)}static LerpToRef(e,t,i,r){return r.x=e.x+(t.x-e.x)*i,r.y=e.y+(t.y-e.y)*i,r}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return se.NormalizeToRef(e,new se)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new se(i,r)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new se(i,r)}static Transform(e,t){return se.TransformToRef(e,t,new se)}static TransformToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+r[12],a=e.x*r[1]+e.y*r[5]+r[13];return i.x=s,i.y=a,i}static PointInTriangle(e,t,i,r){const s=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),a=s<0?-1:1,o=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*a,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*a;return o>0&&l>0&&o+l<2*s*a}static Distance(e,t){return Math.sqrt(se.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}static Center(e,t){return se.CenterToRef(e,t,new se)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const r=se.DistanceSquared(t,i);if(r===0)return se.Distance(e,t);const s=i.subtract(t),a=Math.max(0,Math.min(1,se.Dot(e.subtract(t),s)/r)),o=t.add(s.multiplyByFloats(a,a));return se.Distance(e,o)}}se._ZeroReadOnly=se.Zero();Object.defineProperties(se.prototype,{dimension:{value:[2]},rank:{value:1}});class m{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=Qr(this._x),t=Qr(this._y),i=Qr(this._z);let r=e;return r=r*397^t,r=r*397^i,r}asArray(){return[this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return m.FromArrayToRef(e,t,this),this}toQuaternion(){return ce.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=!0,this}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new m(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._isDirty=!0,t}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new m(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new m(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,r){return r._x=this._x-e,r._y=this._y-t,r._z=this._z-i,r._isDirty=!0,r}negate(){return new m(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e._x=this._x*-1,e._y=this._y*-1,e._z=this._z*-1,e._isDirty=!0,e}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new m(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._isDirty=!0,t}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const r=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const s=t*Math.sin(i)*Math.cos(r),a=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(r);return e.set(s,a,o),e}applyRotationQuaternionToRef(e,t){const i=this._x,r=this._y,s=this._z,a=e._x,o=e._y,l=e._z,c=e._w,u=2*(o*s-l*r),h=2*(l*i-a*s),f=2*(a*r-o*i);return t._x=i+c*u+o*f-l*h,t._y=r+c*h+l*u-a*f,t._z=s+c*f+a*h-o*u,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new m)}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._isDirty=!0,t}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new m)}projectOnPlaneToRef(e,t,i){const r=e.normal,s=e.d,a=Ye.Vector3[0];this.subtractToRef(t,a),a.normalize();const o=m.Dot(a,r);if(Math.abs(o)<1e-10)i.setAll(1/0);else{const l=-(m.Dot(t,r)+s)/o,c=a.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=pt){return e&&Qt(this._x,e._x,t)&&Qt(this._y,e._y,t)&&Qt(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t._x=this._x*e._x,t._y=this._y*e._y,t._z=this._z*e._z,t._isDirty=!0,t}multiplyByFloats(e,t,i){return new m(this._x*e,this._y*t,this._z*i)}divide(e){return new m(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t._x=this._x/e._x,t._y=this._y/e._y,t._z=this._z/e._z,t._isDirty=!0,t}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=!0,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!Qt(t,i,e))return!0;const r=Math.abs(this._z);return!Qt(t,r,e)||!Qt(i,r,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=!0,e}floor(){return new m(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}fractToRef(e){return e._x=this.x-Math.floor(this._x),e._y=this.y-Math.floor(this._y),e._z=this.z-Math.floor(this._z),e._isDirty=!0,e}fract(){return new m(this.x-Math.floor(this._x),this.y-Math.floor(this._y),this.z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if(e=e.toLowerCase(),e==="xyz")return this;const t=Ye.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(Ye.Matrix[0]),m.TransformCoordinatesToRef(this,Ye.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,Ye.Vector3[0]),Ye.Vector3[0].rotateByQuaternionToRef(e,Ye.Vector3[0]),t.addToRef(Ye.Vector3[0],i),i}cross(e){return m.CrossToRef(this,e,new m)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new m)}normalizeToRef(e){const t=this.length();return t===0||t===1?(e._x=this._x,e._y=this._y,e._z=this._z,e._isDirty=!0,e):this.scaleToRef(1/t,e)}clone(){return new m(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,r){const s=m.Dot(e,i),a=m.Dot(t,i);return(s-r)/(s-a)}static GetAngleBetweenVectors(e,t,i){const r=e.normalizeToRef(Ye.Vector3[1]),s=t.normalizeToRef(Ye.Vector3[2]);let a=m.Dot(r,s);a=vt(a,-1,1);const o=Math.acos(a),l=Ye.Vector3[3];return m.CrossToRef(r,s,l),m.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}static GetAngleBetweenVectorsOnPlane(e,t,i){Ye.Vector3[0].copyFrom(e);const r=Ye.Vector3[0];Ye.Vector3[1].copyFrom(t);const s=Ye.Vector3[1];Ye.Vector3[2].copyFrom(i);const a=Ye.Vector3[2],o=Ye.Vector3[3],l=Ye.Vector3[4];r.normalize(),s.normalize(),a.normalize(),m.CrossToRef(a,r,o),m.CrossToRef(o,a,l);const c=Math.atan2(m.Dot(s,o),m.Dot(s,l));return eT(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const r=B.Vector3[0];return t.subtractToRef(e,r),i._y=Math.atan2(r.x,r.z)||0,i._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=m.Zero();return m.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,r){i=vt(i,0,1);const s=Ye.Vector3[0],a=Ye.Vector3[1];s.copyFrom(e);const o=s.length();s.normalizeFromLength(o),a.copyFrom(t);const l=a.length();a.normalizeFromLength(l);const c=m.Dot(s,a);let u,h;if(c<1-pt){const f=Math.acos(c),d=1/Math.sin(f);u=Math.sin((1-i)*f)*d,h=Math.sin(i*f)*d}else u=1-i,h=i;return s.scaleInPlace(u),a.scaleInPlace(h),r.copyFrom(s).addInPlace(a),r.scaleInPlace(ar(o,l,i)),r}static SmoothToRef(e,t,i,r,s){return m.SlerpToRef(e,t,r===0?1:i/r,s),s}static FromArray(e,t=0){return new m(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return m.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return m.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,r){return r.copyFromFloats(e,t,i),r}static Zero(){return new m(0,0,0)}static One(){return new m(1,1,1)}static Up(){return new m(0,1,0)}static get UpReadOnly(){return m._UpReadOnly}static get DownReadOnly(){return m._DownReadOnly}static get RightReadOnly(){return m._RightReadOnly}static get LeftReadOnly(){return m._LeftReadOnly}static get LeftHandedForwardReadOnly(){return m._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return m._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return m._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return m._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return m._ZeroReadOnly}static get OneReadOnly(){return m._OneReadOnly}static Down(){return new m(0,-1,0)}static Forward(e=!1){return new m(0,0,e?-1:1)}static Backward(e=!1){return new m(0,0,e?1:-1)}static Right(){return new m(1,0,0)}static Left(){return new m(-1,0,0)}static Random(e=0,t=1){return new m(Qe(e,t),Qe(e,t),Qe(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(Qe(e,t),Qe(e,t),Qe(e,t))}static TransformCoordinates(e,t){const i=m.Zero();return m.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return m.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const a=r.m,o=e*a[0]+t*a[4]+i*a[8]+a[12],l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],u=1/(e*a[3]+t*a[7]+i*a[11]+a[15]);return s._x=o*u,s._y=l*u,s._z=c*u,s._isDirty=!0,s}static TransformNormal(e,t){const i=m.Zero();return m.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,r,s){const a=r.m;return s._x=e*a[0]+t*a[4]+i*a[8],s._y=e*a[1]+t*a[5]+i*a[9],s._z=e*a[2]+t*a[6]+i*a[10],s._isDirty=!0,s}static CatmullRom(e,t,i,r,s){const a=s*s,o=s*a,l=.5*(2*t._x+(-e._x+i._x)*s+(2*e._x-5*t._x+4*i._x-r._x)*a+(-e._x+3*t._x-3*i._x+r._x)*o),c=.5*(2*t._y+(-e._y+i._y)*s+(2*e._y-5*t._y+4*i._y-r._y)*a+(-e._y+3*t._y-3*i._y+r._y)*o),u=.5*(2*t._z+(-e._z+i._z)*s+(2*e._z-5*t._z+4*i._z-r._z)*a+(-e._z+3*t._z-3*i._z+r._z)*o);return new m(l,c,u)}static Clamp(e,t,i){const r=new m;return m.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){let s=e._x;s=s>i._x?i._x:s,s=s<t._x?t._x:s;let a=e._y;a=a>i._y?i._y:a,a=a<t._y?t._y:a;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,r.copyFromFloats(s,a,o),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,r,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a,f=e._x*l+i._x*c+t._x*u+r._x*h,d=e._y*l+i._y*c+t._y*u+r._y*h,p=e._z*l+i._z*c+t._z*u+r._z*h;return new m(f,d,p)}static Hermite1stDerivative(e,t,i,r,s){const a=new m;return this.Hermite1stDerivativeToRef(e,t,i,r,s,a),a}static Hermite1stDerivativeToRef(e,t,i,r,s,a){const o=s*s;return a._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*i._x+(3*o-2*s)*r._x,a._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*i._y+(3*o-2*s)*r._y,a._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*i._z+(3*o-2*s)*r._z,a._isDirty=!0,a}static Lerp(e,t,i){const r=new m(0,0,0);return m.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){return r._x=e._x+(t._x-e._x)*i,r._y=e._y+(t._y-e._y)*i,r._z=e._z+(t._z-e._z)*i,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new m;return m.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const r=e._y*t._z-e._z*t._y,s=e._z*t._x-e._x*t._z,a=e._x*t._y-e._y*t._x;return i.copyFromFloats(r,s,a),i}static Normalize(e){const t=m.Zero();return m.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,r){const s=new m;return m.ProjectToRef(e,t,i,r,s),s}static ProjectToRef(e,t,i,r,s){var _;const a=r.width,o=r.height,l=r.x,c=r.y,u=Ye.Matrix[1],h=(_=$e.LastCreatedEngine)==null?void 0:_.isNDCHalfZRange,f=h?1:.5,d=h?0:.5;O.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,f,0,l+a/2,o/2+c,d,1,u);const p=Ye.Matrix[0];return t.multiplyToRef(i,p),p.multiplyToRef(u,p),m.TransformCoordinatesToRef(e,p,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new m)}static ReflectToRef(e,t,i){const r=B.Vector3[0];return r.copyFrom(t).scaleInPlace(2*m.Dot(e,t)),i.copyFrom(e).subtractInPlace(r)}static _UnprojectFromInvertedMatrixToRef(e,t,i){m.TransformCoordinatesToRef(e,t,i);const r=t.m,s=e._x*r[3]+e._y*r[7]+e._z*r[11]+r[15];return Qt(s,1)&&i.scaleInPlace(1/s),i}static UnprojectFromTransform(e,t,i,r,s){return this.Unproject(e,t,i,r,s,O.IdentityReadOnly)}static Unproject(e,t,i,r,s,a){const o=new m;return m.UnprojectToRef(e,t,i,r,s,a,o),o}static UnprojectToRef(e,t,i,r,s,a,o){return m.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,r,s,a,o),o}static UnprojectFloatsToRef(e,t,i,r,s,a,o,l,c){var f;const u=Ye.Matrix[0];a.multiplyToRef(o,u),u.multiplyToRef(l,u),u.invert();const h=Ye.Vector3[0];return h.x=e/r*2-1,h.y=-(t/s*2-1),(f=$e.LastCreatedEngine)!=null&&f.isNDCHalfZRange?h.z=i:h.z=2*i-1,m._UnprojectFromInvertedMatrixToRef(h,u,c),c}static Minimize(e,t){const i=new m;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new m;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(m.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,r=e._y-t._y,s=e._z-t._z;return i*i+r*r+s*s}static ProjectOnTriangleToRef(e,t,i,r,s){const a=Ye.Vector3[0],o=Ye.Vector3[1],l=Ye.Vector3[2],c=Ye.Vector3[3],u=Ye.Vector3[4];i.subtractToRef(t,a),r.subtractToRef(t,o),r.subtractToRef(i,l);const h=a.length(),f=o.length(),d=l.length();if(h<pt||f<pt||d<pt)return s.copyFrom(t),m.Distance(e,t);e.subtractToRef(t,u),m.CrossToRef(a,o,c);const p=c.length();if(p<pt)return s.copyFrom(t),m.Distance(e,t);c.normalizeFromLength(p);let _=u.length();if(_<pt)return s.copyFrom(t),0;u.normalizeFromLength(_);const g=m.Dot(c,u),E=Ye.Vector3[5],v=Ye.Vector3[6];E.copyFrom(c).scaleInPlace(-_*g),v.copyFrom(e).addInPlace(E);const x=Ye.Vector3[4],A=Ye.Vector3[5],T=Ye.Vector3[7],C=Ye.Vector3[8];x.copyFrom(a).scaleInPlace(1/h),C.copyFrom(o).scaleInPlace(1/f),x.addInPlace(C).scaleInPlace(-1),A.copyFrom(a).scaleInPlace(-1/h),C.copyFrom(l).scaleInPlace(1/d),A.addInPlace(C).scaleInPlace(-1),T.copyFrom(l).scaleInPlace(-1/d),C.copyFrom(o).scaleInPlace(-1/f),T.addInPlace(C).scaleInPlace(-1);const y=Ye.Vector3[9];let P;y.copyFrom(v).subtractInPlace(t),m.CrossToRef(x,y,C),P=m.Dot(C,c);const D=P;y.copyFrom(v).subtractInPlace(i),m.CrossToRef(A,y,C),P=m.Dot(C,c);const F=P;y.copyFrom(v).subtractInPlace(r),m.CrossToRef(T,y,C),P=m.Dot(C,c);const W=P,H=Ye.Vector3[10];let ue,ae;D>0&&F<0?(H.copyFrom(a),ue=t,ae=i):F>0&&W<0?(H.copyFrom(l),ue=i,ae=r):(H.copyFrom(o).scaleInPlace(-1),ue=r,ae=t);const le=Ye.Vector3[9],oe=Ye.Vector3[4];if(ue.subtractToRef(v,C),ae.subtractToRef(v,le),m.CrossToRef(C,le,oe),!(m.Dot(oe,c)<0))return s.copyFrom(v),Math.abs(_*g);const Ee=Ye.Vector3[5];m.CrossToRef(H,oe,Ee),Ee.normalize();const ne=Ye.Vector3[9];ne.copyFrom(ue).subtractInPlace(v);const j=ne.length();if(j<pt)return s.copyFrom(ue),m.Distance(e,ue);ne.normalizeFromLength(j);const L=m.Dot(Ee,ne),Y=Ye.Vector3[7];Y.copyFrom(v).addInPlace(Ee.scaleInPlace(j*L)),C.copyFrom(Y).subtractInPlace(ue),_=H.length(),H.normalizeFromLength(_);let te=m.Dot(C,H)/Math.max(_,pt);return te=vt(te,0,1),Y.copyFrom(ue).addInPlace(H.scaleInPlace(te*_)),s.copyFrom(Y),m.Distance(e,Y)}static Center(e,t){return m.CenterToRef(e,t,m.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const r=new m;return m.RotationFromAxisToRef(e,t,i,r),r}static RotationFromAxisToRef(e,t,i,r){const s=Ye.Quaternion[0];return ce.RotationQuaternionFromAxisToRef(e,t,i,s),s.toEulerAnglesToRef(r),r}}m._UpReadOnly=m.Up();m._DownReadOnly=m.Down();m._LeftHandedForwardReadOnly=m.Forward(!1);m._RightHandedForwardReadOnly=m.Forward(!0);m._LeftHandedBackwardReadOnly=m.Backward(!1);m._RightHandedBackwardReadOnly=m.Backward(!0);m._RightReadOnly=m.Right();m._LeftReadOnly=m.Left();m._ZeroReadOnly=m.Zero();m._OneReadOnly=m.One();Object.defineProperties(m.prototype,{dimension:{value:[3]},rank:{value:1}});class We{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.z=i,this.w=r}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=Qr(this.x),t=Qr(this.y),i=Qr(this.z),r=Qr(this.w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){return[this.x,this.y,this.z,this.w]}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return We.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addInPlaceFromFloats(e,t,i,r){return this.x+=e,this.y+=t,this.z+=i,this.w+=r,this}add(e){return new We(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new We(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,r){return new We(this.x-e,this.y-t,this.z-i,this.w-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.x=this.x-e,s.y=this.y-t,s.z=this.z-i,s.w=this.w-r,s}negate(){return new We(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=-this.w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new We(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=pt){return e&&Qt(this.x,e.x,t)&&Qt(this.y,e.y,t)&&Qt(this.z,e.z,t)&&Qt(this.w,e.w,t)}equalsToFloats(e,t,i,r){return this.x===e&&this.y===t&&this.z===i&&this.w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new We(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,r){return new We(this.x*e,this.y*t,this.z*i,this.w*r)}divide(e){return new We(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,i,r){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this.z=Math.min(i,this.z),this.w=Math.min(r,this.w),this}maximizeInPlaceFromFloats(e,t,i,r){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this.z=Math.max(i,this.z),this.w=Math.max(r,this.w),this}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e.z=Math.floor(this.z),e.w=Math.floor(this.w),e}floor(){return new We(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e.z=this.z-Math.floor(this.z),e.w=this.w-Math.floor(this.w),e}fract(){return new We(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new We)}normalizeToRef(e){const t=this.length();return t===0||t===1?(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e):this.scaleToRef(1/t,e)}toVector3(){return new m(this.x,this.y,this.z)}clone(){return new We(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new We(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return We.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}static Zero(){return new We(0,0,0,0)}static One(){return new We(1,1,1,1)}static Random(e=0,t=1){return new We(Qe(e,t),Qe(e,t),Qe(e,t),Qe(e,t))}static RandomToRef(e=0,t=1,i){return i.x=Qe(e,t),i.y=Qe(e,t),i.z=Qe(e,t),i.w=Qe(e,t),i}static Clamp(e,t,i){return We.ClampToRef(e,t,i,new We)}static ClampToRef(e,t,i,r){return r.x=vt(e.x,t.x,i.x),r.y=vt(e.y,t.y,i.y),r.z=vt(e.z,t.z,i.z),r.w=vt(e.w,t.w,i.w),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static get ZeroReadOnly(){return We._ZeroReadOnly}static Normalize(e){return We.NormalizeToRef(e,new We)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new We;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new We;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(We.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return i*i+r*r+s*s+a*a}static Center(e,t){return We.CenterToRef(e,t,new We)}static CenterToRef(e,t,i){return i.x=(e.x+t.x)/2,i.y=(e.y+t.y)/2,i.z=(e.z+t.z)/2,i.w=(e.w+t.w)/2,i}static TransformCoordinates(e,t){return We.TransformCoordinatesToRef(e,t,new We)}static TransformCoordinatesToRef(e,t,i){return We.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,s){const a=r.m,o=e*a[0]+t*a[4]+i*a[8]+a[12],l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],u=e*a[3]+t*a[7]+i*a[11]+a[15];return s.x=o,s.y=l,s.z=c,s.w=u,s}static TransformNormal(e,t){return We.TransformNormalToRef(e,t,new We)}static TransformNormalToRef(e,t,i){const r=t.m,s=e.x*r[0]+e.y*r[4]+e.z*r[8],a=e.x*r[1]+e.y*r[5]+e.z*r[9],o=e.x*r[2]+e.y*r[6]+e.z*r[10];return i.x=s,i.y=a,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,r,s,a){const o=s.m;return a.x=e*o[0]+t*o[4]+i*o[8],a.y=e*o[1]+t*o[5]+i*o[9],a.z=e*o[2]+t*o[6]+i*o[10],a.w=r,a}static FromVector3(e,t=0){return new We(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}}We._ZeroReadOnly=We.Zero();Object.defineProperties(We.prototype,{dimension:{value:[4]},rank:{value:1}});class ce{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=Qr(this._x),t=Qr(this._y),i=Qr(this._z),r=Qr(this._w);let s=e;return s=s*397^t,s=s*397^i,s=s*397^r,s}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return ce.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=pt){return e&&Qt(this._x,e._x,t)&&Qt(this._y,e._y,t)&&Qt(this._z,e._z,t)&&Qt(this._w,e._w,t)}clone(){return new ce(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._isDirty=!0,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new ce(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=!0,t}addInPlaceFromFloats(e,t,i,r){return this._x+=e,this._y+=t,this._z+=i,this._w+=r,this._isDirty=!0,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=!0,t}subtractFromFloats(e,t,i,r){return this.subtractFromFloatsToRef(e,t,i,r,new ce)}subtractFromFloatsToRef(e,t,i,r,s){return s._x=this._x-e,s._y=this._y-t,s._z=this._z-i,s._w=this._w-r,s._isDirty=!0,s}subtract(e){return new ce(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new ce(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new ce(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,s=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,a=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,s,a),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,i,r){return this._x*=e,this._y*=t,this._z*=i,this._w*=r,this._isDirty=!0,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new ce)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=!0,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=!0,e}equalsToFloats(e,t,i,r){return this._x===e&&this._y===t&&this._z===i&&this._w===r}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new ce(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new ce(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=m.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,a=r*t-i*s,o=.4999999;if(a<-o)e._y=2*Math.atan2(r,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(a>o)e._y=2*Math.atan2(r,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=s*s,c=t*t,u=i*i,h=r*r;e._z=Math.atan2(2*(i*r+t*s),-c-u+h+l),e._x=Math.asin(-2*a),e._y=Math.atan2(2*(t*i+r*s),c-u-h+l),e._isDirty=!0}return e}toAlphaBetaGammaToRef(e){const t=this._z,i=this._x,r=this._y,s=this._w,a=Math.sqrt(i*i+r*r),o=Math.sqrt(t*t+s*s),l=2*Math.atan2(a,o),c=2*Math.atan2(t,s),u=2*Math.atan2(r,i),h=(c+u)/2,f=(c-u)/2;return e.set(f,l,h),e}toRotationMatrix(e){return O.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return ce.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new ce;return ce.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,r=i[0],s=i[4],a=i[8],o=i[1],l=i[5],c=i[9],u=i[2],h=i[6],f=i[10],d=r+l+f;let p;return d>0?(p=.5/Math.sqrt(d+1),t._w=.25/p,t._x=(h-c)*p,t._y=(a-u)*p,t._z=(o-s)*p,t._isDirty=!0):r>l&&r>f?(p=2*Math.sqrt(1+r-l-f),t._w=(h-c)/p,t._x=.25*p,t._y=(s+o)/p,t._z=(a+u)/p,t._isDirty=!0):l>f?(p=2*Math.sqrt(1+l-r-f),t._w=(a-u)/p,t._x=(s+o)/p,t._y=.25*p,t._z=(c+h)/p,t._isDirty=!0):(p=2*Math.sqrt(1+f-r-l),t._w=(o-s)/p,t._x=(a+u)/p,t._y=(c+h)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const r=ce.Dot(e,t);return 1-r*r<=i}static SmoothToRef(e,t,i,r,s){let a=r===0?1:i/r;return a=vt(a,0,1),ce.SlerpToRef(e,t,a,s),s}static Zero(){return new ce(0,0,0,0)}static Inverse(e){return new ce(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new ce(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return ce.RotationAxisToRef(e,t,new ce)}static RotationAxisToRef(e,t,i){i._w=Math.cos(t/2);const r=Math.sin(t/2)/e.length();return i._x=e._x*r,i._y=e._y*r,i._z=e._z*r,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new ce(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromFloatsToRef(e,t,i,r,s){return s.copyFromFloats(e,t,i,r),s}static FromEulerAngles(e,t,i){const r=new ce;return ce.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerAnglesToRef(e,t,i,r){return ce.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerVector(e){const t=new ce;return ce.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return ce.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,r=pt){const s=m.Dot(e,t)+1;return s<r?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(m.CrossToRef(e,t,B.Vector3[0]),i.set(B.Vector3[0].x,B.Vector3[0].y,B.Vector3[0].z,s)),i.normalize()}static RotationYawPitchRoll(e,t,i){const r=new ce;return ce.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){const s=i*.5,a=t*.5,o=e*.5,l=Math.sin(s),c=Math.cos(s),u=Math.sin(a),h=Math.cos(a),f=Math.sin(o),d=Math.cos(o);return r._x=d*u*c+f*h*l,r._y=f*h*c-d*u*l,r._z=d*h*l-f*u*c,r._w=d*h*c+f*u*l,r._isDirty=!0,r}static RotationAlphaBetaGamma(e,t,i){const r=new ce;return ce.RotationAlphaBetaGammaToRef(e,t,i,r),r}static RotationAlphaBetaGammaToRef(e,t,i,r){const s=(i+e)*.5,a=(i-e)*.5,o=t*.5;return r._x=Math.cos(a)*Math.sin(o),r._y=Math.sin(a)*Math.sin(o),r._z=Math.sin(s)*Math.cos(o),r._w=Math.cos(s)*Math.cos(o),r._isDirty=!0,r}static RotationQuaternionFromAxis(e,t,i){const r=new ce(0,0,0,0);return ce.RotationQuaternionFromAxisToRef(e,t,i,r),r}static RotationQuaternionFromAxisToRef(e,t,i,r){const s=Ye.Matrix[0];return e=e.normalizeToRef(Ye.Vector3[0]),t=t.normalizeToRef(Ye.Vector3[1]),i=i.normalizeToRef(Ye.Vector3[2]),O.FromXYZAxesToRef(e,t,i,s),ce.FromRotationMatrixToRef(s,r),r}static FromLookDirectionLH(e,t){const i=new ce;return ce.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const r=Ye.Matrix[0];return O.LookDirectionLHToRef(e,t,r),ce.FromRotationMatrixToRef(r,i),i}static FromLookDirectionRH(e,t){const i=new ce;return ce.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const r=Ye.Matrix[0];return O.LookDirectionRHToRef(e,t,r),ce.FromRotationMatrixToRef(r,i)}static Slerp(e,t,i){const r=ce.Identity();return ce.SlerpToRef(e,t,i,r),r}static SlerpToRef(e,t,i,r){let s,a,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)a=1-i,s=l?-i:i;else{const c=Math.acos(o),u=1/Math.sin(c);a=Math.sin((1-i)*c)*u,s=l?-Math.sin(i*c)*u:Math.sin(i*c)*u}return r._x=a*e._x+s*t._x,r._y=a*e._y+s*t._y,r._z=a*e._z+s*t._z,r._w=a*e._w+s*t._w,r._isDirty=!0,r}static Hermite(e,t,i,r,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a,f=e._x*l+i._x*c+t._x*u+r._x*h,d=e._y*l+i._y*c+t._y*u+r._y*h,p=e._z*l+i._z*c+t._z*u+r._z*h,_=e._w*l+i._w*c+t._w*u+r._w*h;return new ce(f,d,p,_)}static Hermite1stDerivative(e,t,i,r,s){const a=new ce;return this.Hermite1stDerivativeToRef(e,t,i,r,s,a),a}static Hermite1stDerivativeToRef(e,t,i,r,s,a){const o=s*s;return a._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*i._x+(3*o-2*s)*r._x,a._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*i._y+(3*o-2*s)*r._y,a._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*i._z+(3*o-2*s)*r._z,a._w=(o-s)*6*e._w+(3*o-4*s+1)*t._w+(-o+s)*6*i._w+(3*o-2*s)*r._w,a._isDirty=!0,a}static Normalize(e){const t=ce.Zero();return ce.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,i){const r=new ce;return ce.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){return r.copyFromFloats(vt(e.x,t.x,i.x),vt(e.y,t.y,i.y),vt(e.z,t.z,i.z),vt(e.w,t.w,i.w))}static Random(e=0,t=1){return new ce(Qe(e,t),Qe(e,t),Qe(e,t),Qe(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(Qe(e,t),Qe(e,t),Qe(e,t),Qe(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(ce.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return i*i+r*r+s*s+a*a}static Center(e,t){return ce.CenterToRef(e,t,ce.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}}Object.defineProperties(ce.prototype,{dimension:{value:[4]},rank:{value:1}});class O{static get Use64Bits(){return lr.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=O._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,lr.MatrixTrackPrecisionChange&&lr.MatrixTrackedMatrices.push(this),this._m=new lr.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=e[6],c=e[7],u=e[8],h=e[9],f=e[10],d=e[11],p=e[12],_=e[13],g=e[14],E=e[15],v=f*E-g*d,x=h*E-_*d,A=h*g-_*f,T=u*E-p*d,C=u*g-f*p,y=u*_-p*h,P=+(o*v-l*x+c*A),D=-(a*v-l*T+c*C),F=+(a*x-o*T+c*y),W=-(a*A-o*C+l*y);return t*P+i*D+r*F+s*W}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}
${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}
${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}
${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;const i=this._m;for(let r=0;r<16;r++)e[t+r]=i[r];return this}asArray(){return this._m}fromArray(e,t=0){return O.FromArrayToRef(e,t,this)}copyFromFloats(...e){return O.FromArrayToRef(e,0,this)}set(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=e[i];return this.markAsUpdated(),this}setAll(e){const t=this._m;for(let i=0;i<16;i++)t[i]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return O.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new O;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,r=t._m,s=e.m;for(let a=0;a<16;a++)r[a]=i[a]+s[a];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],t[9]+=i[9],t[10]+=i[10],t[11]+=i[11],t[12]+=i[12],t[13]+=i[13],t[14]+=i[14],t[15]+=i[15],this.markAsUpdated(),this}addInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]+=i[r];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]+=e[i];return this.markAsUpdated(),this}subtract(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]-=i[r];return this.markAsUpdated(),this}subtractToRef(e,t){const i=this._m,r=e.m,s=t._m;for(let a=0;a<16;a++)s[a]=i[a]-r[a];return t.markAsUpdated(),t}subtractInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]-=i[r];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new O)}subtractFromFloatsToRef(...e){const t=e.pop(),i=this._m,r=t._m,s=e;for(let a=0;a<16;a++)r[a]=i[a]-s[a];return t.markAsUpdated(),t}invertToRef(e){if(this._isIdentity===!0)return O.IdentityToRef(e),e;const t=this._m,i=t[0],r=t[1],s=t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],f=t[9],d=t[10],p=t[11],_=t[12],g=t[13],E=t[14],v=t[15],x=d*v-E*p,A=f*v-g*p,T=f*E-g*d,C=h*v-_*p,y=h*E-d*_,P=h*g-_*f,D=+(l*x-c*A+u*T),F=-(o*x-c*C+u*y),W=+(o*A-l*C+u*P),H=-(o*T-l*y+c*P),ue=i*D+r*F+s*W+a*H;if(ue===0)return e.copyFrom(this),e;const ae=1/ue,le=c*v-E*u,oe=l*v-g*u,ge=l*E-g*c,Ee=o*v-_*u,ne=o*E-_*c,j=o*g-_*l,L=c*p-d*u,Y=l*p-f*u,te=l*d-f*c,De=o*p-h*u,Ve=o*d-h*c,ve=o*f-h*l,Me=-(r*x-s*A+a*T),Re=+(i*x-s*C+a*y),Pe=-(i*A-r*C+a*P),ft=+(i*T-r*y+s*P),Wt=+(r*le-s*oe+a*ge),xe=-(i*le-s*Ee+a*ne),z=+(i*oe-r*Ee+a*j),K=-(i*ge-r*ne+s*j),he=-(r*L-s*Y+a*te),Ce=+(i*L-s*De+a*Ve),ye=-(i*Y-r*De+a*ve),be=+(i*te-r*Ve+s*ve);return O.FromValuesToRef(D*ae,Me*ae,Wt*ae,he*ae,F*ae,Re*ae,xe*ae,Ce*ae,W*ae,Pe*ae,z*ae,ye*ae,H*ae,ft*ae,K*ae,be*ae,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new m(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return O.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiply(e){const t=new O;return this.multiplyToRef(e,t),t}multiplyInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]*=i[r];return this.markAsUpdated(),this}multiplyByFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e[i];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){const t=e.pop(),i=this._m,r=t._m,s=e;for(let a=0;a<16;a++)r[a]=i[a]*s[a];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const r=this._m,s=e.m,a=r[0],o=r[1],l=r[2],c=r[3],u=r[4],h=r[5],f=r[6],d=r[7],p=r[8],_=r[9],g=r[10],E=r[11],v=r[12],x=r[13],A=r[14],T=r[15],C=s[0],y=s[1],P=s[2],D=s[3],F=s[4],W=s[5],H=s[6],ue=s[7],ae=s[8],le=s[9],oe=s[10],ge=s[11],Ee=s[12],ne=s[13],j=s[14],L=s[15];return t[i]=a*C+o*F+l*ae+c*Ee,t[i+1]=a*y+o*W+l*le+c*ne,t[i+2]=a*P+o*H+l*oe+c*j,t[i+3]=a*D+o*ue+l*ge+c*L,t[i+4]=u*C+h*F+f*ae+d*Ee,t[i+5]=u*y+h*W+f*le+d*ne,t[i+6]=u*P+h*H+f*oe+d*j,t[i+7]=u*D+h*ue+f*ge+d*L,t[i+8]=p*C+_*F+g*ae+E*Ee,t[i+9]=p*y+_*W+g*le+E*ne,t[i+10]=p*P+_*H+g*oe+E*j,t[i+11]=p*D+_*ue+g*ge+E*L,t[i+12]=v*C+x*F+A*ae+T*Ee,t[i+13]=v*y+x*W+A*le+T*ne,t[i+14]=v*P+x*H+A*oe+T*j,t[i+15]=v*D+x*ue+A*ge+T*L,this}divide(e){return this.divideToRef(e,new O)}divideToRef(e,t){const i=this._m,r=e.m,s=t._m;for(let a=0;a<16;a++)s[a]=i[a]/r[a];return t.markAsUpdated(),t}divideInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]/=i[r];return this.markAsUpdated(),this}minimizeInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],i[r]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}maximizeInPlace(e){const t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],i[r]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new O)}negateInPlace(){const e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){const t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=-t[r];return e.markAsUpdated(),e}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,r=t.m;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]&&i[9]===r[9]&&i[10]===r[10]&&i[11]===r[11]&&i[12]===r[12]&&i[13]===r[13]&&i[14]===r[14]&&i[15]===r[15]}equalsWithEpsilon(e,t=0){const i=this._m,r=e.m;for(let s=0;s<16;s++)if(!Qt(i[s],r[s],t))return!1;return!0}equalsToFloats(...e){const t=this._m;for(let i=0;i<16;i++)if(t[i]!=e[i])return!1;return!0}floor(){return this.floorToRef(new O)}floorToRef(e){const t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=Math.floor(t[r]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new O)}fractToRef(e){const t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=t[r]-Math.floor(t[r]);return e.markAsUpdated(),e}clone(){const e=new O;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=Qr(this._m[0]);for(let t=1;t<16;t++)e=e*397^Qr(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new ce,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,r,s=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const a=this._m;if(i&&i.copyFromFloats(a[12],a[13],a[14]),e=e||Ye.Vector3[0],e.x=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),e.y=Math.sqrt(a[4]*a[4]+a[5]*a[5]+a[6]*a[6]),e.z=Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]),r){const o=(s?r.absoluteScaling.x:r.scaling.x)<0?-1:1,l=(s?r.absoluteScaling.y:r.scaling.y)<0?-1:1,c=(s?r.absoluteScaling.z:r.scaling.z)<0?-1:1;e.x*=o,e.y*=l,e.z*=c}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const o=1/e._x,l=1/e._y,c=1/e._z;O.FromValuesToRef(a[0]*o,a[1]*o,a[2]*o,0,a[4]*l,a[5]*l,a[6]*l,0,a[8]*c,a[9]*c,a[10]*c,0,0,0,0,1,Ye.Matrix[0]),ce.FromRotationMatrixToRef(Ye.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new We(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new O;return O.TransposeToRef(this,e),e}transposeToRef(e){return O.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,r,s){if(e<0||e>3)return this;const a=e*4;return this._m[a+0]=t,this._m[a+1]=i,this._m[a+2]=r,this._m[a+3]=s,this.markAsUpdated(),this}scale(e){const t=new O;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}scaleInPlace(e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){const t=Ye.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return O.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new O;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=Ye.Vector3[0];if(!this.decompose(t))return O.IdentityToRef(e),e;const i=this._m,r=1/t._x,s=1/t._y,a=1/t._z;return O.FromValuesToRef(i[0]*r,i[1]*r,i[2]*r,0,i[4]*s,i[5]*s,i[6]*s,0,i[8]*a,i[9]*a,i[10]*a,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new O;return O.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let r=0;r<16;r++)i._m[r]=e[r+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,r){return r._m[0]=e[0+t]*i,r._m[1]=e[1+t]*i,r._m[2]=e[2+t]*i,r._m[3]=e[3+t]*i,r._m[4]=e[4+t]*i,r._m[5]=e[5+t]*i,r._m[6]=e[6+t]*i,r._m[7]=e[7+t]*i,r._m[8]=e[8+t]*i,r._m[9]=e[9+t]*i,r._m[10]=e[10+t]*i,r._m[11]=e[11+t]*i,r._m[12]=e[12+t]*i,r._m[13]=e[13+t]*i,r._m[14]=e[14+t]*i,r._m[15]=e[15+t]*i,r.markAsUpdated(),r}static get IdentityReadOnly(){return O._IdentityReadOnly}static FromValuesToRef(e,t,i,r,s,a,o,l,c,u,h,f,d,p,_,g,E){const v=E._m;v[0]=e,v[1]=t,v[2]=i,v[3]=r,v[4]=s,v[5]=a,v[6]=o,v[7]=l,v[8]=c,v[9]=u,v[10]=h,v[11]=f,v[12]=d,v[13]=p,v[14]=_,v[15]=g,E.markAsUpdated()}static FromValues(e,t,i,r,s,a,o,l,c,u,h,f,d,p,_,g){const E=new O,v=E._m;return v[0]=e,v[1]=t,v[2]=i,v[3]=r,v[4]=s,v[5]=a,v[6]=o,v[7]=l,v[8]=c,v[9]=u,v[10]=h,v[11]=f,v[12]=d,v[13]=p,v[14]=_,v[15]=g,E.markAsUpdated(),E}static Compose(e,t,i){const r=new O;return O.ComposeToRef(e,t,i,r),r}static ComposeToRef(e,t,i,r){const s=r._m,a=t._x,o=t._y,l=t._z,c=t._w,u=a+a,h=o+o,f=l+l,d=a*u,p=a*h,_=a*f,g=o*h,E=o*f,v=l*f,x=c*u,A=c*h,T=c*f,C=e._x,y=e._y,P=e._z;return s[0]=(1-(g+v))*C,s[1]=(p+T)*C,s[2]=(_-A)*C,s[3]=0,s[4]=(p-T)*y,s[5]=(1-(d+v))*y,s[6]=(E+x)*y,s[7]=0,s[8]=(_+A)*P,s[9]=(E-x)*P,s[10]=(1-(d+g))*P,s[11]=0,s[12]=i._x,s[13]=i._y,s[14]=i._z,s[15]=1,r.markAsUpdated(),r}static Identity(){const e=O.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return O.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=O.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new O;return O.RotationXToRef(e,t),t}static Invert(e){const t=new O;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return O.FromValuesToRef(1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationY(e){const t=new O;return O.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return O.FromValuesToRef(r,0,-i,0,0,1,0,0,i,0,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationZ(e){const t=new O;return O.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),r=Math.cos(e);return O.FromValuesToRef(r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationAxis(e,t){const i=new O;return O.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const r=Math.sin(-t),s=Math.cos(-t),a=1-s;e=e.normalizeToRef(Ye.Vector3[0]);const o=i._m;return o[0]=e._x*e._x*a+s,o[1]=e._x*e._y*a-e._z*r,o[2]=e._x*e._z*a+e._y*r,o[3]=0,o[4]=e._y*e._x*a+e._z*r,o[5]=e._y*e._y*a+s,o[6]=e._y*e._z*a-e._x*r,o[7]=0,o[8]=e._z*e._x*a-e._y*r,o[9]=e._z*e._y*a+e._x*r,o[10]=e._z*e._z*a+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,r=!1){const s=m.Dot(t,e),a=i._m;if(s<-1+pt)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=r?1:-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=r?-1:1,a[11]=0;else{const o=m.Cross(t,e),l=1/(1+s);a[0]=o._x*o._x*l+s,a[1]=o._y*o._x*l-o._z,a[2]=o._z*o._x*l+o._y,a[3]=0,a[4]=o._x*o._y*l+o._z,a[5]=o._y*o._y*l+s,a[6]=o._z*o._y*l-o._x,a[7]=0,a[8]=o._x*o._z*l-o._y,a[9]=o._y*o._z*l+o._x,a[10]=o._z*o._z*l+s,a[11]=0}return a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const r=new O;return O.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){return ce.RotationYawPitchRollToRef(e,t,i,Ye.Quaternion[0]),Ye.Quaternion[0].toRotationMatrix(r),r}static Scaling(e,t,i){const r=new O;return O.ScalingToRef(e,t,i,r),r}static ScalingToRef(e,t,i,r){return O.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,r),r._updateIdentityStatus(e===1&&t===1&&i===1),r}static Translation(e,t,i){const r=new O;return O.TranslationToRef(e,t,i,r),r}static TranslationToRef(e,t,i,r){return O.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r),r._updateIdentityStatus(e===0&&t===0&&i===0),r}static Lerp(e,t,i){const r=new O;return O.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){const s=r._m,a=e.m,o=t.m;for(let l=0;l<16;l++)s[l]=a[l]*(1-i)+o[l]*i;return r.markAsUpdated(),r}static DecomposeLerp(e,t,i){const r=new O;return O.DecomposeLerpToRef(e,t,i,r),r}static DecomposeLerpToRef(e,t,i,r){const s=Ye.Vector3[0],a=Ye.Quaternion[0],o=Ye.Vector3[1];e.decompose(s,a,o);const l=Ye.Vector3[2],c=Ye.Quaternion[1],u=Ye.Vector3[3];t.decompose(l,c,u);const h=Ye.Vector3[4];m.LerpToRef(s,l,i,h);const f=Ye.Quaternion[2];ce.SlerpToRef(a,c,i,f);const d=Ye.Vector3[5];return m.LerpToRef(o,u,i,d),O.ComposeToRef(h,f,d,r),r}static LookAtLH(e,t,i){const r=new O;return O.LookAtLHToRef(e,t,i,r),r}static LookAtLHToRef(e,t,i,r){const s=Ye.Vector3[0],a=Ye.Vector3[1],o=Ye.Vector3[2];t.subtractToRef(e,o),o.normalize(),m.CrossToRef(i,o,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(o,s,a),a.normalize();const c=-m.Dot(s,e),u=-m.Dot(a,e),h=-m.Dot(o,e);return O.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,c,u,h,1,r),r}static LookAtRH(e,t,i){const r=new O;return O.LookAtRHToRef(e,t,i,r),r}static LookAtRHToRef(e,t,i,r){const s=Ye.Vector3[0],a=Ye.Vector3[1],o=Ye.Vector3[2];e.subtractToRef(t,o),o.normalize(),m.CrossToRef(i,o,s);const l=s.lengthSquared();l===0?s.x=1:s.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(o,s,a),a.normalize();const c=-m.Dot(s,e),u=-m.Dot(a,e),h=-m.Dot(o,e);return O.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,c,u,h,1,r),r}static LookDirectionLH(e,t){const i=new O;return O.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const r=Ye.Vector3[0];r.copyFrom(e),r.scaleInPlace(-1);const s=Ye.Vector3[1];return m.CrossToRef(t,r,s),O.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new O;return O.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const r=Ye.Vector3[2];return m.CrossToRef(t,e,r),O.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,r,s){const a=new O;return O.OrthoLHToRef(e,t,i,r,a,s),a}static OrthoLHToRef(e,t,i,r,s,a){const o=i,l=r,c=2/e,u=2/t,h=2/(l-o),f=-(l+o)/(l-o);return O.FromValuesToRef(c,0,0,0,0,u,0,0,0,0,h,0,0,0,f,1,s),a&&s.multiplyToRef(wa,s),s._updateIdentityStatus(c===1&&u===1&&h===1&&f===0),s}static OrthoOffCenterLH(e,t,i,r,s,a,o){const l=new O;return O.OrthoOffCenterLHToRef(e,t,i,r,s,a,l,o),l}static OrthoOffCenterLHToRef(e,t,i,r,s,a,o,l){const c=s,u=a,h=2/(t-e),f=2/(r-i),d=2/(u-c),p=-(u+c)/(u-c),_=(e+t)/(e-t),g=(r+i)/(i-r);return O.FromValuesToRef(h,0,0,0,0,f,0,0,0,0,d,0,_,g,p,1,o),l&&o.multiplyToRef(wa,o),o.markAsUpdated(),o}static ObliqueOffCenterLHToRef(e,t,i,r,s,a,o,l,c,u,h){const f=-o*Math.cos(l),d=-o*Math.sin(l);return O.TranslationToRef(0,0,-c,Ye.Matrix[1]),O.FromValuesToRef(1,0,0,0,0,1,0,0,f,d,1,0,0,0,0,1,Ye.Matrix[0]),Ye.Matrix[1].multiplyToRef(Ye.Matrix[0],Ye.Matrix[0]),O.TranslationToRef(0,0,c,Ye.Matrix[1]),Ye.Matrix[0].multiplyToRef(Ye.Matrix[1],Ye.Matrix[0]),O.OrthoOffCenterLHToRef(e,t,i,r,s,a,u,h),Ye.Matrix[0].multiplyToRef(u,u),u}static OrthoOffCenterRH(e,t,i,r,s,a,o){const l=new O;return O.OrthoOffCenterRHToRef(e,t,i,r,s,a,l,o),l}static OrthoOffCenterRHToRef(e,t,i,r,s,a,o,l){return O.OrthoOffCenterLHToRef(e,t,i,r,s,a,o,l),o._m[10]*=-1,o}static ObliqueOffCenterRHToRef(e,t,i,r,s,a,o,l,c,u,h){const f=o*Math.cos(l),d=o*Math.sin(l);return O.TranslationToRef(0,0,c,Ye.Matrix[1]),O.FromValuesToRef(1,0,0,0,0,1,0,0,f,d,1,0,0,0,0,1,Ye.Matrix[0]),Ye.Matrix[1].multiplyToRef(Ye.Matrix[0],Ye.Matrix[0]),O.TranslationToRef(0,0,-c,Ye.Matrix[1]),Ye.Matrix[0].multiplyToRef(Ye.Matrix[1],Ye.Matrix[0]),O.OrthoOffCenterRHToRef(e,t,i,r,s,a,u,h),Ye.Matrix[0].multiplyToRef(u,u),u}static PerspectiveLH(e,t,i,r,s,a=0){const o=new O,l=i,c=r,u=2*l/e,h=2*l/t,f=(c+l)/(c-l),d=-2*c*l/(c-l),p=Math.tan(a);return O.FromValuesToRef(u,0,0,0,0,h,0,p,0,0,f,1,0,0,d,0,o),s&&o.multiplyToRef(wa,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,r,s,a=0,o=!1){const l=new O;return O.PerspectiveFovLHToRef(e,t,i,r,l,!0,s,a,o),l}static PerspectiveFovLHToRef(e,t,i,r,s,a=!0,o,l=0,c=!1){const u=i,h=r,f=1/Math.tan(e*.5),d=a?f/t:f,p=a?f:f*t,_=c&&u===0?-1:h!==0?(h+u)/(h-u):1,g=c&&u===0?2*h:h!==0?-2*h*u/(h-u):-2*u,E=Math.tan(l);return O.FromValuesToRef(d,0,0,0,0,p,0,E,0,0,_,1,0,0,g,0,s),o&&s.multiplyToRef(wa,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,i,r,s,a=!0,o,l=0){const c=1/Math.tan(e*.5),u=a?c/t:c,h=a?c:c*t,f=Math.tan(l);return O.FromValuesToRef(u,0,0,0,0,h,0,f,0,0,-i,1,0,0,1,0,s),o&&s.multiplyToRef(wa,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,i,r,s,a=0,o=!1){const l=new O;return O.PerspectiveFovRHToRef(e,t,i,r,l,!0,s,a,o),l}static PerspectiveFovRHToRef(e,t,i,r,s,a=!0,o,l=0,c=!1){const u=i,h=r,f=1/Math.tan(e*.5),d=a?f/t:f,p=a?f:f*t,_=c&&u===0?1:h!==0?-(h+u)/(h-u):-1,g=c&&u===0?2*h:h!==0?-2*h*u/(h-u):-2*u,E=Math.tan(l);return O.FromValuesToRef(d,0,0,0,0,p,0,E,0,0,_,-1,0,0,g,0,s),o&&s.multiplyToRef(wa,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,i,r,s,a=!0,o,l=0){const c=1/Math.tan(e*.5),u=a?c/t:c,h=a?c:c*t,f=Math.tan(l);return O.FromValuesToRef(u,0,0,0,0,h,0,f,0,0,-i,-1,0,0,-1,0,s),o&&s.multiplyToRef(wa,s),s._updateIdentityStatus(!1),s}static GetFinalMatrix(e,t,i,r,s,a){const o=e.width,l=e.height,c=e.x,u=e.y,h=O.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,a-s,0,c+o/2,l/2+u,s,1),f=new O;return t.multiplyToRef(i,f),f.multiplyToRef(r,f),f.multiplyToRef(h,f)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return lr.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return lr.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new O;return O.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,r=i[0],s=i[4],a=i[8],o=i[12],l=i[1],c=i[5],u=i[9],h=i[13],f=i[2],d=i[6],p=i[10],_=i[14],g=i[3],E=i[7],v=i[11],x=i[15],A=t._m;return A[0]=r,A[1]=s,A[2]=a,A[3]=o,A[4]=l,A[5]=c,A[6]=u,A[7]=h,A[8]=f,A[9]=d,A[10]=p,A[11]=_,A[12]=g,A[13]=E,A[14]=v,A[15]=x,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new O;return O.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,r=e.normal.y,s=e.normal.z,a=-2*i,o=-2*r,l=-2*s;return O.FromValuesToRef(a*i+1,o*i,l*i,0,a*r,o*r+1,l*r,0,a*s,o*s,l*s+1,0,a*e.d,o*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,r){return O.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static FromQuaternionToRef(e,t){const i=e._x*e._x,r=e._y*e._y,s=e._z*e._z,a=e._x*e._y,o=e._z*e._w,l=e._z*e._x,c=e._y*e._w,u=e._y*e._z,h=e._x*e._w;return t._m[0]=1-2*(r+s),t._m[1]=2*(a+o),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(a-o),t._m[5]=1-2*(s+i),t._m[6]=2*(u+h),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(u-h),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}O._UpdateFlagSeed=0;O._IdentityReadOnly=O.Identity();Object.defineProperties(O.prototype,{dimension:{value:[4,4]},rank:{value:2}});class Ye{}Ye.Vector3=Ia(11,m.Zero);Ye.Matrix=Ia(2,O.Identity);Ye.Quaternion=Ia(3,ce.Zero);class B{}B.Vector2=Ia(3,se.Zero);B.Vector3=Ia(13,m.Zero);B.Vector4=Ia(3,We.Zero);B.Quaternion=Ia(3,ce.Zero);B.Matrix=Ia(8,O.Identity);$("BABYLON.Vector2",se);$("BABYLON.Vector3",m);$("BABYLON.Vector4",We);$("BABYLON.Matrix",O);const wa=O.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);var xm;(function(n){n[n.LOCAL=0]="LOCAL",n[n.WORLD=1]="WORLD",n[n.BONE=2]="BONE"})(xm||(xm={}));class ys{}ys.X=new m(1,0,0);ys.Y=new m(0,1,0);ys.Z=new m(0,0,1);var Cm;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(Cm||(Cm={}));function Bo(n){return Math.pow(n,lu)}function Vo(n){return n<=.04045?.0773993808*n:Math.pow(.947867299*(n+.055),2.4)}function Uo(n){return Math.pow(n,ou)}function ko(n){return n<=.0031308?12.92*n:1.055*Math.pow(n,.41666)-.055}class fe{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return fe.FromArrayToRef(e,t,this),this}toColor4(e=1){return new Be(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new fe(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new fe(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=pt){return Qt(this.r,e.r,t)&&Qt(this.g,e.g,t)&&Qt(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new fe(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=vt(this.r,e,t),i.g=vt(this.g,e,t),i.b=vt(this.b,e,t),i}add(e){return new fe(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new fe(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new fe(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r}clone(){return new fe(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+Vs(e)+Vs(t)+Vs(i)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,this)}toHSV(){return this.toHSVToRef(new fe)}toHSVToRef(e){const t=this.r,i=this.g,r=this.b,s=Math.max(t,i,r),a=Math.min(t,i,r);let o=0,l=0;const c=s,u=s-a;return s!==0&&(l=u/s),s!=a&&(s==t?(o=(i-r)/u,i<r&&(o+=6)):s==i?o=(r-t)/u+2:s==r&&(o=(t-i)/u+4),o*=60),e.r=o,e.g=l,e.b=c,e}toLinearSpace(e=!1){const t=new fe;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Vo(this.r),e.g=Vo(this.g),e.b=Vo(this.b)):(e.r=Bo(this.r),e.g=Bo(this.g),e.b=Bo(this.b)),this}toGammaSpace(e=!1){const t=new fe;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=ko(this.r),e.g=ko(this.g),e.b=ko(this.b)):(e.r=Uo(this.r),e.g=Uo(this.g),e.b=Uo(this.b)),this}static HSVtoRGBToRef(e,t,i,r){const s=i*t,a=e/60,o=s*(1-Math.abs(a%2-1));let l=0,c=0,u=0;a>=0&&a<=1?(l=s,c=o):a>=1&&a<=2?(l=o,c=s):a>=2&&a<=3?(c=s,u=o):a>=3&&a<=4?(c=o,u=s):a>=4&&a<=5?(l=o,u=s):a>=5&&a<=6&&(l=s,u=o);const h=i-s;return r.r=l+h,r.g=c+h,r.b=u+h,r}static FromHSV(e,t,i){const r=new fe(0,0,0);return fe.HSVtoRGBToRef(e,t,i,r),r}static FromHexString(e){return new fe(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new fe(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new fe(e/255,t/255,i/255)}static Lerp(e,t,i){const r=new fe(0,0,0);return fe.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,r,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a,f=e.r*l+i.r*c+t.r*u+r.r*h,d=e.g*l+i.g*c+t.g*u+r.g*h,p=e.b*l+i.b*c+t.b*u+r.b*h;return new fe(f,d,p)}static Hermite1stDerivative(e,t,i,r,s){const a=fe.Black();return this.Hermite1stDerivativeToRef(e,t,i,r,s,a),a}static Hermite1stDerivativeToRef(e,t,i,r,s,a){const o=s*s;a.r=(o-s)*6*e.r+(3*o-4*s+1)*t.r+(-o+s)*6*i.r+(3*o-2*s)*r.r,a.g=(o-s)*6*e.g+(3*o-4*s+1)*t.g+(-o+s)*6*i.g+(3*o-2*s)*r.g,a.b=(o-s)*6*e.b+(3*o-4*s+1)*t.b+(-o+s)*6*i.b+(3*o-2*s)*r.b}static Red(){return new fe(1,0,0)}static Green(){return new fe(0,1,0)}static Blue(){return new fe(0,0,1)}static Black(){return new fe(0,0,0)}static get BlackReadOnly(){return fe._BlackReadOnly}static White(){return new fe(1,1,1)}static Purple(){return new fe(.5,0,.5)}static Magenta(){return new fe(1,0,1)}static Yellow(){return new fe(1,1,0)}static Gray(){return new fe(.5,.5,.5)}static Teal(){return new fe(0,1,1)}static Random(){return new fe(Math.random(),Math.random(),Math.random())}}fe._BlackReadOnly=fe.Black();Object.defineProperties(fe.prototype,{dimension:{value:[3]},rank:{value:1}});class Be{constructor(e=0,t=0,i=0,r=1){this.r=e,this.g=t,this.b=i,this.a=r}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new Be(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,r){return this.r+=e,this.g+=t,this.b+=i,this.a+=r,this}subtract(e){return new Be(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,r){return new Be(this.r-e,this.g-t,this.b-i,this.a-r)}subtractFromFloatsToRef(e,t,i,r,s){return s.r=this.r-e,s.g=this.g-t,s.b=this.b-i,s.a=this.a-r,s}scale(e){return new Be(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=vt(this.r,e,t),i.g=vt(this.g,e,t),i.b=vt(this.b,e,t),i.a=vt(this.a,e,t),i}multiply(e){return new Be(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,r){return new Be(this.r*e,this.g*t,this.b*i,this.a*r)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,r){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(r,this.a),this}maximizeInPlaceFromFloats(e,t,i,r){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(r,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=pt){return Qt(this.r,e.r,t)&&Qt(this.g,e.g,t)&&Qt(this.b,e.b,t)&&Qt(this.a,e.a,t)}equalsToFloats(e,t,i,r){return this.r===e&&this.g===t&&this.b===i&&this.a===r}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new Be().copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),r=Math.round(this.b*255);if(e)return"#"+Vs(t)+Vs(i)+Vs(r);const s=Math.round(this.a*255);return"#"+Vs(t)+Vs(i)+Vs(r)+Vs(s)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,e.length===9&&(this.a=parseInt(e.substring(7,9),16)/255),this)}toLinearSpace(e=!1){const t=new Be;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Vo(this.r),e.g=Vo(this.g),e.b=Vo(this.b)):(e.r=Bo(this.r),e.g=Bo(this.g),e.b=Bo(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new Be;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=ko(this.r),e.g=ko(this.g),e.b=ko(this.b)):(e.r=Uo(this.r),e.g=Uo(this.g),e.b=Uo(this.b)),e.a=this.a,this}static FromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?new Be(0,0,0,0):new Be(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return Be.LerpToRef(e,t,i,new Be)}static LerpToRef(e,t,i,r){return r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i,r}static Hermite(e,t,i,r,s){const a=s*s,o=s*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+s,h=o-a,f=e.r*l+i.r*c+t.r*u+r.r*h,d=e.g*l+i.g*c+t.g*u+r.g*h,p=e.b*l+i.b*c+t.b*u+r.b*h,_=e.a*l+i.a*c+t.a*u+r.a*h;return new Be(f,d,p,_)}static Hermite1stDerivative(e,t,i,r,s){const a=new Be;return this.Hermite1stDerivativeToRef(e,t,i,r,s,a),a}static Hermite1stDerivativeToRef(e,t,i,r,s,a){const o=s*s;a.r=(o-s)*6*e.r+(3*o-4*s+1)*t.r+(-o+s)*6*i.r+(3*o-2*s)*r.r,a.g=(o-s)*6*e.g+(3*o-4*s+1)*t.g+(-o+s)*6*i.g+(3*o-2*s)*r.g,a.b=(o-s)*6*e.b+(3*o-4*s+1)*t.b+(-o+s)*6*i.b+(3*o-2*s)*r.b,a.a=(o-s)*6*e.a+(3*o-4*s+1)*t.a+(-o+s)*6*i.a+(3*o-2*s)*r.a}static FromColor3(e,t=1){return new Be(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new Be(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,r){return new Be(e/255,t/255,i/255,r/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let r=0;r<e.length;r+=3){const s=r/3*4;i[s]=e[r],i[s+1]=e[r+1],i[s+2]=e[r+2],i[s+3]=1}return i}return e}}Object.defineProperties(Be.prototype,{dimension:{value:[4]},rank:{value:1}});class Ot{}Ot.Color3=ms(3,fe.Black);Ot.Color4=ms(3,()=>new Be(0,0,0,0));$("BABYLON.Color3",fe);$("BABYLON.Color4",Be);class Vr{constructor(e,t,i,r){this.normal=new m(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Vr(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Vr._TmpMatrix;e.invertToRef(t);const i=t.m,r=this.normal.x,s=this.normal.y,a=this.normal.z,o=this.d,l=r*i[0]+s*i[1]+a*i[2]+o*i[3],c=r*i[4]+s*i[5]+a*i[6]+o*i[7],u=r*i[8]+s*i[9]+a*i[10]+o*i[11],h=r*i[12]+s*i[13]+a*i[14]+o*i[15];return new Vr(l,c,u,h)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const r=t.x-e.x,s=t.y-e.y,a=t.z-e.z,o=i.x-e.x,l=i.y-e.y,c=i.z-e.z,u=s*c-a*l,h=a*o-r*c,f=r*l-s*o,d=Math.sqrt(u*u+h*h+f*f);let p;return d!==0?p=1/d:p=0,this.normal.x=u*p,this.normal.y=h*p,this.normal.z=f*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return m.Dot(this.normal,e)<=t}signedDistanceTo(e){return m.Dot(e,this.normal)+this.d}static FromArray(e){return new Vr(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const r=new Vr(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){const i=new Vr(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return m.Dot(i,t)+r}}Vr._TmpMatrix=O.Identity();class Ts{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Vr(0,0,0,0));return Ts.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Ts.GetNearPlaneToRef(e,t[0]),Ts.GetFarPlaneToRef(e,t[1]),Ts.GetLeftPlaneToRef(e,t[2]),Ts.GetRightPlaneToRef(e,t[3]),Ts.GetTopPlaneToRef(e,t[4]),Ts.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}var Am;(function(n){n[n.CW=0]="CW",n[n.CCW=1]="CCW"})(Am||(Am={}));class nn{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),r=Math.atan2(i.y,i.x);return new nn(r)}static BetweenTwoVectors(e,t){let i=e.lengthSquared()*t.lengthSquared();if(i===0)return new nn(Math.PI/2);i=Math.sqrt(i);let r=e.dot(t)/i;r=vt(r,-1,1);const s=Math.acos(r);return new nn(s)}static FromRadians(e){return new nn(e)}static FromDegrees(e){return new nn(e*Math.PI/180)}}class pD{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const r=Math.pow(t.x,2)+Math.pow(t.y,2),s=(Math.pow(e.x,2)+Math.pow(e.y,2)-r)/2,a=(r-Math.pow(i.x,2)-Math.pow(i.y,2))/2,o=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new se((s*(t.y-i.y)-a*(e.y-t.y))/o,((e.x-t.x)*a-(t.x-i.x)*s)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=nn.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let c=nn.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),u=nn.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-l>180&&(c-=360),c-l<-180&&(c+=360),u-c>180&&(u-=360),u-c<-180&&(u+=360),this.orientation=c-l<0?0:1,this.angle=nn.FromDegrees(this.orientation===0?l-u:u-l)}}class Ju{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new se(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new se(e,t),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this}addArcTo(e,t,i,r,s=36){if(this.closed)return this;const a=this._points[this._points.length-1],o=new se(e,t),l=new se(i,r),c=new pD(a,o,l);let u=c.angle.radians()/s;c.orientation===0&&(u*=-1);let h=c.startAngle.radians()+u;for(let f=0;f<s;f++){const d=Math.cos(h)*c.radius+c.centerPoint.x,p=Math.sin(h)*c.radius+c.centerPoint.y;this.addLineTo(d,p),h+=u}return this}addQuadraticCurveTo(e,t,i,r,s=36){if(this.closed)return this;const a=(l,c,u,h)=>(1-l)*(1-l)*c+2*l*(1-l)*u+l*l*h,o=this._points[this._points.length-1];for(let l=0;l<=s;l++){const c=l/s,u=a(c,o.x,e,i),h=a(c,o.y,t,r);this.addLineTo(u,h)}return this}addBezierCurveTo(e,t,i,r,s,a,o=36){if(this.closed)return this;const l=(u,h,f,d,p)=>(1-u)*(1-u)*(1-u)*h+3*u*(1-u)*(1-u)*f+3*u*u*(1-u)*d+u*u*u*p,c=this._points[this._points.length-1];for(let u=0;u<=o;u++){const h=u/o,f=l(h,c.x,e,i,s),d=l(h,c.y,t,r,a);this.addLineTo(f,d)}return this}isPointInside(e){let t=!1;const i=this._points.length;for(let r=i-1,s=0;s<i;r=s++){let a=this._points[r],o=this._points[s],l=o.x-a.x,c=o.y-a.y;if(Math.abs(c)>Number.EPSILON){if(c<0&&(a=this._points[s],l=-l,o=this._points[r],c=-c),e.y<a.y||e.y>o.y)continue;if(e.y===a.y&&e.x===a.x)return!0;{const u=c*(e.x-a.x)-l*(e.y-a.y);if(u===0)return!0;if(u<0)continue;t=!t}}else{if(e.y!==a.y)continue;if(o.x<=e.x&&e.x<=a.x||a.x<=e.x&&e.x<=o.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const t=this._points[this._points.length-1],i=this._points[0];e+=i.subtract(t).length()}return e}area(){const e=this._points.length;let t=0;for(let i=e-1,r=0;r<e;i=r++)t+=this._points[i].x*this._points[r].y-this._points[r].x*this._points[i].y;return t*.5}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return se.Zero();const t=e*this.length();let i=0;for(let r=0;r<this._points.length;r++){const s=(r+1)%this._points.length,a=this._points[r],l=this._points[s].subtract(a),c=l.length()+i;if(t>=i&&t<=c){const u=l.normalize(),h=t-i;return new se(a.x+u.x*h,a.y+u.y*h)}i=c}return se.Zero()}static StartingAt(e,t){return new Ju(e,t)}}class ic{constructor(e,t=null,i,r=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:m.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:O.Identity()};for(let s=0;s<e.length;s++)this._curve[s]=e[s].clone();this._raw=i||!1,this._alignTangentsWithPath=r,this._compute(t,r)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?m.TransformCoordinates(m.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?m.TransformCoordinates(m.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?m.TransformCoordinates(m.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let r=0;r<this._curve.length-1;r++){const s=this._curve[r+0],a=this._curve[r+1].subtract(s).normalize(),o=this._distances[r+1]-this._distances[r+0],l=Math.min(Math.max(m.Dot(a,e.subtract(s).normalize()),0)*m.Distance(s,e)/o,1),c=m.Distance(s.add(a.scale(l*o)),e);c<t&&(t=c,i=(this._distances[r+0]+o*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){const c=e;e=t,t=c}const i=this.getCurve(),r=this.getPointAt(e);let s=this.getPreviousPointIndexAt(e);const a=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(s++,l.push(r)),l.push(...i.slice(s,o)),(t!==1||e===1)&&l.push(a),new ic(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const r=this._tangents[0],s=this._normalVector(r,e);this._normals[0]=s,this._raw||this._normals[0].normalize(),this._binormals[0]=m.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let a,o,l,c,u;for(let h=1;h<i;h++)a=this._getLastNonNullVector(h),h<i-1&&(o=this._getFirstNonNullVector(h),this._tangents[h]=t?o:a.add(o),this._tangents[h].normalize()),this._distances[h]=this._distances[h-1]+this._curve[h].subtract(this._curve[h-1]).length(),l=this._tangents[h],u=this._binormals[h-1],this._normals[h]=m.Cross(u,l),this._raw||(this._normals[h].length()===0?(c=this._normals[h-1],this._normals[h]=c.clone()):this._normals[h].normalize()),this._binormals[h]=m.Cross(l,this._normals[h]),this._raw||this._binormals[h].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,r=e.length();if(r===0&&(r=1),t==null){let s;Qt(Math.abs(e.y)/r,1,pt)?Qt(Math.abs(e.x)/r,1,pt)?Qt(Math.abs(e.z)/r,1,pt)?s=m.Zero():s=new m(0,0,1):s=new m(1,0,0):s=new m(0,-1,0),i=m.Cross(e,s)}else i=m.Cross(e,t),m.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let r=i[0],s,a=0;const o=e*this.length();for(let l=1;l<i.length;l++){s=i[l];const c=m.Distance(r,s);if(a+=c,a===o)return this._setPointAtData(e,1,s,l,t);if(a>o){const h=(a-o)/c,f=r.subtract(s),d=s.add(f.scaleInPlace(h));return this._setPointAtData(e,1-h,d,l-1,t)}r=s}return this._pointAtData}_setPointAtData(e,t,i,r,s){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=r,this._pointAtData.interpolateReady=s,s&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=O.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),r=this._normals[e].clone(),s=this._binormals[e].clone(),a=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),c=ce.RotationQuaternionFromAxis(r,s,i),u=ce.RotationQuaternionFromAxis(o,l,a);ce.Slerp(c,u,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class Nn{static CreateQuadraticBezier(e,t,i,r){r=r>2?r:3;const s=[],a=(o,l,c,u)=>(1-o)*(1-o)*l+2*o*(1-o)*c+o*o*u;for(let o=0;o<=r;o++)s.push(new m(a(o/r,e.x,t.x,i.x),a(o/r,e.y,t.y,i.y),a(o/r,e.z,t.z,i.z)));return new Nn(s)}static CreateCubicBezier(e,t,i,r,s){s=s>3?s:4;const a=[],o=(l,c,u,h,f)=>(1-l)*(1-l)*(1-l)*c+3*l*(1-l)*(1-l)*u+3*l*l*(1-l)*h+l*l*l*f;for(let l=0;l<=s;l++)a.push(new m(o(l/s,e.x,t.x,i.x,r.x),o(l/s,e.y,t.y,i.y,r.y),o(l/s,e.z,t.z,i.z,r.z)));return new Nn(a)}static CreateHermiteSpline(e,t,i,r,s){const a=[],o=1/s;for(let l=0;l<=s;l++)a.push(m.Hermite(e,t,i,r,l*o));return new Nn(a)}static CreateCatmullRomSpline(e,t,i){const r=[],s=1/t;let a=0;if(i){const o=e.length;for(let l=0;l<o;l++){a=0;for(let c=0;c<t;c++)r.push(m.CatmullRom(e[l%o],e[(l+1)%o],e[(l+2)%o],e[(l+3)%o],a)),a+=s}r.push(r[0])}else{const o=[];o.push(e[0].clone()),Array.prototype.push.apply(o,e),o.push(e[e.length-1].clone());let l=0;for(;l<o.length-3;l++){a=0;for(let c=0;c<t;c++)r.push(m.CatmullRom(o[l],o[l+1],o[l+2],o[l+3],a)),a+=s}l--,r.push(m.CatmullRom(o[l],o[l+1],o[l+2],o[l+3],a))}return new Nn(r)}static ArcThru3Points(e,t,i,r=32,s=!1,a=!1){const o=[],l=t.subtract(e),c=i.subtract(t),u=e.subtract(i),h=m.Cross(l,c),f=h.length();if(f<Math.pow(10,-8))return new Nn(o);const d=l.lengthSquared(),p=c.lengthSquared(),_=u.lengthSquared(),g=h.lengthSquared(),E=l.length(),v=c.length(),x=u.length(),A=.5*E*v*x/f,T=m.Dot(l,u),C=m.Dot(l,c),y=m.Dot(c,u),P=-.5*p*T/g,D=-.5*_*C/g,F=-.5*d*y/g,W=e.scale(P).add(t.scale(D)).add(i.scale(F)),ue=e.subtract(W).normalize(),ae=m.Cross(h,ue).normalize();if(a){const le=2*Math.PI/r;for(let oe=0;oe<=2*Math.PI;oe+=le)o.push(W.add(ue.scale(A*Math.cos(oe)).add(ae.scale(A*Math.sin(oe)))));o.push(e)}else{const le=1/r;let oe=0,ge=m.Zero();do ge=W.add(ue.scale(A*Math.cos(oe)).add(ae.scale(A*Math.sin(oe)))),o.push(ge),oe+=le;while(!ge.equalsWithEpsilon(i,A*le*1.1));o.push(i),s&&o.push(e)}return new Nn(o)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),r=e.getPoints();for(let a=1;a<r.length;a++)i.push(r[a].subtract(r[0]).add(t));return new Nn(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}class xs{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new xs(this.width*e,this.height*t)}clone(){return new xs(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new xs(0,0)}add(e){return new xs(this.width+e.width,this.height+e.height)}subtract(e){return new xs(this.width-e.width,this.height-e.height)}scale(e){return new xs(this.width*e,this.height*e)}static Lerp(e,t,i){const r=e.width+(t.width-e.width)*i,s=e.height+(t.height-e.height)*i;return new xs(r,s)}}class Hn{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new Hn(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Hn(this.x,this.y,this.width,this.height)}}const js=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],_D=[()=>1,n=>n.y,n=>n.z,n=>n.x,n=>n.x*n.y,n=>n.y*n.z,n=>3*n.z*n.z-1,n=>n.x*n.z,n=>n.x*n.x-n.y*n.y],Rn=(n,e)=>js[n]*_D[n](e),Pn=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class rc{constructor(){this.preScaled=!1,this.l00=m.Zero(),this.l1_1=m.Zero(),this.l10=m.Zero(),this.l11=m.Zero(),this.l2_2=m.Zero(),this.l2_1=m.Zero(),this.l20=m.Zero(),this.l21=m.Zero(),this.l22=m.Zero()}addLight(e,t,i){B.Vector3[0].set(t.r,t.g,t.b);const r=B.Vector3[0],s=B.Vector3[1];r.scaleToRef(i,s),s.scaleToRef(Rn(0,e),B.Vector3[2]),this.l00.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(1,e),B.Vector3[2]),this.l1_1.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(2,e),B.Vector3[2]),this.l10.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(3,e),B.Vector3[2]),this.l11.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(4,e),B.Vector3[2]),this.l2_2.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(5,e),B.Vector3[2]),this.l2_1.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(6,e),B.Vector3[2]),this.l20.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(7,e),B.Vector3[2]),this.l21.addInPlace(B.Vector3[2]),s.scaleToRef(Rn(8,e),B.Vector3[2]),this.l22.addInPlace(B.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(Pn[0]),this.l1_1.scaleInPlace(Pn[1]),this.l10.scaleInPlace(Pn[2]),this.l11.scaleInPlace(Pn[3]),this.l2_2.scaleInPlace(Pn[4]),this.l2_1.scaleInPlace(Pn[5]),this.l20.scaleInPlace(Pn[6]),this.l21.scaleInPlace(Pn[7]),this.l22.scaleInPlace(Pn[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(js[0]),this.l1_1.scaleInPlace(js[1]),this.l10.scaleInPlace(js[2]),this.l11.scaleInPlace(js[3]),this.l2_2.scaleInPlace(js[4]),this.l2_1.scaleInPlace(js[5]),this.l20.scaleInPlace(js[6]),this.l21.scaleInPlace(js[7]),this.l22.scaleInPlace(js[8])}updateFromArray(e){return m.FromArrayToRef(e[0],0,this.l00),m.FromArrayToRef(e[1],0,this.l1_1),m.FromArrayToRef(e[2],0,this.l10),m.FromArrayToRef(e[3],0,this.l11),m.FromArrayToRef(e[4],0,this.l2_2),m.FromArrayToRef(e[5],0,this.l2_1),m.FromArrayToRef(e[6],0,this.l20),m.FromArrayToRef(e[7],0,this.l21),m.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return m.FromFloatsToRef(e[0],e[1],e[2],this.l00),m.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),m.FromFloatsToRef(e[6],e[7],e[8],this.l10),m.FromFloatsToRef(e[9],e[10],e[11],this.l11),m.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),m.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),m.FromFloatsToRef(e[18],e[19],e[20],this.l20),m.FromFloatsToRef(e[21],e[22],e[23],this.l21),m.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new rc().updateFromArray(e)}static FromPolynomial(e){const t=new rc;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class eo{constructor(){this.x=m.Zero(),this.y=m.Zero(),this.z=m.Zero(),this.xx=m.Zero(),this.yy=m.Zero(),this.zz=m.Zero(),this.xy=m.Zero(),this.yz=m.Zero(),this.zx=m.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=rc.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){B.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=B.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),B.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),B.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(B.Vector3[0]).addInPlace(B.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(B.Vector3[0]).subtractInPlace(B.Vector3[1]),this.zz.copyFrom(e.l00),B.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(B.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new eo().updateFromHarmonics(e)}static FromArray(e){const t=new eo;return m.FromArrayToRef(e[0],0,t.x),m.FromArrayToRef(e[1],0,t.y),m.FromArrayToRef(e[2],0,t.z),m.FromArrayToRef(e[3],0,t.xx),m.FromArrayToRef(e[4],0,t.yy),m.FromArrayToRef(e[5],0,t.zz),m.FromArrayToRef(e[6],0,t.yz),m.FromArrayToRef(e[7],0,t.zx),m.FromArrayToRef(e[8],0,t.xy),t}}function I(n,e,t,i){var r=arguments.length,s=r<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,i);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(s=(r<3?a(s):r>3?a(e,t,s):a(e,t))||s);return r>3&&s&&Object.defineProperty(e,t,s),s}const Xc={},cu={};function mD(n){const e=n.getClassName();return cu[e]||(cu[e]={}),cu[e]}function rd(n){const e=n.getClassName();if(Xc[e])return Xc[e];Xc[e]={};const t=Xc[e];let i=n,r=e;for(;r;){const s=cu[r];for(const l in s)t[l]=s[l];let a,o=!1;do{if(a=Object.getPrototypeOf(i),!a.getClassName){o=!0;break}if(a.getClassName()!==r)break;i=a}while(a);if(o)break;r=a.getClassName(),i=a}return t}function Ns(n,e){return(t,i)=>{const r=mD(t);r[i]||(r[i]={type:n,sourceName:e})}}function gD(n,e=null){return(t,i)=>{const r=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[r]},set:function(s){typeof this.equals=="function"&&this.equals(s)||this[r]!==s&&(this[r]=s,t[n].apply(this))},enumerable:!0,configurable:!0})}}function ie(n,e=null){return gD(n,e)}function M(n){return Ns(0,n)}function Rt(n){return Ns(1,n)}function hi(n){return Ns(2,n)}function gc(n){return Ns(3,n)}function np(n){return Ns(4,n)}function Ar(n){return Ns(5,n)}function eh(n){return Ns(6,n)}function ED(n){return Ns(7,n)}function rT(n){return Ns(8,n)}function sT(n){return Ns(9,n)}function vD(n){return Ns(10,n)}function nT(n){return Ns(12,n)}function Xn(n,e,t,i){const r=t.value;t.value=(...s)=>{let a=r;if(typeof _native<"u"&&_native[e]){const o=_native[e];i?a=(...l)=>i(...l)?o(...l):r(...l):a=o}return n[e]=a,a(...s)}}Xn.filter=function(n){return(e,t,i)=>Xn(e,t,i,n)};function th(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function SD(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class Gi{constructor(){this._xhr=SD(),this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(Gi.CustomRequestHeaders).length>0||Gi.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Gi.CustomRequestHeaders){const t=Gi.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Gi.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Gi.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of Gi.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Gi.CustomRequestHeaders={};Gi.CustomRequestModifiers=new Array;Gi.SkipRequestModificationForBabylonCDN=!0;class Gl{}Gl.FilesToLoad={};class TD{static ExponentialBackoff(e=3,t=500){return(i,r,s)=>r.status!==0||s>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,s)*t}}class jo extends Error{}jo._setPrototypeOf=Object.setPrototypeOf||((n,e)=>(n.__proto__=e,n));const ya={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class vn extends jo{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",jo._setPrototypeOf(this,vn.prototype)}}const M5=n=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(n);let e="";for(let t=0;t<n.byteLength;t++)e+=String.fromCharCode(n[t]);return e},aT=n=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,r,s,a,o,l,c,u=0;const h=ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n);for(;u<h.length;)i=h[u++],r=u<h.length?h[u++]:Number.NaN,s=u<h.length?h[u++]:Number.NaN,a=i>>2,o=(i&3)<<4|r>>4,l=(r&15)<<2|s>>6,c=s&63,isNaN(r)?l=c=64:isNaN(s)&&(c=64),t+=e.charAt(a)+e.charAt(o)+e.charAt(l)+e.charAt(c);return t},oT=n=>atob(n),xD=n=>{const e=oT(n),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i.buffer};class qo{static SetImmediate(e){Yi()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const lT=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class bu extends vn{constructor(e,t){super(e,ya.LoadFileError),this.name="LoadFileError",jo._setPrototypeOf(this,bu.prototype),t instanceof Gi?this.request=t:this.file=t}}class Ru extends vn{constructor(e,t){super(e,ya.RequestFileError),this.request=t,this.name="RequestFileError",jo._setPrototypeOf(this,Ru.prototype)}}class ap extends vn{constructor(e,t){super(e,ya.ReadFileError),this.file=t,this.name="ReadFileError",jo._setPrototypeOf(this,ap.prototype)}}const CD=n=>(n=n.replace(/#/gm,"%23"),n),Pi={DefaultRetryStrategy:TD.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:n=>n,ScriptBaseUrl:"",ScriptPreprocessUrl:n=>n,CleanUrl:CD},op=(n,e)=>{if(!(n&&n.indexOf("data:")===0)&&Pi.CorsBehavior)if(typeof Pi.CorsBehavior=="string"||Pi.CorsBehavior instanceof String)e.crossOrigin=Pi.CorsBehavior;else{const t=Pi.CorsBehavior(n);t&&(e.crossOrigin=t)}},Ec=(n,e,t,i,r="",s)=>{const a=$e.LastCreatedEngine;if(typeof HTMLImageElement>"u"&&!(a!=null&&a._features.forceBitmapOverHTMLImageElement))return t("LoadImage is only supported in web or BabylonNative environments."),null;let o,l=!1;n instanceof ArrayBuffer||ArrayBuffer.isView(n)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([n],{type:r})),l=!0):o=`data:${r};base64,`+aT(n):n instanceof Blob?(o=URL.createObjectURL(n),l=!0):(o=Pi.CleanUrl(n),o=Pi.PreprocessUrl(o));const c=T=>{if(t){const C=o||n.toString();t(`Error while trying to load image: ${C.indexOf("http")===0||C.length<=128?C:C.slice(0,128)+"..."}`,T)}};if(a!=null&&a._features.forceBitmapOverHTMLImageElement)return Ea(o,T=>{a.createImageBitmap(new Blob([T],{type:r}),{premultiplyAlpha:"none",...s}).then(C=>{e(C),l&&URL.revokeObjectURL(o)}).catch(C=>{t&&t("Error while trying to load image: "+n,C)})},void 0,i||void 0,!0,(T,C)=>{c(C)}),null;const u=new Image;op(o,u);const h=[],f=()=>{h.forEach(T=>{T.target.addEventListener(T.name,T.handler)})},d=()=>{h.forEach(T=>{T.target.removeEventListener(T.name,T.handler)}),h.length=0},p=()=>{d(),e(u),l&&u.src&&URL.revokeObjectURL(u.src)},_=T=>{d(),c(T),l&&u.src&&URL.revokeObjectURL(u.src)},g=T=>{if(T.blockedURI!==u.src||T.disposition==="report")return;d();const C=new Error(`CSP violation of policy ${T.effectiveDirective} ${T.blockedURI}. Current policy is ${T.originalPolicy}`);$e.UseFallbackTexture=!1,c(C),l&&u.src&&URL.revokeObjectURL(u.src),u.src=""};h.push({target:u,name:"load",handler:p}),h.push({target:u,name:"error",handler:_}),h.push({target:document,name:"securitypolicyviolation",handler:g}),f();const E=o.substring(0,5)==="blob:",v=o.substring(0,5)==="data:",x=()=>{E||v||!Gi.IsCustomRequestAvailable?u.src=o:Ea(o,(T,C,y)=>{const P=!r&&y?y:r,D=new Blob([T],{type:P}),F=URL.createObjectURL(D);l=!0,u.src=F},void 0,i||void 0,!0,(T,C)=>{c(C)})},A=()=>{i&&i.loadImage(o,u)};if(!E&&!v&&i&&i.enableTexturesOffline)i.open(A,x);else{if(o.indexOf("file:")!==-1){const T=decodeURIComponent(o.substring(5).toLowerCase());if(Gl.FilesToLoad[T]&&typeof URL<"u"){try{let C;try{C=URL.createObjectURL(Gl.FilesToLoad[T])}catch{C=URL.createObjectURL(Gl.FilesToLoad[T])}u.src=C,l=!0}catch{u.src=""}return u}}x()}return u},sc=(n,e,t,i,r)=>{const s=new FileReader,a={onCompleteObservable:new Q,abort:()=>s.abort()};return s.onloadend=()=>a.onCompleteObservable.notifyObservers(a),r&&(s.onerror=()=>{r(new ap(`Unable to read ${n.name}`,n))}),s.onload=o=>{e(o.target.result)},t&&(s.onprogress=t),i?s.readAsArrayBuffer(n):s.readAsText(n),a},Ea=(n,e,t,i,r,s,a)=>{if(n.name)return sc(n,e,t,r,s?u=>{s(void 0,u)}:void 0);const o=n;if(o.indexOf("file:")!==-1){let u=decodeURIComponent(o.substring(5).toLowerCase());u.indexOf("./")===0&&(u=u.substring(2));const h=Gl.FilesToLoad[u];if(h)return sc(h,e,t,r,s?f=>s(void 0,new bu(f.message,f.file)):void 0)}const{match:l,type:c}=AD(o);if(l){const u={onCompleteObservable:new Q,abort:()=>()=>{}};try{const h=r?up(o):uT(o);e(h,void 0,c)}catch(h){s?s(void 0,h):w.Error(h.message||"Failed to parse the Data URL")}return qo.SetImmediate(()=>{u.onCompleteObservable.notifyObservers(u)}),u}return lp(o,(u,h)=>{e(u,h==null?void 0:h.responseURL,h==null?void 0:h.getResponseHeader("content-type"))},t,i,r,s?u=>{s(u.request,new bu(u.message,u.request))}:void 0,a)},lp=(n,e,t,i,r,s,a)=>{n=Pi.CleanUrl(n),n=Pi.PreprocessUrl(n);const o=Pi.BaseUrl+n;let l=!1;const c={onCompleteObservable:new Q,abort:()=>l=!0},u=()=>{let h=new Gi,f=null,d;const p=()=>{h&&(t&&h.removeEventListener("progress",t),d&&h.removeEventListener("readystatechange",d),h.removeEventListener("loadend",_))};let _=()=>{p(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,d=null,_=null,s=void 0,a=void 0,e=void 0};c.abort=()=>{l=!0,_&&_(),h&&h.readyState!==(XMLHttpRequest.DONE||4)&&h.abort(),f!==null&&(clearTimeout(f),f=null),h=null};const g=v=>{const x=v.message||"Unknown error";s&&h?s(new Ru(x,h)):w.Error(x)},E=v=>{if(h){if(h.open("GET",o),a)try{a(h)}catch(x){g(x);return}r&&(h.responseType="arraybuffer"),t&&h.addEventListener("progress",t),_&&h.addEventListener("loadend",_),d=()=>{if(!(l||!h)&&h.readyState===(XMLHttpRequest.DONE||4)){if(d&&h.removeEventListener("readystatechange",d),h.status>=200&&h.status<300||h.status===0&&(!Yi()||cT())){try{e&&e(r?h.response:h.responseText,h)}catch(T){g(T)}return}const x=Pi.DefaultRetryStrategy;if(x){const T=x(o,h,v);if(T!==-1){p(),h=new Gi,f=setTimeout(()=>E(v+1),T);return}}const A=new Ru("Error status: "+h.status+" "+h.statusText+" - Unable to load "+o,h);s&&s(A)}},h.addEventListener("readystatechange",d),h.send()}};E(0)};if(i&&i.enableSceneOffline){const h=d=>{d&&d.status>400?s&&s(d):u()},f=()=>{i&&i.loadFile(Pi.BaseUrl+n,d=>{!l&&e&&e(d),c.onCompleteObservable.notifyObservers(c)},t?d=>{!l&&t&&t(d)}:void 0,h,r)};i.open(f,h)}else u();return c},cT=()=>typeof location<"u"&&location.protocol==="file:",cp=n=>lT.test(n),AD=n=>{const e=lT.exec(n);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function up(n){return xD(n.split(",")[1])}const uT=n=>oT(n.split(",")[1]),ID=()=>{q._FileToolsLoadImage=Ec,Cu.loadFile=Ea,VS.loadFile=Ea};ID();let Il;const yD=(n,e,t,i,r,s,a,o,l,c)=>{Il={DecodeBase64UrlToBinary:n,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:r,LoadFile:s,LoadImage:a,ReadFile:o,RequestFile:l,SetCorsBehavior:c},Object.defineProperty(Il,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(u){t.DefaultRetryStrategy=u}}),Object.defineProperty(Il,"BaseUrl",{get:function(){return t.BaseUrl},set:function(u){t.BaseUrl=u}}),Object.defineProperty(Il,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(u){t.PreprocessUrl=u}}),Object.defineProperty(Il,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(u){t.CorsBehavior=u}})};yD(up,uT,Pi,cp,cT,Ea,Ec,sc,lp,op);class hp{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return(e==null?void 0:e.shareDepth)!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=xs.Zero(),this._cachedBaseSize=xs.Zero(),this._initialSamplingMode=2,this._texture=hp._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class Ua{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),Ua._HandleParenthesisContent(i,t))):e=Ua._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:Ua.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(s=>s==="true");let i;const r=e.split("||");for(const s in r)if(Object.prototype.hasOwnProperty.call(r,s)){let a=Ua._SimplifyNegation(r[s].trim());const o=a.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){const c=Ua._SimplifyNegation(o[l].trim());if(c!=="true"&&c!=="false"?c[0]==="!"?i=!t(c.substring(1)):i=t(c):i=c==="true",!i){a="false";break}}if(i||a==="true"){i=!0;break}a!=="true"&&a!=="false"?a[0]==="!"?i=!t(a.substring(1)):i=t(a):i=a==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class Pt{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Pt.HasTags(e),e.addTags=t=>Pt.AddTagsTo(e,t),e.removeTags=t=>Pt.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>Pt.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const r in e._tags)Object.prototype.hasOwnProperty.call(e._tags,r)&&e._tags[r]===!0&&i.push(r);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(r){Pt._AddTagTo(e,r)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(Pt.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!Pt.HasTags(e))return;const i=t.split(" ");for(const r in i)Pt._RemoveTagFrom(e,i[r])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?Pt.HasTags(e):Ua.Eval(t,i=>Pt.HasTags(e)&&e._tags[i])}}const Im=function(n,e,t,i={}){const r=n();Pt&&Pt.HasTags(e)&&Pt.AddTagsTo(r,Pt.GetTags(e,!0));const s=rd(r),a={};for(const o in s){const l=s[o],c=e[o],u=l.type;if(c!=null&&(o!=="uniqueId"||Ke.AllowLoadingUniqueId))switch(u){case 0:case 6:case 11:r[o]=c;break;case 1:i.cloneTexturesOnlyOnce&&a[c.uniqueId]?r[o]=a[c.uniqueId]:(r[o]=t||c.isRenderTarget?c:c.clone(),a[c.uniqueId]=r[o]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:r[o]=t?c:c.clone();break}}return r};class Ke{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),Pt&&(t.tags=Pt.GetTags(e));const i=rd(e);for(const r in i){const s=i[r],a=s.sourceName||r,o=s.type,l=e[r];if(l!=null&&(r!=="uniqueId"||Ke.AllowLoadingUniqueId))switch(o){case 0:t[a]=l;break;case 1:t[a]=l.serialize();break;case 2:t[a]=l.asArray();break;case 3:t[a]=l.serialize();break;case 4:t[a]=l.asArray();break;case 5:t[a]=l.asArray();break;case 6:t[a]=l.id;break;case 7:t[a]=l.serialize();break;case 8:t[a]=l.asArray();break;case 9:t[a]=l.serialize();break;case 10:t[a]=l.asArray();break;case 11:t[a]=l.id;break;case 12:t[a]=l.asArray();break}}return t}static ParseProperties(e,t,i,r){r||(r="");const s=rd(t);for(const a in s){const o=s[a],l=e[o.sourceName||a],c=o.type;if(l!=null&&(a!=="uniqueId"||Ke.AllowLoadingUniqueId)){const u=t;switch(c){case 0:u[a]=l;break;case 1:i&&(u[a]=Ke._TextureParser(l,i,r));break;case 2:u[a]=fe.FromArray(l);break;case 3:u[a]=Ke._FresnelParametersParser(l);break;case 4:u[a]=se.FromArray(l);break;case 5:u[a]=m.FromArray(l);break;case 6:i&&(u[a]=i.getLastMeshById(l));break;case 7:u[a]=Ke._ColorCurvesParser(l);break;case 8:u[a]=Be.FromArray(l);break;case 9:u[a]=Ke._ImageProcessingConfigurationParser(l);break;case 10:u[a]=ce.FromArray(l);break;case 11:i&&(u[a]=i.getCameraById(l));break;case 12:u[a]=O.FromArray(l);break}}}}static Parse(e,t,i,r=null){const s=e();return Pt&&Pt.AddTagsTo(s,t.tags),Ke.ParseProperties(t,s,i,r),s}static Clone(e,t,i={}){return Im(e,t,!1,i)}static Instanciate(e,t){return Im(e,t,!0)}}Ke.AllowLoadingUniqueId=!1;Ke._ImageProcessingConfigurationParser=n=>{throw rt("ImageProcessingConfiguration")};Ke._FresnelParametersParser=n=>{throw rt("FresnelParameters")};Ke._ColorCurvesParser=n=>{throw rt("ColorCurves")};Ke._TextureParser=(n,e,t)=>{throw rt("Texture")};class jt extends hp{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){var t;if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}(t=this.getScene())==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this))}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){var t;e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),(t=this.getScene())==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=th()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=jt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new Q,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?jt._IsScene(e)?this._scene=e:this._engine=e:this._scene=$e.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return O.IdentityReadOnly}getReflectionTextureMatrix(){return O.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,s,a){const o=this._getEngine();if(!o)return null;const l=o._getUseSRGBBuffer(!!s,t),c=o.getLoadedTexturesCache();for(let u=0;u<c.length;u++){const h=c[u];if((s===void 0||l===h._useSRGBBuffer)&&(r===void 0||r===h.invertY)&&h.url===e&&h.generateMipMaps===!t&&(!i||i===h.samplingMode)&&(a===void 0||a===h.isCube))return h.incrementReferences(),h}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,s=!1,a=0,o=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;const u=this._getEngine();if(!u)return null;const h=this.getSize();let f=h.width,d=h.height;t!==0&&(f=f/Math.pow(2,t),d=d/Math.pow(2,t),f=Math.round(f),d=Math.round(d)),l=Math.min(f,l),c=Math.min(d,c);try{return this._texture.isCube?u._readTexturePixels(this._texture,l,c,e,t,i,r,s,a,o):u._readTexturePixels(this._texture,l,c,-1,t,i,r,s,a,o)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,s=!1){if(!this._texture)return null;const a=this.getSize();let o=a.width,l=a.height;const c=this._getEngine();if(!c)return null;t!=0&&(o=o/Math.pow(2,t),l=l/Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,o,l,e,t,i,r,s):c._readTexturePixelsSync(this._texture,o,l,-1,t,i,r,s)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=Ke.Serialize(this);return Ke.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let r=0;r<e.length;r++){const s=e[r];if(s.isReady())--i===0&&t();else{const a=s.onLoadObservable;a?a.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}jt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;I([M()],jt.prototype,"uniqueId",void 0);I([M()],jt.prototype,"name",void 0);I([M()],jt.prototype,"metadata",void 0);I([M("hasAlpha")],jt.prototype,"_hasAlpha",void 0);I([M("getAlphaFromRGB")],jt.prototype,"_getAlphaFromRGB",void 0);I([M()],jt.prototype,"level",void 0);I([M("coordinatesIndex")],jt.prototype,"_coordinatesIndex",void 0);I([M()],jt.prototype,"optimizeUVAllocation",void 0);I([M("coordinatesMode")],jt.prototype,"_coordinatesMode",void 0);I([M()],jt.prototype,"wrapU",null);I([M()],jt.prototype,"wrapV",null);I([M()],jt.prototype,"wrapR",void 0);I([M()],jt.prototype,"anisotropicFilteringLevel",void 0);I([M()],jt.prototype,"isCube",null);I([M()],jt.prototype,"is3D",null);I([M()],jt.prototype,"is2DArray",null);I([M()],jt.prototype,"gammaSpace",null);I([M()],jt.prototype,"invertZ",void 0);I([M()],jt.prototype,"lodLevelInAlpha",void 0);I([M()],jt.prototype,"lodGenerationOffset",null);I([M()],jt.prototype,"lodGenerationScale",null);I([M()],jt.prototype,"linearSpecularLOD",null);I([Rt()],jt.prototype,"irradianceTexture",null);I([M()],jt.prototype,"isRenderTarget",void 0);class go{constructor(e,t,i,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=r}}class ol{static ConvertCubeMapTextureToSphericalPolynomial(e){var f;if(!e.isCube)return null;(f=e.getScene())==null||f.getEngine().flushFramebuffer();const t=e.getSize().width,i=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let s,a;e.isRenderTarget?(s=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(s=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const o=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,u=5;let h=0;return(e.textureType==1||e.textureType==2)&&(h=1),new Promise(d=>{Promise.all([r,i,s,a,o,l]).then(([p,_,g,E,v,x])=>{const A={size:t,right:_,left:p,up:g,down:E,front:v,back:x,format:u,type:h,gammaSpace:c};d(this.ConvertCubeMapToSphericalPolynomial(A))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new rc;let i=0;const r=2/e.size,s=r,a=.5*r,o=a-1;for(let f=0;f<6;f++){const d=this._FileFaces[f],p=e[d.name];let _=o;const g=e.format===5?4:3;for(let E=0;E<e.size;E++){let v=o;for(let x=0;x<e.size;x++){const A=d.worldAxisForFileX.scale(v).add(d.worldAxisForFileY.scale(_)).add(d.worldAxisForNormal);A.normalize();const T=this._AreaElement(v-a,_-a)-this._AreaElement(v-a,_+a)-this._AreaElement(v+a,_-a)+this._AreaElement(v+a,_+a);let C=p[E*e.size*g+x*g+0],y=p[E*e.size*g+x*g+1],P=p[E*e.size*g+x*g+2];isNaN(C)&&(C=0),isNaN(y)&&(y=0),isNaN(P)&&(P=0),e.type===0&&(C/=255,y/=255,P/=255),e.gammaSpace&&(C=Math.pow(vt(C),lu),y=Math.pow(vt(y),lu),P=Math.pow(vt(P),lu));const D=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const W=Math.max(C,y,P);if(W>D){const H=D/W;C*=H,y*=H,P*=H}}else C=vt(C,0,D),y=vt(y,0,D),P=vt(P,0,D);const F=new fe(C,y,P);t.addLight(A,F,T),i+=T,v+=r}_+=s}}const h=4*Math.PI*6/6/i;return t.scaleInPlace(h),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),eo.FromHarmonics(t)}}ol._FileFaces=[new go("right",new m(1,0,0),new m(0,0,-1),new m(0,-1,0)),new go("left",new m(-1,0,0),new m(0,0,1),new m(0,-1,0)),new go("up",new m(0,1,0),new m(1,0,0),new m(0,0,1)),new go("down",new m(0,-1,0),new m(1,0,0),new m(0,0,-1)),new go("front",new m(0,0,1),new m(1,0,0),new m(0,-1,0)),new go("back",new m(0,0,-1),new m(-1,0,0),new m(0,-1,0))];ol.MAX_HDRI_VALUE=4096;ol.PRESERVE_CLAMPED_COLORS=!1;class zl{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=Ai(e);if(t)return t;w.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let r=window||this;for(let s=0,a=i.length;s<a;s++)r=r[i[s]];return typeof r!="function"?null:r}}zl.RegisteredExternalClasses={};function hT(n,e,t=!1){const i=e.width,r=e.height;if(n instanceof Float32Array){let c=n.byteLength/n.BYTES_PER_ELEMENT;const u=new Uint8Array(c);for(;--c>=0;){let h=n[c];h<0?h=0:h>1&&(h=1),u[c]=h*255}n=u}const s=document.createElement("canvas");s.width=i,s.height=r;const a=s.getContext("2d");if(!a)return null;const o=a.createImageData(i,r);if(o.data.set(n),a.putImageData(o,0,0),t){const c=document.createElement("canvas");c.width=i,c.height=r;const u=c.getContext("2d");return u?(u.translate(0,r),u.scale(1,-1),u.drawImage(s,0,0),c.toDataURL("image/png")):null}return s.toDataURL("image/png")}function bD(n,e=0,t=0){const i=n.getInternalTexture();if(!i)return null;const r=n._readPixelsSync(e,t);return r?hT(r,n.getSize(),i.invertY):null}async function RD(n,e=0,t=0){const i=n.getInternalTexture();if(!i)return null;const r=await n.readPixels(e,t);return r?hT(r,n.getSize(),i.invertY):null}let ym=!1;class Z extends jt{static _CreateVideoTexture(e,t,i,r=!1,s=!1,a=Z.TRILINEAR_SAMPLINGMODE,o={},l,c=5){throw rt("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,r,s=Z.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=null,c=!1,u,h,f,d,p){super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new Q,this._isBlocking=!0,this.name=e||"",this.url=e;let _,g=!1,E=null,v=!0;typeof i=="object"&&i!==null?(_=i.noMipmap??!1,r=i.invertY??!ym,s=i.samplingMode??Z.TRILINEAR_SAMPLINGMODE,a=i.onLoad??null,o=i.onError??null,l=i.buffer??null,c=i.deleteBuffer??!1,u=i.format,h=i.mimeType,f=i.loaderOptions,d=i.creationFlags,g=i.useSRGBBuffer??!1,E=i.internalTexture??null,v=i.gammaSpace??v):_=!!i,this._gammaSpace=v,this._noMipmap=_,this._invertY=r===void 0?!ym:r,this._initialSamplingMode=s,this._buffer=l,this._deleteBuffer=c,this._mimeType=h,this._loaderOptions=f,this._creationFlags=d,this._useSRGBBuffer=g,this._forcedExtension=p,u&&(this._format=u);const x=this.getScene(),A=this._getEngine();if(!A)return;A.onBeforeTextureInitObservable.notifyObservers(this);const T=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&x&&x.resetCachedMaterial()},C=(y,P)=>{this._loadingError=!0,this._errorObject={message:y,exception:P},o&&o(y,P),Z.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!E){this._delayedOnLoad=T,this._delayedOnError=C;return}if(this._texture=E??this._getFromCache(this.url,_,s,this._invertY,g,this.isCube),this._texture)if(this._texture.isReady)qo.SetImmediate(()=>T());else{const y=this._texture.onLoadedObservable.add(T);this._texture.onErrorObservable.add(P=>{var D;C(P.message,P.exception),(D=this._texture)==null||D.onLoadedObservable.remove(y)})}else if(!x||!x.useDelayedTextureLoading){try{this._texture=A.createTexture(this.url,_,this._invertY,x,s,T,C,this._buffer,void 0,this._format,this._forcedExtension,h,f,d,g)}catch(y){throw C("error loading",y),y}c&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=T,this._delayedOnError=C}updateURL(e,t=null,i,r){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,s=>s.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=r,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?qo.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,r){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,m.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,r.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,r.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=O.Zero(),this._rowGenerationMatrix=new O,this._t0=m.Zero(),this._t1=m.Zero(),this._t2=m.Zero()),O.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(O.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,B.Matrix[0]),O.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,B.Matrix[1]),O.ScalingToRef(this._cachedUScale,this._cachedVScale,0,B.Matrix[2]),O.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,B.Matrix[3]),B.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(B.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(B.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(B.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),O.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();if(!t)return this._cachedTextureMatrix;const i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,r=>r.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===Z.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=O.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=O.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case Z.PLANAR_MODE:{O.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case Z.PROJECTION_MODE:{O.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:O.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return Ke.Clone(()=>new Z(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var i,r;const e=this.name;Z.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const t=super.serialize(Z._SerializeInternalTextureUniqueId);return t?((Z.SerializeBuffers||Z.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substring(0,5)==="data:"?(t.base64String=this._buffer,t.name=t.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?t.base64String="data:image/png;base64,"+aT(this._buffer):(Z.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?bD(this):RD(this))),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,Z._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=(i=this._texture)==null?void 0:i.uniqueId),t.internalTextureLabel=(r=this._texture)==null?void 0:r.label,t.noMipmap=this._noMipmap,this.name=e,t):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const c=zl.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return Z._CubeTextureParser(e,t,i);const r=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!r)return null;let s;if(r){const l=t.getEngine().getLoadedTexturesCache();for(const c of l)if(c.uniqueId===e.internalTextureUniqueId){s=c;break}}const a=l=>{if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const c=e.samplingMode;l&&l.samplingMode!==c&&l.updateSamplingMode(c)}if(l&&e.animations)for(let c=0;c<e.animations.length;c++){const u=e.animations[c],h=Ai("BABYLON.Animation");h&&l.animations.push(h.Parse(u))}l&&l._texture&&(r&&!s&&l._texture._setUniqueId(e.internalTextureUniqueId),l._texture.label=e.internalTextureLabel)};return Ke.Parse(()=>{let l=!0;if(e.noMipmap&&(l=!1),e.mirrorPlane){const c=Z._CreateMirror(e.name,e.renderTargetSize,t,l);return c._waitingRenderList=e.renderList,c.mirrorPlane=Vr.FromArray(e.mirrorPlane),a(c),c}else if(e.isRenderTarget){let c=null;if(e.isCube){if(t.reflectionProbes)for(let u=0;u<t.reflectionProbes.length;u++){const h=t.reflectionProbes[u];if(h.name===e.name)return h.cubeTexture}}else c=Z._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,l,e._creationFlags??0),c._waitingRenderList=e.renderList;return a(c),c}else if(e.isVideo){const c=Z._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,l,e.invertY,e.samplingMode,e.settings||{});return a(c),c}else{let c;if(e.base64String&&!s)c=Z.CreateFromBase64String(e.base64String,e.base64String,t,!l,e.invertY,e.samplingMode,()=>{a(c)},e._creationFlags??0,e._useSRGBBuffer??!1),c.name=e.name;else{let u;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?u=e.name:u=i+e.name,e.url&&(e.url.startsWith("data:")||Z.UseSerializedUrlIfAny)&&(u=e.url);const h={noMipmap:!l,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{a(c)},internalTexture:s};c=new Z(u,t,h)}return c}},e,t)}static CreateFromBase64String(e,t,i,r,s,a=Z.TRILINEAR_SAMPLINGMODE,o=null,l=null,c=5,u,h){return new Z("data:"+t,i,r,s,a,o,l,e,!1,c,void 0,void 0,u,h)}static LoadFromDataString(e,t,i,r=!1,s,a=!0,o=Z.TRILINEAR_SAMPLINGMODE,l=null,c=null,u=5,h,f){return e.substring(0,5)!=="data:"&&(e="data:"+e),new Z(e,i,s,a,o,l,c,t,r,u,void 0,void 0,h,f)}}Z.SerializeBuffers=!0;Z.ForceSerializeBuffers=!1;Z.OnTextureLoadErrorObservable=new Q;Z._SerializeInternalTextureUniqueId=!1;Z._CubeTextureParser=(n,e,t)=>{throw rt("CubeTexture")};Z._CreateMirror=(n,e,t,i)=>{throw rt("MirrorTexture")};Z._CreateRenderTargetTexture=(n,e,t,i,r)=>{throw rt("RenderTargetTexture")};Z.NEAREST_SAMPLINGMODE=1;Z.NEAREST_NEAREST_MIPLINEAR=8;Z.BILINEAR_SAMPLINGMODE=2;Z.LINEAR_LINEAR_MIPNEAREST=11;Z.TRILINEAR_SAMPLINGMODE=3;Z.LINEAR_LINEAR_MIPLINEAR=3;Z.NEAREST_NEAREST_MIPNEAREST=4;Z.NEAREST_LINEAR_MIPNEAREST=5;Z.NEAREST_LINEAR_MIPLINEAR=6;Z.NEAREST_LINEAR=7;Z.NEAREST_NEAREST=1;Z.LINEAR_NEAREST_MIPNEAREST=9;Z.LINEAR_NEAREST_MIPLINEAR=10;Z.LINEAR_LINEAR=2;Z.LINEAR_NEAREST=12;Z.EXPLICIT_MODE=0;Z.SPHERICAL_MODE=1;Z.PLANAR_MODE=2;Z.CUBIC_MODE=3;Z.PROJECTION_MODE=4;Z.SKYBOX_MODE=5;Z.INVCUBIC_MODE=6;Z.EQUIRECTANGULAR_MODE=7;Z.FIXED_EQUIRECTANGULAR_MODE=8;Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Z.CLAMP_ADDRESSMODE=0;Z.WRAP_ADDRESSMODE=1;Z.MIRROR_ADDRESSMODE=2;Z.UseSerializedUrlIfAny=!1;I([M()],Z.prototype,"url",void 0);I([M()],Z.prototype,"uOffset",void 0);I([M()],Z.prototype,"vOffset",void 0);I([M()],Z.prototype,"uScale",void 0);I([M()],Z.prototype,"vScale",void 0);I([M()],Z.prototype,"uAng",void 0);I([M()],Z.prototype,"vAng",void 0);I([M()],Z.prototype,"wAng",void 0);I([M()],Z.prototype,"uRotationCenter",void 0);I([M()],Z.prototype,"vRotationCenter",void 0);I([M()],Z.prototype,"wRotationCenter",void 0);I([M()],Z.prototype,"homogeneousRotationInUVTransform",void 0);I([M()],Z.prototype,"isBlocking",null);$("BABYLON.Texture",Z);Ke._TextureParser=Z.Parse;class tr{get isDisposed(){return this._isDisposed}constructor(e,t,i,r=0,s=!1,a=!1,o=!1,l,c){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=a,this._divisor=l||1,this._label=c,t instanceof ao?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,s||this.create()}createVertexBuffer(e,t,i,r,s,a=!1,o){const l=a?t:t*Float32Array.BYTES_PER_ELEMENT,c=r?a?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new b(this._engine,this,e,this._updatable,!0,c,s===void 0?this._instanced:s,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}w.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,i,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class b{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,r,s,a,o,l,c,u,h=!1,f=!1,d=1,p=!1){this._isDisposed=!1;let _=!1;if(this.engine=e,typeof r=="object"&&r!==null?(_=r.updatable??!1,s=r.postponeInternalCreation,a=r.stride,o=r.instanced,l=r.offset,c=r.size,u=r.type,h=r.normalized??!1,f=r.useBytes??!1,d=r.divisor??1,p=r.takeBufferOwnership??!1,this._label=r.label):_=!!r,t instanceof tr?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new tr(e,t,_,a,s,o,f,d,this._label),this._ownsBuffer=!0),this.uniqueId=b._Counter++,this._kind=i,u===void 0){const E=this.getData();this.type=E?b.GetDataType(E):b.FLOAT}else this.type=u;const g=b.GetTypeByteLength(this.type);f?(this._size=c||(a?a/g:b.DeduceStride(i)),this.byteStride=a||this._buffer.byteStride||this._size*g,this.byteOffset=l||0):(this._size=c||a||b.DeduceStride(i),this.byteStride=a?a*g:this._buffer.byteStride||this._size*g,this.byteOffset=(l||0)*g),this.normalized=h,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?d:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){var e;(e=this._buffer)==null||e._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?b.GetFloatData(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/b.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/b.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*b.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){b.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}_alignBuffer(){}static DeduceStride(e){switch(e){case b.UVKind:case b.UV2Kind:case b.UV3Kind:case b.UV4Kind:case b.UV5Kind:case b.UV6Kind:return 2;case b.NormalKind:case b.PositionKind:return 3;case b.ColorKind:case b.ColorInstanceKind:case b.MatricesIndicesKind:case b.MatricesIndicesExtraKind:case b.MatricesWeightsKind:case b.MatricesWeightsExtraKind:case b.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?b.BYTE:e instanceof Uint8Array?b.UNSIGNED_BYTE:e instanceof Int16Array?b.SHORT:e instanceof Uint16Array?b.UNSIGNED_SHORT:e instanceof Int32Array?b.INT:e instanceof Uint32Array?b.UNSIGNED_INT:b.FLOAT}static GetTypeByteLength(e){switch(e){case b.BYTE:case b.UNSIGNED_BYTE:return 1;case b.SHORT:case b.UNSIGNED_SHORT:return 2;case b.INT:case b.UNSIGNED_INT:case b.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,r,s,a,o,l){if(e instanceof Array){let c=t/4;const u=i/4;for(let h=0;h<a;h+=r){for(let f=0;f<r;f++)l(e[c+f],h+f);c+=u}}else{const c=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),u=b.GetTypeByteLength(s);for(let h=0;h<a;h+=r){let f=t;for(let d=0;d<r;d++){const p=b._GetFloatValue(c,s,f,o);l(p,h+d),f+=u}t+=i}}}static _GetFloatValue(e,t,i,r){switch(t){case b.BYTE:{let s=e.getInt8(i);return r&&(s=Math.max(s/127,-1)),s}case b.UNSIGNED_BYTE:{let s=e.getUint8(i);return r&&(s=s/255),s}case b.SHORT:{let s=e.getInt16(i,!0);return r&&(s=Math.max(s/32767,-1)),s}case b.UNSIGNED_SHORT:{let s=e.getUint16(i,!0);return r&&(s=s/65535),s}case b.INT:return e.getInt32(i,!0);case b.UNSIGNED_INT:return e.getUint32(i,!0);case b.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}static GetFloatData(e,t,i,r,s,a,o,l){const c=t*b.GetTypeByteLength(i),u=o*t;if(i!==b.FLOAT||s!==c){const h=new Float32Array(u);return b.ForEach(e,r,s,t,i,u,a,(f,d)=>h[d]=f),h}if(!(e instanceof Array||e instanceof Float32Array)||r!==0||e.length!==u)if(e instanceof Array){const h=r/4;return e.slice(h,h+u)}else{if(e instanceof ArrayBuffer)return new Float32Array(e,r,u);{const h=e.byteOffset+r;if(h&3&&(w.Warn("Float array must be aligned to 4-bytes border"),l=!0),l){const f=new Uint8Array(u*Float32Array.BYTES_PER_ELEMENT),d=new Uint8Array(e.buffer,h,f.length);return f.set(d),new Float32Array(f.buffer)}else return new Float32Array(e.buffer,h,u)}}return l?e.slice():e}}b._Counter=0;b.BYTE=5120;b.UNSIGNED_BYTE=5121;b.SHORT=5122;b.UNSIGNED_SHORT=5123;b.INT=5124;b.UNSIGNED_INT=5125;b.FLOAT=5126;b.PositionKind="position";b.NormalKind="normal";b.TangentKind="tangent";b.UVKind="uv";b.UV2Kind="uv2";b.UV3Kind="uv3";b.UV4Kind="uv4";b.UV5Kind="uv5";b.UV6Kind="uv6";b.ColorKind="color";b.ColorInstanceKind="instanceColor";b.MatricesIndicesKind="matricesIndices";b.MatricesWeightsKind="matricesWeights";b.MatricesIndicesExtraKind="matricesIndicesExtra";b.MatricesWeightsExtraKind="matricesWeightsExtra";class Pu{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new Q,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[b.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[b.PositionKind]=new b(this._scene.getEngine(),e,b.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[b.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,r=0,s=0,a=!1){var l;const o=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?o.bindFramebuffer(t,r,void 0,void 0,i,s):a||o.restoreDefaultFramebuffer(),(l=o._debugInsertMarker)==null||l.call(o,`post process ${e[c].name} output`));const u=e[c],h=u.apply();h&&(u.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,h),o.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(h))}o.setDepthBuffer(!0),o.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,s=!1){var l;const a=this._scene.activeCamera;if(!a||(this.onBeforeRenderObservable.notifyObservers(this),r=r||a._postProcesses.filter(c=>c!=null),r.length===0||!this._scene.postProcessesEnabled))return;const o=this._scene.getEngine();for(let c=0,u=r.length;c<u;c++){const h=r[c];if(c<u-1?h._outputTexture=r[c+1].activate(a,t==null?void 0:t.texture):(t?(o.bindFramebuffer(t,i,void 0,void 0,s),h._outputTexture=t):(o.restoreDefaultFramebuffer(),h._outputTexture=null),(l=o._debugInsertMarker)==null||l.call(o,`post process ${r[c].name} output`)),e)break;const f=h.apply();f&&(h.onBeforeRenderObservable.notifyObservers(f),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,f),o.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(f))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[b.PositionKind];e&&(e.dispose(),this._vertexBuffers[b.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class pr{constructor(e){this.length=0,this.data=new Array(e),this._id=pr._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}pr._GlobalId=0;class na extends pr{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class Bs{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=Bs.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=Bs.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=Bs.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,s=null){this.index=e,this._opaqueSubMeshes=new pr(256),this._transparentSubMeshes=new pr(256),this._alphaTestSubMeshes=new pr(256),this._depthOnlySubMeshes=new pr(256),this._particleSystems=new pr(256),this._spriteManagers=new pr(256),this._empty=!0,this._edgesRenderers=new na(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=s}render(e,t,i,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const s=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const a=s.getStencilBuffer();if(s.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(s.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){const o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);s.setAlphaMode(0)}if(s.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();s.setAlphaMode(0)}s.setStencilBuffer(a)}_renderOpaqueSorted(e){Bs._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){Bs._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){Bs._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,r){let s=0,a;const o=i?i.globalPosition:Bs._ZeroVector;if(r)for(;s<e.length;s++)a=e.data[s],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=m.Distance(a.getBoundingInfo().boundingSphere.centerWorld,o);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(s=0;s<l.length;s++)if(a=l[s],!(c._activeMeshesFrozenButKeepClipping&&!a.isInFrustum(c._frustumPlanes))){if(r){const u=a.getMaterial();if(u&&u.needDepthPrePass){const h=u.getScene().getEngine();h.setColorWrite(!1),h.setAlphaMode(0),a.render(!1),h.setColorWrite(!0)}}a.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:Bs.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0)continue;const s=r.emitter;(!s.position||!e||e.indexOf(s)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}Bs._ZeroVector=m.Zero();class PD{}class fr{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new PD,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=fr.MIN_RENDERINGGROUPS;t<fr.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,r){const s=this._renderingGroupInfo;if(s.scene=this._scene,s.camera=this._scene.activeCamera,this._scene.spriteManagers&&r)for(let a=0;a<this._scene.spriteManagers.length;a++){const o=this._scene.spriteManagers[a];this.dispatchSprites(o)}for(let a=fr.MIN_RENDERINGGROUPS;a<fr.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===fr.MIN_RENDERINGGROUPS;const o=this._renderingGroups[a];if(!o||o._empty)continue;const l=1<<a;if(s.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(s,l),fr.AUTOCLEAR){const c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}for(const c of this._scene._beforeRenderingGroupDrawStage)c.action(a);o.render(e,r,i,t);for(const c of this._scene._afterRenderingGroupDrawStage)c.action(a);this._scene.onAfterRenderingGroupObservable.notifyObservers(s,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=fr.MIN_RENDERINGGROUPS;e<fr.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=fr.MIN_RENDERINGGROUPS;e<fr.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=fr.MIN_RENDERINGGROUPS;e<fr.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Bs(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){const s=this._renderingGroups[e];s.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],s.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],s.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}fr.MAX_RENDERINGGROUPS=4;fr.MIN_RENDERINGGROUPS=0;fr.AUTOCLEAR=!0;ei.prototype.setDepthStencilTexture=function(n,e){this._engine.setDepthStencilTexture(this._samplers[n],this._uniforms[n],e,n)};class mr extends Z{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=ZS(e,this._renderListHasChanged)),this._renderList=e)}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let r=0;r<i.length;++r)for(let s=0;s<this._renderPassIds.length;++s)i[r].setMaterialForRenderPass(this._renderPassIds[s],t!==void 0?Array.isArray(t)?t[s]:t:void 0)}get isMulti(){var e;return((e=this._renderTarget)==null?void 0:e.isMulti)??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e;return((e=this._renderTarget)==null?void 0:e._depthStencilTexture)??null}constructor(e,t,i,r=!1,s=!0,a=0,o=!1,l=Z.TRILINEAR_SAMPLINGMODE,c=!0,u=!1,h=!1,f=5,d=!1,p,_,g=!1,E=!1){let v,x=!0;if(typeof r=="object"){const T=r;r=!!T.generateMipMaps,s=T.doNotChangeAspectRatio??!0,a=T.type??0,o=!!T.isCube,l=T.samplingMode??Z.TRILINEAR_SAMPLINGMODE,c=T.generateDepthBuffer??!0,u=!!T.generateStencilBuffer,h=!!T.isMulti,f=T.format??5,d=!!T.delayAllocation,p=T.samples,_=T.creationFlags,g=!!T.noColorAttachment,E=!!T.useSRGBBuffer,v=T.colorAttachment,x=T.gammaSpace??x}if(super(null,i,!r,void 0,l,void 0,void 0,void 0,void 0,f),this._unObserveRenderList=null,this._renderListHasChanged=(T,C)=>{var P;const y=this._renderList?this._renderList.length:0;(C===0&&y>0||y===0)&&((P=this.getScene())==null||P.meshes.forEach(D=>{D._markSubMeshesAsLightDirty()}))},this.particleSystemList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new Q,this.onAfterUnbindObservable=new Q,this.onBeforeRenderObservable=new Q,this.onAfterRenderObservable=new Q,this.onClearObservable=new Q,this.onResizeObservable=new Q,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=m.Zero(),this._dumpToolsLoading=!1,i=this.getScene(),!i)return;const A=this.getScene().getEngine();this._gammaSpace=x,this._coordinatesMode=Z.PROJECTION_MODE,this.renderList=[],this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=o,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=A.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=s,this._renderingManager=new fr(i),this._renderingManager._useSceneAutoClearSetup=!0,!h&&(this._renderTargetOptions={generateMipMaps:r,type:a,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:u,samples:p,creationFlags:_,noColorAttachment:g,useSRGBBuffer:E,colorAttachment:v,label:this.name},this.samplingMode===Z.NEAREST_SAMPLINGMODE&&(this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE),d||(o?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=Z.INVCUBIC_MODE,this._textureMatrix=O.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,p!==void 0&&(this.samples=p)))}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,s=14,a){var o;(o=this._renderTarget)==null||o.createDepthStencilTexture(e,t,i,r,s,a)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e,t=!0){if(e.ratio){this._sizeRatio=e.ratio;const i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=e;t&&this._createRenderPassId()}get samples(){var e;return((e=this._renderTarget)==null?void 0:e.samples)??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new Pu(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;const t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var r;const t=this.isCube;(r=this._renderTarget)==null||r.dispose(),this._renderTarget=null;const i=this.getScene();i&&(this._processSizeParameter(e,!1),t?this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._dumpToolsLoading||(this._dumpToolsLoading=!0,re(()=>Promise.resolve().then(()=>vO),void 0).then(e=>this._dumpTools=e)),this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){const r=this.getScene();if(!r)return i;const s=r.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){const h=this._waitingRenderList[u],f=r.getMeshById(h);f&&this.renderList.push(f)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const u=this.getScene();if(!u)return i;const h=u.meshes;for(let f=0;f<h.length;f++){const d=h[f];this.renderListPredicate(d)&&this.renderList.push(d)}}const a=s.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const o=this.activeCamera??r.activeCamera,l=r.activeCamera;o&&(o!==r.activeCamera&&(r.setTransformMatrix(o.getViewMatrix(),o.getProjectionMatrix(!0)),r.activeCamera=o),s.setViewport(o.rigParent?o.rigParent.viewport:o.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let c=i;if(i){r.getViewMatrix()||r.updateTransformMatrix();const u=this.is2DArray||this.is3D?this.getRenderLayers():this.isCube?6:1;for(let f=0;f<u&&c;f++){let d=null;const p=this.renderList?this.renderList:r.getActiveMeshes().data,_=this.renderList?this.renderList.length:r.getActiveMeshes().length;s.currentRenderPassId=this._renderPassIds[f],this.onBeforeRenderObservable.notifyObservers(f),this.getCustomRenderList&&(d=this.getCustomRenderList(f,p,_)),d||(d=p),this._doNotChangeAspectRatio||r.updateTransformMatrix(!0);for(let g=0;g<d.length&&c;++g){const E=d[g];if(!(!E.isEnabled()||E.isBlocked||!E.isVisible||!E.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(E,this.refreshRate,i)){c=!1;continue}}else if(!E.isReady(!0)){c=!1;continue}}}this.onAfterRenderObservable.notifyObservers(f),(this.is2DArray||this.is3D||this.isCube)&&(r.incrementRenderId(),r.resetCachedMaterial())}const h=this.particleSystemList||r.particleSystems;for(const f of h)f.isReady()||(c=!1)}else if((this.is2DArray||this.is3D)&&!this.isMulti)for(let u=0;u<this.getRenderLayers();u++)this._renderToTarget(0,e,t,u,o),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let u=0;u<6;u++)this._renderToTarget(u,e,t,void 0,o),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,o);return this.onAfterUnbindObservable.notifyObservers(this),s.currentRenderPassId=a,r.activeCamera=l,l&&(this.activeCamera&&this.activeCamera!==r.activeCamera&&r.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),s.setViewport(l.viewport)),r.resetCachedMaterial(),c}_bestReflectionRenderTargetDimension(e,t){const r=e*t,s=HS(r+128*128/(128+r));return Math.min(rp(e),s)}_prepareRenderingManager(e,t,i,r){const s=this.getScene();if(!s)return;this._renderingManager.reset();const a=s.getRenderId();for(let l=0;l<t;l++){const c=e[l];if(c&&!c.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!c.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!c._internalAbstractMeshDataInfo._currentLODIsUpToDate&&i&&(c._internalAbstractMeshDataInfo._currentLOD=s.customLODSelector?s.customLODSelector(c,i):c.getLOD(i),c._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!c._internalAbstractMeshDataInfo._currentLOD)continue;let u=c._internalAbstractMeshDataInfo._currentLOD;u!==c&&u.billboardMode!==0&&u.computeWorldMatrix(),u._preActivateForIntermediateRendering(a);let h;if(r&&i?h=(c.layerMask&i.layerMask)===0:h=!1,c.isEnabled()&&c.isVisible&&c.subMeshes&&!h){if(u!==c&&u._activate(a,!0),c._activate(a,!0)&&c.subMeshes.length){c.isAnInstance?c._internalAbstractMeshDataInfo._actAsRegularMesh&&(u=c):u._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,u._internalAbstractMeshDataInfo._isActiveIntermediate=!0,s._prepareSkeleton(u);for(let f=0;f<u.subMeshes.length;f++){const d=u.subMeshes[f];this._renderingManager.dispatch(d,u)}}c._postActivate()}}}const o=this.particleSystemList||s.particleSystems;for(let l=0;l<o.length;l++){const c=o[l],u=c.emitter;!c.isStarted()||!u||u.position&&!u.isEnabled()||this._renderingManager.dispatchParticles(c)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const r=i.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,r=0,s=null){var c,u,h;const a=this.getScene();if(!a)return;const o=a.getEngine();if(this._prepareFrame(a,e,r,t),(c=o._debugPushGroup)==null||c.call(o,`render to face #${e} layer #${r}`,2),this.is2DArray||this.is3D?(o.currentRenderPassId=this._renderPassIds[r],this.onBeforeRenderObservable.notifyObservers(r)):(o.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),o.snapshotRendering&&o.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(o):this.skipInitialClear||o.clear(this.clearColor||a.clearColor,!0,!0,!0);else{let f=null;const d=this.renderList?this.renderList:a.getActiveMeshes().data,p=this.renderList?this.renderList.length:a.getActiveMeshes().length;this.getCustomRenderList&&(f=this.getCustomRenderList(this.is2DArray||this.is3D?r:e,d,p)),f?this._prepareRenderingManager(f,f.length,s,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(d,p,s,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),f=d);for(const g of a._beforeRenderTargetClearStage)g.action(this,e,r);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(o):this.skipInitialClear||o.clear(this.clearColor||a.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0);for(const g of a._beforeRenderTargetDrawStage)g.action(this,e,r);this._renderingManager.render(this.customRenderFunction,f,this.renderParticles,this.renderSprites);for(const g of a._afterRenderTargetDrawStage)g.action(this,e,r);const _=((u=this._texture)==null?void 0:u.generateMipMaps)??!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&a.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,e);for(const g of a._afterRenderTargetPostProcessStage)g.action(this,e,r);this._texture&&(this._texture.generateMipMaps=_),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0),i&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),o):w.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}(h=o._debugPopGroup)==null||h.call(o,2),this._unbindFrameBuffer(o,e),this._texture&&this.isCube&&e===5&&o.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new mr(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)==null||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)==null||e.releaseTextures(),this._texture=null}dispose(){var i;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const r of e.cameras)t=r.customRenderTargets.indexOf(this),t>=0&&r.customRenderTargets.splice(t,1);(i=this._renderTarget)==null||i.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===mr.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=mr.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}mr.REFRESHRATE_RENDER_ONCE=0;mr.REFRESHRATE_RENDER_ONEVERYFRAME=1;mr.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;Z._CreateRenderTargetTexture=(n,e,t,i,r)=>new mr(n,e,t,i);class ds{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var r;this.effect=e,t!==void 0&&(this.defines=t),i&&((r=this.drawContext)==null||r.reset())}dispose(){var e;(e=this.drawContext)==null||e.dispose()}}const fT="postprocessVertexShader",dT=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStore[fT]=dT;const MD={name:fT,shader:dT},pT=Object.freeze(Object.defineProperty({__proto__:null,postprocessVertexShader:MD},Symbol.toStringTag,{value:"Module"})),Ef={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class _T{constructor(e,t=Ef){this._fullscreenViewport=new Hn(0,0,1,1);const i=t.positions??Ef.positions,r=t.indices??Ef.indices;this.engine=e,this._vertexBuffers={[b.PositionKind]:new b(e,i,b.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(r);for(const s in this._vertexBuffers)this._vertexBuffers[s]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[b.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[b.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class Or{static RegisterShaderCodeProcessing(e,t){if(!t){delete Or._CustomShaderCodeProcessing[e??""];return}Or._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){return Or._CustomShaderCodeProcessing[e]??Or._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){var e;return((e=this._drawWrapper.effect)==null?void 0:e.isReady())??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new Q(void 0,!0),this.onApplyObservable=new Q,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(this.options.samplers.indexOf("textureSampler")===-1&&this.options.samplers.push("textureSampler"),this.options.uniforms.indexOf("scale")===-1&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new ds(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;const t=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([re(()=>import("./postprocess.vertex-BFmurKaD.js"),[])])):t.push(Promise.all([re(()=>Promise.resolve().then(()=>pT),void 0)])))}_postConstructor(e,t=null,i,r){this._importPromises.length=0,r&&this._importPromises.push(...r);const s=this.options.engine.isWebGPU&&!Or.ForceGLSL;this._gatherImports(s,this._importPromises),i!==void 0&&i(s,this._importPromises),s&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,i=null,r,s,a,o,l){const c=Or._GetShaderCodeProcessing(this.name);if(c!=null&&c.defineCustomBindings){const f=(t==null?void 0:t.slice())??[];f.push(...this.options.uniforms);const d=(i==null?void 0:i.slice())??[];d.push(...this.options.samplers),e=c.defineCustomBindings(this.name,e,f,d),t=f,i=d}this.options.defines=e||"";const u=this._shadersLoaded||this._importPromises.length===0?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let h;this.options.extraInitializationsAsync?h=async()=>{u==null||u(),await this.options.extraInitializationsAsync}:h=u,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:o??this._shaderPath.vertex,fragment:l??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:i||this.options.samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:s??this.options.onCompiled,onError:a??null,indexParameters:r||this.options.indexParameters,processCodeAfterIncludes:c!=null&&c.processCodeAfterIncludes?(f,d)=>c.processCodeAfterIncludes(this.name,f,d):null,processFinalCode:c!=null&&c.processFinalCode?(f,d)=>c.processFinalCode(this.name,f,d):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:h},this.options.engine):this._drawWrapper.effect=new ei(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,i||this.options.samplerNames,this.options.engine,e,void 0,s||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,h),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(){var e,t;this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),(t=(e=Or._GetShaderCodeProcessing(this.name))==null?void 0:e.bindCustomBindings)==null||t.call(e,this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this.effect.dispose()}}Or.ForceGLSL=!1;Or._CustomShaderCodeProcessing={};q.prototype.setTextureFromPostProcess=function(n,e,t){let i=null;e&&(e._forcedOutputTexture?i=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(i=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(n,(i==null?void 0:i.texture)??null,t)};q.prototype.setTextureFromPostProcessOutput=function(n,e,t){var i;this._bindTexture(n,((i=e==null?void 0:e._outputTexture)==null?void 0:i.texture)??null,t)};ei.prototype.setTextureFromPostProcess=function(n,e){this._engine.setTextureFromPostProcess(this._samplers[n],e,n)};ei.prototype.setTextureFromPostProcessOutput=function(n,e){this._engine.setTextureFromPostProcessOutput(this._samplers[n],e,n)};class Jt{static get ForceGLSL(){return Or.ForceGLSL}static set ForceGLSL(e){Or.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){Or.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,r,s,a,o=1,l,c,u=null,h=0,f="postprocess",d,p=!1,_=5,g,E){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new pr(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new se(1,1),this._texelSize=se.Zero(),this.onActivateObservable=new Q,this.onSizeChangedObservable=new Q,this.onApplyObservable=new Q,this.onBeforeRenderObservable=new Q,this.onAfterRenderObservable=new Q;let v=1,x=null,A;if(i&&!Array.isArray(i)){const C=i;i=C.uniforms??null,r=C.samplers??null,v=C.size??1,a=C.camera??null,o=C.samplingMode??1,l=C.engine,c=C.reusable,u=Array.isArray(C.defines)?C.defines.join(`
`):C.defines??null,h=C.textureType??0,f=C.vertexUrl??"postprocess",d=C.indexParameters,p=C.blockCompilation??!1,_=C.textureFormat??5,g=C.shaderLanguage??0,x=C.uniformBuffers??null,E=C.extraInitializations,A=C.effectWrapper}else s&&(typeof s=="number"?v=s:v={width:s.width,height:s.height});const T=!!A;if(this._effectWrapper=A??new Or({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:l||(a==null?void 0:a.getScene().getEngine()),uniforms:i,samplers:r,uniformBuffers:x,defines:u,vertexUrl:f,indexParameters:d,blockCompilation:p,shaderLanguage:g,extraInitializations:E}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,a!=null?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=v,this.renderTargetSamplingMode=o||1,this._reusable=c||!1,this._textureType=h,this._textureFormat=_,this._shaderLanguage=g||0,this._samplers=r||[],this._samplers.indexOf("textureSampler")===-1&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=f,this._parameters=i||[],this._parameters.indexOf("scale")===-1&&this._parameters.push("scale"),this._uniformBuffers=x||[],this._indexParameters=d,!T){this._webGPUReady=this._shaderLanguage===1;const C=[];this._gatherImports(this._engine.isWebGPU&&!Jt.ForceGLSL,C),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(p,u,E,C)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([re(()=>import("./postprocess.vertex-BFmurKaD.js"),[])])):t.push(Promise.all([re(()=>Promise.resolve().then(()=>pT),void 0)]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new pr(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,r,s,a,o,l){this._effectWrapper.updateEffect(e,t,i,r,s,a,o,l),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join(`
`):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:i,lastUsedRenderId:-1}),r}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,r=!1,s=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let a=null;if(i){for(let c=0;c<i._postProcesses.length;c++)if(i._postProcesses[c]!==null){a=i._postProcesses[c];break}}const o={width:this.width,height:this.height},l={generateMipMaps:r,generateDepthBuffer:s||a===this,generateStencilBuffer:(s||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){var d,p;e=e||this._camera;const r=e.getScene(),s=r.getEngine(),a=s.getCaps().maxTextureSize,o=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,l=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let c=this._options.width||o,u=this._options.height||l;const h=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;let f=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const _=s.currentViewport;_&&(c*=_.width,u*=_.height)}(h||this.alwaysForcePOT)&&(this._options.width||(c=s.needPOTTextures?Wn(c,a,this.scaleMode):c),this._options.height||(u=s.needPOTTextures?Wn(u,a,this.scaleMode):u)),(this.width!==c||this.height!==u||!(f=this._getTarget()))&&this.resize(c,u,e,h,i),this._textures.forEach(_=>{_.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(_,this.samples)}),this._flushTextureCache(),this._renderId++}return f||(f=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(o/c,l/u),this._engine.bindFramebuffer(f,0,o,l,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(f,0,void 0,void 0,this.forceFullscreenViewport)),(p=(d=this._engine)._debugInsertMarker)==null||p.call(d,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:r.clearColor,r._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),f}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e==null?void 0:e.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=Ke.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=Jt.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const r=Ai(e.customType);if(!r||!r._Parse)return null;const s=t?t.getCameraById(e.cameraId):null;return r._Parse(e,s,t,i)}static _Parse(e,t,i,r){return Ke.Parse(()=>new Jt(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,r)}}I([M()],Jt.prototype,"uniqueId",void 0);I([M()],Jt.prototype,"name",null);I([M()],Jt.prototype,"width",void 0);I([M()],Jt.prototype,"height",void 0);I([M()],Jt.prototype,"renderTargetSamplingMode",void 0);I([rT()],Jt.prototype,"clearColor",void 0);I([M()],Jt.prototype,"autoClear",void 0);I([M()],Jt.prototype,"forceAutoClearInAlphaMode",void 0);I([M()],Jt.prototype,"alphaMode",null);I([M()],Jt.prototype,"alphaConstants",void 0);I([M()],Jt.prototype,"enablePixelPerfectMode",void 0);I([M()],Jt.prototype,"forceFullscreenViewport",void 0);I([M()],Jt.prototype,"scaleMode",void 0);I([M()],Jt.prototype,"alwaysForcePOT",void 0);I([M("samples")],Jt.prototype,"_samples",void 0);I([M()],Jt.prototype,"adaptScaleToCurrentViewport",void 0);$("BABYLON.PostProcess",Jt);class oo extends Jt{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,r,s,a,o=0,l=!1){super(e,"pass",null,null,t,i,r,s,a,void 0,o,void 0,null,l)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([re(()=>import("./pass.fragment-D-3sxBAe.js"),[])]))):t.push(Promise.all([re(()=>import("./pass.fragment-15ZcIKRQ.js"),[])])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return Ke.Parse(()=>new oo(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}}$("BABYLON.PassPostProcess",oo);q._RescalePostProcessFactory=n=>new oo("rescale",1,null,2,n,!1,0);function DD(n,e,t,i=!0){const r=n.getScene(),s=r.getEngine(),a=new mr("resized"+n.name,{width:e,height:t},r,!n.noMipmap,!0,n._texture.type,!1,n.samplingMode,!1);a.wrapU=n.wrapU,a.wrapV=n.wrapV,a.uOffset=n.uOffset,a.vOffset=n.vOffset,a.uScale=n.uScale,a.vScale=n.vScale,a.uAng=n.uAng,a.vAng=n.vAng,a.wAng=n.wAng,a.coordinatesIndex=n.coordinatesIndex,a.level=n.level,a.anisotropicFilteringLevel=n.anisotropicFilteringLevel,a._texture.isReady=!1,n.wrapU=Z.CLAMP_ADDRESSMODE,n.wrapV=Z.CLAMP_ADDRESSMODE;const o=new oo("pass",1,null,i?Z.BILINEAR_SAMPLINGMODE:Z.NEAREST_SAMPLINGMODE,s,!1,0);return o.externalTextureSamplerBinding=!0,o.onEffectCreatedObservable.addOnce(l=>{l.executeWhenCompiled(()=>{o.onApply=function(u){u.setTexture("textureSampler",n)};const c=a.renderTarget;c&&(r.postProcessManager.directRender([o],c),s.unBindFramebuffer(c),a.disposeFramebufferObjects(),o.dispose(),a.getInternalTexture().isReady=!0)})}),a}function mT(n,e,t,i,r,s,a,o){const l=e.getEngine();return e.isReady=!1,r=r??e.samplingMode,i=i??e.type,s=s??e.format,a=a??e.width,o=o??e.height,i===-1&&(i=0),new Promise(c=>{const u=new Jt("postprocess",n,null,null,1,null,r,l,!1,void 0,i,void 0,null,!1,s);u.externalTextureSamplerBinding=!0;const h=l.createRenderTargetTexture({width:a,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:i,format:s});u.onEffectCreatedObservable.addOnce(f=>{f.executeWhenCompiled(()=>{u.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([u],h,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),u&&u.dispose(),h._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,c(e)})})})}let Yc,bm;function Ur(n){Yc||(Yc=new Float32Array(1),bm=new Int32Array(Yc.buffer)),Yc[0]=n;const e=bm[0];let t=e>>16&32768,i=e>>12&2047;const r=e>>23&255;return r<103?t:r>142?(t|=31744,t|=(r==255?0:1)&&e&8388607,t):r<113?(i|=2048,t|=(i>>114-r)+(i>>113-r&1),t):(t|=r-112<<10|i>>1,t+=i&1,t)}function Qs(n){const e=(n&32768)>>15,t=(n&31744)>>10,i=n&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}const OD=async(n,e,t,i,r)=>{const s=n.getScene(),a=s.getEngine();a.isWebGPU?n.isCube?await re(()=>import("./lodCube.fragment-ixOWJe6O.js"),[]):await re(()=>import("./lod.fragment-Df03X65Q.js"),[]):n.isCube?await re(()=>import("./lodCube.fragment-Bf_syYv7.js"),[]):await re(()=>import("./lod.fragment-CsFsyEBT.js"),[]);let o;if(!n.isCube)o=new Jt("lod","lod",{uniforms:["lod","gamma"],samplingMode:Z.NEAREST_NEAREST_MIPNEAREST,engine:a,shaderLanguage:a.isWebGPU?1:0});else{const u=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];o=new Jt("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:Z.NEAREST_NEAREST_MIPNEAREST,engine:a,defines:u[i],shaderLanguage:a.isWebGPU?1:0})}await new Promise(u=>{o.onEffectCreatedObservable.addOnce(h=>{h.executeWhenCompiled(()=>{u(0)})})});const l=new mr("temp",{width:e,height:t},s,!1);o.onApply=function(u){u.setTexture("textureSampler",n),u.setFloat("lod",r),u.setInt("gamma",n.gammaSpace?1:0)};const c=n.getInternalTexture();try{if(l.renderTarget&&c){const u=c.samplingMode;r!==0?n.updateSamplingMode(Z.NEAREST_NEAREST_MIPNEAREST):n.updateSamplingMode(Z.NEAREST_NEAREST),s.postProcessManager.directRender([o],l.renderTarget,!0),n.updateSamplingMode(u);const h=await a.readPixels(0,0,e,t),f=new Uint8Array(h.buffer,0,h.byteLength);return a.unBindFramebuffer(l.renderTarget),f}else throw Error("Render to texture failed.")}finally{l.dispose(),o.dispose()}};async function ND(n,e,t,i=0,r=0){return!n.isReady()&&n._texture&&await new Promise((s,a)=>{if(n._texture===null){a(0);return}n._texture.onLoadedObservable.addOnce(()=>{s(0)})}),await OD(n,e,t,i,r)}const LD={CreateResizedCopy:DD,ApplyPostProcess:mT,ToHalfFloat:Ur,FromHalfFloat:Qs,GetTextureDataAsync:ND};q.prototype._partialLoadFile=function(n,e,t,i,r=null){const s=o=>{t[e]=o,t._internalCount++,t._internalCount===6&&i(t)},a=(o,l)=>{r&&o&&r(o.status+" "+o.statusText,l)};this._loadFile(n,s,void 0,void 0,!0,a)};q.prototype._cascadeLoadFiles=function(n,e,t,i=null){const r=[];r._internalCount=0;for(let s=0;s<6;s++)this._partialLoadFile(t[s],s,r,e,i)};q.prototype._cascadeLoadImgs=function(n,e,t,i,r=null,s){const a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,a,n,e,t,r,s)};q.prototype._partialLoadImg=function(n,e,t,i,r,s,a=null,o){const l=th();Ec(n,h=>{t[e]=h,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&s&&s(r,t)},(h,f)=>{i&&i.removePendingData(l),a&&a(h,f)},i?i.offlineProvider:null,o),i&&i.addPendingData(l)};q.prototype.createCubeTextureBase=function(n,e,t,i,r=null,s=null,a,o=null,l=!1,c=0,u=0,h=null,f=null,d=null,p=!1,_=null){const g=h||new Yt(this,7);g.isCube=!0,g.url=n,g.generateMipMaps=!i,g._lodGenerationScale=c,g._lodGenerationOffset=u,g._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!i),g!==h&&(g.label=n.substring(0,60)),this._doNotHandleContextLost||(g._extension=o,g._files=t,g._buffer=_);const E=n;this._transformTextureUrl&&!h&&(n=this._transformTextureUrl(n));const v=n.split("?")[0],x=v.lastIndexOf("."),A=o||(x>-1?v.substring(x).toLowerCase():""),T=ip(A),C=(y,P)=>{n===E?s&&y&&s(y.status+" "+y.statusText,P):(w.Warn(`Failed to load ${n}, falling back to the ${E}`),this.createCubeTextureBase(E,e,t,!!i,r,s,a,o,l,c,u,g,f,d,p,_))};if(T)T.then(y=>{const P=D=>{f&&f(g,D),y.loadCubeData(D,g,l,r,s)};_?P(_):t&&t.length===6?y.supportCascades?this._cascadeLoadFiles(e,D=>P(D.map(F=>new Uint8Array(F))),t,s):s?s("Textures type does not support cascades."):w.Warn("Texture loader does not support cascades."):this._loadFile(n,D=>P(new Uint8Array(D)),void 0,void 0,!0,C)});else{if(!t||t.length===0)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(e,g,(y,P)=>{d&&d(y,P)},t,s)}return this._internalTexturesCache.push(g),g};const FD=542327876,Rm=131072,Pm=512,Mm=4,Dm=64,Om=131072;function ih(n){return n.charCodeAt(0)+(n.charCodeAt(1)<<8)+(n.charCodeAt(2)<<16)+(n.charCodeAt(3)<<24)}function wD(n){return String.fromCharCode(n&255,n>>8&255,n>>16&255,n>>24&255)}const Nm=ih("DXT1"),Lm=ih("DXT3"),Fm=ih("DXT5"),vf=ih("DX10"),wm=113,Bm=116,Vm=2,Um=10,BD=88,Sf=31,VD=0,UD=1,km=2,Gm=3,Tf=4,zm=7,xf=20,Wm=21,kD=22,GD=23,zD=24,WD=25,HD=26,XD=28,YD=32;class fi{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,Sf),i=new Int32Array(e.buffer,e.byteOffset,Sf+4);let r=1;t[km]&Rm&&(r=Math.max(1,t[zm]));const s=t[Wm],a=s===vf?i[YD]:0;let o=0;switch(s){case wm:o=2;break;case Bm:o=1;break;case vf:if(a===Um){o=2;break}if(a===Vm){o=1;break}}return{width:t[Tf],height:t[Gm],mipmapCount:r,isFourCC:(t[xf]&Mm)===Mm,isRGB:(t[xf]&Dm)===Dm,isLuminance:(t[xf]&Om)===Om,isCube:(t[XD]&Pm)===Pm,isCompressed:s===Nm||s===Lm||s===Fm,dxgiFormat:a,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,r,s,a){const o=new Float32Array(r),l=new Uint16Array(s,i);let c=0;for(let u=0;u<t;u++)for(let h=0;h<e;h++){const f=(h+u*e)*4;o[c]=Qs(l[f]),o[c+1]=Qs(l[f+1]),o[c+2]=Qs(l[f+2]),fi.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=Qs(l[f+3]),c+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,r,s,a){if(fi.StoreLODInAlphaChannel){const o=new Uint16Array(r),l=new Uint16Array(s,i);let c=0;for(let u=0;u<t;u++)for(let h=0;h<e;h++){const f=(h+u*e)*4;o[c]=l[f],o[c+1]=l[f+1],o[c+2]=l[f+2],o[c+3]=Ur(a),c+=4}return o}return new Uint16Array(s,i,r)}static _GetFloatRGBAArrayBuffer(e,t,i,r,s,a){if(fi.StoreLODInAlphaChannel){const o=new Float32Array(r),l=new Float32Array(s,i);let c=0;for(let u=0;u<t;u++)for(let h=0;h<e;h++){const f=(h+u*e)*4;o[c]=l[f],o[c+1]=l[f+1],o[c+2]=l[f+2],o[c+3]=a,c+=4}return o}return new Float32Array(s,i,r)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,r,s,a){const o=new Uint16Array(r),l=new Float32Array(s,i);let c=0;for(let u=0;u<t;u++)for(let h=0;h<e;h++)o[c]=Ur(l[c]),o[c+1]=Ur(l[c+1]),o[c+2]=Ur(l[c+2]),fi.StoreLODInAlphaChannel?o[c+3]=Ur(a):o[c+3]=Ur(l[c+3]),c+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,r,s,a){const o=new Uint8Array(r),l=new Float32Array(s,i);let c=0;for(let u=0;u<t;u++)for(let h=0;h<e;h++){const f=(h+u*e)*4;o[c]=vt(l[f])*255,o[c+1]=vt(l[f+1])*255,o[c+2]=vt(l[f+2])*255,fi.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=vt(l[f+3])*255,c+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,r,s,a){const o=new Uint8Array(r),l=new Uint16Array(s,i);let c=0;for(let u=0;u<t;u++)for(let h=0;h<e;h++){const f=(h+u*e)*4;o[c]=vt(Qs(l[f]))*255,o[c+1]=vt(Qs(l[f+1]))*255,o[c+2]=vt(Qs(l[f+2]))*255,fi.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=vt(Qs(l[f+3]))*255,c+=4}return o}static _GetRGBAArrayBuffer(e,t,i,r,s,a,o,l,c){const u=new Uint8Array(r),h=new Uint8Array(s,i);let f=0;for(let d=0;d<t;d++)for(let p=0;p<e;p++){const _=(p+d*e)*4;u[f]=h[_+a],u[f+1]=h[_+o],u[f+2]=h[_+l],u[f+3]=h[_+c],f+=4}return u}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+fi._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,r,s,a,o,l){const c=new Uint8Array(r),u=new Uint8Array(s,i);let h=0;for(let f=0;f<t;f++)for(let d=0;d<e;d++){const p=(d+f*e)*3;c[h]=u[p+a],c[h+1]=u[p+o],c[h+2]=u[p+l],h+=3}return c}static _GetLuminanceArrayBuffer(e,t,i,r,s){const a=new Uint8Array(r),o=new Uint8Array(s,i);let l=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const h=u+c*e;a[l]=o[h],l++}return a}static UploadDDSLevels(e,t,i,r,s,a,o=-1,l,c=!0){let u=null;r.sphericalPolynomial&&(u=[]);const h=!!e.getCaps().s3tc;t.generateMipMaps=s;const f=new Int32Array(i.buffer,i.byteOffset,Sf);let d,p,_,g=0,E,v,x,A,T=0,C=1;if(f[VD]!==FD){w.Error("Invalid magic number in DDS header");return}if(!r.isFourCC&&!r.isRGB&&!r.isLuminance){w.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(r.isCompressed&&!h){w.Error("Compressed textures are not supported on this platform.");return}let y=f[kD];E=f[UD]+4;let P=!1;if(r.isFourCC)switch(d=f[Wm],d){case Nm:C=8,T=33777;break;case Lm:C=16,T=33778;break;case Fm:C=16,T=33779;break;case wm:P=!0,y=64;break;case Bm:P=!0,y=128;break;case vf:{E+=5*4;let le=!1;switch(r.dxgiFormat){case Um:P=!0,y=64,le=!0;break;case Vm:P=!0,y=128,le=!0;break;case BD:r.isRGB=!0,r.isFourCC=!1,y=32,le=!0;break}if(le)break}default:w.Error(["Unsupported FourCC code:",wD(d)]);return}const D=fi._ExtractLongWordOrder(f[GD]),F=fi._ExtractLongWordOrder(f[zD]),W=fi._ExtractLongWordOrder(f[WD]),H=fi._ExtractLongWordOrder(f[HD]);P&&(T=e._getRGBABufferInternalSizedFormat(r.textureType)),x=1,f[km]&Rm&&s!==!1&&(x=Math.max(1,f[zm]));const ue=l||0,ae=e.getCaps();for(let le=ue;le<a;le++){for(p=f[Tf],_=f[Gm],A=0;A<x;++A){if(o===-1||o===A){const oe=o===-1?A:0;if(!r.isCompressed&&r.isFourCC){t.format=5,g=p*_*4;let ge=null;if(e._badOS||e._badDesktopOS||!ae.textureHalfFloat&&!ae.textureFloat)y===128?(ge=fi._GetFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,oe),u&&oe==0&&u.push(fi._GetFloatRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,oe))):y===64&&(ge=fi._GetHalfFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,oe),u&&oe==0&&u.push(fi._GetHalfFloatAsFloatRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,oe))),t.type=0;else{const Ee=ae.textureFloat&&(c&&ae.textureFloatLinearFiltering||!c),ne=ae.textureHalfFloat&&(c&&ae.textureHalfFloatLinearFiltering||!c),j=(y===128||y===64&&!ne)&&Ee?1:(y===64||y===128&&!Ee)&&ne?2:0;let L,Y=null;switch(y){case 128:{switch(j){case 1:L=fi._GetFloatRGBAArrayBuffer,Y=null;break;case 2:L=fi._GetFloatAsHalfFloatRGBAArrayBuffer,Y=fi._GetFloatRGBAArrayBuffer;break;case 0:L=fi._GetFloatAsUIntRGBAArrayBuffer,Y=fi._GetFloatRGBAArrayBuffer;break}break}default:{switch(j){case 1:L=fi._GetHalfFloatAsFloatRGBAArrayBuffer,Y=null;break;case 2:L=fi._GetHalfFloatRGBAArrayBuffer,Y=fi._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:L=fi._GetHalfFloatAsUIntRGBAArrayBuffer,Y=fi._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=j,ge=L(p,_,i.byteOffset+E,g,i.buffer,oe),u&&oe==0&&u.push(Y?Y(p,_,i.byteOffset+E,g,i.buffer,oe):ge)}ge&&e._uploadDataToTextureDirectly(t,ge,le,oe)}else if(r.isRGB)t.type=0,y===24?(t.format=4,g=p*_*3,v=fi._GetRGBArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,D,F,W),e._uploadDataToTextureDirectly(t,v,le,oe)):(t.format=5,g=p*_*4,v=fi._GetRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,D,F,W,H),e._uploadDataToTextureDirectly(t,v,le,oe));else if(r.isLuminance){const ge=e._getUnpackAlignement(),Ee=p;g=Math.floor((p+ge-1)/ge)*ge*(_-1)+Ee,v=fi._GetLuminanceArrayBuffer(p,_,i.byteOffset+E,g,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,v,le,oe)}else g=Math.max(4,p)/4*Math.max(4,_)/4*C,v=new Uint8Array(i.buffer,i.byteOffset+E,g),t.type=0,e._uploadCompressedDataToTextureDirectly(t,T,p,_,v,le,oe)}E+=y?p*_*(y/8):g,p*=.5,_*=.5,p=Math.max(1,p),_=Math.max(1,_)}if(l!==void 0)break}u&&u.length>0?r.sphericalPolynomial=ol.ConvertCubeMapToSphericalPolynomial({size:f[Tf],right:u[0],left:u[1],up:u[2],down:u[3],front:u[4],back:u[5],format:5,type:1,gammaSpace:!1}):r.sphericalPolynomial=void 0}}fi.StoreLODInAlphaChannel=!1;st.prototype.createPrefilteredCubeTexture=function(n,e,t,i,r=null,s=null,a,o=null,l=!0){const c=u=>{if(!u){r&&r(null);return}const h=u.texture;if(l?u.info.sphericalPolynomial&&(h._sphericalPolynomial=u.info.sphericalPolynomial):h._sphericalPolynomial=new eo,h._source=9,this.getCaps().textureLOD){r&&r(h);return}const f=3,d=this._gl,p=u.width;if(!p)return;const _=[];for(let g=0;g<f;g++){const v=1-g/(f-1),x=i,A=Math.log2(p)*t+i,T=x+(A-x)*v,C=Math.round(Math.min(Math.max(T,0),A)),y=new Yt(this,2);if(y.type=h.type,y.format=h.format,y.width=Math.pow(2,Math.max(Math.log2(p)-C,0)),y.height=y.width,y.isCube=!0,y._cachedWrapU=0,y._cachedWrapV=0,this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,y,!0),y.samplingMode=2,d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),u.isDDS){const D=u.info,F=u.data;this._unpackFlipY(D.isCompressed),fi.UploadDDSLevels(this,y,F,D,!0,6,C)}else w.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null);const P=new jt(e);P._isCube=!0,P._texture=y,y.isReady=!0,_.push(P)}h._lodTextureHigh=_[2],h._lodTextureMid=_[1],h._lodTextureLow=_[0],r&&r(h)};return this.createCubeTexture(n,e,null,!1,c,s,a,o,l,t,i)};st.prototype.createUniformBuffer=function(n,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");const i=new Jl(t);return this.bindUniformBuffer(i),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};st.prototype.createDynamicUniformBuffer=function(n,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");const i=new Jl(t);return this.bindUniformBuffer(i),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};st.prototype.updateUniformBuffer=function(n,e,t,i){this.bindUniformBuffer(n),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};st.prototype.bindUniformBuffer=function(n){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,n?n.underlyingResource:null)};st.prototype.bindUniformBufferBase=function(n,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,n?n.underlyingResource:null)};st.prototype.bindUniformBlock=function(n,e,t){const i=n.program,r=this._gl.getUniformBlockIndex(i,e);r!==4294967295&&this._gl.uniformBlockBinding(i,r,t)};q.prototype.displayLoadingUI=function(){if(!Yi())return;const n=this.loadingScreen;n&&n.displayLoadingUI()};q.prototype.hideLoadingUI=function(){if(!Yi())return;const n=this._loadingScreen;n&&n.hideLoadingUI()};Object.defineProperty(q.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=q.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(n){this._loadingScreen=n},enumerable:!0,configurable:!0});Object.defineProperty(q.prototype,"loadingUIText",{set:function(n){this.loadingScreen.loadingUIText=n},enumerable:!0,configurable:!0});Object.defineProperty(q.prototype,"loadingUIBackgroundColor",{set:function(n){this.loadingScreen.loadingUIBackgroundColor=n},enumerable:!0,configurable:!0});q.prototype.getInputElement=function(){return this._renderingCanvas};q.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null};q.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null};q.prototype.getAspectRatio=function(n,e=!1){const t=n.viewport;return this.getRenderWidth(e)*t.width/(this.getRenderHeight(e)*t.height)};q.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)};q.prototype._verifyPointerLock=function(){var n;(n=this._onPointerLockChange)==null||n.call(this)};q.prototype.setAlphaEquation=function(n){if(this._alphaEquation!==n){switch(n){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=n}};q.prototype.getInputElement=function(){return this._renderingCanvas};q.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};q.prototype.setDepthFunction=function(n){this._depthCullingState.depthFunc=n};q.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)};q.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)};q.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)};q.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)};q.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};q.prototype.setDepthWrite=function(n){this._depthCullingState.depthMask=n};q.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};q.prototype.setStencilBuffer=function(n){this._stencilState.stencilTest=n};q.prototype.getStencilMask=function(){return this._stencilState.stencilMask};q.prototype.setStencilMask=function(n){this._stencilState.stencilMask=n};q.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};q.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};q.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};q.prototype.setStencilFunction=function(n){this._stencilState.stencilFunc=n};q.prototype.setStencilFunctionReference=function(n){this._stencilState.stencilFuncRef=n};q.prototype.setStencilFunctionMask=function(n){this._stencilState.stencilFuncMask=n};q.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};q.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};q.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};q.prototype.setStencilOperationFail=function(n){this._stencilState.stencilOpStencilFail=n};q.prototype.setStencilOperationDepthFail=function(n){this._stencilState.stencilOpDepthFail=n};q.prototype.setStencilOperationPass=function(n){this._stencilState.stencilOpStencilDepthPass=n};q.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()};q.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)};q.prototype.setAlphaConstants=function(n,e,t,i){this._alphaState.setAlphaBlendConstants(n,e,t,i)};q.prototype.getAlphaMode=function(){return this._alphaMode};q.prototype.getAlphaEquation=function(){return this._alphaEquation};q.prototype.getRenderPassNames=function(){return this._renderPassNames};q.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]};q.prototype.createRenderPassId=function(n){const e=++q._RenderPassIdCounter;return this._renderPassNames[e]=n??"NONAME",e};q.prototype.releaseRenderPassId=function(n){this._renderPassNames[n]=void 0;for(let e=0;e<this.scenes.length;++e){const t=this.scenes[e];for(let i=0;i<t.meshes.length;++i){const r=t.meshes[i];if(r.subMeshes)for(let s=0;s<r.subMeshes.length;++s)r.subMeshes[s]._removeDrawWrapper(n)}}};function $D(n){!n||!n.setAttribute||(n.setAttribute("touch-action","none"),n.style.touchAction="none",n.style.webkitTapHighlightColor="transparent")}function gT(n,e,t){n._onCanvasFocus=()=>{n.onCanvasFocusObservable.notifyObservers(n)},n._onCanvasBlur=()=>{n.onCanvasBlurObservable.notifyObservers(n)},n._onCanvasContextMenu=r=>{n.disableContextMenu&&r.preventDefault()},e.addEventListener("focus",n._onCanvasFocus),e.addEventListener("blur",n._onCanvasBlur),e.addEventListener("contextmenu",n._onCanvasContextMenu),n._onBlur=()=>{n.disablePerformanceMonitorInBackground&&n.performanceMonitor.disable(),n._windowIsBackground=!0},n._onFocus=()=>{n.disablePerformanceMonitorInBackground&&n.performanceMonitor.enable(),n._windowIsBackground=!1},n._onCanvasPointerOut=r=>{document.elementFromPoint(r.clientX,r.clientY)!==e&&n.onCanvasPointerOutObservable.notifyObservers(r)};const i=n.getHostWindow();i&&typeof i.addEventListener=="function"&&(i.addEventListener("blur",n._onBlur),i.addEventListener("focus",n._onFocus)),e.addEventListener("pointerout",n._onCanvasPointerOut),t.doNotHandleTouchAction||$D(e),!q.audioEngine&&t.audioEngine&&q.AudioEngineFactory&&(q.audioEngine=q.AudioEngineFactory(n.getRenderingCanvas(),n.getAudioContext(),n.getAudioDestination())),kl()&&(n._onFullscreenChange=()=>{n.isFullscreen=!!document.fullscreenElement,n.isFullscreen&&n._pointerLockRequested&&e&&fp(e)},document.addEventListener("fullscreenchange",n._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",n._onFullscreenChange,!1),n._onPointerLockChange=()=>{n.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",n._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",n._onPointerLockChange,!1)),n.enableOfflineSupport=q.OfflineProviderFactory!==void 0,n._deterministicLockstep=!!t.deterministicLockstep,n._lockstepMaxSteps=t.lockstepMaxSteps||0,n._timeStep=t.timeStep||1/60}function ET(n,e){$e.Instances.length===1&&q.audioEngine&&(q.audioEngine.dispose(),q.audioEngine=null);const t=n.getHostWindow();t&&typeof t.removeEventListener=="function"&&(t.removeEventListener("blur",n._onBlur),t.removeEventListener("focus",n._onFocus)),e&&(e.removeEventListener("focus",n._onCanvasFocus),e.removeEventListener("blur",n._onCanvasBlur),e.removeEventListener("pointerout",n._onCanvasPointerOut),e.removeEventListener("contextmenu",n._onCanvasContextMenu)),kl()&&(document.removeEventListener("fullscreenchange",n._onFullscreenChange),document.removeEventListener("mozfullscreenchange",n._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",n._onFullscreenChange),document.removeEventListener("msfullscreenchange",n._onFullscreenChange),document.removeEventListener("pointerlockchange",n._onPointerLockChange),document.removeEventListener("mspointerlockchange",n._onPointerLockChange),document.removeEventListener("mozpointerlockchange",n._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",n._onPointerLockChange))}function vT(n){const e=document.createElement("span");e.textContent="Hg",e.style.font=n;const t=document.createElement("div");t.style.display="inline-block",t.style.width="1px",t.style.height="0px",t.style.verticalAlign="bottom";const i=document.createElement("div");i.style.whiteSpace="nowrap",i.appendChild(e),i.appendChild(t),document.body.appendChild(i);let r=0,s=0;try{s=t.getBoundingClientRect().top-e.getBoundingClientRect().top,t.style.verticalAlign="baseline",r=t.getBoundingClientRect().top-e.getBoundingClientRect().top}finally{document.body.removeChild(i)}return{ascent:r,height:s,descent:s-r}}function ST(n,e,t){return new Promise((r,s)=>{const a=new Image;a.onload=()=>{a.decode().then(()=>{n.createImageBitmap(a,t).then(o=>{r(o)})})},a.onerror=()=>{s(`Error loading image ${a.src}`)},a.src=e})}function TT(n,e,t,i){const s=n.createCanvas(t,i).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(e,0,0),s.getImageData(0,0,t,i).data}function xT(n){const e=n.requestFullscreen||n.webkitRequestFullscreen;e&&e.call(n)}function CT(){const n=document;document.exitFullscreen?document.exitFullscreen():n.webkitCancelFullScreen&&n.webkitCancelFullScreen()}function fp(n){if(n.requestPointerLock){const e=n.requestPointerLock();e instanceof Promise?e.then(()=>{n.focus()}).catch(()=>{}):n.focus()}}function AT(){document.exitPointerLock&&document.exitPointerLock()}class ps{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){ps.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){ps.Enabled&&(this._startMonitoringTime=Tr.Now)}endMonitoring(e=!0){if(!ps.Enabled)return;e&&this.fetchNewFrame();const t=Tr.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Tr.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}ps.Enabled=!0;q.AudioEngineFactory=(n,e,t)=>new KD(n,e,t);class KD{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new Q,this.onAudioLockedObservable=new Q,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!Yi())return;typeof window.AudioContext<"u"&&(this.canUseWebAudio=!0);const r=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{r&&r.canPlayType&&(r.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||r.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{r&&r.canPlayType&&r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}lock(){this._triggerSuspendedState()}unlock(){var e,t;if(((e=this._audioContext)==null?void 0:e.state)==="running"){this._hideMuteButton(),this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._tryToRun?(t=this._audioContext)==null||t.suspend().then(()=>{this._tryToRun=!1,this._triggerRunningState()}):this._triggerRunningState()}_resumeAudioContextOnStateChange(){var e;(e=this._audioContext)==null||e.addEventListener("statechange",()=>{var t;this.unlocked&&((t=this._audioContext)==null?void 0:t.state)!=="running"&&this._resumeAudioContext()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContext(){var e;return(e=this._audioContext)!=null&&e.resume?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,w.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this.unlock()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}class Se extends st{static get NpmPackage(){return q.NpmPackage}static get Version(){return q.Version}static get Instances(){return $e.Instances}static get LastCreatedEngine(){return $e.LastCreatedEngine}static get LastCreatedScene(){return $e.LastCreatedScene}static DefaultLoadingScreenFactory(e){return q.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!Se._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,i,r=!1){if(super(e,t,i,r),this.customAnimationFrameRequester=null,this._performanceMonitor=new $S,this._drawCalls=new ps,!!e&&(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext)){const s=e;this._sharedInit(s)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),gT(this,e,this._creationOptions)}resizeImageBitmap(e,t,i){return TT(this,e,t,i)}_createImageBitmapFromSource(e,t){return ST(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&xT(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&CT()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,i,r){const s=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),s}scissorClear(e,t,i,r,s){this.enableScissor(e,t,i,r),this.clear(s,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){const s=this._gl;s.enable(s.SCISSOR_TEST),s.scissor(e,t,i,r)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_loadFileAsync(e,t,i){return new Promise((r,s)=>{this._loadFile(e,a=>{r(a)},void 0,t,i,(a,o)=>{s(o)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return vT(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(this._frameHandler!==0){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&this._frameHandler===0&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&fp(this._renderingCanvas)}exitPointerlock(){AT()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,s,a=null){s=s||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,r,s,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,r,s=null){const a=r.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");if(r.attachShader(a,t),r.attachShader(a,i),this.webGLVersion>1&&s){const o=this.createTransformFeedback();this.bindTransformFeedback(o),this.setTranformFeedbackVaryings(a,s),e.transformFeedback=o}return r.linkProgram(a),this.webGLVersion>1&&s&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),a}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(r=>{r&&r._outputTexture===e&&(r._outputTexture=null)})})})}_rescaleTexture(e,t,i,r,s){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const a=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&Se._RescalePostProcessFactory&&(this._rescalePostProcess=Se._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const o=()=>{this._rescalePostProcess.onApply=function(u){u._bindTexture("textureSampler",e)};let c=i;c||(c=this.scenes[this.scenes.length-1]),c.postProcessManager.directRender([this._rescalePostProcess],a,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(a),a.dispose(),s&&s()},l=this._rescalePostProcess.getEffect();l?l.executeWhenCompiled(o):this._rescalePostProcess.onEffectCreatedObservable.addOnce(c=>{c.executeWhenCompiled(o)})}}wrapWebGLTexture(e,t=!1,i=3,r=0,s=0){const a=new YS(e,this._gl),o=new Yt(this,0,!0);return o._hardwareTexture=a,o.baseWidth=r,o.baseHeight=s,o.width=r,o.height=s,o.isReady=!0,o.useMipMaps=t,this.updateTextureSamplingMode(i,o),o}_uploadImageToTexture(e,t,i=0,r=0){const s=this._gl,a=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,o),c=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let u=s.TEXTURE_2D;e.isCube&&(u=s.TEXTURE_CUBE_MAP_POSITIVE_X+i),s.texImage2D(u,r,l,o,a,t),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){w.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new Jl(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const r=this._gl;return new Promise((s,a)=>{const o=()=>{const l=r.clientWaitSync(e,t,0);if(l==r.WAIT_FAILED){a();return}if(l==r.TIMEOUT_EXPIRED){setTimeout(o,i);return}s()};o()})}_readPixelsAsync(e,t,i,r,s,a,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,c=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.bufferData(l.PIXEL_PACK_BUFFER,o.byteLength,l.STREAM_READ),l.readPixels(e,t,i,r,s,a,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const u=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(l.flush(),this._clientWaitAsync(u,0,10).then(()=>(l.deleteSync(u),l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,o),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(c),o))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),ET(this,this._renderingCanvas),super.dispose()}}Se.ALPHA_DISABLE=0;Se.ALPHA_ADD=1;Se.ALPHA_COMBINE=2;Se.ALPHA_SUBTRACT=3;Se.ALPHA_MULTIPLY=4;Se.ALPHA_MAXIMIZED=5;Se.ALPHA_ONEONE=6;Se.ALPHA_PREMULTIPLIED=7;Se.ALPHA_PREMULTIPLIED_PORTERDUFF=8;Se.ALPHA_INTERPOLATE=9;Se.ALPHA_SCREENMODE=10;Se.DELAYLOADSTATE_NONE=0;Se.DELAYLOADSTATE_LOADED=1;Se.DELAYLOADSTATE_LOADING=2;Se.DELAYLOADSTATE_NOTLOADED=4;Se.NEVER=512;Se.ALWAYS=519;Se.LESS=513;Se.EQUAL=514;Se.LEQUAL=515;Se.GREATER=516;Se.GEQUAL=518;Se.NOTEQUAL=517;Se.KEEP=7680;Se.REPLACE=7681;Se.INCR=7682;Se.DECR=7683;Se.INVERT=5386;Se.INCR_WRAP=34055;Se.DECR_WRAP=34056;Se.TEXTURE_CLAMP_ADDRESSMODE=0;Se.TEXTURE_WRAP_ADDRESSMODE=1;Se.TEXTURE_MIRROR_ADDRESSMODE=2;Se.TEXTUREFORMAT_ALPHA=0;Se.TEXTUREFORMAT_LUMINANCE=1;Se.TEXTUREFORMAT_LUMINANCE_ALPHA=2;Se.TEXTUREFORMAT_RGB=4;Se.TEXTUREFORMAT_RGBA=5;Se.TEXTUREFORMAT_RED=6;Se.TEXTUREFORMAT_R=6;Se.TEXTUREFORMAT_RG=7;Se.TEXTUREFORMAT_RED_INTEGER=8;Se.TEXTUREFORMAT_R_INTEGER=8;Se.TEXTUREFORMAT_RG_INTEGER=9;Se.TEXTUREFORMAT_RGB_INTEGER=10;Se.TEXTUREFORMAT_RGBA_INTEGER=11;Se.TEXTURETYPE_UNSIGNED_BYTE=0;Se.TEXTURETYPE_UNSIGNED_INT=0;Se.TEXTURETYPE_FLOAT=1;Se.TEXTURETYPE_HALF_FLOAT=2;Se.TEXTURETYPE_BYTE=3;Se.TEXTURETYPE_SHORT=4;Se.TEXTURETYPE_UNSIGNED_SHORT=5;Se.TEXTURETYPE_INT=6;Se.TEXTURETYPE_UNSIGNED_INTEGER=7;Se.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;Se.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;Se.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;Se.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;Se.TEXTURETYPE_UNSIGNED_INT_24_8=12;Se.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;Se.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;Se.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;Se.TEXTURE_NEAREST_SAMPLINGMODE=1;Se.TEXTURE_BILINEAR_SAMPLINGMODE=2;Se.TEXTURE_TRILINEAR_SAMPLINGMODE=3;Se.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;Se.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;Se.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;Se.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;Se.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;Se.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;Se.TEXTURE_NEAREST_LINEAR=7;Se.TEXTURE_NEAREST_NEAREST=1;Se.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;Se.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;Se.TEXTURE_LINEAR_LINEAR=2;Se.TEXTURE_LINEAR_NEAREST=12;Se.TEXTURE_EXPLICIT_MODE=0;Se.TEXTURE_SPHERICAL_MODE=1;Se.TEXTURE_PLANAR_MODE=2;Se.TEXTURE_CUBIC_MODE=3;Se.TEXTURE_PROJECTION_MODE=4;Se.TEXTURE_SKYBOX_MODE=5;Se.TEXTURE_INVCUBIC_MODE=6;Se.TEXTURE_EQUIRECTANGULAR_MODE=7;Se.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;Se.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;Se.SCALEMODE_FLOOR=1;Se.SCALEMODE_NEAREST=2;Se.SCALEMODE_CEILING=3;function sd(n,e,t){try{const i=n.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function nd(n=25){let e;return(t,i,r)=>{const s=performance.now();e===void 0||s-e>n?(e=s,setTimeout(()=>{sd(t,i,r)},0)):sd(t,i,r)}}function IT(n,e,t,i,r){const s=()=>{let a;const o=l=>{l.done?t(l.value):a===void 0?a=!0:s()};do a=void 0,e(n,o,i),a===void 0&&(a=!1);while(a)};s()}function rh(n,e){let t;return IT(n,sd,i=>t=i,i=>{throw i}),t}function ad(n,e,t){return new Promise((i,r)=>{IT(n,e,i,r)})}function jD(n,e){return(...t)=>rh(n(...t))}class od{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class hs{constructor(e,t,i){this.vectors=ms(8,m.Zero),this.center=m.Zero(),this.centerWorld=m.Zero(),this.extendSize=m.Zero(),this.extendSizeWorld=m.Zero(),this.directions=ms(3,m.Zero),this.vectorsWorld=ms(8,m.Zero),this.minimumWorld=m.Zero(),this.maximumWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const r=e.x,s=e.y,a=e.z,o=t.x,l=t.y,c=t.z,u=this.vectors;this.minimum.copyFromFloats(r,s,a),this.maximum.copyFromFloats(o,l,c),u[0].copyFromFloats(r,s,a),u[1].copyFromFloats(o,l,c),u[2].copyFromFloats(o,s,a),u[3].copyFromFloats(r,l,a),u[4].copyFromFloats(r,s,c),u[5].copyFromFloats(o,l,a),u[6].copyFromFloats(r,l,c),u[7].copyFromFloats(o,s,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||O.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=hs._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);const s=r*e,a=i.scaleInPlace(s*.5),o=this.center.subtractToRef(a,t[1]),l=this.center.addToRef(a,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,r=this.directions,s=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)s[o].copyFrom(a[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){const l=s[o];m.TransformCoordinatesToRef(a[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}m.FromArrayToRef(e.m,0,r[0]),m.FromArrayToRef(e.m,4,r[1]),m.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return hs.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return hs.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,r=t.x,s=t.y,a=t.z,o=i.x,l=i.y,c=i.z,u=e.x,h=e.y,f=e.z,d=-pt;return!(o-u<d||d>u-r||l-h<d||d>h-s||c-f<d||d>f-a)}intersectsSphere(e){return hs.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,r=this.maximumWorld,s=i.x,a=i.y,o=i.z,l=r.x,c=r.y,u=r.z,h=e.x,f=e.y,d=e.z,p=t.x,_=t.y,g=t.z;return!(l<h||s>p||c<f||a>_||u<d||o>g)}dispose(){var e,t;(e=this._drawWrapperFront)==null||e.dispose(),(t=this._drawWrapperBack)==null||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){const s=hs._TmpVector3[0];return m.ClampToRef(i,e,t,s),m.DistanceSquared(i,s)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const r=t[i];for(let s=0;s<8;++s)if(r.dotCoordinate(e[s])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0;const s=t[i];for(let a=0;a<8;++a)if(s.dotCoordinate(e[a])>=0){r=!1;break}if(r)return!1}return!0}}hs._TmpVector3=ms(3,m.Zero);class $a{constructor(e,t,i){this.center=m.Zero(),this.centerWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const r=m.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||O.IdentityReadOnly)}scale(e){const t=this.radius*e,i=$a._TmpVector3,r=i[0].setAll(t),s=this.center.subtractToRef(r,i[1]),a=this.center.addToRef(r,i[2]);return this.reConstruct(s,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{m.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=$a._TmpVector3[0];m.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=m.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=m.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const r=new $a(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=O.Identity(),r}}$a._TmpVector3=ms(3,m.Zero);const Cf={min:0,max:0},Af={min:0,max:0},Hm=(n,e,t)=>{const i=m.Dot(e.centerWorld,n),r=Math.abs(m.Dot(e.directions[0],n))*e.extendSize.x,s=Math.abs(m.Dot(e.directions[1],n))*e.extendSize.y,a=Math.abs(m.Dot(e.directions[2],n))*e.extendSize.z,o=r+s+a;t.min=i-o,t.max=i+o},Hr=(n,e,t)=>(Hm(n,e,Cf),Hm(n,t,Af),!(Cf.min>Af.max||Af.min>Cf.max));class Jr{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new hs(e,t,i),this.boundingSphere=new $a(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Jr._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=Jr._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=m.Minimize(this.minimum,e),i=m.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=B.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=B.Vector3[0];return m.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),m.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Jr._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!$a.Intersects(this.boundingSphere,e.boundingSphere)||!hs.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,r=e.boundingBox;return!(!Hr(i.directions[0],i,r)||!Hr(i.directions[1],i,r)||!Hr(i.directions[2],i,r)||!Hr(r.directions[0],i,r)||!Hr(r.directions[1],i,r)||!Hr(r.directions[2],i,r)||!Hr(m.Cross(i.directions[0],r.directions[0]),i,r)||!Hr(m.Cross(i.directions[0],r.directions[1]),i,r)||!Hr(m.Cross(i.directions[0],r.directions[2]),i,r)||!Hr(m.Cross(i.directions[1],r.directions[0]),i,r)||!Hr(m.Cross(i.directions[1],r.directions[1]),i,r)||!Hr(m.Cross(i.directions[1],r.directions[2]),i,r)||!Hr(m.Cross(i.directions[2],r.directions[0]),i,r)||!Hr(m.Cross(i.directions[2],r.directions[1]),i,r)||!Hr(m.Cross(i.directions[2],r.directions[2]),i,r))}}Jr._TmpVector3=ms(2,m.Zero);class sh{static extractMinAndMaxIndexed(e,t,i,r,s,a){for(let o=i;o<i+r;o++){const l=t[o]*3,c=e[l],u=e[l+1],h=e[l+2];s.minimizeInPlaceFromFloats(c,u,h),a.maximizeInPlaceFromFloats(c,u,h)}}static extractMinAndMax(e,t,i,r,s,a){for(let o=t,l=t*r;o<t+i;o++,l+=r){const c=e[l],u=e[l+1],h=e[l+2];s.minimizeInPlaceFromFloats(c,u,h),a.maximizeInPlaceFromFloats(c,u,h)}}}I([Xn.filter((...[n,e])=>!Array.isArray(n)&&!Array.isArray(e))],sh,"extractMinAndMaxIndexed",null);I([Xn.filter((...[n])=>!Array.isArray(n))],sh,"extractMinAndMax",null);function qD(n,e,t,i,r=null){const s=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return sh.extractMinAndMaxIndexed(n,e,t,i,s,a),r&&(s.x-=s.x*r.x+r.y,s.y-=s.y*r.x+r.y,s.z-=s.z*r.x+r.y,a.x+=a.x*r.x+r.y,a.y+=a.y*r.x+r.y,a.z+=a.z*r.x+r.y),{minimum:s,maximum:a}}function to(n,e,t,i=null,r){const s=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),sh.extractMinAndMax(n,e,t,r,s,a),i&&(s.x-=s.x*i.x+i.y,s.y-=s.y*i.x+i.y,s.z-=s.z*i.x+i.y,a.x+=a.x*i.x+i.y,a.y+=a.y*i.x+i.y,a.z+=a.z*i.x+i.y),{minimum:s,maximum:a}}function ZD(n,e){const t=to(n,0,n.length/3),i=t.maximum.subtract(t.minimum).scale(.5).add(t.minimum),r=new m,s=new m,a=new m,o=new m,l=new m,c=new m,u=new m;for(let h=0;h<e.length;h+=3){const f=e[h],d=e[h+1],p=e[h+2];r.fromArray(n,f*3),s.fromArray(n,d*3),a.fromArray(n,p*3),s.subtractToRef(r,o),a.subtractToRef(r,l),m.CrossToRef(o,l,c),c.normalize();const _=r.x+s.x+a.x,g=r.y+s.y+a.y,E=r.z+s.z+a.z;u.set(_/3,g/3,E/3),u.subtractInPlace(i),u.normalize(),m.Dot(c,u)>=0&&(e[h]=p,e[h+2]=f)}}class _r{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())==null?void 0:e.defines}set materialDefines(e){const t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new ds(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&((i=this._drawWrappers[e])==null||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:((e=this._getDrawWrapper())==null?void 0:e.effect)??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){const s=this._drawWrapper;s.setEffect(e,t,r),i!==void 0&&(s.materialContext=i),e||(s.defines=null,s.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const t of this._drawWrappers)t==null||t.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,r,s,a,o,l=!0){return new _r(e,t,i,r,s,a,o,l)}constructor(e,t,i,r,s,a,o,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,c&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,l&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){const t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){const i=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==i&&(this._currentMaterial=i,this.resetDrawCache()),i}}else return e?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(b.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=qD(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Jr(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,s){const a=this.getMaterial();if(!a)return null;let o=3,l=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break}return a.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,s):this._intersectTriangles(e,t,i,o,l,r,s)}_intersectLines(e,t,i,r,s){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const l=t[i[o]],c=t[i[o+1]],u=e.intersectionSegment(l,c,r);if(!(u<0)&&(s||!a||u<a.distance)&&(a=new od(null,null,u),a.faceId=o/2,s))break}return a}_intersectUnIndexedLines(e,t,i,r,s){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){const l=t[o],c=t[o+1],u=e.intersectionSegment(l,c,r);if(!(u<0)&&(s||!a||u<a.distance)&&(a=new od(null,null,u),a.faceId=o/2,s))break}return a}_intersectTriangles(e,t,i,r,s,a,o){let l=null,c=-1;for(let u=this.indexStart;u<this.indexStart+this.indexCount-(3-r);u+=r){c++;const h=i[u],f=i[u+1],d=i[u+2];if(s&&d===4294967295){u+=2;continue}const p=t[h],_=t[f],g=t[d];if(!p||!_||!g||o&&!o(p,_,g,e,h,f,d))continue;const E=e.intersectsTriangle(p,_,g);if(E){if(E.distance<0)continue;if((a||!l||E.distance<l.distance)&&(l=E,l.faceId=c,a))break}}return l}_intersectUnIndexedTriangles(e,t,i,r,s){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=t[o],c=t[o+1],u=t[o+2];if(s&&!s(l,c,u,e,-1,-1,-1))continue;const h=e.intersectsTriangle(l,c,u);if(h){if(h.distance<0)continue;if((r||!a||h.distance<a.distance)&&(a=h,a.faceId=o/3,r))break}}return a}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new _r(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new Jr(r.minimum,r.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,s,a=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE;const u=(s||r).getIndices();for(let h=t;h<t+i;h++){const f=u[h];f<o&&(o=f),f>l&&(l=f)}return new _r(e,o,l-o+1,t,i,r,s,a)}}class uu{}class de{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=jD(this._applyToCoroutine.bind(this)),this.uniqueId=de._UniqueIDGenerator,de._UniqueIDGenerator++}set(e,t){switch(e.length||w.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case b.PositionKind:this.positions=e;break;case b.NormalKind:this.normals=e;break;case b.TangentKind:this.tangents=e;break;case b.UVKind:this.uvs=e;break;case b.UV2Kind:this.uvs2=e;break;case b.UV3Kind:this.uvs3=e;break;case b.UV4Kind:this.uvs4=e;break;case b.UV5Kind:this.uvs5=e;break;case b.UV6Kind:this.uvs6=e;break;case b.ColorKind:this.colors=e;break;case b.MatricesIndicesKind:this.matricesIndices=e;break;case b.MatricesWeightsKind:this.matricesWeights=e;break;case b.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case b.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(b.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(b.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(b.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(b.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(b.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(b.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(b.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(b.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(b.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(b.ColorKind,this.colors,t),this.hasVertexAlpha&&e.hasVertexAlpha!==void 0&&(e.hasVertexAlpha=!0),i&&(yield)),this.matricesIndices&&(e.setVerticesData(b.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(b.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(b.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(b.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const r=e;r.subMeshes=[];for(const s of this.materialInfos)new _r(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,r)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(b.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(b.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(b.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(b.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(b.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(b.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(b.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(b.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(b.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(b.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(b.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(b.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(b.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(b.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){const s=B.Vector3[0],a=B.Vector3[1];for(let o=i;o<i+r;o+=3)m.FromArrayToRef(e,o,s),m.TransformCoordinatesToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,i=0,r=e.length){const s=B.Vector3[0],a=B.Vector3[1];for(let o=i;o<i+r;o+=3)m.FromArrayToRef(e,o,s),m.TransformNormalToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,i=0,r=e.length){const s=B.Vector4[0],a=B.Vector4[1];for(let o=i;o<i+r;o+=4)We.FromArrayToRef(e,o,s),We.TransformNormalToRef(s,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){const s=e[r+1];e[r+1]=e[r+2],e[r+2]=s}}transform(e){const t=e.determinant()<0;return this.positions&&de._TransformVector3Coordinates(this.positions,e),this.normals&&de._TransformVector3Normals(this.normals,e),this.tangents&&de._TransformVector4Normals(this.tangents,e),t&&this.indices&&de._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const i=new de;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let s=t.indexStart;s<t.indexStart+t.indexCount;s++)i.indices.push(this.indices[s]-t.verticesStart)}const r=new uu;r.indexStart=0,r.indexCount=i.indices?i.indices.length:0,r.materialIndex=t.materialIndex,r.verticesStart=0,r.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[r],e.push(i)}return e}merge(e,t=!1,i=!1,r=!1,s=!1){const a=Array.isArray(e)?e.map(o=>({vertexData:o})):[{vertexData:e}];return rh(this._mergeCoroutine(void 0,a,t,!1,i,r,s))}*_mergeCoroutine(e,t,i=!1,r,s,a=!1,o=!1){var d,p;this._validate();let l=t.map(_=>_.vertexData),c=this;if(o)for(const _ of l)_&&(_._validate(),!this.normals&&_.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&_.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&_.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&_.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&_.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&_.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&_.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&_.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&_.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&_.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&_.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&_.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&_.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const _ of l)if(_){if(o)this.normals&&!_.normals&&(_.normals=new Float32Array(_.positions.length)),this.tangents&&!_.tangents&&(_.tangents=new Float32Array(_.positions.length/3*4)),this.uvs&&!_.uvs&&(_.uvs=new Float32Array(_.positions.length/3*2)),this.uvs2&&!_.uvs2&&(_.uvs2=new Float32Array(_.positions.length/3*2)),this.uvs3&&!_.uvs3&&(_.uvs3=new Float32Array(_.positions.length/3*2)),this.uvs4&&!_.uvs4&&(_.uvs4=new Float32Array(_.positions.length/3*2)),this.uvs5&&!_.uvs5&&(_.uvs5=new Float32Array(_.positions.length/3*2)),this.uvs6&&!_.uvs6&&(_.uvs6=new Float32Array(_.positions.length/3*2)),this.colors&&!_.colors&&(_.colors=new Float32Array(_.positions.length/3*4),_.colors.fill(1)),this.matricesIndices&&!_.matricesIndices&&(_.matricesIndices=new Float32Array(_.positions.length/3*4)),this.matricesWeights&&!_.matricesWeights&&(_.matricesWeights=new Float32Array(_.positions.length/3*4)),this.matricesIndicesExtra&&!_.matricesIndicesExtra&&(_.matricesIndicesExtra=new Float32Array(_.positions.length/3*4)),this.matricesWeightsExtra&&!_.matricesWeightsExtra&&(_.matricesWeightsExtra=new Float32Array(_.positions.length/3*4));else if(_._validate(),!this.normals!=!_.normals||!this.tangents!=!_.tangents||!this.uvs!=!_.uvs||!this.uvs2!=!_.uvs2||!this.uvs3!=!_.uvs3||!this.uvs4!=!_.uvs4||!this.uvs5!=!_.uvs5||!this.uvs6!=!_.uvs6||!this.colors!=!_.colors||!this.matricesIndices!=!_.matricesIndices||!this.matricesWeights!=!_.matricesWeights||!this.matricesIndicesExtra!=!_.matricesIndicesExtra||!this.matricesWeightsExtra!=!_.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(a){let _=0,g=0,E=0;const v=[];let x=null;const A=[];for(const C of this.splitBasedOnMaterialID())A.push({vertexData:C,transform:e});for(const C of t)if(C.vertexData)for(const y of C.vertexData.splitBasedOnMaterialID())A.push({vertexData:y,transform:C.transform});A.sort((C,y)=>{const P=C.vertexData.materialInfos?C.vertexData.materialInfos[0].materialIndex:0,D=y.vertexData.materialInfos?y.vertexData.materialInfos[0].materialIndex:0;return P>D?1:P===D?0:-1});for(const C of A){const y=C.vertexData;if(y.materialInfos?_=y.materialInfos[0].materialIndex:_=0,x&&x.materialIndex===_)x.indexCount+=y.indices.length,x.verticesCount+=y.positions.length/3;else{const P=new uu;P.materialIndex=_,P.indexStart=g,P.indexCount=y.indices.length,P.verticesStart=E,P.verticesCount=y.positions.length/3,v.push(P),x=P}g+=y.indices.length,E+=y.positions.length/3}const T=A.splice(0,1)[0];c=T.vertexData,e=T.transform,l=A.map(C=>C.vertexData),t=A,this.materialInfos=v}const u=l.reduce((_,g)=>{var E;return _+(((E=g.indices)==null?void 0:E.length)??0)},((d=c.indices)==null?void 0:d.length)??0);let f=s||l.some(_=>_.indices===c.indices)?(p=c.indices)==null?void 0:p.slice():c.indices;if(u>0){let _=(f==null?void 0:f.length)??0;if(f||(f=new Array(u)),f.length!==u){if(Array.isArray(f))f.length=u;else{const E=i||f instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u);E.set(f),f=E}e&&e.determinant()<0&&de._FlipFaces(f,0,_)}let g=c.positions?c.positions.length/3:0;for(const{vertexData:E,transform:v}of t)if(E.indices){for(let x=0;x<E.indices.length;x++)f[_+x]=E.indices[x]+g;v&&v.determinant()<0&&de._FlipFaces(f,_,E.indices.length),g+=E.positions.length/3,_+=E.indices.length,r&&(yield)}}return this.indices=f,this.positions=de._MergeElement(b.PositionKind,c.positions,e,t.map(_=>[_.vertexData.positions,_.transform])),r&&(yield),c.normals&&(this.normals=de._MergeElement(b.NormalKind,c.normals,e,t.map(_=>[_.vertexData.normals,_.transform])),r&&(yield)),c.tangents&&(this.tangents=de._MergeElement(b.TangentKind,c.tangents,e,t.map(_=>[_.vertexData.tangents,_.transform])),r&&(yield)),c.uvs&&(this.uvs=de._MergeElement(b.UVKind,c.uvs,e,t.map(_=>[_.vertexData.uvs,_.transform])),r&&(yield)),c.uvs2&&(this.uvs2=de._MergeElement(b.UV2Kind,c.uvs2,e,t.map(_=>[_.vertexData.uvs2,_.transform])),r&&(yield)),c.uvs3&&(this.uvs3=de._MergeElement(b.UV3Kind,c.uvs3,e,t.map(_=>[_.vertexData.uvs3,_.transform])),r&&(yield)),c.uvs4&&(this.uvs4=de._MergeElement(b.UV4Kind,c.uvs4,e,t.map(_=>[_.vertexData.uvs4,_.transform])),r&&(yield)),c.uvs5&&(this.uvs5=de._MergeElement(b.UV5Kind,c.uvs5,e,t.map(_=>[_.vertexData.uvs5,_.transform])),r&&(yield)),c.uvs6&&(this.uvs6=de._MergeElement(b.UV6Kind,c.uvs6,e,t.map(_=>[_.vertexData.uvs6,_.transform])),r&&(yield)),c.colors&&(this.colors=de._MergeElement(b.ColorKind,c.colors,e,t.map(_=>[_.vertexData.colors,_.transform])),(c.hasVertexAlpha!==void 0||t.some(_=>_.vertexData.hasVertexAlpha!==void 0))&&(this.hasVertexAlpha=c.hasVertexAlpha||t.some(_=>_.vertexData.hasVertexAlpha)),r&&(yield)),c.matricesIndices&&(this.matricesIndices=de._MergeElement(b.MatricesIndicesKind,c.matricesIndices,e,t.map(_=>[_.vertexData.matricesIndices,_.transform])),r&&(yield)),c.matricesWeights&&(this.matricesWeights=de._MergeElement(b.MatricesWeightsKind,c.matricesWeights,e,t.map(_=>[_.vertexData.matricesWeights,_.transform])),r&&(yield)),c.matricesIndicesExtra&&(this.matricesIndicesExtra=de._MergeElement(b.MatricesIndicesExtraKind,c.matricesIndicesExtra,e,t.map(_=>[_.vertexData.matricesIndicesExtra,_.transform])),r&&(yield)),c.matricesWeightsExtra&&(this.matricesWeightsExtra=de._MergeElement(b.MatricesWeightsExtraKind,c.matricesWeightsExtra,e,t.map(_=>[_.vertexData.matricesWeightsExtra,_.transform]))),this}static _MergeElement(e,t,i,r){const s=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&s.length==0)return t;if(!t)return this._MergeElement(e,s[0][0],s[0][1],s.slice(1));const a=s.reduce((l,c)=>l+c[0].length,t.length),o=e===b.PositionKind?de._TransformVector3Coordinates:e===b.NormalKind?de._TransformVector3Normals:e===b.TangentKind?de._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(a);l.set(t),i&&o(l,i,0,t.length);let c=t.length;for(const[u,h]of s)l.set(u,c),h&&o(l,h,c,u.length),c+=u.length;return l}else{const l=new Array(a);for(let u=0;u<t.length;u++)l[u]=t[u];i&&o(l,i,0,t.length);let c=t.length;for(const[u,h]of s){for(let f=0;f<u.length;f++)l[c+f]=u[f];h&&o(l,h,c,u.length),c+=u.length}return l}}_validate(){if(!this.positions)throw new vn("Positions are required",ya.MeshInvalidPositionsError);const e=(r,s)=>{const a=b.DeduceStride(r);if(s.length%a!==0)throw new Error("The "+r+"s array count must be a multiple of "+a);return s.length/a},t=e(b.PositionKind,this.positions),i=(r,s)=>{const a=e(r,s);if(a!==t)throw new Error("The "+r+"s element count ("+a+") does not match the positions count ("+t+")")};this.normals&&i(b.NormalKind,this.normals),this.tangents&&i(b.TangentKind,this.tangents),this.uvs&&i(b.UVKind,this.uvs),this.uvs2&&i(b.UV2Kind,this.uvs2),this.uvs3&&i(b.UV3Kind,this.uvs3),this.uvs4&&i(b.UV4Kind,this.uvs4),this.uvs5&&i(b.UV5Kind,this.uvs5),this.uvs6&&i(b.UV6Kind,this.uvs6),this.colors&&i(b.ColorKind,this.colors),this.matricesIndices&&i(b.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(b.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(b.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(b.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return de.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return de._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return de._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const r=new de;if(e.isVerticesDataPresent(b.PositionKind)&&(r.positions=e.getVerticesData(b.PositionKind,t,i)),e.isVerticesDataPresent(b.NormalKind)&&(r.normals=e.getVerticesData(b.NormalKind,t,i)),e.isVerticesDataPresent(b.TangentKind)&&(r.tangents=e.getVerticesData(b.TangentKind,t,i)),e.isVerticesDataPresent(b.UVKind)&&(r.uvs=e.getVerticesData(b.UVKind,t,i)),e.isVerticesDataPresent(b.UV2Kind)&&(r.uvs2=e.getVerticesData(b.UV2Kind,t,i)),e.isVerticesDataPresent(b.UV3Kind)&&(r.uvs3=e.getVerticesData(b.UV3Kind,t,i)),e.isVerticesDataPresent(b.UV4Kind)&&(r.uvs4=e.getVerticesData(b.UV4Kind,t,i)),e.isVerticesDataPresent(b.UV5Kind)&&(r.uvs5=e.getVerticesData(b.UV5Kind,t,i)),e.isVerticesDataPresent(b.UV6Kind)&&(r.uvs6=e.getVerticesData(b.UV6Kind,t,i)),e.isVerticesDataPresent(b.ColorKind)){const s=e.geometry||e,a=s.getVertexBuffer(b.ColorKind),o=s.getVerticesData(b.ColorKind,t,i);if(a.getSize()===3){const l=new Float32Array(o.length*4/3);for(let c=0,u=0;c<o.length;c+=3,u+=4)l[u]=o[c],l[u+1]=o[c+1],l[u+2]=o[c+2],l[u+3]=1;r.colors=l}else if(a.getSize()===4)r.colors=o;else throw new Error(`Unexpected number of color components: ${a.getSize()}`)}return e.isVerticesDataPresent(b.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(b.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(b.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(b.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(b.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(b.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(b.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(b.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw rt("ribbonBuilder")}static CreateBox(e){throw rt("boxBuilder")}static CreateTiledBox(e){throw rt("tiledBoxBuilder")}static CreateTiledPlane(e){throw rt("tiledPlaneBuilder")}static CreateSphere(e){throw rt("sphereBuilder")}static CreateCylinder(e){throw rt("cylinderBuilder")}static CreateTorus(e){throw rt("torusBuilder")}static CreateLineSystem(e){throw rt("linesBuilder")}static CreateDashedLines(e){throw rt("linesBuilder")}static CreateGround(e){throw rt("groundBuilder")}static CreateTiledGround(e){throw rt("groundBuilder")}static CreateGroundFromHeightMap(e){throw rt("groundBuilder")}static CreatePlane(e){throw rt("planeBuilder")}static CreateDisc(e){throw rt("discBuilder")}static CreatePolygon(e,t,i,r,s,a,o){throw rt("polygonBuilder")}static CreateIcoSphere(e){throw rt("icoSphereBuilder")}static CreatePolyhedron(e){throw rt("polyhedronBuilder")}static CreateCapsule(e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw rt("capsuleBuilder")}static CreateTorusKnot(e){throw rt("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let s=0,a=0,o=0,l=0,c=0,u=0,h=0,f=0,d=0,p=0,_=0,g=0,E=0,v=0,x=0,A=0,T=0,C=0,y=0,P=0,D=!1,F=!1,W=!1,H=!1,ue=1,ae=0,le=null;r&&(D=!!r.facetNormals,F=!!r.facetPositions,W=!!r.facetPartitioning,ue=r.useRightHandedSystem===!0?-1:1,ae=r.ratio||0,H=!!r.depthSort,le=r.distanceTo,H&&le===void 0&&(le=m.Zero()));let oe=0,ge=0,Ee=0,ne=0;for(W&&r&&r.bbSize&&(oe=r.subDiv.X*ae/r.bbSize.x,ge=r.subDiv.Y*ae/r.bbSize.y,Ee=r.subDiv.Z*ae/r.bbSize.z,ne=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),s=0;s<e.length;s++)i[s]=0;const j=t.length/3|0;for(s=0;s<j;s++){if(g=t[s*3]*3,E=g+1,v=g+2,x=t[s*3+1]*3,A=x+1,T=x+2,C=t[s*3+2]*3,y=C+1,P=C+2,a=e[g]-e[x],o=e[E]-e[A],l=e[v]-e[T],c=e[C]-e[x],u=e[y]-e[A],h=e[P]-e[T],f=ue*(o*h-l*u),d=ue*(l*c-a*h),p=ue*(a*u-o*c),_=Math.sqrt(f*f+d*d+p*p),_=_===0?1:_,f/=_,d/=_,p/=_,D&&r&&(r.facetNormals[s].x=f,r.facetNormals[s].y=d,r.facetNormals[s].z=p),F&&r&&(r.facetPositions[s].x=(e[g]+e[x]+e[C])/3,r.facetPositions[s].y=(e[E]+e[A]+e[y])/3,r.facetPositions[s].z=(e[v]+e[T]+e[P])/3),W&&r){const L=Math.floor((r.facetPositions[s].x-r.bInfo.minimum.x*ae)*oe),Y=Math.floor((r.facetPositions[s].y-r.bInfo.minimum.y*ae)*ge),te=Math.floor((r.facetPositions[s].z-r.bInfo.minimum.z*ae)*Ee),De=Math.floor((e[g]-r.bInfo.minimum.x*ae)*oe),Ve=Math.floor((e[E]-r.bInfo.minimum.y*ae)*ge),ve=Math.floor((e[v]-r.bInfo.minimum.z*ae)*Ee),Me=Math.floor((e[x]-r.bInfo.minimum.x*ae)*oe),Re=Math.floor((e[A]-r.bInfo.minimum.y*ae)*ge),Pe=Math.floor((e[T]-r.bInfo.minimum.z*ae)*Ee),ft=Math.floor((e[C]-r.bInfo.minimum.x*ae)*oe),Wt=Math.floor((e[y]-r.bInfo.minimum.y*ae)*ge),xe=Math.floor((e[P]-r.bInfo.minimum.z*ae)*Ee),z=De+r.subDiv.max*Ve+ne*ve,K=Me+r.subDiv.max*Re+ne*Pe,he=ft+r.subDiv.max*Wt+ne*xe,Ce=L+r.subDiv.max*Y+ne*te;r.facetPartitioning[Ce]=r.facetPartitioning[Ce]?r.facetPartitioning[Ce]:new Array,r.facetPartitioning[z]=r.facetPartitioning[z]?r.facetPartitioning[z]:new Array,r.facetPartitioning[K]=r.facetPartitioning[K]?r.facetPartitioning[K]:new Array,r.facetPartitioning[he]=r.facetPartitioning[he]?r.facetPartitioning[he]:new Array,r.facetPartitioning[z].push(s),K!=z&&r.facetPartitioning[K].push(s),he==K||he==z||r.facetPartitioning[he].push(s),Ce==z||Ce==K||Ce==he||r.facetPartitioning[Ce].push(s)}if(H&&r&&r.facetPositions){const L=r.depthSortedFacets[s];L.ind=s*3,L.sqDistance=m.DistanceSquared(r.facetPositions[s],le)}i[g]+=f,i[E]+=d,i[v]+=p,i[x]+=f,i[A]+=d,i[T]+=p,i[C]+=f,i[y]+=d,i[P]+=p}for(s=0;s<i.length/3;s++)f=i[s*3],d=i[s*3+1],p=i[s*3+2],_=Math.sqrt(f*f+d*d+p*p),_=_===0?1:_,f/=_,d/=_,p/=_,i[s*3]=f,i[s*3+1]=d,i[s*3+2]=p}static _ComputeSides(e,t,i,r,s,a,o){const l=i.length,c=r.length;let u,h;switch(e=e||de.DEFAULTSIDE,e){case de.FRONTSIDE:break;case de.BACKSIDE:for(u=0;u<l;u+=3){const f=i[u];i[u]=i[u+2],i[u+2]=f}for(h=0;h<c;h++)r[h]=-r[h];break;case de.DOUBLESIDE:{const f=t.length,d=f/3;for(let g=0;g<f;g++)t[f+g]=t[g];for(u=0;u<l;u+=3)i[u+l]=i[u+2]+d,i[u+1+l]=i[u+1]+d,i[u+2+l]=i[u]+d;for(h=0;h<c;h++)r[c+h]=-r[h];const p=s.length;let _=0;for(_=0;_<p;_++)s[_+p]=s[_];for(a=a||new We(0,0,1,1),o=o||new We(0,0,1,1),_=0,u=0;u<p/2;u++)s[_]=a.x+(a.z-a.x)*s[_],s[_+1]=a.y+(a.w-a.y)*s[_+1],s[_+p]=o.x+(o.z-o.x)*s[_+p],s[_+p+1]=o.y+(o.w-o.y)*s[_+p+1],_+=2;break}}}static Parse(e){const t=new de,i=e.positions;i&&t.set(i,b.PositionKind);const r=e.normals;r&&t.set(r,b.NormalKind);const s=e.tangents;s&&t.set(s,b.TangentKind);const a=e.uvs;a&&t.set(a,b.UVKind);const o=e.uvs2;o&&t.set(o,b.UV2Kind);const l=e.uvs3;l&&t.set(l,b.UV3Kind);const c=e.uvs4;c&&t.set(c,b.UV4Kind);const u=e.uvs5;u&&t.set(u,b.UV5Kind);const h=e.uvs6;h&&t.set(h,b.UV6Kind);const f=e.colors;f&&(t.set(Be.CheckColors4(f,i.length/3),b.ColorKind),e.hasVertexAlpha!==void 0&&(t.hasVertexAlpha=e.hasVertexAlpha));const d=e.matricesIndices;d&&t.set(d,b.MatricesIndicesKind);const p=e.matricesWeights;p&&t.set(p,b.MatricesWeightsKind);const _=e.indices;_&&(t.indices=_);const g=e.materialInfos;if(g){t.materialInfos=[];for(const E of g){const v=new uu;v.indexCount=E.indexCount,v.indexStart=E.indexStart,v.verticesCount=E.verticesCount,v.verticesStart=E.verticesStart,v.materialIndex=E.materialIndex,t.materialInfos.push(v)}}return t}static ImportVertexData(e,t){const i=de.Parse(e);t.setAllVerticesData(i,e.updatable)}}de.FRONTSIDE=0;de.BACKSIDE=1;de.DOUBLESIDE=2;de.DEFAULTSIDE=0;de._UniqueIDGenerator=0;I([Xn.filter((...[n])=>!Array.isArray(n))],de,"_TransformVector3Coordinates",null);I([Xn.filter((...[n])=>!Array.isArray(n))],de,"_TransformVector3Normals",null);I([Xn.filter((...[n])=>!Array.isArray(n))],de,"_TransformVector4Normals",null);I([Xn.filter((...[n])=>!Array.isArray(n))],de,"_FlipFaces",null);class QD{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new Q,this._onClonedObservable=new Q}}let Lt=class ld{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){const s=this._NodeConstructors[e];return s?s(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=!0){this._isDirty=!1,this._nodeDataStorage=new QD,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new Q,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=O.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new Q,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||$e.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){const s=this._children[r];(!i||i(s))&&e.push(s),t||s._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=ld._AnimationRangeFactory(e,t,i);for(let r=0,s=this.animations.length;r<s;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const r=Ke.Clone(()=>new ld(e,this.getScene()),this);if(t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let a=0;a<s.length;a++){const o=s[a];o.clone(e+"."+o.name,r)}}return r}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=O.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let r=0;r<t.ranges.length;r++){const s=t.ranges[r];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,r;const s=this;if(s.getBoundingInfo&&s.subMeshes){const a=s.getBoundingInfo();i=a.boundingBox.minimumWorld.clone(),r=a.boundingBox.maximumWorld.clone()}else i=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const a=this.getDescendants(!1);for(const o of a){const l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const u=l.getBoundingInfo().boundingBox,h=u.minimumWorld,f=u.maximumWorld;m.CheckExtends(h,i,r),m.CheckExtends(f,i,r)}}return{min:i,max:r}}};Lt._AnimationRangeFactory=(n,e,t)=>{throw rt("AnimationRange")};Lt._NodeConstructors={};I([M()],Lt.prototype,"name",void 0);I([M()],Lt.prototype,"id",void 0);I([M()],Lt.prototype,"uniqueId",void 0);I([M()],Lt.prototype,"state",void 0);I([M()],Lt.prototype,"metadata",void 0);const JD=O.Compose(m.One(),ce.FromEulerAngles(0,Math.PI,0),m.Zero());class ot extends Lt{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&ot.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==ot.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new m(0,0,1),this._up=new m(0,1,0),this._right=new m(1,0,0),this._position=m.Zero(),this._rotation=m.Zero(),this._rotationQuaternion=null,this._scaling=m.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=ot.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=O.Zero(),this._usePivotMatrix=!1,this._absolutePosition=m.Zero(),this._absoluteScaling=m.Zero(),this._absoluteRotationQuaternion=ce.Identity(),this._pivotMatrix=O.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new Q,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){this._isDirty||(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return m.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return m.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return m.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=O.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==ot.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=O.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||ce.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){const s=B.Matrix[0];this.parent.getWorldMatrix().invertToRef(s),m.TransformCoordinatesFromFloatsToRef(t,i,r,s,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=m.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=B.Matrix[0];return this._localMatrix.invertToRef(e),m.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=m.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,s=0){const a=ot._LookAtVectorCache,o=s===0?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,i,r),s===1&&this.parent)if(this.rotationQuaternion){const l=B.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const c=B.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=B.Quaternion[0];ce.FromEulerVectorToRef(this.rotation,l);const c=B.Matrix[0];l.toRotationMatrix(c);const u=B.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(u),u.invert(),c.multiplyToRef(u,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=m.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return m.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){const s=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?ce.RotationYawPitchRollToRef(s+t,o+i,r,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=s+t,this.rotation.z=r),this}setPivotPoint(e,t=0){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==1){const r=B.Matrix[0];i.invertToRef(r),e=m.TransformCoordinates(e,r)}return this.setPivotMatrix(O.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=m.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=m.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),m.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const r=B.Quaternion[0],s=B.Vector3[0],a=B.Vector3[1],o=B.Matrix[1];O.IdentityToRef(o);const l=B.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=ot._TmpRotation,ce.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),O.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,r,s,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(s),this.parent=e,i&&this.setPivotMatrix(O.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===0)r=ce.RotationAxisToRef(e,t,ot._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){const s=this.parent.getWorldMatrix(),a=B.Matrix[0];s.invertToRef(a),e=m.TransformNormal(e,a),s.determinant()<0&&(t*=-1)}r=ce.RotationAxisToRef(e,t,ot._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=ce.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const r=B.Vector3[0],s=B.Vector3[1],a=B.Vector3[2],o=B.Quaternion[0],l=B.Matrix[0],c=B.Matrix[1],u=B.Matrix[2],h=B.Matrix[3];return e.subtractToRef(this.position,r),O.TranslationToRef(r.x,r.y,r.z,l),O.TranslationToRef(-r.x,-r.y,-r.z,c),O.RotationAxisToRef(t,i,u),c.multiplyToRef(u,h),h.multiplyToRef(l,h),h.decompose(s,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const r=e.scale(t);if(!i||i===0){const s=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(s)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=B.Quaternion[1],ce.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));const s=B.Quaternion[0];return ce.RotationYawPitchRollToRef(t,e,i,s),r.multiplyInPlace(s),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==ot.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const s=this._getEffectiveParent(),a=ot._TmpScaling;let o=this._position;if(this._infiniteDistance&&!this.parent&&t){const c=t.getWorldMatrix(),u=new m(c.m[12],c.m[13],c.m[14]);o=ot._TmpTranslation,o.copyFromFloats(this._position.x+u.x,this._position.y+u.y,this._position.z+u.z)}a.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(ce.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=ot._TmpRotation,ce.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const c=B.Matrix[1];O.ScalingToRef(a.x,a.y,a.z,c);const u=B.Matrix[0];l.toRotationMatrix(u),this._pivotMatrix.multiplyToRef(c,B.Matrix[4]),B.Matrix[4].multiplyToRef(u,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else O.ComposeToRef(a,l,o,this._localMatrix);if(s&&s.getWorldMatrix){if(e&&s.computeWorldMatrix(e),r.useBillboardPath){if(this._transformToBoneReferal){const f=this.parent;f.getSkeleton().prepare(),f.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),B.Matrix[7])}else B.Matrix[7].copyFrom(s.getWorldMatrix());const c=B.Vector3[5],u=B.Vector3[6],h=B.Quaternion[0];B.Matrix[7].decompose(u,h,c),O.ScalingToRef(u.x,u.y,u.z,B.Matrix[7]),B.Matrix[7].setTranslation(c),ot.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(h,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(B.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const c=this.parent;c.getSkeleton().prepare(),this._localMatrix.multiplyToRef(c.getFinalMatrix(),B.Matrix[6]),B.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(s.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r.useBillboardPath&&t&&this.billboardMode&&!r.useBillboardPosition){const c=B.Vector3[0];if(this._worldMatrix.getTranslationToRef(c),B.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&B.Matrix[1].multiplyToRef(JD,B.Matrix[1]),B.Matrix[1].setTranslationFromFloats(0,0,0),B.Matrix[1].invertToRef(B.Matrix[0]),(this.billboardMode&ot.BILLBOARDMODE_ALL)!==ot.BILLBOARDMODE_ALL){B.Matrix[0].decompose(void 0,B.Quaternion[0],void 0);const u=B.Vector3[1];B.Quaternion[0].toEulerAnglesToRef(u),(this.billboardMode&ot.BILLBOARDMODE_X)!==ot.BILLBOARDMODE_X&&(u.x=0),(this.billboardMode&ot.BILLBOARDMODE_Y)!==ot.BILLBOARDMODE_Y&&(u.y=0),(this.billboardMode&ot.BILLBOARDMODE_Z)!==ot.BILLBOARDMODE_Z&&(u.z=0),O.RotationYawPitchRollToRef(u.y,u.x,u.z,B.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(B.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(B.Vector3[0])}else if(r.useBillboardPath&&t&&r.useBillboardPosition){const c=B.Vector3[0];this._worldMatrix.getTranslationToRef(c);const u=t.globalPosition;this._worldMatrix.invertToRef(B.Matrix[1]);const h=B.Vector3[1];m.TransformCoordinatesToRef(u,B.Matrix[1],h),h.normalize();const f=-Math.atan2(h.z,h.x)+Math.PI/2,d=Math.sqrt(h.x*h.x+h.z*h.z),p=-Math.atan2(h.y,d);if(ce.RotationYawPitchRollToRef(f,p,0,B.Quaternion[0]),(this.billboardMode&ot.BILLBOARDMODE_ALL)!==ot.BILLBOARDMODE_ALL){const _=B.Vector3[1];B.Quaternion[0].toEulerAnglesToRef(_),(this.billboardMode&ot.BILLBOARDMODE_X)!==ot.BILLBOARDMODE_X&&(_.x=0),(this.billboardMode&ot.BILLBOARDMODE_Y)!==ot.BILLBOARDMODE_Y&&(_.y=0),(this.billboardMode&ot.BILLBOARDMODE_Z)!==ot.BILLBOARDMODE_Z&&(_.z=0),O.RotationYawPitchRollToRef(_.y,_.x,_.z,B.Matrix[0])}else O.FromQuaternionToRef(B.Quaternion[0],B.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(B.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(B.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):s&&s._nonUniformScaling?this._updateNonUniformScalingState(s._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=O.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const r=t[i];if(r){r.computeWorldMatrix();const s=B.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,s);const a=B.Quaternion[0];s.decompose(r.scaling,a,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=ce.Identity()),this._worldMatrix=O.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),m.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const r=Ke.Clone(()=>new ot(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){const s=this.getDescendants(!0);for(let a=0;a<s.length;a++){const o=s[a];o.clone&&o.clone(e+"."+o.name,r)}}return r}serialize(e){const t=Ke.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),Ke.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){const r=Ke.Parse(()=>new ot(e.name,t),e,t,i);if(e.localMatrix?r.setPreTransformMatrix(O.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(O.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=Ai("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}Lt.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),r}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof ot),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,s=null;t&&(this.rotationQuaternion?(s=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const a=this.getHierarchyBoundingVectors(e,i),o=a.max.subtract(a.min),l=Math.max(o.x,o.y,o.z);if(l===0)return this;const c=1/l;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&s?this.rotationQuaternion.copyFrom(s):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}ot.BILLBOARDMODE_NONE=0;ot.BILLBOARDMODE_X=1;ot.BILLBOARDMODE_Y=2;ot.BILLBOARDMODE_Z=4;ot.BILLBOARDMODE_ALL=7;ot.BILLBOARDMODE_USE_POSITION=128;ot.BillboardUseParentOrientation=!1;ot._TmpRotation=ce.Zero();ot._TmpScaling=m.Zero();ot._TmpTranslation=m.Zero();ot._LookAtVectorCache=new m(0,0,0);ot._RotationAxisCache=new ce;I([Ar("position")],ot.prototype,"_position",void 0);I([Ar("rotation")],ot.prototype,"_rotation",void 0);I([vD("rotationQuaternion")],ot.prototype,"_rotationQuaternion",void 0);I([Ar("scaling")],ot.prototype,"_scaling",void 0);I([M("billboardMode")],ot.prototype,"_billboardMode",void 0);I([M()],ot.prototype,"scalingDeterminant",void 0);I([M("infiniteDistance")],ot.prototype,"_infiniteDistance",void 0);I([M()],ot.prototype,"ignoreNonUniformScaling",void 0);I([M()],ot.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class es{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(b.NormalKind))return null;let i=this.pickedMesh.getIndices();(i==null?void 0:i.length)===0&&(i=null);let r;const s=B.Vector3[0],a=B.Vector3[1],o=B.Vector3[2];if(t){const c=this.pickedMesh.getVerticesData(b.NormalKind);let u=i?m.FromArrayToRef(c,i[this.faceId*3]*3,s):s.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),h=i?m.FromArrayToRef(c,i[this.faceId*3+1]*3,a):a.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),f=i?m.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]);u=u.scale(this.bu),h=h.scale(this.bv),f=f.scale(1-this.bu-this.bv),r=new m(u.x+h.x+f.x,u.y+h.y+f.y,u.z+h.z+f.z)}else{const c=this.pickedMesh.getVerticesData(b.PositionKind),u=i?m.FromArrayToRef(c,i[this.faceId*3]*3,s):s.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),h=i?m.FromArrayToRef(c,i[this.faceId*3+1]*3,a):a.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),f=i?m.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]),d=u.subtract(h),p=f.subtract(h);r=m.Cross(d,p)}const l=(c,u)=>{let h=c.getWorldMatrix();c.nonUniformScaling&&(B.Matrix[0].copyFrom(h),h=B.Matrix[0],h.setTranslationFromFloats(0,0,0),h.invert(),h.transposeToRef(B.Matrix[1]),h=B.Matrix[1]),m.TransformNormalToRef(u,h,u)};if(e&&l(this.pickedMesh,r),this.ray){const c=B.Vector3[0].copyFrom(r);e||l(this.pickedMesh,c),m.Dot(c,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(e=b.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let r=se.FromArray(i,t[this.faceId*3]*2),s=se.FromArray(i,t[this.faceId*3+1]*2),a=se.FromArray(i,t[this.faceId*3+2]*2);return r=r.scale(this.bu),s=s.scale(this.bv),a=a.scale(1-this.bu-this.bv),new se(r.x+s.x+a.x,r.y+s.y+a.y)}}const Xm=(n,e,t)=>!n||n.getClassName&&n.getClassName()==="Mesh"?null:n.getClassName&&(n.getClassName()==="SubMesh"||n.getClassName()==="PhysicsBody")?n.clone(e):n.clone?n.clone():Array.isArray(n)?n.slice():t&&typeof n=="object"?{...n}:null;function eO(n){const e=[];do Object.getOwnPropertyNames(n).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(n=Object.getPrototypeOf(n));return e}class cr{static DeepCopy(e,t,i,r,s=!1){const a=eO(e);for(const o of a){if(o[0]==="_"&&(!r||r.indexOf(o)===-1)||o.endsWith("Observable")||i&&i.indexOf(o)!==-1)continue;const l=e[o],c=typeof l;if(c!=="function")try{if(c==="object")if(l instanceof Uint8Array)t[o]=Uint8Array.from(l);else if(l instanceof Array){if(t[o]=[],l.length>0)if(typeof l[0]=="object")for(let u=0;u<l.length;u++){const h=Xm(l[u],t,s);t[o].indexOf(h)===-1&&t[o].push(h)}else t[o]=l.slice(0)}else t[o]=Xm(l,t,s);else t[o]=l}catch(u){w.Warn(u.message)}}}}class J{static get BaseUrl(){return Pi.BaseUrl}static set BaseUrl(e){Pi.BaseUrl=e}static get CleanUrl(){return Pi.CleanUrl}static set CleanUrl(e){Pi.CleanUrl=e}static IsAbsoluteUrl(e){return e.indexOf("//")===0?!0:e.indexOf("://")===-1||e.indexOf(".")===-1||e.indexOf("/")===-1||e.indexOf(":")>e.indexOf("/")?!1:e.indexOf("://")<e.indexOf(".")||e.indexOf("data:")===0||e.indexOf("blob:")===0}static set ScriptBaseUrl(e){Pi.ScriptBaseUrl=e}static get ScriptBaseUrl(){return Pi.ScriptBaseUrl}static set ScriptPreprocessUrl(e){Pi.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return Pi.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return Pi.DefaultRetryStrategy}static set DefaultRetryStrategy(e){Pi.DefaultRetryStrategy=e}static get CorsBehavior(){return Pi.CorsBehavior}static set CorsBehavior(e){Pi.CorsBehavior=e}static get UseFallbackTexture(){return $e.UseFallbackTexture}static set UseFallbackTexture(e){$e.UseFallbackTexture=e}static get RegisteredExternalClasses(){return zl.RegisteredExternalClasses}static set RegisteredExternalClasses(e){zl.RegisteredExternalClasses=e}static get fallbackTexture(){return $e.FallbackTexture}static set fallbackTexture(e){$e.FallbackTexture=e}static FetchToRef(e,t,i,r,s,a){const o=Math.abs(e)*i%i|0,l=Math.abs(t)*r%r|0,c=(o+l*i)*4;a.r=s[c]/255,a.g=s[c+1]/255,a.b=s[c+2]/255,a.a=s[c+3]/255}static Mix(e,t,i){return 0}static Instantiate(e){return zl.Instantiate(e)}static SetImmediate(e){qo.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const r=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(s)+i*Math.sin(r),(1-i)*Math.cos(s)+i*Math.cos(r)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){return Yi()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){op(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return Pi.PreprocessUrl}static set PreprocessUrl(e){Pi.PreprocessUrl=e}static LoadImage(e,t,i,r,s,a){return Ec(e,t,i,r,s,a)}static LoadFile(e,t,i,r,s,a){return Ea(e,t,i,r,s,a)}static LoadFileAsync(e,t=!0){return new Promise((i,r)=>{Ea(e,s=>{i(s)},void 0,void 0,t,(s,a)=>{r(a)})})}static GetBabylonScriptURL(e,t){if(!e)return"";if(J.ScriptBaseUrl&&e.startsWith(J._DefaultCdnUrl)){const i=J.ScriptBaseUrl[J.ScriptBaseUrl.length-1]==="/"?J.ScriptBaseUrl.substring(0,J.ScriptBaseUrl.length-1):J.ScriptBaseUrl;e=e.replace(J._DefaultCdnUrl,i)}return e=J.ScriptPreprocessUrl(e),t&&(e=J.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,r){e=J.GetBabylonScriptURL(e),J.LoadScript(e,t,i)}static LoadBabylonScriptAsync(e){return e=J.GetBabylonScriptURL(e),J.LoadScriptAsync(e)}static LoadScript(e,t,i,r,s=!1){if(typeof importScripts=="function"){try{importScripts(e),t&&t()}catch(l){i==null||i(`Unable to load script '${e}' in worker`,l)}return}else if(!Yi()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const a=document.getElementsByTagName("head")[0],o=document.createElement("script");s?(o.setAttribute("type","module"),o.innerText=e):(o.setAttribute("type","text/javascript"),o.setAttribute("src",e)),r&&(o.id=r),o.onload=()=>{t&&t()},o.onerror=l=>{i&&i(`Unable to load script '${e}'`,l)},a.appendChild(o)}static LoadScriptAsync(e,t){return new Promise((i,r)=>{this.LoadScript(e,()=>{i()},(s,a)=>{r(a||new Error(s))},t)})}static ReadFileAsDataURL(e,t,i){const r=new FileReader,s={onCompleteObservable:new Q,abort:()=>r.abort()};return r.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},r.onload=a=>{t(a.target.result)},r.onprogress=i,r.readAsDataURL(e),s}static ReadFile(e,t,i,r,s){return sc(e,t,i,r,s)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,r){cr.DeepCopy(e,t,i,r)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch{}}}static async DumpFramebuffer(e,t,i,r,s="image/png",a,o){throw rt("DumpTools")}static DumpData(e,t,i,r,s="image/png",a,o=!1,l=!1,c){throw rt("DumpTools")}static DumpDataAsync(e,t,i,r="image/png",s,a=!1,o=!1,l){throw rt("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,i="image/png",r){!J._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(s,a,o){setTimeout(()=>{const l=atob(this.toDataURL(a,o).split(",")[1]),c=l.length,u=new Uint8Array(c);for(let h=0;h<c;h++)u[h]=l.charCodeAt(h);s(new Blob([u]))})}),J._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:r}).then(s=>t(s)):e.toBlob(function(s){t(s)},i,r)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}J.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),r=window.open("");if(!r)return;const s=r.document.createElement("img");s.onload=function(){URL.revokeObjectURL(i)},s.src=i,r.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",r,s){if(typeof r=="string"||!t)this.ToBlob(e,function(a){a&&J.DownloadBlob(a,r),t&&t("")},i,s);else if(t){if(J._IsOffScreenCanvas(e)){e.convertToBlob({type:i,quality:s}).then(o=>{const l=new FileReader;l.readAsDataURL(o),l.onloadend=()=>{const c=l.result;t(c)}});return}const a=e.toDataURL(i,s);t(a)}}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",()=>{r.parentElement&&r.parentElement.removeChild(r)}),r.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,r,s="image/png",a=!1,o){throw rt("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,r="image/png",s){throw rt("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,r,s="image/png",a=1,o=!1,l,c=!1,u=!1,h=!0,f,d){throw rt("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,r="image/png",s=1,a=!1,o,l=!1,c=!1,u=!0,h,f){throw rt("ScreenshotTools")}static RandomId(){return th()}static IsBase64(e){return cp(e)}static DecodeBase64(e){return up(e)}static get errorsCount(){return w.errorsCount}static Log(e){w.Log(e)}static Warn(e){w.Warn(e)}static Error(e){w.Error(e)}static get LogCache(){return w.LogCache}static ClearLogCache(){w.ClearLogCache()}static set LogLevels(e){w.LogLevels=e}static set PerformanceLogLevel(e){if((e&J.PerformanceUserMarkLogLevel)===J.PerformanceUserMarkLogLevel){J.StartPerformanceCounter=J._StartUserMark,J.EndPerformanceCounter=J._EndUserMark;return}if((e&J.PerformanceConsoleLogLevel)===J.PerformanceConsoleLogLevel){J.StartPerformanceCounter=J._StartPerformanceConsole,J.EndPerformanceCounter=J._EndPerformanceConsole;return}J.StartPerformanceCounter=J._StartPerformanceCounterDisabled,J.EndPerformanceCounter=J._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!J._Performance){if(!Yi())return;J._Performance=window.performance}!t||!J._Performance.mark||J._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!J._Performance.mark||(J._Performance.mark(e+"-End"),J._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(J._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(J._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Tr.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,r=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const s=t?e:Object.getPrototypeOf(e);i=s.constructor.__bjsclassName__,r=s.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(r!=null?r+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return Ro()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}J.UseCustomRequestHeaders=!1;J.CustomRequestHeaders=Gi.CustomRequestHeaders;J.GetDOMTextContent=Zd;J._DefaultCdnUrl="https://cdn.babylonjs.com";J.GetAbsoluteUrl=typeof document=="object"?n=>{const e=document.createElement("a");return e.href=n,e.href}:typeof URL=="function"&&typeof location=="object"?n=>new URL(n,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};J.NoneLogLevel=w.NoneLogLevel;J.MessageLogLevel=w.MessageLogLevel;J.WarningLogLevel=w.WarningLogLevel;J.ErrorLogLevel=w.ErrorLogLevel;J.AllLogLevel=w.AllLogLevel;J.IsWindowObjectExist=Yi;J.PerformanceNoneLogLevel=0;J.PerformanceUserMarkLogLevel=1;J.PerformanceConsoleLogLevel=2;J.StartPerformanceCounter=J._StartPerformanceCounterDisabled;J.EndPerformanceCounter=J._EndPerformanceCounterDisabled;class Os{constructor(e,t,i,r=0){this.iterations=e,this.index=r-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,r=0){const s=new Os(e,t,i,r);return s.executeNext(),s}static SyncAsyncForLoop(e,t,i,r,s,a=0){return Os.Run(Math.ceil(e/t),o=>{s&&s()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const c=o.index*t+l;if(c>=e)break;if(i(c),s&&s()){o.breakLoop();break}}o.executeNext()},a)},r)}}J.Mix=id;J.IsExponentOfTwo=ec;$e.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";class ke{constructor(e,t,i,r,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const r=this._uniformLocationPointer-i;for(let s=0;s<r;s++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const a=(4-t)*i;t=t*i+a}r=[];for(let s=0;s<t;s++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{t=t,r=[];for(let s=0;s<t;s++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let s=0;s<t;s++)this._data.push(r[s]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){const r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){const s=[t,i,r];this.addUniform(e,s)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];let t=0;for(const i in this._uniformLocations)if(e.push(i),++t===10)break;return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(ke._UpdatedUbosInFrame[this._name]||(ke._UpdatedUbosInFrame[this._name]=0),ke._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){w.Error("Cannot add an uniform after UBO has been created. uniformName="+e);return}this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let s=0;s<i;s++)this._bufferData[r+s]=t[s];else{let s=!1;for(let a=0;a<i;a++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+a]!==Math.fround(t[a]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+a]=t[a]);this._needSync=this._needSync||s}}updateUniformArray(e,t,i){this._checkNewFrame();const r=this._uniformLocations[e];if(r===void 0){w.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const s=this._uniformArraySizes[e];if(this._dynamic)for(let a=0;a<i;a++)this._bufferData[r+a]=t[a];else{let a=!1,o=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[r+l*4+o]!==J.FloatRound(t[c])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+l*4+o]=t[c]),o++,o===s.strideSize){for(;o<4;o++)this._bufferData[r+l*4+o]=0;o=0,l++}this._needSync=this._needSync||a}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)ke._TempBuffer[i*4]=t[i*3],ke._TempBuffer[i*4+1]=t[i*3+1],ke._TempBuffer[i*4+2]=t[i*3+2],ke._TempBuffer[i*4+3]=0;this.updateUniform(e,ke._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)ke._TempBuffer[i*4]=t[i*2],ke._TempBuffer[i*4+1]=t[i*2+1],ke._TempBuffer[i*4+2]=0,ke._TempBuffer[i*4+3]=0;this.updateUniform(e,ke._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){ke._TempBuffer[0]=t,this.updateUniform(e,ke._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){ke._TempBuffer[0]=t,ke._TempBuffer[1]=i,this.updateUniform(e,ke._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,s=""){this._currentEffect.setFloat3(e+s,t,i,r)}_updateFloat3ForUniform(e,t,i,r){ke._TempBuffer[0]=t,ke._TempBuffer[1]=i,ke._TempBuffer[2]=r,this.updateUniform(e,ke._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,s,a=""){this._currentEffect.setFloat4(e+a,t,i,r,s)}_updateFloat4ForUniform(e,t,i,r,s){ke._TempBuffer[0]=t,ke._TempBuffer[1]=i,ke._TempBuffer[2]=r,ke._TempBuffer[3]=s,this.updateUniform(e,ke._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){ke._TempBufferInt32View.set(t),this.updateUniformArray(e,ke._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){ke._TempBufferUInt32View.set(t),this.updateUniformArray(e,ke._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){ke._TempBuffer[0]=t.x,ke._TempBuffer[1]=t.y,ke._TempBuffer[2]=t.z,this.updateUniform(e,ke._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){ke._TempBuffer[0]=t.x,ke._TempBuffer[1]=t.y,ke._TempBuffer[2]=t.z,ke._TempBuffer[3]=t.w,this.updateUniform(e,ke._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){ke._TempBuffer[0]=t.r,ke._TempBuffer[1]=t.g,ke._TempBuffer[2]=t.b,this.updateUniform(e,ke._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){ke._TempBuffer[0]=t.r,ke._TempBuffer[1]=t.g,ke._TempBuffer[2]=t.b,ke._TempBuffer[3]=i,this.updateUniform(e,ke._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){ke._TempBuffer[0]=t.r,ke._TempBuffer[1]=t.g,ke._TempBuffer[2]=t.b,ke._TempBuffer[3]=t.a,this.updateUniform(e,ke._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){ke._TempBufferInt32View[0]=t,this.updateUniform(e,ke._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){ke._TempBufferInt32View[0]=t,ke._TempBufferInt32View[1]=i,this.updateUniform(e,ke._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setInt3(e+s,t,i,r)}_updateInt3ForUniform(e,t,i,r){ke._TempBufferInt32View[0]=t,ke._TempBufferInt32View[1]=i,ke._TempBufferInt32View[2]=r,this.updateUniform(e,ke._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,s,a=""){this._currentEffect.setInt4(e+a,t,i,r,s)}_updateInt4ForUniform(e,t,i,r,s){ke._TempBufferInt32View[0]=t,ke._TempBufferInt32View[1]=i,ke._TempBufferInt32View[2]=r,ke._TempBufferInt32View[3]=s,this.updateUniform(e,ke._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){ke._TempBufferUInt32View[0]=t,this.updateUniform(e,ke._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){ke._TempBufferUInt32View[0]=t,ke._TempBufferUInt32View[1]=i,this.updateUniform(e,ke._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setUInt3(e+s,t,i,r)}_updateUInt3ForUniform(e,t,i,r){ke._TempBufferUInt32View[0]=t,ke._TempBufferUInt32View[1]=i,ke._TempBufferUInt32View[2]=r,this.updateUniform(e,ke._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,s,a=""){this._currentEffect.setUInt4(e+a,t,i,r,s)}_updateUInt4ForUniform(e,t,i,r,s){ke._TempBufferUInt32View[0]=t,ke._TempBufferUInt32View[1]=i,ke._TempBufferUInt32View[2]=r,ke._TempBufferUInt32View[3]=s,this.updateUniform(e,ke._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}ke._UpdatedUbosInFrame={};ke._MAX_UNIFORM_SIZE=256;ke._TempBuffer=new Float32Array(ke._MAX_UNIFORM_SIZE);ke._TempBufferInt32View=new Int32Array(ke._TempBuffer.buffer);ke._TempBufferUInt32View=new Uint32Array(ke._TempBuffer.buffer);class tO{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new m(0,0,0),this._diffPositionForCollisions=new m(0,0,0),this._collisionResponse=!0}}function iO(n,e,t){let i=null;switch(e){case b.PositionKind:i=r=>r.getPositions();break;case b.NormalKind:i=r=>r.getNormals();break;case b.TangentKind:i=r=>r.getTangents();break;case b.UVKind:i=r=>r.getUVs();break;default:return}for(let r=0;r<n.length;r++){let s=n[r];for(let a=0;a<t.numTargets;a++){const o=t.getTarget(a),l=o.influence;if(l!==0){const c=i(o);c&&(s+=(c[r]-n[r])*l)}}n[r]=s}}function rO(n,e,t,i,r,s,a){const o=B.Vector3[0],l=B.Matrix[0],c=B.Matrix[1],u=e===b.NormalKind?m.TransformNormalFromFloatsToRef:m.TransformCoordinatesFromFloatsToRef;for(let h=0,f=0;h<n.length;h+=3,f+=4){l.reset();let d,p;for(d=0;d<4;d++)p=r[f+d],p>0&&(O.FromFloat32ArrayToRefScaled(t,Math.floor(i[f+d]*16),p,c),l.addToSelf(c));if(s&&a)for(d=0;d<4;d++)p=a[f+d],p>0&&(O.FromFloat32ArrayToRefScaled(t,Math.floor(s[f+d]*16),p,c),l.addToSelf(c));u(n[h],n[h+1],n[h+2],l,o),o.toArray(n,h)}}class sO{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=m.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class nO{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new sO,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new tO,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._inheritVisibility=!1}}class $t extends ot{static get BILLBOARDMODE_NONE(){return ot.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return ot.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return ot.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return ot.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return ot.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return ot.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get inheritVisibility(){return this._internalAbstractMeshDataInfo._inheritVisibility}set inheritVisibility(e){this._internalAbstractMeshDataInfo._inheritVisibility=e}get isVisible(){if(!this._isVisible||!this.inheritVisibility||!this._parentNode)return this._isVisible;if(this._isVisible){let e=this._parentNode;for(;e;){const t=e.isVisible;if(typeof t<"u")return t;e=e.parent}}return this._isVisible}set isVisible(e){this._isVisible=e}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e)}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new nO,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=$t.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new Q,this.onCollisionPositionChangeObservable=new Q,this.onMaterialChangedObservable=new Q,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this._isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=fe.Red(),this.outlineWidth=.02,this.overlayColor=fe.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.edgesWidth=1,this.edgesColor=new Be(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new Q,this._onCollisionPositionChange=(i,r,s=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>q.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),s&&this.onCollideObservable.notifyObservers(s),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new ke(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==ot.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes){for(const t of this.subMeshes)t._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let r=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const r=t._drawWrappers[i];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(e),this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,r){return this}updateVerticesData(e,t,i,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new Jr(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(b.MatricesIndicesKind)&&this.isVerticesDataPresent(b.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===ot.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const r=new O;(this.rotationQuaternion?this.rotationQuaternion:ce.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);const a=m.Zero(),o=this.definedFacingForward?-1:1;return m.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,r,a),a}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const r=this.definedFacingForward?1:-1;return new m(e*r,t,i*r)}_refreshBoundingInfo(e,t){if(e){const i=to(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Jr(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new Jr(e.minimum,e.maximum),this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(e,t,i,r,s,a,o){rO(e,t,i,r,s,a,o)}_getData(e,t,i=b.PositionKind){const r=e.cache,s=a=>{if(r){const o=r._vertexData||(r._vertexData={});return o[a]||this.copyVerticesData(a,o),o[a]}return this.getVerticesData(a)};if(t||(t=s(i)),!t)return null;if(r?(r._outputData?r._outputData.set(t):r._outputData=new Float32Array(t),t=r._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&iO(t,i,this.morphTargetManager),e.applySkeleton&&this.skeleton){const a=s(b.MatricesIndicesKind),o=s(b.MatricesWeightsKind);if(o&&a){const l=this.numBoneInfluencers>4,c=l?s(b.MatricesIndicesExtraKind):null,u=l?s(b.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this);$t._ApplySkeleton(t,i,h,a,o,c,u)}}if(e.updatePositionsArray!==!1&&i===b.PositionKind){const a=this._internalAbstractMeshDataInfo._positions||[],o=a.length;if(a.length=t.length/3,o<a.length)for(let l=o;l<a.length;l++)a[l]=new m;for(let l=0,c=0;l<a.length;l++,c+=3)a[l].copyFromFloats(t[c],t[c+1],t[c+2]);this._internalAbstractMeshDataInfo._positions=a}return t}getNormalsData(e=!1,t=!1){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},null,b.NormalKind)}getPositionData(e=!1,t=!1,i=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},i,b.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Jr(m.Zero(),m.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const r=this.subMeshes[i];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const r=this.getBoundingInfo(),s=e.getBoundingInfo();if(r.intersects(s,t))return!0;if(i){for(const a of this.getChildMeshes())if(a.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var r;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const s=e.verticesStart,a=e.verticesStart+e.verticesCount;for(let o=s;o<a;o++)e._lastColliderWorldVertices.push(m.TransformCoordinates(this._positions[o],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((r=e.getMaterial())==null?void 0:r.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),r=i.length;for(let s=0;s<r;s++){const a=i.data[s];r>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=B.Matrix[0],i=B.Matrix[1];return O.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,r=!1,s,a=!1){const o=new es,l=this.getClassName(),c=l==="InstancedLinesMesh"||l==="LinesMesh"||l==="GreasedLineMesh"?this.intersectionThreshold:0,u=this.getBoundingInfo();if(!this.subMeshes||!a&&(!e.intersectsSphere(u.boundingSphere,c)||!e.intersectsBox(u.boundingBox,c)))return o;if(r)return o.hit=!a,o.pickedMesh=a?null:this,o.distance=a?0:m.Distance(e.origin,u.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let h=null;const f=this._scene.getIntersectingSubMeshCandidates(this,e),d=f.length;let p=!1;for(let _=0;_<d;_++){const E=f.data[_].getMaterial();if(E&&(E.fillMode==7||E.fillMode==0||E.fillMode==1||E.fillMode==2||E.fillMode==4)){p=!0;break}}if(!p)return o.hit=!0,o.pickedMesh=this,o.distance=m.Distance(e.origin,u.boundingSphere.center),o.subMeshId=-1,o;for(let _=0;_<d;_++){const g=f.data[_];if(d>1&&!a&&!g.canIntersects(e))continue;const E=g.intersects(e,this._positions,this.getIndices(),t,i);if(E&&(t||!h||E.distance<h.distance)&&(h=E,h.subMeshId=_,t))break}if(h){const _=s??this.getWorldMatrix(),g=B.Vector3[0],E=B.Vector3[1];m.TransformCoordinatesToRef(e.origin,_,g),e.direction.scaleToRef(h.distance,E);const x=m.TransformNormal(E,_).addInPlace(g);return o.hit=!0,o.distance=m.Distance(g,x),o.pickedPoint=x,o.pickedMesh=this,o.bu=h.bu||0,o.bv=h.bv||0,o.subMeshFaceId=h.faceId,o.faceId=h.faceId+f.data[h.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=h.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(e,t=!1){let i;const r=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),r.freeActiveMeshes(),r.freeRenderingGroups(),r.renderingManager.maintainStateBetweenFrames&&r.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(o=>o!==this&&o.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const o=this._intersectionsInProgress[i],l=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(l,1)}this._intersectionsInProgress.length=0,r.lights.forEach(o=>{let l=o.includedOnlyMeshes.indexOf(this);l!==-1&&o.includedOnlyMeshes.splice(l,1),l=o.excludedMeshes.indexOf(this),l!==-1&&o.excludedMeshes.splice(l,1);const c=o.getShadowGenerators();if(c){const u=c.values();for(let h=u.next();h.done!==!0;h=u.next()){const d=h.value.getShadowMap();d&&d.renderList&&(l=d.renderList.indexOf(this),l!==-1&&d.renderList.splice(l,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const a=r.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),r.removeMesh(this),this._parentContainer){const o=this._parentContainer.meshes.indexOf(this);o>-1&&this._parentContainer.meshes.splice(o,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<r.particleSystems.length;i++)r.particleSystems[i].emitter===this&&(r.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=m.Zero(),e.facetPositions[t]=m.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(b.PositionKind),i=this.getIndices(),r=this.getVerticesData(b.NormalKind),s=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,l){return l.sqDistance-o.sqDistance},!e.facetDepthSortFrom){const o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:m.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){const l={ind:o*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=O.Identity(),e.facetDepthSortOrigin=m.Zero()}e.bbSize.x=s.maximum.x-s.minimum.x>pt?s.maximum.x-s.minimum.x:pt,e.bbSize.y=s.maximum.y-s.minimum.y>pt?s.maximum.y-s.minimum.y:pt,e.bbSize.z=s.maximum.z-s.minimum.z>pt?s.maximum.z-s.minimum.z:pt;let a=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(a=a>e.bbSize.z?a:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/a),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/a),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/a),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=s,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),m.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&de.ComputeNormals(t,i,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const o=e.depthSortedIndices.length/3|0;for(let l=0;l<o;l++){const c=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[c],e.depthSortedIndices[l*3+1]=i[c+1],e.depthSortedIndices[l*3+2]=i[c+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=m.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return m.TransformCoordinatesToRef(i,r,t),this}getFacetNormal(e){const t=m.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return m.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const r=this.getBoundingInfo(),s=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((e-r.minimum.x*s.partitioningBBoxRatio)*s.subDiv.X*s.partitioningBBoxRatio/s.bbSize.x),o=Math.floor((t-r.minimum.y*s.partitioningBBoxRatio)*s.subDiv.Y*s.partitioningBBoxRatio/s.bbSize.y),l=Math.floor((i-r.minimum.z*s.partitioningBBoxRatio)*s.subDiv.Z*s.partitioningBBoxRatio/s.bbSize.z);return a<0||a>s.subDiv.max||o<0||o>s.subDiv.max||l<0||l>s.subDiv.max?null:s.facetPartitioning[a+s.subDiv.max*o+s.subDiv.max*s.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,r,s=!1,a=!0){const o=this.getWorldMatrix(),l=B.Matrix[5];o.invertToRef(l);const c=B.Vector3[8];m.TransformCoordinatesFromFloatsToRef(e,t,i,l,c);const u=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,r,s,a);return r&&m.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,o,r),u}getClosestFacetAtLocalCoordinates(e,t,i,r,s=!1,a=!0){let o=null,l=0,c=0,u=0,h=0,f=0,d=0,p=0,_=0;const g=this.getFacetLocalPositions(),E=this.getFacetLocalNormals(),v=this.getFacetsAtLocalCoordinates(e,t,i);if(!v)return null;let x=Number.MAX_VALUE,A=x,T,C,y;for(let P=0;P<v.length;P++)T=v[P],C=E[T],y=g[T],h=(e-y.x)*C.x+(t-y.y)*C.y+(i-y.z)*C.z,(!s||s&&a&&h>=0||s&&!a&&h<=0)&&(h=C.x*y.x+C.y*y.y+C.z*y.z,f=-(C.x*e+C.y*t+C.z*i-h)/(C.x*C.x+C.y*C.y+C.z*C.z),d=e+C.x*f,p=t+C.y*f,_=i+C.z*f,l=d-e,c=p-t,u=_-i,A=l*l+c*c+u*u,A<x&&(x=A,o=T,r&&(r.x=d,r.y=p,r.z=_)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(b.PositionKind),i=this.getIndices();let r;return this.isVerticesDataPresent(b.NormalKind)?r=this.getVerticesData(b.NormalKind):r=[],de.ComputeNormals(t,i,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(b.NormalKind,r,e),this}alignWithNormal(e,t){t||(t=ys.Y);const i=B.Vector3[0],r=B.Vector3[1];return m.CrossToRef(t,e,r),m.CrossToRef(e,r,i),this.rotationQuaternion?ce.RotationQuaternionFromAxisToRef(i,e,r,this.rotationQuaternion):m.RotationFromAxisToRef(i,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw rt("EdgesRenderer")}enableEdgesRendering(e,t,i){throw rt("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}$t.OCCLUSION_TYPE_NONE=0;$t.OCCLUSION_TYPE_OPTIMISTIC=1;$t.OCCLUSION_TYPE_STRICT=2;$t.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;$t.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;$t.CULLINGSTRATEGY_STANDARD=0;$t.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;$t.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;$t.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;I([Xn.filter((...[n,e,t,i,r])=>!Array.isArray(n)&&!Array.isArray(e)&&!Array.isArray(t)&&!Array.isArray(i)&&!Array.isArray(r))],$t,"_ApplySkeleton",null);$("BABYLON.AbstractMesh",$t);class aO{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=$t.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=$t.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}q.prototype.getGPUFrameTimeCounter=function(){return null};q.prototype.captureGPUFrameTime=function(n){};q.prototype.createQuery=function(){return null};q.prototype.deleteQuery=function(n){return this};q.prototype.isQueryResultAvailable=function(n){return!1};q.prototype.getQueryResult=function(n){return 0};q.prototype.beginOcclusionQuery=function(n,e){return!1};q.prototype.endOcclusionQuery=function(n){return this};Object.defineProperty($t.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(n){this._occlusionDataStorage.isOcclusionQueryInProgress=n},enumerable:!1,configurable:!0});Object.defineProperty($t.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new aO),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty($t.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(n){this._occlusionDataStorage.isOccluded=n},enumerable:!0,configurable:!0});Object.defineProperty($t.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(n){this._occlusionDataStorage.occlusionQueryAlgorithmType=n},enumerable:!0,configurable:!0});Object.defineProperty($t.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(n){this._occlusionDataStorage.occlusionType=n},enumerable:!0,configurable:!0});Object.defineProperty($t.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(n){this._occlusionDataStorage.occlusionRetryCount=n},enumerable:!0,configurable:!0});Object.defineProperty($t.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(n){this._occlusionDataStorage.forceRenderingWhenOccluded=n},enumerable:!0,configurable:!0});$t.prototype._checkOcclusionQuery=function(){const n=this._occlusionDataStorage;if(n.occlusionType===$t.OCCLUSION_TYPE_NONE)return n.isOccluded=!1,!1;const e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return n.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery!==null&&this._occlusionQuery!==void 0)if(e.isQueryResultAvailable(this._occlusionQuery)){const r=e.getQueryResult(this._occlusionQuery);n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=!(r>0)}else if(n.occlusionInternalRetryCounter++,n.occlusionRetryCount!==-1&&n.occlusionInternalRetryCounter>n.occlusionRetryCount)n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=n.occlusionType===$t.OCCLUSION_TYPE_OPTIMISTIC?!1:n.isOccluded;else return n.occlusionType===$t.OCCLUSION_TYPE_OPTIMISTIC?!1:n.isOccluded;const t=this.getScene();if(t.getBoundingBoxRenderer){const i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),this._occlusionQuery&&e.beginOcclusionQuery(n.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(n.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return n.isOccluded};const yT=new Q,bT=new Q;Object.defineProperty(q.prototype,"onBeforeViewRenderObservable",{get:function(){return yT}});Object.defineProperty(q.prototype,"onAfterViewRenderObservable",{get:function(){return bT}});Object.defineProperty(q.prototype,"inputElement",{get:function(){return this._inputElement},set:function(n){var e;this._inputElement!==n&&(this._inputElement=n,(e=this._onEngineViewChanged)==null||e.call(this))}});q.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()};q.prototype.registerView=function(n,e,t){this.views||(this.views=[]);for(const s of this.views)if(s.target===n)return s;const i=this.getRenderingCanvas();i&&(n.width=i.width,n.height=i.height);const r={target:n,camera:e,clearBeforeCopy:t,enabled:!0,id:(Math.random()*1e5).toFixed()};return this.views.push(r),e&&!Array.isArray(e)&&e.onDisposeObservable.add(()=>{this.unRegisterView(n)}),r};q.prototype.unRegisterView=function(n){if(!this.views||this.views.length===0)return this;for(const e of this.views)if(e.target===n){const t=this.views.indexOf(e);t!==-1&&this.views.splice(t,1);break}return this};q.prototype._renderViewStep=function(n){const e=n.target,t=e.getContext("2d");if(!t)return!0;const i=this.getRenderingCanvas();yT.notifyObservers(n);const r=n.camera;let s=null,a=null,o=null;if(r&&(o=Array.isArray(r)?r[0].getScene():r.getScene(),s=o.activeCamera,a=o.activeCameras,Array.isArray(r)?o.activeCameras=r:(o.activeCamera=r,o.activeCameras=null)),this.activeView=n,n.customResize)n.customResize(e);else{const l=Math.floor(e.clientWidth/this._hardwareScalingLevel),c=Math.floor(e.clientHeight/this._hardwareScalingLevel),u=l!==e.width||i.width!==e.width||c!==e.height||i.height!==e.height;e.clientWidth&&e.clientHeight&&u&&(e.width=l,e.height=c,this.setSize(l,c))}return!i.width||!i.height?!1:(this._renderFrame(),this.flushFramebuffer(),n.clearBeforeCopy&&t.clearRect(0,0,i.width,i.height),t.drawImage(i,0,0),o&&(o.activeCameras=a,o.activeCamera=s),bT.notifyObservers(n),!0)};q.prototype._renderViews=function(){if(!this.views||this.views.length===0||!this.getRenderingCanvas())return!1;let e;for(const t of this.views){if(!t.enabled)continue;if(t.target===this.inputElement){e=t;continue}if(!this._renderViewStep(t))return!1}return e&&!this._renderViewStep(e)?!1:(this.activeView=null,!0)};q.prototype._debugPushGroup=function(n,e){};q.prototype._debugPopGroup=function(n){};q.prototype._debugInsertMarker=function(n,e){};q.prototype._debugFlushPendingCommands=function(){};class oO{constructor(){this._timeElapsedQueryEnded=!1}}Se.prototype.createQuery=function(){const n=this._gl.createQuery();if(!n)throw new Error("Unable to create Occlusion Query");return n};Se.prototype.deleteQuery=function(n){return this._gl.deleteQuery(n),this};Se.prototype.isQueryResultAvailable=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT_AVAILABLE)};Se.prototype.getQueryResult=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT)};Se.prototype.beginOcclusionQuery=function(n,e){const t=this._getGlAlgorithmType(n);return this._gl.beginQuery(t,e),!0};Se.prototype.endOcclusionQuery=function(n){const e=this._getGlAlgorithmType(n);return this._gl.endQuery(e),this};Se.prototype._createTimeQuery=function(){const n=this.getCaps().timerQuery;return n.createQueryEXT?n.createQueryEXT():this.createQuery()};Se.prototype._deleteTimeQuery=function(n){const e=this.getCaps().timerQuery;if(e.deleteQueryEXT){e.deleteQueryEXT(n);return}this.deleteQuery(n)};Se.prototype._getTimeQueryResult=function(n){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(n,e.QUERY_RESULT_EXT):this.getQueryResult(n)};Se.prototype._getTimeQueryAvailability=function(n){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(n,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(n)};Se.prototype.startTimeQuery=function(){const n=this.getCaps(),e=n.timerQuery;if(!e)return null;const t=new oO;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),n.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),t._startTimeQuery&&e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),t._timeElapsedQuery&&(e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery)),this._currentNonTimestampToken=t}return t};Se.prototype.endTimeQuery=function(n){const e=this.getCaps(),t=e.timerQuery;if(!t||!n)return-1;if(e.canUseTimestampForTimerQuery){if(!n._startTimeQuery)return-1;n._endTimeQuery||(n._endTimeQuery=this._createTimeQuery(),n._endTimeQuery&&t.queryCounterEXT(n._endTimeQuery,t.TIMESTAMP_EXT))}else if(!n._timeElapsedQueryEnded){if(!n._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),n._timeElapsedQueryEnded=!0}const i=this._gl.getParameter(t.GPU_DISJOINT_EXT);let r=!1;if(n._endTimeQuery?r=this._getTimeQueryAvailability(n._endTimeQuery):n._timeElapsedQuery&&(r=this._getTimeQueryAvailability(n._timeElapsedQuery)),r&&!i){let s=0;if(e.canUseTimestampForTimerQuery){if(!n._startTimeQuery||!n._endTimeQuery)return-1;const a=this._getTimeQueryResult(n._startTimeQuery);s=this._getTimeQueryResult(n._endTimeQuery)-a,this._deleteTimeQuery(n._startTimeQuery),this._deleteTimeQuery(n._endTimeQuery),n._startTimeQuery=null,n._endTimeQuery=null}else{if(!n._timeElapsedQuery)return-1;s=this._getTimeQueryResult(n._timeElapsedQuery),this._deleteTimeQuery(n._timeElapsedQuery),n._timeElapsedQuery=null,n._timeElapsedQueryEnded=!1}return s}return-1};Se.prototype._captureGPUFrameTime=!1;Se.prototype._gpuFrameTime=new ps;Se.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime};Se.prototype.captureGPUFrameTime=function(n){n!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=n,n?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))};Se.prototype._getGlAlgorithmType=function(n){return n===$t.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};Se.prototype.createTransformFeedback=function(){const n=this._gl.createTransformFeedback();if(!n)throw new Error("Unable to create Transform Feedback");return n};Se.prototype.deleteTransformFeedback=function(n){this._gl.deleteTransformFeedback(n)};Se.prototype.bindTransformFeedback=function(n){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,n)};Se.prototype.beginTransformFeedback=function(n=!0){this._gl.beginTransformFeedback(n?this._gl.POINTS:this._gl.TRIANGLES)};Se.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};Se.prototype.setTranformFeedbackVaryings=function(n,e){this._gl.transformFeedbackVaryings(n,e,this._gl.INTERLEAVED_ATTRIBS)};Se.prototype.bindTransformFeedbackBuffer=function(n){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,n?n.underlyingResource:null)};Se.prototype.readTransformFeedbackBuffer=function(n){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,n)};class He extends Lt{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===He.PERSPECTIVE_CAMERA)this.fovMode===He.FOVMODE_VERTICAL_FIXED?(t=this.minZ*2*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=this.minZ*2*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{const i=this.getEngine().getRenderWidth()/2,r=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??r)-(this.orthoBottom??-r)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,r=!0){super(e,i,!1),this._position=m.Zero(),this._upVector=m.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=He.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Hn(0,0,1,1),this.layerMask=268435455,this.fovMode=He.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=He.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new Q,this.onProjectionMatrixChangedObservable=new Q,this.onAfterCheckInputsObservable=new Q,this.onRestoreStateObservable=new Q,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new O,this._postProcesses=new Array,this._activeMeshes=new pr(256),this._globalPosition=m.Zero(),this._computedViewMatrix=O.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=O.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=ce.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===He.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==He.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const r=this._rigCameras[t],s=r._rigPostProcess;s?(s.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(w.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return O.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var s,a,o;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const t=this.getEngine(),i=this.getScene(),r=t.useReverseDepthBuffer;if(this.mode===He.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let l;i.useRightHandedSystem?l=O.PerspectiveFovRHToRef:l=O.PerspectiveFovLHToRef,l(this.fov,t.getAspectRatio(this),r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===He.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,r)}else{const l=t.getRenderWidth()/2,c=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?O.ObliqueOffCenterRHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):O.OrthoOffCenterRHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?O.ObliqueOffCenterLHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):O.OrthoOffCenterLHToRef(this.orthoLeft??-l,this.orthoRight??l,this.orthoBottom??-c,this.orthoTop??c,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=(s=this.oblique)==null?void 0:s.angle,this._cache.obliqueLength=(a=this.oblique)==null?void 0:a.length,this._cache.obliqueOffset=(o=this.oblique)==null?void 0:o.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){const t=this,i=this;return(t.radius||(i.target?m.Distance(this.position,i.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Ts.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Ts.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(r=>{r._updateFrustumPlanes(),i=i||e.isInFrustum(r._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw rt("Ray")}getForwardRayToRef(e,t=100,i,r){throw rt("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){const r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==He.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){const s=this._postProcesses[r];s&&s.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=J.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==He.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),i&&r&&(this._rigCameras.push(i),this._rigCameras.push(r))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return O.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=J.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=Ke.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),Ke.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=Ke.Clone(He.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=m.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){m.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,s=!0){const a=Lt.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:s});return a||(()=>He._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,r=He.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),s=Ke.Parse(r,e,t);if(e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s.inputs&&(s.inputs.parse(e),s._setupInputs()),e.upVector&&(s.upVector=m.FromArray(e.upVector)),s.setPosition&&(s.position.copyFromFloats(0,0,0),s.setPosition(m.FromArray(e.position))),e.target&&s.setTarget&&s.setTarget(m.FromArray(e.target)),e.cameraRigMode){const a=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};s.setCameraRigMode(e.cameraRigMode,a)}if(e.animations){for(let a=0;a<e.animations.length;a++){const o=e.animations[a],l=Ai("BABYLON.Animation");l&&s.animations.push(l.Parse(o))}Lt.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&s.setEnabled(e.isEnabled),s}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}He._CreateDefaultParsedCamera=(n,e)=>{throw rt("UniversalCamera")};He.PERSPECTIVE_CAMERA=0;He.ORTHOGRAPHIC_CAMERA=1;He.FOVMODE_VERTICAL_FIXED=0;He.FOVMODE_HORIZONTAL_FIXED=1;He.RIG_MODE_NONE=0;He.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;He.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;He.RIG_MODE_STEREOSCOPIC_INTERLACED=14;He.RIG_MODE_VR=20;He.RIG_MODE_CUSTOM=22;He.ForceAttachControlToAlwaysPreventDefault=!1;I([Ar("position")],He.prototype,"_position",void 0);I([Ar("upVector")],He.prototype,"_upVector",void 0);I([M()],He.prototype,"orthoLeft",null);I([M()],He.prototype,"orthoRight",null);I([M()],He.prototype,"orthoBottom",null);I([M()],He.prototype,"orthoTop",null);I([M()],He.prototype,"fov",void 0);I([M()],He.prototype,"projectionPlaneTilt",void 0);I([M()],He.prototype,"minZ",void 0);I([M()],He.prototype,"maxZ",void 0);I([M()],He.prototype,"inertia",void 0);I([M()],He.prototype,"mode",null);I([M()],He.prototype,"layerMask",void 0);I([M()],He.prototype,"fovMode",void 0);I([M()],He.prototype,"cameraRigMode",void 0);I([M()],He.prototype,"interaxialDistance",void 0);I([M()],He.prototype,"isStereoscopicSideBySide",void 0);class cd{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],r=e(t,i);if(r)return r}return null}}function RT(n){n.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}class xi{constructor(){this._dirty=!0,this._tempColor=new Be(0,0,0,0),this._globalCurve=new Be(0,0,0,0),this._highlightsCurve=new Be(0,0,0,0),this._midtonesCurve=new Be(0,0,0,0),this._shadowsCurve=new Be(0,0,0,0),this._positiveCurve=new Be(0,0,0,0),this._negativeCurve=new Be(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,r,s){e!=null&&(e=xi._Clamp(e,0,360),t=xi._Clamp(t,-100,100),i=xi._Clamp(i,-100,100),r=xi._Clamp(r,-100,100),t=xi._ApplyColorGradingSliderNonlinear(t),t*=.5,r=xi._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),xi._FromHSBToRef(e,t,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let s=xi._Clamp(e,0,360);const a=xi._Clamp(t/100,0,1),o=xi._Clamp(i/100,0,1);if(a===0)r.r=o,r.g=o,r.b=o;else{s/=60;const l=Math.floor(s),c=s-l,u=o*(1-a),h=o*(1-a*c),f=o*(1-a*(1-c));switch(l){case 0:r.r=o,r.g=f,r.b=u;break;case 1:r.r=h,r.g=o,r.b=u;break;case 2:r.r=u,r.g=o,r.b=f;break;case 3:r.r=u,r.g=h,r.b=o;break;case 4:r.r=f,r.g=u,r.b=o;break;default:r.r=o,r.g=u,r.b=h;break}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return Ke.Clone(()=>new xi,this)}serialize(){return Ke.Serialize(this)}static Parse(e){return Ke.Parse(()=>new xi,e,null,null)}}xi.PrepareUniforms=RT;I([M()],xi.prototype,"_globalHue",void 0);I([M()],xi.prototype,"_globalDensity",void 0);I([M()],xi.prototype,"_globalSaturation",void 0);I([M()],xi.prototype,"_globalExposure",void 0);I([M()],xi.prototype,"_highlightsHue",void 0);I([M()],xi.prototype,"_highlightsDensity",void 0);I([M()],xi.prototype,"_highlightsSaturation",void 0);I([M()],xi.prototype,"_highlightsExposure",void 0);I([M()],xi.prototype,"_midtonesHue",void 0);I([M()],xi.prototype,"_midtonesDensity",void 0);I([M()],xi.prototype,"_midtonesSaturation",void 0);I([M()],xi.prototype,"_midtonesExposure",void 0);Ke._ColorCurvesParser=xi.Parse;function PT(n,e){e.EXPOSURE&&n.push("exposureLinear"),e.CONTRAST&&n.push("contrast"),e.COLORGRADING&&n.push("colorTransformSettings"),(e.VIGNETTE||e.DITHER)&&n.push("vInverseScreenSize"),e.VIGNETTE&&(n.push("vignetteSettings1"),n.push("vignetteSettings2")),e.COLORCURVES&&RT(n),e.DITHER&&n.push("ditherIntensity")}function MT(n,e){e.COLORGRADING&&n.push("txColorTransform")}class It{constructor(){this.colorCurves=new xi,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=It.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Be(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=It.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new Q}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===It._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,!this._toneMappingEnabled)e.TONEMAPPING=0;else switch(this._toneMappingType){case It.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case It.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&xi.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const s=t??r/i;let a=Math.tan(this.vignetteCameraFov*.5),o=a*s;const l=Math.sqrt(o*a);o=id(o,l,this.vignetteStretch),a=id(a,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,a,-o*this.vignetteCenterX,-a*this.vignetteCenterY);const c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return Ke.Clone(()=>new It,this)}serialize(){return Ke.Serialize(this)}static Parse(e){const t=Ke.Parse(()=>new It,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}It.TONEMAPPING_STANDARD=0;It.TONEMAPPING_ACES=1;It.TONEMAPPING_KHR_PBR_NEUTRAL=2;It.PrepareUniforms=PT;It.PrepareSamplers=MT;It._VIGNETTEMODE_MULTIPLY=0;It._VIGNETTEMODE_OPAQUE=1;I([ED()],It.prototype,"colorCurves",void 0);I([M()],It.prototype,"_colorCurvesEnabled",void 0);I([Rt("colorGradingTexture")],It.prototype,"_colorGradingTexture",void 0);I([M()],It.prototype,"_colorGradingEnabled",void 0);I([M()],It.prototype,"_colorGradingWithGreenDepth",void 0);I([M()],It.prototype,"_colorGradingBGR",void 0);I([M()],It.prototype,"_exposure",void 0);I([M()],It.prototype,"_toneMappingEnabled",void 0);I([M()],It.prototype,"_toneMappingType",void 0);I([M()],It.prototype,"_contrast",void 0);I([M()],It.prototype,"vignetteStretch",void 0);I([M()],It.prototype,"vignetteCenterX",void 0);I([M()],It.prototype,"vignetteCenterY",void 0);I([M()],It.prototype,"vignetteWeight",void 0);I([rT()],It.prototype,"vignetteColor",void 0);I([M()],It.prototype,"vignetteCameraFov",void 0);I([M()],It.prototype,"_vignetteBlendMode",void 0);I([M()],It.prototype,"_vignetteEnabled",void 0);I([M()],It.prototype,"_ditheringEnabled",void 0);I([M()],It.prototype,"_ditheringIntensity",void 0);I([M()],It.prototype,"_skipFinalColorClamp",void 0);I([M()],It.prototype,"_applyByPostProcess",void 0);I([M()],It.prototype,"_isEnabled",void 0);Ke._ImageProcessingConfigurationParser=It.Parse;$("BABYLON.ImageProcessingConfiguration",It);class Ei{constructor(e,t,i,r,s,a){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=a}static CreateNew(e,t,i){const r=e.getScene();return new Ei(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new Ei(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new Ei(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new Ei(e,t.x,t.y,null,i,r)}}class we{}we.NAME_EFFECTLAYER="EffectLayer";we.NAME_LAYER="Layer";we.NAME_LENSFLARESYSTEM="LensFlareSystem";we.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";we.NAME_PARTICLESYSTEM="ParticleSystem";we.NAME_GAMEPAD="Gamepad";we.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";we.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";we.NAME_PREPASSRENDERER="PrePassRenderer";we.NAME_DEPTHRENDERER="DepthRenderer";we.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";we.NAME_IBLSHADOWSRENDERER="IblShadowsRenderer";we.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";we.NAME_SPRITE="Sprite";we.NAME_SUBSURFACE="SubSurface";we.NAME_OUTLINERENDERER="Outline";we.NAME_PROCEDURALTEXTURE="ProceduralTexture";we.NAME_SHADOWGENERATOR="ShadowGenerator";we.NAME_OCTREE="Octree";we.NAME_PHYSICSENGINE="PhysicsEngine";we.NAME_AUDIO="Audio";we.NAME_FLUIDRENDERER="FluidRenderer";we.STEP_ISREADYFORMESH_EFFECTLAYER=0;we.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;we.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;we.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;we.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;we.STEP_BEFORECAMERADRAW_PREPASS=0;we.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;we.STEP_BEFORECAMERADRAW_LAYER=2;we.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;we.STEP_BEFORERENDERTARGETDRAW_LAYER=1;we.STEP_BEFORERENDERINGMESH_PREPASS=0;we.STEP_BEFORERENDERINGMESH_OUTLINE=1;we.STEP_AFTERRENDERINGMESH_PREPASS=0;we.STEP_AFTERRENDERINGMESH_OUTLINE=1;we.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;we.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;we.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;we.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;we.STEP_BEFORECLEAR_PREPASS=1;we.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;we.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;we.STEP_AFTERRENDERTARGETDRAW_LAYER=1;we.STEP_AFTERCAMERADRAW_PREPASS=0;we.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;we.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;we.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;we.STEP_AFTERCAMERADRAW_LAYER=4;we.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;we.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;we.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;we.STEP_AFTERRENDER_AUDIO=0;we.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;we.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;we.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;we.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;we.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;we.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;we.STEP_POINTERMOVE_SPRITE=0;we.STEP_POINTERDOWN_SPRITE=0;we.STEP_POINTERUP_SPRITE=0;class Oi extends Array{constructor(e){super(...e)}static Create(){return Object.create(Oi.prototype)}registerStep(e,t,i){let r=0,s=Number.MAX_VALUE;for(;r<this.length&&(s=this[r].index,!(e<s));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class tt{}tt.POINTERDOWN=1;tt.POINTERUP=2;tt.POINTERMOVE=4;tt.POINTERWHEEL=8;tt.POINTERPICK=16;tt.POINTERTAP=32;tt.POINTERDOUBLETAP=64;class DT{constructor(e,t){this.type=e,this.event=t}}class lO extends DT{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new se(i,r)}}class Mn extends DT{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class cs{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(const e in cs.Triggers)if(Object.prototype.hasOwnProperty.call(cs.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in cs.Triggers)if(Object.prototype.hasOwnProperty.call(cs.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in cs.Triggers)if(Object.prototype.hasOwnProperty.call(cs.Triggers,t)&&parseInt(t)===e)return!0;return!1}}cs.Triggers={};class gn{}gn.KEYDOWN=1;gn.KEYUP=2;class ud{constructor(e,t){this.type=e,this.event=t}}class Ym extends ud{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var Ze;(function(n){n[n.Generic=0]="Generic",n[n.Keyboard=1]="Keyboard",n[n.Mouse=2]="Mouse",n[n.Touch=3]="Touch",n[n.DualShock=4]="DualShock",n[n.Xbox=5]="Xbox",n[n.Switch=6]="Switch",n[n.DualSense=7]="DualSense"})(Ze||(Ze={}));var lt;(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.LeftClick=2]="LeftClick",n[n.MiddleClick=3]="MiddleClick",n[n.RightClick=4]="RightClick",n[n.BrowserBack=5]="BrowserBack",n[n.BrowserForward=6]="BrowserForward",n[n.MouseWheelX=7]="MouseWheelX",n[n.MouseWheelY=8]="MouseWheelY",n[n.MouseWheelZ=9]="MouseWheelZ",n[n.Move=12]="Move"})(lt||(lt={}));var $m;(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.LeftClick=2]="LeftClick",n[n.MiddleClick=3]="MiddleClick",n[n.RightClick=4]="RightClick",n[n.BrowserBack=5]="BrowserBack",n[n.BrowserForward=6]="BrowserForward",n[n.MouseWheelX=7]="MouseWheelX",n[n.MouseWheelY=8]="MouseWheelY",n[n.MouseWheelZ=9]="MouseWheelZ",n[n.DeltaHorizontal=10]="DeltaHorizontal",n[n.DeltaVertical=11]="DeltaVertical"})($m||($m={}));var Km;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.L2=6]="L2",n[n.R2=7]="R2",n[n.Share=8]="Share",n[n.Options=9]="Options",n[n.L3=10]="L3",n[n.R3=11]="R3",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.TouchPad=17]="TouchPad",n[n.LStickXAxis=18]="LStickXAxis",n[n.LStickYAxis=19]="LStickYAxis",n[n.RStickXAxis=20]="RStickXAxis",n[n.RStickYAxis=21]="RStickYAxis"})(Km||(Km={}));var jm;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.L2=6]="L2",n[n.R2=7]="R2",n[n.Create=8]="Create",n[n.Options=9]="Options",n[n.L3=10]="L3",n[n.R3=11]="R3",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.TouchPad=17]="TouchPad",n[n.LStickXAxis=18]="LStickXAxis",n[n.LStickYAxis=19]="LStickYAxis",n[n.RStickXAxis=20]="RStickXAxis",n[n.RStickYAxis=21]="RStickYAxis"})(jm||(jm={}));var qm;(function(n){n[n.A=0]="A",n[n.B=1]="B",n[n.X=2]="X",n[n.Y=3]="Y",n[n.LB=4]="LB",n[n.RB=5]="RB",n[n.LT=6]="LT",n[n.RT=7]="RT",n[n.Back=8]="Back",n[n.Start=9]="Start",n[n.LS=10]="LS",n[n.RS=11]="RS",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.LStickXAxis=17]="LStickXAxis",n[n.LStickYAxis=18]="LStickYAxis",n[n.RStickXAxis=19]="RStickXAxis",n[n.RStickYAxis=20]="RStickYAxis"})(qm||(qm={}));var Zm;(function(n){n[n.B=0]="B",n[n.A=1]="A",n[n.Y=2]="Y",n[n.X=3]="X",n[n.L=4]="L",n[n.R=5]="R",n[n.ZL=6]="ZL",n[n.ZR=7]="ZR",n[n.Minus=8]="Minus",n[n.Plus=9]="Plus",n[n.LS=10]="LS",n[n.RS=11]="RS",n[n.DPadUp=12]="DPadUp",n[n.DPadDown=13]="DPadDown",n[n.DPadLeft=14]="DPadLeft",n[n.DPadRight=15]="DPadRight",n[n.Home=16]="Home",n[n.Capture=17]="Capture",n[n.LStickXAxis=18]="LStickXAxis",n[n.LStickYAxis=19]="LStickYAxis",n[n.RStickXAxis=20]="RStickXAxis",n[n.RStickYAxis=21]="RStickYAxis"})(Zm||(Zm={}));var Qm;(function(n){n[n.PointerMove=0]="PointerMove",n[n.PointerDown=1]="PointerDown",n[n.PointerUp=2]="PointerUp"})(Qm||(Qm={}));class ll{}ll.DOM_DELTA_PIXEL=0;ll.DOM_DELTA_LINE=1;ll.DOM_DELTA_PAGE=2;class Va{static CreateDeviceEvent(e,t,i,r,s,a,o){switch(e){case Ze.Keyboard:return this._CreateKeyboardEvent(i,r,s,a);case Ze.Mouse:if(i===lt.MouseWheelX||i===lt.MouseWheelY||i===lt.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,s,a);case Ze.Touch:return this._CreatePointerEvent(e,t,i,r,s,a,o);default:throw`Unable to generate event for device ${Ze[e]}`}}static _CreatePointerEvent(e,t,i,r,s,a,o){const l=this._CreateMouseEvent(e,t,i,r,s,a);e===Ze.Mouse?(l.deviceType=Ze.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=Ze.Touch,l.pointerId=o??t,l.pointerType="touch");let c=0;return c+=s.pollInput(e,t,lt.LeftClick),c+=s.pollInput(e,t,lt.RightClick)*2,c+=s.pollInput(e,t,lt.MiddleClick)*4,l.buttons=c,i===lt.Move?l.type="pointermove":i>=lt.LeftClick&&i<=lt.RightClick&&(l.type=r===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,r,s,a){const o=this._CreateMouseEvent(e,t,i,r,s,a);switch(o.pointerId=1,o.type="wheel",o.deltaMode=ll.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case lt.MouseWheelX:o.deltaX=r;break;case lt.MouseWheelY:o.deltaY=r;break;case lt.MouseWheelZ:o.deltaZ=r;break}return o}static _CreateMouseEvent(e,t,i,r,s,a){const o=this._CreateEvent(a),l=s.pollInput(e,t,lt.Horizontal),c=s.pollInput(e,t,lt.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=s.pollInput(e,t,10),o.movementY=s.pollInput(e,t,11),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,s),o.clientX=l,o.clientY=c,o.x=l,o.y=c,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,r){const s=this._CreateEvent(r);return this._CheckNonCharacterKeys(s,i),s.deviceType=Ze.Keyboard,s.deviceSlot=0,s.inputIndex=e,s.type=t===1?"keydown":"keyup",s.key=String.fromCharCode(e),s.keyCode=e,s}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Ze.Keyboard),r=i&&t.pollInput(Ze.Keyboard,0,18)===1,s=i&&t.pollInput(Ze.Keyboard,0,17)===1,a=i&&(t.pollInput(Ze.Keyboard,0,91)===1||t.pollInput(Ze.Keyboard,0,92)===1||t.pollInput(Ze.Keyboard,0,93)===1),o=i&&t.pollInput(Ze.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=s,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class cO{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(r,s,a,o)=>{const l=Va.CreateDeviceEvent(r,s,a,o,this);i(r,s,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Ze.Mouse||e===Ze.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const Jm=255,eg=Object.keys(lt).length/2;class uO{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=J.IsSafari(),this._usingMacOS=Ro()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=s=>{},this._keyboardUpEvent=s=>{},this._keyboardBlurEvent=s=>{},this._pointerMoveEvent=s=>{},this._pointerDownEvent=s=>{},this._pointerUpEvent=s=>{},this._pointerCancelEvent=s=>{},this._pointerWheelEvent=s=>{},this._pointerBlurEvent=s=>{},this._pointerMacOSChromeOutEvent=s=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Ro()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._isUsingChromium=Ro()&&navigator.userAgent&&navigator.userAgent.indexOf("Chrome")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=s=>{},this._gamepadDisconnectedEvent=s=>{},this._eventPrefix=J.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const r=this._inputs[e][t];if(!r)throw`Unable to find device ${Ze[e]}`;e>=Ze.DualShock&&e<=Ze.DualSense&&this._updateDevice(e,t,i);const s=r[i];if(s===void 0)throw`Unable to find input ${i} for device ${Ze[e]} in slot ${t}`;return i===lt.Move&&J.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),s}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this==null?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const r=+i,s=t[r];if(s)for(let a=0;a<s.length;a++)s[a]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Ze.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,eg);const s=this._inputs[e][t];s[0]=i,s[1]=r}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${Ze[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Ze.Keyboard,0,Jm));const t=this._inputs[Ze.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Ze.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Ze.Keyboard,0,Jm));const t=this._inputs[Ze.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const r of this._metaKeys){const s=Va.CreateDeviceEvent(Ze.Keyboard,0,r,0,this,this._elementToAttachTo);t[r]=0,this._onInputChanged(Ze.Keyboard,0,s)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Ze.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Ze.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=Va.CreateDeviceEvent(Ze.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Ze.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Ro()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const r=this._getPointerType(i);let s=r===Ze.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===Ze.Touch&&s===-1){const o=this._activeTouchIds.indexOf(-1);if(o>=0)s=o,this._activeTouchIds[o]=i.pointerId,this._onDeviceConnected(r,s);else{J.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]||this._addPointerDevice(r,s,i.clientX,i.clientY);const a=this._inputs[r][s];if(a){const o=i;o.inputIndex=lt.Move,a[lt.Horizontal]=i.clientX,a[lt.Vertical]=i.clientY,r===Ze.Touch&&a[lt.LeftClick]===0&&(a[lt.LeftClick]=1),i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(r,s,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,a[i.button+2]=a[i.button+2]?0:1,this._onInputChanged(r,s,o))}},this._pointerDownEvent=i=>{const r=this._getPointerType(i);let s=r===Ze.Mouse?0:i.pointerId;if(r===Ze.Touch){let o=this._activeTouchIds.indexOf(i.pointerId);if(o===-1&&(o=this._activeTouchIds.indexOf(-1)),o>=0)s=o,this._activeTouchIds[o]=i.pointerId;else{J.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][s]?r===Ze.Touch&&this._onDeviceConnected(r,s):this._addPointerDevice(r,s,i.clientX,i.clientY);const a=this._inputs[r][s];if(a){const o=a[lt.Horizontal],l=a[lt.Vertical];if(r===Ze.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}a[lt.Horizontal]=i.clientX,a[lt.Vertical]=i.clientY,a[i.button+2]=1;const c=i;c.inputIndex=i.button+2,this._onInputChanged(r,s,c),(o!==i.clientX||l!==i.clientY)&&(c.inputIndex=lt.Move,this._onInputChanged(r,s,c))}},this._pointerUpEvent=i=>{var o,l,c,u,h;const r=this._getPointerType(i),s=r===Ze.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===Ze.Touch){if(s===-1)return;this._activeTouchIds[s]=-1}const a=(o=this._inputs[r])==null?void 0:o[s];if(a&&a[i.button+2]!==0){const f=a[lt.Horizontal],d=a[lt.Vertical];a[lt.Horizontal]=i.clientX,a[lt.Vertical]=i.clientY,a[i.button+2]=0;const p=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(f!==i.clientX||d!==i.clientY)&&(p.inputIndex=lt.Move,this._onInputChanged(r,s,p)),p.inputIndex=i.button+2,r===Ze.Mouse&&this._mouseId>=0&&((c=(l=this._elementToAttachTo).hasPointerCapture)!=null&&c.call(l,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&((h=(u=this._elementToAttachTo).hasPointerCapture)!=null&&h.call(u,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(r,s,p),r===Ze.Touch&&this._onDeviceDisconnected(r,s)}},this._pointerCancelEvent=i=>{var r,s,a,o;if(i.pointerType==="mouse"){const l=this._inputs[Ze.Mouse][0];this._mouseId>=0&&((s=(r=this._elementToAttachTo).hasPointerCapture)!=null&&s.call(r,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=lt.LeftClick;c<=lt.BrowserForward;c++)if(l[c]===1){l[c]=0;const u=Va.CreateDeviceEvent(Ze.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(Ze.Mouse,0,u)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);if(l===-1)return;(o=(a=this._elementToAttachTo).hasPointerCapture)!=null&&o.call(a,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[Ze.Touch][l][lt.LeftClick]=0;const c=Va.CreateDeviceEvent(Ze.Touch,l,lt.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(Ze.Touch,l,c),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(Ze.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,r,s,a,o;if(this.isDeviceAvailable(Ze.Mouse)){const l=this._inputs[Ze.Mouse][0];this._mouseId>=0&&((r=(i=this._elementToAttachTo).hasPointerCapture)!=null&&r.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=lt.LeftClick;c<=lt.BrowserForward;c++)if(l[c]===1){l[c]=0;const u=Va.CreateDeviceEvent(Ze.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(Ze.Mouse,0,u)}}if(this.isDeviceAvailable(Ze.Touch)){const l=this._inputs[Ze.Touch];for(let c=0;c<this._activeTouchIds.length;c++){const u=this._activeTouchIds[c];if((a=(s=this._elementToAttachTo).hasPointerCapture)!=null&&a.call(s,u)&&this._elementToAttachTo.releasePointerCapture(u),u!==-1&&((o=l[c])==null?void 0:o[lt.LeftClick])===1){l[c][lt.LeftClick]=0;const h=Va.CreateDeviceEvent(Ze.Touch,c,lt.LeftClick,0,this,this._elementToAttachTo,u);this._onInputChanged(Ze.Touch,c,h),this._activeTouchIds[c]=-1,this._onDeviceDisconnected(Ze.Touch,c)}}}},this._pointerWheelEvent=i=>{const r=Ze.Mouse,s=0;this._inputs[r]||(this._inputs[r]=[]),this._inputs[r][s]||(this._pointerActive=!0,this._registerDevice(r,s,eg));const a=this._inputs[r][s];if(a){a[lt.MouseWheelX]=i.deltaX||0,a[lt.MouseWheelY]=i.deltaY||i.wheelDelta||0,a[lt.MouseWheelZ]=i.deltaZ||0;const o=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),a[lt.MouseWheelX]!==0&&(o.inputIndex=lt.MouseWheelX,this._onInputChanged(r,s,o)),a[lt.MouseWheelY]!==0&&(o.inputIndex=lt.MouseWheelY,this._onInputChanged(r,s,o)),a[lt.MouseWheelZ]!==0&&(o.inputIndex=lt.MouseWheelZ,this._onInputChanged(r,s,o))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=i=>{i.buttons>1&&this._pointerCancelEvent(i)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Ze.Mouse)){const i=this._inputs[Ze.Mouse][0];i[lt.MouseWheelX]=0,i[lt.MouseWheelY]=0,i[lt.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){const s=this._inputs[e][t];i>=r.buttons.length?s[i]=r.axes[i-r.buttons.length].valueOf():s[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?Ze.DualSense:Ze.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?Ze.Xbox:e.indexOf("057e")!==-1?Ze.Switch:Ze.Generic}_getPointerType(e){let t=Ze.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=Ze.Touch),t}}class tg{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new Q,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class hO{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=a=>{for(let o=0;o<this._devices.length;o++){const l=this._devices[o];for(const c in l){const u=+c;a._addDevice(new tg(this._deviceInputSystem,o,u))}}this._registeredManagers.push(a)},this.unregisterManager=a=>{const o=this._registeredManagers.indexOf(a);o>-1&&this._registeredManagers.splice(o,1)};const t=Object.keys(Ze).length/2;this._devices=new Array(t);const i=(a,o)=>{this._devices[a]||(this._devices[a]=new Array),this._devices[a][o]||(this._devices[a][o]=o);for(const l of this._registeredManagers){const c=new tg(this._deviceInputSystem,a,o);l._addDevice(c)}},r=(a,o)=>{var l;(l=this._devices[a])!=null&&l[o]&&delete this._devices[a][o];for(const c of this._registeredManagers)c._removeDevice(a,o)},s=(a,o,l)=>{if(l)for(const c of this._registeredManagers)c._onInputChanged(a,o,l)};typeof _native<"u"?this._deviceInputSystem=new cO(i,r,s):this._deviceInputSystem=new uO(e,i,r,s)}dispose(){this._deviceInputSystem.dispose()}}class fO{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(Ze).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new hO(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new Q(i=>{for(const r of this._devices)if(r)for(const s of r)s&&this.onDeviceConnectedObservable.notifyObserver(i,s)}),this.onDeviceDisconnectedObservable=new Q,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var r,s;const i=(r=this._devices[e])==null?void 0:r[t];this.onDeviceDisconnectedObservable.notifyObservers(i),(s=this._devices[e])!=null&&s[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var r,s;(s=(r=this._devices[e])==null?void 0:r[t])==null||s.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Ze.Keyboard:case Ze.Mouse:this._firstDevice[e]=0;break;case Ze.Touch:case Ze.DualSense:case Ze.DualShock:case Ze.Xbox:case Ze.Switch:case Ze.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class dp{}dp._IsPickingAvailable=!1;class ig{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Fi{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._activePointerIds=new Array,this._activePointerIdsCount=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new se(0,0),this._previousStartingPointerPosition=new se(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||$e.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new se(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,r=i.getEngine(),s=r.getInputElement();s&&(s.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(s.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const l of i._pointerMoveStage){e=e||this._pickMove(t);const c=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,c,s)}const a=t.inputIndex>=lt.MouseWheelX&&t.inputIndex<=lt.MouseWheelZ?tt.POINTERWHEEL:tt.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,a));let o;e?(o=new Mn(a,t,e),this._setRayOnPointerInfo(e,t)):(o=new Mn(a,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,a)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&dp._IsPickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,O.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const r=this._scene,s=new lO(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(s.originalPickingInfo=e,s.ray=e.ray,t.pointerType==="xr-near"&&e.originMesh&&(s.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(s,i),!!s.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const a=this._pointerOverMesh._getActionManagerForTrigger();a&&a.hasPointerTriggers&&(s.style.cursor=a.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=lt.Move,!this._checkPrePointerObservable(e,i,tt.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,tt.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const a=e.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,Ei.CreateNew(e.pickedMesh,t,e)),t.button){case 0:a.processTrigger(2,Ei.CreateNew(e.pickedMesh,t,e));break;case 1:a.processTrigger(4,Ei.CreateNew(e.pickedMesh,t,e));break;case 2:a.processTrigger(3,Ei.CreateNew(e.pickedMesh,t,e));break}a.hasSpecificTrigger(8)&&window.setTimeout(()=>{const o=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);o!=null&&o.pickedMesh&&a&&this._activePointerIdsCount!==0&&Date.now()-this._startingPointerTime>Fi.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,a.processTrigger(8,Ei.CreateNew(o.pickedMesh,t)))},Fi.LongPressDelay)}}else for(const a of i._pointerDownStage)e=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r;const s=tt.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,s),r=new Mn(s,t,e),this._setRayOnPointerInfo(e,t)):r=new Mn(s,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,s)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const r=new PointerEvent("pointerup",t);r.inputIndex=lt.Move;const s=new ig;i?s.doubleClick=!0:s.singleClick=!0,!this._checkPrePointerObservable(e,r,tt.POINTERUP)&&this._processPointerUp(e,r,s)}_processPointerUp(e,t,i){const r=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){const a=tt.POINTERPICK,o=new Mn(a,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(o,a)}const s=e.pickedMesh._getActionManagerForTrigger();if(s&&!i.ignore){s.processTrigger(7,Ei.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&s.processTrigger(1,Ei.CreateNew(e.pickedMesh,t,e));const a=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&a&&a.processTrigger(6,Ei.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const s of r._pointerUpStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const s=this._pickedDownMesh._getActionManagerForTrigger(16);s&&s.processTrigger(16,Ei.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const s=new Mn(tt.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(s,tt.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,tt.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let a=0;if(i.singleClick?a=tt.POINTERTAP:i.doubleClick&&(a=tt.POINTERDOUBLETAP),a){const o=new Mn(a,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(a)&&r.onPointerObservable.notifyObservers(o,a)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,r=null){const s=this._scene,a=s.getEngine();r||(r=a.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new fO(a),this._initActionManager=o=>{if(!this._meshPickProceed){const l=s.skipPointerUpPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerUp?null:s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerUpPredicate,s.pointerUpFastCheck,s.cameraToUseForPointers,s.pointerUpTrianglePredicate);this._currentPickResult=l,l&&(o=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return o},this._delayedSimpleClick=(o,l,c)=>{if((Date.now()-this._previousStartingPointerTime>Fi.DoubleClickDelay&&!this._doubleClickOccured||o!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,this._delayedClicks[o])){const u=this._delayedClicks[o].evt,h=tt.POINTERTAP,f=new Mn(h,u,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(h)&&s.onPointerObservable.notifyObservers(f,h),this._delayedClicks[o]=null}},this._initClickEvent=(o,l,c,u)=>{var _,g;const h=new ig;this._currentPickResult=null;let f=null,d=o.hasSpecificMask(tt.POINTERPICK)||l.hasSpecificMask(tt.POINTERPICK)||o.hasSpecificMask(tt.POINTERTAP)||l.hasSpecificMask(tt.POINTERTAP)||o.hasSpecificMask(tt.POINTERDOUBLETAP)||l.hasSpecificMask(tt.POINTERDOUBLETAP);!d&&cs&&(f=this._initActionManager(f,h),f&&(d=f.hasPickTriggers));let p=!1;if(d){const E=c.button;if(h.hasSwiped=this._isPointerSwiping(),!h.hasSwiped){let v=!Fi.ExclusiveDoubleClickMode;if(v||(v=!o.hasSpecificMask(tt.POINTERDOUBLETAP)&&!l.hasSpecificMask(tt.POINTERDOUBLETAP),v&&!cs.HasSpecificTrigger(6)&&(f=this._initActionManager(f,h),f&&(v=!f.hasSpecificTrigger(6)))),v)(Date.now()-this._previousStartingPointerTime>Fi.DoubleClickDelay||E!==this._previousButtonPressed)&&(h.singleClick=!0,u(h,this._currentPickResult),p=!0);else{const A={evt:c,clickInfo:h,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,E,h,u),Fi.DoubleClickDelay)};this._delayedClicks[E]=A}let x=o.hasSpecificMask(tt.POINTERDOUBLETAP)||l.hasSpecificMask(tt.POINTERDOUBLETAP);!x&&cs.HasSpecificTrigger(6)&&(f=this._initActionManager(f,h),f&&(x=f.hasSpecificTrigger(6))),x&&(E===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Fi.DoubleClickDelay&&!this._doubleClickOccured?(!h.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,h.doubleClick=!0,h.ignore=!1,Fi.ExclusiveDoubleClickMode&&this._delayedClicks[E]&&(clearTimeout((_=this._delayedClicks[E])==null?void 0:_.timeoutId),this._delayedClicks[E]=null),u(h,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E,Fi.ExclusiveDoubleClickMode?(this._delayedClicks[E]&&(clearTimeout((g=this._delayedClicks[E])==null?void 0:g.timeoutId),this._delayedClicks[E]=null),u(h,this._previousPickResult)):u(h,this._currentPickResult)),p=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E))}}p||u(h,this._currentPickResult)},this._onPointerMove=o=>{if(this._updatePointerPosition(o),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Fi.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Fi.DragMovementThreshold),a.isPointerLock&&a._verifyPointerLock(),this._checkPrePointerObservable(null,o,o.inputIndex>=lt.MouseWheelX&&o.inputIndex<=lt.MouseWheelZ?tt.POINTERWHEEL:tt.POINTERMOVE)||!s.cameraToUseForPointers&&!s.activeCamera)return;if(s.skipPointerMovePicking){this._processPointerMove(new es,o);return}s.pointerMovePredicate||(s.pointerMovePredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(c.enablePointerMoveEvents||s.constantlyUpdateMeshUnderPointer||c._getActionManagerForTrigger()!==null)&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&c.layerMask)!==0));const l=s._registeredActions>0||s.constantlyUpdateMeshUnderPointer?this._pickMove(o):null;this._processPointerMove(l,o)},this._onPointerDown=o=>{var u;const l=this._activePointerIds.indexOf(-1);if(l===-1?this._activePointerIds.push(o.pointerId):this._activePointerIds[l]=o.pointerId,this._activePointerIdsCount++,this._pickedDownMesh=null,this._meshPickProceed=!1,Fi.ExclusiveDoubleClickMode){for(let h=0;h<this._delayedClicks.length;h++)if(this._delayedClicks[h])if(o.button===h)clearTimeout((u=this._delayedClicks[h])==null?void 0:u.timeoutId);else{const f=this._delayedClicks[h].clickInfo;this._doubleClickOccured=!1,f.singleClick=!0,f.ignore=!1;const d=this._delayedClicks[h].evt,p=tt.POINTERTAP,_=new Mn(p,d,this._currentPickResult);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(p)&&s.onPointerObservable.notifyObservers(_,p),this._delayedClicks[h]=null}}if(this._updatePointerPosition(o),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=o.button),s.preventDefaultOnPointerDown&&r&&(o.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,o,tt.POINTERDOWN)||!s.cameraToUseForPointers&&!s.activeCamera)return;this._pointerCaptures[o.pointerId]=!0,s.pointerDownPredicate||(s.pointerDownPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&h.layerMask)!==0)),this._pickedDownMesh=null;let c;s.skipPointerDownPicking||s._registeredActions===0&&!this._checkForPicking()&&!s.onPointerDown?c=new es:c=s.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,s.pointerDownPredicate,s.pointerDownFastCheck,s.cameraToUseForPointers,s.pointerDownTrianglePredicate),this._processPointerDown(c,o)},this._onPointerUp=o=>{const l=this._activePointerIds.indexOf(o.pointerId);l!==-1&&(this._activePointerIds[l]=-1,this._activePointerIdsCount--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(o),s.preventDefaultOnPointerUp&&r&&(o.preventDefault(),r.focus()),this._initClickEvent(s.onPrePointerObservable,s.onPointerObservable,o,(c,u)=>{if(s.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!c.ignore)){if(this._checkPrePointerObservable(null,o,tt.POINTERUP)){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1);return}c.hasSwiped||(c.singleClick&&s.onPrePointerObservable.hasSpecificMask(tt.POINTERTAP)&&this._checkPrePointerObservable(null,o,tt.POINTERTAP)&&(this._skipPointerTap=!0),c.doubleClick&&s.onPrePointerObservable.hasSpecificMask(tt.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,o,tt.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[o.pointerId]){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1),!(!s.cameraToUseForPointers&&!s.activeCamera)&&(s.pointerUpPredicate||(s.pointerUpPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!s.cameraToUseForPointers||(s.cameraToUseForPointers.layerMask&h.layerMask)!==0)),!this._meshPickProceed&&(cs&&cs.HasTriggers||this._checkForPicking()||s.onPointerUp)&&this._initActionManager(null,c),u||(u=this._currentPickResult),this._processPointerUp(u,o,c),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=o=>{const l=gn.KEYDOWN;if(s.onPreKeyboardObservable.hasObservers()){const c=new Ym(l,o);if(s.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const c=new ud(l,o);s.onKeyboardObservable.notifyObservers(c,l)}s.actionManager&&s.actionManager.processTrigger(14,Ei.CreateNewFromScene(s,o))},this._onKeyUp=o=>{const l=gn.KEYUP;if(s.onPreKeyboardObservable.hasObservers()){const c=new Ym(l,o);if(s.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(s.onKeyboardObservable.hasObservers()){const c=new ud(l,o);s.onKeyboardObservable.notifyObservers(c,l)}s.actionManager&&s.actionManager.processTrigger(15,Ei.CreateNewFromScene(s,o))},this._deviceSourceManager.onDeviceConnectedObservable.add(o=>{o.deviceType===Ze.Mouse?o.onInputChangedObservable.add(l=>{this._originMouseEvent=l,l.inputIndex===lt.LeftClick||l.inputIndex===lt.MiddleClick||l.inputIndex===lt.RightClick||l.inputIndex===lt.BrowserBack||l.inputIndex===lt.BrowserForward?t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===lt.Move?this._onPointerMove(l):(l.inputIndex===lt.MouseWheelX||l.inputIndex===lt.MouseWheelY||l.inputIndex===lt.MouseWheelZ)&&this._onPointerMove(l))}):o.deviceType===Ze.Touch?o.onInputChangedObservable.add(l=>{l.inputIndex===lt.LeftClick&&(t&&o.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._activePointerIdsCount>1&&(this._isMultiTouchGesture=!0)):e&&o.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._activePointerIdsCount===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===lt.Move&&this._onPointerMove(l)}):o.deviceType===Ze.Keyboard&&o.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,r){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const s=this._meshUnderPointerId[t];let a;s&&(a=s._getActionManagerForTrigger(10),a&&a.processTrigger(10,Ei.CreateNew(s,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,a=e._getActionManagerForTrigger(9),a&&a.processTrigger(9,Ei.CreateNew(e,r,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}Fi.DragMovementThreshold=10;Fi.LongPressDelay=500;Fi.DoubleClickDelay=300;Fi.ExclusiveDoubleClickMode=!1;class vc{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}vc._UniqueIdCounter=1;class qt{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}qt.FALLOFF_DEFAULT=0;qt.FALLOFF_PHYSICAL=1;qt.FALLOFF_GLTF=2;qt.FALLOFF_STANDARD=3;qt.LIGHTMAP_DEFAULT=0;qt.LIGHTMAP_SPECULAR=1;qt.LIGHTMAP_SHADOWSONLY=2;qt.INTENSITYMODE_AUTOMATIC=0;qt.INTENSITYMODE_LUMINOUSPOWER=1;qt.INTENSITYMODE_LUMINOUSINTENSITY=2;qt.INTENSITYMODE_ILLUMINANCE=3;qt.INTENSITYMODE_LUMINANCE=4;qt.LIGHTTYPEID_POINTLIGHT=0;qt.LIGHTTYPEID_DIRECTIONALLIGHT=1;qt.LIGHTTYPEID_SPOTLIGHT=2;qt.LIGHTTYPEID_HEMISPHERICLIGHT=3;class dO{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var rg;(function(n){n[n.BackwardCompatible=0]="BackwardCompatible",n[n.Intermediate=1]="Intermediate",n[n.Aggressive=2]="Aggressive"})(rg||(rg={}));class ht{static DefaultMaterialFactory(e){throw rt("StandardMaterial")}static CollisionCoordinatorFactory(){throw rt("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Fi.DragMovementThreshold}static set DragMovementThreshold(e){Fi.DragMovementThreshold=e}static get LongPressDelay(){return Fi.LongPressDelay}static set LongPressDelay(e){Fi.LongPressDelay=e}static get DoubleClickDelay(){return Fi.DoubleClickDelay}static set DoubleClickDelay(e){Fi.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Fi.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Fi.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){const r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition,s=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return B.Vector4[0].set(r.x,r.y,r.z,s?-1:1),e&&(i?e.setFloat3(t,B.Vector4[0].x,B.Vector4[0].y,B.Vector4[0].z):e.setVector4(t,B.Vector4[0])),B.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=ZS(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=ht.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph){this._frameGraph=e,e||(this.customRenderFunction=this._currentCustomRenderFunction);return}this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=ht.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){this._inputManager=new Fi(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new Be(.2,.2,.3,1),this.onClearColorChangedObservable=new Q,this.ambientColor=new fe(0,0,0),this.environmentIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new Q,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new Q,this._onDisposeObserver=null,this.onBeforeRenderObservable=new Q,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new Q,this.onAfterRenderCameraObservable=new Q,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new Q,this.onAfterAnimationsObservable=new Q,this.onBeforeDrawPhaseObservable=new Q,this.onAfterDrawPhaseObservable=new Q,this.onReadyObservable=new Q,this.onBeforeCameraRenderObservable=new Q,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new Q,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new Q,this.onAfterActiveMeshesEvaluationObservable=new Q,this.onBeforeParticlesRenderingObservable=new Q,this.onAfterParticlesRenderingObservable=new Q,this.onDataLoadedObservable=new Q,this.onNewCameraAddedObservable=new Q,this.onCameraRemovedObservable=new Q,this.onNewLightAddedObservable=new Q,this.onLightRemovedObservable=new Q,this.onNewGeometryAddedObservable=new Q,this.onGeometryRemovedObservable=new Q,this.onNewTransformNodeAddedObservable=new Q,this.onTransformNodeRemovedObservable=new Q,this.onNewMeshAddedObservable=new Q,this.onMeshRemovedObservable=new Q,this.onNewSkeletonAddedObservable=new Q,this.onSkeletonRemovedObservable=new Q,this.onNewMaterialAddedObservable=new Q,this.onNewMultiMaterialAddedObservable=new Q,this.onMaterialRemovedObservable=new Q,this.onMultiMaterialRemovedObservable=new Q,this.onNewTextureAddedObservable=new Q,this.onTextureRemovedObservable=new Q,this.onBeforeRenderTargetsRenderObservable=new Q,this.onAfterRenderTargetsRenderObservable=new Q,this.onBeforeStepObservable=new Q,this.onAfterStepObservable=new Q,this.onActiveCameraChanged=new Q,this.onActiveCamerasChanged=new Q,this.onBeforeRenderingGroupObservable=new Q,this.onAfterRenderingGroupObservable=new Q,this.onMeshImportedObservable=new Q,this.onAnimationFileImportedObservable=new Q,this._registeredForLateAnimationBindings=new na(256),this._pointerPickingConfiguration=new dO,this.onPrePointerObservable=new Q,this.onPointerObservable=new Q,this.onPreKeyboardObservable=new Q,this.onKeyboardObservable=new Q,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=ht.FOGMODE_NONE,this.fogColor=new fe(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new m(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new na(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new ps,this._activeIndices=new ps,this._activeParticles=new ps,this._activeBones=new ps,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new pr(256),this._processedMaterials=new pr(256),this._renderTargets=new na(256),this._materialsRenderTargets=new na(256),this._activeParticleSystems=new pr(256),this._activeSkeletons=new na(32),this._softwareSkinnedMeshes=new na(32),this._activeAnimatables=new Array,this._transformMatrix=O.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=Oi.Create(),this._beforeClearStage=Oi.Create(),this._beforeRenderTargetClearStage=Oi.Create(),this._gatherRenderTargetsStage=Oi.Create(),this._gatherActiveCameraRenderTargetsStage=Oi.Create(),this._isReadyForMeshStage=Oi.Create(),this._beforeEvaluateActiveMeshStage=Oi.Create(),this._evaluateSubMeshStage=Oi.Create(),this._preActiveMeshStage=Oi.Create(),this._cameraDrawRenderTargetStage=Oi.Create(),this._beforeCameraDrawStage=Oi.Create(),this._beforeRenderTargetDrawStage=Oi.Create(),this._beforeRenderingGroupDrawStage=Oi.Create(),this._beforeRenderingMeshStage=Oi.Create(),this._afterRenderingMeshStage=Oi.Create(),this._afterRenderingGroupDrawStage=Oi.Create(),this._afterCameraDrawStage=Oi.Create(),this._afterCameraPostProcessStage=Oi.Create(),this._afterRenderTargetDrawStage=Oi.Create(),this._afterRenderTargetPostProcessStage=Oi.Create(),this._afterRenderStage=Oi.Create(),this._pointerMoveStage=Oi.Create(),this._pointerDownStage=Oi.Create(),this._pointerUpStage=Oi.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||$e.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):($e._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new fr(this),Pu&&(this.postProcessManager=new Pu(this)),Yi()&&this.attachControl(),this._createUbo(),It&&(this._imageProcessingConfiguration=new It),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var a,o;if(this._isDisposed)return!1;let t;const i=this.getEngine(),r=i.currentRenderPassId;i.currentRenderPassId=((a=this.activeCamera)==null?void 0:a.renderPassId)??r;let s=!0;for(this._pendingData.length>0&&(s=!1),(o=this.prePassRenderer)==null||o.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&s&&(s=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const l=this.meshes[t];if(!l.subMeshes||l.subMeshes.length===0)continue;if(!l.isReady(!0)){s=!1;continue}const c=l.hasThinInstances||l.getClassName()==="InstancedMesh"||l.getClassName()==="InstancedLinesMesh"||i.getCaps().instancedArrays&&l.instances.length>0;for(const h of this._isReadyForMeshStage)h.action(l,c)||(s=!1);if(!e)continue;const u=l.material||this.defaultMaterial;if(u)if(u._storeEffectOnSubMeshes)for(const h of l.subMeshes){const f=h.getMaterial();f&&f.hasRenderTargetTextures&&f.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(f)===-1&&(this._processedMaterials.push(f),this._materialsRenderTargets.concatWithNoDuplicate(f.getRenderTargetTextures()))}else u.hasRenderTargetTextures&&u.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(u)===-1&&(this._processedMaterials.push(u),this._materialsRenderTargets.concatWithNoDuplicate(u.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(s=!1);for(t=0;t<this.geometries.length;t++)this.geometries[t].delayLoadState===2&&(s=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const l of this.activeCameras)l.isReady(!0)||(s=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(s=!1));for(const l of this.particleSystems)l.isReady()||(s=!1);if(this.layers)for(const l of this.layers)l.isReady()||(s=!1);return i.areAllEffectsReady()||(s=!1),i.currentRenderPassId=r,s}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Tr.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){!i&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Ts.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Ts.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new ke(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return vc.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(r=>{this.removeMesh(r)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(qt.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){const r=this.materials[i];if(t(r))return r}if(e)for(let i=0;i<this.multiMaterials.length;i++){const r=this.multiMaterials[i];if(t(r))return r}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].id===e)return i.bones[r]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].name===e)return i.bones[r]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const r=this.getLightById(e);if(r)return r;const s=this.getCameraById(e);if(s)return s;const a=this.getBoneById(e);return a||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const r=this.getLightByName(e);if(r)return r;const s=this.getCameraByName(e);if(s)return s;const a=this.getBoneByName(e);return a||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){const s=i.getTarget(r);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=J.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new cd),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new cd),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(const a of this._evaluateSubMeshStage)a.action(t,e);const s=e.getMaterial();s!=null&&(s.hasRenderTargetTextures&&s.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(s)===-1&&(this._processedMaterials.push(s),this._materialsRenderTargets.concatWithNoDuplicate(s.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,s))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,s=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,r)for(let a=0;a<this._activeMeshes.length;a++)this._activeMeshes.data[a]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var i;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((i=this.activeCamera)==null||i._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const r=this._activeMeshes.length;for(let s=0;s<r;s++)this._activeMeshes.data[s].computeWorldMatrix()}if(this._activeParticleSystems){const r=this._activeParticleSystems.length;for(let s=0;s<r;s++)this._activeParticleSystems.data[s].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const r of this._beforeEvaluateActiveMeshStage)r.action();const e=this.getActiveMeshCandidates(),t=e.length;for(let r=0;r<t;r++){const s=e.data[r];if(s._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,s.isBlocked||(this._totalVertices.addCount(s.getTotalVertices(),!1),!s.isReady()||!s.isEnabled()||s.scaling.hasAZeroComponent))continue;s.computeWorldMatrix(),s.actionManager&&s.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(s);let a=this.customLODSelector?this.customLODSelector(s,this.activeCamera):s.getLOD(this.activeCamera);if(s._internalAbstractMeshDataInfo._currentLOD=a,s._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,a!=null&&(a!==s&&a.billboardMode!==0&&a.computeWorldMatrix(),s._preActivate(),s.isVisible&&s.visibility>0&&s.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||s.alwaysSelectAsActiveMesh||s.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(s),this.activeCamera._activeMeshes.push(s),a!==s&&a._activate(this._renderId,!1);for(const o of this._preActiveMeshStage)o.action(s);s._activate(this._renderId,!1)&&(s.isAnInstance?s._internalAbstractMeshDataInfo._actAsRegularMesh&&(a=s):a._internalAbstractMeshDataInfo._onlyForInstances=!1,a._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(s,a)),s._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let r=0;r<this.particleSystems.length;r++){const s=this.particleSystems[r];if(!s.isStarted()||!s.emitter)continue;const a=s.emitter;(!a.position||a.isEnabled())&&(this._activeParticleSystems.push(s),s.animate(),this._renderingManager.dispatchParticles(s))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){!this._skeletonsEnabled||!e.skeleton||(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const r=this.getActiveSubMeshCandidates(t),s=r.length;i=i||s===1;for(let a=0;a<s;a++){const o=r.data[a];this._evaluateSubMesh(o,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],r=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),r.getViewMatrix(),r.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):!t.skipInitialClear&&!e.isRightCamera&&(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var a;if(e&&e._skipRendering)return;const r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let o=!0;e._renderingMultiview&&e.outputRenderTarget&&(o=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=o)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let o=0;o<this._softwareSkinnedMeshes.length;o++){const l=this._softwareSkinnedMeshes.data[o];l.applySkeleton(l.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const o of this._gatherActiveCameraRenderTargetsStage)o.action(this._renderTargets);let s=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){J.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let o=0;o<this._renderTargets.length;o++){const l=this._renderTargets.data[o];if(l._shouldRender()){this._renderId++;const c=l.activeCamera&&l.activeCamera!==this.activeCamera;l.render(c,this.dumpNextRenderTargets),s=!0}}J.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const o of this._cameraDrawRenderTargetStage)s=o.action(this.activeCamera)||s;this._intermediateRendering=!1}this._engine.currentRenderPassId=((a=e.outputRenderTarget)==null?void 0:a.renderPassId)??e.renderPassId??0,s&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const o of this._beforeCameraDrawStage)o.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),r.snapshotRendering&&r.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const o of this._afterCameraDrawStage)o.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const o=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,o)}for(const o of this._afterCameraPostProcessStage)o.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const r=t.actionManager.actions[i];if(r.trigger===12||r.trigger===13){const s=r.getTriggerParameter(),a=s.mesh?s.mesh:s,o=a.intersectsMesh(t,s.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(a);o&&l===-1?r.trigger===12?(r._executeCurrent(Ei.CreateNew(t,void 0,a)),t._intersectionsInProgress.push(a)):r.trigger===13&&t._intersectionsInProgress.push(a):!o&&l>-1&&(r.trigger===13&&r._executeCurrent(Ei.CreateNew(t,void 0,a)),(!t.actionManager.hasSpecificTrigger(13,c=>{const u=c.mesh?c.mesh:c;return a===u})||r.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(ht.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ht.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let r=0;const s=this._engine.getLockstepMaxSteps();let a=Math.floor(e/t);for(a=Math.min(a,s);e>0&&r<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(ht.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ht.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),(t=e==null?void 0:e.rigCameras)!=null&&t.length)for(let i=0;i<e.rigCameras.length;++i){const r=e.rigCameras[i].outputRenderTarget;r&&(r._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1){var s;if(this.activeCamera=null,this._activeParticleSystems.reset(),this._activeSkeletons.reset(),e){for(const a of this.cameras)if(a.update(),a.cameraRigMode!==0)for(let o=0;o<a._rigCameras.length;o++)a._rigCameras[o].update()}for(const a of this._beforeClearStage)a.action();const i=this.getActiveMeshCandidates(),r=i.length;for(let a=0;a<r;a++){const o=i.data[a];o.isBlocked||(this._totalVertices.addCount(o.getTotalVertices(),!1),!(!o.isReady()||!o.isEnabled()||o.scaling.hasAZeroComponent)&&(o.computeWorldMatrix(),o.actionManager&&o.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(o)))}if(this.particlesEnabled)for(let a=0;a<this.particleSystems.length;a++){const o=this.particleSystems[a];if(!o.isStarted()||!o.emitter)continue;const l=o.emitter;(!l.position||l.isEnabled())&&(this._activeParticleSystems.push(o),o.animate())}(s=this.frameGraph)==null||s.execute()}render(e=!0,t=!1){var i,r;if(!this.isDisposed){this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),(i=this.activeCameras)!=null&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const s of this._beforeCameraUpdateStage)s.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let s=0;s<this.activeCameras.length;s++){const a=this.activeCameras[s];if(a.update(),a.cameraRigMode!==0)for(let o=0;o<a._rigCameras.length;o++)a._rigCameras[o].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let s=0;s<this.activeCamera._rigCameras.length;s++)this.activeCamera._rigCameras[s].update()}if(this.onBeforeRenderObservable.notifyObservers(this),this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{const s=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const a=(r=this.activeCameras)!=null&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){J.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let o=0;o<this.customRenderTargets.length;o++){const l=this.customRenderTargets[o];if(l._shouldRender()){if(this._renderId++,this.activeCamera=l.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");s.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),l.render(a!==this.activeCamera,this.dumpNextRenderTargets)}}J.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(a==null?void 0:a.renderPassId)??0,this.activeCamera=a,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const o of this._beforeClearStage)o.action();this._clearFrameBuffer(this.activeCamera);for(const o of this._gatherRenderTargetsStage)o.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let o=0;o<this.activeCameras.length;o++)this._processSubCameras(this.activeCameras[o],o>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}this._checkIntersections();for(const s of this._afterRenderStage)s.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let s=0;s<this._toBeDisposed.length;s++){const a=this._toBeDisposed[s];a&&a.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations&&(this._activeAnimatables.forEach(s=>{s.onAnimationEndObservable.clear(),s.onAnimationEnd=null}),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const s of e)s.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(s){w.Error("An error occurred while calling onDisposeObservable!",s)}if(this.detachControl(),this._engine.getInputElement())for(let s=0;s<this.cameras.length;s++)this.cameras[s].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,s=>s.dispose(!0)),this._disposeList(this.transformNodes,s=>s.dispose(!0));const i=this.cameras;this._disposeList(i),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let r=this._engine.scenes.indexOf(this);r>-1&&this._engine.scenes.splice(r,1),$e._LastCreatedScene===this&&(this._engine.scenes.length>0?$e._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:$e._LastCreatedScene=null),r=this._engine._virtualScenes.indexOf(this),r>-1&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(r=>r.dispose());for(const r of i)t(r);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(r=>{if(r.computeWorldMatrix(!0),!r.subMeshes||r.subMeshes.length===0||r.infiniteDistance)return;const s=r.getBoundingInfo(),a=s.boundingBox.minimumWorld,o=s.boundingBox.maximumWorld;m.CheckExtends(a,t,i),m.CheckExtends(o,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,r,s=!1){throw rt("Ray")}createPickingRayToRef(e,t,i,r,s,a=!1,o=!1){throw rt("Ray")}createPickingRayInCameraSpace(e,t,i){throw rt("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw rt("Ray")}pick(e,t,i,r,s,a){const o=rt("Ray",!0);return o&&w.Warn(o),new es}pickWithBoundingInfo(e,t,i,r,s){const a=rt("Ray",!0);return a&&w.Warn(a),new es}pickWithRay(e,t,i,r){throw rt("Ray")}multiPick(e,t,i,r,s){throw rt("Ray")}multiPickWithRay(e,t,i){throw rt("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const r=[];for(const s in e){const a=e[s];Pt&&Pt.MatchesQuery(a,t)&&(!i||i(a))&&r.push(a)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,r,s,a,o){const l=Ea(e,t,i,r?this.offlineProvider:void 0,s,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_loadFileAsync(e,t,i,r,s){return new Promise((a,o)=>{this._loadFile(e,l=>{a(l)},t,i,r,(l,c)=>{o(c)},s)})}_requestFile(e,t,i,r,s,a,o){const l=lp(e,t,i,r?this.offlineProvider:void 0,s,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_requestFileAsync(e,t,i,r,s){return new Promise((a,o)=>{this._requestFile(e,l=>{a(l)},t,i,r,l=>{o(l)},s)})}_readFile(e,t,i,r,s){const a=sc(e,t,i,r,s);return this._activeRequests.push(a),a.onCompleteObservable.add(o=>{this._activeRequests.splice(this._activeRequests.indexOf(o),1)}),a}_readFileAsync(e,t,i){return new Promise((r,s)=>{this._readFile(e,a=>{r(a)},t,i,a=>{s(a)})})}getPerfCollector(){throw rt("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}ht.FOGMODE_NONE=0;ht.FOGMODE_EXP=1;ht.FOGMODE_EXP2=2;ht.FOGMODE_LINEAR=3;ht.MinDeltaTime=1;ht.MaxDeltaTime=1e3;$("BABYLON.Scene",ht);class sg extends mr{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}Se.prototype.createMultiviewRenderTargetTexture=function(n,e,t,i){const r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const s=this._createHardwareRenderTargetWrapper(!1,!1,{width:n,height:e});s._framebuffer=r.createFramebuffer();const a=new Yt(this,0,!0);return a.width=n,a.height=e,a.isMultiview=!0,t||(t=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,t),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,n,e,2)),s._colorTextureArray=t,i||(i=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,i),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,n,e,2)),s._depthStencilTextureArray=i,a.isReady=!0,s.setTextures(a),s._depthStencilTexture=a,s};Se.prototype.bindMultiviewFramebuffer=function(n){const e=n,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};Se.prototype.bindSpaceWarpFramebuffer=function(n){const e=n,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw new Error("Invalid Space Warp framebuffer")};He.prototype._useMultiviewToSingleView=!1;He.prototype._multiviewTexture=null;He.prototype._resizeOrCreateMultiviewTexture=function(n,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=n||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new sg(this.getScene(),{width:n,height:e})):this._multiviewTexture=new sg(this.getScene(),{width:n,height:e})};function OT(n,e){const t=new ke(n,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}const pO=ht.prototype.createSceneUniformBuffer;ht.prototype._transformMatrixR=O.Zero();ht.prototype._multiviewSceneUbo=null;ht.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=OT(this.getEngine(),"scene_multiview")};ht.prototype.createSceneUniformBuffer=function(n){return this._multiviewSceneUbo?OT(this.getEngine(),n):pO.bind(this)(n)};ht.prototype._updateMultiviewUbo=function(n,e){n&&e&&n.multiplyToRef(e,this._transformMatrixR),n&&e&&(n.multiplyToRef(e,B.Matrix[0]),Ts.GetRightPlaneToRef(B.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};ht.prototype._renderMultiviewToSingleView=function(n){n._resizeOrCreateMultiviewTexture(n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.width>0?n._rigPostProcess.width:this.getEngine().getRenderWidth(!0),n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.height>0?n._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),n.outputRenderTarget=n._multiviewTexture,this._renderForCamera(n),n.outputRenderTarget=null;for(let e=0;e<n._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=n._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};st.prototype.createDynamicTexture=function(n,e,t,i){const r=new Yt(this,4);return r.baseWidth=n,r.baseHeight=e,t&&(n=this.needPOTTextures?Wn(n,this._caps.maxTextureSize):n,e=this.needPOTTextures?Wn(e,this._caps.maxTextureSize):e),r.width=n,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),r};st.prototype.updateDynamicTexture=function(n,e,t,i=!1,r,s=!1,a=!1){if(!n)return;const o=this._gl,l=o.TEXTURE_2D,c=this._bindTextureDirectly(l,n,!0,s);this._unpackFlipY(t===void 0?n.invertY:t),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const u=this._getWebGLTextureType(n.type),h=this._getInternalFormat(r||n.format),f=this._getRGBABufferInternalSizedFormat(n.type,h);o.texImage2D(l,0,f,h,u,e),n.generateMipMaps&&o.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(n.format=r),n._dynamicTextureSource=e,n._premulAlpha=i,n.invertY=t||!1,n.isReady=!0};st.prototype.updateVideoTexture=function(n,e,t){if(!n||n._isDisabled)return;const i=this._getInternalFormat(n.format),r=this._getRGBABufferInternalSizedFormat(0,n.format),s=this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e);else{if(!n._workingCanvas){n._workingCanvas=this.createCanvas(n.width,n.height);const a=n._workingCanvas.getContext("2d");if(!a)throw new Error("Unable to get 2d context");n._workingContext=a,n._workingCanvas.width=n.width,n._workingCanvas.height=n.height}n._workingContext.clearRect(0,0,n.width,n.height),n._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,n.width,n.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,n._workingCanvas)}n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),s||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),n.isReady=!0}catch{n._isDisabled=!0}};st.prototype.restoreSingleAttachment=function(){const n=this._gl;this.bindAttachments([n.BACK])};st.prototype.restoreSingleAttachmentForRenderTarget=function(){const n=this._gl;this.bindAttachments([n.COLOR_ATTACHMENT0])};st.prototype.buildTextureLayout=function(n){const e=this._gl,t=[];for(let i=0;i<n.length;i++)n[i]?t.push(e["COLOR_ATTACHMENT"+i]):t.push(e.NONE);return t};st.prototype.bindAttachments=function(n){this._gl.drawBuffers(n)};st.prototype.unBindMultiColorAttachmentFramebuffer=function(n,e=!1,t){this._currentRenderTarget=null;const i=this._gl,r=n._attachments,s=r.length;if(n._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,n._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,n._framebuffer);for(let a=0;a<s;a++){const o=n.textures[a];for(let l=0;l<s;l++)r[l]=i.NONE;r[a]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],i.readBuffer(r[a]),i.drawBuffers(r),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let a=0;a<s;a++)r[a]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"];i.drawBuffers(r)}for(let a=0;a<s;a++){const o=n.textures[a];o!=null&&o.generateMipMaps&&!e&&!(o!=null&&o.isCube)&&!(o!=null&&o.is3D)&&(this._bindTextureDirectly(i.TEXTURE_2D,o,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(n._MSAAFramebuffer&&this._bindUnboundFramebuffer(n._framebuffer),t()),this._bindUnboundFramebuffer(null)};st.prototype.createMultipleRenderTarget=function(n,e,t=!0){let i=!1,r=!0,s=!1,a=!1,o=15,l=1,c=1;const u=0,h=3,f=!1,d=5,p=3553;let _=[],g=[],E=[],v=[],x=[],A=[],T=[],C=[],y=[];const P=this._createHardwareRenderTargetWrapper(!0,!1,n);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,s=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,a=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount??1,c=e.samples??c,_=e.types||_,g=e.samplingModes||g,E=e.useSRGBBuffers||E,v=e.formats||v,x=e.targetTypes||x,A=e.faceIndex||A,T=e.layerIndex||T,C=e.layerCounts||C,y=e.labels||y,this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(o=e.depthTextureFormat));const D=this._gl,F=D.createFramebuffer();this._bindUnboundFramebuffer(F);const W=n.width??n,H=n.height??n,ue=[],ae=[],le=this.webGLVersion>1&&(o===13||o===17||o===18);P.label=(e==null?void 0:e.label)??"MultiRenderTargetWrapper",P._framebuffer=F,P._generateDepthBuffer=a||r,P._generateStencilBuffer=a?le:s,P._depthStencilBuffer=this._setupFramebufferDepthAttachments(P._generateStencilBuffer,P._generateDepthBuffer,W,H,1,o),P._attachments=ae;for(let oe=0;oe<l;oe++){let ge=g[oe]||h,Ee=_[oe]||u,ne=E[oe]||f;const j=v[oe]||d,L=x[oe]||p,Y=C[oe]??1;(Ee===1&&!this._caps.textureFloatLinearFiltering||Ee===2&&!this._caps.textureHalfFloatLinearFiltering)&&(ge=1);const te=this._getSamplingParameters(ge,i);Ee===1&&!this._caps.textureFloat&&(Ee=0,w.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),ne=ne&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const De=this.webGLVersion>1,Ve=D[De?"COLOR_ATTACHMENT"+oe:"COLOR_ATTACHMENT"+oe+"_WEBGL"];if(ae.push(Ve),L===-1)continue;const ve=new Yt(this,6);ue[oe]=ve,D.activeTexture(D["TEXTURE"+oe]),D.bindTexture(L,ve._hardwareTexture.underlyingResource),D.texParameteri(L,D.TEXTURE_MAG_FILTER,te.mag),D.texParameteri(L,D.TEXTURE_MIN_FILTER,te.min),D.texParameteri(L,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(L,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE);const Me=this._getRGBABufferInternalSizedFormat(Ee,j,ne),Re=this._getInternalFormat(j),Pe=this._getWebGLTextureType(Ee);if(De&&(L===35866||L===32879))L===35866?ve.is2DArray=!0:ve.is3D=!0,ve.baseDepth=ve.depth=Y,D.texImage3D(L,0,Me,W,H,Y,0,Re,Pe,null);else if(L===34067){for(let ft=0;ft<6;ft++)D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+ft,0,Me,W,H,0,Re,Pe,null);ve.isCube=!0}else D.texImage2D(D.TEXTURE_2D,0,Me,W,H,0,Re,Pe,null);i&&D.generateMipmap(L),this._bindTextureDirectly(L,null),ve.baseWidth=W,ve.baseHeight=H,ve.width=W,ve.height=H,ve.isReady=!0,ve.samples=1,ve.generateMipMaps=i,ve.samplingMode=ge,ve.type=Ee,ve._useSRGBBuffer=ne,ve.format=j,ve.label=y[oe]??P.label+"-Texture"+oe,this._internalTexturesCache.push(ve)}if(a&&this._caps.depthTextureExtension){const oe=new Yt(this,14);let ge=5,Ee=D.DEPTH_COMPONENT16,ne=D.DEPTH_COMPONENT,j=D.UNSIGNED_SHORT,L=D.DEPTH_ATTACHMENT;this.webGLVersion<2?Ee=D.DEPTH_COMPONENT:o===14?(ge=1,j=D.FLOAT,Ee=D.DEPTH_COMPONENT32F):o===18?(ge=0,j=D.FLOAT_32_UNSIGNED_INT_24_8_REV,Ee=D.DEPTH32F_STENCIL8,ne=D.DEPTH_STENCIL,L=D.DEPTH_STENCIL_ATTACHMENT):o===16?(ge=0,j=D.UNSIGNED_INT,Ee=D.DEPTH_COMPONENT24,L=D.DEPTH_ATTACHMENT):(o===13||o===17)&&(ge=12,j=D.UNSIGNED_INT_24_8,Ee=D.DEPTH24_STENCIL8,ne=D.DEPTH_STENCIL,L=D.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(D.TEXTURE_2D,oe,!0),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,D.NEAREST),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,D.NEAREST),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),D.texImage2D(D.TEXTURE_2D,0,Ee,W,H,0,ne,j,null),D.framebufferTexture2D(D.FRAMEBUFFER,L,D.TEXTURE_2D,oe._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(D.TEXTURE_2D,null),P._depthStencilTexture=oe,P._depthStencilTextureWithStencil=le,oe.baseWidth=W,oe.baseHeight=H,oe.width=W,oe.height=H,oe.isReady=!0,oe.samples=1,oe.generateMipMaps=i,oe.samplingMode=1,oe.format=o,oe.type=ge,oe.label=P.label+"-DepthStencil",ue[l]=oe,this._internalTexturesCache.push(oe)}return P.setTextures(ue),t&&D.drawBuffers(ae),this._bindUnboundFramebuffer(null),P.setLayerAndFaceIndices(T,A),this.resetTextureCache(),this.updateMultipleRenderTargetTextureSampleCount(P,c,t),P};st.prototype.updateMultipleRenderTargetTextureSampleCount=function(n,e,t=!0){if(this.webGLVersion<2||!n)return 1;if(n.samples===e)return e;const i=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),n._depthStencilBuffer&&(i.deleteRenderbuffer(n._depthStencilBuffer),n._depthStencilBuffer=null),n._MSAAFramebuffer&&(i.deleteFramebuffer(n._MSAAFramebuffer),n._MSAAFramebuffer=null);const r=n._attachments.length;for(let a=0;a<r;a++){const l=n.textures[a]._hardwareTexture;l==null||l.releaseMSAARenderBuffers()}if(e>1&&typeof i.renderbufferStorageMultisample=="function"){const a=i.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");n._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);const o=[];for(let l=0;l<r;l++){const c=n.textures[l],u=c._hardwareTexture,h=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],f=this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBABufferInternalSizedFormat(c.type,c.format,c._useSRGBBuffer),h);if(!f)throw new Error("Unable to create multi sampled framebuffer");u.addMSAARenderBuffer(f),c.samples=e,o.push(h)}t&&i.drawBuffers(o)}else this._bindUnboundFramebuffer(n._framebuffer);const s=n._depthStencilTexture?n._depthStencilTexture.format:void 0;return n._depthStencilBuffer=this._setupFramebufferDepthAttachments(n._generateStencilBuffer,n._generateDepthBuffer,n.width,n.height,e,s),this._bindUnboundFramebuffer(null),n._samples=e,e};var ng;(function(n){n[n.Texture=0]="Texture",n[n.StorageTexture=1]="StorageTexture",n[n.UniformBuffer=2]="UniformBuffer",n[n.StorageBuffer=3]="StorageBuffer",n[n.TextureWithoutSampler=4]="TextureWithoutSampler",n[n.Sampler=5]="Sampler",n[n.ExternalTexture=6]="ExternalTexture",n[n.DataBuffer=7]="DataBuffer"})(ng||(ng={}));st.prototype.createComputeEffect=function(n,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")};st.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")};st.prototype.createComputeContext=function(){};st.prototype.computeDispatch=function(n,e,t,i,r,s,a){throw new Error("computeDispatch: This engine does not support compute shaders!")};st.prototype.computeDispatchIndirect=function(n,e,t,i,r,s){throw new Error("computeDispatchIndirect: This engine does not support compute shaders!")};st.prototype.areAllComputeEffectsReady=function(){return!0};st.prototype.releaseComputeEffects=function(){};st.prototype._prepareComputePipelineContext=function(n,e,t,i,r){};st.prototype._rebuildComputeEffects=function(){};q.prototype._executeWhenComputeStateIsCompiled=function(n,e){e(null)};st.prototype._releaseComputeEffect=function(n){};st.prototype._deleteComputePipelineContext=function(n){};function _O(n){const e=s=>{const a="\\b"+s+"\\b";return n&&(n===s||n.match(new RegExp(a,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(e))return n;const t=n.lastIndexOf("."),i=n.lastIndexOf("?"),r=i>-1?n.substring(i,n.length):"";return(t>-1?n.substring(0,t):n)+this._textureFormatInUse+r}Object.defineProperty(Se.prototype,"texturesSupported",{get:function(){const n=[];return this._caps.astc&&n.push("-astc.ktx"),this._caps.s3tc&&n.push("-dxt.ktx"),this._caps.pvrtc&&n.push("-pvrtc.ktx"),this._caps.etc2&&n.push("-etc2.ktx"),this._caps.etc1&&n.push("-etc1.ktx"),n},enumerable:!0,configurable:!0});Object.defineProperty(Se.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0});Se.prototype.setCompressedTextureExclusions=function(n){this._excludedCompressedTextures=n};Se.prototype.setTextureFormatToUse=function(n){const e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let r=0,s=n.length;r<s;r++)if(e[t]===n[r].toLowerCase())return this._transformTextureUrl=_O.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class io{constructor(){const e=new ArrayBuffer(io.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=io.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}io.DEFAULT_BUFFER_SIZE=65536;class ag{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),r=i.getCaps(),s=t.isReady;let a=!1;r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?(a=!0,t.type=2):r.textureFloatRender&&r.textureFloatLinearFiltering&&(a=!0,t.type=1),a&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=async()=>{const l=i.isWebGPU,c=l?1:0;t.isReady=!1,l?await Promise.all([re(()=>import("./rgbdDecode.fragment-DWuG9R4n.js"),[]),re(()=>import("./rgbdEncode.fragment-Ckq7cphA.js"),[])]):await Promise.all([re(()=>import("./rgbdDecode.fragment-mmX8lHRD.js"),[]),re(()=>import("./rgbdEncode.fragment-Ck3gRTAk.js"),[])]);const u=new Jt("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1,void 0,c);u.externalTextureSamplerBinding=!0;const h=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});u.onEffectCreatedObservable.addOnce(f=>{f.executeWhenCompiled(()=>{u.onApply=d=>{d._bindTexture("textureSampler",t),d.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([u],h,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),u&&u.dispose(),h._swapAndDie(t),t.isReady=!0})})};a&&(s?o():e.onLoadObservable.addOnce(o))}static EncodeTextureToRGBD(e,t,i=0){return mT("rgbdEncode",e,t,i,1,5)}}jt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(jt.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=ol.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(n=>{this._texture._sphericalPolynomial=n,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(n){this._texture&&(this._texture._sphericalPolynomial=n)},enumerable:!0,configurable:!0});let ka,Ga=null;async function mO(){return Ga||(Ga=new Promise((n,e)=>{let t,i=null;const r={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};re(async()=>{const{ThinEngine:s}=await Promise.resolve().then(()=>ZM);return{ThinEngine:s}},void 0).then(({ThinEngine:s})=>{try{t=new OffscreenCanvas(100,100),i=new s(t,!1,r)}catch{t=document.createElement("canvas"),i=new s(t,!1,r)}$e.Instances.pop(),$e.OnEnginesDisposedObservable.add(o=>{i&&o!==i&&!i.isDisposed&&$e.Instances.length===0&&mp()}),i.getCaps().parallelShaderCompile=void 0;const a=new _T(i);re(async()=>{const{passPixelShader:o}=await import("./pass.fragment-15ZcIKRQ.js");return{passPixelShader:o}},[]).then(({passPixelShader:o})=>{if(!i){e("Engine is not defined");return}const l=new Or({engine:i,name:o.name,fragmentShader:o.shader,samplerNames:["textureSampler"]});ka={canvas:t,engine:i,renderer:a,wrapper:l},n(ka)})}).catch(e)})),await Ga}async function pp(n,e,t,i,r="image/png",s,a){const o=await t.readPixels(0,0,n,e),l=new Uint8Array(o.buffer);Sc(n,e,l,i,r,s,!0,void 0,a)}function _p(n,e,t,i="image/png",r,s=!1,a=!1,o){return new Promise(l=>{Sc(n,e,t,c=>l(c),i,r,s,a,o)})}function Sc(n,e,t,i,r="image/png",s,a=!1,o=!1,l){mO().then(c=>{if(c.engine.setSize(n,e,!0),t instanceof Float32Array){const h=new Uint8Array(t.length);let f=t.length;for(;f--;){const d=t[f];h[f]=Math.round(vt(d)*255)}t=h}const u=c.engine.createRawTexture(t,n,e,5,!1,!a,1);c.renderer.setViewport(),c.renderer.applyEffectWrapper(c.wrapper),c.wrapper.effect._bindTexture("textureSampler",u),c.renderer.draw(),o?J.ToBlob(c.canvas,h=>{const f=new FileReader;f.onload=d=>{const p=d.target.result;i&&i(p)},f.readAsArrayBuffer(h)},r,l):J.EncodeScreenshotCanvasData(c.canvas,i,r,s,l),u.dispose()})}function mp(){ka?(ka.wrapper.dispose(),ka.renderer.dispose(),ka.engine.dispose()):Ga==null||Ga.then(n=>{n.wrapper.dispose(),n.renderer.dispose(),n.engine.dispose()}),Ga=null,ka=null}const gO={DumpData:Sc,DumpDataAsync:_p,DumpFramebuffer:pp,Dispose:mp},EO=()=>{J.DumpData=Sc,J.DumpDataAsync=_p,J.DumpFramebuffer=pp};EO();const vO=Object.freeze(Object.defineProperty({__proto__:null,Dispose:mp,DumpData:Sc,DumpDataAsync:_p,DumpFramebuffer:pp,DumpTools:gO},Symbol.toStringTag,{value:"Module"})),NT="image/png",og=2,lg=[134,22,135,150,246,214,150,54];function SO(n){const e=new DataView(n.buffer,n.byteOffset,n.byteLength);let t=0;for(let a=0;a<lg.length;a++)if(e.getUint8(t++)!==lg[a])return w.Error("Not a babylon environment map"),null;let i="",r=0;for(;r=e.getUint8(t++);)i+=String.fromCharCode(r);let s=JSON.parse(i);return s=nh(s),s.specular&&(s.specular.specularDataPosition=t,s.specular.lodGenerationScale=s.specular.lodGenerationScale||.8),s}function nh(n){if(n.version>og)throw new Error(`Unsupported babylon environment map version "${n.version}". Latest supported version is "${og}".`);return n.version===2||(n={...n,version:2,imageType:NT}),n}function LT(n,e){e=nh(e);const t=e.specular;let i=Math.log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const r=new Array(i);for(let s=0;s<i;s++){r[s]=new Array(6);for(let a=0;a<6;a++){const o=t.mipmaps[s*6+a];r[s][a]=new Uint8Array(n.buffer,n.byteOffset+t.specularDataPosition+o.position,o.length)}}return r}function D5(n,e,t){t=nh(t);const i=t.specular;if(!i)return Promise.resolve();n._lodGenerationScale=i.lodGenerationScale;const r=LT(e,t);return hd(n,r,t.imageType)}function cg(n,e,t,i,r,s,a,o,l,c,u){return new Promise((h,f)=>{if(t){const d=e.createTexture(null,!0,!0,null,1,null,p=>{f(p)},n);i==null||i.onEffectCreatedObservable.addOnce(p=>{p.executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=_=>{_._bindTexture("textureSampler",d),_.setFloat2("scale",1,e._features.needsInvertingBitmap&&n instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,s,a),e.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(r),h())})})}else{if(e._uploadImageToTexture(u,n,s,a),o){const d=l[a];d&&e._uploadImageToTexture(d._texture,n,s,0)}h()}})}async function hd(n,e,t=NT){if(!J.IsExponentOfTwo(n.width))throw new Error("Texture size must be a power of two");const i=mc(n.width)+1,r=n.getEngine();let s=!1,a=!1,o=null,l=null,c=null;const u=r.getCaps();n.format=5,n.type=0,n.generateMipMaps=!0,n._cachedAnisotropicFilteringLevel=null,r.updateTextureSamplingMode(3,n),u.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(s=!0,n.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(s=!0,n.type=1):s=!1:(s=!1,a=!0,c={});let h=0;if(s)r.isWebGPU?(h=1,await re(()=>import("./rgbdDecode.fragment-DWuG9R4n.js"),[])):await re(()=>import("./rgbdDecode.fragment-mmX8lHRD.js"),[]),o=new Jt("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,n.type,void 0,null,!1,void 0,h),n._isRGBD=!1,n.invertY=!1,l=r.createRenderTargetCubeTexture(n.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:n.type,format:5});else if(n._isRGBD=!0,n.invertY=!0,a){const p=n._lodGenerationScale,_=n._lodGenerationOffset;for(let g=0;g<3;g++){const v=1-g/2,x=_,A=(i-1)*p+_,T=x+(A-x)*v,C=Math.round(Math.min(Math.max(T,0),A)),y=new Yt(r,2);y.isCube=!0,y.invertY=!0,y.generateMipMaps=!1,r.updateTextureSamplingMode(2,y);const P=new jt(null);switch(P._isCube=!0,P._texture=y,c[C]=P,g){case 0:n._lodTextureLow=P;break;case 1:n._lodTextureMid=P;break;case 2:n._lodTextureHigh=P;break}}}const f=[];for(let d=0;d<e.length;d++)for(let p=0;p<6;p++){const _=e[d][p],g=new Blob([_],{type:t}),E=URL.createObjectURL(g);let v;if(r._features.forceBitmapOverHTMLImageElement)v=r.createImageBitmap(g,{premultiplyAlpha:"none"}).then(x=>cg(x,r,s,o,E,p,d,a,c,l,n));else{const x=new Image;x.src=E,v=new Promise((A,T)=>{x.onload=()=>{cg(x,r,s,o,E,p,d,a,c,l,n).then(()=>A()).catch(C=>{T(C)})},x.onerror=C=>{T(C)}})}f.push(v)}if(e.length<i){let d;const p=Math.pow(2,i-1-e.length),_=p*p*4;switch(n.type){case 0:{d=new Uint8Array(_);break}case 2:{d=new Uint16Array(_);break}case 1:{d=new Float32Array(_);break}}for(let g=e.length;g<i;g++)for(let E=0;E<6;E++)r._uploadArrayBufferViewToTexture(n,d,E,g)}return Promise.all(f).then(()=>{l&&(r._releaseTexture(n),l._swapAndDie(n)),o&&o.dispose(),a&&(n._lodTextureHigh&&n._lodTextureHigh._texture&&(n._lodTextureHigh._texture.isReady=!0),n._lodTextureMid&&n._lodTextureMid._texture&&(n._lodTextureMid._texture.isReady=!0),n._lodTextureLow&&n._lodTextureLow._texture&&(n._lodTextureLow._texture.isReady=!0))})}function TO(n,e){e=nh(e);const t=e.irradiance;if(!t)return;const i=new eo;m.FromArrayToRef(t.x,0,i.x),m.FromArrayToRef(t.y,0,i.y),m.FromArrayToRef(t.z,0,i.z),m.FromArrayToRef(t.xx,0,i.xx),m.FromArrayToRef(t.yy,0,i.yy),m.FromArrayToRef(t.zz,0,i.zz),m.FromArrayToRef(t.yz,0,i.yz),m.FromArrayToRef(t.zx,0,i.zx),m.FromArrayToRef(t.xy,0,i.xy),n._sphericalPolynomial=i}function O5(n,e,t,i,r){const s=n.getEngine().createRawCubeTexture(null,n.width,n.format,n.type,n.generateMipMaps,n.invertY,n.samplingMode,n._compression),a=hd(s,e).then(()=>n);return n.onRebuildCallback=o=>({proxy:a,isReady:!0,isAsync:!0}),n._source=13,n._bufferViewArrayArray=e,n._lodGenerationScale=i,n._lodGenerationOffset=r,n._sphericalPolynomial=t,hd(n,e).then(()=>(n.isReady=!0,n))}function $c(n,e,t,i){let r=i,s=0,a="";for(;r<t.length;){const o=t.charAt(r);if(a)o===a?a==='"'||a==="'"?t.charAt(r-1)!=="\\"&&(a=""):a="":a==="*/"&&o==="*"&&r+1<t.length&&(t.charAt(r+1)==="/"&&(a=""),a===""&&r++);else switch(o){case n:s++;break;case e:s--;break;case'"':case"'":case"`":a=o;break;case"/":if(r+1<t.length){const l=t.charAt(r+1);l==="/"?a=`
`:l==="*"&&(a="*/")}break}if(r++,s===0)break}return s===0?r-1:-1}function ug(n,e){for(;e<n.length;){const t=n[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!==" ")break;e++}return e}function If(n){const e=n.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function fd(n){let e=0,t="",i=!1;const r=[];for(;e<n.length;){const s=n.charAt(e);if(t)s===t?t==='"'||t==="'"?(n.charAt(e-1)!=="\\"&&(t=""),r.push(s)):(t="",i=!1):t==="*/"&&s==="*"&&e+1<n.length?(n.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||r.push(s);else{switch(s){case'"':case"'":case"`":t=s;break;case"/":if(e+1<n.length){const a=n.charAt(e+1);a==="/"?(t=`
`,i=!0):a==="*"&&(t="*/",i=!0)}break}i||r.push(s)}e++}return r.join("")}function xO(n,e,t,i){for(;e>=0&&n.charAt(e)!==t&&n.charAt(e)!==i;)e--;return e}function CO(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Mu(n,e,t,i){let r=n.indexOf(e);if(r<0)return n;if(t){for(;r++<n.length&&n.charAt(r)!="{";);if(r<n.length){const s=n.substring(0,r+1),a=n.substring(r+1);n=s+t+a}}if(i){const s=n.lastIndexOf("}");n=n.substring(0,s),n+=i+`
}`}return n}class Ka{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&w.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&w.Log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&w.Warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const r=Ka._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!r){this.debug&&w.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}const[s,a]=[r[3],r[4]],o=$c("(",")",this._sourceCode,i);if(o<0){this.debug&&w.Warn(`Could not extract the parameters the function '${a}' (type=${s}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}const l=this._sourceCode.substring(i+1,o),c=ug(this._sourceCode,o+1);if(c===this._sourceCode.length){this.debug&&w.Warn(`Could not extract the body of the function '${a}' (type=${s}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}const u=$c("{","}",this._sourceCode,c);if(u<0){this.debug&&w.Warn(`Could not extract the body of the function '${a}' (type=${s}). funcBodyStartIndex=${c}`),e=t+this.inlineToken.length;continue}const h=this._sourceCode.substring(c,u+1),f=fd(l).split(","),d=[];for(let g=0;g<f.length;++g){const E=f[g].trim(),v=E.lastIndexOf(" ");v>=0&&d.push(E.substring(v+1))}s!=="void"&&d.push("return"),this._functionDescr.push({name:a,type:s,parameters:d,body:h,callIndex:0}),e=u+1;const p=t>0?this._sourceCode.substring(0,t):"",_=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";this._sourceCode=p+_,e-=u+1-t}this.debug&&w.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(e=20){for(;e-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&w.Log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:i,type:r,parameters:s,body:a}=t;let o=0;for(;o<this._sourceCode.length;){const l=this._sourceCode.indexOf(i,o);if(l<0)break;if(l===0||If(this._sourceCode.charAt(l-1))){o=l+i.length;continue}const c=ug(this._sourceCode,l+i.length);if(c===this._sourceCode.length||this._sourceCode.charAt(c)!=="("){o=l+i.length;continue}const u=$c("(",")",this._sourceCode,c);if(u<0){this.debug&&w.Warn(`Could not extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}`),o=l+i.length;continue}const h=this._sourceCode.substring(c+1,u),d=(x=>{const A=[];let T=0,C=0;for(;T<x.length;){if(x.charAt(T)==="("){const y=$c("(",")",x,T);if(y<0)return null;T=y}else x.charAt(T)===","&&(A.push(x.substring(C,T)),C=T+1);T++}return C<T&&A.push(x.substring(C,T)),A})(fd(h));if(d===null){this.debug&&w.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}, callParams=`+h),o=l+i.length;continue}const p=[];for(let x=0;x<d.length;++x){const A=d[x].trim();p.push(A)}const _=r!=="void"?i+"_"+t.callIndex++:null;if(_&&p.push(_+" ="),p.length!==s.length){this.debug&&w.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${r}). function parameters=${s}, call parameters=${p}`),o=l+i.length;continue}o=u+1;const g=this._replaceNames(a,s,p);let E=l>0?this._sourceCode.substring(0,l):"";const v=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";if(_){const x=xO(this._sourceCode,l-1,`
`,"{");E=this._sourceCode.substring(0,x+1);const A=this._sourceCode.substring(x+1,l);this._sourceCode=E+r+" "+_+`;
`+g+`
`+A+_+v,this.debug&&w.Log(`Replace function call by code. Function '${i}' (type=${r}). injectDeclarationIndex=${x}, call parameters=${p}`)}else this._sourceCode=E+g+v,o+=g.length-(u+1-l),this.debug&&w.Log(`Replace function call by code. Function '${i}' (type=${r}). functionCallIndex=${l}, call parameters=${p}`);e=!0}}return e}_replaceNames(e,t,i){for(let r=0;r<t.length;++r){const s=new RegExp(CO(t[r]),"g"),a=t[r].length,o=i[r];e=e.replace(s,(l,...c)=>{const u=c[0];return If(e.charAt(u-1))||If(e.charAt(u+a))?t[r]:o})}return e}}Ka._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;const AO=/(flat\s)?\s*varying\s*.*/;class IO{constructor(){this.shaderLanguage=0}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");const i=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(i!==null){const r=i[1],s=i[2],a=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[s];if(a!==void 0){const o=a<0?a===-1?"int":"ivec"+-a:a===1?"uint":"uvec"+a,l=`_int_${s}_`;e=e.replace(i[0],`in ${o} ${l}; ${r} ${s};`),this._nativeProcessingContext.injectInVertexMain+=`${s} = ${r}(${l});
`,this._nativeProcessingContext.remappedAttributeNames[s]=l}else e=e.replace(i[0],`in ${r} ${s};`)}return e}varyingCheck(e,t){return AO.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){var a;const r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,s=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(s,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const o=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r||o?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if((a=this._nativeProcessingContext)!=null&&a.injectInVertexMain&&(e=Mu(e,"void main",this._nativeProcessingContext.injectInVertexMain)),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class yO{get isReady(){if(this.compilationError){const e=this.compilationError.message;throw new Error("SHADER ERROR"+(typeof e=="string"?`
`+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,s,a,o,l){const c=this._engine;if(c.supportsUniformBuffers)for(const f in t)e.bindUniformBlock(f,t[f]);this._engine.getUniforms(this,i).forEach((f,d)=>{r[i[d]]=f}),this._uniforms=r;let h;for(h=0;h<s.length;h++)e.getUniform(s[h])==null&&(s.splice(h,1),h--);s.forEach((f,d)=>{a[f]=d}),l.push(...c.getAttributes(this,o))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s)return s=[t,i,r],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==i&&(s[1]=i,a=!0),s[2]!==r&&(s[2]=r,a=!0),a}_cacheFloat4(e,t,i,r,s){let a=this._valueCache[e];if(!a)return a=[t,i,r,s],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==r&&(a[2]=r,o=!0),a[3]!==s&&(a[3]=s,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class bO extends sp{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class hg{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}function yf(n,e){switch(n){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:return _native.Engine.TEXTURE_FORMAT_BC1;case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break}case 5:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break}case 6:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break}case 7:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break}case 12:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_BGRA8}break}}throw new vn(`Unsupported texture format or type: format ${n}, type ${e}.`,ya.UnsupportedTextureError)}function yl(n){switch(n){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${n}.`)}}function bf(n){switch(n){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+n+".")}}function RO(n){switch(n){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${n}.`)}}function PO(n){switch(n){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${n}.`)}}function MO(n){switch(n){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${n}.`)}}function DO(n){switch(n){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${n}.`)}}function OO(n){switch(n){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${n}.`)}}function NO(n){switch(n){case b.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case b.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case b.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case b.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case b.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${n}.`)}}const LO={[b.PositionKind]:!0,[b.NormalKind]:!0,[b.TangentKind]:!0,[b.UVKind]:!0,[b.UV2Kind]:!0,[b.UV3Kind]:!0,[b.UV4Kind]:!0,[b.UV5Kind]:!0,[b.UV6Kind]:!0,[b.ColorKind]:!0,[b.ColorInstanceKind]:!0,[b.MatricesIndicesKind]:!0,[b.MatricesWeightsKind]:!0,[b.MatricesIndicesExtraKind]:!0,[b.MatricesWeightsExtraKind]:!0};function FO(n){switch(n){case b.BYTE:case b.SHORT:case b.INT:case b.FLOAT:return!0;case b.UNSIGNED_BYTE:case b.UNSIGNED_SHORT:case b.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${n}'`)}}function FT(n,e){const t=e.getEngine(),i=e._pipelineContext;if(!(i!=null&&i.vertexBufferKindToType))return;let r=null;for(const s in n){const a=n[s];if(!a||!LO[s])continue;const o=a.normalized?b.FLOAT:a.type,l=i.vertexBufferKindToType[s];(o!==b.FLOAT&&l===void 0||l!==void 0&&l!==o)&&(r||(r=t._getShaderProcessingContext(e.shaderLanguage,!1)),i.vertexBufferKindToType[s]=o,o!==b.FLOAT&&(r.vertexBufferKindToNumberOfComponents[s]=b.DeduceStride(s),FO(o)&&(r.vertexBufferKindToNumberOfComponents[s]*=-1)))}if(r){const s=t._caps.parallelShaderCompile;t._caps.parallelShaderCompile=void 0,e._processShaderCodeAsync(null,t._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,r),t._caps.parallelShaderCompile=s}}class wO{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}}const bl=(()=>{const n=new Uint8Array(4),e=new Uint32Array(n.buffer);return!!((e[0]=1)&n[0])})();Object.defineProperty(b.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0});b.prototype._rebuild=function(){var n,e;(n=this._buffer)==null||n._rebuild(),(e=this._alignedBuffer)==null||e._rebuild()};b.prototype.dispose=function(){var n;this._ownsBuffer&&this._buffer.dispose(),(n=this._alignedBuffer)==null||n.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0};b.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer};b.prototype._alignBuffer=function(){var h;const n=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4===0&&this.byteOffset%4===0||!n)return;const e=b.GetTypeByteLength(this.type),t=this.byteStride+3&-4,i=t/e,r=this._maxVerticesCount,a=r*t/e;let o;if(Array.isArray(n)){const f=new Float32Array(n);o=new DataView(f.buffer,f.byteOffset,f.byteLength)}else n instanceof ArrayBuffer?o=new DataView(n,0,n.byteLength):o=new DataView(n.buffer,n.byteOffset,n.byteLength);let l;this.type===b.BYTE?l=new Int8Array(a):this.type===b.UNSIGNED_BYTE?l=new Uint8Array(a):this.type===b.SHORT?l=new Int16Array(a):this.type===b.UNSIGNED_SHORT?l=new Uint16Array(a):this.type===b.INT?l=new Int32Array(a):this.type===b.UNSIGNED_INT?l=new Uint32Array(a):l=new Float32Array(a);const c=this.getSize();let u=this.byteOffset;for(let f=0;f<r;++f){for(let d=0;d<c;++d)switch(this.type){case b.BYTE:l[f*i+d]=o.getInt8(u+d);break;case b.UNSIGNED_BYTE:l[f*i+d]=o.getUint8(u+d);break;case b.SHORT:l[f*i+d]=o.getInt16(u+d*2,bl);break;case b.UNSIGNED_SHORT:l[f*i+d]=o.getUint16(u+d*2,bl);break;case b.INT:l[f*i+d]=o.getInt32(u+d*4,bl);break;case b.UNSIGNED_INT:l[f*i+d]=o.getUint32(u+d*4,bl);break;case b.FLOAT:l[f*i+d]=o.getFloat32(u+d*4,bl);break}u+=this.byteStride}(h=this._alignedBuffer)==null||h.dispose(),this._alignedBuffer=new tr(this.engine,l,!1,t,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")};const BO=new Q;if(typeof self<"u"&&!Object.prototype.hasOwnProperty.call(self,"_native")){let n;Object.defineProperty(self,"_native",{get:()=>n,set:e=>{n=e,n&&BO.notifyObservers(n)}})}class fg extends ao{}class VO{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=Zo._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}const Rf=[];class Zo extends Se{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine({version:Se.Version,nonFloatVertexBuffers:!0}),this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new VO(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,this._fillModeWarningDisplayed=!1,_native.Engine.PROTOCOL_VERSION!==Zo.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${Zo.PROTOCOL_VERSION} (JS)`);this._engine.setDeviceLostCallback&&this._engine.setDeviceLostCallback(()=>{this.onContextLostObservable.notifyObservers(this),this._contextWasLost=!0,this._restoreEngineAfterContextLost()}),this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxDrawBuffers:8,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1,parallelShaderCompile:{COMPLETION_STATUS_KHR:0}},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},J.Log("Babylon Native (v"+Se.Version+") launched"),J.LoadScript=function(r,s,a,o){J.LoadFile(r,l=>{Function(l).apply(null),s&&s()},void 0,void 0,!1,(l,c)=>{a&&a("LoadScript Error",c)})},typeof URL>"u"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob>"u"&&(window.Blob=function(r){return r}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function r(){const s=isNaN(arguments[0])?1:Number(arguments[0]);return s?Array.prototype.reduce.call(this,function(a,o){return Array.isArray(o)?a.push.apply(a,r.call(o,s-1)):a.push(o),a},[]):Array.prototype.slice.call(this)},writable:!0});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new IO,this.onNewSceneAddedObservable.add(r=>{const s=r.render;r.render=(...a)=>{this._commandBufferEncoder.beginCommandScope(),s.apply(r,a),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new io}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_restoreEngineAfterContextLost(){this._clearEmptyResources();const e=this._depthCullingState.depthTest,t=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;this._rebuildGraphicsResources(),this._depthCullingState.depthTest=e,this._depthCullingState.depthFunc=t,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=r,this._flagContextRestored()}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,r=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t,i){const r=this._normalizeIndexData(e),s=new fg;return s.references=1,s.is32Bits=r.BYTES_PER_ELEMENT===4,r.byteLength&&(s.nativeIndexBuffer=this._engine.createIndexBuffer(r.buffer,r.byteOffset,r.byteLength,s.is32Bits,t??!1)),s}createVertexBuffer(e,t,i){const r=ArrayBuffer.isView(e)?e:new Float32Array(e),s=new fg;return s.references=1,r.byteLength&&(s.nativeVertexBuffer=this._engine.createVertexBuffer(r.buffer,r.byteOffset,r.byteLength,t??!1)),s}_recordVertexArrayObject(e,t,i,r,s){r._checkedNonFloatVertexBuffers||(FT(t,r),r._checkedNonFloatVertexBuffers=!0),i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const a=r.getAttributesNames();for(let o=0;o<a.length;o++){const l=r.getAttributeLocation(o);if(l>=0){const c=a[o];let u=null;if(s&&(u=s[c]),u||(u=t[c]),u){const h=u.effectiveBuffer;h&&h.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,h.nativeVertexBuffer,l,u.effectiveByteOffset,u.effectiveByteStride,u.getSize(),NO(u.type),u.normalized,u.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,r){const s=this._engine.createVertexArray();return this._recordVertexArrayObject(s,e,t,i,r),s}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e,r=i.shaderProcessingContext;Rf.length=0;for(let s=0;s<t.length;s++){const a=t[s],o=r.remappedAttributeNames[a]??a;Rf[s]=o}return this._engine.getAttributes(i.program,Rf)}_checkSupportedFillMode(e){return e==5||e==8?(this._fillModeWarningDisplayed||(w.Warn("Line Loop and Triangle Fan are not supported fill modes with Babylon Native. Elements with these fill mode will not be visible."),this._fillModeWarningDisplayed=!0),!1):!0}drawElementsType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINDEXEDINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}drawArraysType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}createPipelineContext(e){const t=!!(this._caps.parallelShaderCompile&&this._engine.createProgramAsync);return new yO(this,t,e)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,r,s,a,o,l,c,u,h){r?this.createRawShaderProgram():this.createShaderProgram(e,t,i,l),h()}_getShaderProcessingContext(e){return new wO}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(i.isAsync)if(i.onCompiled){const r=i.onCompiled;i.onCompiled=()=>{r(),t()}}else i.onCompiled=t;else t()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(e,t,i,r){const s=e;this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=new Ka(t);a.processCode(),t=a.code;const o=new Ka(i);o.processCode(),i=o.code,t=st._ConcatenateShader(t,r),i=st._ConcatenateShader(i,r);const l=()=>{var c;s.isCompiled=!0,(c=s.onCompiled)==null||c.call(s),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(e.isAsync)s.program=this._engine.createProgramAsync(t,i,l,c=>{s.compilationError=c});else try{s.program=this._engine.createProgram(t,i),l()}catch(c){const u=c==null?void 0:c.message;throw new Error("SHADER ERROR"+(typeof u=="string"?`
`+u:""))}return s.program}inlineShaderCode(e){const t=new Ka(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.program&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.program),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.program,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let r=0;r<i.length;r++){const s=e.getUniform(i[r]);s&&(this._boundUniforms[r]=s)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setState(e,t=0,i,r=!1,s,a,o=0){this._zOffset=t,this._zOffsetUnits=o,this._zOffset!==0&&J.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces??s??!0?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL;break}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,PO(this._stencilOpStencilFail),MO(this._stencilOpDepthFail),DO(this._stencilOpStencilDepthPass),RO(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,r,s,a){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,r){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=OO(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(e===0),this._alphaMode=e}setInt(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setArray(e,t){return e?this.setFloatArray(e,new Float32Array(t)):!1}setArray2(e,t){return e?this.setFloatArray2(e,new Float32Array(t)):!1}setArray3(e,t){return e?this.setFloatArray3(e,new Float32Array(t)):!1}setArray4(e,t){return e?this.setFloatArray4(e,new Float32Array(t)):!1}setMatrices(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix3x3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix2x2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat2(e,t,i){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat3(e,t,i,r){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat4(e,t,i,r,s){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setColor3(e,t){return e?(this.setFloat3(e,t.r,t.g,t.b),!0):!1}setColor4(e,t,i){return e?(this.setFloat4(e,t.r,t.g,t.b,i),!0):!1}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e.underlyingResource)}updateDynamicTexture(e,t,i,r=!1,s){if(r===void 0&&(r=!1),e&&e._hardwareTexture){const a=t.getCanvasTexture(),o=e._hardwareTexture.underlyingResource;this._engine.copyTexture(o,a),e.isReady=!0}}createDynamicTexture(e,t,i,r){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,r)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const r=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(r,t,i)}}createRawTexture(e,t,i,r,s,a,o,l=null,c=0,u=0,h=!1){const f=new Yt(this,3);if(f.format=r,f.generateMipMaps=s,f.samplingMode=o,f.invertY=a,f.baseWidth=t,f.baseHeight=i,f.width=f.baseWidth,f.height=f.baseHeight,f._compression=l,f.type=c,f._useSRGBBuffer=this._getUseSRGBBuffer(h,!s),this.updateRawTexture(f,e,r,a,l,c,f._useSRGBBuffer),f._hardwareTexture){const d=f._hardwareTexture.underlyingResource,p=yl(o);this._setTextureSampling(d,p)}return this._internalTexturesCache.push(f),f}createRawTexture2DArray(e,t,i,r,s,a,o,l,c=null,u=0){const h=new Yt(this,11);if(h.baseWidth=t,h.baseHeight=i,h.baseDepth=r,h.width=t,h.height=i,h.depth=r,h.format=s,h.type=u,h.generateMipMaps=a,h.samplingMode=l,h.is2DArray=!0,h._hardwareTexture){const f=h._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(f,e,t,i,r,yf(s,u),a,o);const d=yl(l);this._setTextureSampling(f,d)}return h.isReady=!0,this._internalTexturesCache.push(h),h}updateRawTexture(e,t,i,r,s=null,a=0,o=!1){if(e){if(t&&e._hardwareTexture){const l=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(l,t,e.width,e.height,yf(i,a),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,r,s=3,a=null,o=null,l=null,c=null,u=null,h=null,f,d,p,_=!1){e=e||"";const g=e.substring(0,5)==="data:",E=g&&e.indexOf(";base64,")!==-1,v=c||new Yt(this,1),x=e;this._transformTextureUrl&&!E&&!c&&!l&&(e=this._transformTextureUrl(e));const A=e.lastIndexOf("."),T=h||(A>-1?e.substring(A).toLowerCase():"");let C=null;(T.endsWith(".basis")||T.endsWith(".ktx")||T.endsWith(".ktx2")||f==="image/ktx"||f==="image/ktx2")&&(C=ip(T)),r&&r.addPendingData(v),v.url=e,v.generateMipMaps=!t,v.samplingMode=s,v.invertY=i,v._useSRGBBuffer=this._getUseSRGBBuffer(_,t),this.doNotHandleContextLost||(v._buffer=l);let y=null;a&&!c&&(y=v.onLoadedObservable.add(a)),c||this._internalTexturesCache.push(v);const P=(D,F)=>{r&&r.removePendingData(v),e===x?(y&&v.onLoadedObservable.remove(y),$e.UseFallbackTexture&&this.createTexture($e.FallbackTexture,t,v.invertY,r,s,null,o,l,v),o&&o((D||"Unknown error")+($e.UseFallbackTexture?" - Fallback texture was used":""),F)):(w.Warn(`Failed to load ${e}, falling back to ${x}`),this.createTexture(x,t,v.invertY,r,s,a,o,l,v,u,h,f,d))};if(C)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const D=F=>{if(!v._hardwareTexture){r&&r.removePendingData(v);return}const W=v._hardwareTexture.underlyingResource;this._engine.loadTexture(W,F,!t,i,v._useSRGBBuffer,()=>{v.baseWidth=this._engine.getTextureWidth(W),v.baseHeight=this._engine.getTextureHeight(W),v.width=v.baseWidth,v.height=v.baseHeight,v.isReady=!0;const H=yl(s);this._setTextureSampling(W,H),r&&r.removePendingData(v),v.onLoadedObservable.notifyObservers(v),v.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(g&&l)if(l instanceof ArrayBuffer)D(new Uint8Array(l));else if(ArrayBuffer.isView(l))D(l);else if(typeof l=="string")D(new Uint8Array(J.DecodeBase64(l)));else throw new Error("Unsupported buffer type");else E?D(new Uint8Array(J.DecodeBase64(e))):this._loadFile(e,F=>D(new Uint8Array(F)),void 0,void 0,!0,(F,W)=>{P("Unable to load "+(F&&F.responseURL,W))})}return v}wrapNativeTexture(e,t=!1,i=3){const r=new hg(e,this._engine),s=new Yt(this,0,!0);return s._hardwareTexture=r,s.baseWidth=this._engine.getTextureWidth(e),s.baseHeight=this._engine.getTextureHeight(e),s.width=s.baseWidth,s.height=s.baseHeight,s.isReady=!0,s.useMipMaps=t,this.updateTextureSamplingMode(i,s),s}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){const r=t.generateStencil||!1,s=t.samples||1,a=i,o=new Yt(this,12),l=e.width??e,c=e.height??e,u=this._engine.createFrameBuffer(o._hardwareTexture.underlyingResource,l,c,r,!0,s);return a._framebufferDepthStencil=u,o}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){return new Promise((r,s)=>{const a=this.createCanvasImage();a.onload=()=>{try{const o=this._engine.createImageBitmap(a);r(o)}catch(o){s(`Error loading image ${a.src} with exception: ${o}`)}},a.onerror=o=>{s(`Error loading image ${a.src} with exception: ${o}`)},a.src=e})}createImageBitmap(e,t){return new Promise((i,r)=>{if(Array.isArray(e)){const s=e;if(s.length){const a=this._engine.createImageBitmap(s[0]);if(a){i(a);return}}}r("Unsupported data for createImageBitmap.")})}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,r,s=null,a=null,o,l=null,c=!1,u=0,h=0,f=null,d,p=!1,_=null){const g=f||new Yt(this,7);g.isCube=!0,g.url=e,g.generateMipMaps=!r,g._lodGenerationScale=u,g._lodGenerationOffset=h,g._useSRGBBuffer=this._getUseSRGBBuffer(p,!!r),this._doNotHandleContextLost||(g._extension=l,g._files=i,g._buffer=_);const E=e.lastIndexOf(".");if((l||(E>-1?e.substring(E).toLowerCase():""))===".env"){const x=A=>{const T=SO(A);g.width=T.width,g.height=T.width,TO(g,T);const C=T.specular;if(!C)throw new Error("Nothing else parsed so far");g._lodGenerationScale=C.lodGenerationScale;const y=LT(A,T);g.format=5,g.type=0,g.generateMipMaps=!0,g.getEngine().updateTextureSamplingMode(Z.TRILINEAR_SAMPLINGMODE,g),g._isRGBD=!0,g.invertY=!0,this._engine.loadCubeTextureWithMips(g._hardwareTexture.underlyingResource,y,!1,g._useSRGBBuffer,()=>{g.isReady=!0,s&&s()},()=>{throw new Error("Could not load a native cube texture.")})};if(_)x(_);else{if(i&&i.length===6)throw new Error("Multi-file loading not allowed on env files.");{const A=(T,C)=>{a&&T&&a(T.status+" "+T.statusText,C)};this._loadFile(e,T=>{x(new Uint8Array(T,0,T.byteLength))},void 0,void 0,!0,A)}}}else{if(!i||i.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");const x=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(x.map(A=>this._loadFileAsync(A,void 0,!0).then(T=>new Uint8Array(T,0,T.byteLength)))).then(A=>new Promise((T,C)=>{this._engine.loadCubeTexture(g._hardwareTexture.underlyingResource,A,!r,!0,g._useSRGBBuffer,T,C)})).then(()=>{g.isReady=!0,s&&s()},A=>{a&&a(`Failed to load cubemap: ${A.message}`,A)})}return this._internalTexturesCache.push(g),g}_createHardwareTexture(){return new hg(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){const r=new bO(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}_createInternalTexture(e,t,i=!0,r=0){let s=!1,a=0,o=3,l=5,c=!1,u=1,h;t!==void 0&&typeof t=="object"?(s=!!t.generateMipMaps,a=t.type===void 0?0:t.type,o=t.samplingMode===void 0?3:t.samplingMode,l=t.format===void 0?5:t.format,c=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=t.samples??1,h=t.label):s=!!t,c=this._getUseSRGBBuffer(c,!s),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(o=1),a===1&&!this._caps.textureFloat&&(a=0,w.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=new Yt(this,r),d=e.width??e,p=e.height??e,_=e.layers||0;if(_!==0)throw new Error("Texture layers are not supported in Babylon Native");const g=f._hardwareTexture.underlyingResource,E=yf(l,a);return this._engine.initializeTexture(g,d,p,s,E,!0,c,u),this._setTextureSampling(g,yl(o)),f._useSRGBBuffer=c,f.baseWidth=d,f.baseHeight=p,f.width=d,f.height=p,f.depth=_,f.isReady=!0,f.samples=u,f.generateMipMaps=s,f.samplingMode=o,f.type=a,f.format=l,f.label=h,this._internalTexturesCache.push(f),f}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e);let r=!0,s=!1,a=!1,o,l=1;t!==void 0&&typeof t=="object"&&(r=t.generateDepthBuffer??!0,s=!!t.generateStencilBuffer,a=!!t.noColorAttachment,o=t.colorAttachment,l=t.samples??1);const c=o||(a?null:this._createInternalTexture(e,t,!0,5)),u=e.width??e,h=e.height??e,f=this._engine.createFrameBuffer(c?c._hardwareTexture.underlyingResource:null,u,h,s,r,l);return i._framebuffer=f,i._generateDepthBuffer=r,i._generateStencilBuffer=s,i._samples=l,i.setTextures(c),i}updateRenderTargetTextureSampleCount(e,t){return w.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=yl(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,r,s){const a=e;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||r)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");a._framebufferDepthStencil?this._bindUnboundFramebuffer(a._framebufferDepthStencil):this._bindUnboundFramebuffer(a._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const r=e,s=this._normalizeIndexData(t);r.is32Bits=s.BYTES_PER_ELEMENT===4,this._engine.updateDynamicIndexBuffer(r.nativeIndexBuffer,s.buffer,s.byteOffset,s.byteLength,i)}updateDynamicVertexBuffer(e,t,i=0,r){const s=e,a=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,o=new Uint8Array(a.buffer,a.byteOffset,r??a.byteLength);this._engine.updateDynamicVertexBuffer(s.nativeVertexBuffer,o.buffer,o.byteOffset,o.byteLength,i)}_setTexture(e,t,i=!1,r=!1){const s=this._boundUniforms[e];if(!s)return!1;if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._boundTexturesCache[e]=null,this._unsetNativeTexture(s)),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;return r?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,this._activeChannel=e,!a||!a._hardwareTexture?!1:(this._setTextureWrapMode(a._hardwareTexture.underlyingResource,bf(t.wrapU),bf(t.wrapV),bf(t.wrapR)),this._updateAnisotropicLevel(t),this._setNativeTexture(s,a._hardwareTexture.underlyingResource),!0)}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand()}_setNativeTexture(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_unsetNativeTexture(e){_native.Engine.COMMAND_UNSETTEXTURE&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNSETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;!t||!t._hardwareTexture||t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_bindTexture(e,t){const i=this._boundUniforms[e];if(i)if(t&&t._hardwareTexture){const r=t._hardwareTexture.underlyingResource;this._setNativeTexture(i,r)}else this._unsetNativeTexture(i)}unbindAllTextures(){_native.Engine.COMMAND_DISCARDALLTEXTURES&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DISCARDALLTEXTURES),this._commandBufferEncoder.finishEncodingCommand())}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,r,s,a,o=0,l=0,c=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,a=0,o=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,r=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,r=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(e){return{ascent:0,height:0,descent:0}}flushFramebuffer(){}_readTexturePixels(e,t,i,r,s,a,o,l,c,u){var h;if(r!==void 0&&r!==-1)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${r}.`);return this._engine.readTexture((h=e._hardwareTexture)==null?void 0:h.underlyingResource,s??0,c??0,u??0,t,i,(a==null?void 0:a.buffer)??null,(a==null?void 0:a.byteOffset)??0,(a==null?void 0:a.byteLength)??0).then(f=>(a||(a=new Uint8Array(f)),a))}}Zo.PROTOCOL_VERSION=8;Zo._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new UO:new io};class UO extends io{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}class Ft{static ComputeNumMipmapLevels(e,t){return mc(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8uint":case"rg8unorm":case"rg8uint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8uint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc5-rg-unorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-rg11unorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":return 0;case"r8snorm":case"r8sint":case"rg8snorm":case"rg8sint":case"rgba8snorm":case"rgba8sint":case"bc6h-rgb-float":case"bc5-rg-snorm":case"bc4-r-snorm":case"eac-r11snorm":case"eac-rg11snorm":return 3;case"r16uint":case"rg16uint":case"rgba16uint":case"depth16unorm":return 5;case"r16sint":case"rg16sint":case"rgba16sint":return 4;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"rg32uint":case"rgba32uint":return 7;case"r32sint":case"rg32sint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth16unorm":return{width:1,height:1,length:2};case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float":return{width:1,height:1,length:4};case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":return{width:4,height:4,length:8};case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":return{width:4,height:4,length:16};case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return i?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return i?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return i?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return i?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return i?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return i?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return i?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?"rgba8unorm-srgb":"rgba8unorm";case 12:return i?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16sint";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16uint";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32sint";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32uint";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba32float";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba16float";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV";default:return"rg11b10ufloat"}case 14:switch(t){case 5:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV";default:return"rgb9e5ufloat"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return"rgb10a2unorm";case 11:return"rgb10a2uint";default:return"rgb10a2unorm"}}return i?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":return"depth24plus";case"depth24plus-stencil8":return"depth24plus";case"depth32float":return"depth32float";case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}class gp{constructor(){this._gpuTimeInFrameId=-1,this.counter=new ps}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}class Wi extends q{constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new gp:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return this._currentRenderTarget===null}_endCurrentRenderPass(){var t,i,r;if(!this._currentRenderPass)return 0;const e=this._currentPassIsMainPass()?2:1;return!this._snapshotRendering.endRenderPass(this._currentRenderPass)&&!this.compatibilityMode&&(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log("frame #"+this._count+" - "+(e===2?"main":"render target")+" end pass"+(e===1?" - internalTexture.uniqueId="+((i=(t=this._currentRenderTarget)==null?void 0:t.texture)==null?void 0:i.uniqueId):""))),(r=this._debugPopGroup)==null||r.call(this,0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;const i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();const r=e._hardwareTexture.format,s=Ft.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,s,t):this._textureHelper.generateMipmaps(i,r,s,0,e.is3D,t)}}Wi.prototype.setAlphaMode=function(n,e=!1){if(this._alphaMode===n&&(n===0&&!this._alphaState.alphaBlend||n!==0&&this._alphaState.alphaBlend)){if(!e){const t=n===0;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}return}switch(n){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0;break}e||(this.setDepthWrite(n===0),this._cacheRenderPipeline.setDepthWriteEnabled(n===0)),this._alphaMode=n,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};Wi.prototype.setAlphaEquation=function(n){q.prototype.setAlphaEquation.call(this,n),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};class Qo{constructor(e,t,i,r=""){this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new Q,this.onErrorObservable=new Q,this.onBindObservable=new Q,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=1,this.name=e,this._key=r,this._engine=i,this.uniqueId=Qo._UniqueIdSeed++,this.defines=t.defines??"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=t.entryPoint??"main",this._shaderStore=V.GetShadersStore(this._shaderLanguage),this._shaderRepository=V.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=V.GetIncludesShadersStore(this._shaderLanguage);let s;const a=Yi()?this._engine.getHostDocument():null;typeof e=="string"?s=e:e.computeSource?s="source:"+e.computeSource:e.computeElement?s=(a==null?void 0:a.getElementById(e.computeElement))||e.computeElement:s=e.compute||e;const o={defines:this.defines.split(`
`),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(l,c,u)=>{if(!u)return c;for(const h of u){const d=h.replace("#define","").replace(";","").trim().split(" ");if(d.length===2){const p=d[0],_=d[1];(!isNaN(parseInt(_))||!isNaN(parseFloat(_)))&&(c=`const ${p} = ${_};
`+c)}}return c}};this._loadShader(s,"Compute","",l=>{Jd(o),LM(l,o,c=>{this._rawComputeSourceCode=l,t.processFinalCode&&(c=t.processFinalCode(c));const u=ep(c,"",o);this._useFinalCode(u.vertexCode,e)},this._engine)})}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+`
`+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,r){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const a=Zd(e);r(a);return}if(e.substring(0,7)==="source:"){r(e.substring(7));return}if(e.substring(0,7)==="base64:"){const a=window.atob(e.substring(7));r(a);return}if(this._shaderStore[e+t+"Shader"]){r(this._shaderStore[e+t+"Shader"]);return}if(i&&this._shaderStore[e+i+"Shader"]){r(this._shaderStore[e+i+"Shader"]);return}let s;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?s=e:s=this._shaderRepository+e,this._engine._loadFile(s+"."+t.toLowerCase()+".fx",r)}get computeSourceCode(){var e;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:((e=this._pipelineContext)==null?void 0:e._getComputeShaderCode())??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,r=>{if(r&&r.numErrors>0){this._processCompilationErrors(r,t);return}this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t)}),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_processCompilationErrors(e,t=null){var i;if(this._compilationError="",w.Error("Unable to compile compute effect:"),this.defines&&w.Error(`Defines:
`+this.defines),Qo.LogShaderCodeOnCompilationError){const r=(i=this._pipelineContext)==null?void 0:i._getComputeShaderCode();r&&(w.Error("Compute code:"),w.Error(r))}if(typeof e=="string")this._compilationError=e,w.Error("Error: "+this._compilationError);else for(const r of e.messages){let s="";r.line!==void 0&&(s+="Line "+r.line+", "),r.offset!==void 0&&(s+="Offset "+r.offset+", "),r.length!==void 0&&(s+="Length "+r.length+", "),s+=r.type+": "+r.text,this._compilationError&&(this._compilationError+=`
`),this._compilationError+=s,w.Error(s)}t&&(this._pipelineContext=t,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){V.GetShadersStore(1)[`${e}ComputeShader`]=t}}Qo._UniqueIdSeed=0;Qo.LogShaderCodeOnCompilationError=!0;var dg;(function(n){n.LowPower="low-power",n.HighPerformance="high-performance"})(dg||(dg={}));var pg;(function(n){n.DepthClipControl="depth-clip-control",n.Depth32FloatStencil8="depth32float-stencil8",n.TextureCompressionBC="texture-compression-bc",n.TextureCompressionBCSliced3D="texture-compression-bc-sliced-3d",n.TextureCompressionETC2="texture-compression-etc2",n.TextureCompressionASTC="texture-compression-astc",n.TextureCompressionASTCSliced3D="texture-compression-astc-sliced-3d",n.TimestampQuery="timestamp-query",n.IndirectFirstInstance="indirect-first-instance",n.ShaderF16="shader-f16",n.RG11B10UFloatRenderable="rg11b10ufloat-renderable",n.BGRA8UnormStorage="bgra8unorm-storage",n.Float32Filterable="float32-filterable",n.Float32Blendable="float32-blendable",n.ClipDistances="clip-distances",n.DualSourceBlending="dual-source-blending"})(pg||(pg={}));var _g;(function(n){n.Unmapped="unmapped",n.Pending="pending",n.Mapped="mapped"})(_g||(_g={}));var Kt;(function(n){n[n.MapRead=1]="MapRead",n[n.MapWrite=2]="MapWrite",n[n.CopySrc=4]="CopySrc",n[n.CopyDst=8]="CopyDst",n[n.Index=16]="Index",n[n.Vertex=32]="Vertex",n[n.Uniform=64]="Uniform",n[n.Storage=128]="Storage",n[n.Indirect=256]="Indirect",n[n.QueryResolve=512]="QueryResolve"})(Kt||(Kt={}));var mg;(function(n){n[n.Read=1]="Read",n[n.Write=2]="Write"})(mg||(mg={}));var gg;(function(n){n.E1d="1d",n.E2d="2d",n.E3d="3d"})(gg||(gg={}));var Eg;(function(n){n[n.CopySrc=1]="CopySrc",n[n.CopyDst=2]="CopyDst",n[n.TextureBinding=4]="TextureBinding",n[n.StorageBinding=8]="StorageBinding",n[n.RenderAttachment=16]="RenderAttachment"})(Eg||(Eg={}));var vg;(function(n){n.E1d="1d",n.E2d="2d",n.E2dArray="2d-array",n.Cube="cube",n.CubeArray="cube-array",n.E3d="3d"})(vg||(vg={}));var Sg;(function(n){n.All="all",n.StencilOnly="stencil-only",n.DepthOnly="depth-only"})(Sg||(Sg={}));var Tg;(function(n){n.R8Unorm="r8unorm",n.R8Snorm="r8snorm",n.R8Uint="r8uint",n.R8Sint="r8sint",n.R16Uint="r16uint",n.R16Sint="r16sint",n.R16Float="r16float",n.RG8Unorm="rg8unorm",n.RG8Snorm="rg8snorm",n.RG8Uint="rg8uint",n.RG8Sint="rg8sint",n.R32Uint="r32uint",n.R32Sint="r32sint",n.R32Float="r32float",n.RG16Uint="rg16uint",n.RG16Sint="rg16sint",n.RG16Float="rg16float",n.RGBA8Unorm="rgba8unorm",n.RGBA8UnormSRGB="rgba8unorm-srgb",n.RGBA8Snorm="rgba8snorm",n.RGBA8Uint="rgba8uint",n.RGBA8Sint="rgba8sint",n.BGRA8Unorm="bgra8unorm",n.BGRA8UnormSRGB="bgra8unorm-srgb",n.RGB9E5UFloat="rgb9e5ufloat",n.RGB10A2UINT="rgb10a2uint",n.RGB10A2Unorm="rgb10a2unorm",n.RG11B10UFloat="rg11b10ufloat",n.RG32Uint="rg32uint",n.RG32Sint="rg32sint",n.RG32Float="rg32float",n.RGBA16Uint="rgba16uint",n.RGBA16Sint="rgba16sint",n.RGBA16Float="rgba16float",n.RGBA32Uint="rgba32uint",n.RGBA32Sint="rgba32sint",n.RGBA32Float="rgba32float",n.Stencil8="stencil8",n.Depth16Unorm="depth16unorm",n.Depth24Plus="depth24plus",n.Depth24PlusStencil8="depth24plus-stencil8",n.Depth32Float="depth32float",n.BC1RGBAUnorm="bc1-rgba-unorm",n.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",n.BC2RGBAUnorm="bc2-rgba-unorm",n.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",n.BC3RGBAUnorm="bc3-rgba-unorm",n.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",n.BC4RUnorm="bc4-r-unorm",n.BC4RSnorm="bc4-r-snorm",n.BC5RGUnorm="bc5-rg-unorm",n.BC5RGSnorm="bc5-rg-snorm",n.BC6HRGBUFloat="bc6h-rgb-ufloat",n.BC6HRGBFloat="bc6h-rgb-float",n.BC7RGBAUnorm="bc7-rgba-unorm",n.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",n.ETC2RGB8Unorm="etc2-rgb8unorm",n.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",n.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",n.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",n.ETC2RGBA8Unorm="etc2-rgba8unorm",n.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",n.EACR11Unorm="eac-r11unorm",n.EACR11Snorm="eac-r11snorm",n.EACRG11Unorm="eac-rg11unorm",n.EACRG11Snorm="eac-rg11snorm",n.ASTC4x4Unorm="astc-4x4-unorm",n.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",n.ASTC5x4Unorm="astc-5x4-unorm",n.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",n.ASTC5x5Unorm="astc-5x5-unorm",n.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",n.ASTC6x5Unorm="astc-6x5-unorm",n.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",n.ASTC6x6Unorm="astc-6x6-unorm",n.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",n.ASTC8x5Unorm="astc-8x5-unorm",n.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",n.ASTC8x6Unorm="astc-8x6-unorm",n.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",n.ASTC8x8Unorm="astc-8x8-unorm",n.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",n.ASTC10x5Unorm="astc-10x5-unorm",n.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",n.ASTC10x6Unorm="astc-10x6-unorm",n.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",n.ASTC10x8Unorm="astc-10x8-unorm",n.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",n.ASTC10x10Unorm="astc-10x10-unorm",n.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",n.ASTC12x10Unorm="astc-12x10-unorm",n.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",n.ASTC12x12Unorm="astc-12x12-unorm",n.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",n.Depth32FloatStencil8="depth32float-stencil8"})(Tg||(Tg={}));var xg;(function(n){n.ClampToEdge="clamp-to-edge",n.Repeat="repeat",n.MirrorRepeat="mirror-repeat"})(xg||(xg={}));var Cg;(function(n){n.Nearest="nearest",n.Linear="linear"})(Cg||(Cg={}));var Ag;(function(n){n.Nearest="nearest",n.Linear="linear"})(Ag||(Ag={}));var Ig;(function(n){n.Never="never",n.Less="less",n.Equal="equal",n.LessEqual="less-equal",n.Greater="greater",n.NotEqual="not-equal",n.GreaterEqual="greater-equal",n.Always="always"})(Ig||(Ig={}));var yg;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Compute=4]="Compute"})(yg||(yg={}));var bg;(function(n){n.Uniform="uniform",n.Storage="storage",n.ReadOnlyStorage="read-only-storage"})(bg||(bg={}));var Rg;(function(n){n.Filtering="filtering",n.NonFiltering="non-filtering",n.Comparison="comparison"})(Rg||(Rg={}));var Pg;(function(n){n.Float="float",n.UnfilterableFloat="unfilterable-float",n.Depth="depth",n.Sint="sint",n.Uint="uint"})(Pg||(Pg={}));var Mg;(function(n){n.WriteOnly="write-only",n.ReadOnly="read-only",n.ReadWrite="read-write"})(Mg||(Mg={}));var Dg;(function(n){n.Error="error",n.Warning="warning",n.Info="info"})(Dg||(Dg={}));var Og;(function(n){n.Validation="validation",n.Internal="internal"})(Og||(Og={}));var Ng;(function(n){n.Auto="auto"})(Ng||(Ng={}));var Lg;(function(n){n.PointList="point-list",n.LineList="line-list",n.LineStrip="line-strip",n.TriangleList="triangle-list",n.TriangleStrip="triangle-strip"})(Lg||(Lg={}));var Fg;(function(n){n.CCW="ccw",n.CW="cw"})(Fg||(Fg={}));var wg;(function(n){n.None="none",n.Front="front",n.Back="back"})(wg||(wg={}));var Bg;(function(n){n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(Bg||(Bg={}));var Vg;(function(n){n.Zero="zero",n.One="one",n.Src="src",n.OneMinusSrc="one-minus-src",n.SrcAlpha="src-alpha",n.OneMinusSrcAlpha="one-minus-src-alpha",n.Dst="dst",n.OneMinusDst="one-minus-dst",n.DstAlpha="dst-alpha",n.OneMinusDstAlpha="one-minus-dst-alpha",n.SrcAlphaSaturated="src-alpha-saturated",n.Constant="constant",n.OneMinusConstant="one-minus-constant",n.Src1="src1",n.OneMinusSrc1="one-minus-src1",n.Src1Alpha="src1-alpha",n.OneMinusSrc1Alpha="one-minus-src1-alpha"})(Vg||(Vg={}));var Ug;(function(n){n.Add="add",n.Subtract="subtract",n.ReverseSubtract="reverse-subtract",n.Min="min",n.Max="max"})(Ug||(Ug={}));var kg;(function(n){n.Keep="keep",n.Zero="zero",n.Replace="replace",n.Invert="invert",n.IncrementClamp="increment-clamp",n.DecrementClamp="decrement-clamp",n.IncrementWrap="increment-wrap",n.DecrementWrap="decrement-wrap"})(kg||(kg={}));var Gg;(function(n){n.Uint16="uint16",n.Uint32="uint32"})(Gg||(Gg={}));var zg;(function(n){n.Uint8x2="uint8x2",n.Uint8x4="uint8x4",n.Sint8x2="sint8x2",n.Sint8x4="sint8x4",n.Unorm8x2="unorm8x2",n.Unorm8x4="unorm8x4",n.Snorm8x2="snorm8x2",n.Snorm8x4="snorm8x4",n.Uint16x2="uint16x2",n.Uint16x4="uint16x4",n.Sint16x2="sint16x2",n.Sint16x4="sint16x4",n.Unorm16x2="unorm16x2",n.Unorm16x4="unorm16x4",n.Snorm16x2="snorm16x2",n.Snorm16x4="snorm16x4",n.Float16x2="float16x2",n.Float16x4="float16x4",n.Float32="float32",n.Float32x2="float32x2",n.Float32x3="float32x3",n.Float32x4="float32x4",n.Uint32="uint32",n.Uint32x2="uint32x2",n.Uint32x3="uint32x3",n.Uint32x4="uint32x4",n.Sint32="sint32",n.Sint32x2="sint32x2",n.Sint32x3="sint32x3",n.Sint32x4="sint32x4",n.UNORM10x10x10x2="unorm10-10-10-2"})(zg||(zg={}));var Wg;(function(n){n.Vertex="vertex",n.Instance="instance"})(Wg||(Wg={}));var Hg;(function(n){n.Beginning="beginning",n.End="end"})(Hg||(Hg={}));var Xg;(function(n){n.Beginning="beginning",n.End="end"})(Xg||(Xg={}));var Yg;(function(n){n.Load="load",n.Clear="clear"})(Yg||(Yg={}));var $g;(function(n){n.Store="store",n.Discard="discard"})($g||($g={}));var Kg;(function(n){n.Occlusion="occlusion",n.Timestamp="timestamp"})(Kg||(Kg={}));var jg;(function(n){n.Opaque="opaque",n.Premultiplied="premultiplied"})(jg||(jg={}));var qg;(function(n){n.Standard="standard",n.Extended="extended"})(qg||(qg={}));var Zg;(function(n){n.Unknown="unknown",n.Destroyed="destroyed"})(Zg||(Zg={}));var Qg;(function(n){n.Validation="validation",n.OutOfMemory="out-of-memory",n.Internal="internal"})(Qg||(Qg={}));class $i{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let s=0;s<this._webgpuProcessingContext.leftOverUniforms.length;s++)if(this._webgpuProcessingContext.leftOverUniforms[s].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=$i.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",!0),this._addBufferBindingDescription(e,t,"uniform",!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){const r=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].name,a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].nameInArrayOfTexture;r&&(r.texture||r.externalTexture||r.storageTexture?this._webgpuProcessingContext.textureNames.push(a):r.sampler?this._webgpuProcessingContext.samplerNames.push(s):r.buffer&&this._webgpuProcessingContext.bufferNames.push(s))}}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let s=0;s<i.length;s++){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[t][s];a.sampler||a.texture||a.storageTexture||a.externalTexture?r.push({binding:a.binding,resource:void 0}):a.buffer&&r.push({binding:a.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,s,a){let{groupIndex:o,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]){let c;r===null?c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,externalTexture:{}}):s?c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,storageTexture:{access:"write-only",format:s,viewDimension:r}}):c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});const u=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]={name:e,index:c-1,nameInArrayOfTexture:u}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l].index,a?this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=2}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]){const a=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]={name:e,index:a-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=2}_addBufferBindingDescription(e,t,i,r){let{groupIndex:s,bindingIndex:a}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a]){const o=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:a,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a]={name:e,index:o-1}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][a].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[s][a].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[s][a].visibility|=2}}$i.LeftOvertUBOName="LeftOver";$i.InternalsUBOName="Internals";$i.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2};$i._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"};$i._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"};$i._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"};$i._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"};$i._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class kO{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,s,a,o,l){const c=this.engine;c._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");const u=this.shaderProcessingContext.availableTextures;let h;for(h=0;h<s.length;h++){const p=s[h],_=u[s[h]];_==null||_==null?(s.splice(h,1),h--):a[p]=h}for(const p of c.getAttributes(this,o))l.push(p);this.buildUniformLayout();const f=[],d=[];for(h=0;h<o.length;h++){const p=l[h];p>=0&&(f.push(o[h]),d.push(p))}this.shaderProcessingContext.attributeNamesFromEffect=f,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){var e;if(this.shaderProcessingContext.leftOverUniforms.length){(e=this.uniformBuffer)==null||e.dispose(),this.uniformBuffer=new ke(this.engine,void 0,void 0,"leftOver-"+this._name);for(const t of this.shaderProcessingContext.leftOverUniforms){const i=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),r=$i.UniformSizes[i];this.uniformBuffer.addUniform(t.name,r,t.length),this._leftOverUniformsByName[t.name]=t.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,r,s)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,r,s)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,r,s)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return(e=this.sources)==null?void 0:e.vertex}_getFragmentShaderCode(){var e;return(e=this.sources)==null?void 0:e.fragment}}const GO=4,zO=65536,Jg={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class _s{static get KnownUBOs(){return _s._SimplifiedKnownBindings?_s._SimplifiedKnownUBOs:_s._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){const e=_s.KnownUBOs,t=[];for(const i in e){const r=e[i].binding;r.groupIndex!==-1&&(t[r.groupIndex]===void 0?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){const i=this._attributeNextLocation;return this._attributeNextLocation+=(Jg[e]??1)*(t||1),i}getVaryingNextLocation(e,t=0){const i=this._varyingNextLocation;return this._varyingNextLocation+=(Jg[e]??1)*(t||1),i}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>zO-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===GO)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}_s._SimplifiedKnownBindings=!0;_s._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}};_s._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class WO extends $i{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0;const s=e.indexOf("["),a=e.indexOf("]");if(s>0&&a>0){const o=e.substring(s+1,a);r=+o,isNaN(r)&&(r=+i[o.trim()]),e=e.substring(0,s)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){const i=`// Internals UBO
uniform ${$i.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=e.indexOf("// Internals UBO")!==-1;return t?(this._fragmentIsGLES3=e.indexOf("#version 3")!==-1,this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+`##INJECTCODE##
`+e):(this._vertexIsGLES3=e.indexOf("#version 3")!==-1,this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){const i=/(flat\s)?\s*\bout\b/,r=/(flat\s)?\s*\bin\b/,s=/(flat\s)?\s*\bvarying\b/;return(t&&this._fragmentIsGLES3?r:!t&&this._vertexIsGLES3?i:s).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;const r=/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,s=/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,a=/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,l=(t&&this._fragmentIsGLES3?s:!t&&this._vertexIsGLES3?r:a).exec(e);if(l!==null){const c=l[1]??"",u=l[2],h=l[3];let f;t?(f=this._webgpuProcessingContext.availableVaryings[h],this._missingVaryings[f]="",f===void 0&&w.Warn(`Invalid fragment shader: The varying named "${h}" is not declared in the vertex shader! This declaration will be ignored.`)):(f=this._webgpuProcessingContext.getVaryingNextLocation(u,this._getArraySize(h,u,i)[2]),this._webgpuProcessingContext.availableVaryings[h]=f,this._missingVaryings[f]=`layout(location = ${f}) ${c} in ${u} ${h};`),e=e.replace(l[0],f===void 0?"":`layout(location = ${f}) ${c} ${t?"in":"out"} ${u} ${h};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const i=/\s*in\s+(\S+)\s+(\S+)\s*;/gm,r=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,a=(this._vertexIsGLES3?i:r).exec(e);if(a!==null){const o=a[1],l=a[2],c=this._webgpuProcessingContext.getAttributeNextLocation(o,this._getArraySize(l,o,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l;const u=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[l];if(u!==void 0){const h=u<0?u===-1?"int":"ivec"+-u:u===1?"uint":"uvec"+u,f=`_int_${l}_`;e=e.replace(a[0],`layout(location = ${c}) in ${h} ${f}; ${o} ${l} = ${o}(${f});`)}else e=e.replace(a[0],`layout(location = ${c}) in ${o} ${l};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;const s=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(s!==null){let a=s[1],o=s[2];if(a.indexOf("sampler")===0||a.indexOf("sampler")===1){let l=0;[o,a,l]=this._getArraySize(o,a,i);let c=this._webgpuProcessingContext.availableTextures[o];if(!c){c={autoBindSampler:!0,isTextureArray:l>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let y=0;y<(l||1);++y)c.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const u=$i._SamplerTypeByWebGLSamplerType[a]??"sampler",h=!!$i._IsComparisonSamplerByWebGPUSamplerType[u],f=h?"comparison":"filtering",d=o+"Sampler";let p=this._webgpuProcessingContext.availableSamplers[d];p||(p={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:f});const _=a.charAt(0)==="u"?"u":a.charAt(0)==="i"?"i":"";_&&(a=a.substring(1));const g=h?"depth":_==="u"?"uint":_==="i"?"sint":"float";c.sampleType=g;const E=l>0,v=p.binding.groupIndex,x=p.binding.bindingIndex,A=$i._SamplerFunctionByWebGLSamplerType[a],T=$i._TextureTypeByWebGLSamplerType[a],C=$i._GpuTextureViewDimensionByWebGPUTextureType[T];if(!E)l=1,e=`layout(set = ${v}, binding = ${x}) uniform ${u} ${d};
                        layout(set = ${c.textures[0].groupIndex}, binding = ${c.textures[0].bindingIndex}) uniform ${_}${T} ${o}Texture;
                        #define ${o} ${_}${A}(${o}Texture, ${d})`;else{const y=[];y.push(`layout(set = ${v}, binding = ${x}) uniform ${_}${u} ${d};`),e=`
`;for(let P=0;P<l;++P){const D=c.textures[P].groupIndex,F=c.textures[P].bindingIndex;y.push(`layout(set = ${D}, binding = ${F}) uniform ${T} ${o}Texture${P};`),e+=`${P>0?`
`:""}#define ${o}${P} ${_}${A}(${o}Texture${P}, ${d})`}e=y.join(`
`)+e,this._textureArrayProcessing.push(o)}this._webgpuProcessingContext.availableTextures[o]=c,this._webgpuProcessingContext.availableSamplers[d]=p,this._addSamplerBindingDescription(d,p,!t);for(let y=0;y<l;++y)this._addTextureBindingDescription(o,c,y,C,null,!t)}else this._addUniformToLeftOverUBO(o,a,i),e=""}return e}uniformBufferProcessor(e,t){const r=/uniform\s+(\w+)/gm.exec(e);if(r!==null){const s=r[1];let a=this._webgpuProcessingContext.availableBuffers[s];if(!a){const o=_s.KnownUBOs[s];let l;o&&o.binding.groupIndex!==-1?l=o.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),a={binding:l},this._webgpuProcessingContext.availableBuffers[s]=a}this._addBufferBindingDescription(s,a,"uniform",!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,s){const a=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,o=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(o,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const l=e.indexOf("gl_FragCoord")>=0,c=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,u=l?`vec4 glFragCoord_;
`:"",h=e.search(/layout *\(location *= *0\) *out/g)!==-1;if(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),!this._fragmentIsGLES3)e=e.replace(/void\s+?main\s*\(/g,(a||h?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{const f=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);f!==null&&(e=e.substring(0,f.index)+"layout(location = 0) "+e.substring(f.index))}e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",u),l&&(e=Mu(e,"void main",c))}else if(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){const l=e.lastIndexOf("}");e=e.substring(0,l),e+=`gl_Position.y *= yFactor_;
`,e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let r=i.exec(e);for(;r!==null;){const s=r[1];let a=+s;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[s.trim()]),e=e.replace(r[0],t+a),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(const r of this._webgpuProcessingContext.leftOverUniforms)r.length>0?i+=`    ${r.type} ${r.name}[${r.length}];
`:i+=`    ${r.type} ${r.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){const s=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,s),t=this._applyTextureArrayProcessing(t,s)}for(let r=0;r<this._missingVaryings.length;++r){const s=this._missingVaryings[r];s&&s.length>0&&(t=s+`
`+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}const HO="bakedVertexAnimationDeclaration",XO=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;
#ifdef INSTANCES
attribute bakedVertexAnimationSettingsInstanced : vec4<f32>;
#endif
fn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>
{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
`;V.IncludesShadersStoreWGSL[HO]=XO;const YO="bakedVertexAnimation",$O=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
let VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;
#else
let VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;
#endif
let totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;V.IncludesShadersStoreWGSL[YO]=$O;const KO="instancesDeclaration",jO=`#ifdef INSTANCES
attribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;V.IncludesShadersStoreWGSL[KO]=jO;const qO="instancesVertex",ZO=`#ifdef INSTANCES
var finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
var finalPreviousWorld=mat4x4<f32>(
vertexInputs.previousWorld0,vertexInputs.previousWorld1,
vertexInputs.previousWorld2,vertexInputs.previousWorld3);
#endif
#ifdef THIN_INSTANCES
#if !defined(WORLD_UBO)
finalWorld=uniforms.world*finalWorld;
#else
finalWorld=mesh.world*finalWorld;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
finalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
var finalWorld=uniforms.world;
#else
var finalWorld=mesh.world;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
var finalPreviousWorld=uniforms.previousWorld;
#endif
#endif
`;V.IncludesShadersStoreWGSL[qO]=ZO;const wT="helperFunctions",BT=`const PI: f32=3.1415926535897932384626433832795;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const HALF_MIN: f32=5.96046448e-08; 
const LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3<f32>=vec3<f32> (0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}
fn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}
fn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(0.0),vec3f(1.0));}
fn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);} 
fn maxEps(x: f32)->f32 {return max(x,Epsilon);}
fn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}
fn absEps(x: f32)->f32 {return abs(x)+Epsilon;}
fn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3<f32>=inMatrix[0];let i1: vec3<f32>=inMatrix[1];let i2: vec3<f32>=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
fn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,
b11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,
b21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}
#if USE_EXACT_SRGB_CONVERSIONS
fn toLinearSpaceExact(color: vec3<f32>)->vec3<f32>
{let nearZeroSection: vec3<f32>=0.0773993808*color;let remainingSection: vec3<f32>=pow(0.947867299*(color+vec3<f32>(0.055)),vec3<f32>(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3<f32>(0.04045)));}
fn toGammaSpaceExact(color: vec3<f32>)->vec3<f32>
{let nearZeroSection: vec3<f32>=12.92*color;let remainingSection: vec3<f32>=1.055*pow(color,vec3<f32>(0.41666))-vec3<f32>(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3<f32>(0.0031308)));}
#endif
fn toLinearSpace(color: f32)->f32
{
#if USE_EXACT_SRGB_CONVERSIONS
var nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
fn toLinearSpaceVec3(color: vec3<f32>)->vec3<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3<f32>(LinearEncodePowerApprox));
#endif
}
fn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4f(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpace(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4<f32>(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4<f32>(pow(color.rgb,vec3<f32>(GammaEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpaceVec3(color: vec3<f32>)->vec3<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3<f32>(GammaEncodePowerApprox));
#endif
}
fn squareVec3(value: vec3<f32>)->vec3<f32>
{return value*value;}
fn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}
fn getLuminance(color: vec3<f32>)->f32
{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}
fn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}
fn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}
const rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3<f32>)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3<f32> =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(clamp(rgb,vec3<f32>(0.,0.,0.),vec3<f32>(1.,1.,1.)),D); }
fn fromRGBD(rgbd: vec4<f32>)->vec3<f32> {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}
fn parallaxCorrectNormal(vertexPos: vec3<f32>,origVec: vec3<f32>,cubeSize: vec3<f32>,cubePos: vec3<f32>)->vec3<f32> {let invOrigVec: vec3<f32>=vec3<f32>(1.0,1.0,1.0)/origVec;let halfSize: vec3<f32>=cubeSize*0.5;let intersecAtMaxPlane: vec3<f32>=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3<f32>=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3<f32>=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3<f32>=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
`;V.IncludesShadersStoreWGSL[wT]=BT;const QO={name:wT,shader:BT},VT=Object.freeze(Object.defineProperty({__proto__:null,helperFunctionsWGSL:QO},Symbol.toStringTag,{value:"Module"})),JO="fresnelFunction",eN=`#ifdef FRESNEL
fn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32
{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;V.IncludesShadersStoreWGSL[JO]=eN;const tN="meshUboDeclaration",iN=`struct Mesh {world : mat4x4<f32>,
visibility : f32,};var<uniform> mesh : Mesh;
#define WORLD_UBO
`;V.IncludesShadersStoreWGSL[tN]=iN;const rN="sceneUboDeclaration",sN=`struct Scene {viewProjection : mat4x4<f32>,
#ifdef MULTIVIEW
viewProjectionR : mat4x4<f32>,
#endif 
view : mat4x4<f32>,
projection : mat4x4<f32>,
vEyePosition : vec4<f32>,};var<uniform> scene : Scene;
`;V.IncludesShadersStoreWGSL[rN]=sN;const nN="decalFragment",aN=`#ifdef DECAL
var decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;
#ifdef GAMMADECAL
decalTempColor=toLinearSpaceVec3(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalTempAlpha=decalColor.a*decalColor.a;
#endif
surfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);
#endif
`;V.IncludesShadersStoreWGSL[nN]=aN;const eE="fragmentOutputs.fragDepth",oN="uniforms",lN="internals",cN={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class uN extends $i{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}preProcessor(e,t,i,r,s){for(const a in i){if(a==="__VERSION__")continue;const o=i[a];(!isNaN(parseInt(o))||!isNaN(parseFloat(o)))&&(e=`const ${a} = ${o};
`+e)}return e}_getArraySize(e,t,i){let r=0;const s=t.lastIndexOf(">");if(t.indexOf("array")>=0&&s>0){let a=s;for(;a>0&&t.charAt(a)!==" "&&t.charAt(a)!==",";)a--;const o=t.substring(a+1,s);for(r=+o,isNaN(r)&&(r=+i[o.trim()]);a>0&&(t.charAt(a)===" "||t.charAt(a)===",");)a--;t=t.substring(t.indexOf("<")+1,a+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){const t=this.pureMode?"":`struct ${$i.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> ${lN} : ${$i.InternalsUBOName};
`;return e.indexOf(t)!==-1?e:t+fd(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){const s=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(s!==null){const a=s[1]??"perspective",o=s[2]??"center",l=s[4],c=s[3],u=a==="flat"?`@interpolate(${a})`:`@interpolate(${a}, ${o})`;let h;t?(h=this._webgpuProcessingContext.availableVaryings[c],h===void 0&&w.Warn(`Invalid fragment shader: The varying named "${c}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this._webgpuProcessingContext.getVaryingNextLocation(l,this._getArraySize(c,l,i)[2]),this._webgpuProcessingContext.availableVaryings[c]=h,this._varyingsWGSL.push(`  @location(${h}) ${u} ${c} : ${l},`),this._varyingNamesWGSL.push(c)),e=""}return e}attributeProcessor(e,t){const r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){const s=r[2],a=r[1],o=this._webgpuProcessingContext.getAttributeNextLocation(s,this._getArraySize(a,s,t)[2]);this._webgpuProcessingContext.availableAttributes[a]=o,this._webgpuProcessingContext.orderedAttributes[o]=a;const l=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[a];if(l!==void 0){const c=l<0?l===-1?"i32":"vec"+-l+"<i32>":l===1?"u32":"vec"+l+"<u32>",u=`_int_${a}_`;this._attributesInputWGSL.push(`@location(${o}) ${u} : ${c},`),this._attributesWGSL.push(`${a} : ${s},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = ${s}(vertexInputs_.${u});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${o}) ${a} : ${s},`),this._attributesWGSL.push(`${a} : ${s},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = vertexInputs_.${a};`);e=""}return e}uniformProcessor(e,t,i){const r=this.uniformRegexp.exec(e);if(r!==null){const s=r[2],a=r[1];this._addUniformToLeftOverUBO(a,s,i),e=""}return e}textureProcessor(e,t,i){const r=this.textureRegexp.exec(e);if(r!==null){const s=r[1],a=r[2],o=!!r[3],l=r[4],c=l.indexOf("storage")>0,u=r[6],h=c?u.substring(0,u.indexOf(",")).trim():null;let f=o?this._getArraySize(s,a,i)[2]:0,d=this._webgpuProcessingContext.availableTextures[s];if(d)f=d.textures.length;else{d={isTextureArray:f>0,isStorageTexture:c,textures:[],sampleType:"float"},f=f||1;for(let E=0;E<f;++E)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=d;const p=l.indexOf("depth")>0,_=cN[l],g=p?"depth":u==="u32"?"uint":u==="i32"?"sint":"float";if(d.sampleType=g,_===void 0)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let E=0;E<f;++E){const{groupIndex:v,bindingIndex:x}=d.textures[E];E===0&&(e=`@group(${v}) @binding(${x}) ${e}`),this._addTextureBindingDescription(s,d,E,_,h,!t)}}return e}postProcessor(e){const t=/#define (.+?) (.+?)$/gm;let i;for(;(i=t.exec(e))!==null;)e=e.replace(new RegExp(i[1],"g"),i[2]);return e}finalizeShaders(e,t){const i=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const r=this._buildLeftOverUBO();e=r+e,t=r+t,e=e.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;"),e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let s=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesInputWGSL.length>0&&(s+=this._attributesInputWGSL.join(`
`)),s+=`
};
var<private> vertexInputs`+(this._hasNonFloatAttribute?"_":"")+` : VertexInputs;
`,this._hasNonFloatAttribute&&(s+=`struct VertexInputs_ {
  vertexIndex : u32, instanceIndex : u32,
`,s+=this._attributesWGSL.join(`
`),s+=`
};
var<private> vertexInputs : VertexInputs_;
`);let a=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(a+=this._varyingsWGSL.join(`
`)),a+=`
};
var<private> vertexOutputs : FragmentInputs;
`,e=s+a+e;let o=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(o+=`vertexInputs.vertexIndex = vertexInputs_.vertexIndex;
vertexInputs.instanceIndex = vertexInputs_.instanceIndex;
`,o+=this._attributesConversionCodeWGSL.join(`
`),o+=`
`);const l=this.pureMode?"  return vertexOutputs;":`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`;let c=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1;e=(c?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+Mu(e,"fn main",o,l),t=t.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;"),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let u=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(u+=this._varyingsWGSL.join(`
`)),u+=`
};
var<private> fragmentInputs : FragmentInputs;
`;let h=`struct FragmentOutputs {
`;const f="fragmentOutputs\\.fragData";let d=t.match(new RegExp(f+"0","g")),p=0;if(d){h+=` @location(${p}) fragData0 : vec4<f32>,
`,p++;for(let A=1;A<8;A++)d=t.match(new RegExp(f+A,"g")),d&&(h+=` @location(${p}) fragData${p} : vec4<f32>,
`,p++);t.indexOf("MRT_AND_COLOR")!==-1&&(h+=`  @location(${p}) color : vec4<f32>,
`,p++)}const _=/oitDepthSampler/;d=t.match(_),d&&(h+=` @location(${p++}) depth : vec2<f32>,
`,h+=` @location(${p++}) frontColor : vec4<f32>,
`,h+=` @location(${p++}) backColor : vec4<f32>,
`),p===0&&(h+=`  @location(0) color : vec4<f32>,
`,p++);let g=!1,E=0;for(;!g&&(E=t.indexOf(eE,E),!(E<0));){const A=E;for(g=!0;E>1&&t.charAt(E)!==`
`;){if(t.charAt(E)==="/"&&t.charAt(E-1)==="/"){g=!1;break}E--}E=A+eE.length}g&&(h+=`  @builtin(frag_depth) fragDepth: f32,
`),h+=`};
var<private> fragmentOutputs : FragmentOutputs;
`,t=u+h+t;const v=`  fragmentInputs = input;
  `+i,x="  return fragmentOutputs;";return c=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1,t=(c?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+Mu(t,"fn main",v,x),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(const s of this._webgpuProcessingContext.leftOverUniforms){const a=s.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=$i.UniformSizes[a];if(s.length>0)if(o<=2){const l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {
                        @size(16)
                        el: ${a},
                    }`,this._stridedUniformArrays.push(s.name),r+=` @align(16) ${s.name} : array<${l}, ${s.length}>,
`}else r+=` ${s.name} : array<${s.type}, ${s.length}>,
`;else r+=`  ${s.name} : ${s.type},
`}return r+=`};
`,r=`${i}
${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${oN} : ${e};
`,r}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const r=i.exec(e);if(r===null)break;const s=r[1],a=r[2],o=s.length-7,l=s.lastIndexOf("Sampler")===o?s.substring(0,o):null,c=a==="sampler_comparison"?"comparison":"filtering";if(l){const p=this._webgpuProcessingContext.availableTextures[l];p&&(p.autoBindSampler=!0)}let u=this._webgpuProcessingContext.availableSamplers[s];u||(u={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c},this._webgpuProcessingContext.availableSamplers[s]=u),this._addSamplerBindingDescription(s,u,t);const h=e.substring(0,r.index),f=`@group(${u.binding.groupIndex}) @binding(${u.binding.bindingIndex}) `,d=e.substring(r.index);e=h+f+d,i.lastIndex+=f.length}return e}_processCustomBuffers(e,t){var r;const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=i.exec(e);if(s===null)break;const a=s[1],o=s[3];let l=s[4];const c=s[5];let u=this._webgpuProcessingContext.availableBuffers[l];if(!u){const g=a==="uniform"?_s.KnownUBOs[c]:null;let E;g?(l=c,E=g.binding,E.groupIndex===-1&&(E=(r=this._webgpuProcessingContext.availableBuffers[l])==null?void 0:r.binding,E||(E=this._webgpuProcessingContext.getNextFreeUBOBinding()))):E=this._webgpuProcessingContext.getNextFreeUBOBinding(),u={binding:E},this._webgpuProcessingContext.availableBuffers[l]=u}this._addBufferBindingDescription(l,this._webgpuProcessingContext.availableBuffers[l],o==="read_write"?"storage":a==="storage"?"read-only-storage":"uniform",t);const h=u.binding.groupIndex,f=u.binding.bindingIndex,d=e.substring(0,s.index),p=`@group(${h}) @binding(${f}) `,_=e.substring(s.index);e=d+p+_,i.lastIndex+=p.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}class hu{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e){var t;return((t=this._webgpuMSAATexture)==null?void 0:t[e])??null}setMSAATexture(e,t){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=e}releaseMSAATexture(e){var t;if(this._webgpuMSAATexture)if(e)(t=this._webgpuMSAATexture[e])==null||t.destroy(),delete this._webgpuMSAATexture[e];else{for(const i of this._webgpuMSAATexture)i==null||i.destroy();this._webgpuMSAATexture=null}}constructor(e=null){this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,s,a,o,l){let c="2d",u=1;r?(c=i?"cube-array":"cube",u=6*(l||1)):s?(c="3d",u=1):i&&(c="2d-array",u=l);const h=Ft.GetDepthFormatOnly(this.format),f=Ft.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${s?"3D":r?"Cube":"2D"}${i?"_Array"+u:""}_${a}x${o}_${t?"wmips":"womips"}_${this.format}_${c}`,format:h,dimension:c,mipLevelCount:t?mc(Math.max(a,o))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:u,aspect:f})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t;(e=this._webgpuTexture)==null||e.destroy(),this.releaseMSAATexture(),(t=this._copyInvertYTempTexture)==null||t.destroy(),this.reset()}}const hN=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    varying vTex: vec2f;

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.vTex = tex[input.vertexIndex];
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,fN=`
    var imgSampler: sampler;
    var img: texture_2d<f32>;

    varying vTex: vec2f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);
    }
    `,UT=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        #ifdef INVERTY
            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));
        #endif
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,dN=`
    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        fragmentOutputs.color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,pN=UT,_N=`
    var img: texture_2d<f32>;
    uniform ofstX: f32;
    uniform ofstY: f32;
    uniform width: f32;
    uniform height: f32;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {
            discard;
        }
        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {
            discard;
        }
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,mN=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,gN=`
    uniform color: vec4f;


    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = uniforms.color;
    }
    `,EN=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,vN=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,SN=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `;var Ds;(function(n){n[n.MipMap=0]="MipMap",n[n.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",n[n.Clear=2]="Clear",n[n.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"})(Ds||(Ds={}));var Po;(function(n){n[n.DontInvertY=0]="DontInvertY",n[n.InvertY=1]="InvertY"})(Po||(Po={}));const tE=[{vertex:hN,fragment:fN},{vertex:UT,fragment:dN},{vertex:mN,fragment:gN},{vertex:pN,fragment:_N}],an={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38};class TN{constructor(e,t,i,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=i,r.indexOf("rg11b10ufloat-renderable")!==-1){const s=Object.keys(an);an.rg11b10ufloat=an[s[s.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(4*4,Kt.Uniform|Kt.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=Ds.MipMap,i){const r=t===Ds.MipMap?1:t===Ds.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===Ds.Clear?8:t===Ds.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][r];if(!s){let a="";(t===Ds.InvertYPremultiplyAlpha||t===Ds.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(a+=`#define INVERTY
`),i.premultiplyAlpha&&(a+=`#define PREMULTIPLYALPHA
`));let o=this._compiledShaders[r];if(!o){let c=tE[t].vertex,u=tE[t].fragment;const h={defines:a.split(`
`),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};Jd(h),h.processor.pureMode=!0,Iu(c,h,_=>{c=_},this._engine),h.isFragment=!0,Iu(u,h,_=>{u=_},this._engine);const f=ep(c,u,h);h.processor.pureMode=!1;const d=this._device.createShaderModule({code:f.vertexCode}),p=this._device.createShaderModule({code:f.fragmentCode});o=this._compiledShaders[r]=[d,p]}const l=this._device.createRenderPipeline({layout:"auto",vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});s=this._pipelines[e][r]=[l,l.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=Po.DontInvertY){const i=t===Po.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let s=this._videoCompiledShaders[i];if(!s){const o=this._device.createShaderModule({code:EN}),l=this._device.createShaderModule({code:i===0?vN:SN});s=this._videoCompiledShaders[i]=[o,l]}const a=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_${e}_${i===0?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:s[0],entryPoint:"main"},fragment:{module:s[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});r=this._videoPipelines[e][i]=[a,a.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,s){var p,_;const a=s===void 0,[o,l]=this._getVideoPipeline(i,r?Po.InvertY:Po.DontInvertY);a&&(s=this._device.createCommandEncoder({})),(p=s.pushDebugGroup)==null||p.call(s,`copy video to texture - invertY=${r}`);const c=t._hardwareTexture,u={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:c.underlyingResource.createView({format:i,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},h=s.beginRenderPass(u),f={layout:l,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(f);h.setPipeline(o),h.setBindGroup(0,d),h.draw(4,1,0,0),h.end(),(_=s.popDebugGroup)==null||_.call(s),a&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,i,r,s=!1,a=!1,o=0,l=0,c=1,u=0,h=0,f=0,d=0,p,_){var F,W;const g=f!==0,E=p===void 0,[v,x]=this._getPipeline(r,g?Ds.InvertYPremultiplyAlphaWithOfst:Ds.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:a});o=Math.max(o,0),E&&(p=this._device.createCommandEncoder({})),(F=p.pushDebugGroup)==null||F.call(p,`internal process texture - invertY=${s} premultiplyAlpha=${a}`);let A;if(Ft.IsHardwareTexture(e)?(A=e.underlyingResource,s&&!a&&c===1&&o===0||(e=void 0)):(A=e,e=void 0),!A)return;g&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([u,h,f,d]),0,4*4);const T=e,C=(T==null?void 0:T._copyInvertYTempTexture)??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,p,21,void 0,"TempTextureForCopyWithInvertY"),y=(T==null?void 0:T._copyInvertYRenderPassDescr)??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${s?"InvertY":"DontInvertY"}_${a?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:C.createView({format:r,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},P=p.beginRenderPass(y);let D=g?T==null?void 0:T._copyInvertYBindGroupWithOfst:T==null?void 0:T._copyInvertYBindGroup;if(!D){const H={layout:x,entries:[{binding:0,resource:A.createView({format:r,dimension:"2d",baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:o})}]};g&&H.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),D=this._device.createBindGroup(H)}P.setPipeline(v),P.setBindGroup(0,D),P.draw(4,1,0,0),P.end(),p.copyTextureToTexture({texture:C},{texture:A,mipLevel:l,origin:{x:0,y:0,z:o}},{width:t,height:i,depthOrArrayLayers:1}),T?(T._copyInvertYTempTexture=C,T._copyInvertYRenderPassDescr=y,g?T._copyInvertYBindGroupWithOfst=D:T._copyInvertYBindGroup=D):this._deferredReleaseTextures.push([C,null]),(W=p.popDebugGroup)==null||W.call(p),E&&(this._device.queue.submit([p.finish()]),p=null)}copyWithInvertY(e,t,i,r){var u,h;const s=r===void 0,[a,o]=this._getPipeline(t,Ds.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});s&&(r=this._device.createCommandEncoder({})),(u=r.pushDebugGroup)==null||u.call(r,"internal copy texture with invertY");const l=r.beginRenderPass(i),c=this._device.createBindGroup({layout:o,entries:[{binding:0,resource:e}]});l.setPipeline(a),l.setBindGroup(0,c),l.draw(4,1,0,0),l.end(),(h=r.popDebugGroup)==null||h.call(r),s&&(this._device.queue.submit([r.finish()]),r=null)}createTexture(e,t=!1,i=!1,r=!1,s=!1,a=!1,o="rgba8unorm",l=1,c,u=-1,h=0,f){l=Ft.GetSample(l);const d=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:d},_=an[o]?16:0,g=Ft.IsCompressedFormat(o),E=t?Ft.ComputeNumMipmapLevels(e.width,e.height):1,v=u>=0?u:7;h|=t&&!g?1|_:0,!g&&!a&&(h|=_|2);const x=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${a?"3D":"2D"}_${f?f+"_":""}${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${l}`,size:p,dimension:a?"3d":"2d",format:o,usage:v|h,sampleCount:l,mipLevelCount:E});return Ft.IsImageBitmap(e)&&(this.updateTexture(e,x,e.width,e.height,d,o,0,0,r,s,0,0),t&&i&&this.generateMipmaps(x,o,E,0,a,c)),x}createCubeTexture(e,t=!1,i=!1,r=!1,s=!1,a="rgba8unorm",o=1,l,c=-1,u=0,h){o=Ft.GetSample(o);const f=Ft.IsImageBitmapArray(e)?e[0].width:e.width,d=Ft.IsImageBitmapArray(e)?e[0].height:e.height,p=an[a]?16:0,_=Ft.IsCompressedFormat(a),g=t?Ft.ComputeNumMipmapLevels(f,d):1,E=c>=0?c:7;u|=t&&!_?1|p:0,_||(u|=p|2);const v=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${f}x${d}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:f,height:d,depthOrArrayLayers:6},dimension:"2d",format:a,usage:E|u,sampleCount:o,mipLevelCount:g});return Ft.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,v,f,d,a,r,s,0,0),t&&i&&this.generateCubeMipmaps(v,a,g,l)),v}generateCubeMipmaps(e,t,i,r){var a,o;const s=r===void 0;s&&(r=this._device.createCommandEncoder({})),(a=r.pushDebugGroup)==null||a.call(r,`create cube mipmaps - ${i} levels`);for(let l=0;l<6;++l)this.generateMipmaps(e,t,i,l,!1,r);(o=r.popDebugGroup)==null||o.call(r),s&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,s=!1,a){var f,d,p,_;const o=a===void 0,[l,c]=this._getPipeline(t);r=Math.max(r,0),o&&(a=this._device.createCommandEncoder({})),(f=a.pushDebugGroup)==null||f.call(a,`create mipmaps for face #${r} - ${i} levels`);let u;if(Ft.IsHardwareTexture(e)?(u=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(u=e,e=void 0),!u)return;const h=e;for(let g=1;g<i;++g){const E=((d=h==null?void 0:h._mipmapGenRenderPassDescr[r])==null?void 0:d[g-1])??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${r}_level${g}`,colorAttachments:[{view:u.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:g,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[r]=h._mipmapGenRenderPassDescr[r]||[],h._mipmapGenRenderPassDescr[r][g-1]=E);const v=a.beginRenderPass(E),x=((p=h==null?void 0:h._mipmapGenBindGroup[r])==null?void 0:p[g-1])??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:u.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:g-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[r]=h._mipmapGenBindGroup[r]||[],h._mipmapGenBindGroup[r][g-1]=x),v.setPipeline(l),v.setBindGroup(0,x),v.draw(4,1,0,0),v.end()}(_=a.popDebugGroup)==null||_.call(a),o&&(this._device.queue.submit([a.finish()]),a=null)}createGPUTextureForInternalTexture(e,t,i,r,s,a){e._hardwareTexture||(e._hardwareTexture=new hu),t===void 0&&(t=e.width),i===void 0&&(i=e.height),r===void 0&&(r=e.depth);const o=e._hardwareTexture,l=((s??0)&1)!==0;o.format=Ft.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=e._source===5||e.source===6?21:e._source===12?20:-1,o.textureAdditionalUsages=l?8:0;const c=e.generateMipMaps,u=r||1;let h;if(e._maxLodLevel!==null?h=e._maxLodLevel:h=c?Ft.ComputeNumMipmapLevels(t,i):1,e.isCube){const f=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(f);const d=e.is3D?1:u,p=Ft.GetDepthFormatOnly(o.format),_=Ft.HasDepthAndStencilAspects(o.format)?"depth-only":"all",g=e.is2DArray?"cube-array":"cube";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+d:""}_${t}x${i}_${c?"wmips":"womips"}_${p}_${g}_${_}_${e.label??"noname"}`,format:p,dimension:g,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:_},l)}else{const f=this.createTexture({width:t,height:i,layers:u},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(f);const d=e.is3D?1:u,p=Ft.GetDepthFormatOnly(o.format),_=Ft.HasDepthAndStencilAspects(o.format)?"depth-only":"all",g=e.is2DArray?"2d-array":e.is3D?"3d":"2d";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+d:""}_${t}x${i}${e.is3D?"x"+u:""}_${c?"wmips":"womips"}_${p}_${g}_${_}_${e.label??"noname"}`,format:p,dimension:g,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:d,aspect:_},l)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r,a||this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,i=!0,r=0){const s=e._hardwareTexture;if(i&&(s==null||s.releaseMSAATexture()),!s||(t??1)<=1)return;const a=e.width,o=e.height,l=this.createTexture({width:a,height:o,layers:1},!1,!1,!1,!1,!1,s.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA"+e.label:void 0);s.setMSAATexture(l,r)}updateCubeTextures(e,t,i,r,s,a=!1,o=!1,l=0,c=0){const u=[0,3,1,4,2,5];for(let h=0;h<u.length;++h){const f=e[u[h]];this.updateTexture(f,t,i,r,1,s,h,0,a,o,l,c)}}updateTexture(e,t,i,r,s,a,o=0,l=0,c=!1,u=!1,h=0,f=0,d){const p=Ft.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,_=Ft.GetBlockInformationFromFormat(a),g=Ft.IsInternalTexture(t)?t._hardwareTexture:t,E={texture:p,origin:{x:h,y:f,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:u},v={width:Math.ceil(i/_.width)*_.width,height:Math.ceil(r/_.height)*_.height,depthOrArrayLayers:s||1};if(e.byteLength!==void 0){e=e;const x=Math.ceil(i/_.width)*_.length;if(Math.ceil(x/256)*256===x){const T=this._device.createCommandEncoder({}),C=this._bufferManager.createRawBuffer(e.byteLength,Kt.MapWrite|Kt.CopySrc,!0,"TempBufferForUpdateTexture"+(p?"_"+p.label:"")),y=C.getMappedRange();new Uint8Array(y).set(e),C.unmap(),T.copyBufferToTexture({buffer:C,offset:0,bytesPerRow:x,rowsPerImage:r},E,v),this._device.queue.submit([T.finish()]),this._bufferManager.releaseBuffer(C)}else this._device.queue.writeTexture(E,e,{offset:0,bytesPerRow:x,rowsPerImage:r},v);if(c||u)if(Ft.IsInternalTexture(t)){const T=h===0&&f===0&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(g,t.width,t.height,a,c,u,o,l,s||1,h,f,T?0:i,T?0:r,void 0,d)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else if(e=e,c)if(E.premultipliedAlpha=!1,Ft.IsInternalTexture(t)&&h===0&&f===0&&i===t.width&&r===t.height)this._device.queue.copyExternalImageToTexture({source:e},E,v),this.invertYPreMultiplyAlpha(g,i,r,a,c,u,o,l,s||1,0,0,0,0,void 0,d);else{const x=this._device.createCommandEncoder({}),A=this.createTexture({width:i,height:r,layers:1},!1,!1,!1,!1,!1,a,1,x,5,void 0,"TempTextureForUpdateTexture");this._deferredReleaseTextures.push([A,null]),v.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:A},v),v.depthOrArrayLayers=s||1,this.invertYPreMultiplyAlpha(A,i,r,a,c,u,o,l,s||1,0,0,0,0,x,d),x.copyTextureToTexture({texture:A},E,v),this._device.queue.submit([x.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},E,v)}readPixels(e,t,i,r,s,a,o=0,l=0,c=null,u=!1){const h=Ft.GetBlockInformationFromFormat(a),f=Math.ceil(r/h.width)*h.length,d=Math.ceil(f/256)*256,p=d*s,_=this._bufferManager.createRawBuffer(p,Kt.MapRead|Kt.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),g=this._device.createCommandEncoder({});return g.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:_,offset:0,bytesPerRow:d},{width:r,height:s,depthOrArrayLayers:1}),this._device.queue.submit([g.finish()]),this._bufferManager.readDataFromBuffer(_,p,r,s,f,d,Ft.GetTextureTypeFromFormat(a),0,c,!0,u)}releaseTexture(e){if(Ft.IsInternalTexture(e)){const t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(Ft.IsHardwareTexture(t)?t.release():t.destroy()),i==null||i.dispose()}this._deferredReleaseTextures.length=0}}class xN extends ao{set buffer(e){this._buffer=e}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e)}get underlyingResource(){return this._buffer}}class Du{static _IsGPUBuffer(e){return e.underlyingResource===void 0}static _FlagsToString(e,t=""){let i=t;for(let r=0;r<=9;++r)e&1<<r&&(i&&(i+="_"),i+=Kt[1<<r]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){const s=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,a={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+Du._FlagsToString(t,r??"Buffer")+"_size"+s,mappedAtCreation:i,size:s,usage:t};return this._device.createBuffer(a)}createBuffer(e,t,i){const r=e.byteLength!==void 0,s=new xN,a="DataBufferUniqueId="+s.uniqueId;return s.buffer=this.createRawBuffer(e,t,void 0,i?a+"-"+i:a),s.references=1,s.capacity=r?e.byteLength:e,s.engineId=this._engine.uniqueId,r&&this.setSubData(s,0,e),s}setRawData(e,t,i,r,s){this._device.queue.writeBuffer(e,t,i.buffer,r,s)}setSubData(e,t,i,r=0,s=0){const a=e.underlyingResource;s=s||i.byteLength,s=Math.min(s,e.capacity-t);let o=i.byteOffset+r,l=o+s;const c=s+3&-4;if(c!==s){const f=new Uint8Array(i.buffer.slice(o,l));i=new Uint8Array(c),i.set(f),r=0,o=0,l=c,s=c}const u=1024*1024*15;let h=0;for(;l-(o+h)>u;)this._device.queue.writeBuffer(a,t+h,i.buffer,o+h,u),h+=u;this._device.queue.writeBuffer(a,t+h,i.buffer,o+h,s-h)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const r=new Uint16Array(t);for(;e--;)i[e]=Qs(r[e]);return i}readDataFromBuffer(e,t,i,r,s,a,o=0,l=0,c=null,u=!0,h=!1){const f=o===1?2:o===2?1:0,d=this._engine.uniqueId;return new Promise((p,_)=>{e.mapAsync(1,l,t).then(()=>{const g=e.getMappedRange(l,t);let E=c;if(h)E===null?E=Qf(o,t,!0,g):E=Qf(o,E.buffer,void 0,g);else if(E===null)switch(f){case 0:E=new Uint8Array(t),E.set(new Uint8Array(g));break;case 1:E=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,g);break;case 2:E=new Float32Array(t/4),E.set(new Float32Array(g));break}else switch(f){case 0:E=new Uint8Array(E.buffer),E.set(new Uint8Array(g));break;case 1:E=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,g,c);break;case 2:E=new Float32Array(E.buffer),E.set(new Float32Array(g));break}if(s!==a){f===1&&!h&&(s*=2,a*=2);const v=new Uint8Array(E.buffer);let x=s,A=0;for(let T=1;T<r;++T){A=T*a;for(let C=0;C<s;++C)v[x++]=v[A++]}f!==0&&!h?E=new Float32Array(v.buffer,0,x/4):E=new Uint8Array(v.buffer,0,x)}e.unmap(),u&&this.releaseBuffer(e),p(E)},g=>{this._engine.isDisposed||this._engine.uniqueId!==d?p(new Uint8Array):_(g)})})}releaseBuffer(e){return Du._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}const CN=[0,0,3,7,0,2,6,2,4,1,5,3,1],AN=[0,64,32,96,16,80,48,112,8],IN=[0,128,128,0,0,0,0,128,0,0,0,0,128];class za{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){const t=e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;return CN[e.samplingMode]+AN[(e._comparisonFunction||514)-512+1]+IN[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,s,a,o;const l=e.useMipMaps;switch(e.samplingMode){case 11:i="linear",r="linear",s="nearest",l||(a=o=0);break;case 3:case 3:i="linear",r="linear",l?s="linear":(s="nearest",a=o=0);break;case 8:i="nearest",r="nearest",l?s="linear":(s="nearest",a=o=0);break;case 4:i="nearest",r="nearest",s="nearest",l||(a=o=0);break;case 5:i="nearest",r="linear",s="nearest",l||(a=o=0);break;case 6:i="nearest",r="linear",l?s="linear":(s="nearest",a=o=0);break;case 7:i="nearest",r="linear",s="nearest",a=o=0;break;case 1:case 1:i="nearest",r="nearest",s="nearest",a=o=0;break;case 9:i="linear",r="nearest",s="nearest",l||(a=o=0);break;case 10:i="linear",r="nearest",l?s="linear":(s="nearest",a=o=0);break;case 2:case 2:i="linear",r="linear",s="nearest",a=o=0;break;case 12:i="linear",r="nearest",s="nearest",a=o=0;break;default:i="nearest",r="nearest",s="nearest",a=o=0;break}return t>1&&(a!==0||o!==0)&&s!=="nearest"?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:s,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return"repeat";case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){const i=e.useMipMaps&&e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1,r=this._GetSamplerFilterDescriptor(e,i);return{label:t,...r,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?za.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1}}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal";default:return"less"}}getSampler(e,t=!1,i=0,r){if(this.disabled)return this._device.createSampler(za._GetSamplerDescriptor(e,r));t?i=0:i===0&&(i=za.GetSamplerHashCode(e));let s=t?void 0:this._samplers[i];return s||(s=this._device.createSampler(za._GetSamplerDescriptor(e,r)),t||(this._samplers[i]=s)),s}}var Ni;(function(n){n[n.StencilReadMask=0]="StencilReadMask",n[n.StencilWriteMask=1]="StencilWriteMask",n[n.DepthBias=2]="DepthBias",n[n.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",n[n.DepthStencilState=4]="DepthStencilState",n[n.MRTAttachments1=5]="MRTAttachments1",n[n.MRTAttachments2=6]="MRTAttachments2",n[n.RasterizationState=7]="RasterizationState",n[n.ColorStates=8]="ColorStates",n[n.ShaderStage=9]="ShaderStage",n[n.TextureStage=10]="TextureStage",n[n.VertexState=11]="VertexState",n[n.NumStates=12]="NumStates"})(Ni||(Ni={}));const Kc={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},Eo={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class _i{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,r=0){if(i=Ft.GetSample(i),this.disabled){const a=_i._GetTopology(e);return this._setVertexState(t),this._setTextureState(r),this._parameter.pipeline=this._createRenderPipeline(t,a,i),_i.NumCacheMiss++,_i._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(r),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,_i.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return _i.NumCacheHitWithHash++,this._parameter.pipeline;const s=_i._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,s,i),this._setRenderPipeline(this._parameter),_i.NumCacheMiss++,_i._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){_i.NumPipelineCreationLastFrame=_i._NumPipelineCreationCurrentFrame,_i._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,r,s,a,o,l){this._depthWriteEnabled=o,this._depthTestEnabled=a,this._depthCompare=(l??519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(r),this.setDepthBias(s)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[Ni.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[Ni.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=an[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)e[i]!==0&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.MRTAttachments1))}setMRT(e,t){if(t=t??e.length,t>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;const i=[0,0];let r=0,s=0,a=0;for(let o=0;o<t;++o){const l=e[o],c=l==null?void 0:l._hardwareTexture;this._mrtFormats[a]=(c==null?void 0:c.format)??this._webgpuColorFormat[0],i[r]+=an[this._mrtFormats[a]??""]<<s,s+=6,a++,s>=32&&(s=0,r++)}this._mrtFormats.length=a,(this._mrtAttachments1!==i[0]||this._mrtAttachments2!==i[1])&&(this._mrtAttachments1=i[0],this._mrtAttachments2=i[1],this._states[Ni.MRTAttachments1]=i[0],this._states[Ni.MRTAttachments2]=i[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=e===void 0?0:an[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=e===null?1:Eo[e]}setStencilPassOp(e){this._stencilFrontPassOp=e===null?2:Eo[e]}setStencilFailOp(e){this._stencilFrontFailOp=e===null?1:Eo[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[Ni.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[Ni.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,r,s,a,o){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=i===null?1:Eo[i],this._stencilFrontPassOp=r===null?2:Eo[r],this._stencilFrontFailOp=s===null?1:Eo[s],this.setStencilReadMask(a),this.setStencilWriteMask(o)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:return"triangle-list";case 2:return"point-list";case 1:return"line-list";case 3:return"point-list";case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return"triangle-list"}}static _GetAphaBlendOperation(e){switch(e){case 32774:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max";default:return"add"}}static _GetAphaBlendFactor(e){switch(e){case 0:return"zero";case 1:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:return"constant";case 32770:return"one-minus-constant";case 32771:return"constant";case 32772:return"one-minus-constant";case 35065:return"src1";case 35066:return"one-minus-src1";case 34185:return"src1-alpha";case 35067:return"one-minus-src1-alpha";default:return"one"}}static _GetCompareFunction(e){switch(e){case 0:return"never";case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(e){switch(e){case 0:return"zero";case 1:return"keep";case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(e){const t=e.type,i=e.normalized,r=e.getSize();switch(t){case b.BYTE:switch(r){case 1:case 2:return i?"snorm8x2":"sint8x2";case 3:case 4:return i?"snorm8x4":"sint8x4"}break;case b.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?"unorm8x2":"uint8x2";case 3:case 4:return i?"unorm8x4":"uint8x4"}break;case b.SHORT:switch(r){case 1:case 2:return i?"snorm16x2":"sint16x2";case 3:case 4:return i?"snorm16x4":"sint16x4"}break;case b.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?"unorm16x2":"uint16x2";case 3:case 4:return i?"unorm16x4":"uint16x4"}break;case b.INT:switch(r){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case b.UNSIGNED_INT:switch(r){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case b.FLOAT:switch(r){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}break}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${r}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:_i._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:_i._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:_i._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:_i._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:_i._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:_i._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[Ni.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.ShaderStage))}_setRasterizationState(e,t){const i=this._frontFace,r=this._cullEnabled?this._cullFace:0,s=this._clampDepth?1:0,a=this._alphaToCoverageEnabled?1:0,o=i-1+(r<<1)+(s<<3)+(a<<4)+(e<<5)+(t<<8);this._rasterizationState!==o&&(this._rasterizationState=o,this._states[Ni.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=((this._alphaBlendFuncParams[0]===null?2:Kc[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:Kc[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:Kc[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:Kc[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[Ni.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.ColorStates))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[Ni.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.DepthStencilState))}_setVertexState(e){var c;const t=this._statesLength;let i=Ni.VertexState;const r=e._pipelineContext,s=r.shaderProcessingContext.attributeNamesFromEffect,a=r.shaderProcessingContext.attributeLocationsFromEffect;let o,l=0;for(let u=0;u<s.length;u++){const h=a[u];let f=(this._overrideVertexBuffers&&this._overrideVertexBuffers[s[u]])??this._vertexBuffers[s[u]];f||(f=this._emptyVertexBuffer);const d=(c=f.effectiveBuffer)==null?void 0:c.underlyingResource;if(f._validOffsetRange===void 0){const _=f.effectiveByteOffset,g=f.getSize(!0),E=f.effectiveByteStride;f._validOffsetRange=_+g<=this._kMaxVertexBufferStride&&E===0||E!==0&&_+g<=E}o&&o===d&&f._validOffsetRange||(this.vertexBuffers[l++]=f,o=f._validOffsetRange?d:null);const p=f.hashCode+(h<<7);this._isDirty=this._isDirty||this._states[i]!==p,this._states[i++]=p}this.vertexBuffers.length=l,this._statesLength=i,this._isDirty=this._isDirty||i!==t,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[Ni.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Ni.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let r=0;r<i.length;r++){const s=i[r];t[r]=this._device.createBindGroupLayout({entries:s})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){const t=e.shaderProcessingContext,i=t.bindGroupLayoutEntries;let r=1;for(let a=0;a<i.length;a++){const o=i[a];for(let l=0;l<o.length;l++){const c=i[a][l];if(c.texture){const u=t.bindGroupLayoutEntryInfo[a][c.binding].name,h=t.availableTextures[u],f=h.autoBindSampler?t.availableSamplers[u+"Sampler"]:null;let d=h.sampleType,p=(f==null?void 0:f.type)??"filtering";if(this._textureState&r&&d!=="depth"&&(h.autoBindSampler&&(p="non-filtering"),d="unfilterable-float"),c.texture.sampleType=d,f){const _=t.bindGroupLayoutEntryInfo[f.binding.groupIndex][f.binding.bindingIndex].index;i[f.binding.groupIndex][_].sampler.type=p}r=r<<1}}}const s=[];for(let a=0;a<i.length;++a)s[a]=this._device.createBindGroupLayout({entries:i[a]});return e.bindGroupLayouts[this._textureState]=s,this._device.createPipelineLayout({bindGroupLayouts:s})}_getVertexInputDescriptor(e){var l;const t=[],i=e._pipelineContext,r=i.shaderProcessingContext.attributeNamesFromEffect,s=i.shaderProcessingContext.attributeLocationsFromEffect;let a,o;for(let c=0;c<r.length;c++){const u=s[c];let h=(this._overrideVertexBuffers&&this._overrideVertexBuffers[r[c]])??this._vertexBuffers[r[c]];h||(h=this._emptyVertexBuffer);let f=(l=h.effectiveBuffer)==null?void 0:l.underlyingResource,d=h.effectiveByteOffset;const p=!h._validOffsetRange;if(!(a&&o&&a===f)||p){const _={arrayStride:h.effectiveByteStride,stepMode:h.getIsInstanced()?"instance":"vertex",attributes:[]};t.push(_),o=_.attributes,p&&(d=0,f=null)}o.push({shaderLocation:u,offset:d,format:_i._GetVertexInputDescriptorFormat(h)}),a=f}return t}_createRenderPipeline(e,t,i){var d;const r=e._pipelineContext,s=this._getVertexInputDescriptor(e),a=this._createPipelineLayout(r),o=[],l=this._getAphaBlendState(),c=this._getColorBlendState();if(this._vertexBuffers&&FT(this._vertexBuffers,e),this._mrtAttachments1>0)for(let p=0;p<this._mrtFormats.length;++p){const _=this._mrtFormats[p];if(_){const g={format:_,writeMask:this._mrtEnabledMask&1<<p?this._writeMask:0};l&&c&&(g.blend={alpha:l,color:c}),o.push(g)}else o.push(null)}else if(this._webgpuColorFormat[0]){const p={format:this._webgpuColorFormat[0],writeMask:this._writeMask};l&&c&&(p.blend={alpha:l,color:c}),o.push(p)}else o.push(null);const u={compare:_i._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:_i._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:_i._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:_i._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let h;(t==="line-strip"||t==="triangle-strip")&&(h=!this._indexBuffer||this._indexBuffer.is32Bits?"uint32":"uint16");const f=this._webgpuDepthStencilFormat?Ft.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({label:`RenderPipeline_${((d=o[0])==null?void 0:d.format)??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${i}_textureState${this._textureState}`,layout:a,vertex:{module:r.stages.vertexStage.module,entryPoint:r.stages.vertexStage.entryPoint,buffers:s},primitive:{topology:t,stripIndexFormat:h,frontFace:this._frontFace===1?"ccw":"cw",cullMode:this._cullEnabled?this._cullFace===2?"front":"back":"none"},fragment:r.stages.fragmentStage?{module:r.stages.fragmentStage.module,entryPoint:r.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:i},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?_i._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&f?u:void 0,stencilBack:this._stencilEnabled&&f?u:void 0,stencilReadMask:this._stencilEnabled&&f?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&f?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}_i.NumCacheHitWithoutHash=0;_i.NumCacheHitWithHash=0;_i.NumCacheMiss=0;_i.NumPipelineCreationLastFrame=0;_i._NumPipelineCreationCurrentFrame=0;class dd{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const r=this.values[i],[s,a]=r.count();e+=s,t+=a,e++}return[e,t]}}class Us extends _i{static GetNodeCounts(){const e=Us._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){const s=i.slice();s.length=r,t.push(s)}for(const s in e.values){const a=e.values[s];i[r]=parseInt(s),Us._GetPipelines(a,t,i,r+1)}}static GetPipelines(){const e=[];return Us._GetPipelines(Us._Cache,e,[],0),e}static ResetCache(){Us._Cache=new dd}reset(){this._nodeStack=[],this._nodeStack[0]=Us._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let r=t.values[this._states[i]];r||(r=new dd,t.values[this._states[i]]=r),t=r,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}Us._Cache=new dd;class yN extends kS{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var t;const e=(t=this.stencilMaterial)==null?void 0:t.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class bN extends US{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class kT{static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=Yt._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class ah{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.uniqueId=ah._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?za.GetSamplerHashCode(t):0;const s=r!==i.hashCode;s&&this.updateId++,this.isDirty||(this.isDirty=s)}setTexture(e,t){var a;let i=this.textures[e],r=-1;i?r=((a=i.texture)==null?void 0:a.uniqueId)??-1:this.textures[e]=i={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},i.isExternalTexture&&this._numExternalTextures--,i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(i.isFloatOrDepthTexture=t.type===1||t.format>=13&&t.format<=18,i.isExternalTexture=kT.IsExternalTexture(t),i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,i.isExternalTexture&&this._numExternalTextures++):(i.isFloatOrDepthTexture=!1,i.isExternalTexture=!1),i.texture=t;const s=r!==((t==null?void 0:t.uniqueId)??-1);s&&this.updateId++,this.isDirty||(this.isDirty=s)}}ah._Counter=0;class oh{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,Kt.CopyDst|Kt.Indirect|Kt.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}constructor(e){this._bufferManager=e,this.uniqueId=oh._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){var i;this._isDirty||(this._isDirty=(t==null?void 0:t.uniqueId)!==((i=this.buffers[e])==null?void 0:i.uniqueId)),this.buffers[e]=t}setIndirectData(e,t,i){t===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}oh._Counter=0;const RN=1<<20,PN=2**35;class Ml{constructor(){this.values={}}}class Zt{static get Statistics(){return{totalCreated:Zt.NumBindGroupsCreatedTotal,lastFrameCreated:Zt.NumBindGroupsCreatedLastFrame,lookupLastFrame:Zt.NumBindGroupsLookupLastFrame,noLookupLastFrame:Zt.NumBindGroupsNoLookupLastFrame}}static ResetCache(){Zt._Cache=new Ml,Zt.NumBindGroupsCreatedTotal=0,Zt.NumBindGroupsCreatedLastFrame=0,Zt.NumBindGroupsLookupLastFrame=0,Zt.NumBindGroupsNoLookupLastFrame=0,Zt._NumBindGroupsCreatedCurrentFrame=0,Zt._NumBindGroupsLookupCurrentFrame=0,Zt._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){Zt.NumBindGroupsCreatedLastFrame=Zt._NumBindGroupsCreatedCurrentFrame,Zt.NumBindGroupsLookupLastFrame=Zt._NumBindGroupsLookupCurrentFrame,Zt.NumBindGroupsNoLookupLastFrame=Zt._NumBindGroupsNoLookupCurrentFrame,Zt._NumBindGroupsCreatedCurrentFrame=0,Zt._NumBindGroupsLookupCurrentFrame=0,Zt._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var l,c,u,h,f,d;let r,s=Zt._Cache;const a=this.disabled||i.forceBindGroupCreation;if(!a){if(!t.isDirty(i.updateId)&&!i.isDirty)return Zt._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const p of e.shaderProcessingContext.bufferNames){const _=(((l=t.buffers[p])==null?void 0:l.uniqueId)??0)+RN;let g=s.values[_];g||(g=new Ml,s.values[_]=g),s=g}for(const p of e.shaderProcessingContext.samplerNames){const _=((c=i.samplers[p])==null?void 0:c.hashCode)??0;let g=s.values[_];g||(g=new Ml,s.values[_]=g),s=g}for(const p of e.shaderProcessingContext.textureNames){const _=(((h=(u=i.textures[p])==null?void 0:u.texture)==null?void 0:h.uniqueId)??0)+PN;let g=s.values[_];g||(g=new Ml,s.values[_]=g),s=g}r=s.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,r)return t.bindGroups=r,Zt._NumBindGroupsLookupCurrentFrame++,r;r=[],t.bindGroups=r,a||(s.bindGroups=r),Zt.NumBindGroupsCreatedTotal++,Zt._NumBindGroupsCreatedCurrentFrame++;const o=e.bindGroupLayouts[i.textureState];for(let p=0;p<e.shaderProcessingContext.bindGroupLayoutEntries.length;p++){const _=e.shaderProcessingContext.bindGroupLayoutEntries[p],g=e.shaderProcessingContext.bindGroupEntries[p];for(let v=0;v<_.length;v++){const x=e.shaderProcessingContext.bindGroupLayoutEntries[p][v],A=e.shaderProcessingContext.bindGroupLayoutEntryInfo[p][x.binding],T=A.nameInArrayOfTexture??A.name;if(x.sampler){const C=i.samplers[T];if(C){const y=C.sampler;if(!y){this._engine.dbgSanityChecks&&w.Error(`Trying to bind a null sampler! entry=${JSON.stringify(x)}, name=${T}, bindingInfo=${JSON.stringify(C,(P,D)=>P==="texture"?"<no dump>":D)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}g[v].resource=this._cacheSampler.getSampler(y,!1,C.hashCode,y.label)}else w.Error(`Sampler "${T}" could not be bound. entry=${JSON.stringify(x)}, materialContext=${JSON.stringify(i,(y,P)=>y==="texture"||y==="sampler"?"<no dump>":P)}`,50)}else if(x.texture||x.storageTexture){const C=i.textures[T];if(C){if(this._engine.dbgSanityChecks&&C.texture===null){w.Error(`Trying to bind a null texture! entry=${JSON.stringify(x)}, bindingInfo=${JSON.stringify(C,(P,D)=>P==="texture"?"<no dump>":D)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const y=C.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!y||x.texture&&!y.view||x.storageTexture&&!y.viewForWriting)){w.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(x)}, name=${T}, bindingInfo=${JSON.stringify(C,(P,D)=>P==="texture"?"<no dump>":D)}, isReady=${(f=C.texture)==null?void 0:f.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}g[v].resource=x.storageTexture?y.viewForWriting:y.view}else w.Error(`Texture "${T}" could not be bound. entry=${JSON.stringify(x)}, materialContext=${JSON.stringify(i,(y,P)=>y==="texture"||y==="sampler"?"<no dump>":P)}`,50)}else if(x.externalTexture){const C=i.textures[T];if(C){if(this._engine.dbgSanityChecks&&C.texture===null){w.Error(`Trying to bind a null external texture! entry=${JSON.stringify(x)}, name=${T}, bindingInfo=${JSON.stringify(C,(P,D)=>P==="texture"?"<no dump>":D)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const y=C.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!y){w.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(x)}, name=${T}, bindingInfo=${JSON.stringify(C,(P,D)=>P==="texture"?"<no dump>":D)}, isReady=${(d=C.texture)==null?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}g[v].resource=this._device.importExternalTexture({source:y})}else w.Error(`Texture "${T}" could not be bound. entry=${JSON.stringify(x)}, materialContext=${JSON.stringify(i,(y,P)=>y==="texture"||y==="sampler"?"<no dump>":P)}`,50)}else if(x.buffer){const C=t.buffers[T];if(C){const y=C.underlyingResource;g[v].resource.buffer=y,g[v].resource.size=C.capacity}else w.Error(`Can't find buffer "${T}". entry=${JSON.stringify(x)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const E=o[p];r[p]=this._device.createBindGroup({layout:E,entries:g})}return r}}Zt.NumBindGroupsCreatedTotal=0;Zt.NumBindGroupsCreatedLastFrame=0;Zt.NumBindGroupsLookupLastFrame=0;Zt.NumBindGroupsNoLookupLastFrame=0;Zt._Cache=new Ml;Zt._NumBindGroupsCreatedCurrentFrame=0;Zt._NumBindGroupsLookupCurrentFrame=0;Zt._NumBindGroupsNoLookupCurrentFrame=0;const MN="clearQuadVertexShader",DN=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;V.ShadersStoreWGSL[MN]=DN;const ON="clearQuadPixelShader",NN=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;V.ShadersStoreWGSL[ON]=NN;class LN{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new Us(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,i,r,s=1){let a,o=null,l;const c=!!this._engine._currentRenderTarget;if(e)a=e;else{let g=0;this._keyTemp.length=0;for(let v=0;v<this._cacheRenderPipeline.colorFormats.length;++v)this._keyTemp[g++]=an[this._cacheRenderPipeline.colorFormats[v]??""];const E=an[this._depthTextureFormat??0];if(this._keyTemp[g]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(s>1?2**36:0)+E*2**37,l=this._keyTemp.join("_"),o=this._bundleCache[l],o)return o;a=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:Ft.GetSample(s)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&Ft.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const u=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,s),h=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),h.uniformBuffer.update();const f=c?this._engine._ubInvertY:this._engine._ubDontInvertY,d=h.uniformBuffer.getBuffer(),p=d.uniqueId+"-"+f.uniqueId;let _=this._bindGroups[p];if(!_){const g=h.bindGroupLayouts[0];_=this._bindGroups[p]=[],_.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${p}`,layout:g[0],entries:[]})),_s._SimplifiedKnownBindings||_.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${p}`,layout:g[1],entries:[]})),_.push(this._device.createBindGroup({label:`clearQuadBindGroup${_s._SimplifiedKnownBindings?1:2}-${p}`,layout:g[_s._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:f.underlyingResource,size:f.capacity}},{binding:1,resource:{buffer:d.underlyingResource,size:d.capacity}}]}))}a.setPipeline(u);for(let g=0;g<_.length;++g)a.setBindGroup(g,_[g]);return a.draw(4,1,0,0),e||(o=a.finish(),this._bundleCache[l]=o),o}}class Ep{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new Ep(this.x,this.y,this.w,this.h)}}class vp{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new vp(this.x,this.y,this.w,this.h)}}class Ou{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new Ou(this.ref)}}class Sp{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new Sp(this.color)}}class Tp{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new Tp(this.query)}}class xp{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new xp}}class Cp{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new Cp;return e.bundles=this.bundles,e}}class Ap{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const t=new Cp;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:Ft.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new Ap(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class GT{get querySet(){return this._querySet}constructor(e,t,i,r,s,a=!0,o){this._dstBuffers=[],this._engine=e,this._device=r,this._bufferManager=s,this._count=t,this._canUseMultipleBuffers=a,this._querySet=r.createQuerySet({label:o??"QuerySet",type:i,count:t}),this._queryBuffer=s.createRawBuffer(8*t,Kt.QueryResolve|Kt.CopySrc,void 0,"QueryBuffer"),a||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,Kt.MapRead|Kt.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;const i=this._device.createCommandEncoder();let r;return this._dstBuffers.length===0?r=this._bufferManager.createRawBuffer(8*this._count,Kt.MapRead|Kt.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(r=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,r,0,8*t),this._device.queue.submit([i.finish()]),r}async readValues(e=0,t=1){const i=this._getBuffer(e,t);if(i===null)return null;const r=this._engine.uniqueId;return i.mapAsync(1).then(()=>{const s=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,s},s=>{if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw s})}async readValue(e=0){const t=this._getBuffer(e,1);if(t===null)return null;const i=this._engine.uniqueId;return t.mapAsync(1).then(()=>{const r=new BigUint64Array(t.getMappedRange()),s=Number(r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,s},r=>{if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r})}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(t===null)return null;const i=this._engine.uniqueId;return t.mapAsync(1).then(()=>{const r=new BigUint64Array(t.getMappedRange()),s=Number(r[1]-r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,s},r=>{if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r})}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class FN{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new ps,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new wN(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(t){this._enabled=!1,w.Error(`Could not create a WebGPUDurationMeasure!
Error: `+t.message+`
Make sure timestamp query is supported and enabled in your browser.`);return}else this._measureDuration.dispose()}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;const i=this._engine.frameId;this._measureDuration.stopPass(e).then(r=>{t._addDuration(i,r!==null&&r>0?r:0)})}dispose(){var e;(e=this._measureDuration)==null||e.dispose()}}class wN{constructor(e,t,i,r=2,s){this._count=r,this._querySet=new GT(e,r,"timestamp",t,i,!0,s)}start(e){var t;(t=e.writeTimestamp)==null||t.call(e,this._querySet.querySet,0)}async stop(e){var t;return(t=e.writeTimestamp)==null||t.call(e,this._querySet.querySet,1),e.writeTimestamp?this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}class BN{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;const t=this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet!==void 0;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,s=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=s,this._allocateNewIndices(r)}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t;return Number(((t=this._lastBuffer)==null?void 0:t[e])??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new GT(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){var e;(e=this._querySet)==null||e.dispose(),this._availableIndices.length=0}}class os{async initTwgsl(e){if(!os._Twgsl)return e=e||{},e={...os._TWgslDefaultOptions,...e},e.twgsl?(os._Twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&await J.LoadBabylonScriptAsync(e.jsPath),self.twgsl?(os._Twgsl=await self.twgsl(J.GetBabylonScriptURL(e.wasmPath)),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(e,t=!1){const i=os._Twgsl.convertSpirV2WGSL(e,os.DisableUniformityAnalysis||t);return os.ShowWGSLShaderCode&&(w.Log(i),w.Log("***********************************************")),os.DisableUniformityAnalysis||t?`diagnostic(off, derivative_uniformity);
`+i:i}}os._TWgslDefaultOptions={jsPath:`${J._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${J._DefaultCdnUrl}/twgsl/twgsl.wasm`};os.ShowWGSLShaderCode=!1;os.DisableUniformityAnalysis=!1;os._Twgsl=null;class VN{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t;if(this._record)t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset();else{if(this._playBundleListIndex>=this._allBundleLists.length)throw new Error(`Invalid playBundleListIndex! Your snapshot is no longer valid for the current frame, you should recreate a new one. playBundleListIndex=${this._playBundleListIndex}, allBundleLists.length=${this._allBundleLists.length}}`);t=this._allBundleLists[this._playBundleListIndex++]}return t.run(e),this._mode===1&&this._engine._reportDrawCall(t.numDrawCalls),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved),this._playBundleListIndex=0}reset(){this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}}class UN extends kT{constructor(e){super(e)}}Wi.prototype.createRawTexture=function(n,e,t,i,r,s,a,o=null,l=0,c=0,u=!1){const h=new Yt(this,3);return h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=r,h.samplingMode=a,h.invertY=s,h._compression=o,h.type=l,h._creationFlags=c,h._useSRGBBuffer=u,this._doNotHandleContextLost||(h._bufferView=n),this._textureHelper.createGPUTextureForInternalTexture(h,e,t,void 0,c),this.updateRawTexture(h,n,i,s,o,l,u),this._internalTexturesCache.push(h),h};Wi.prototype.updateRawTexture=function(n,e,t,i,r=null,s=0,a=!1){if(n){if(this._doNotHandleContextLost||(n._bufferView=e,n.invertY=i,n._compression=r,n._useSRGBBuffer=a),e){const o=n._hardwareTexture;t===4&&(e=Tc(e,n.width,n.height,s));const c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,n,n.width,n.height,n.depth,o.format,0,0,i,!1,0,0),n.generateMipMaps&&this._generateMipmaps(n,this._uploadEncoder)}n.isReady=!0}};Wi.prototype.createRawCubeTexture=function(n,e,t,i,r,s,a,o=null){const l=new Yt(this,8);if(i===1&&!this._caps.textureFloatLinearFiltering?(r=!1,a=1,w.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,a=1,w.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(r=!1,w.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(r=!1,w.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),l.isCube=!0,l._originalFormat=t,l.format=t===4?5:t,l.type=i,l.generateMipMaps=r,l.width=e,l.height=e,l.samplingMode=a,this._doNotHandleContextLost||(l._bufferViewArray=n),l.invertY=s,l._compression=o,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),t===4){const c=l._hardwareTexture;c._originalFormatIsRGB=!0}return n&&this.updateRawCubeTexture(l,n,t,i,s,o),l.isReady=!0,l};Wi.prototype.updateRawCubeTexture=function(n,e,t,i,r,s=null){n._bufferViewArray=e,n.invertY=r,n._compression=s;const a=n._hardwareTexture,o=a._originalFormatIsRGB,l=[0,2,4,1,3,5],c=[];for(let u=0;u<e.length;++u){let h=e[l[u]];o&&(h=Tc(h,n.width,n.height,i)),c.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(c,a.underlyingResource,n.width,n.height,a.format,r,!1,0,0),n.generateMipMaps&&this._generateMipmaps(n,this._uploadEncoder),n.isReady=!0};Wi.prototype.createRawCubeTextureFromUrl=function(n,e,t,i,r,s,a,o,l=null,c=null,u=3,h=!1){const f=this.createRawCubeTexture(null,t,i,r,!s,h,u,null);e==null||e.addPendingData(f),f.url=n,f.isReady=!1,this._internalTexturesCache.push(f);const d=(_,g)=>{e==null||e.removePendingData(f),c&&_&&c(_.status+" "+_.statusText,g)},p=_=>{const g=f.width,E=a(_);if(E){if(o){const v=i===4,x=o(E),A=f._hardwareTexture,T=[0,1,2,3,4,5];for(let C=0;C<x.length;C++){const y=g>>C,P=[];for(let D=0;D<6;D++){let F=x[C][T[D]];v&&(F=Tc(F,y,y,r)),P.push(new Uint8Array(F.buffer,F.byteOffset,F.byteLength))}this._textureHelper.updateCubeTextures(P,A.underlyingResource,y,y,A.format,h,!1,0,0)}}else this.updateRawCubeTexture(f,E,i,r,h);f.isReady=!0,e==null||e.removePendingData(f),l&&l()}};return this._loadFile(n,_=>{p(_)},void 0,e==null?void 0:e.offlineProvider,!0,d),f};Wi.prototype.createRawTexture3D=function(n,e,t,i,r,s,a,o,l=null,c=0,u=0){const f=new Yt(this,10);return f.baseWidth=e,f.baseHeight=t,f.baseDepth=i,f.width=e,f.height=t,f.depth=i,f.format=r,f.type=c,f.generateMipMaps=s,f.samplingMode=o,f.is3D=!0,f._creationFlags=u,this._doNotHandleContextLost||(f._bufferView=n),this._textureHelper.createGPUTextureForInternalTexture(f,e,t,void 0,u),this.updateRawTexture3D(f,n,r,a,l,c),this._internalTexturesCache.push(f),f};Wi.prototype.updateRawTexture3D=function(n,e,t,i,r=null,s=0){if(this._doNotHandleContextLost||(n._bufferView=e,n.format=t,n.invertY=i,n._compression=r),e){const a=n._hardwareTexture;t===4&&(e=Tc(e,n.width,n.height,s));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,n,n.width,n.height,n.depth,a.format,0,0,i,!1,0,0),n.generateMipMaps&&this._generateMipmaps(n,this._uploadEncoder)}n.isReady=!0};Wi.prototype.createRawTexture2DArray=function(n,e,t,i,r,s,a,o,l=null,c=0,u=0){const f=new Yt(this,11);return f.baseWidth=e,f.baseHeight=t,f.baseDepth=i,f.width=e,f.height=t,f.depth=i,f.format=r,f.type=c,f.generateMipMaps=s,f.samplingMode=o,f.is2DArray=!0,f._creationFlags=u,this._doNotHandleContextLost||(f._bufferView=n),this._textureHelper.createGPUTextureForInternalTexture(f,e,t,i,u),this.updateRawTexture2DArray(f,n,r,a,l,c),this._internalTexturesCache.push(f),f};Wi.prototype.updateRawTexture2DArray=function(n,e,t,i,r=null,s=0){if(this._doNotHandleContextLost||(n._bufferView=e,n.format=t,n.invertY=i,n._compression=r),e){const a=n._hardwareTexture;t===4&&(e=Tc(e,n.width,n.height,s));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,n,n.width,n.height,n.depth,a.format,0,0,i,!1,0,0),n.generateMipMaps&&this._generateMipmaps(n,this._uploadEncoder)}n.isReady=!0};function Tc(n,e,t,i){let r,s=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),s=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){const l=(o*e+a)*3,c=(o*e+a)*4;r[c+0]=n[l+0],r[c+1]=n[l+1],r[c+2]=n[l+2],r[c+3]=s}return r}Wi.prototype._readTexturePixels=function(n,e,t,i=-1,r=0,s=null,a=!0,o=!1,l=0,c=0){const u=n._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(u.underlyingResource,l,c,e,t,u.format,i,r,s,o)};Wi.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};Wi.prototype._createDepthStencilCubeTexture=function(n,e){const t=new Yt(this,e.generateStencil?12:14);t.isCube=!0,t.label=e.label;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e};t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,n,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t);const r=t._hardwareTexture;return t.type=Ft.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(t),t};Wi.prototype.createCubeTexture=function(n,e,t,i,r=null,s=null,a,o=null,l=!1,c=0,u=0,h=null,f,d=!1,p=null){return this.createCubeTextureBase(n,e,t,!!i,r,s,a,o,l,c,u,h,null,(_,g)=>{const E=g,v=E[0].width,x=v;this._setCubeMapTextureParams(_,!i),_.format=a??-1;const A=this._textureHelper.createGPUTextureForInternalTexture(_,v,x);this._textureHelper.updateCubeTextures(E,A.underlyingResource,v,x,A.format,!1,!1,0,0),i||this._generateMipmaps(_,this._uploadEncoder),_.isReady=!0,_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),r&&r()},!!d,p)};Wi.prototype._setCubeMapTextureParams=function(n,e,t){n.samplingMode=e?3:2,n._cachedWrapU=0,n._cachedWrapV=0,t&&(n._maxLodLevel=t)};Wi.prototype.generateMipMapsForCubemap=function(n){var e;n.generateMipMaps&&((e=n._hardwareTexture)!=null&&e.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(n),this._generateMipmaps(n))};class kN extends sp{constructor(e,t,i,r,s){super(e,t,i,r,s),r.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new gp)}}Wi.prototype._createHardwareRenderTargetWrapper=function(n,e,t){const i=new kN(n,e,t,this);return this._renderTargetWrapperCache.push(i),i};Wi.prototype.createRenderTargetTexture=function(n,e){var s;const t=this._createHardwareRenderTargetWrapper(!1,!1,n),i={};e!==void 0&&typeof e=="object"?(i.generateMipMaps=e.generateMipMaps,i.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,i.generateStencilBuffer=i.generateDepthBuffer&&e.generateStencilBuffer,i.samplingMode=e.samplingMode===void 0?3:e.samplingMode,i.creationFlags=e.creationFlags??0,i.noColorAttachment=!!e.noColorAttachment,i.colorAttachment=e.colorAttachment,i.samples=e.samples,i.label=e.label,i.format=e.format,i.type=e.type):(i.generateMipMaps=e,i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.samplingMode=3,i.creationFlags=0,i.noColorAttachment=!1);const r=i.colorAttachment||(i.noColorAttachment?null:this._createInternalTexture(n,i,!0,5));return t.label=i.label??"RenderTargetWrapper",t._samples=((s=i.colorAttachment)==null?void 0:s.samples)??i.samples??1,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,!1,t._generateStencilBuffer,t.samples,i.generateStencilBuffer?13:14,i.label?i.label+"-DepthStencil":void 0),r&&!i.colorAttachment&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r,void 0,void 0,void 0,i.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1)),t};Wi.prototype._createDepthStencilTexture=function(n,e,t){const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e},r=i.depthTextureFormat===17||i.depthTextureFormat===13||i.depthTextureFormat===18;t._depthStencilTextureWithStencil=r;const s=new Yt(this,r?12:14);s.label=e.label,s.format=i.depthTextureFormat,this._setupDepthStencilTexture(s,n,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(s);const a=s._hardwareTexture;return s.type=Ft.GetTextureTypeFromFormat(a.format),this._internalTexturesCache.push(s),s};Wi.prototype._setupDepthStencilTexture=function(n,e,t,i,r=1){const s=e.width??e,a=e.height??e,o=e.layers||0,l=e.depth||0;n.baseWidth=s,n.baseHeight=a,n.width=s,n.height=a,n.is2DArray=o>0,n.is3D=l>0,n.depth=o||l,n.isReady=!0,n.samples=r,n.generateMipMaps=!1,n.samplingMode=t?2:1,n.type=1,n._comparisonFunction=i,n._cachedWrapU=0,n._cachedWrapV=0};Wi.prototype.updateRenderTargetTextureSampleCount=function(n,e){return!n||!n.texture||n.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(n.texture,e),n._depthStencilTexture&&(this._textureHelper.createMSAATexture(n._depthStencilTexture,e),n._depthStencilTexture.samples=e),n._samples=e,n.texture.samples=e),e};Wi.prototype.setDepthStencilTexture=function(n,e,t,i){!t||!t.depthStencilTexture?this._setTexture(n,null,void 0,void 0,i):this._setTexture(n,t,!1,!0,i)};Wi.prototype.createRenderTargetCubeTexture=function(n,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,n),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t.label=i.label??"RenderTargetWrapper",t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;const r=new Yt(this,5);return r.width=n,r.height=n,r.depth=0,r.isReady=!0,r.isCube=!0,r.samples=i.samples,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1),t};const iE={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},rE={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},GN=new Be;class Vt extends Wi{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return vT(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return w.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const i=new Vt(e,t);return new Promise(r=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>r(i))})}constructor(e,t={}){if(super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=!1,this._adapterInfo={vendor:"",architecture:"",device:"",description:""},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._debugStackRenderPass=[],this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new $S,this._name="WebGPU",this._drawCalls=new ps,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,w.Log(`Babylon.js v${q.Version} - ${this.description} engine`),!navigator.gpu){w.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new WO,this._shaderProcessorWGSL=new uN}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise(e=>{var t;this._initGlslang(this._glslangOptions??((t=this._options)==null?void 0:t.glslangOptions)).then(i=>{var r;this._glslang=i,this._tintWASM=new os,this._tintWASM.initTwgsl(this._twgslOptions??((r=this._options)==null?void 0:r.twgslOptions)).then(()=>{this._glslangAndTintAreFullyLoaded=!0,e()})})})),this._workingGlslangAndTintPromise}initAsync(e,t){return this.uniqueId=Vt._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,navigator.gpu.requestAdapter(this._options).then(i=>{var r;if(i){this._adapter=i,this._adapterSupportedExtensions=[],(r=this._adapter.features)==null||r.forEach(o=>this._adapterSupportedExtensions.push(o)),this._adapterSupportedLimits=this._adapter.limits,this._adapterInfo=this._adapter.info;const s=this._options.deviceDescriptor??{},a=(s==null?void 0:s.requiredFeatures)??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(a){const o=a,l=[];for(const c of o)this._adapterSupportedExtensions.indexOf(c)!==-1&&l.push(c);s.requiredFeatures=l}if(this._options.setMaximumLimits&&!s.requiredLimits){s.requiredLimits={};for(const o in this._adapterSupportedLimits)o==="minSubgroupSize"||o==="maxSubgroupSize"||(s.requiredLimits[o]=this._adapterSupportedLimits[o])}return s.label=`BabylonWebGPUDevice${this.uniqueId}`,this._adapter.requestDevice(s)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(i=>{var s,a;this._device=i,this._deviceEnabledExtensions=[],(s=this._device.features)==null||s.forEach(o=>this._deviceEnabledExtensions.push(o)),this._deviceLimits=i.limits;let r=-1;this._device.addEventListener("uncapturederror",o=>{++r<this.numMaxUncapturedErrors?w.Warn(`WebGPU uncaptured error (${r+1}): ${o.error} - ${o.error.message}`):r++===this.numMaxUncapturedErrors&&w.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||(a=this._device.lost)==null||a.then(o=>{this._isDisposed||(this._contextWasLost=!0,w.Warn("WebGPU context lost. "+o),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(async()=>{var p,_;const l=this.snapshotRenderingMode,c=this.snapshotRendering,u=this.disableCacheSamplers,h=this.disableCacheRenderPipelines,f=this.disableCacheBindGroups,d=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??((p=this._options)==null?void 0:p.glslangOptions),this._twgslOptions??((_=this._options)==null?void 0:_.twgslOptions)),this.snapshotRenderingMode=l,this.snapshotRendering=c,this.disableCacheSamplers=u,this.disableCacheRenderPipelines=h,this.disableCacheBindGroups=f,this.enableGPUTimingMeasurements=d,this._currentRenderPass=null}))})}).then(()=>{this._initializeLimits(),this._bufferManager=new Du(this,this._device),this._textureHelper=new TN(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new za(this._device),this._cacheBindGroups=new Zt(this._device,this._cacheSampler,this),this._timestampQuery=new FN(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new BN(this,this._device,this._bufferManager):void 0,this._bundleList=new Ap(this._device),this._snapshotRendering=new VN(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),Kt.Uniform|Kt.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),Kt.Uniform|Kt.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,w.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new b(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._cacheRenderPipeline=new Us(this._device,this._emptyVertexBuffer),this._depthCullingState=new bN(this._cacheRenderPipeline),this._stencilStateComposer=new yN(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new LN(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(i=>{throw w.Error("A fatal error occurred during WebGPU creation/initialization."),i})}_initGlslang(e){return e=e||{},e={...Vt._GlslangDefaultOptions,...e},e.glslang?Promise.resolve(e.glslang):self.glslang?self.glslang(e.wasmPath):e.jsPath&&e.wasmPath?J.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(J.GetBabylonScriptURL(e.wasmPath))):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage*2,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this._deviceEnabledExtensions.indexOf("timestamp-query")!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportIBLShadows:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new hu],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};const e=new Float32Array([this.getRenderHeight(!0)]);this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e);let t;if(this._options.antialias){const s={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(s),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new Be(0,0,0,1),loadOp:"clear",storeOp:"store"}]}else t=[{view:void 0,clearValue:new Be(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);const i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);const r={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:r}}_sharedInit(e){super._sharedInit(e),gT(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"})}resizeImageBitmap(e,t,i){return TT(this,e,t,i)}_createImageBitmapFromSource(e,t){return ST(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&xT(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&CT()}enterPointerlock(){this._renderingCanvas&&fp(this._renderingCanvas)}exitPointerlock(){AT()}_rebuildBuffers(){super._rebuildBuffers();for(const e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){Us.ResetCache(),Zt.ResetCache();const t=r=>{var s;for(const a of r){for(const o of a.meshes){const l=o.subMeshes;if(l)for(const c of l)c._drawWrappers=[]}for(const o of a.materials)(s=o._materialContext)==null||s.reset()}};t(this.scenes),t(this._virtualScenes);const i=[];for(const r of this._uniformBuffers)r.name.indexOf("leftOver")<0&&i.push(r);this._uniformBuffers=i,super._restoreEngineAfterContextLost(e)}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===1?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new _s(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){const e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,r=this._viewportCached.w,s=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==r;return s&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),s}_applyViewport(e){const t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),r=Math.floor(this._viewportCached.w);let s=Math.floor(this._viewportCached.y);this._currentRenderTarget||(s=this.getRenderHeight(!0)-s-r),e?e.addItem(new Ep(t,s,i,r)):this._getCurrentRenderPass().setViewport(t,s,i,r,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_mustUpdateScissor(){const e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,r=this._scissorCached.w,s=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==r;return s&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),s}_applyScissor(e){const t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new vp(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){const e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new Ou(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){const e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new Sp(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,r=!1){e&&e.a===void 0&&(e.a=1);const s=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",s])),this._currentRenderTarget?s?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):((!this._currentRenderPass||!s)&&this._startMainRenderPass(!s,t?e:null,i,r),s&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){const r=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?r.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new Ou(this._clearStencilValue));const s=this._clearQuad.clear(r,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(s),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let r;return e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.createBuffer(r,Kt.Vertex|Kt.CopyDst,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let r=!0,s;e instanceof Uint32Array||e instanceof Int32Array?s=e:e instanceof Uint16Array?(s=e,r=!1):e.length>65535?s=new Uint32Array(e):(s=new Uint16Array(e),r=!1);const a=this._bufferManager.createBuffer(s,Kt.Index|Kt.CopyDst,i);return a.is32Bits=r,a}updateDynamicIndexBuffer(e,t,i=0){const r=e;let s;e.is32Bits?s=t instanceof Uint32Array?t:new Uint32Array(t):s=t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(r,i,s)}updateDynamicVertexBuffer(e,t,i,r){const s=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(s,i,a,0,r)}_createBuffer(e,t,i){let r;e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e;let s=0;return t&1&&(s|=Kt.CopySrc),t&2&&(s|=Kt.CopyDst),t&4&&(s|=Kt.Uniform),t&8&&(s|=Kt.Vertex),t&16&&(s|=Kt.Index),t&32&&(s|=Kt.Storage),t&64&&(s|=Kt.Indirect),this._bufferManager.createBuffer(r,s,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,i,r){this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(e,t,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let i;return e instanceof Array?i=new Float32Array(e):i=e,this._bufferManager.createBuffer(i,Kt.Uniform|Kt.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,i,r){i===void 0&&(i=0);const s=e;let a;r===void 0?(t instanceof Float32Array?a=t:a=new Float32Array(t),r=a.byteLength):t instanceof Float32Array?a=t:a=new Float32Array(t),this._bufferManager.setSubData(s,i,a,0,r)}bindUniformBufferBase(e,t,i){this._currentDrawContext.setBuffer(i,e)}bindUniformBlock(){}createEffect(e,t,i,r,s,a,o,l,c,u=0,h){const f=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines();let _=s??t.defines??"";p&&(_+=`
`+p);const g=f+"+"+d+"@"+_;if(this._compiledEffects[g]){const v=this._compiledEffects[g];return o&&v.isReady()&&o(v),v._refCount++,v}const E=new ei(e,t,i,r,this,s,a,o,l,c,g,t.shaderLanguage??u,t.extraInitializationsAsync??h);return this._compiledEffects[g]=E,E}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i,r,s){return this._tintWASM&&i===0&&(e=this._tintWASM.convertSpirV2WGSL(e,r),t=this._tintWASM.convertSpirV2WGSL(t,s)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){const r=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,s=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=i===0?this._compileRawShaderToSpirV(e,"vertex"):e,o=i===0?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(a,o,i,r,s)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);const s=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,o=`#version 450
`,l=r===0?this._compileShaderToSpirV(e,"vertex",i,o):this._getWGSLShader(e,"vertex",i),c=r===0?this._compileShaderToSpirV(t,"fragment",i,o):this._getWGSLShader(t,"fragment",i),u=this._createPipelineStageDescriptor(l,c,r,s,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),u}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){const t=new Ka(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new kO(e,this)}createMaterialContext(){return new ah}createDrawContext(){return new oh(this._bufferManager)}async _preparePipelineContext(e,t,i,r,s,a,o,l,c,u,h){const f=e,d=f.shaderProcessingContext.shaderLanguage;d===0&&!this._glslangAndTintAreFullyLoaded&&await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(w.Log(["defines",l]),w.Log(t),w.Log(i),w.Log("***********************************************")),f.sources={fragment:i,vertex:t,rawVertex:s,rawFragment:a},r?f.stages=this._compileRawPipelineStageDescriptor(t,i,d):f.stages=this._compilePipelineStageDescriptor(t,i,l,d),h()}getAttributes(e,t){const i=new Array(t.length),r=e;for(let s=0;s<t.length;s++){const a=t[s],o=r.shaderProcessingContext.availableAttributes[a];o!==void 0&&(i[s]=o)}return i}enableEffect(e){if(e){if(!WS(e))this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&w.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${typeof e.name=="string"?"":e.name.vertex}, effect.name.fragment=${typeof e.name=="string"?"":e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw w.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}else if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw w.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}_deletePipelineContext(e){const t=e;t&&tp(t)}get needPOTTextures(){return!1}_createHardwareTexture(){return new hu}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=0){const s={};t!==void 0&&typeof t=="object"?(s.generateMipMaps=t.generateMipMaps,s.type=t.type===void 0?0:t.type,s.samplingMode=t.samplingMode===void 0?3:t.samplingMode,s.format=t.format===void 0?5:t.format,s.samples=t.samples??1,s.creationFlags=t.creationFlags??0,s.useSRGBBuffer=t.useSRGBBuffer??!1,s.label=t.label):(s.generateMipMaps=t,s.type=0,s.samplingMode=3,s.format=5,s.samples=1,s.creationFlags=0,s.useSRGBBuffer=!1),(s.type===1&&!this._caps.textureFloatLinearFiltering||s.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(s.samplingMode=1),s.type===1&&!this._caps.textureFloat&&(s.type=0,w.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const a=new Yt(this,r),o=e.width||e,l=e.height||e,c=e.depth||0,u=e.layers||0;return a.baseWidth=o,a.baseHeight=l,a.width=o,a.height=l,a.depth=c||u,a.isReady=!0,a.samples=s.samples,a.generateMipMaps=!!s.generateMipMaps,a.samplingMode=s.samplingMode,a.type=s.type,a.format=s.format,a.is2DArray=u>0,a.is3D=c>0,a._cachedWrapU=0,a._cachedWrapV=0,a._useSRGBBuffer=s.useSRGBBuffer,a.label=s.label,this._internalTexturesCache.push(a),i||this._textureHelper.createGPUTextureForInternalTexture(a,o,l,u||1,s.creationFlags),a}createTexture(e,t,i,r,s=3,a=null,o=null,l=null,c=null,u=null,h=null,f,d,p,_){return this._createTextureBase(e,t,i,r,s,a,o,(g,E,v,x,A,T,C,y)=>{var D;const P=x;if(g.baseWidth=P.width,g.baseHeight=P.height,g.width=P.width,g.height=P.height,g.format=g.format!==-1?g.format:u??5,g.type=g.type!==-1?g.type:0,g._creationFlags=p??0,y(g.width,g.height,P,E,g,()=>{}),(D=g._hardwareTexture)!=null&&D.underlyingResource)!T&&!C&&this._generateMipmaps(g,this._uploadEncoder);else{const F=this._textureHelper.createGPUTextureForInternalTexture(g,P.width,P.height,void 0,p);Ft.IsImageBitmap(P)&&(this._textureHelper.updateTexture(P,g,P.width,P.height,g.depth,F.format,0,0,A,!1,0,0),!T&&!C&&this._generateMipmaps(g,this._uploadEncoder))}v&&v.removePendingData(g),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear()},()=>!1,l,c,u,h,f,d,_)}wrapWebGPUTexture(e){const t=new hu(e),i=new Yt(this,0,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;const s=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,s)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){const s=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),s&&s.autoBindSampler){const a=i+"Sampler";this._currentMaterialContext.setSampler(a,t)}}}createPrefilteredCubeTexture(e,t,i,r,s=null,a=null,o,l=null,c=!0){const u=h=>{if(!h){s&&s(null);return}const f=h.texture;c?h.info.sphericalPolynomial&&(f._sphericalPolynomial=h.info.sphericalPolynomial):f._sphericalPolynomial=new eo,f._source=9,s&&s(f)};return this.createCubeTexture(e,t,null,!1,u,a,o,l,c,i,r)}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let s=0;s<i.length;s++)this._setTexture(-1,i[s],!0,!1,r+s.toString(),r)}_setTexture(e,t,i=!1,r=!1,s="",a){if(a=a??s,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(s,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let o=null;if(r?o=t.depthStencilTexture:t.isReady()?o=t.getInternalTexture():t.isCube?o=this.emptyCubeTexture:t.is3D?o=this.emptyTexture3D:t.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==t.coordinatesMode){o._cachedCoordinatesMode=t.coordinatesMode;const l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}o._cachedWrapU=t.wrapU,o._cachedWrapV=t.wrapV,o.is3D&&(o._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,o,t.anisotropicFilteringLevel)}this._setInternalTexture(s,o,a)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}updateTextureData(e,t,i,r,s,a,o=0,l=0,c=!1){var f;let u=e._hardwareTexture;(f=e._hardwareTexture)!=null&&f.underlyingResource||(u=this._textureHelper.createGPUTextureForInternalTexture(e));const h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,s,a,e.depth,u.format,o,l,e.invertY,!1,i,r),c&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,a=0,o=0){var u;let l=e._hardwareTexture;(u=e._hardwareTexture)!=null&&u.underlyingResource||(e.format=t,l=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));const c=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);this._textureHelper.updateTexture(c,e,i,r,e.depth,l.format,a,o,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,a=!1){var d;const o=Math.round(Math.log(e.width)*Math.LOG2E),l=Math.round(Math.log(e.height)*Math.LOG2E),c=a?e.width:Math.pow(2,Math.max(o-r,0)),u=a?e.height:Math.pow(2,Math.max(l-r,0));let h=e._hardwareTexture;(d=e._hardwareTexture)!=null&&d.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e,c,u));const f=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(f,e,c,u,e.depth,h.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){var c;let s=e._hardwareTexture;if((c=e._hardwareTexture)!=null&&c.underlyingResource||(s=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";const a=t,o=Math.ceil(e.width/(1<<r)),l=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(a,e,o,l,e.depth,s.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,s=!0,a=!0){const l=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!l)return Promise.resolve(new Uint8Array(0));const c=l.underlyingResource,u=l.format;return c?(a&&this.flushFramebuffer(),this._textureHelper.readPixels(c,e,t,i,r,u)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in ke._UpdatedUbosInFrame)e.push(t+":"+ke._UpdatedUbosInFrame[t]);w.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}ke._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&w.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&w.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,r,s){var x,A,T,C;this._endCurrentRenderPass();const a=e,o=a._depthStencilTexture,l=o==null?void 0:o._hardwareTexture,c=l==null?void 0:l.underlyingResource,u=l==null?void 0:l.getMSAATexture(0),h=c==null?void 0:c.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),f=u==null?void 0:u.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),d=l?Ft.HasStencilAspect(l.format):!1,p=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const _=GN;i&&(_.r=i.r*255,_.g=i.g*255,_.b=i.b*255,_.a=i.a*255);const g=t&&i,E=t&&r,v=t&&s;if(a._attachments&&a.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=a._defaultAttachments);for(let y=0;y<this._mrtAttachments.length;++y){const P=this._mrtAttachments[y],D=a.textures[y],F=D==null?void 0:D._hardwareTexture,W=F==null?void 0:F.underlyingResource;if(F&&W){const H=a.getBaseArrayLayer(y),ue=F.getMSAATexture(H),ae={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:D.is3D?"3d":"2d",format:F.format,baseArrayLayer:H},le={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:D.is3D?"3d":"2d",format:F.format,baseArrayLayer:0},oe=D.type===7||D.type===5,ge=W.createView(ae),Ee=ue==null?void 0:ue.createView(le);p.push({view:Ee||ge,resolveTarget:ue?ge:void 0,depthSlice:D.is3D?((x=a.layerIndices)==null?void 0:x[y])??0:void 0,clearValue:P!==0&&g?oe?_:i:void 0,loadOp:P!==0&&g?"clear":"load",storeOp:"store"})}}this._cacheRenderPipeline.setMRT(a.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const y=a.texture;if(y){const P=y._hardwareTexture,D=P.underlyingResource;let F;a.is3D&&(F=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);const W=P.getMSAATexture(0),H=D.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),ue=W==null?void 0:W.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),ae=y.type===7||y.type===5;p.push({view:ue||H,resolveTarget:W?H:void 0,depthSlice:F,clearValue:g?ae?_:i:void 0,loadOp:g?"clear":"load",storeOp:"store"})}else p.push(null)}if((A=this._debugPushGroup)==null||A.call(this,"render target pass"+(e.label?" ("+e.label+")":""),0),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+" - RenderPass",colorAttachments:p,depthStencilAttachment:o&&c?{view:f||h,depthClearValue:E?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:E?"clear":"load",depthStoreOp:"store",stencilClearValue:a._depthStencilTextureWithStencil&&v?this._clearStencilValue:void 0,stencilLoadOp:d?a._depthStencilTextureWithStencil&&v?"clear":"load":void 0,stencilStoreOp:d?"store":void 0}:void 0,occlusionQuerySet:(T=this._occlusionQuery)!=null&&T.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const y=a.texture;w.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+y.uniqueId+", width="+y.width+", height="+y.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}(C=this._debugFlushPendingCommands)==null||C.call(this),this._resetRenderPassStates(),(!l||!Ft.HasStencilAspect(l.format))&&(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,r){var c,u,h;this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const s=e&&t,a=e&&i,o=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=s?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=s?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=o?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?o?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=(c=this._occlusionQuery)!=null&&c.hasQueries?this._occlusionQuery.querySet:void 0;const l=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(l),this._options.antialias?(iE.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=l.createView(iE)):(rE.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=l.createView(rE)),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),(u=this._debugPushGroup)==null||u.call(this,"main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),(h=this._debugFlushPendingCommands)==null||h.call(this),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}bindFramebuffer(e,t=0,i,r,s,a=0,o=0){var u,h;const l=(u=e.texture)==null?void 0:u._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;const c=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=l,this._rttRenderPassWrapper.depthTextureFormat=c?Ft.GetWebGPUTextureFormat(-1,c.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?o*6+t:o,baseMipLevel:a,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:c&&c.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:c?c.isCube?o*6+t:o:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+((h=e.texture)==null?void 0:h.uniqueId)+", face="+t+", lodLevel="+a+", layer="+o,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),r||(r=e.height,a&&(r=r/Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){var s,a;const r=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=r,this._endCurrentRenderPass(),(s=e.texture)!=null&&s.generateMipMaps&&!t&&!e.isCube&&this._generateMipmaps(e.texture),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&w.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",(a=e.texture)==null?void 0:a.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){var i;const t=((i=e.colorAttachmentGPUTextures[0])==null?void 0:i.format)??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setState(e,t=0,i,r=!1,s,a,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const l=this.cullBackFaces??s??!0?1:2;(this._depthCullingState.cullFace!==l||i)&&(this._depthCullingState.cullFace=l),this.setZOffset(t),this.setZOffsetUnits(o);const c=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=a}_applyRenderPassChanges(e){const t=this._stencilStateComposer.enabled?this._mustUpdateStencilRef():!1,i=this._alphaState.alphaBlend?this._mustUpdateBlendColor():!1;this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,r,s){var g;const a=this._getCurrentRenderPass(),o=this._bundleList;this.applyStates();const l=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,$i.InternalsUBOName),l.uniformBuffer&&(l.uniformBuffer.update(),this.bindUniformBufferBase(l.uniformBuffer.getBuffer(),0,$i.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);const c=!this.compatibilityMode&&this._currentDrawContext.fastBundle;let u=a;if(c||this._snapshotRendering.record){if(this._applyRenderPassChanges(o),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,s||1,i),o.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}u=o.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),o.numDrawCalls++}let h=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let E=1;for(let v=0;v<l.shaderProcessingContext.textureNames.length;++v){const x=l.shaderProcessingContext.textureNames[v],A=(g=this._currentMaterialContext.textures[x])==null?void 0:g.texture,T=A&&A.format>=13&&A.format<=18;((A==null?void 0:A.type)===1&&!this._caps.textureFloatLinearFiltering||T)&&(h|=E),E=E<<1}}this._currentMaterialContext.textureState=h;const f=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,h),d=this._cacheBindGroups.getBindGroups(l,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:o),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,u=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:Ft.GetSample(this.currentSampleCount)}))),u.setPipeline(f),this._currentIndexBuffer&&u.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);const p=this._cacheRenderPipeline.vertexBuffers;for(let E=0;E<p.length;E++){const v=p[E],x=v.effectiveBuffer;x&&u.setVertexBuffer(E,x.underlyingResource,v._validOffsetRange?0:v.byteOffset)}for(let E=0;E<d.length;E++)u.setBindGroup(E,d[E]);const _=!this.compatibilityMode&&!this._snapshotRendering.record;_&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,s||1,i),e===0?u.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):u.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?u.drawIndexed(r,s||1,i,0,0):u.draw(r,s||1,i,0),_&&(this._currentDrawContext.fastBundle=u.finish(),o.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){var e,t;this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),(e=this._mainTexture)==null||e.destroy(),(t=this._depthTexture)==null||t.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),ET(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){var t;return!e&&this._currentRenderTarget?this._currentRenderTarget.width:((t=this._renderingCanvas)==null?void 0:t.width)??0}getRenderHeight(e=!1){var t;return!e&&this._currentRenderTarget?this._currentRenderTarget.height:((t=this._renderingCanvas)==null?void 0:t.height)??0}getError(){return 0}createExternalTexture(e){return new UN(e)}setExternalTexture(e,t){if(!t){this._currentMaterialContext.setTexture(e,null);return}this._setInternalTexture(e,t)}setTextureSampler(e,t){var i;(i=this._currentMaterialContext)==null||i.setSampler(e,t)}createStorageBuffer(e,t,i){return this._createBuffer(e,t|32,i)}updateStorageBuffer(e,t,i,r){const s=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(s,i,a,0,r)}_readFromGPUBuffer(e,t,i,r){return new Promise((s,a)=>{const o=()=>{e.mapAsync(1,0,t).then(()=>{const l=e.getMappedRange(0,t);let c=i;if(c===void 0)c=new Uint8Array(t),c.set(new Uint8Array(l));else{const u=c.constructor;c=new u(c.buffer),c.set(new u(l))}e.unmap(),this._bufferManager.releaseBuffer(e),s(c)},l=>{this.isDisposed?s(new Uint8Array):a(l)})};r?(this.flushFramebuffer(),o()):this.onEndFrameObservable.addOnce(()=>{o()})})}readFromStorageBuffer(e,t,i,r,s){i=i||e.capacity;const a=this._bufferManager.createRawBuffer(i,Kt.MapRead|Kt.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,a,0,i),this._readFromGPUBuffer(a,i,r,s)}readFromMultipleStorageBuffers(e,t,i,r,s){i=i||e[0].capacity;const a=this._bufferManager.createRawBuffer(i*e.length,Kt.MapRead|Kt.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let o=0;o<e.length;o++)this._renderEncoder.copyBufferToBuffer(e[o].underlyingResource,t??0,a,o*i,i);return this._readFromGPUBuffer(a,i*e.length,r,s)}setStorageBuffer(e,t){var i;(i=this._currentDrawContext)==null||i.setBuffer(e,(t==null?void 0:t.getBuffer())??null)}}Vt._GlslangDefaultOptions={jsPath:`${J._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${J._DefaultCdnUrl}/glslang/glslang.wasm`};Vt._InstanceId=0;class lh{getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(this._bindGroups.length===0){const r=this._bindGroupEntries.length>0;for(const s in e){const a=e[s],o=i[s],l=o.group,c=o.binding,u=a.type,h=a.object;let f=a.indexInGroupEntries,d=this._bindGroupEntries[l];switch(d||(d=this._bindGroupEntries[l]=[]),u){case 5:{const p=h;f!==void 0&&r?d[f].resource=this._cacheSampler.getSampler(p):(a.indexInGroupEntries=d.length,d.push({binding:c,resource:this._cacheSampler.getSampler(p)}));break}case 0:case 4:{const p=h,_=p._texture._hardwareTexture;f!==void 0&&r?(u===0&&(d[f++].resource=this._cacheSampler.getSampler(p._texture)),d[f].resource=_.view):(a.indexInGroupEntries=d.length,u===0&&d.push({binding:c-1,resource:this._cacheSampler.getSampler(p._texture)}),d.push({binding:c,resource:_.view}));break}case 1:{const p=h,_=p._texture._hardwareTexture;_.textureAdditionalUsages&8||w.Error(`computeDispatch: The texture (name=${p.name}, uniqueId=${p.uniqueId}) is not a storage texture!`,50),f!==void 0&&r?d[f].resource=_.viewForWriting:(a.indexInGroupEntries=d.length,d.push({binding:c,resource:_.viewForWriting}));break}case 6:{const _=h.underlyingResource;f!==void 0&&r?d[f].resource=this._device.importExternalTexture({source:_}):(a.indexInGroupEntries=d.length,d.push({binding:c,resource:this._device.importExternalTexture({source:_})}));break}case 2:case 3:case 7:{const p=u===7?h:h.getBuffer(),_=p.underlyingResource;f!==void 0&&r?(d[f].resource.buffer=_,d[f].resource.size=p.capacity):(a.indexInGroupEntries=d.length,d.push({binding:c,resource:{buffer:_,offset:0,size:p.capacity}}));break}}}for(let s=0;s<this._bindGroupEntries.length;++s){const a=this._bindGroupEntries[s];if(!a){this._bindGroups[s]=void 0;continue}this._bindGroups[s]=this._device.createBindGroup({layout:t.getBindGroupLayout(s),entries:a})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=lh._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}lh._Counter=0;class zN{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){var e;return(e=this.sources)==null?void 0:e.compute}dispose(){}}const sE={};Vt.prototype.createComputeContext=function(){return new lh(this._device,this._cacheSampler)};Vt.prototype.createComputeEffect=function(n,e){const i=(typeof n=="string"?n:n.computeToken||n.computeSource||n.computeElement||n.compute)+"@"+e.defines;if(this._compiledComputeEffects[i]){const s=this._compiledComputeEffects[i];return e.onCompiled&&s.isReady()&&e.onCompiled(s),s}const r=new Qo(n,e,this,i);return this._compiledComputeEffects[i]=r,r};Vt.prototype.createComputePipelineContext=function(){return new zN(this)};Vt.prototype.areAllComputeEffectsReady=function(){for(const n in this._compiledComputeEffects)if(!this._compiledComputeEffects[n].isReady())return!1;return!0};Vt.prototype.computeDispatch=function(n,e,t,i,r=1,s=1,a,o){this._computeDispatch(n,e,t,i,r,s,void 0,void 0,a,o)};Vt.prototype.computeDispatchIndirect=function(n,e,t,i,r=0,s,a){this._computeDispatch(n,e,t,void 0,void 0,void 0,i,r,s,a)};Vt.prototype._computeDispatch=function(n,e,t,i,r,s,a,o,l,c){this._endCurrentRenderPass();const u=n._pipelineContext,h=e;u.computePipeline||(u.computePipeline=this._device.createComputePipeline({layout:"auto",compute:u.stage})),c&&this._timestampQuery.startPass(sE,this._timestampIndex);const f=this._renderEncoder.beginComputePass(sE);f.setPipeline(u.computePipeline);const d=h.getBindGroups(t,u.computePipeline,l);for(let p=0;p<d.length;++p){const _=d[p];_&&f.setBindGroup(p,_)}a!==void 0?f.dispatchWorkgroupsIndirect(a.underlyingResource,o):i+r+s>0&&f.dispatchWorkgroups(i,r,s),f.end(),c&&(this._timestampQuery.endPass(this._timestampIndex,c),this._timestampIndex+=2)};Vt.prototype.releaseComputeEffects=function(){for(const n in this._compiledComputeEffects){const e=this._compiledComputeEffects[n].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}};Vt.prototype._prepareComputePipelineContext=function(n,e,t,i,r){const s=n;this.dbgShowShaderCode&&(w.Log(i),w.Log(e)),s.sources={compute:e,rawCompute:t},s.stage=this._createComputePipelineStageDescriptor(e,i,r)};Vt.prototype._releaseComputeEffect=function(n){this._compiledComputeEffects[n._key]&&(delete this._compiledComputeEffects[n._key],this._deleteComputePipelineContext(n.getPipelineContext()))};Vt.prototype._rebuildComputeEffects=function(){for(const n in this._compiledComputeEffects){const e=this._compiledComputeEffects[n];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}};Vt.prototype._executeWhenComputeStateIsCompiled=function(n,e){n.stage.module.getCompilationInfo().then(t=>{const i={numErrors:0,messages:[]};for(const r of t.messages)r.type==="error"&&i.numErrors++,i.messages.push({type:r.type,text:r.message,line:r.lineNum,column:r.linePos,length:r.length,offset:r.offset});e(i)})};Vt.prototype._deleteComputePipelineContext=function(n){n&&n.dispose()};Vt.prototype._createComputePipelineStageDescriptor=function(n,e,t){return e?e="//"+e.split(`
`).join(`
//`)+`
`:e="",{module:this._device.createShaderModule({code:e+n}),entryPoint:t}};Vt.prototype._debugPushGroup=function(n,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?(e===1&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.pushDebugGroup(n)):this._currentRenderPass?(this._currentRenderPass.pushDebugGroup(n),this._debugStackRenderPass.push(n)):this._pendingDebugCommands.push(["push",n,e]))};Vt.prototype._debugPopGroup=function(n){this._options.enableGPUDebugMarkers&&(n===0||n===1?(n===1&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.popDebugGroup()):this._currentRenderPass?(this._currentRenderPass.popDebugGroup(),this._debugStackRenderPass.pop()):this._pendingDebugCommands.push(["pop",null,n]))};Vt.prototype._debugInsertMarker=function(n,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?(e===1&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.insertDebugMarker(n)):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(n):this._pendingDebugCommands.push(["insert",n,e]))};Vt.prototype._debugFlushPendingCommands=function(){if(this._debugStackRenderPass.length!==0){const n=this._debugStackRenderPass.slice();this._debugStackRenderPass.length=0;for(let e=0;e<n.length;++e)this._debugPushGroup(n[e],2)}for(let n=0;n<this._pendingDebugCommands.length;++n){const[e,t,i]=this._pendingDebugCommands[n];switch(e){case"push":this._debugPushGroup(t,i);break;case"pop":this._debugPopGroup(i);break;case"insert":this._debugInsertMarker(t,i);break}}this._pendingDebugCommands.length=0};Vt.prototype.createDynamicTexture=function(n,e,t,i){const r=new Yt(this,4);return r.baseWidth=n,r.baseHeight=e,t&&(n=this.needPOTTextures?Wn(n,this._caps.maxTextureSize):n,e=this.needPOTTextures?Wn(e,this._caps.maxTextureSize):e),r.width=n,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),n&&e&&this._textureHelper.createGPUTextureForInternalTexture(r,n,e),r};Vt.prototype.updateDynamicTexture=function(n,e,t,i=!1,r,s,a){var u;if(!n)return;const o=e.width,l=e.height;let c=n._hardwareTexture;(u=n._hardwareTexture)!=null&&u.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(n,o,l)),this._textureHelper.updateTexture(e,n,o,l,n.depth,c.format,0,0,t,i,0,0,a),n.generateMipMaps&&this._generateMipmaps(n),n._dynamicTextureSource=e,n._premulAlpha=i,n.invertY=t||!1,n.isReady=!0};Vt.prototype.unBindMultiColorAttachmentFramebuffer=function(n,e=!1,t){t&&t();const r=n._attachments.length;this._endCurrentRenderPass();for(let s=0;s<r;s++){const a=n.textures[s];a.generateMipMaps&&!e&&!a.isCube&&!a.is3D&&this._generateMipmaps(a)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)};Vt.prototype.createMultipleRenderTarget=function(n,e,t){let i=!1,r=!0,s=!1,a=!1,o=15,l=1,c=1;const u=0,h=3,f=!1,d=5,p=3553;let _=[],g=[],E=[],v=[],x=[],A=[],T=[],C=[],y=[],P=[];const D=this._createHardwareRenderTargetWrapper(!0,!1,n);e!==void 0&&(i=e.generateMipMaps??!1,r=e.generateDepthBuffer??!0,s=e.generateStencilBuffer??!1,a=e.generateDepthTexture??!1,l=e.textureCount??1,o=e.depthTextureFormat??15,_=e.types||_,g=e.samplingModes||g,E=e.useSRGBBuffers||E,v=e.formats||v,x=e.targetTypes||x,A=e.faceIndex||A,T=e.layerIndex||T,C=e.layerCounts||C,y=e.labels||y,P=e.creationFlags||P,c=e.samples??c);const F=n.width??n,W=n.height??n,H=[],ue=[],ae=[];D.label=(e==null?void 0:e.label)??"MultiRenderTargetWrapper",D._generateDepthBuffer=r,D._generateStencilBuffer=s,D._attachments=ue,D._defaultAttachments=ae;let le=null;(r||s||a)&&(a||(r&&s?o=13:r?o=14:o=19),le=D.createDepthStencilTexture(0,!1,s,1,o,D.label+"-DepthStencil"));const oe=e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i;for(let ge=0;ge<l;ge++){let Ee=g[ge]||h,ne=_[ge]||u;const j=v[ge]||d,L=(E[ge]||f)&&this._caps.supportSRGBBuffers,Y=x[ge]||p,te=C[ge]??1,De=P[ge];if((ne===1&&!this._caps.textureFloatLinearFiltering||ne===2&&!this._caps.textureHalfFloatLinearFiltering)&&(Ee=1),ne===1&&!this._caps.textureFloat&&(ne=0,w.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),ue.push(ge+1),ae.push(t?ge+1:ge===0?1:0),Y===-1)continue;const Ve=new Yt(this,6);switch(H[ge]=Ve,Y){case 34067:Ve.isCube=!0;break;case 32879:Ve.is3D=!0,Ve.baseDepth=Ve.depth=te;break;case 35866:Ve.is2DArray=!0,Ve.baseDepth=Ve.depth=te;break}Ve.baseWidth=F,Ve.baseHeight=W,Ve.width=F,Ve.height=W,Ve.isReady=!0,Ve.samples=1,Ve.generateMipMaps=i,Ve.samplingMode=Ee,Ve.type=ne,Ve._cachedWrapU=0,Ve._cachedWrapV=0,Ve._useSRGBBuffer=L,Ve.format=j,Ve.label=y[ge]??D.label+"-Texture"+ge,this._internalTexturesCache.push(Ve),oe&&(Ve.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(Ve,void 0,void 0,void 0,De,!0),oe&&(Ve.generateMipMaps=!1)}return le&&(le.incrementReferences(),H[l]=le,this._internalTexturesCache.push(le)),D.setTextures(H),D.setLayerAndFaceIndices(T,A),this.updateMultipleRenderTargetTextureSampleCount(D,c),D};Vt.prototype.updateMultipleRenderTargetTextureSampleCount=function(n,e){if(!n||!n.textures||n.textures[0].samples===e)return e;const t=n.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let r=0;r<t;++r){const a=n.textures[r]._hardwareTexture;a==null||a.releaseMSAATexture(n.getBaseArrayLayer(r))}const i=n._depthStencilTexture===n.textures[t-1];for(let r=0;r<t;++r){const s=n.textures[r];this._textureHelper.createMSAATexture(s,e,!1,n.getBaseArrayLayer(r)),s.samples=e}return n._depthStencilTexture&&!i&&(this._textureHelper.createMSAATexture(n._depthStencilTexture,e),n._depthStencilTexture.samples=e),n._samples=e,e};Vt.prototype.bindAttachments=function(n){n.length===0||!this._currentRenderTarget||(this._mrtAttachments=n,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(n))};Vt.prototype.buildTextureLayout=function(n){const e=[];for(let t=0;t<n.length;t++)n[t]?e.push(t+1):e.push(0);return e};Vt.prototype.restoreSingleAttachment=function(){};Vt.prototype.restoreSingleAttachmentForRenderTarget=function(){};Vt.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};Vt.prototype.captureGPUFrameTime=function(n){this._timestampQuery.enable=n&&!!this._caps.timerQuery};Vt.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};Vt.prototype.deleteQuery=function(n){return this._occlusionQuery.deleteQuery(n),this};Vt.prototype.isQueryResultAvailable=function(n){return this._occlusionQuery.isQueryResultAvailable(n)};Vt.prototype.getQueryResult=function(n){return this._occlusionQuery.getQueryResult(n)};Vt.prototype.beginOcclusionQuery=function(n,e){var t;if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery(e))return(t=this._currentRenderPass)==null||t.beginOcclusionQuery(e),!0}else return this._bundleList.addItem(new Tp(e)),!0;return!1};Vt.prototype.endOcclusionQuery=function(){var n;return this.compatibilityMode?(n=this._currentRenderPass)==null||n.endOcclusionQuery():this._bundleList.addItem(new xp),this};function WN(n){return!!(n&&n.underlyingResource!==void 0)}Vt.prototype.updateVideoTexture=function(n,e,t){var r;if(!n||n._isDisabled)return;this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);let i=n._hardwareTexture;if((r=n._hardwareTexture)!=null&&r.underlyingResource||(i=this._textureHelper.createGPUTextureForInternalTexture(n)),WN(e)){if(e.isReady()){try{this._textureHelper.copyVideoToTexture(e,n,i.format,!t),n.generateMipMaps&&this._generateMipmaps(n)}catch{}n.isReady=!0}}else e&&this.createImageBitmap(e).then(s=>{this._textureHelper.updateTexture(s,n,n.width,n.height,n.depth,i.format,0,0,!t,!1,0,0),n.generateMipMaps&&this._generateMipmaps(n),n.isReady=!0}).catch(()=>{n.isReady=!0})};const HN=(n,e)=>{const t=document.getElementById(n),i=document.getElementById(e),r=new Se(t,!0);return{canvasElement:t,fpsMeterElement:i,gameEngine:r}},XN=tc,vo={...dD,TwoPi:Math.PI*2,Sign:Math.sign,Log2:Math.log2,HCF:XN};function YN(n,e){return`{X: ${n.x.toFixed(e)} Y: ${n.y.toFixed(e)}}`}function $N(n,e){return`{X: ${n._x.toFixed(e)} Y: ${n._y.toFixed(e)} Z: ${n._z.toFixed(e)}}`}function KN(n,e){return`{X: ${n.x.toFixed(e)} Y: ${n.y.toFixed(e)} Z: ${n.z.toFixed(e)} W: ${n.w.toFixed(e)}}`}class Tt extends Lt{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new fe(1,1,1),this.specular=new fe(1,1,1),this.falloffType=Tt.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Tt.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new ke(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,s=!0){const a=e.toString();let o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;const l=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(l,Ot.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Ot.Color3[0],this.range,a),r&&(this.specular.scaleToRef(l,Ot.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Ot.Color3[1],this.radius,a)),o=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&s){const l=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();l&&(l.bindShadowLight(a,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return this._shadowGenerators===null?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return m.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=Tt.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const r=Ke.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){const e=Ke.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),Ke.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const r=Lt.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){const i=Tt.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const r=Ke.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=Ai("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}Lt.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);for(const a of r)a._resyncLightSource(this);return s};const i=e.splice;e.splice=(r,s)=>{const a=i.apply(e,[r,s]);for(const o of a)o._resyncLightSource(this);return a};for(const r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._resyncMeshes(),s};const i=e.splice;e.splice=(r,s)=>{const a=i.apply(e,[r,s]);return this._resyncMeshes(),a},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===Tt.INTENSITYMODE_AUTOMATIC&&(t===Tt.LIGHTTYPEID_DIRECTIONALLIGHT?i=Tt.INTENSITYMODE_ILLUMINANCE:i=Tt.INTENSITYMODE_LUMINOUSINTENSITY),t){case Tt.LIGHTTYPEID_POINTLIGHT:case Tt.LIGHTTYPEID_SPOTLIGHT:switch(i){case Tt.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Tt.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Tt.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case Tt.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case Tt.INTENSITYMODE_ILLUMINANCE:e=1;break;case Tt.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case Tt.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Tt.FALLOFF_DEFAULT=qt.FALLOFF_DEFAULT;Tt.FALLOFF_PHYSICAL=qt.FALLOFF_PHYSICAL;Tt.FALLOFF_GLTF=qt.FALLOFF_GLTF;Tt.FALLOFF_STANDARD=qt.FALLOFF_STANDARD;Tt.LIGHTMAP_DEFAULT=qt.LIGHTMAP_DEFAULT;Tt.LIGHTMAP_SPECULAR=qt.LIGHTMAP_SPECULAR;Tt.LIGHTMAP_SHADOWSONLY=qt.LIGHTMAP_SHADOWSONLY;Tt.INTENSITYMODE_AUTOMATIC=qt.INTENSITYMODE_AUTOMATIC;Tt.INTENSITYMODE_LUMINOUSPOWER=qt.INTENSITYMODE_LUMINOUSPOWER;Tt.INTENSITYMODE_LUMINOUSINTENSITY=qt.INTENSITYMODE_LUMINOUSINTENSITY;Tt.INTENSITYMODE_ILLUMINANCE=qt.INTENSITYMODE_ILLUMINANCE;Tt.INTENSITYMODE_LUMINANCE=qt.INTENSITYMODE_LUMINANCE;Tt.LIGHTTYPEID_POINTLIGHT=qt.LIGHTTYPEID_POINTLIGHT;Tt.LIGHTTYPEID_DIRECTIONALLIGHT=qt.LIGHTTYPEID_DIRECTIONALLIGHT;Tt.LIGHTTYPEID_SPOTLIGHT=qt.LIGHTTYPEID_SPOTLIGHT;Tt.LIGHTTYPEID_HEMISPHERICLIGHT=qt.LIGHTTYPEID_HEMISPHERICLIGHT;I([hi()],Tt.prototype,"diffuse",void 0);I([hi()],Tt.prototype,"specular",void 0);I([M()],Tt.prototype,"falloffType",void 0);I([M()],Tt.prototype,"intensity",void 0);I([M()],Tt.prototype,"range",null);I([M()],Tt.prototype,"intensityMode",null);I([M()],Tt.prototype,"radius",null);I([M()],Tt.prototype,"_renderPriority",void 0);I([ie("_reorderLightsInScene")],Tt.prototype,"renderPriority",void 0);I([M("shadowEnabled")],Tt.prototype,"_shadowEnabled",void 0);I([M("excludeWithLayerMask")],Tt.prototype,"_excludeWithLayerMask",void 0);I([M("includeOnlyWithLayerMask")],Tt.prototype,"_includeOnlyWithLayerMask",void 0);I([M("lightmapMode")],Tt.prototype,"_lightmapMode",void 0);class lo extends Tt{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=O.Identity(),this._projectionMatrix=O.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=m.Zero()),m.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=m.Zero()),m.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=m.Cross(this.direction,ys.Y),t=m.Cross(e,this.direction);return m.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=m.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=O.Identity()),O.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=B.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),m.NormalizeToRef(this.getShadowDirection(e),t),Math.abs(m.Dot(t,m.Up()))===1&&(t.z=1e-13);const r=B.Vector3[1];return i.addToRef(t,r),O.LookAtLHToRef(i,r,m.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}I([Ar()],lo.prototype,"position",null);I([Ar()],lo.prototype,"direction",null);I([M()],lo.prototype,"shadowMinZ",null);I([M()],lo.prototype,"shadowMaxZ",null);class fs extends Or{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([re(()=>import("./kernelBlur.fragment-DBgXQgrZ.js"),__vite__mapDeps([0,1])),re(()=>import("./kernelBlur.vertex-CvUNVGTR.js"),__vite__mapDeps([2,1]))]))):t.push(Promise.all([re(()=>import("./kernelBlur.fragment-DM8Kv_4_.js"),__vite__mapDeps([3,4])),re(()=>import("./kernelBlur.vertex-C9g5aE1A.js"),__vite__mapDeps([5,4]))]))}constructor(e,t=null,i,r,s){const a=!!(s!=null&&s.blockCompilation);super({...s,name:e,engine:t||Se.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:fs.FragmentUrl,uniforms:fs.Uniforms,samplers:fs.Samplers,vertexUrl:fs.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this.options.blockCompilation=a,i!==void 0&&(this.direction=i),r!==void 0&&(this.kernel=r)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(){super.bind(),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){const i=this._kernel,r=(i-1)/2;let s=[],a=[],o=0;for(let g=0;g<i;g++){const E=g/(i-1),v=this._gaussianWeight(E*2-1);s[g]=g-r,a[g]=v,o+=v}for(let g=0;g<a.length;g++)a[g]/=o;const l=[],c=[],u=[];for(let g=0;g<=r;g+=2){const E=Math.min(g+1,Math.floor(r));if(g===E)u.push({o:s[g],w:a[g]});else{const x=E===r,A=a[g]+a[E]*(x?.5:1),T=s[g]+1/(1+a[g]/a[E]);T===0?(u.push({o:s[g],w:a[g]}),u.push({o:s[g+1],w:a[g+1]})):(u.push({o:T,w:A}),u.push({o:-T,w:A}))}}for(let g=0;g<u.length;g++)c[g]=u[g].o,l[g]=u[g].w;s=c,a=l;const h=this.options.engine.getCaps().maxVaryingVectors-(this.options.shaderLanguage===1?1:0),f=Math.max(h,0)-1;let d=Math.min(s.length,f),p="";p+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(a[d-1])}
`,d--);for(let g=0;g<d;g++)p+=`#define KERNEL_OFFSET${g} ${this._glslFloat(s[g])}
`,p+=`#define KERNEL_WEIGHT${g} ${this._glslFloat(a[g])}
`;let _=0;for(let g=f;g<s.length;g++)p+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(s[g])}
`,p+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(a[g])}
`,_++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(p,null,null,{varyingCount:d,depCount:_},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,r=-(e*e/(2*t*t));return 1/i*Math.exp(r)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}fs.VertexUrl="kernelBlur";fs.FragmentUrl="kernelBlur";fs.Uniforms=["delta","direction"];fs.Samplers=["circleOfConfusionSampler"];class En extends Jt{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,s=null,a=Z.BILINEAR_SAMPLINGMODE,o,l,c=0,u="",h=!1,f=5){const d=typeof r=="number"?h:!!r.blockCompilation,p={uniforms:fs.Uniforms,samplers:fs.Samplers,size:typeof r=="number"?r:void 0,camera:s,samplingMode:a,engine:o,reusable:l,textureType:c,vertexUrl:fs.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:f,defines:u,...r,blockCompilation:!0};super(e,fs.FragmentUrl,{effectWrapper:typeof r=="number"||!r.effectWrapper?new fs(e,o,void 0,void 0,p):void 0,...p}),this._effectWrapper.options.blockCompilation=d,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=i}updateEffect(e=null,t=null,i=null,r,s,a){this._effectWrapper._updateParameters(s,a)}static _Parse(e,t,i,r){return Ke.Parse(()=>new En(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,r)}}I([np()],En.prototype,"direction",null);I([M()],En.prototype,"kernel",null);I([M()],En.prototype,"packedFloat",null);$("BABYLON.BlurPostProcess",En);class co{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let r=0;r<i.meshes.length;r++){const s=i.meshes[r];if(!s.material){!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1);continue}if(!(!s.computeBonesUsingShaders||s.numBoneInfluencers===0)){if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes){for(const a of s.subMeshes)if(a.effect===t){s.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");this._currentRank++}return e}}function Zn(n){n.indexOf("vClipPlane")===-1&&n.push("vClipPlane"),n.indexOf("vClipPlane2")===-1&&n.push("vClipPlane2"),n.indexOf("vClipPlane3")===-1&&n.push("vClipPlane3"),n.indexOf("vClipPlane4")===-1&&n.push("vClipPlane4"),n.indexOf("vClipPlane5")===-1&&n.push("vClipPlane5"),n.indexOf("vClipPlane6")===-1&&n.push("vClipPlane6")}function xc(n,e,t){const i=!!(n.clipPlane??e.clipPlane),r=!!(n.clipPlane2??e.clipPlane2),s=!!(n.clipPlane3??e.clipPlane3),a=!!(n.clipPlane4??e.clipPlane4),o=!!(n.clipPlane5??e.clipPlane5),l=!!(n.clipPlane6??e.clipPlane6);i&&t.push("#define CLIPPLANE"),r&&t.push("#define CLIPPLANE2"),s&&t.push("#define CLIPPLANE3"),a&&t.push("#define CLIPPLANE4"),o&&t.push("#define CLIPPLANE5"),l&&t.push("#define CLIPPLANE6")}function jN(n,e,t){let i=!1;const r=!!(n.clipPlane??e.clipPlane),s=!!(n.clipPlane2??e.clipPlane2),a=!!(n.clipPlane3??e.clipPlane3),o=!!(n.clipPlane4??e.clipPlane4),l=!!(n.clipPlane5??e.clipPlane5),c=!!(n.clipPlane6??e.clipPlane6);return t.CLIPPLANE!==r&&(t.CLIPPLANE=r,i=!0),t.CLIPPLANE2!==s&&(t.CLIPPLANE2=s,i=!0),t.CLIPPLANE3!==a&&(t.CLIPPLANE3=a,i=!0),t.CLIPPLANE4!==o&&(t.CLIPPLANE4=o,i=!0),t.CLIPPLANE5!==l&&(t.CLIPPLANE5=l,i=!0),t.CLIPPLANE6!==c&&(t.CLIPPLANE6=c,i=!0),i}function Sn(n,e,t){let i=e.clipPlane??t.clipPlane;So(n,"vClipPlane",i),i=e.clipPlane2??t.clipPlane2,So(n,"vClipPlane2",i),i=e.clipPlane3??t.clipPlane3,So(n,"vClipPlane3",i),i=e.clipPlane4??t.clipPlane4,So(n,"vClipPlane4",i),i=e.clipPlane5??t.clipPlane5,So(n,"vClipPlane5",i),i=e.clipPlane6??t.clipPlane6,So(n,"vClipPlane6",i)}function So(n,e,t){t&&n.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}const nE=fe.Black(),aE={NUM_MORPH_INFLUENCERS:0};function Qn(n,e,t){if(!n||n.LOGARITHMICDEPTH||n.indexOf&&n.indexOf("LOGARITHMICDEPTH")>=0){const i=t.activeCamera;i.mode===1&&w.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(i.maxZ+1)/Math.LN2))}}function uo(n,e,t,i=!1){t&&n.fogEnabled&&(!e||e.applyFog)&&n.fogMode!==0&&(t.setFloat4("vFogInfos",n.fogMode,n.fogStart,n.fogEnd,n.fogDensity),i?(n.fogColor.toLinearSpaceToRef(nE,n.getEngine().useExactSrgbConversions),t.setColor3("vFogColor",nE)):t.setColor3("vFogColor",n.fogColor))}function zT(n,e,t){aE.NUM_MORPH_INFLUENCERS=t,Ip(n,e,aE)}function Ip(n,e,t){const i=t.NUM_MORPH_INFLUENCERS;if(i>0&&$e.LastCreatedEngine){const r=$e.LastCreatedEngine.getCaps().maxVertexAttribs,s=e.morphTargetManager;if(s!=null&&s.isUsingTextureForTargets)return;const a=s&&s.supportsNormals&&t.NORMAL,o=s&&s.supportsTangents&&t.TANGENT,l=s&&s.supportsUVs&&t.UV1;for(let c=0;c<i;c++)n.push("position"+c),a&&n.push("normal"+c),o&&n.push("tangent"+c),l&&n.push("uv_"+c),n.length>r&&w.Error("Cannot add more vertex attributes for mesh "+e.name)}}function ch(n,e=!1){n.push("world0"),n.push("world1"),n.push("world2"),n.push("world3"),e&&(n.push("previousWorld0"),n.push("previousWorld1"),n.push("previousWorld2"),n.push("previousWorld3"))}function cl(n,e){const t=n.morphTargetManager;!n||!t||e.setFloatArray("morphTargetInfluences",t.influences)}function yp(n,e){e.bindToEffect(n,"Scene")}function ai(n,e,t){e._needUVs=!0,e[t]=!0,n.optimizeUVAllocation&&n.getTextureMatrix().isIdentityAs3x2()?(e[t+"DIRECTUV"]=n.coordinatesIndex+1,e["MAINUV"+(n.coordinatesIndex+1)]=!0):e[t+"DIRECTUV"]=0}function oi(n,e,t){const i=n.getTextureMatrix();e.updateMatrix(t+"Matrix",i)}function bp(n,e,t){t.BAKED_VERTEX_ANIMATION_TEXTURE&&t.INSTANCES&&n.push("bakedVertexAnimationSettingsInstanced")}function qN(n,e){return e.set(n),e}function ul(n,e,t){if(!(!e||!n)&&(n.computeBonesUsingShaders&&e._bonesComputationForcedToCPU&&(n.computeBonesUsingShaders=!1),n.useBones&&n.computeBonesUsingShaders&&n.skeleton)){const i=n.skeleton;if(i.isUsingTextureForMatrices&&e.getUniformIndex("boneTextureWidth")>-1){const r=i.getTransformMatrixTexture(n);e.setTexture("boneSampler",r),e.setFloat("boneTextureWidth",4*(i.bones.length+1))}else{const r=i.getTransformMatrices(n);r&&(e.setMatrices("mBones",r),t&&n.getScene().prePassRenderer&&n.getScene().prePassRenderer.getIndex(2)&&(t.previousBones[n.uniqueId]||(t.previousBones[n.uniqueId]=r.slice()),e.setMatrices("mPreviousBones",t.previousBones[n.uniqueId]),qN(r,t.previousBones[n.uniqueId])))}}}function Rp(n,e,t,i,r,s=!0){n._bindLight(e,t,i,r,s)}function Cc(n,e,t,i,r=4){const s=Math.min(e.lightSources.length,r);for(let a=0;a<s;a++){const o=e.lightSources[a];Rp(o,a,n,t,typeof i=="boolean"?i:i.SPECULARTERM,e.receiveShadows)}}function Pp(n,e,t,i){t.NUM_BONE_INFLUENCERS>0&&(i.addCPUSkinningFallback(0,e),n.push("matricesIndices"),n.push("matricesWeights"),t.NUM_BONE_INFLUENCERS>4&&(n.push("matricesIndicesExtra"),n.push("matricesWeightsExtra")))}function uh(n,e){(e.INSTANCES||e.THIN_INSTANCES)&&ch(n,!!e.PREPASS_VELOCITY),e.INSTANCESCOLOR&&n.push("instanceColor")}function Mp(n,e,t=4,i=0){let r=0;for(let s=0;s<t&&n["LIGHT"+s];s++)s>0&&(r=i+s,e.addFallback(r,"LIGHT"+s)),n.SHADOWS||(n["SHADOW"+s]&&e.addFallback(i,"SHADOW"+s),n["SHADOWPCF"+s]&&e.addFallback(i,"SHADOWPCF"+s),n["SHADOWPCSS"+s]&&e.addFallback(i,"SHADOWPCSS"+s),n["SHADOWPOISSON"+s]&&e.addFallback(i,"SHADOWPOISSON"+s),n["SHADOWESM"+s]&&e.addFallback(i,"SHADOWESM"+s),n["SHADOWCLOSEESM"+s]&&e.addFallback(i,"SHADOWCLOSEESM"+s));return r++}function WT(n,e){return e.fogEnabled&&n.applyFog&&e.fogMode!==0}function hh(n,e,t,i,r,s,a,o=!1){a._areMiscDirty&&(a.LOGARITHMICDEPTH=t,a.POINTSIZE=i,a.FOG=r&&WT(n,e),a.NONUNIFORMSCALING=n.nonUniformScaling,a.ALPHATEST=s,a.DECAL_AFTER_DETAIL=o)}function Ac(n,e,t,i,r=4,s=!1){if(!t._areLightsDirty)return t._needNormals;let a=0;const o={needNormals:t._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(n.lightsEnabled&&!s){for(const c of e.lightSources)if(Dp(n,e,c,a,t,i,o),a++,a===r)break}t.SPECULARTERM=o.specularEnabled,t.SHADOWS=o.shadowEnabled;for(let c=a;c<r;c++)t["LIGHT"+c]!==void 0&&(t["LIGHT"+c]=!1,t["HEMILIGHT"+c]=!1,t["POINTLIGHT"+c]=!1,t["DIRLIGHT"+c]=!1,t["SPOTLIGHT"+c]=!1,t["SHADOW"+c]=!1,t["SHADOWCSM"+c]=!1,t["SHADOWCSMDEBUG"+c]=!1,t["SHADOWCSMNUM_CASCADES"+c]=!1,t["SHADOWCSMUSESHADOWMAXZ"+c]=!1,t["SHADOWCSMNOBLEND"+c]=!1,t["SHADOWCSM_RIGHTHANDED"+c]=!1,t["SHADOWPCF"+c]=!1,t["SHADOWPCSS"+c]=!1,t["SHADOWPOISSON"+c]=!1,t["SHADOWESM"+c]=!1,t["SHADOWCLOSEESM"+c]=!1,t["SHADOWCUBE"+c]=!1,t["SHADOWLOWQUALITY"+c]=!1,t["SHADOWMEDIUMQUALITY"+c]=!1);const l=n.getEngine().getCaps();return t.SHADOWFLOAT===void 0&&(o.needRebuild=!0),t.SHADOWFLOAT=o.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),t.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&t.rebuild(),o.needNormals}function Dp(n,e,t,i,r,s,a){switch(a.needNormals=!0,r["LIGHT"+i]===void 0&&(a.needRebuild=!0),r["LIGHT"+i]=!0,r["SPOTLIGHT"+i]=!1,r["HEMILIGHT"+i]=!1,r["POINTLIGHT"+i]=!1,r["DIRLIGHT"+i]=!1,t.prepareLightSpecificDefines(r,i),r["LIGHT_FALLOFF_PHYSICAL"+i]=!1,r["LIGHT_FALLOFF_GLTF"+i]=!1,r["LIGHT_FALLOFF_STANDARD"+i]=!1,t.falloffType){case qt.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+i]=!0;break;case qt.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+i]=!0;break;case qt.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+i]=!0;break}if(s&&!t.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),r["SHADOW"+i]=!1,r["SHADOWCSM"+i]=!1,r["SHADOWCSMDEBUG"+i]=!1,r["SHADOWCSMNUM_CASCADES"+i]=!1,r["SHADOWCSMUSESHADOWMAXZ"+i]=!1,r["SHADOWCSMNOBLEND"+i]=!1,r["SHADOWCSM_RIGHTHANDED"+i]=!1,r["SHADOWPCF"+i]=!1,r["SHADOWPCSS"+i]=!1,r["SHADOWPOISSON"+i]=!1,r["SHADOWESM"+i]=!1,r["SHADOWCLOSEESM"+i]=!1,r["SHADOWCUBE"+i]=!1,r["SHADOWLOWQUALITY"+i]=!1,r["SHADOWMEDIUMQUALITY"+i]=!1,e&&e.receiveShadows&&n.shadowsEnabled&&t.shadowEnabled){const o=t.getShadowGenerator(n.activeCamera)??t.getShadowGenerator();if(o){const l=o.getShadowMap();l&&l.renderList&&l.renderList.length>0&&(a.shadowEnabled=!0,o.prepareDefines(r,i))}}t.lightmapMode!=qt.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+i]=!0,r["LIGHTMAPNOSPECULAR"+i]=t.lightmapMode==qt.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+i]=!1,r["LIGHTMAPNOSPECULAR"+i]=!1)}function fh(n,e,t,i,r,s=null,a=!1){let o=$T(n,i);s!==!1&&(o=jN(t,n,i)),i.DEPTHPREPASS!==!e.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,o=!0),i.INSTANCES!==r&&(i.INSTANCES=r,o=!0),i.THIN_INSTANCES!==a&&(i.THIN_INSTANCES=a,o=!0),o&&i.markAsUnprocessed()}function HT(n,e){if(n.useBones&&n.computeBonesUsingShaders&&n.skeleton){e.NUM_BONE_INFLUENCERS=n.numBoneInfluencers;const t=e.BONETEXTURE!==void 0;if(n.skeleton.isUsingTextureForMatrices&&t)e.BONETEXTURE=!0;else{e.BonesPerMesh=n.skeleton.bones.length+1,e.BONETEXTURE=t?!1:void 0;const i=n.getScene().prePassRenderer;if(i&&i.enabled){const r=i.excludedSkinnedMesh.indexOf(n)===-1;e.BONES_VELOCITY_ENABLED=r}}}else e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE!==void 0&&(e.BONETEXTURE=!1)}function XT(n,e){const t=n.morphTargetManager;t?(e.MORPHTARGETS_UV=t.supportsUVs&&e.UV1,e.MORPHTARGETS_TANGENT=t.supportsTangents&&e.TANGENT,e.MORPHTARGETS_NORMAL=t.supportsNormals&&e.NORMAL,e.NUM_MORPH_INFLUENCERS=t.numMaxInfluencers||t.numInfluencers,e.MORPHTARGETS=e.NUM_MORPH_INFLUENCERS>0,e.MORPHTARGETS_TEXTURE=t.isUsingTextureForTargets):(e.MORPHTARGETS_UV=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS=!1,e.NUM_MORPH_INFLUENCERS=0)}function ZN(n,e){const t=n.bakedVertexAnimationManager;e.BAKED_VERTEX_ANIMATION_TEXTURE=!!(t&&t.isEnabled)}function dh(n,e,t,i,r=!1,s=!0,a=!0){if(!e._areAttributesDirty&&e._needNormals===e._normals&&e._needUVs===e._uvs)return!1;e._normals=e._needNormals,e._uvs=e._needUVs,e.NORMAL=e._needNormals&&n.isVerticesDataPresent("normal"),e._needNormals&&n.isVerticesDataPresent("tangent")&&(e.TANGENT=!0);for(let o=1;o<=6;++o)e["UV"+o]=e._needUVs?n.isVerticesDataPresent(`uv${o===1?"":o}`):!1;if(t){const o=n.useVertexColors&&n.isVerticesDataPresent("color");e.VERTEXCOLOR=o,e.VERTEXALPHA=n.hasVertexAlpha&&o&&s}return n.isVerticesDataPresent("instanceColor")&&(n.hasInstances||n.hasThinInstances)&&(e.INSTANCESCOLOR=!0),i&&HT(n,e),r&&XT(n,e),a&&ZN(n,e),!0}function ph(n,e){if(n.activeCamera){const t=e.MULTIVIEW;e.MULTIVIEW=n.activeCamera.outputRenderTarget!==null&&n.activeCamera.outputRenderTarget.getViewCount()>1,e.MULTIVIEW!=t&&e.markAsUnprocessed()}}function YT(n,e,t){const i=e.ORDER_INDEPENDENT_TRANSPARENCY,r=e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;e.ORDER_INDEPENDENT_TRANSPARENCY=n.useOrderIndependentTransparency&&t,e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!n.getEngine().getCaps().textureFloatLinearFiltering,(i!==e.ORDER_INDEPENDENT_TRANSPARENCY||r!==e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&e.markAsUnprocessed()}function Op(n,e,t){const i=e.PREPASS;if(!e._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:9,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:11,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:10,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:8,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(n.prePassRenderer&&n.prePassRenderer.enabled&&t){e.PREPASS=!0,e.SCENE_MRT_COUNT=n.prePassRenderer.mrtCount,e.PREPASS_NORMAL_WORLDSPACE=n.prePassRenderer.generateNormalsInWorldSpace,e.PREPASS_COLOR=!0,e.PREPASS_COLOR_INDEX=0;for(let s=0;s<r.length;s++){const a=n.prePassRenderer.getIndex(r[s].type);a!==-1?(e[r[s].define]=!0,e[r[s].index]=a):e[r[s].define]=!1}}else{e.PREPASS=!1;for(let s=0;s<r.length;s++)e[r[s].define]=!1}e.PREPASS!=i&&(e.markAsUnprocessed(),e.markAsImageProcessingDirty())}function $T(n,e){let t=!1;if(n.activeCamera){const i=e.CAMERA_ORTHOGRAPHIC?1:0,r=e.CAMERA_PERSPECTIVE?1:0,s=n.activeCamera.mode===1?1:0,a=n.activeCamera.mode===0?1:0;(i^s||r^a)&&(e.CAMERA_ORTHOGRAPHIC=s===1,e.CAMERA_PERSPECTIVE=a===1,t=!0)}return t}function Np(n,e,t,i,r=null,s=!1){r&&r.push("Light"+n),!s&&(e.push("vLightData"+n,"vLightDiffuse"+n,"vLightSpecular"+n,"vLightDirection"+n,"vLightFalloff"+n,"vLightGround"+n,"lightMatrix"+n,"shadowsInfo"+n,"depthValues"+n),t.push("shadowTexture"+n),t.push("depthTexture"+n),e.push("viewFrustumZ"+n,"cascadeBlendFactor"+n,"lightSizeUVCorrection"+n,"depthCorrection"+n,"penumbraDarkness"+n,"frustumLengths"+n),i&&(t.push("projectionLightTexture"+n),e.push("textureProjectionMatrix"+n)))}function _h(n,e,t,i=4){let r,s=null;if(n.uniformsNames){const a=n;r=a.uniformsNames,s=a.uniformBuffersNames,e=a.samplers,t=a.defines,i=a.maxSimultaneousLights||0}else r=n,e||(e=[]);for(let a=0;a<i&&t["LIGHT"+a];a++)Np(a,r,e,t["PROJECTEDLIGHTTEXTURE"+a],s);t.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),t.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),e.push("bakedVertexAnimationTexture"))}class et{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===et.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===et.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===et.FILTER_PCF||e===et.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===et.FILTER_PCF||e===et.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===et.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(et.FILTER_POISSONSAMPLING);!e&&this.filter!==et.FILTER_POISSONSAMPLING||(this.filter=e?t:et.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===et.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(et.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==et.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:et.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===et.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(et.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==et.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:et.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===et.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(et.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==et.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:et.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===et.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(et.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==et.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:et.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===et.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(et.FILTER_PCF);!e&&this.filter!==et.FILTER_PCF||(this.filter=e?t:et.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===et.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(et.FILTER_PCSS);!e&&this.filter!==et.FILTER_PCSS||(this.filter=e?t:et.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return et.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(const i of e.getChildMeshes())this._shadowMap.renderList.indexOf(i)===-1&&this._shadowMap.renderList.push(i);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(i!==-1&&this._shadowMap.renderList.splice(i,1),t)for(const r of e.getChildren())this.removeShadowCaster(r);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,s,a=!1){this.onBeforeShadowMapRenderObservable=new Q,this.onAfterShadowMapRenderObservable=new Q,this.onBeforeShadowMapRenderMeshObservable=new Q,this.onAfterShadowMapRenderMeshObservable=new Q,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=et.FILTER_NONE,this._filteringQuality=et.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=m.Zero(),this._viewMatrix=O.Zero(),this._projectionMatrix=O.Zero(),this._transformMatrix=O.Zero(),this._cachedPosition=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=O.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!s,this._initShaderSourceAsync(a);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),et._SceneComponentInitialization(this._scene);const l=this._scene.getEngine().getCaps();i?l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new mr(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new mr(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=Z.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=Z.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(Z.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(r,s,a,o)=>this._renderForShadowMap(r,s,a,o),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var r;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(r=e._debugPushGroup)==null||r.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(r=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=r,this._filter===et.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var s,a;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===et.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){(s=e._debugPopGroup)==null||s.call(e,1);return}const r=this.getShadowMapForRendering();r&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,r.renderTarget,!0),e.unBindFramebuffer(r.renderTarget,!0)),(a=e._debugPopGroup)==null||a.call(e,1)});const t=new Be(0,0,0,0),i=new Be(1,1,1,1);this._shadowMap.onClearObservable.add(r=>{this._filter===et.FILTER_PCF?r.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?r.clear(t,!0,!0,!1):r.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(r=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=r.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let r=fr.MIN_RENDERINGGROUPS;r<fr.MAX_RENDERINGGROUPS;r++)this._shadowMap.setRenderingAutoClearDepthStencil(r,!1)}async _initShaderSourceAsync(e=!1){this._scene.getEngine().isWebGPU&&!e&&!et.ForceGLSL?(this._shaderLanguage=1,await Promise.all([re(()=>Promise.resolve().then(()=>rF),void 0),re(()=>Promise.resolve().then(()=>bF),void 0),re(()=>Promise.resolve().then(()=>PF),void 0),re(()=>Promise.resolve().then(()=>DF),void 0)])):await Promise.all([re(()=>Promise.resolve().then(()=>UF),void 0),re(()=>Promise.resolve().then(()=>a1),void 0),re(()=>Promise.resolve().then(()=>l1),void 0),re(()=>Promise.resolve().then(()=>u1),void 0)]),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new mr(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=Z.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=Z.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(Z.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new En(this._light.name+"KernelBlurX",new se(1,0),this.blurKernel,1,null,Z.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(i=>{i.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new En(this._light.name+"KernelBlurY",new se(0,1),this.blurKernel,1,null,Z.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Jt(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,Z.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",t,t),i.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,r){let s;if(r.length)for(s=0;s<r.length;s++)this._renderSubMeshForShadowMap(r.data[s]);for(s=0;s<e.length;s++)this._renderSubMeshForShadowMap(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMeshForShadowMap(t.data[s]);if(this._transparencyShadow)for(s=0;s<i.length;s++)this._renderSubMeshForShadowMap(i.data[s],!0);else for(s=0;s<i.length;s++)i.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var p;const i=e.getRenderingMesh(),r=e.getEffectiveMesh(),s=this._scene,a=s.getEngine(),o=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!o||e.verticesCount===0||e._renderId===s.getRenderId())return;const l=s.useRightHandedSystem,c=r._getWorldMatrixDeterminant()<0;let u=o._getEffectiveOrientation(i);(c&&!l||!c&&l)&&(u=u===0?1:0);const h=u===0;a.setState(o.backFaceCulling,void 0,void 0,h,o.cullBackFaces);const f=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(f.mustReturn)return;const d=a.getCaps().instancedArrays&&(f.visibleInstances[e._id]!==null&&f.visibleInstances[e._id]!==void 0||i.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,d,t)){e._renderId=s.getRenderId();const _=o.shadowDepthWrapper,g=(_==null?void 0:_.getEffect(e,this,a.currentRenderPassId))??e._getDrawWrapper(),E=ds.GetEffect(g);a.enableEffect(g),d||i._bind(e,E,o.fillMode),this.getTransformMatrix(),E.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Tt.LIGHTTYPEID_DIRECTIONALLIGHT?E.setVector3("lightDataSM",this._cachedDirection):E.setVector3("lightDataSM",this._cachedPosition);const v=this._getCamera();if(v&&E.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(v),this.getLight().getDepthMinZ(v)+this.getLight().getDepthMaxZ(v)),t&&this.enableSoftTransparentShadow&&E.setFloat2("softTransparentShadowSM",r.visibility*o.alpha,(p=this._opacityTexture)!=null&&p.getAlphaFromRGB?1:0),_)e._setMainDrawWrapperOverride(g),_.standalone?_.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):o.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(E.setTexture("diffuseSampler",this._opacityTexture),E.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const T=i.skeleton;if(T.isUsingTextureForMatrices){const C=T.getTransformMatrixTexture(i);if(!C)return;E.setTexture("boneSampler",C),E.setFloat("boneTextureWidth",4*(T.bones.length+1))}else E.setMatrices("mBones",T.getTransformMatrices(i))}cl(i,E),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(E);const A=e.getMesh().bakedVertexAnimationManager;A&&A.isEnabled&&A.bind(E,d),Sn(E,o,s)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,E,r),yp(E,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const x=r.getWorldMatrix();d&&(r.getMeshUniformBuffer().bindToEffect(E,"Mesh"),r.transferToEffect(x)),this.forceBackFacesOnly&&a.setState(!0,0,!1,!0,o.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(E),i._processRendering(r,e,E,o.fillMode,f,d,(A,T)=>{r!==i&&!A?(i.getMeshUniformBuffer().bindToEffect(E,"Mesh"),i.transferToEffect(T)):(r.getMeshUniformBuffer().bindToEffect(E,"Mesh"),r.transferToEffect(A?T:x))}),this.forceBackFacesOnly&&a.setState(!0,0,!1,!1,o.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(E),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===et.FILTER_NONE||this.filter===et.FILTER_PCSS?this._shadowMap.updateSamplingMode(Z.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(Z.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},r=this.getShadowMap();if(!r){e&&e(this);return}const s=r.renderList;if(!s){e&&e(this);return}const a=[];for(const c of s)a.push(...c.subMeshes);if(a.length===0){e&&e(this);return}let o=0;const l=()=>{var c;if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(a[o],i.useInstances,((c=a[o].getMaterial())==null?void 0:c.needAlphaBlendingForMesh(a[o].getMesh()))??!1);)if(o++,o>=a.length){e&&e(this);return}setTimeout(l,16)}};l()}forceCompilationAsync(e){return new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const s=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&s.isVerticesDataPresent(b.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Tt.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;const r=e.getMaterial(),s=r==null?void 0:r.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;const a=[];if(this._prepareShadowDefines(e,t,a,i),s){if(!s.isReadyForSubMesh(e,a,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const o=e._getDrawWrapper(void 0,!0);let l=o.effect,c=o.defines;const u=[b.PositionKind],h=e.getMesh();this.normalBias&&h.isVerticesDataPresent(b.NormalKind)&&(u.push(b.NormalKind),a.push("#define NORMAL"),h.nonUniformScaling&&a.push("#define NONUNIFORMSCALING"));const f=r.needAlphaTesting();if((f||r.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const v=r.alphaCutOff??et.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEXTURE"),f&&a.push(`#define ALPHATESTVALUE ${v}${v%1===0?".":""}`),h.isVerticesDataPresent(b.UVKind)&&(u.push(b.UVKind),a.push("#define UV1")),h.isVerticesDataPresent(b.UV2Kind)&&this._opacityTexture.coordinatesIndex===1&&(u.push(b.UV2Kind),a.push("#define UV2"))}const d=new co;if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){u.push(b.MatricesIndicesKind),u.push(b.MatricesWeightsKind),h.numBoneInfluencers>4&&(u.push(b.MatricesIndicesExtraKind),u.push(b.MatricesWeightsExtraKind));const v=h.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers),h.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,h),v.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(v.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");const p=h.morphTargetManager;let _=0;if(p&&(_=p.numMaxInfluencers||p.numInfluencers,_>0&&(a.push("#define MORPHTARGETS"),a.push("#define NUM_MORPH_INFLUENCERS "+_),p.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),zT(u,h,_))),xc(r,this._scene,a),t&&(a.push("#define INSTANCES"),ch(u),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const v of this.customShaderOptions.defines)a.indexOf(v)===-1&&a.push(v);const g=h.bakedVertexAnimationManager;g&&g.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&u.push("bakedVertexAnimationSettingsInstanced"));const E=a.join(`
`);if(c!==E){c=E;let v="shadowMap";const x=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],A=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],T=["Scene","Mesh"];if(Zn(x),this.customShaderOptions){if(v=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const y of this.customShaderOptions.attributes)u.indexOf(y)===-1&&u.push(y);if(this.customShaderOptions.uniforms)for(const y of this.customShaderOptions.uniforms)x.indexOf(y)===-1&&x.push(y);if(this.customShaderOptions.samplers)for(const y of this.customShaderOptions.samplers)A.indexOf(y)===-1&&A.push(y)}const C=this._scene.getEngine();l=C.createEffect(v,{attributes:u,uniformsNames:x,uniformBuffersNames:T,samplers:A,defines:E,fallbacks:d,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:_},shaderLanguage:this._shaderLanguage},C),o.setEffect(l,c)}if(!l.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,r=this._light;!i.shadowsEnabled||!r.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===et.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===et.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===et.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===et.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),r.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const a=this.getShadowMap();if(!a)return;i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());const o=this.getShadowMapForRendering();this._filter===et.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,e)):this._filter===et.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,o),t.setTexture("depthTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),m.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(m.Dot(this._lightDirection,m.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),O.LookAtLHToRef(t,t.add(this._lightDirection),m.Up(),this._viewMatrix);const i=this.getShadowMap();if(i){const r=i.renderList;r&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,r)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const i of t)this._shadowMap.renderList.push(i)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();t.done!==!0;t=e.next()){const[i,r]=t.value;r===this&&this._light._shadowGenerators.delete(i)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var i;const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=(i=this._camera)==null?void 0:i.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let r=0;r<t.renderList.length;r++){const s=t.renderList[r];e.renderList.push(s.id)}return e}static Parse(e,t,i){const r=t.getLightById(e.lightId),s=e.cameraId!==void 0?t.getCameraById(e.cameraId):null,a=i?i(e.mapSize,r,s):new et(e.mapSize,r,void 0,s),o=a.getShadowMap();for(let l=0;l<e.renderList.length;l++)t.getMeshesById(e.renderList[l]).forEach(function(u){o&&(o.renderList||(o.renderList=[]),o.renderList.push(u))});return e.id!==void 0&&(a.id=e.id),a.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&a.setDarkness(e.darkness),e.transparencyShadow&&a.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(a.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(a.bias=e.bias),e.normalBias!==void 0&&(a.normalBias=e.normalBias),e.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?a.useContactHardeningShadow=!0:e.usePoissonSampling?a.usePoissonSampling=!0:e.useExponentialShadowMap?a.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?a.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(a.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(a.filteringQuality=e.filteringQuality),e.depthScale&&(a.depthScale=e.depthScale),e.blurScale&&(a.blurScale=e.blurScale),e.blurBoxOffset&&(a.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(a.useKernelBlur=e.useKernelBlur),e.blurKernel&&(a.blurKernel=e.blurKernel),a}}et.CLASSNAME="ShadowGenerator";et.ForceGLSL=!1;et.FILTER_NONE=0;et.FILTER_EXPONENTIALSHADOWMAP=1;et.FILTER_POISSONSAMPLING=2;et.FILTER_BLUREXPONENTIALSHADOWMAP=3;et.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;et.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;et.FILTER_PCF=6;et.FILTER_PCSS=7;et.QUALITY_HIGH=0;et.QUALITY_MEDIUM=1;et.QUALITY_LOW=2;et.DEFAULT_ALPHA_CUTOFF=.5;et._SceneComponentInitialization=n=>{throw rt("ShadowGeneratorSceneComponent")};const KT="clipPlaneFragmentDeclaration",jT=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;V.IncludesShadersStore[KT]=jT;const QN={name:KT,shader:jT},JN=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneFragmentDeclaration:QN},Symbol.toStringTag,{value:"Module"})),qT="packingFunctions",ZT=`vec4 pack(float depth)
{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;V.IncludesShadersStore[qT]=ZT;const eL={name:qT,shader:ZT},tL=Object.freeze(Object.defineProperty({__proto__:null,packingFunctions:eL},Symbol.toStringTag,{value:"Module"})),QT="clipPlaneFragment",JT=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{discard;}
#endif
`;V.IncludesShadersStore[QT]=JT;const iL={name:QT,shader:JT},rL=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneFragment:iL},Symbol.toStringTag,{value:"Module"})),ex="depthPixelShader",tx=`#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;V.ShadersStore[ex]=tx;const sL={name:ex,shader:tx},nL=Object.freeze(Object.defineProperty({__proto__:null,depthPixelShader:sL},Symbol.toStringTag,{value:"Module"})),ix="bonesDeclaration",rx=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform highp sampler2D boneSampler;uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#endif
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}
#endif
#endif
#endif
`;V.IncludesShadersStore[ix]=rx;const aL={name:ix,shader:rx},oL=Object.freeze(Object.defineProperty({__proto__:null,bonesDeclaration:aL},Symbol.toStringTag,{value:"Module"})),lL="bakedVertexAnimationDeclaration",cL=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}
#endif
`;V.IncludesShadersStore[lL]=cL;const sx="morphTargetsVertexGlobalDeclaration",nx=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}
#endif
#endif
`;V.IncludesShadersStore[sx]=nx;const uL={name:sx,shader:nx},hL=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexGlobalDeclaration:uL},Symbol.toStringTag,{value:"Module"})),ax="morphTargetsVertexDeclaration",ox=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#elif {X}==0
uniform int morphTargetCount;
#endif
#endif
`;V.IncludesShadersStore[ax]=ox;const fL={name:ax,shader:ox},dL=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexDeclaration:fL},Symbol.toStringTag,{value:"Module"})),lx="clipPlaneVertexDeclaration",cx=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;varying float fClipDistance6;
#endif
`;V.IncludesShadersStore[lx]=cx;const pL={name:lx,shader:cx},_L=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneVertexDeclaration:pL},Symbol.toStringTag,{value:"Module"})),mL="instancesDeclaration",gL=`#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform mat4 previousWorld;
#endif
#endif
`;V.IncludesShadersStore[mL]=gL;const EL="pointCloudVertexDeclaration",vL=`#ifdef POINTSIZE
uniform float pointSize;
#endif
`;V.IncludesShadersStore[EL]=vL;const ux="morphTargetsVertexGlobal",hx=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;V.IncludesShadersStore[ux]=hx;const SL={name:ux,shader:hx},TL=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexGlobal:SL},Symbol.toStringTag,{value:"Module"})),fx="morphTargetsVertex",dx=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (int i=0; i<NUM_MORPH_INFLUENCERS; i++) {if (i>=morphTargetCount) break;vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;positionUpdated+=(readVector3FromRawSampler(i,vertexID)-position)*morphTargetInfluences[i];vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler(i,vertexID) -normal)*morphTargetInfluences[i];vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler(i,vertexID).xy-uv)*morphTargetInfluences[i];vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler(i,vertexID) -tangent.xyz)*morphTargetInfluences[i];
#endif
}
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;V.IncludesShadersStore[fx]=dx;const xL={name:fx,shader:dx},CL=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertex:xL},Symbol.toStringTag,{value:"Module"})),AL="instancesVertex",IL=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,
previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;V.IncludesShadersStore[AL]=IL;const px="bonesVertex",_x=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;V.IncludesShadersStore[px]=_x;const yL={name:px,shader:_x},bL=Object.freeze(Object.defineProperty({__proto__:null,bonesVertex:yL},Symbol.toStringTag,{value:"Module"})),RL="bakedVertexAnimation",PL=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;V.IncludesShadersStore[RL]=PL;const mx="clipPlaneVertex",gx=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;V.IncludesShadersStore[mx]=gx;const ML={name:mx,shader:gx},DL=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneVertex:ML},Symbol.toStringTag,{value:"Module"})),OL="pointCloudVertex",NL=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;V.IncludesShadersStore[OL]=NL;const Ex="depthVertexShader",vx=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform mat4 view;varying vec4 vViewPos;
#endif
#include<pointCloudVertexDeclaration>
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vViewPos=view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<pointCloudVertex>
}
`;V.ShadersStore[Ex]=vx;const LL={name:Ex,shader:vx},FL=Object.freeze(Object.defineProperty({__proto__:null,depthVertexShader:LL},Symbol.toStringTag,{value:"Module"}));class Jo{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,s=Z.TRILINEAR_SAMPLINGMODE,a=!1,o){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=a,this.isPacked=t===0,this.isPacked?this.clearColor=new Be(1,1,1,1):this.clearColor=new Be(a?1e8:1,0,0,1),this._initShaderSourceAsync(),Jo._SceneComponentInitialization(this._scene);const l=e.getEngine();this._camera=i,s!==Z.NEAREST_SAMPLINGMODE&&(t===1&&!l._caps.textureFloatLinearFiltering&&(s=Z.NEAREST_SAMPLINGMODE),t===2&&!l._caps.textureHalfFloatLinearFiltering&&(s=Z.NEAREST_SAMPLINGMODE));const c=this.isPacked||!l._features.supportExtendedTextureFormats?5:6;this._depthMap=new mr(o??"DepthRenderer",{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,t,!1,s,void 0,void 0,void 0,c),this._depthMap.wrapU=Z.CLAMP_ADDRESSMODE,this._depthMap.wrapV=Z.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(h=>{h.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var h;(h=l._debugPushGroup)==null||h.call(l,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var h;(h=l._debugPopGroup)==null||h.call(l,1)}),this._depthMap.customIsReadyFunction=(h,f,d)=>{if((d||f===0)&&h.subMeshes)for(let p=0;p<h.subMeshes.length;++p){const _=h.subMeshes[p],g=_.getRenderingMesh(),E=g._getInstancesRenderList(_._id,!!_.getReplacementMesh()),v=l.getCaps().instancedArrays&&(E.visibleInstances[_._id]!==null&&E.visibleInstances[_._id]!==void 0||g.hasThinInstances);if(!this.isReady(_,v))return!1}return!0};const u=h=>{var y;const f=h.getRenderingMesh(),d=h.getEffectiveMesh(),p=this._scene,_=p.getEngine(),g=h.getMaterial();if(d._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!g||d.infiniteDistance||g.disableDepthWrite||h.verticesCount===0||h._renderId===p.getRenderId())return;const E=d._getWorldMatrixDeterminant()<0;let v=g._getEffectiveOrientation(f);E&&(v=v===0?1:0);const x=v===0;_.setState(g.backFaceCulling,0,!1,x,this.reverseCulling?!g.cullBackFaces:g.cullBackFaces);const A=f._getInstancesRenderList(h._id,!!h.getReplacementMesh());if(A.mustReturn)return;const T=_.getCaps().instancedArrays&&(A.visibleInstances[h._id]!==null&&A.visibleInstances[h._id]!==void 0||f.hasThinInstances),C=this._camera||p.activeCamera;if(this.isReady(h,T)&&C){h._renderId=p.getRenderId();const P=(y=d._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:y[_.currentRenderPassId];let D=h._getDrawWrapper();!D&&P&&(D=P._getDrawWrapper());const F=C.mode===He.ORTHOGRAPHIC_CAMERA;if(!D)return;const W=D.effect;_.enableEffect(D),T||f._bind(h,W,g.fillMode),P?P.bindForSubMesh(d.getWorldMatrix(),d,h):(W.setMatrix("viewProjection",p.getTransformMatrix()),W.setMatrix("world",d.getWorldMatrix()),this._storeCameraSpaceZ&&W.setMatrix("view",p.getViewMatrix()));let H,ue;if(F?(H=!_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1,ue=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1):(H=_.useReverseDepthBuffer&&_.isNDCHalfZRange?C.minZ:_.isNDCHalfZRange?0:C.minZ,ue=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:C.maxZ),W.setFloat2("depthValues",H,H+ue),!P){if(g.needAlphaTesting()){const le=g.getAlphaTestTexture();le&&(W.setTexture("diffuseSampler",le),W.setMatrix("diffuseMatrix",le.getTextureMatrix()))}ul(f,W),Sn(W,g,p),cl(f,W),f.morphTargetManager&&f.morphTargetManager.isUsingTextureForTargets&&f.morphTargetManager._bind(W);const ae=h.getMesh().bakedVertexAnimationManager;ae&&ae.isEnabled&&ae.bind(W,T),g.pointsCloud&&W.setFloat("pointSize",g.pointSize)}f._processRendering(d,h,W,g.fillMode,A,T,(ae,le)=>W.setMatrix("world",le))}};this._depthMap.customRenderFunction=(h,f,d,p)=>{let _;if(p.length)for(_=0;_<p.length;_++)u(p.data[_]);for(_=0;_<h.length;_++)u(h.data[_]);for(_=0;_<f.length;_++)u(f.data[_]);if(this.forceDepthWriteTransparentMeshes)for(_=0;_<d.length;_++)u(d.data[_]);else for(_=0;_<d.length;_++)d.data[_].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){this._scene.getEngine().isWebGPU&&!e&&!Jo.ForceGLSL?(this._shaderLanguage=1,await Promise.all([re(()=>import("./depth.vertex-opnJbTfP.js"),[]),re(()=>import("./depth.fragment-BYht4XRQ.js"),[])])):await Promise.all([re(()=>Promise.resolve().then(()=>FL),void 0),re(()=>Promise.resolve().then(()=>nL),void 0)]),this._shadersLoaded=!0}isReady(e,t){var E;if(!this._shadersLoaded)return!1;const i=this._scene.getEngine(),r=e.getMesh(),s=r.getScene(),a=(E=r._internalAbstractMeshDataInfo._materialForRenderPass)==null?void 0:E[i.currentRenderPassId];if(a)return a.isReadyForSubMesh(r,e,t);const o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;const l=[],c=[b.PositionKind];o.needAlphaTesting()&&o.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),r.isVerticesDataPresent(b.UVKind)&&(c.push(b.UVKind),l.push("#define UV1")),r.isVerticesDataPresent(b.UV2Kind)&&(c.push(b.UV2Kind),l.push("#define UV2")));const u=new co;if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){c.push(b.MatricesIndicesKind),c.push(b.MatricesWeightsKind),r.numBoneInfluencers>4&&(c.push(b.MatricesIndicesExtraKind),c.push(b.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),r.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,r);const v=r.skeleton;v.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(v.bones.length+1))}else l.push("#define NUM_BONE_INFLUENCERS 0");const h=r.morphTargetManager;let f=0;h&&(f=h.numMaxInfluencers||h.numInfluencers,f>0&&(l.push("#define MORPHTARGETS"),l.push("#define NUM_MORPH_INFLUENCERS "+f),h.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),zT(c,r,f))),o.pointsCloud&&l.push("#define POINTSIZE"),t&&(l.push("#define INSTANCES"),ch(c),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES"));const d=r.bakedVertexAnimationManager;d&&d.isEnabled&&(l.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&c.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&l.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&l.push("#define PACKED"),xc(o,s,l);const p=e._getDrawWrapper(void 0,!0),_=p.defines,g=l.join(`
`);if(_!==g){const v=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],x=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];Zn(v),p.setEffect(i.createEffect("depth",{attributes:c,uniformsNames:v,uniformBuffersNames:[],samplers:x,defines:g,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:f},shaderLanguage:this._shaderLanguage},i))}return p.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}Jo.ForceGLSL=!1;Jo._SceneComponentInitialization=n=>{throw rt("DepthRendererSceneComponent")};const wL="minmaxReduxPixelShader",BL=`varying vec2 vUV;uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(MAIN)
uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(LAST)
void main(void)
{glFragColor=vec4(0.);if (true) { 
discard;}}
#endif
`;V.ShadersStore[wL]=BL;class VL{constructor(e){this.onAfterReductionPerformed=new Q,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new Pu(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;const s=this._camera.getScene(),a=new Jt("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,s.getEngine(),!1,"#define INITIAL"+(t?`
#define DEPTH_REDUX`:""),i,void 0,void 0,void 0,7);a.autoClear=!1,a.forceFullscreenViewport=r;let o=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();a.onApply=((u,h)=>f=>{f.setTexture("sourceTexture",this._sourceTexture),f.setFloat2("texSize",u,h)})(o,l),this._reductionSteps.push(a);let c=1;for(;o>1||l>1;){o=Math.max(Math.round(o/2),1),l=Math.max(Math.round(l/2),1);const u=new Jt("Reduction phase "+c,"minmaxRedux",["texSize"],null,{width:o,height:l},null,1,s.getEngine(),!1,"#define "+(o==1&&l==1?"LAST":o==1||l==1?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(u.autoClear=!1,u.forceFullscreenViewport=r,u.onApply=((h,f)=>d=>{h==1||f==1?d.setInt2("texSize",h,f):d.setFloat2("texSize",h,f)})(o,l),this._reductionSteps.push(u),c++,o==1&&l==1){const h=(f,d,p)=>{const _=new Float32Array(4*f*d),g={min:0,max:0};return()=>{s.getEngine()._readTexturePixels(p.inputTexture.texture,f,d,-1,0,_,!1),g.min=_[0],g.max=_[1],this.onAfterReductionPerformed.notifyObservers(g)}};u.onAfterRenderObservable.add(h(o,l,u))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var t,i;const e=this._camera.getScene().getEngine();(t=e._debugPushGroup)==null||t.call(e,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),e.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),(i=e._debugPopGroup)==null||i.call(e,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class UL extends VL{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(r._depthRenderer||(r._depthRenderer={}),e=this._depthRenderer=new Jo(r,t,this._camera,!1,1),e.enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const oE=m.Up(),kL=m.Zero(),ji=new m,To=new m,jc=new O;class or extends et{_validateFilter(e){return e===et.FILTER_NONE||e===et.FILTER_PCF||e===et.FILTER_PCSS?e:(w.Error('Unsupported filter "'+e+'"!'),et.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){e=Math.min(Math.max(e,or.MIN_CASCADES_COUNT),or.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){const r=e[i];if(!r)continue;const s=r.getBoundingInfo(),a=s.boundingBox;this._scbiMin.minimizeInPlace(a.minimumWorld),this._scbiMax.maximizeInPlace(a.maximumWorld)}const t=this._scene.meshes;for(let i=0;i<t.length;i++){const r=t[i];if(!r||!r.isVisible||!r.isEnabled||!r.receiveShadows)continue;const s=r.getBoundingInfo(),a=s.boundingBox;this._scbiMin.minimizeInPlace(a.minimumWorld),this._scbiMax.maximizeInPlace(a.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return or.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&t.maxZ!==0||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new UL(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let r=i.min,s=i.max;r>=s&&(r=0,s=1),(r!=this._minDistance||s!=this._maxDistance)&&this.setMinMaxDistance(r,s)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t;return((t=(e=this._depthReducer)==null?void 0:e.depthRenderer)==null?void 0:t.getDepthMap().refreshRate)??-1}set autoCalcDepthBoundsRefreshRate(e){var t;(t=this._depthReducer)!=null&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,r=i-t,s=this._minDistance,a=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,o=t+s*r,l=t+a*r,c=l-o,u=l/o;for(let h=0;h<this._cascades.length;++h){const f=(h+1)/this._numCascades,d=o*u**f,p=o+c*f,_=this._lambda*(d-p)+p;this._cascades[h].prevBreakDistance=h===0?s:this._cascades[h-1].breakDistance,this._cascades[h].breakDistance=(_-t)/r,this._viewSpaceFrustumsZ[h]=_,this._frustumLengths[h]=(this._cascades[h].breakDistance-this._cascades[h].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;m.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(m.Dot(this._lightDirection,m.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const i=e.getEngine().useReverseDepthBuffer;for(let r=0;r<this._numCascades;++r){this._computeFrustumInWorldSpace(r),this._computeCascadeFrustum(r),this._cascadeMaxExtents[r].subtractToRef(this._cascadeMinExtents[r],ji),this._frustumCenter[r].addToRef(this._lightDirection.scale(this._cascadeMinExtents[r].z),this._shadowCameraPos[r]),O.LookAtLHToRef(this._shadowCameraPos[r],this._frustumCenter[r],oE,this._viewMatrices[r]);let s=0,a=ji.z;const o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[r]),a=Math.min(a,o.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===et.FILTER_PCSS?s=Math.min(s,o.boundingBox.minimumWorld.z):s=Math.max(s,o.boundingBox.minimumWorld.z),O.OrthoOffCenterLHToRef(this._cascadeMinExtents[r].x,this._cascadeMaxExtents[r].x,this._cascadeMinExtents[r].y,this._cascadeMaxExtents[r].y,i?a:s,i?s:a,this._projectionMatrices[r],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[r].z=s,this._cascadeMaxExtents[r].z=a,this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),m.TransformCoordinatesToRef(kL,this._transformMatrices[r],ji),ji.scaleInPlace(this._mapSize/2),To.copyFromFloats(Math.round(ji.x),Math.round(ji.y),Math.round(ji.z)),To.subtractInPlace(ji).scaleInPlace(2/this._mapSize),O.TranslationToRef(To.x,To.y,0,jc),this._projectionMatrices[r].multiplyToRef(jc,this._projectionMatrices[r]),this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),this._transformMatrices[r].copyToArray(this._transformMatricesAsArray,r*16)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const a=t.maxZ===0,o=t.maxZ;a&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const l=O.Invert(t.getTransformationMatrix());a&&(t.maxZ=o,t.getProjectionMatrix(!0));const c=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let u=0;u<or._FrustumCornersNDCSpace.length;++u)ji.copyFrom(or._FrustumCornersNDCSpace[(u+c)%or._FrustumCornersNDCSpace.length]),s&&ji.z===-1&&(ji.z=0),m.TransformCoordinatesToRef(ji,l,this._frustumCornersWorldSpace[e][u]);for(let u=0;u<or._FrustumCornersNDCSpace.length/2;++u)ji.copyFrom(this._frustumCornersWorldSpace[e][u+4]).subtractInPlace(this._frustumCornersWorldSpace[e][u]),To.copyFrom(ji).scaleInPlace(i),ji.scaleInPlace(r),ji.addInPlace(this._frustumCornersWorldSpace[e][u]),this._frustumCornersWorldSpace[e][u+4].copyFrom(ji),this._frustumCornersWorldSpace[e][u].addInPlace(To)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),!!this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r){const s=this._frustumCornersWorldSpace[e][r].subtractToRef(this._frustumCenter[e],ji).length();i=Math.max(i,s)}i=Math.ceil(i*16)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{const i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,ji),O.LookAtLHToRef(i,ji,oE,jc);for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r)m.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][r],jc,ji),this._cascadeMinExtents[e].minimizeInPlace(ji),this._cascadeMaxExtents[e].maximizeInPlace(ji)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=$e.LastCreatedEngine;return e?e._features.supportCSM:!1}constructor(e,t,i,r,s=!0){if(!or.IsSupported){w.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i,r,s),this.usePercentageCloserFiltering=!0}_initializeGenerator(){var e;this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??or.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new m(0,0,0),this._scbiMax=this._scbiMax??new m(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new Jr(new m(0,0,0),new m(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??((e=this._getCamera())==null?void 0:e.maxZ)??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new mr(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=O.Zero(),this._projectionMatrices[t]=O.Zero(),this._transformMatrices[t]=O.Zero(),this._cascadeMinExtents[t]=new m,this._cascadeMaxExtents[t]=new m,this._frustumCenter[t]=new m,this._shadowCameraPos[t]=new m,this._frustumCornersWorldSpace[t]=new Array(or._FrustumCornersNDCSpace.length);for(let i=0;i<or._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new m}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===et.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(t=e._debugPushGroup)==null||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==et.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const s=this._getCamera();s&&this._shadowMaxZ<=(s.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const a=this.getShadowMap();if(!a)return;const o=a.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===et.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);else if(this._filter===et.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[l*2+0]=l===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[l*2+1]=l===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=l===0?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,a),t.setTexture("depthTexture"+e,a),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o,this._contactHardeningLightSizeUVRatio*o,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){const i=et.Parse(e,t,(r,s,a)=>new or(r,s,void 0,a));return e.numCascades!==void 0&&(i.numCascades=e.numCascades),e.debug!==void 0&&(i.debug=e.debug),e.stabilizeCascades!==void 0&&(i.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(i.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(i.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(i.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(i.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}or._FrustumCornersNDCSpace=[new m(-1,1,-1),new m(1,1,-1),new m(1,-1,-1),new m(-1,-1,-1),new m(-1,1,1),new m(1,1,1),new m(1,-1,1),new m(-1,-1,1)];or.CLASSNAME="CascadedShadowGenerator";or.DEFAULT_CASCADES_COUNT=4;or.MIN_CASCADES_COUNT=2;or.MAX_CASCADES_COUNT=4;or._SceneComponentInitialization=n=>{throw rt("ShadowGeneratorSceneComponent")};const fu={},pd={};function Lp(n,e){fu[n]=e}function GL(n,e){pd[n]=e}function Sx(n){return pd[n]?pd[n]:null}function zL(n,e,t,i){for(const r in fu)Object.prototype.hasOwnProperty.call(fu,r)&&fu[r](n,e,t,i)}Lp(we.NAME_SHADOWGENERATOR,(n,e)=>{if(n.shadowGenerators!==void 0&&n.shadowGenerators!==null)for(let t=0,i=n.shadowGenerators.length;t<i;t++){const r=n.shadowGenerators[t];r.className===or.CLASSNAME?or.Parse(r,e):et.Parse(r,e)}});class WL{constructor(e){this.name=we.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(we.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const r=i.getShadowGenerators();if(r){const s=r.values();for(let a=s.next();a.done!==!0;a=s.next()){const o=a.value;e.shadowGenerators.push(o.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const r=t.lights[i],s=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&s){const a=s.values();for(let o=a.next();o.done!==!0;o=a.next()){const c=o.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}}et._SceneComponentInitialization=n=>{let e=n._getComponent(we.NAME_SHADOWGENERATOR);e||(e=new WL(n),n._addComponent(e))};const Tx="packingFunctions",xx=`fn pack(depth: f32)->vec4f
{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;V.IncludesShadersStoreWGSL[Tx]=xx;const HL={name:Tx,shader:xx},XL=Object.freeze(Object.defineProperty({__proto__:null,packingFunctionsWGSL:HL},Symbol.toStringTag,{value:"Module"})),YL="bayerDitherFunctions",$L=`fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}
fn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5*((_P)%(4.0))); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
fn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5 *((_P)%(4.0))); 
var P4: vec2f=floor(0.25*((_P)%(8.0))); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;V.IncludesShadersStoreWGSL[YL]=$L;const KL="shadowMapFragmentExtraDeclaration",jL=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform softTransparentShadowSM: vec2f;
#endif
varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
uniform lightDataSM: vec3f;varying vPositionWSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;V.IncludesShadersStoreWGSL[KL]=jL;const Cx="clipPlaneFragmentDeclaration",Ax=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;V.IncludesShadersStoreWGSL[Cx]=Ax;const qL={name:Cx,shader:Ax},ZL=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneFragmentDeclarationWGSL:qL},Symbol.toStringTag,{value:"Module"})),Ix="clipPlaneFragment",yx=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fragmentInputs.fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fragmentInputs.fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fragmentInputs.fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fragmentInputs.fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fragmentInputs.fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fragmentInputs.fClipDistance6>0.0)
{discard;}
#endif
`;V.IncludesShadersStoreWGSL[Ix]=yx;const QL={name:Ix,shader:yx},JL=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneFragmentWGSL:QL},Symbol.toStringTag,{value:"Module"})),bx="shadowMapFragment",Rx=`var depthSM: f32=fragmentInputs.vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
depthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
fragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
fragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
fragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);
#else
fragmentOutputs.color=pack(depthSM);
#endif
`;V.IncludesShadersStoreWGSL[bx]=Rx;const eF={name:bx,shader:Rx},tF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapFragmentWGSL:eF},Symbol.toStringTag,{value:"Module"})),Px="shadowMapPixelShader",Mx=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
var opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;
#if SM_SOFTTRANSPARENTSHADOW==1
if (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}
#endif
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}
#else
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} 
#endif
#endif
#include<shadowMapFragment>
}`;V.ShadersStoreWGSL[Px]=Mx;const iF={name:Px,shader:Mx},rF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapPixelShaderWGSL:iF},Symbol.toStringTag,{value:"Module"})),Dx="bonesDeclaration",Ox=`#if NUM_BONE_INFLUENCERS>0
attribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;
#if NUM_BONE_INFLUENCERS>4
attribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
var boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;
#else
uniform mBones : array<mat4x4,BonesPerMesh>;
#ifdef BONES_VELOCITY_ENABLED
uniform mPreviousBones : array<mat4x4,BonesPerMesh>;
#endif
#endif
#ifdef BONETEXTURE
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[Dx]=Ox;const sF={name:Dx,shader:Ox},nF=Object.freeze(Object.defineProperty({__proto__:null,bonesDeclarationWGSL:sF},Symbol.toStringTag,{value:"Module"})),Nx="morphTargetsVertexGlobalDeclaration",Lx=`#ifdef MORPHTARGETS
uniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;
#ifdef MORPHTARGETS_TEXTURE 
uniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}
#endif
#endif
`;V.IncludesShadersStoreWGSL[Nx]=Lx;const aF={name:Nx,shader:Lx},oF=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexGlobalDeclarationWGSL:aF},Symbol.toStringTag,{value:"Module"})),Fx="morphTargetsVertexDeclaration",wx=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute position{X} : vec3<f32>;
#ifdef MORPHTARGETS_NORMAL
attribute normal{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_TANGENT
attribute tangent{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_UV
attribute uv_{X} : vec2<f32>;
#endif
#elif {X}==0
uniform morphTargetCount: i32;
#endif
#endif
`;V.IncludesShadersStoreWGSL[Fx]=wx;const lF={name:Fx,shader:wx},cF=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexDeclarationWGSL:lF},Symbol.toStringTag,{value:"Module"})),uF="shadowMapVertexExtraDeclaration",hF=`#if SM_NORMALBIAS==1
uniform lightDataSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
varying vPositionWSM: vec3f;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;V.IncludesShadersStoreWGSL[uF]=hF;const Bx="clipPlaneVertexDeclaration",Vx=`#ifdef CLIPPLANE
uniform vClipPlane: vec4<f32>;varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
uniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
uniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
uniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
uniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
uniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;
#endif
`;V.IncludesShadersStoreWGSL[Bx]=Vx;const fF={name:Bx,shader:Vx},dF=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneVertexDeclarationWGSL:fF},Symbol.toStringTag,{value:"Module"})),Ux="morphTargetsVertexGlobal",kx=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
var vertexID : f32;
#endif
#endif
`;V.IncludesShadersStoreWGSL[Ux]=kx;const pF={name:Ux,shader:kx},_F=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexGlobalWGSL:pF},Symbol.toStringTag,{value:"Module"})),Gx="morphTargetsVertex",zx=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=uniforms.morphTargetCount) {break;}
vertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;positionUpdated=positionUpdated+(readVector3FromRawSampler(i,vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[i];vertexID=vertexID+1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(readVector3FromRawSampler(i,vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[i];vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[i];vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated=vec4f(tangentUpdated.xyz+(readVector3FromRawSampler(i,vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[i],tangentUpdated.a);
#endif
}
#endif
#else
positionUpdated=positionUpdated+(vertexInputs.position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(vertexInputs.normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated=vec4f(tangentUpdated.xyz+(vertexInputs.tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}],tangentUpdated.a);
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(vertexInputs.uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[Gx]=zx;const mF={name:Gx,shader:zx},gF=Object.freeze(Object.defineProperty({__proto__:null,morphTargetsVertexWGSL:mF},Symbol.toStringTag,{value:"Module"})),Wx="bonesVertex",Hx=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];
#endif 
#else 
influence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif 
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;V.IncludesShadersStoreWGSL[Wx]=Hx;const EF={name:Wx,shader:Hx},vF=Object.freeze(Object.defineProperty({__proto__:null,bonesVertexWGSL:EF},Symbol.toStringTag,{value:"Module"})),SF="shadowMapVertexNormalBias",TF=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
var worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);
#else
var directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);
#endif
var ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);
#endif
`;V.IncludesShadersStoreWGSL[SF]=TF;const Xx="shadowMapVertexMetric",Yx=`#if SM_USEDISTANCE==1
vertexOutputs.vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;
#else
vertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
vertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
vertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
`;V.IncludesShadersStoreWGSL[Xx]=Yx;const xF={name:Xx,shader:Yx},CF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapVertexMetricWGSL:xF},Symbol.toStringTag,{value:"Module"})),$x="clipPlaneVertex",Kx=`#ifdef CLIPPLANE
vertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);
#endif
#ifdef CLIPPLANE2
vertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);
#endif
#ifdef CLIPPLANE3
vertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);
#endif
#ifdef CLIPPLANE4
vertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);
#endif
#ifdef CLIPPLANE5
vertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);
#endif
#ifdef CLIPPLANE6
vertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);
#endif
`;V.IncludesShadersStoreWGSL[$x]=Kx;const AF={name:$x,shader:Kx},IF=Object.freeze(Object.defineProperty({__proto__:null,clipPlaneVertexWGSL:AF},Symbol.toStringTag,{value:"Module"})),jx="shadowMapVertexShader",qx=`attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;
#endif
#include<helperFunctions>
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#ifdef ALPHATEXTURE
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef NORMAL
var normalUpdated: vec3f=input.normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#ifdef NORMAL
var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
var vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
var vNormalW: vec3f=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
vertexOutputs.position=scene.viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
#include<clipPlaneVertex>
}`;V.ShadersStoreWGSL[jx]=qx;const yF={name:jx,shader:qx},bF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapVertexShaderWGSL:yF},Symbol.toStringTag,{value:"Module"})),Zx="depthBoxBlurPixelShader",Qx=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}
fragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}`;V.ShadersStoreWGSL[Zx]=Qx;const RF={name:Zx,shader:Qx},PF=Object.freeze(Object.defineProperty({__proto__:null,depthBoxBlurPixelShaderWGSL:RF},Symbol.toStringTag,{value:"Module"})),Jx="shadowMapFragmentSoftTransparentShadow",eC=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}
#endif
`;V.IncludesShadersStoreWGSL[Jx]=eC;const MF={name:Jx,shader:eC},DF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapFragmentSoftTransparentShadowWGSL:MF},Symbol.toStringTag,{value:"Module"})),OF="bayerDitherFunctions",NF=`float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}
float bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
float bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;V.IncludesShadersStore[OF]=NF;const LF="shadowMapFragmentExtraDeclaration",FF=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform vec2 softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;V.IncludesShadersStore[LF]=FF;const tC="shadowMapFragment",iC=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;V.IncludesShadersStore[tC]=iC;const wF={name:tC,shader:iC},BF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapFragment:wF},Symbol.toStringTag,{value:"Module"})),rC="shadowMapPixelShader",sC=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
vec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;
#if SM_SOFTTRANSPARENTSHADOW==1
if (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}
#endif
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;
#endif
#endif
#include<shadowMapFragment>
}`;V.ShadersStore[rC]=sC;const VF={name:rC,shader:sC},UF=Object.freeze(Object.defineProperty({__proto__:null,shadowMapPixelShader:VF},Symbol.toStringTag,{value:"Module"})),nC="helperFunctions",aC=`const float PI=3.1415926535897932384626433832795;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
`;V.IncludesShadersStore[nC]=aC;const kF={name:nC,shader:aC},oC=Object.freeze(Object.defineProperty({__proto__:null,helperFunctions:kF},Symbol.toStringTag,{value:"Module"})),GF="sceneVertexDeclaration",zF=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;V.IncludesShadersStore[GF]=zF;const WF="meshVertexDeclaration",HF=`uniform mat4 world;uniform float visibility;
`;V.IncludesShadersStore[WF]=HF;const XF="shadowMapVertexDeclaration",YF=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;V.IncludesShadersStore[XF]=YF;const $F="sceneUboDeclaration",KF=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;V.IncludesShadersStore[$F]=KF;const jF="meshUboDeclaration",qF=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;V.IncludesShadersStore[jF]=qF;const ZF="shadowMapUboDeclaration",QF=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;V.IncludesShadersStore[ZF]=QF;const JF="shadowMapVertexExtraDeclaration",e1=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;V.IncludesShadersStore[JF]=e1;const t1="shadowMapVertexNormalBias",i1=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;V.IncludesShadersStore[t1]=i1;const lC="shadowMapVertexMetric",cC=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;V.IncludesShadersStore[lC]=cC;const r1={name:lC,shader:cC},s1=Object.freeze(Object.defineProperty({__proto__:null,shadowMapVertexMetric:r1},Symbol.toStringTag,{value:"Module"})),uC="shadowMapVertexShader",hC=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;V.ShadersStore[uC]=hC;const n1={name:uC,shader:hC},a1=Object.freeze(Object.defineProperty({__proto__:null,shadowMapVertexShader:n1},Symbol.toStringTag,{value:"Module"})),fC="depthBoxBlurPixelShader",dC=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}`;V.ShadersStore[fC]=dC;const o1={name:fC,shader:dC},l1=Object.freeze(Object.defineProperty({__proto__:null,depthBoxBlurPixelShader:o1},Symbol.toStringTag,{value:"Module"})),pC="shadowMapFragmentSoftTransparentShadow",_C=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;
#endif
`;V.IncludesShadersStore[pC]=_C;const c1={name:pC,shader:_C},u1=Object.freeze(Object.defineProperty({__proto__:null,shadowMapFragmentSoftTransparentShadow:c1},Symbol.toStringTag,{value:"Module"}));Lt.AddNodeConstructor("Light_Type_1",(n,e)=>()=>new Tn(n,m.Zero(),e));class Tn extends lo{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return Tt.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&O.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const u=m.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let h=Number.MAX_VALUE,f=-Number.MAX_VALUE;for(let d=0;d<i.length;d++){const p=i[d];if(!p)continue;const g=p.getBoundingInfo().boundingBox;for(let E=0;E<g.vectorsWorld.length;E++)m.TransformCoordinatesToRef(g.vectorsWorld[E],t,u),u.x<this._orthoLeft&&(this._orthoLeft=u.x),u.y<this._orthoBottom&&(this._orthoBottom=u.y),u.x>this._orthoRight&&(this._orthoRight=u.x),u.y>this._orthoTop&&(this._orthoTop=u.y),this.autoCalcShadowZBounds&&(u.z<h&&(h=u.z),u.z>f&&(f=u.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=h,this._shadowMaxZ=f)}const s=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;O.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}I([M()],Tn.prototype,"shadowFrustumSize",null);I([M()],Tn.prototype,"shadowOrthoScale",null);I([M()],Tn.prototype,"autoUpdateExtends",void 0);I([M()],Tn.prototype,"autoCalcShadowZBounds",void 0);I([M("orthoLeft")],Tn.prototype,"_orthoLeft",void 0);I([M("orthoRight")],Tn.prototype,"_orthoRight",void 0);I([M("orthoTop")],Tn.prototype,"_orthoTop",void 0);I([M("orthoBottom")],Tn.prototype,"_orthoBottom",void 0);$("BABYLON.DirectionalLight",Tn);Lt.AddNodeConstructor("Light_Type_3",(n,e)=>()=>new Ic(n,m.Zero(),e));class Ic extends Tt{constructor(e,t,i){super(e,i),this.groundColor=new fe(0,0,0),this.direction=t||m.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(m.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=m.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=m.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=O.Identity()),this._worldMatrix}getTypeID(){return Tt.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}I([hi()],Ic.prototype,"groundColor",void 0);I([Ar()],Ic.prototype,"direction",void 0);$("BABYLON.HemisphericLight",Ic);Lt.AddNodeConstructor("Light_Type_0",(n,e)=>()=>new mh(n,m.Zero(),e));class mh extends lo{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Tt.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new m(1,0,0);case 1:return new m(-1,0,0);case 2:return new m(0,-1,0);case 3:return new m(0,1,0);case 4:return new m(0,0,1);case 5:return new m(0,0,-1)}return m.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;const s=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;O.PerspectiveFovLHToRef(this.shadowAngle,1,o?a:s,o?s:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}I([M()],mh.prototype,"shadowAngle",null);$("BABYLON.PointLight",mh);Lt.AddNodeConstructor("Light_Type_2",(n,e)=>()=>new bs(n,m.Zero(),m.Zero(),0,0,e));class bs extends lo{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(bs._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):bs._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,s,a){super(e,a),this._innerAngle=0,this._projectionTextureMatrix=O.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=m.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=m.Zero(),this._projectionTextureViewLightMatrix=O.Zero(),this._projectionTextureProjectionLightMatrix=O.Zero(),this._projectionTextureScalingMatrix=O.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=s}getClassName(){return"SpotLight"}getTypeID(){return Tt.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;const s=this._shadowAngleScale*this._angle,a=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;O.PerspectiveFovLHToRef(s,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),O.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,s=1/Math.tan(this._angle/2);O.FromValuesToRef(s/1,0,0,0,0,s,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof Z){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;O.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=m.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=m.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=m.Normalize(this.transformedDirection):i=m.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}I([M()],bs.prototype,"angle",null);I([M()],bs.prototype,"innerAngle",null);I([M()],bs.prototype,"shadowAngleScale",null);I([M()],bs.prototype,"exponent",void 0);I([M()],bs.prototype,"projectionTextureLightNear",null);I([M()],bs.prototype,"projectionTextureLightFar",null);I([M()],bs.prototype,"projectionTextureUpDirection",null);I([Rt("projectedLightTexture")],bs.prototype,"_projectionTexture",void 0);$("BABYLON.SpotLight",bs);const h1=(n,e,t,i)=>!(n.x>t.x+i||t.x-i>e.x||n.y>t.y+i||t.y-i>e.y||n.z>t.z+i||t.z-i>e.z),xo=function(){const n={root:0,found:!1};return function(e,t,i,r){n.root=0,n.found=!1;const s=t*t-4*e*i;if(s<0)return n;const a=Math.sqrt(s);let o=(-t-a)/(2*e),l=(-t+a)/(2*e);if(o>l){const c=l;l=o,o=c}return o>0&&o<r?(n.root=o,n.found=!0,n):(l>0&&l<r&&(n.root=l,n.found=!0),n)}}();class gh{constructor(){this._collisionPoint=m.Zero(),this._planeIntersectionPoint=m.Zero(),this._tempVector=m.Zero(),this._tempVector2=m.Zero(),this._tempVector3=m.Zero(),this._tempVector4=m.Zero(),this._edge=m.Zero(),this._baseToVertex=m.Zero(),this._destinationPoint=m.Zero(),this._slidePlaneNormal=m.Zero(),this._displacementVector=m.Zero(),this._radius=m.One(),this._retry=0,this._basePointWorld=m.Zero(),this._velocityWorld=m.Zero(),this._normalizedVelocity=m.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const r=Math.sqrt(this._velocitySquaredLength);r===0||r===1?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,s){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),m.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let a=m.Dot(this._tempVector4,s);return a<0||(r.subtractToRef(e,this._tempVector3),m.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=m.Dot(this._tempVector4,s),a<0)?!1:(m.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=m.Dot(this._tempVector4,s),a>=0)}_canDoCollision(e,t,i,r){const s=m.Distance(this._basePointWorld,e),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(s>this._velocityWorldLength+a+t||!h1(i,r,this._basePointWorld,this._velocityWorldLength+a))}_testTriangle(e,t,i,r,s,a,o){let l,c=!1;t||(t=[]),t[e]||(t[e]=new Vr(0,0,0,0),t[e].copyFromPoints(i,r,s));const u=t[e];if(!a&&!u.isFrontFacingTo(this._normalizedVelocity,0))return;const h=u.signedDistanceTo(this._basePoint),f=m.Dot(u.normal,this._velocity);if(gh.DoubleSidedCheck&&f>1e-4)return;if(f==0){if(Math.abs(h)>=1)return;c=!0,l=0}else{l=(-1-h)/f;let _=(1-h)/f;if(l>_){const g=_;_=l,l=g}if(l>1||_<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let d=!1,p=1;if(c||(this._basePoint.subtractToRef(u.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,s,u.normal)&&(d=!0,p=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!d){let _=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let g=2*m.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,v=xo(_,g,E,p);v.found&&(p=v.root,d=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),g=2*m.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,v=xo(_,g,E,p),v.found&&(p=v.root,d=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(s,this._tempVector),g=2*m.Dot(this._velocity,this._tempVector),E=this._tempVector.lengthSquared()-1,v=xo(_,g,E,p),v.found&&(p=v.root,d=!0,this._collisionPoint.copyFrom(s)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let x=this._edge.lengthSquared(),A=m.Dot(this._edge,this._velocity),T=m.Dot(this._edge,this._baseToVertex);if(_=x*-this._velocitySquaredLength+A*A,g=2*(x*m.Dot(this._velocity,this._baseToVertex)-A*T),E=x*(1-this._baseToVertex.lengthSquared())+T*T,v=xo(_,g,E,p),v.found){const C=(A*v.root-T)/x;C>=0&&C<=1&&(p=v.root,d=!0,this._edge.scaleInPlace(C),i.addToRef(this._edge,this._collisionPoint))}if(s.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),x=this._edge.lengthSquared(),A=m.Dot(this._edge,this._velocity),T=m.Dot(this._edge,this._baseToVertex),_=x*-this._velocitySquaredLength+A*A,g=2*(x*m.Dot(this._velocity,this._baseToVertex)-A*T),E=x*(1-this._baseToVertex.lengthSquared())+T*T,v=xo(_,g,E,p),v.found){const C=(A*v.root-T)/x;C>=0&&C<=1&&(p=v.root,d=!0,this._edge.scaleInPlace(C),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),x=this._edge.lengthSquared(),A=m.Dot(this._edge,this._velocity),T=m.Dot(this._edge,this._baseToVertex),_=x*-this._velocitySquaredLength+A*A,g=2*(x*m.Dot(this._velocity,this._baseToVertex)-A*T),E=x*(1-this._baseToVertex.lengthSquared())+T*T,v=xo(_,g,E,p),v.found){const C=(A*v.root-T)/x;C>=0&&C<=1&&(p=v.root,d=!0,this._edge.scaleInPlace(C),s.addToRef(this._edge,this._collisionPoint))}}if(d){const _=p*p*this._velocitySquaredLength;(!this.collisionFound||_<this._nearestDistanceSquared)&&(o.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=_,this._nearestDistance=Math.sqrt(_),this.collisionFound=!0),this.collidedMesh=o)}}_collide(e,t,i,r,s,a,o,l,c,u=!1){if(u)if(!i||i.length===0)for(let h=0;h<t.length-2;h+=1){const f=t[h],d=t[h+1],p=t[h+2];!f||!d||!p||((c?1:0)^h%2?this._testTriangle(h,e,f,d,p,o,l):this._testTriangle(h,e,d,f,p,o,l))}else for(let h=r;h<s-2;h+=1){const f=i[h],d=i[h+1],p=i[h+2];if(p===4294967295){h+=2;continue}const _=t[f],g=t[d],E=t[p];!_||!g||!E||((c?1:0)^h%2?this._testTriangle(h,e,_,g,E,o,l):this._testTriangle(h,e,g,_,E,o,l))}else if(!i||i.length===0)for(let h=0;h<t.length;h+=3){const f=t[h],d=t[h+1],p=t[h+2];c?this._testTriangle(h,e,f,d,p,o,l):this._testTriangle(h,e,p,d,f,o,l)}else for(let h=r;h<s;h+=3){const f=t[i[h]-a],d=t[i[h+1]-a],p=t[i[h+2]-a];c?this._testTriangle(h,e,f,d,p,o,l):this._testTriangle(h,e,p,d,f,o,l)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(Vr.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}gh.DoubleSidedCheck=!1;class f1{constructor(){this._scaledPosition=m.Zero(),this._scaledVelocity=m.Zero(),this._finalPosition=m.Zero()}getNewPosition(e,t,i,r,s,a,o){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,s),this._finalPosition.multiplyInPlace(i._radius),a(o,this._finalPosition,i.collidedMesh)}createCollider(){return new gh}init(e){this._scene=e}_collideWithWorld(e,t,i,r,s,a=null){const o=q.CollisionsEpsilon*10;if(i._retry>=r){s.copyFrom(e);return}const l=a?a.collisionMask:i.collisionMask;i._initialize(e,t,o);const c=a&&a.surroundingMeshes||this._scene.meshes;for(let u=0;u<c.length;u++){const h=c[u];h.isEnabled()&&h.checkCollisions&&h.subMeshes&&h!==a&&l&h.collisionGroup&&h._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,s);return}if((t.x!==0||t.y!==0||t.z!==0)&&i._getResponse(e,t),t.length()<=o){s.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,r,s,a)}}ht.CollisionCoordinatorFactory=()=>new f1;class Xi{static get ForceFullSceneLoadingForIncremental(){return Xi._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Xi._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Xi._ShowLoadingScreen}static set ShowLoadingScreen(e){Xi._ShowLoadingScreen=e}static get loggingLevel(){return Xi._LoggingLevel}static set loggingLevel(e){Xi._LoggingLevel=e}static get CleanBoneMatrixWeights(){return Xi._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Xi._CleanBoneMatrixWeights=e}}Xi._ForceFullSceneLoadingForIncremental=!1;Xi._ShowLoadingScreen=!0;Xi._CleanBoneMatrixWeights=!1;Xi._LoggingLevel=0;function d1(n,e){const t=e.method||"GET";return new Promise((i,r)=>{const s=new Gi;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){const a={};if(e.responseHeaders)for(const o of e.responseHeaders)a[o]=s.getResponseHeader(o)||"";i({response:s.response,headerValues:a})}else r(`Unable to fetch data from ${n}. Error code: ${s.status}`)}),s.open(t,n),s.send()})}var lE;(function(n){n[n.Clean=0]="Clean",n[n.Stop=1]="Stop",n[n.Sync=2]="Sync",n[n.NoSync=3]="NoSync"})(lE||(lE={}));function p1(n){return!!n.createPlugin}function _1(n){return!!n.name}const mC=new Q,_n={};let Pf=!1;function Eh(){return _n[".babylon"]}function m1(n){for(const e in _n){const t=_n[e];if(t.mimeType===n)return t}}function _d(n,e){const t=_n[n];return t||(w.Warn("Unable to find a plugin to load "+n+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),e?Eh():void 0)}function g1(n){return!!_n[n]}function E1(n){for(const e in _n){const t=_n[e].plugin;if(t.canDirectLoad&&t.canDirectLoad(n))return _n[e]}return Eh()}function v1(n){const e=n.indexOf("?");e!==-1&&(n=n.substring(0,e));const t=n.lastIndexOf(".");return n.substring(t,n.length).toLowerCase()}function S1(n){return n.substring(0,5)==="data:"?n.substring(5):null}function Fp(n,e,t){let r="Unable to load from "+(n.rawData?"binary data":n.url);return e?r+=`: ${e}`:t&&(r+=`: ${t}`),r}async function wp(n,e,t,i,r,s,a,o,l){var d;const c=S1(n.url);if(n.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";const u=!c&&!a?v1(n.url):"";let h=a?_d(a,!0):c?E1(n.url):_d(u,!1);if(!h&&u){if(n.url&&!n.url.startsWith("blob:")){const p=await d1(n.url,{method:"HEAD",responseHeaders:["Content-Type"]}),_=p.headerValues?p.headerValues["Content-Type"]:"";_&&(h=m1(_))}h||(h=Eh())}if(!h)throw new Error(`No plugin or fallback for ${a??n.url}`);if(((d=l==null?void 0:l[h.plugin.name])==null?void 0:d.enabled)===!1)throw new Error(`The '${h.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(n.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(p=>{if(p1(h.plugin)){const g=h.plugin.createPlugin(l??{});return g instanceof Promise?(g.then(p).catch(E=>{r("Error instantiating plugin.",E)}),null):(p(g),g)}else return p(h.plugin),h.plugin})(p=>{var C;if(!p)throw`The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(mC.notifyObservers(p),c&&(p.canDirectLoad&&p.canDirectLoad(n.url)||!cp(n.url))){if(p.directLoad){const y=p.directLoad(e,c);y instanceof Promise?y.then(P=>{t(p,P)}).catch(P=>{r("Error in directLoad of _loadData: "+P,P)}):t(p,y)}else t(p,c);return}const _=h.isBinary,g=(y,P)=>{if(e.isDisposed){r("Scene has been disposed");return}t(p,y,P)};let E=null,v=!1;(C=p.onDisposeObservable)==null||C.add(()=>{v=!0,E&&(E.abort(),E=null),s()});const x=()=>{if(v)return;const y=(P,D)=>{r(P==null?void 0:P.statusText,D)};if(!p.loadFile&&n.rawData)throw"Plugin does not support loading ArrayBufferView.";E=p.loadFile?p.loadFile(e,n.rawData||n.file||n.url,n.rootUrl,g,i,_,y,o):e._loadFile(n.file||n.url,g,i,!0,_,y)},A=e.getEngine();let T=A.enableOfflineSupport;if(T){let y=!1;for(const P of e.disableOfflineSupportExceptionRules)if(P.test(n.url)){y=!0;break}T=!y}T&&q.OfflineProviderFactory?e.offlineProvider=q.OfflineProviderFactory(n.url,x,A.disableManifestCheck):x()})}function Bp(n,e){let t,i,r=null,s=null;if(!e)t=n,i=J.GetFilename(n),n=J.GetFolderPath(n);else if(_1(e))t=`file:${e.name}`,i=e.name,r=e;else if(ArrayBuffer.isView(e))t="",i=th(),s=e;else if(e.startsWith("data:"))t=e,i="";else if(n){const a=e;if(a.substring(0,1)==="/")return J.Error("Wrong sceneFilename parameter"),null;t=n+a,i=a}else t=e,i=J.GetFilename(e),n=J.GetFolderPath(e);return{url:t,rootUrl:n,name:i,file:r,rawData:s}}function Dl(n){if(typeof n.extensions=="string"){const e=n.extensions;_n[e.toLowerCase()]={plugin:n,isBinary:!1}}else{const e=n.extensions;Object.keys(e).forEach(t=>{_n[t.toLowerCase()]={plugin:n,isBinary:e[t].isBinary,mimeType:e[t].mimeType}})}}async function gC(n,e,t="",i=$e.LastCreatedScene,r=null,s=null,a=null,o=null,l="",c={}){if(!i)return w.Error("No scene available to import mesh to"),null;const u=Bp(e,t);if(!u)return null;const h={};i.addPendingData(h);const f=()=>{i.removePendingData(h)},d=(g,E)=>{const v=Fp(u,g,E);a?a(i,v,new vn(v,ya.SceneLoaderError,E)):w.Error(v),f()},p=s?g=>{try{s(g)}catch(E){d("Error in onProgress callback: "+E,E)}}:void 0,_=(g,E,v,x,A,T,C,y)=>{if(i.importedMeshesFiles.push(u.url),r)try{r(g,E,v,x,A,T,C,y)}catch(P){d("Error in onSuccess callback: "+P,P)}i.removePendingData(h)};return await wp(u,i,(g,E,v)=>{if(g.rewriteRootURL&&(u.rootUrl=g.rewriteRootURL(u.rootUrl,v)),g.importMesh){const x=g,A=[],T=[],C=[];if(!x.importMesh(n,i,E,u.rootUrl,A,T,C,d))return;i.loadingPluginName=g.name,_(A,T,C,[],[],[],[],[])}else g.importMeshAsync(n,i,E,u.rootUrl,p,u.name).then(A=>{i.loadingPluginName=g.name,_(A.meshes,A.particleSystems,A.skeletons,A.animationGroups,A.transformNodes,A.geometries,A.lights,A.spriteManagers)}).catch(A=>{d(A.message,A)})},p,d,f,o,l,c)}function T1(n,e,t,i,r,s,a,o){return new Promise((l,c)=>{gC(n,e,t,i,(u,h,f,d,p,_,g,E)=>{l({meshes:u,particleSystems:h,skeletons:f,animationGroups:d,transformNodes:p,geometries:_,lights:g,spriteManagers:E})},r,(u,h,f)=>{c(f||new Error(h))},s,a,o)})}function EC(n,e="",t=$e.LastCreatedEngine,i=null,r=null,s=null,a=null,o="",l={}){if(!t){J.Error("No engine available");return}Vp(n,e,new ht(t),i,r,s,a,o,l)}function x1(n,e,t,i,r,s,a){return new Promise((o,l)=>{EC(n,e,t,c=>{o(c)},i,(c,u,h)=>{l(h||new Error(u))},r,s,a)})}async function Vp(n,e="",t=$e.LastCreatedScene,i=null,r=null,s=null,a=null,o="",l={}){if(!t)return w.Error("No scene available to append to"),null;const c=Bp(n,e);if(!c)return null;const u={};t.addPendingData(u);const h=()=>{t.removePendingData(u)};Xi.ShowLoadingScreen&&!Pf&&(Pf=!0,t.getEngine().displayLoadingUI(),t.executeWhenReady(()=>{t.getEngine().hideLoadingUI(),Pf=!1}));const f=(_,g)=>{const E=Fp(c,_,g);s?s(t,E,new vn(E,ya.SceneLoaderError,g)):w.Error(E),h()},d=r?_=>{try{r(_)}catch(g){f("Error in onProgress callback",g)}}:void 0,p=()=>{if(i)try{i(t)}catch(_){f("Error in onSuccess callback",_)}t.removePendingData(u)};return await wp(c,t,(_,g)=>{if(_.load){if(!_.load(t,g,c.rootUrl,f))return;t.loadingPluginName=_.name,p()}else _.loadAsync(t,g,c.rootUrl,d,c.name).then(()=>{t.loadingPluginName=_.name,p()}).catch(v=>{f(v.message,v)})},d,f,h,a,o,l)}function C1(n,e,t,i,r,s,a){return new Promise((o,l)=>{Vp(n,e,t,c=>{o(c)},i,(c,u,h)=>{l(h||new Error(u))},r,s,a)})}async function Up(n,e="",t=$e.LastCreatedScene,i=null,r=null,s=null,a=null,o="",l={}){if(!t)return w.Error("No scene available to load asset container to"),null;const c=Bp(n,e);if(!c)return null;const u={};t.addPendingData(u);const h=()=>{t.removePendingData(u)},f=(_,g)=>{const E=Fp(c,_,g);s?s(t,E,new vn(E,ya.SceneLoaderError,g)):w.Error(E),h()},d=r?_=>{try{r(_)}catch(g){f("Error in onProgress callback",g)}}:void 0,p=_=>{if(i)try{i(_)}catch(g){f("Error in onSuccess callback",g)}t.removePendingData(u)};return await wp(c,t,(_,g)=>{if(_.loadAssetContainer){const v=_.loadAssetContainer(t,g,c.rootUrl,f);if(!v)return;v.populateRootNodes(),t.loadingPluginName=_.name,p(v)}else _.loadAssetContainerAsync?_.loadAssetContainerAsync(t,g,c.rootUrl,d,c.name).then(v=>{v.populateRootNodes(),t.loadingPluginName=_.name,p(v)}).catch(v=>{f(v.message,v)}):f("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,f,h,a,o,l)}function A1(n,e,t,i,r,s,a){return new Promise((o,l)=>{Up(n,e,t,c=>{o(c)},i,(c,u,h)=>{l(h||new Error(u))},r,s,a)})}function vC(n,e="",t=$e.LastCreatedScene,i=!0,r=0,s=null,a=null,o=null,l=null,c=null,u="",h={}){if(!t){w.Error("No scene available to load animations to");return}if(i){for(const _ of t.animatables)_.reset();t.stopAllAnimations(),t.animationGroups.slice().forEach(_=>{_.dispose()}),t.getNodes().forEach(_=>{_.animations&&(_.animations=[])})}else switch(r){case 0:t.animationGroups.slice().forEach(p=>{p.dispose()});break;case 1:t.animationGroups.forEach(p=>{p.stop()});break;case 2:t.animationGroups.forEach(p=>{p.reset(),p.restart()});break;case 3:break;default:w.Error("Unknown animation group loading mode value '"+r+"'");return}const f=t.animatables.length;Up(n,e,t,p=>{p.mergeAnimationsTo(t,t.animatables.slice(f),s),p.dispose(),t.onAnimationFileImportedObservable.notifyObservers(t),a&&a(t)},o,l,c,u,h)}function I1(n,e,t,i,r,s,a,o,l,c){return new Promise((u,h)=>{vC(n,e,t,i,r,s,f=>{u(f)},a,(f,d,p)=>{h(p||new Error(d))},o,l,c)})}class wi{static get ForceFullSceneLoadingForIncremental(){return Xi.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Xi.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Xi.ShowLoadingScreen}static set ShowLoadingScreen(e){Xi.ShowLoadingScreen=e}static get loggingLevel(){return Xi.loggingLevel}static set loggingLevel(e){Xi.loggingLevel=e}static get CleanBoneMatrixWeights(){return Xi.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Xi.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return Eh()}static GetPluginForExtension(e){var t;return(t=_d(e,!0))==null?void 0:t.plugin}static IsPluginForExtensionAvailable(e){return g1(e)}static RegisterPlugin(e){Dl(e)}static ImportMesh(e,t,i,r,s,a,o,l,c){gC(e,t,i,r,s,a,o,l,c)}static ImportMeshAsync(e,t,i,r,s,a,o){return T1(e,t,i,r,s,a,o)}static Load(e,t,i,r,s,a,o,l){EC(e,t,i,r,s,a,o,l)}static LoadAsync(e,t,i,r,s,a){return x1(e,t,i,r,s,a)}static Append(e,t,i,r,s,a,o,l){Vp(e,t,i,r,s,a,o,l)}static AppendAsync(e,t,i,r,s,a){return C1(e,t,i,r,s,a)}static LoadAssetContainer(e,t,i,r,s,a,o,l){Up(e,t,i,r,s,a,o,l)}static LoadAssetContainerAsync(e,t,i,r,s,a){return A1(e,t,i,r,s,a)}static ImportAnimations(e,t,i,r,s,a,o,l,c,u,h){vC(e,t,i,r,s,a,o,l,c,u,h)}static ImportAnimationsAsync(e,t,i,r,s,a,o,l,c,u,h){return I1(e,t,i,r,s,a,l,u,h)}}wi.NO_LOGGING=0;wi.MINIMAL_LOGGING=1;wi.SUMMARY_LOGGING=2;wi.DETAILED_LOGGING=3;wi.OnPluginActivatedObservable=mC;const qc="Z2xURg",cE={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(n){return n.indexOf("asset")!==-1&&n.indexOf("version")!==-1||n.startsWith("data:base64,"+qc)||n.startsWith("data:;base64,"+qc)||n.startsWith("data:application/octet-stream;base64,"+qc)||n.startsWith("data:model/gltf-binary;base64,"+qc)}},y1={name:"obj",extensions:".obj"},uE={name:"splat",extensions:{".splat":{isBinary:!0},".ply":{isBinary:!0}}},b1={name:"stl",extensions:{".stl":{isBinary:!0}}},kp=new Map,N5=kp;function li(n,e,t){R1(n)&&w.Warn(`Extension with the name '${n}' already exists`),kp.set(n,{isGLTFExtension:e,factory:t})}function R1(n){return kp.delete(n)}function P1(){li("EXT_lights_image_based",!0,async n=>{const{EXT_lights_image_based:e}=await re(async()=>{const{EXT_lights_image_based:t}=await import("./EXT_lights_image_based-BXtXbwmT.js");return{EXT_lights_image_based:t}},__vite__mapDeps([6,7,8]));return new e(n)}),li("EXT_mesh_gpu_instancing",!0,async n=>{const{EXT_mesh_gpu_instancing:e}=await re(async()=>{const{EXT_mesh_gpu_instancing:t}=await import("./EXT_mesh_gpu_instancing-BdK1RPxx.js");return{EXT_mesh_gpu_instancing:t}},__vite__mapDeps([9,7,8]));return new e(n)}),li("EXT_meshopt_compression",!0,async n=>{const{EXT_meshopt_compression:e}=await re(async()=>{const{EXT_meshopt_compression:t}=await import("./EXT_meshopt_compression-BY1gvITJ.js");return{EXT_meshopt_compression:t}},__vite__mapDeps([10,7,8]));return new e(n)}),li("EXT_texture_avif",!0,async n=>{const{EXT_texture_avif:e}=await re(async()=>{const{EXT_texture_avif:t}=await import("./EXT_texture_avif-BWQDy1I2.js");return{EXT_texture_avif:t}},__vite__mapDeps([11,7,8]));return new e(n)}),li("EXT_texture_webp",!0,async n=>{const{EXT_texture_webp:e}=await re(async()=>{const{EXT_texture_webp:t}=await import("./EXT_texture_webp-BLxzoyPr.js");return{EXT_texture_webp:t}},__vite__mapDeps([12,7,8]));return new e(n)}),li("ExtrasAsMetadata",!1,async n=>{const{ExtrasAsMetadata:e}=await re(async()=>{const{ExtrasAsMetadata:t}=await import("./ExtrasAsMetadata-C4OrVdu-.js");return{ExtrasAsMetadata:t}},[]);return new e(n)}),li("KHR_animation_pointer",!0,async n=>{const{KHR_animation_pointer:e}=await re(async()=>{const{KHR_animation_pointer:t}=await import("./KHR_animation_pointer-BY_XIjyS.js");return{KHR_animation_pointer:t}},__vite__mapDeps([13,8,14]));return new e(n)}),li("KHR_draco_mesh_compression",!0,async n=>{const{KHR_draco_mesh_compression:e}=await re(async()=>{const{KHR_draco_mesh_compression:t}=await import("./KHR_draco_mesh_compression-DdOCu7Ee.js");return{KHR_draco_mesh_compression:t}},__vite__mapDeps([15,7,8]));return new e(n)}),li("KHR_interactivity",!0,async n=>{const{KHR_interactivity:e}=await re(async()=>{const{KHR_interactivity:t}=await import("./KHR_interactivity-Bpa1RbAP.js");return{KHR_interactivity:t}},__vite__mapDeps([16,14]));return new e(n)}),li("KHR_lights_punctual",!0,async n=>{const{KHR_lights:e}=await re(async()=>{const{KHR_lights:t}=await import("./KHR_lights_punctual-DKo7P0M-.js");return{KHR_lights:t}},__vite__mapDeps([17,7,8]));return new e(n)}),li("KHR_materials_anisotropy",!0,async n=>{const{KHR_materials_anisotropy:e}=await re(async()=>{const{KHR_materials_anisotropy:t}=await import("./KHR_materials_anisotropy-O_NWomUV.js");return{KHR_materials_anisotropy:t}},__vite__mapDeps([18,7,8]));return new e(n)}),li("KHR_materials_clearcoat",!0,async n=>{const{KHR_materials_clearcoat:e}=await re(async()=>{const{KHR_materials_clearcoat:t}=await import("./KHR_materials_clearcoat-B10mzFrn.js");return{KHR_materials_clearcoat:t}},__vite__mapDeps([19,7,8]));return new e(n)}),li("KHR_materials_diffuse_transmission",!0,async n=>{const{KHR_materials_diffuse_transmission:e}=await re(async()=>{const{KHR_materials_diffuse_transmission:t}=await import("./KHR_materials_diffuse_transmission-CWTqM16l.js");return{KHR_materials_diffuse_transmission:t}},__vite__mapDeps([20,7,8]));return new e(n)}),li("KHR_materials_dispersion",!0,async n=>{const{KHR_materials_dispersion:e}=await re(async()=>{const{KHR_materials_dispersion:t}=await import("./KHR_materials_dispersion-a-0dUGc7.js");return{KHR_materials_dispersion:t}},__vite__mapDeps([21,7,8]));return new e(n)}),li("KHR_materials_emissive_strength",!0,async n=>{const{KHR_materials_emissive_strength:e}=await re(async()=>{const{KHR_materials_emissive_strength:t}=await import("./KHR_materials_emissive_strength-D8T7E2Vt.js");return{KHR_materials_emissive_strength:t}},__vite__mapDeps([22,7,8]));return new e(n)}),li("KHR_materials_ior",!0,async n=>{const{KHR_materials_ior:e}=await re(async()=>{const{KHR_materials_ior:t}=await import("./KHR_materials_ior-Bz-lHwYH.js");return{KHR_materials_ior:t}},__vite__mapDeps([23,7,8]));return new e(n)}),li("KHR_materials_iridescence",!0,async n=>{const{KHR_materials_iridescence:e}=await re(async()=>{const{KHR_materials_iridescence:t}=await import("./KHR_materials_iridescence-B4Y2EIQH.js");return{KHR_materials_iridescence:t}},__vite__mapDeps([24,7,8]));return new e(n)}),li("KHR_materials_pbrSpecularGlossiness",!0,async n=>{const{KHR_materials_pbrSpecularGlossiness:e}=await re(async()=>{const{KHR_materials_pbrSpecularGlossiness:t}=await import("./KHR_materials_pbrSpecularGlossiness-CY6gkaov.js");return{KHR_materials_pbrSpecularGlossiness:t}},__vite__mapDeps([25,7,8]));return new e(n)}),li("KHR_materials_sheen",!0,async n=>{const{KHR_materials_sheen:e}=await re(async()=>{const{KHR_materials_sheen:t}=await import("./KHR_materials_sheen-CFTfKxJT.js");return{KHR_materials_sheen:t}},__vite__mapDeps([26,7,8]));return new e(n)}),li("KHR_materials_specular",!0,async n=>{const{KHR_materials_specular:e}=await re(async()=>{const{KHR_materials_specular:t}=await import("./KHR_materials_specular-C0ftJ22M.js");return{KHR_materials_specular:t}},__vite__mapDeps([27,7,8]));return new e(n)}),li("KHR_materials_transmission",!0,async n=>{const{KHR_materials_transmission:e}=await re(async()=>{const{KHR_materials_transmission:t}=await import("./KHR_materials_transmission-CY2uUqX6.js");return{KHR_materials_transmission:t}},__vite__mapDeps([28,7,8]));return new e(n)}),li("KHR_materials_unlit",!0,async n=>{const{KHR_materials_unlit:e}=await re(async()=>{const{KHR_materials_unlit:t}=await import("./KHR_materials_unlit-Cu_tyu4N.js");return{KHR_materials_unlit:t}},__vite__mapDeps([29,7,8]));return new e(n)}),li("KHR_materials_variants",!0,async n=>{const{KHR_materials_variants:e}=await re(async()=>{const{KHR_materials_variants:t}=await import("./KHR_materials_variants-DEefU7QB.js");return{KHR_materials_variants:t}},__vite__mapDeps([30,7,8]));return new e(n)}),li("KHR_materials_volume",!0,async n=>{const{KHR_materials_volume:e}=await re(async()=>{const{KHR_materials_volume:t}=await import("./KHR_materials_volume-BIv3qF34.js");return{KHR_materials_volume:t}},__vite__mapDeps([31,7,8]));return new e(n)}),li("KHR_mesh_quantization",!0,async n=>{const{KHR_mesh_quantization:e}=await re(async()=>{const{KHR_mesh_quantization:t}=await import("./KHR_mesh_quantization-DlPbtIdB.js");return{KHR_mesh_quantization:t}},[]);return new e(n)}),li("KHR_texture_basisu",!0,async n=>{const{KHR_texture_basisu:e}=await re(async()=>{const{KHR_texture_basisu:t}=await import("./KHR_texture_basisu-DKlCUxb0.js");return{KHR_texture_basisu:t}},__vite__mapDeps([32,7,8]));return new e(n)}),li("KHR_texture_transform",!0,async n=>{const{KHR_texture_transform:e}=await re(async()=>{const{KHR_texture_transform:t}=await import("./KHR_texture_transform-DYAJBtwv.js");return{KHR_texture_transform:t}},__vite__mapDeps([33,7,8]));return new e(n)}),li("KHR_xmp_json_ld",!0,async n=>{const{KHR_xmp_json_ld:e}=await re(async()=>{const{KHR_xmp_json_ld:t}=await import("./KHR_xmp_json_ld-C2uH9SJt.js");return{KHR_xmp_json_ld:t}},[]);return new e(n)}),li("MSFT_audio_emitter",!0,async n=>{const{MSFT_audio_emitter:e}=await re(async()=>{const{MSFT_audio_emitter:t}=await import("./MSFT_audio_emitter-DbHbt2M2.js");return{MSFT_audio_emitter:t}},__vite__mapDeps([34,7,8]));return new e(n)}),li("MSFT_lod",!0,async n=>{const{MSFT_lod:e}=await re(async()=>{const{MSFT_lod:t}=await import("./MSFT_lod-BmLsfyy4.js");return{MSFT_lod:t}},__vite__mapDeps([35,7,8]));return new e(n)}),li("MSFT_minecraftMesh",!0,async n=>{const{MSFT_minecraftMesh:e}=await re(async()=>{const{MSFT_minecraftMesh:t}=await import("./MSFT_minecraftMesh-DpAde5U_.js");return{MSFT_minecraftMesh:t}},__vite__mapDeps([36,7,8]));return new e(n)}),li("MSFT_sRGBFactors",!0,async n=>{const{MSFT_sRGBFactors:e}=await re(async()=>{const{MSFT_sRGBFactors:t}=await import("./MSFT_sRGBFactors-BTegmd7F.js");return{MSFT_sRGBFactors:t}},__vite__mapDeps([37,7,8]));return new e(n)}),li("KHR_node_visibility",!0,async n=>{const{KHR_node_visibility:e}=await re(async()=>{const{KHR_node_visibility:t}=await import("./KHR_node_visibility-C_3qvKAE.js");return{KHR_node_visibility:t}},[]);return new e(n)})}function M1(){Dl({...cE,createPlugin:async n=>{const{GLTFFileLoader:e}=await re(async()=>{const{GLTFFileLoader:t}=await import("./glTFLoader-B7_AMTvd.js").then(i=>i.g);return{GLTFFileLoader:t}},__vite__mapDeps([7,8]));return new e(n[cE.name])}}),P1(),Dl({...y1,createPlugin:async()=>{const{OBJFileLoader:n}=await re(async()=>{const{OBJFileLoader:e}=await import("./objFileLoader-CVWBo01o.js");return{OBJFileLoader:e}},[]);return new n}}),Dl({...uE,createPlugin:async n=>{const{SPLATFileLoader:e}=await re(async()=>{const{SPLATFileLoader:t}=await import("./splatFileLoader-BtQWx3bU.js");return{SPLATFileLoader:t}},[]);return new e(n[uE.name])}}),Dl({...b1,createPlugin:async()=>{const{STLFileLoader:n}=await re(async()=>{const{STLFileLoader:e}=await import("./stlFileLoader-DKU2OIWJ.js");return{STLFileLoader:e}},[]);return new n}})}class D1{constructor({canvas:e,engine:t,onPointerDownCallback:i,onRenderingCallback:r,onRenderingLoopCallback:s}){Fs(this,"_scene",null);Fs(this,"_canvas");Fs(this,"_engine");Fs(this,"_onPointerDownCallback");Fs(this,"_onRenderingCallback");Fs(this,"_onRenderingLoopCallback");this._canvas=e,this._engine=t,this._onPointerDownCallback=i,this._onRenderingCallback=r,this._onRenderingLoopCallback=s}dispose(){var e;(e=this._scene)==null||e.dispose()}createScene(){const e=new ht(this._engine);return e.onPointerDown=async()=>{await this.onPointerDown()},e}async onPointerDown(){this._onPointerDownCallback&&await this._onPointerDownCallback()}doRender(){this._onRenderingCallback&&this._onRenderingCallback(),window.addEventListener("resize",()=>{this._engine.resize()})}}let SC=class TC{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw rt("CannonJSPlugin")}constructor(e,t=TC.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new m(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){const r=this._joints.filter(function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){this._impostors.forEach(t=>{t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}};class ci{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}ci.DistanceJoint=0;ci.HingeJoint=1;ci.BallAndSocketJoint=2;ci.WheelJoint=3;ci.SliderJoint=4;ci.PrismaticJoint=5;ci.UniversalJoint=6;ci.Hinge2Joint=ci.WheelJoint;ci.PointToPointJoint=8;ci.SpringJoint=9;ci.LockJoint=10;Object.defineProperty($t.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(n){this._physicsImpostor!==n&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=n,n&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0});$t.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};$t.prototype.applyImpulse=function(n,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(n,e),this):this};$t.prototype.setPhysicsLinkWith=function(n,e,t,i){return!this.physicsImpostor||!n.physicsImpostor?this:(this.physicsImpostor.createJoint(n.physicsImpostor,ci.HingeJoint,{mainPivot:e,connectedPivot:t,nativeParams:i}),this)};function O1(n,e,t,i,r,s,a,o){const l=e*b.GetTypeByteLength(t),c=a*e;if(o.length!==c)throw new Error("Output length is not valid");if(t!==b.FLOAT||r!==l){b.ForEach(n,i,r,e,t,c,s,(u,h)=>o[h]=u);return}if(n instanceof Array){const u=i/4;o.set(n,u)}else if(n instanceof ArrayBuffer){const u=new Float32Array(n,i,c);o.set(u)}else{const u=n.byteOffset+i;if(u%4){w.Warn("CopyFloatData: copied misaligned data."),o.set(new Float32Array(n.buffer.slice(u,u+c*4)));return}const f=new Float32Array(n.buffer,u,c);o.set(f)}}class dr{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new dr(dr.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||$e.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));const e=new Set;for(const t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(t=>{t._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));const s=new b(this._engine,t,e,{updatable:i,postponeInternalCreation:this._meshes.length===0,stride:r,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;const s=this._meshes,a=s.length;if(r===b.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();const o=this._extend&&this._extend.minimum||new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let c=0;c<a;c++){const u=s[c];u.buildBoundingInfo(o,l),u._createGlobalSubMesh(u.isUnIndexed),u.computeWorldMatrix(!0),u.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){const s=this.getVertexBuffer(e);s&&(s.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const r=this.getVertexBuffer(e);r&&(r.update(t),e===b.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const s=r.subMeshes;for(const a of s)a.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);const s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(s,t,e,i);return}const a=r||this._vertexArrayObjects,o=this._engine;a[e.key]||(a[e.key]=o.recordVertexArrayObject(s,t,e,i)),o.bindVertexArrayObject(a[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}copyVerticesData(e,t){const i=this.getVertexBuffer(e);if(!i)return;t[e]||(t[e]=new Float32Array(this._totalVertices*i.getSize()));const r=i.getData();r&&O1(r,i.getSize(),i.type,i.byteOffset,i.byteStride,i.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(const s of this._meshes)s._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,i){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(const r of this._meshes)r._createGlobalSubMesh(!0),r.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1,r=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),t!=null&&(this._totalVertices=t);for(const s of this._meshes)s._createGlobalSubMesh(!r),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(b.PositionKind),!e))return;this._extend=to(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===b.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const r=this._meshes,s=r.length;for(let a=0;a<s;a++)this._applyToMesh(r[a]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){const s=e[r+0];e[r+0]=e[r+2],e[r+2]=s}this.setIndices(e)}const t=this.getVerticesData(b.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(b.PositionKind,t,!1)}const i=this.getVerticesData(b.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(b.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(b.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=m.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new de;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let r=!1,s=!1,a;for(a in this._vertexBuffers){const l=this.getVerticesData(a);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),a):t.set(l.slice(0),a),!s)){const c=this.getVertexBuffer(a);c&&(r=c.isUpdatable(),s=!r)}}const o=new dr(e,this._scene,t,r);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(a in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(a);return o._boundingInfo=new Jr(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Pt&&Pt.HasTags(this)&&(e.tags=Pt.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(b.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(b.PositionKind)),this.isVertexBufferUpdatable(b.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(b.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(b.NormalKind)),this.isVertexBufferUpdatable(b.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(b.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(b.TangentKind)),this.isVertexBufferUpdatable(b.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(b.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(b.UVKind)),this.isVertexBufferUpdatable(b.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(b.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(b.UV2Kind)),this.isVertexBufferUpdatable(b.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(b.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(b.UV3Kind)),this.isVertexBufferUpdatable(b.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(b.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(b.UV4Kind)),this.isVertexBufferUpdatable(b.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(b.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(b.UV5Kind)),this.isVertexBufferUpdatable(b.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(b.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(b.UV6Kind)),this.isVertexBufferUpdatable(b.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(b.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(b.ColorKind)),this.isVertexBufferUpdatable(b.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(b.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(b.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(b.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(b.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(b.MatricesWeightsKind)),this.isVertexBufferUpdatable(b.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return J.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),r=e.geometryUniqueId,s=e.geometryId;if(r||s){const a=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(s);a&&a.applyToMesh(t)}else if(e instanceof ArrayBuffer){const a=t._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){const o=new Float32Array(e,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);t.setVerticesData(b.PositionKind,o,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){const o=new Float32Array(e,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);t.setVerticesData(b.NormalKind,o,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){const o=new Float32Array(e,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);t.setVerticesData(b.TangentKind,o,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){const o=new Float32Array(e,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);t.setVerticesData(b.UVKind,o,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){const o=new Float32Array(e,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);t.setVerticesData(b.UV2Kind,o,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){const o=new Float32Array(e,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);t.setVerticesData(b.UV3Kind,o,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){const o=new Float32Array(e,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);t.setVerticesData(b.UV4Kind,o,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){const o=new Float32Array(e,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);t.setVerticesData(b.UV5Kind,o,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){const o=new Float32Array(e,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);t.setVerticesData(b.UV6Kind,o,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){const o=new Float32Array(e,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);t.setVerticesData(b.ColorKind,o,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){const o=new Int32Array(e,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const u=o[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(b.MatricesIndicesKind,l,!1)}if(a.matricesIndicesExtraAttrDesc&&a.matricesIndicesExtraAttrDesc.count>0){const o=new Int32Array(e,a.matricesIndicesExtraAttrDesc.offset,a.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const u=o[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(b.MatricesIndicesExtraKind,l,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){const o=new Float32Array(e,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);t.setVerticesData(b.MatricesWeightsKind,o,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){const o=new Int32Array(e,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);t.setIndices(o,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){const o=new Int32Array(e,a.subMeshesAttrDesc.offset,a.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<a.subMeshesAttrDesc.count;l++){const c=o[l*5+0],u=o[l*5+1],h=o[l*5+2],f=o[l*5+3],d=o[l*5+4];_r.AddToMesh(c,u,h,f,d,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(b.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(b.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(b.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(b.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(b.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(b.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(b.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(b.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(b.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(b.ColorKind,Be.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(b.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const a=[];for(let o=0;o<e.matricesIndices.length;o++){const l=e.matricesIndices[o];a.push(l&255),a.push((l&65280)>>8),a.push((l&16711680)>>16),a.push(l>>24&255)}t.setVerticesData(b.MatricesIndicesKind,a,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(b.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const a=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){const l=e.matricesIndicesExtra[o];a.push(l&255),a.push((l&65280)>>8),a.push((l&16711680)>>16),a.push(l>>24&255)}t.setVerticesData(b.MatricesIndicesExtraKind,a,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(dr._CleanMatricesWeights(e,t),t.setVerticesData(b.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(b.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let a=0;a<e.subMeshes.length;a++){const o=e.subMeshes[a];_r.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!Xi.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){const h=t.getScene().getLastSkeletonById(e.skeletonId);if(!h)return;r=h.bones.length}else return;const s=t.getVerticesData(b.MatricesIndicesKind),a=t.getVerticesData(b.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,u=o.length;for(let h=0;h<u;h+=4){let f=0,d=-1;for(let p=0;p<4;p++){const _=o[h+p];f+=_,_<.001&&d<0&&(d=p)}if(l)for(let p=0;p<4;p++){const _=l[h+p];f+=_,_<.001&&d<0&&(d=p+4)}if((d<0||d>c-1)&&(d=c-1),f>.001){const p=1/f;for(let _=0;_<4;_++)o[h+_]*=p;if(l)for(let _=0;_<4;_++)l[h+_]*=p}else d>=4?(l[h+d-4]=1-f,a[h+d-4]=r):(o[h+d]=1-f,s[h+d]=r)}t.setVerticesData(b.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(b.MatricesIndicesExtraKind,a)}static Parse(e,t,i){const r=new dr(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,Pt&&Pt.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new Jr(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(b.UVKind),e.hasUVs2&&r._delayInfo.push(b.UV2Kind),e.hasUVs3&&r._delayInfo.push(b.UV3Kind),e.hasUVs4&&r._delayInfo.push(b.UV4Kind),e.hasUVs5&&r._delayInfo.push(b.UV5Kind),e.hasUVs6&&r._delayInfo.push(b.UV6Kind),e.hasColors&&r._delayInfo.push(b.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(b.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(b.MatricesWeightsKind),r._delayLoadingFunction=de.ImportVertexData):de.ImportVertexData(e,r),t.pushGeometry(r,!0),r}}class Jn{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){Ke.Clone(()=>e,this)}serialize(){return Ke.Serialize(this)}parse(e,t,i){Ke.Parse(()=>this,e,t,i)}}I([M()],Jn.prototype,"func",null);I([M()],Jn.prototype,"funcRef",null);I([M()],Jn.prototype,"funcMask",null);I([M()],Jn.prototype,"opStencilFail",null);I([M()],Jn.prototype,"opDepthFail",null);I([M()],Jn.prototype,"opStencilDepthPass",null);I([M()],Jn.prototype,"mask",null);I([M()],Jn.prototype,"enabled",null);class pe{get shaderLanguage(){return this._shaderLanguage}get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(pe.MiscDirtyFlag+pe.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(pe.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(pe.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new Q),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new Q),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new Q),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(pe.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(pe.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case pe.WireFrameFillMode:case pe.LineListDrawMode:case pe.LineLoopDrawMode:case pe.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?pe.WireFrameFillMode:pe.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case pe.PointFillMode:case pe.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?pe.PointFillMode:pe.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(pe.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&w.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i,r=!1){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this._shaderLanguage=0,this._forceGLSL=!1,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new Q,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Jn,this._useUBO=!1,this._fillMode=pe.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const s=t||$e.LastCreatedScene;s&&(this._scene=s,this._dirtyCallbacks={},this._forceGLSL=r,this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||J.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new ds(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new ke(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,this._createUniformBuffer(),i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),pe.OnEventObservable.notifyObservers(this,1))}_createUniformBuffer(){var t;const e=this.getScene().getEngine();(t=this._uniformBuffer)==null||t.dispose(),e.isWebGPU&&!this._forceGLSL?(this._uniformBuffer=new ke(e,void 0,void 0,this.name,!0),this._shaderLanguage=1):this._uniformBuffer=new ke(this._scene.getEngine(),void 0,void 0,this.name),this._uniformBufferLayoutBuilt=!1}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return this.sideOrientation!==null?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===pe.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===pe.MATERIAL_OPAQUE||this._transparencyMode===pe.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const r of i.subMeshes)if(r.getMaterial()===this)for(const s of r._drawWrappers)s&&this._materialContext===s.materialContext&&(s._wasPreviouslyReady=!1,s._wasPreviouslyUsingInstances=null,s._forceRebindOnNextCall=e)}e&&this.markAsDirty(pe.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(t??this.sideOrientation)===pe.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(8,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const r=i._drawWrapper;this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null,i){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,yp(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const r=this._scene.getEngine();this._cachedDepthWriteState=r.getDepthWrite(),r.setDepthWrite(!1)}if(this.disableColorWrite){const r=this._scene.getEngine();this._cachedColorWriteState=r.getColorWrite(),r.setColorWrite(!1)}if(this.depthFunction!==0){const r=this._scene.getEngine();this._cachedDepthFunctionState=r.getDepthFunction()||0,r.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(256,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(512,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(1024,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),pe._ParsePlugins(i,e,this._scene,t),this.pluginManager)for(const r of this.pluginManager._plugins){const s=e.pluginManager.getPlugin(r.name);s&&r.copyTo(s)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,r){const s={clipPlane:!1,useInstances:!1,...i},a=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const c=a.clipPlane;if(s.clipPlane&&(a.clipPlane=new Vr(0,0,0,1)),this._storeEffectOnSubMeshes){let u=!0,h=null;if(e.subMeshes){const f=new _r(0,0,0,0,0,e,void 0,!1,!1);f.materialDefines&&(f.materialDefines._renderId=-1),this.isReadyForSubMesh(e,f,s.useInstances)||(f.effect&&f.effect.getCompilationError()&&f.effect.allFallbacksProcessed()?h=f.effect.getCompilationError():(u=!1,setTimeout(l,16)))}u&&(this.allowShaderHotSwapping=o,h&&r&&r(h),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);s.clipPlane&&(a.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,r)=>{this.forceCompilation(e,()=>{i()},t,s=>{r(s)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(pe._DirtyCallbackArray.length=0,e&pe.TextureDirtyFlag&&pe._DirtyCallbackArray.push(pe._TextureDirtyCallBack),e&pe.LightDirtyFlag&&pe._DirtyCallbackArray.push(pe._LightsDirtyCallBack),e&pe.FresnelDirtyFlag&&pe._DirtyCallbackArray.push(pe._FresnelDirtyCallBack),e&pe.AttributesDirtyFlag&&pe._DirtyCallbackArray.push(pe._AttributeDirtyCallBack),e&pe.MiscDirtyFlag&&pe._DirtyCallbackArray.push(pe._MiscDirtyCallBack),e&pe.PrePassDirtyFlag&&pe._DirtyCallbackArray.push(pe._PrePassDirtyCallBack),pe._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(pe._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const r of i.subMeshes)if(r.getMaterial(!1)===this)for(const s of r._drawWrappers)!s||!s.defines||!s.defines.markAllAsDirty||this._materialContext===s.materialContext&&e(s.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(pe._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(pe._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(pe._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(pe._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(pe._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(pe._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(pe._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(pe._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(pe._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(pe._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==0){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(2,this._eventInfo),this._parentContainer){const s=this._parentContainer.materials.indexOf(this);s>-1&&this._parentContainer.materials.splice(s,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const s in this.meshMap){const a=this.meshMap[s];a&&(a.material=null,this.releaseVertexArrayObject(a,e))}else{const s=r.meshes;for(const a of s)a.material===this&&!a.sourceMesh&&(a.material=null,this.releaseVertexArrayObject(a,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){const i=e.geometry;if(i)if(this._storeEffectOnSubMeshes){if(e.subMeshes)for(const r of e.subMeshes)i._releaseVertexArrayObject(r.effect),t&&r.effect&&r.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}serialize(){const e=Ke.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return w.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const s=J.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}static _ParsePlugins(e,t,i,r){var s;if(e.plugins)for(const a in e.plugins){const o=e.plugins[a];let l=(s=t.pluginManager)==null?void 0:s.getPlugin(o.name);if(!l){const c=J.Instantiate("BABYLON."+a);c&&(l=new c(t))}l==null||l.parse(o,i,r)}}}pe.TriangleFillMode=0;pe.WireFrameFillMode=1;pe.PointFillMode=2;pe.PointListDrawMode=3;pe.LineListDrawMode=4;pe.LineLoopDrawMode=5;pe.LineStripDrawMode=6;pe.TriangleStripDrawMode=7;pe.TriangleFanDrawMode=8;pe.ClockWiseSideOrientation=0;pe.CounterClockWiseSideOrientation=1;pe.TextureDirtyFlag=1;pe.LightDirtyFlag=2;pe.FresnelDirtyFlag=4;pe.AttributesDirtyFlag=8;pe.MiscDirtyFlag=16;pe.PrePassDirtyFlag=32;pe.AllDirtyFlag=63;pe.MATERIAL_OPAQUE=0;pe.MATERIAL_ALPHATEST=1;pe.MATERIAL_ALPHABLEND=2;pe.MATERIAL_ALPHATESTANDBLEND=3;pe.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;pe.MATERIAL_NORMALBLENDMETHOD_RNM=1;pe.OnEventObservable=new Q;pe._AllDirtyCallBack=n=>n.markAllAsDirty();pe._ImageProcessingDirtyCallBack=n=>n.markAsImageProcessingDirty();pe._TextureDirtyCallBack=n=>n.markAsTexturesDirty();pe._FresnelDirtyCallBack=n=>n.markAsFresnelDirty();pe._MiscDirtyCallBack=n=>n.markAsMiscDirty();pe._PrePassDirtyCallBack=n=>n.markAsPrePassDirty();pe._LightsDirtyCallBack=n=>n.markAsLightDirty();pe._AttributeDirtyCallBack=n=>n.markAsAttributesDirty();pe._FresnelAndMiscDirtyCallBack=n=>{pe._FresnelDirtyCallBack(n),pe._MiscDirtyCallBack(n)};pe._TextureAndMiscDirtyCallBack=n=>{pe._TextureDirtyCallBack(n),pe._MiscDirtyCallBack(n)};pe._DirtyCallbackArray=[];pe._RunDirtyCallBacks=n=>{for(const e of pe._DirtyCallbackArray)e(n)};I([M()],pe.prototype,"id",void 0);I([M()],pe.prototype,"uniqueId",void 0);I([M()],pe.prototype,"name",void 0);I([M()],pe.prototype,"metadata",void 0);I([M()],pe.prototype,"checkReadyOnEveryCall",void 0);I([M()],pe.prototype,"checkReadyOnlyOnce",void 0);I([M()],pe.prototype,"state",void 0);I([M("alpha")],pe.prototype,"_alpha",void 0);I([M("backFaceCulling")],pe.prototype,"_backFaceCulling",void 0);I([M("cullBackFaces")],pe.prototype,"_cullBackFaces",void 0);I([M()],pe.prototype,"sideOrientation",void 0);I([M("alphaMode")],pe.prototype,"_alphaMode",void 0);I([M()],pe.prototype,"_needDepthPrePass",void 0);I([M()],pe.prototype,"disableDepthWrite",void 0);I([M()],pe.prototype,"disableColorWrite",void 0);I([M()],pe.prototype,"forceDepthWrite",void 0);I([M()],pe.prototype,"depthFunction",void 0);I([M()],pe.prototype,"separateCullingPass",void 0);I([M("fogEnabled")],pe.prototype,"_fogEnabled",void 0);I([M()],pe.prototype,"pointSize",void 0);I([M()],pe.prototype,"zOffset",void 0);I([M()],pe.prototype,"zOffsetUnits",void 0);I([M()],pe.prototype,"pointsCloud",null);I([M()],pe.prototype,"fillMode",null);I([M()],pe.prototype,"useLogarithmicDepth",null);I([M()],pe.prototype,"transparencyMode",null);class Yn extends pe{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...r)=>{const s=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(r,s)=>{const a=i.apply(e,[r,s]);return this._markAllSubMeshesAsTexturesDirty(),a}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if((t=this.subMaterials[i])!=null&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){const s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,i))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){const i=new Yn(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let s=null;const a=this.subMaterials[r];t&&a?s=a.clone(e+"-"+a.name):s=this.subMaterials[r],i.subMaterials.push(s)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Pt&&(e.tags=Pt.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const r=this.getScene();if(!r)return;if(i)for(let a=0;a<this.subMaterials.length;a++){const o=this.subMaterials[a];o&&o.dispose(e,t)}const s=r.multiMaterials.indexOf(this);s>=0&&r.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new Yn(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Pt&&Pt.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(r=>i.subMaterials.push(t.getLastMaterialById(r))),i}}$("BABYLON.MultiMaterial",Yn);class N1{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class xC{}class L1{constructor(){this.visibleInstances={},this.batchCache=new hE,this.batchCacheReplacementModeInFrozenMode=new hE,this.instancesBufferSize=32*16*4}}class hE{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class F1{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class w1{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class k extends $t{static _GetDefaultSideOrientation(e){return e||k.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(b.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(b.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new Q),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new Q),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new Q),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new Q),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new Q),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===1||!this._scene.useRightHandedSystem&&e===0}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&this.material.sideOrientation===null||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,i=!0){const r=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),cr.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,r.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){const s=e._ranges;for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&s[a]&&this.createAnimationRange(a,s[a].from,s[a].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,Pt&&Pt.HasTags(e)&&Pt.AddTagsTo(this,Pt.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){const s=e.getDescendants(!0);for(let a=0;a<s.length;a++){const o=s[a];o.clone&&o.clone(this.name+"."+o.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),r.getPhysicsEngine){const s=r.getPhysicsEngine();if(i&&s)if(s.getPluginVersion()===1){const a=s.getImpostorForPhysicsObject(e);a&&(this.physicsImpostor=a.clone(this))}else s.getPluginVersion()===2&&e.physicsBody&&e.physicsBody.clone(this)}for(let s=0;s<r.particleSystems.length;s++){const a=r.particleSystems[s];a.emitter===e&&a.clone(a.name,this)}this.skeleton=e.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}constructor(e,t=null,i=null,r=null,s,a=!0){super(e,t),this._internalMeshDataInfo=new w1,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new L1,this._thinInstanceDataStorage=new F1,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=k.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(o,l,c)=>{o&&c&&(this._uniformBuffer?this.transferToEffect(l):c.bindOnlyWorldMatrix(l))},r&&this._copySource(r,s,a),i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=o=>{o.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new Q(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&s.sourceMesh===this?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):s.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),r=this.getVerticesData(b.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return w.Warn("You cannot use a mesh as LOD level twice"),this;const i=new N1(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;const r=t||this.getBoundingInfo().boundingSphere,s=e.mode===He.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length();let a=s,o=1;if(i._useLODScreenCoverage){const l=e.screenArea;let c=r.radiusWorld*e.minZ/s;c=c*c*Math.PI,a=c/l,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*a)return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const c=i._LODLevels[l];if(o*c.distanceOrScreenCoverage<o*a){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,r){var a,o;if(!this._geometry)return null;let s=r||(o=(a=this._userInstancedBuffersStorage)==null?void 0:a.vertexBuffers[e])==null?void 0:o.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return s||(s=this._geometry.getVerticesData(e,t,i)),s}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){var i;return this._geometry?(t||(i=this._userInstancedBuffersStorage)==null?void 0:i.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&((i=this._userInstancedBuffersStorage)==null?void 0:i.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){const r=(i=this._userInstancedBuffersStorage)==null?void 0:i.vertexBuffers[e];if(r)return r.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const i=[];return this._delayInfo&&this._delayInfo.forEach(function(r){i.push(r)}),i}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var l,c,u,h,f;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const i=this.getEngine(),r=this.getScene(),s=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const a=this.material||r.defaultMaterial;if(a){if(a._storeEffectOnSubMeshes)for(const d of this.subMeshes){const p=d.getMaterial();if(p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,d,s))return!1}else if(!p.isReady(this,s))return!1}}else if(!a.isReady(this,s))return!1}const o=i.currentRenderPassId;for(const d of this.lightSources){const p=d.getShadowGenerators();if(!p)continue;const _=p.values();for(let g=_.next();g.done!==!0;g=_.next()){const E=g.value;if(E&&(!((l=E.getShadowMap())!=null&&l.renderList)||(c=E.getShadowMap())!=null&&c.renderList&&((h=(u=E.getShadowMap())==null?void 0:u.renderList)==null?void 0:h.indexOf(this))!==-1)){const x=E.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let A=0;A<x.length;++A){i.currentRenderPassId=x[A];for(const T of this.subMeshes)if(!E.isReady(T,s,((f=T.getMaterial())==null?void 0:f.needAlphaBlendingForMesh(this))??!1))return i.currentRenderPassId=o,!1}i.currentRenderPassId=o}}}for(const d of this._internalMeshDataInfo._LODLevels)if(d.mesh&&!d.mesh.isReady(s))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};const r=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(i,null,b.PositionKind),r),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const r=i.length;let s=!1;if(e)s=!0;else for(const a of this.subMeshes){if(a.indexStart+a.indexCount>r){s=!0;break}if(a.verticesStart+a.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new _r(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let s=0;s<e&&!(r>=t);s++)_r.CreateFromIndices(0,r,s===e-1?t-r:i,this,void 0,!1),r+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{const s=new de;s.set(t,e);const a=this.getScene();new dr(dr.RandomId(),a,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=dr.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(b.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(b.PositionKind,i,!1,!1),t){const r=this.getIndices(),s=this.getVerticesData(b.NormalKind);if(!s)return this;de.ComputeNormals(i,r,s),this.updateVerticesData(b.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(dr.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i){let r=this._geometry;r||(r=new dr(dr.RandomId(),this.getScene(),void 0,void 0,this)),r.setIndexBuffer(e,t,i)}setIndices(e,t=null,i=!1,r=!1){if(this._geometry)this._geometry.setIndices(e,t,i,r);else{const s=new de;s.indices=e;const a=this.getScene();new dr(dr.RandomId(),a,s,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,r=!0){if(!this._geometry)return this;const s=this.getScene().getEngine();let a;if(this._unIndexed)switch(this._getRenderingFillMode(i)){case pe.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),s);break;default:a=null;break}else switch(this._getRenderingFillMode(i)){case pe.PointFillMode:a=null;break;case pe.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),s);break;default:case pe.TriangleFillMode:a=this._geometry.getIndexBuffer();break}return this._bindDirect(t,a,r)}_bindDirect(e,t,i=!0){return this._geometry?(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),!i||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(e,t):this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this):this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed&&t!==pe.WireFrameFillMode||t==pe.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==pe.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),r=i._isInIntermediateRendering(),s=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=this._instanceDataStorage.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=t||!s&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const o=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=r?o.intermediateDefaultRenderId:o.defaultRenderId;a.visibleInstances[e]=o[l],!a.visibleInstances[e]&&c&&(a.visibleInstances[e]=o[c])}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[e]!==null&&a.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=a,a}_renderWithInstances(e,t,i,r,s){var v;const a=i.visibleInstances[e._id],o=a?a.length:0,l=this._instanceDataStorage,c=l.instancesBufferSize;let u=l.instancesBuffer,h=l.instancesPreviousBuffer;const d=(o+1)*16*4;for(;l.instancesBufferSize<d;)l.instancesBufferSize*=2;(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4));let p=0,_=0;const g=i.renderSelf[e._id],E=!u||c!==l.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!l.isFrozen||E)){const x=this.getWorldMatrix();if(g&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,p),l.masterMeshPreviousWorldMatrix.copyFrom(x)):(l.masterMeshPreviousWorldMatrix=x.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,p))),x.copyToArray(l.instancesData,p),p+=16,_++),a){if(k.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((v=e.getMaterial())!=null&&v.needAlphaBlendingForMesh(e.getRenderingMesh()))){const A=this._scene.activeCamera.globalPosition;for(let T=0;T<a.length;T++){const C=a[T];C._distanceToCamera=m.Distance(C.getBoundingInfo().boundingSphere.centerWorld,A)}a.sort((T,C)=>T._distanceToCamera>C._distanceToCamera?-1:T._distanceToCamera<C._distanceToCamera?1:0)}for(let A=0;A<a.length;A++){const T=a[A],C=T.getWorldMatrix();C.copyToArray(l.instancesData,p),this._scene.needsPreviousWorldMatrices&&(T._previousWorldMatrix?(T._previousWorldMatrix.copyToArray(l.instancesPreviousData,p),T._previousWorldMatrix.copyFrom(C)):(T._previousWorldMatrix=C.clone(),T._previousWorldMatrix.copyToArray(l.instancesPreviousData,p))),p+=16,_++}}}else _=(g?1:0)+o;return E?(u&&u.dispose(),h&&h.dispose(),u=new tr(s,l.instancesData,!0,16,!1,!0),l.instancesBuffer=u,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=u.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=u.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=u.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=u.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(h=new tr(s,l.instancesPreviousData,!0,16,!1,!0),l.instancesPreviousBuffer=h,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=h.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=h.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=h.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=h.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(u.updateDirectly(l.instancesData,0,_),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&h.updateDirectly(l.instancesPreviousData,0,_)),this._processInstancedBuffers(a,g),this.getScene()._activeIndices.addCount(e.indexCount*_,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,r,t),this._draw(e,t,_),this._scene.needsPreviousWorldMatrices&&!E&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&h.updateDirectly(l.instancesData,0,_),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){var a;const s=((a=this._thinInstanceDataStorage)==null?void 0:a.instancesCount)??0;this.getScene()._activeIndices.addCount(e.indexCount*s,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,s),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,s):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,s,a,o,l){const c=this.getScene(),u=c.getEngine();if(r=this._getRenderingFillMode(r),a&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,u),this;if(a)this._renderWithInstances(t,r,s,i,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);let h=0;s.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),h++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));const f=s.visibleInstances[t._id];if(f){const d=f.length;h+=d;for(let p=0;p<d;p++){const g=f[p].getWorldMatrix();o&&o(!0,g,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*h,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,r,s=!0){const a=this._scene.getEngine(),o=a.currentRenderPassId;if(e!==void 0&&(a.currentRenderPassId=e),r)(!s||s&&r.isInFrustum(this._scene._frustumPlanes))&&this.render(r,!!t,i);else for(let l=0;l<this.subMeshes.length;l++){const c=this.subMeshes[l];(!s||s&&c.isInFrustum(this._scene._frustumPlanes))&&this.render(c,!!t,i)}return e!==void 0&&(a.currentRenderPassId=o),this}directRender(){if(!this.subMeshes)return this;for(const e of this.subMeshes)this.render(e,!1);return this}render(e,t,i){var y,P;const r=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const s=((y=r.activeCameras)==null?void 0:y.length)??0;if((s>1&&r.activeCamera===r.activeCameras[0]||s<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const o=this._getInstancesRenderList(e._id,!!i);if(o.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const l=r.getEngine();let c=0,u=null;this.ignoreCameraMaxZ&&r.activeCamera&&!r._isInIntermediateRendering()&&(c=r.activeCamera.maxZ,u=r.activeCamera,r.activeCamera.maxZ=0,r.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const h=e.getRenderingMesh(),f=o.hardwareInstancedRendering[e._id]||h.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,d=this._instanceDataStorage,p=e.getMaterial();if(!p)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;if(!d.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,f))return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this}else if(!p.isReady(this,f))return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}else if(p._storeEffectOnSubMeshes&&!((P=e._drawWrapper)!=null&&P._wasPreviouslyReady)||!p._storeEffectOnSubMeshes&&!p._getDrawWrapper()._wasPreviouslyReady)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;t&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let _;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?_=e._drawWrapper:_=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const g=(_==null?void 0:_.effect)??null;for(const D of r._beforeRenderingMeshStage)D.action(this,e,o,g);if(!_||!g)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;const E=i||this;let v;if(!d.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this._internalMeshDataInfo._effectiveMaterial.sideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)){const D=E._getWorldMatrixDeterminant();v=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),D<0&&(v=v===pe.ClockWiseSideOrientation?pe.CounterClockWiseSideOrientation:pe.ClockWiseSideOrientation),d.sideOrientation=v}else v=d.sideOrientation;const x=this._internalMeshDataInfo._effectiveMaterial._preBind(_,v);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);const A=this._internalMeshDataInfo._effectiveMaterial,T=A.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,g,T,!1);const C=E.getWorldMatrix();A._storeEffectOnSubMeshes?A.bindForSubMesh(C,this,e):A.bind(C,this),!A.backFaceCulling&&A.separateCullingPass&&(l.setState(!0,A.zOffset,!1,!x,A.cullBackFaces,A.stencil,A.zOffsetUnits),this._processRendering(this,e,g,T,o,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,A.zOffset,!1,x,A.cullBackFaces,A.stencil,A.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,g,T,o,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const D of r._afterRenderingMeshStage)D.action(this,e,o,g);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=c,r.updateTransformMatrix(!0)),r.performancePriority===2&&!d.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(b.MatricesWeightsKind)&&(this.isVerticesDataPresent(b.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(b.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{const s=1/r;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(b.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(b.MatricesWeightsExtraKind),t=this.getVerticesData(b.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let s=t[r]+t[r+1]+t[r+2]+t[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)t[r]=1;else{const a=1/s;t[r]*=a,t[r+1]*=a,t[r+2]*=a,t[r+3]*=a,e[r]*=a,e[r+1]*=a,e[r+2]*=a,e[r+3]*=a}}this.setVerticesData(b.MatricesWeightsKind,t),this.setVerticesData(b.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(b.MatricesWeightsExtraKind),t=this.getVerticesData(b.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let r=0,s=0,a=0,o=0;const l=e===null?4:8,c=[];for(let g=0;g<=l;g++)c[g]=0;const u=.001;for(let g=0;g<i;g+=4){let E=t[g],v=E,x=v===0?0:1;for(let A=1;A<l;A++){const T=A<4?t[g+A]:e[g+A-4];T>E&&r++,T!==0&&x++,v+=T,E=T}if(c[x]++,x>a&&(a=x),v===0)s++;else{const A=1/v;let T=0;for(let C=0;C<l;C++)C<4?T+=Math.abs(t[g+C]-t[g+C]*A):T+=Math.abs(e[g+C-4]-e[g+C-4]*A);T>u&&o++}}const h=this.skeleton.bones.length,f=this.getVerticesData(b.MatricesIndicesKind),d=this.getVerticesData(b.MatricesIndicesExtraKind);let p=0;for(let g=0;g<i;g+=4)for(let E=0;E<l;E++){const v=E<4?f[g+E]:d[g+E-4];(v>=h||v<0)&&p++}const _="Number of Weights = "+i/4+`
Maximum influences = `+a+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+o+`
WeightCounts = [`+c+`]
Number of bones = `+h+`
Bad Bone Indices = `+p;return{skinned:!0,valid:s===0&&o===0&&p===0,report:_}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return J.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(r=>{r.refreshBoundingInfo(),r._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(b.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(b.PositionKind);const r=m.Zero();let s;for(s=0;s<i.length;s+=3)m.TransformCoordinatesFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).toArray(i,s);if(this.setVerticesData(b.PositionKind,i,this.getVertexBuffer(b.PositionKind).isUpdatable()),this.isVerticesDataPresent(b.NormalKind)){for(i=this.getVerticesData(b.NormalKind),s=0;s<i.length;s+=3)m.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(b.NormalKind,i,this.getVertexBuffer(b.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(b.TangentKind)){for(i=this.getVerticesData(b.TangentKind),s=0;s<i.length;s+=4)m.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(b.TangentKind,i,this.getVertexBuffer(b.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){return new k(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const r in i.meshMap){const s=i.meshMap[r];s&&(s._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const r=this.getScene().meshes;for(const s of r){const a=s;a._internalMeshDataInfo&&a._internalMeshDataInfo._source&&a._internalMeshDataInfo._source===this&&(a._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,s,a,o=!1,l){const c=this.getScene(),u=h=>{const f=h.width,d=h.height,_=this.getEngine().createCanvas(f,d).getContext("2d");_.drawImage(h,0,0);const g=_.getImageData(0,0,f,d).data;this.applyDisplacementMapFromBuffer(g,f,d,t,i,s,a,o),r&&r(this)};return J.LoadImage(e,u,l||(()=>{}),c.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,s,a,o,l=!1){if(!this.isVerticesDataPresent(b.PositionKind)||!this.isVerticesDataPresent(b.NormalKind)||!this.isVerticesDataPresent(b.UVKind))return w.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(b.PositionKind,!0,!0),u=this.getVerticesData(b.NormalKind),h=this.getVerticesData(b.UVKind);let f=m.Zero();const d=m.Zero(),p=se.Zero();a=a||se.Zero(),o=o||new se(1,1);for(let _=0;_<c.length;_+=3){m.FromArrayToRef(c,_,f),m.FromArrayToRef(u,_,d),se.FromArrayToRef(h,_/3*2,p);const g=Math.abs(p.x*o.x+a.x%1)*(t-1)%t|0,E=Math.abs(p.y*o.y+a.y%1)*(i-1)%i|0,v=(g+E*t)*4,x=e[v]/255,A=e[v+1]/255,T=e[v+2]/255,C=x*.3+A*.59+T*.11;d.normalize(),d.scaleInPlace(r+(s-r)*C),f=f.add(d),f.toArray(c,_)}return de.ComputeNormals(c,this.getIndices(),u),l?(this.setVerticesData(b.PositionKind,c),this.setVerticesData(b.NormalKind,u),this.setVerticesData(b.UVKind,h)):(this.updateVerticesData(b.PositionKind,c),this.updateVerticesData(b.NormalKind,u)),this}_getFlattenedNormals(e,t){const i=new Float32Array(e.length*3);let r=0;const s=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let a=0;a<e.length;a+=3){const o=m.FromArray(t,e[a]*3),l=m.FromArray(t,e[a+1]*3),c=m.FromArray(t,e[a+2]*3),u=o.subtract(l),h=c.subtract(l),f=m.Normalize(m.Cross(u,h));s&&f.scaleInPlace(-1);for(let d=0;d<3;d++)i[r++]=f.x,i[r++]=f.y,i[r++]=f.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds().filter(l=>{var c;return!((c=this.getVertexBuffer(l))!=null&&c.getIsInstanced())}),i=this.getIndices(),r={},s=(l,c)=>{const u=new Float32Array(i.length*c);let h=0;for(let f=0;f<i.length;f++)for(let d=0;d<c;d++)u[h++]=l[i[f]*c+d];return u},a=this.getBoundingInfo(),o=this.geometry?this.subMeshes.slice(0):[];for(const l of t)r[l]=this.getVerticesData(l);for(const l of t){const c=this.getVertexBuffer(l),u=c.getSize();if(e&&l===b.NormalKind){const h=this._getFlattenedNormals(i,r[b.PositionKind]);this.setVerticesData(b.NormalKind,h,c.isUpdatable(),u)}else this.setVerticesData(l,s(r[l],u),c.isUpdatable(),u)}if(this.morphTargetManager){for(let l=0;l<this.morphTargetManager.numTargets;l++){const c=this.morphTargetManager.getTarget(l),u=c.getPositions();c.setPositions(s(u,3));const h=c.getNormals();h&&c.setNormals(e?this._getFlattenedNormals(i,u):s(h,3));const f=c.getTangents();f&&c.setTangents(s(f,3));const d=c.getUVs();d&&c.setUVs(s(d,2))}this.morphTargetManager.synchronize()}for(let l=0;l<i.length;l++)i[l]=l;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const l of o){const c=l.getBoundingInfo();_r.AddToMesh(l.materialIndex,l.indexStart,l.indexCount,l.indexStart,l.indexCount,this).setBoundingInfo(c)}return this.setBoundingInfo(a),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=de.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(b.NormalKind)&&t.normals){for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;this.setVerticesData(b.NormalKind,t.normals,this.isVertexBufferUpdatable(b.NormalKind))}if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(b.PositionKind),!0)}return this}increaseVertices(e=1){const t=de.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,a=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)w.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,s&&(t.uvs=s),a&&(t.normals=a);const o=e+1,l=new Array;for(let T=0;T<o+1;T++)l[T]=new Array;let c,u;const h=new m(0,0,0),f=new m(0,0,0),d=new se(0,0),p=new Array,_=new Array,g=new Array;let E,v=r.length,x;s&&(x=s.length);let A;a&&(A=a.length);for(let T=0;T<i.length;T+=3){_[0]=i[T],_[1]=i[T+1],_[2]=i[T+2];for(let C=0;C<3;C++)if(c=_[C],u=_[(C+1)%3],g[c]===void 0&&g[u]===void 0?(g[c]=new Array,g[u]=new Array):(g[c]===void 0&&(g[c]=new Array),g[u]===void 0&&(g[u]=new Array)),g[c][u]===void 0&&g[u][c]===void 0){g[c][u]=[],h.x=(r[3*u]-r[3*c])/o,h.y=(r[3*u+1]-r[3*c+1])/o,h.z=(r[3*u+2]-r[3*c+2])/o,a&&(f.x=(a[3*u]-a[3*c])/o,f.y=(a[3*u+1]-a[3*c+1])/o,f.z=(a[3*u+2]-a[3*c+2])/o),s&&(d.x=(s[2*u]-s[2*c])/o,d.y=(s[2*u+1]-s[2*c+1])/o),g[c][u].push(c);for(let y=1;y<o;y++)g[c][u].push(r.length/3),r[v++]=r[3*c]+y*h.x,r[v++]=r[3*c+1]+y*h.y,r[v++]=r[3*c+2]+y*h.z,a&&(a[A++]=a[3*c]+y*f.x,a[A++]=a[3*c+1]+y*f.y,a[A++]=a[3*c+2]+y*f.z),s&&(s[x++]=s[2*c]+y*d.x,s[x++]=s[2*c+1]+y*d.y);g[c][u].push(u),g[u][c]=new Array,E=g[c][u].length;for(let y=0;y<E;y++)g[u][c][y]=g[c][u][E-1-y]}l[0][0]=i[T],l[1][0]=g[i[T]][i[T+1]][1],l[1][1]=g[i[T]][i[T+2]][1];for(let C=2;C<o;C++){l[C][0]=g[i[T]][i[T+1]][C],l[C][C]=g[i[T]][i[T+2]][C],h.x=(r[3*l[C][C]]-r[3*l[C][0]])/C,h.y=(r[3*l[C][C]+1]-r[3*l[C][0]+1])/C,h.z=(r[3*l[C][C]+2]-r[3*l[C][0]+2])/C,a&&(f.x=(a[3*l[C][C]]-a[3*l[C][0]])/C,f.y=(a[3*l[C][C]+1]-a[3*l[C][0]+1])/C,f.z=(a[3*l[C][C]+2]-a[3*l[C][0]+2])/C),s&&(d.x=(s[2*l[C][C]]-s[2*l[C][0]])/C,d.y=(s[2*l[C][C]+1]-s[2*l[C][0]+1])/C);for(let y=1;y<C;y++)l[C][y]=r.length/3,r[v++]=r[3*l[C][0]]+y*h.x,r[v++]=r[3*l[C][0]+1]+y*h.y,r[v++]=r[3*l[C][0]+2]+y*h.z,a&&(a[A++]=a[3*l[C][0]]+y*f.x,a[A++]=a[3*l[C][0]+1]+y*f.y,a[A++]=a[3*l[C][0]+2]+y*f.z),s&&(s[x++]=s[2*l[C][0]]+y*d.x,s[x++]=s[2*l[C][0]+1]+y*d.y)}l[o]=g[i[T+1]][i[T+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let C=1;C<o;C++){let y;for(y=0;y<C;y++)p.push(l[C][y],l[C+1][y],l[C+1][y+1]),p.push(l[C][y],l[C+1][y+1],l[C][y+1]);p.push(l[C][y],l[C+1][y],l[C+1][y+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(b.PositionKind))}}forceSharedVertices(){const e=de.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,s=e.colors,a=e.matricesIndices,o=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)w.Warn("VertexData contains empty entries");else{const u=new Array,h=new Array,f=new Array,d=new Array,p=new Array,_=new Array,g=new Array,E=new Array;let v=new Array,x=0;const A={};let T,C;for(let P=0;P<i.length;P+=3){C=[i[P],i[P+1],i[P+2]],v=[];for(let D=0;D<3;D++){v[D]="";for(let F=0;F<3;F++)Math.abs(r[3*C[D]+F])<1e-8&&(r[3*C[D]+F]=0),v[D]+=r[3*C[D]+F]+"|"}if(!(v[0]==v[1]||v[0]==v[2]||v[1]==v[2]))for(let D=0;D<3;D++){if(T=A[v[D]],T===void 0){A[v[D]]=x,T=x++;for(let F=0;F<3;F++)u.push(r[3*C[D]+F]);if(s!=null)for(let F=0;F<4;F++)d.push(s[4*C[D]+F]);if(t!=null)for(let F=0;F<2;F++)f.push(t[2*C[D]+F]);if(a!=null)for(let F=0;F<4;F++)p.push(a[4*C[D]+F]);if(o!=null)for(let F=0;F<4;F++)_.push(o[4*C[D]+F]);if(l!=null)for(let F=0;F<4;F++)g.push(l[4*C[D]+F]);if(c!=null)for(let F=0;F<4;F++)E.push(c[4*C[D]+F])}h.push(T)}}const y=new Array;de.ComputeNormals(u,h,y),e.positions=u,e.indices=h,e.normals=y,t!=null&&(e.uvs=f),s!=null&&(e.colors=d),a!=null&&(e.matricesIndices=p),o!=null&&(e.matricesWeights=_),l!=null&&(e.matricesIndicesExtra=g),o!=null&&(e.matricesWeightsExtra=E),e.applyToMesh(this,this.isVertexBufferUpdatable(b.PositionKind))}}static _instancedMeshFactory(e,t){throw rt("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw rt("PhysicsImpostor")}createInstance(e){const t=k._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(b.PositionKind);if(!i||!t)return this;const r=[];for(let a=0;a<i.length;a=a+3)r.push(m.FromArray(i,a));const s=[];return Os.SyncAsyncForLoop(r.length,40,a=>{const o=r.length-1-a,l=r[o];for(let c=0;c<o;++c){const u=r[c];if(l.equals(u)){s[o]=c;break}}},()=>{for(let o=0;o<t.length;++o)t[o]=s[t[o]]||t[o];const a=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=a,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Pt&&Pt.HasTags(this)&&(e.tags=Pt.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(we.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const r=this.instances[i];if(r.doNotSerialize)continue;const s={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(s),r.rotationQuaternion?s.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(s.rotation=r.rotation.asArray()),this.getScene()._getComponent(we.NAME_PHYSICSENGINE)){const a=r.getPhysicsImpostor();a&&(s.physicsMass=a.getParam("mass"),s.physicsFriction=a.getParam("friction"),s.physicsRestitution=a.getParam("mass"),s.physicsImpostor=a.type)}r.metadata&&(s.metadata=r.metadata),r.actionManager&&(s.actions=r.actionManager.serialize(r.name)),e.instances.push(s),Ke.AppendSerializedAnimations(r,s),s.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return Ke.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){w.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),r=i.getPositions();if(!r){w.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(b.PositionKind+t,r,!1,3);const s=i.getNormals();s&&this.geometry.setVerticesData(b.NormalKind+t,s,!1,3);const a=i.getTangents();a&&this.geometry.setVerticesData(b.TangentKind+t,a,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(b.UVKind+"_"+t,o,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(b.PositionKind+t);)this.geometry.removeVerticesData(b.PositionKind+t),this.geometry.isVerticesDataPresent(b.NormalKind+t)&&this.geometry.removeVerticesData(b.NormalKind+t),this.geometry.isVerticesDataPresent(b.TangentKind+t)&&this.geometry.removeVerticesData(b.TangentKind+t),this.geometry.isVerticesDataPresent(b.UVKind+t)&&this.geometry.removeVerticesData(b.UVKind+"_"+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=k._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=k._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=k._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=k._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?r=k._TrailMeshParser(e,t):r=new k(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,Pt&&Pt.AddTagsTo(r,e.tags),r.position=m.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=ce.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=m.FromArray(e.rotation)),r.scaling=m.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(O.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(O.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(r.ellipsoid=m.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(r.ellipsoidOffset=m.FromArray(e.ellipsoidOffset)),e.overrideMaterialSideOrientation!=null&&(r.sideOrientation=e.overrideMaterialSideOrientation),e.sideOrientation!==void 0&&(r.sideOrientation=e.sideOrientation),e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=fe.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(b.UVKind),e.hasUVs2&&r._delayInfo.push(b.UV2Kind),e.hasUVs3&&r._delayInfo.push(b.UV3Kind),e.hasUVs4&&r._delayInfo.push(b.UV4Kind),e.hasUVs5&&r._delayInfo.push(b.UV5Kind),e.hasUVs6&&r._delayInfo.push(b.UV6Kind),e.hasColors&&r._delayInfo.push(b.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(b.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(b.MatricesWeightsKind),r._delayLoadingFunction=dr._ImportGeometry,Xi.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):dr._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r._waitingMorphTargetManagerId=e.morphTargetManagerId),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=Ai("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}Lt.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&(r.physicsImpostor=k._PhysicsImpostorParser(t,r,e)),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){const a=e.instances[s],o=r.createInstance(a.name);if(a.id&&(o.id=a.id),Pt&&(a.tags?Pt.AddTagsTo(o,a.tags):Pt.AddTagsTo(o,e.tags)),o.position=m.FromArray(a.position),a.metadata!==void 0&&(o.metadata=a.metadata),a.parentId!==void 0&&(o._waitingParentId=a.parentId),a.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=a.parentInstanceIndex),a.isEnabled!==void 0&&a.isEnabled!==null&&o.setEnabled(a.isEnabled),a.isVisible!==void 0&&a.isVisible!==null&&(o.isVisible=a.isVisible),a.isPickable!==void 0&&a.isPickable!==null&&(o.isPickable=a.isPickable),a.rotationQuaternion?o.rotationQuaternion=ce.FromArray(a.rotationQuaternion):a.rotation&&(o.rotation=m.FromArray(a.rotation)),o.scaling=m.FromArray(a.scaling),a.checkCollisions!=null&&a.checkCollisions!=null&&(o.checkCollisions=a.checkCollisions),a.pickable!=null&&a.pickable!=null&&(o.isPickable=a.pickable),a.showBoundingBox!=null&&a.showBoundingBox!=null&&(o.showBoundingBox=a.showBoundingBox),a.showSubMeshesBoundingBox!=null&&a.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=a.showSubMeshesBoundingBox),a.alphaIndex!=null&&a.showSubMeshesBoundingBox!=null&&(o.alphaIndex=a.alphaIndex),a.physicsImpostor&&(o.physicsImpostor=k._PhysicsImpostorParser(t,o,a)),a.actions!==void 0&&(o._waitingData.actions=a.actions),a.animations){for(let l=0;l<a.animations.length;l++){const c=a.animations[l],u=Ai("BABYLON.Animation");u&&o.animations.push(u.Parse(c))}Lt.ParseAnimationRanges(o,a,t),a.autoAnimate&&t.beginAnimation(o,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1)}}if(e.thinInstances){const s=e.thinInstances;if(r.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=s.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){const a=e.thinInstances.userThinInstance;for(const o in a.data)r.thinInstanceSetBuffer(o,new Float32Array(a.data[o]),a.strides[o],!1),r._userThinInstanceBuffersStorage.sizes[o]=a.sizes[o]}}return r}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(b.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(b.PositionKind)||this.setVerticesData(b.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(b.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(b.NormalKind)||this.setVerticesData(b.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(b.PositionKind))return this;if(!this.isVerticesDataPresent(b.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(b.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(b.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const E=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=E}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(b.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let s=this.getVerticesData(b.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}const a=this.getVerticesData(b.MatricesIndicesKind),o=this.getVerticesData(b.MatricesWeightsKind);if(!o||!a)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(b.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(b.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),f=m.Zero(),d=new O,p=new O;let _=0,g;for(let E=0;E<r.length;E+=3,_+=4){let v;for(g=0;g<4;g++)v=o[_+g],v>0&&(O.FromFloat32ArrayToRefScaled(h,Math.floor(a[_+g]*16),v,p),d.addToSelf(p));if(l)for(g=0;g<4;g++)v=u[_+g],v>0&&(O.FromFloat32ArrayToRefScaled(h,Math.floor(c[_+g]*16),v,p),d.addToSelf(p));m.TransformCoordinatesFromFloatsToRef(i._sourcePositions[E],i._sourcePositions[E+1],i._sourcePositions[E+2],d,f),f.toArray(r,E),t&&(m.TransformNormalFromFloatsToRef(i._sourceNormals[E],i._sourceNormals[E+1],i._sourceNormals[E+2],d,f),f.toArray(s,E)),d.reset()}return this.updateVerticesData(b.PositionKind,r),t&&this.updateVerticesData(b.NormalKind,s),this}static MinMax(e){let t=null,i=null;return e.forEach(function(r){const a=r.getBoundingInfo().boundingBox;!t||!i?(t=a.minimumWorld,i=a.maximumWorld):(t.minimizeInPlace(a.minimumWorld),i.maximizeInPlace(a.maximumWorld))}),!t||!i?{min:m.Zero(),max:m.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?k.MinMax(e):e;return m.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,s,a){return rh(k._MergeMeshesCoroutine(e,t,i,r,s,a,!1))}static MergeMeshesAsync(e,t=!0,i,r,s,a){return ad(k._MergeMeshesCoroutine(e,t,i,r,s,a,!0),nd())}static*_MergeMeshesCoroutine(e,t=!0,i,r,s,a,o){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let y=0;for(l=0;l<e.length;l++)if(y+=e[l].getTotalVertices(),y>=65536)return w.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}a&&(s=!1);const c=new Array,u=new Array,h=new Array,f=e[0].sideOrientation;for(l=0;l<e.length;l++){const y=e[l];if(y.isAnInstance)return w.Warn("Cannot merge instance meshes."),null;if(f!==y.sideOrientation)return w.Warn("Cannot merge meshes with different sideOrientation values."),null;if(s&&h.push(y.getTotalIndices()),a)if(y.material){const P=y.material;if(P instanceof Yn){for(let D=0;D<P.subMaterials.length;D++)c.indexOf(P.subMaterials[D])<0&&c.push(P.subMaterials[D]);for(let D=0;D<y.subMeshes.length;D++)u.push(c.indexOf(P.subMaterials[y.subMeshes[D].materialIndex])),h.push(y.subMeshes[D].indexCount)}else{c.indexOf(P)<0&&c.push(P);for(let D=0;D<y.subMeshes.length;D++)u.push(c.indexOf(P)),h.push(y.subMeshes[D].indexCount)}}else for(let P=0;P<y.subMeshes.length;P++)u.push(0),h.push(y.subMeshes[P].indexCount)}const d=e[0],p=y=>{const P=y.computeWorldMatrix(!0);return{vertexData:de.ExtractFromMesh(y,!1,!1),transform:P}},{vertexData:_,transform:g}=p(d);o&&(yield);const E=new Array(e.length-1);for(let y=1;y<e.length;y++)E[y-1]=p(e[y]),o&&(yield);const v=_._mergeCoroutine(g,E,i,o,!t);let x=v.next();for(;!x.done;)o&&(yield),x=v.next();const A=x.value;r||(r=new k(d.name+"_merged",d.getScene()));const T=A._applyToCoroutine(r,void 0,o);let C=T.next();for(;!C.done;)o&&(yield),C=T.next();if(r.checkCollisions=d.checkCollisions,r.sideOrientation=d.sideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||a){r.releaseSubMeshes(),l=0;let y=0;for(;l<h.length;)_r.CreateFromIndices(0,y,h[l],r,void 0,!1),y+=h[l],l++;for(const P of r.subMeshes)P.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(a){const y=new Yn(d.name+"_merged",d.getScene());y.subMaterials=c;for(let P=0;P<r.subMeshes.length;P++)r.subMeshes[P].materialIndex=u[P];r.material=y}else r.material=d.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===pe.CounterClockWiseSideOrientation}_getRenderingFillMode(e){const t=this.getScene();return t.forcePointsCloud?pe.PointFillMode:t.forceWireframe?pe.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,r,s,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,r,s,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,r,s,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,r,s,a,o,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,r,s,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,r,s,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,r,s,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,r,s,a,o,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,r,s,a,o,l,c,u,h,f){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,r,s,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,r,s,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,r,s,a,o,l,c,u,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,r,s,a,o,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,r,s,a){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}k.FRONTSIDE=de.FRONTSIDE;k.BACKSIDE=de.BACKSIDE;k.DOUBLESIDE=de.DOUBLESIDE;k.DEFAULTSIDE=de.DEFAULTSIDE;k.NO_CAP=0;k.CAP_START=1;k.CAP_END=2;k.CAP_ALL=3;k.NO_FLIP=0;k.FLIP_TILE=1;k.ROTATE_TILE=2;k.FLIP_ROW=3;k.ROTATE_ROW=4;k.FLIP_N_ROTATE_TILE=5;k.FLIP_N_ROTATE_ROW=6;k.CENTER=0;k.LEFT=1;k.RIGHT=2;k.TOP=3;k.BOTTOM=4;k.INSTANCEDMESH_SORT_TRANSPARENT=!1;k._GroundMeshParser=(n,e)=>{throw rt("GroundMesh")};k._GoldbergMeshParser=(n,e)=>{throw rt("GoldbergMesh")};k._LinesMeshParser=(n,e)=>{throw rt("LinesMesh")};k._GreasedLineMeshParser=(n,e)=>{throw rt("GreasedLineMesh")};k._GreasedLineRibbonMeshParser=(n,e)=>{throw rt("GreasedLineRibbonMesh")};k._TrailMeshParser=(n,e)=>{throw rt("TrailMesh")};$("BABYLON.Mesh",k);k._PhysicsImpostorParser=function(n,e,t){return new ct(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},n)};class ct{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=m.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new ce,this._tmpQuat2=new ce,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new ce),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(s=>{s(this)}))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach(s=>{s(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,ct._TmpVecs[0]),this.object.translate(ct._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=s=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const a=this._physicsEngine.getImpostorWithPhysicsBody(s.body);a&&(this.onCollideEvent&&this.onCollideEvent(this,a),this._onPhysicsCollideCallbacks.filter(o=>o.otherImpostors.indexOf(a)!==-1).forEach(o=>{o.callback(this,a,s.point,s.distance,s.impulse,s.normal)}))},!this.object){w.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&w.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=ce.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new ce),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&w.Warn("You must affect impostors to children before affecting impostor to parent.")):w.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof $t?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=ct.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}else return ct.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):m.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):m.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):w.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):w.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let r=-1;this._onPhysicsCollideCallbacks.some((a,o)=>{if(a.callback===t&&a.otherImpostors.length===i.length){const l=a.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(r=o),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):w.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):ce.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const r=new ci(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,s){if(!this._physicsEngine)return this;const a=this._physicsEngine.getPhysicsPlugin();return a.appendAnchor?(this._physicsEngine&&a.appendAnchor(this,e,t,i,r,s),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;const s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new ct(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new ce),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,s){const a=ct._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(s){const l=ct._TmpQuat;o.rotationQuaternion.multiplyToRef(s,l),e.setRotationQuaternion(l,1,t)}else e.setRotationQuaternion(o.rotationQuaternion,1,t);a.x=0,a.y=0,a.z=0,i&&(a.x=i.x,a.y=i.y,a.z=i.z,e.getDirectionToRef(a,t,a),r==null&&(r=i.length()),a.x*=r,a.y*=r,a.z*=r),e.getParent()?(a.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(a,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=a.x,t.position.y-=a.y,t.position.z-=a.z)}syncImpostorWithBone(e,t,i,r,s,a){const o=this.object;if(o.rotationQuaternion)if(s){const u=ct._TmpQuat;e.getRotationQuaternionToRef(1,t,u),u.multiplyToRef(s,o.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,o.rotationQuaternion);const l=ct._TmpVecs[0],c=ct._TmpVecs[1];a||(a=ct._TmpVecs[2],a.x=0,a.y=1,a.z=0),e.getDirectionToRef(a,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),o.setAbsolutePosition(l)}}ct.DEFAULT_OBJECT_SIZE=new m(1,1,1);ct.IDENTITY_QUATERNION=ce.Identity();ct._TmpVecs=ms(3,m.Zero);ct._TmpQuat=ce.Identity();ct.NoImpostor=0;ct.SphereImpostor=1;ct.BoxImpostor=2;ct.PlaneImpostor=3;ct.MeshImpostor=4;ct.CapsuleImpostor=6;ct.CylinderImpostor=7;ct.ParticleImpostor=8;ct.HeightmapImpostor=9;ct.ConvexHullImpostor=10;ct.CustomImpostor=100;ct.RopeImpostor=101;ct.ClothImpostor=102;ct.SoftbodyImpostor=103;class B1{constructor(){this._hasHit=!1,this._hitNormal=m.Zero(),this._hitPoint=m.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}class vh extends B1{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=m.Zero(),this._rayToWorld=m.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=m.Distance(this._rayFromWorld,this._hitPoint)}reset(e=m.Zero(),t=m.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}}class md{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new ce,this._minus90X=new ce(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new ce(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=m.Zero(),this._tmpDeltaPosition=m.Zero(),this._tmpUnityRotation=new ce,this.BJSCANNON=i,!this.isSupported()){w.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new vh}getPluginVersion(){return 1}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const i of t)i.type==ct.HeightmapImpostor||i.type===ct.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{typeof this.world.removeBody=="function"?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(s,r)}applyForce(e,t,i){const r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(s,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t){w.Warn("It was not possible to create a physics body for this object.");return}const i=e.physicsBody;i&&this.removePhysicsBody(e);const r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),s={mass:e.getParam("mass"),material:r},a=e.getParam("nativeOptions");for(const o in a)Object.prototype.hasOwnProperty.call(a,o)&&(s[o]=a[o]);e.physicsBody=new this.BJSCANNON.Body(s),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),typeof this.world.addBody=="function"?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(o){const l=i[o];e.physicsBody[o].set(l.x,l.y,l.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const r=s=>{if(!s.rotationQuaternion)return;const a=s.getPhysicsImpostor();if(a&&a.parent!==e&&s.parent){const l=s.getAbsolutePosition().subtract(s.parent.getAbsolutePosition()),c=s.rotationQuaternion.multiply(this._tmpQuaternion);a.physicsBody&&(this.removePhysicsBody(a),a.physicsBody=null),a.parent=e,a.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(a),new this.BJSCANNON.Vec3(l.x,l.y,l.z),new this.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w)),e.physicsBody.mass+=a.getParam("mass")}s.getChildMeshes(!0).filter(o=>!!o.physicsImpostor).forEach(r)};t.filter(s=>!!s.physicsImpostor).forEach(r)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r;const s=e.joint.jointData,a={pivotA:s.mainPivot?new this.BJSCANNON.Vec3().set(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z):null,pivotB:s.connectedPivot?new this.BJSCANNON.Vec3().set(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z):null,axisA:s.mainAxis?new this.BJSCANNON.Vec3().set(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z):null,axisB:s.connectedAxis?new this.BJSCANNON.Vec3().set(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case ci.HingeJoint:case ci.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,a);break;case ci.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,s.maxDistance||2);break;case ci.SpringJoint:{const o=s;r=new this.BJSCANNON.Spring(t,i,{restLength:o.length,stiffness:o.stiffness,damping:o.damping,localAnchorA:a.pivotA,localAnchorB:a.pivotB});break}case ci.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,a);break;case ci.PointToPointJoint:case ci.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,a.pivotA,i,a.pivotB,a.maxForce);break}r.collideConnected=!!s.collision,e.joint.physicsJoint=r,e.joint.type!==ci.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==ci.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,s;for(r=0;r<this._physicsMaterials.length;r++)if(s=this._physicsMaterials[r],s.friction===t&&s.restitution===i)return s;const a=new this.BJSCANNON.Material(e);return a.friction=t,a.restitution=i,this._physicsMaterials.push(a),a}_checkWithEpsilon(e){return e<pt?pt:e}_createShape(e){const t=e.object;let i;const r=e.getObjectExtents();switch(e.type){case ct.SphereImpostor:{const s=r.x,a=r.y,o=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(s),this._checkWithEpsilon(a),this._checkWithEpsilon(o))/2);break}case ct.CylinderImpostor:{let s=e.getParam("nativeOptions");s||(s={});const a=s.radiusTop!==void 0?s.radiusTop:this._checkWithEpsilon(r.x)/2,o=s.radiusBottom!==void 0?s.radiusBottom:this._checkWithEpsilon(r.x)/2,l=s.height!==void 0?s.height:this._checkWithEpsilon(r.y),c=s.numSegments!==void 0?s.numSegments:16;i=new this.BJSCANNON.Cylinder(a,o,l,c);const u=new this.BJSCANNON.Quaternion;u.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const h=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(h,u);break}case ct.BoxImpostor:{const s=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(s.x),this._checkWithEpsilon(s.y),this._checkWithEpsilon(s.z)));break}case ct.PlaneImpostor:w.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case ct.MeshImpostor:{const s=t.getVerticesData?t.getVerticesData(b.PositionKind):[],a=t.getIndices?t.getIndices():[];if(!s){w.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}const o=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const u=t.computeWorldMatrix(!0),h=[];let f;for(f=0;f<s.length;f+=3)m.TransformCoordinates(m.FromArray(s,f),u).toArray(h,f);w.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(h,a),t.position.copyFrom(o),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case ct.HeightmapImpostor:{const s=t.position.clone(),a=t.rotation&&t.rotation.clone(),o=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(s),a&&t.rotation&&t.rotation.copyFrom(a),o&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(o),t.computeWorldMatrix(!0);break}case ct.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case ct.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i}_createHeightmap(e,t){let i=e.getVerticesData(b.PositionKind);const r=e.computeWorldMatrix(!0),s=[];let a;for(a=0;a<i.length;a+=3)m.TransformCoordinates(m.FromArray(i,a),r).toArray(s,a);i=s;const o=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),u=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),h=c.boundingBox.extendSizeWorld.z,f=u*2/l;for(let p=0;p<i.length;p=p+3){const _=Math.round(i[p+0]/f+l/2),g=Math.round((i[p+1]/f-l/2)*-1),E=-i[p+2]+h;o[_]||(o[_]=[]),o[_][g]||(o[_][g]=E),o[_][g]=Math.max(E,o[_][g])}for(let p=0;p<=l;++p){if(!o[p]){let _=1;for(;!o[(p+_)%l];)_++;o[p]=o[(p+_)%l].slice()}for(let _=0;_<=l;++_)if(!o[p][_]){let g=1,E;for(;E===void 0;)E=o[p][(_+g++)%l];o[p][_]=E}}const d=new this.BJSCANNON.Heightfield(o,{elementSize:f});return d.minY=h,d}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if((e.type===ct.PlaneImpostor||e.type===ct.HeightmapImpostor)&&(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===ct.HeightmapImpostor){const s=t;let a=s.getBoundingInfo();const o=s.rotationQuaternion;s.rotationQuaternion=this._tmpUnityRotation,s.computeWorldMatrix(!0);const l=i.clone();let c=s.getPivotMatrix();c?c=c.clone():c=O.Identity();const u=O.Translation(a.boundingBox.extendSizeWorld.x,0,-a.boundingBox.extendSizeWorld.z);s.setPreTransformMatrix(u),s.computeWorldMatrix(!0),a=s.getBoundingInfo();const h=a.boundingBox.centerWorld.subtract(i).subtract(s.position).negate();this._tmpPosition.copyFromFloats(h.x,h.y-a.boundingBox.extendSizeWorld.y,h.z),this._tmpDeltaPosition.copyFrom(a.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=a.boundingBox.extendSizeWorld.y,s.rotationQuaternion=o,s.setPreTransformMatrix(c),s.computeWorldMatrix(!0)}else e.type===ct.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new m(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new m(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=t===void 0?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2,t.y=i.halfExtents.y*2,t.z=i.halfExtents.z*2}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,s){if(s=s||10,r=r||0,r===0)this.internalStep(i),this.time+=i;else{let a=Math.floor((this.time+r)/i)-Math.floor(this.time/i);a=Math.min(a,s)||1;const o=performance.now();for(let f=0;f!==a&&(this.internalStep(i),!(performance.now()-o>i*1e3));f++);this.time+=r;const c=this.time%i/i,u=e,h=this.bodies;for(let f=0;f!==h.length;f++){const d=h[f];d.type!==t.Body.STATIC&&d.sleepState!==t.Body.SLEEPING?(d.position.vsub(d.previousPosition,u),u.scale(c,u),d.position.vadd(u,d.interpolatedPosition)):(d.interpolatedPosition.set(d.position.x,d.position.y,d.position.z),d.interpolatedQuaternion.set(d.quaternion.x,d.quaternion.y,d.quaternion.z,d.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}SC.DefaultPluginFactory=()=>new md;function CC(n){let e=n.pathArray;const t=n.closeArray||!1,i=n.closePath||!1,r=n.invertUV||!1,s=Math.floor(e[0].length/2);let a=n.offset||s;a=a>s?s:Math.floor(a);const o=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,l=n.uvs,c=n.colors,u=[],h=[],f=[],d=[],p=[],_=[],g=[],E=[];let v;const x=[],A=[];let T,C,y;if(e.length<2){const xe=[],z=[];for(C=0;C<e[0].length-a;C++)xe.push(e[0][C]),z.push(e[0][C+a]);e=[xe,z]}let P=0;const D=i?1:0,F=t?1:0;let W,H;v=e[0].length;let ue,ae;for(T=0;T<e.length+F;T++){for(g[T]=0,p[T]=[0],W=T===e.length?e[0]:e[T],H=W.length,v=v<H?v:H,y=0;y<H;)u.push(W[y].x,W[y].y,W[y].z),y>0&&(ue=W[y].subtract(W[y-1]).length(),ae=ue+g[T],p[T].push(ae),g[T]=ae),y++;i&&(y--,u.push(W[0].x,W[0].y,W[0].z),ue=W[y].subtract(W[0]).length(),ae=ue+g[T],p[T].push(ae),g[T]=ae),x[T]=H+D,A[T]=P,P+=H+D}let le,oe,ge=null,Ee=null;for(C=0;C<v+D;C++)for(E[C]=0,_[C]=[0],T=0;T<e.length-1+F;T++)le=e[T],oe=T===e.length-1?e[0]:e[T+1],C===v?(ge=le[0],Ee=oe[0]):(ge=le[C],Ee=oe[C]),ue=Ee.subtract(ge).length(),ae=ue+E[C],_[C].push(ae),E[C]=ae;let ne,j;if(l)for(T=0;T<l.length;T++)d.push(l[T].x,l[T].y);else for(T=0;T<e.length+F;T++)for(C=0;C<v+D;C++)ne=g[T]!=0?p[T][C]/g[T]:0,j=E[C]!=0?_[C][T]/E[C]:0,r?d.push(j,ne):d.push(ne,j);T=0;let L=0,Y=x[T]-1,te=x[T+1]-1,De=Y<te?Y:te,Ve=A[1]-A[0];const ve=x.length-1;for(;L<=De&&T<ve;)h.push(L,L+Ve,L+1),h.push(L+Ve+1,L+1,L+Ve),L+=1,L===De&&(T++,Ve=A[T+1]-A[T],Y=x[T]-1,te=x[T+1]-1,L=A[T],De=Y<te?Y+L:te+L);if(de.ComputeNormals(u,h,f),i){let xe=0,z=0;for(T=0;T<e.length;T++){xe=A[T]*3,T+1<e.length?z=(A[T+1]-1)*3:z=f.length-3,f[xe]=(f[xe]+f[z])*.5,f[xe+1]=(f[xe+1]+f[z+1])*.5,f[xe+2]=(f[xe+2]+f[z+2])*.5;const K=Math.sqrt(f[xe]*f[xe]+f[xe+1]*f[xe+1]+f[xe+2]*f[xe+2]);f[xe]/=K,f[xe+1]/=K,f[xe+2]/=K,f[z]=f[xe],f[z+1]=f[xe+1],f[z+2]=f[xe+2]}}if(t){let xe=A[0]*3,z=A[e.length]*3;for(C=0;C<v+D;C++){f[xe]=(f[xe]+f[z])*.5,f[xe+1]=(f[xe+1]+f[z+1])*.5,f[xe+2]=(f[xe+2]+f[z+2])*.5;const K=Math.sqrt(f[xe]*f[xe]+f[xe+1]*f[xe+1]+f[xe+2]*f[xe+2]);f[xe]/=K,f[xe+1]/=K,f[xe+2]/=K,f[z]=f[xe],f[z+1]=f[xe+1],f[z+2]=f[xe+2],xe+=3,z+=3}}de._ComputeSides(o,u,h,f,d,n.frontUVs,n.backUVs);let Me=null;if(c){Me=new Float32Array(c.length*4);for(let xe=0;xe<c.length;xe++)Me[xe*4]=c[xe].r,Me[xe*4+1]=c[xe].g,Me[xe*4+2]=c[xe].b,Me[xe*4+3]=c[xe].a}const Re=new de,Pe=new Float32Array(u),ft=new Float32Array(f),Wt=new Float32Array(d);return Re.indices=h,Re.positions=Pe,Re.normals=ft,Re.uvs=Wt,Me&&Re.set(Me,b.ColorKind),i&&(Re._idx=A),Re}function ro(n,e,t=null){const i=e.pathArray,r=e.closeArray,s=e.closePath,a=k._GetDefaultSideOrientation(e.sideOrientation),o=e.instance,l=e.updatable;if(o){const c=B.Vector3[0].setAll(Number.MAX_VALUE),u=B.Vector3[1].setAll(-Number.MAX_VALUE),h=d=>{let p=i[0].length;const _=o;let g=0;const E=_._originalBuilderSideOrientation===k.DOUBLESIDE?2:1;for(let v=1;v<=E;++v)for(let x=0;x<i.length;++x){const A=i[x],T=A.length;p=p<T?p:T;for(let C=0;C<p;++C){const y=A[C];d[g]=y.x,d[g+1]=y.y,d[g+2]=y.z,c.minimizeInPlaceFromFloats(y.x,y.y,y.z),u.maximizeInPlaceFromFloats(y.x,y.y,y.z),g+=3}if(_._creationDataStorage&&_._creationDataStorage.closePath){const C=A[0];d[g]=C.x,d[g+1]=C.y,d[g+2]=C.z,g+=3}}},f=o.getVerticesData(b.PositionKind);if(h(f),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(c,u,o._worldMatrix):o.buildBoundingInfo(c,u,o._worldMatrix),o.updateVerticesData(b.PositionKind,f,!1,!1),e.colors){const d=o.getVerticesData(b.ColorKind);for(let p=0,_=0;p<e.colors.length;p++,_+=4){const g=e.colors[p];d[_]=g.r,d[_+1]=g.g,d[_+2]=g.b,d[_+3]=g.a}o.updateVerticesData(b.ColorKind,d,!1,!1)}if(e.uvs){const d=o.getVerticesData(b.UVKind);for(let p=0;p<e.uvs.length;p++)d[p*2]=e.uvs[p].x,d[p*2+1]=e.uvs[p].y;o.updateVerticesData(b.UVKind,d,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){const d=o.getIndices(),p=o.getVerticesData(b.NormalKind),_=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(de.ComputeNormals(f,d,p,_),o._creationDataStorage&&o._creationDataStorage.closePath){let g=0,E=0;for(let v=0;v<i.length;v++)g=o._creationDataStorage.idx[v]*3,v+1<i.length?E=(o._creationDataStorage.idx[v+1]-1)*3:E=p.length-3,p[g]=(p[g]+p[E])*.5,p[g+1]=(p[g+1]+p[E+1])*.5,p[g+2]=(p[g+2]+p[E+2])*.5,p[E]=p[g],p[E+1]=p[g+1],p[E+2]=p[g+2]}o.areNormalsFrozen||o.updateVerticesData(b.NormalKind,p,!1,!1)}return o}else{const c=new k(n,t);c._originalBuilderSideOrientation=a,c._creationDataStorage=new xC;const u=CC(e);return s&&(c._creationDataStorage.idx=u._idx),c._creationDataStorage.closePath=s,c._creationDataStorage.closeArray=r,u.applyToMesh(c,l),c}}de.CreateRibbon=CC;k.CreateRibbon=(n,e,t=!1,i,r,s,a=!1,o,l)=>ro(n,{pathArray:e,closeArray:t,closePath:i,offset:r,updatable:a,sideOrientation:o,instance:l},s);function Gp(n,e,t=null){const i=e.path,r=e.shape,s=e.scale||1,a=e.rotation||0,o=e.cap===0?0:e.cap||k.NO_CAP,l=e.updatable,c=k._GetDefaultSideOrientation(e.sideOrientation),u=e.instance||null,h=e.invertUV||!1,f=e.closeShape||!1,d=e.closePath||!1;return IC(n,r,i,s,a,null,null,d,f,o,!1,t,!!l,c,u,h,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function AC(n,e,t=null){const i=e.path,r=e.shape,s=e.scaleFunction||(()=>1),a=e.rotationFunction||(()=>0),o=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,c=e.cap===0?0:e.cap||k.NO_CAP,u=e.updatable,h=e.firstNormal||null,f=e.adjustFrame||!1,d=k._GetDefaultSideOrientation(e.sideOrientation),p=e.instance,_=e.invertUV||!1;return IC(n,r,i,null,null,s,a,o,l,c,!0,t,!!u,d,p||null,_,e.frontUVs||null,e.backUVs||null,h,f)}function IC(n,e,t,i,r,s,a,o,l,c,u,h,f,d,p,_,g,E,v,x){const A=(D,F,W,H,ue,ae,le,oe,ge,Ee,ne)=>{const j=W.getTangents(),L=W.getNormals(),Y=W.getBinormals(),te=W.getDistances();if(ne){for(let xe=0;xe<j.length;xe++)if(j[xe].x==0&&j[xe].y==0&&j[xe].z==0&&j[xe].copyFrom(j[xe-1]),L[xe].x==0&&L[xe].y==0&&L[xe].z==0&&L[xe].copyFrom(L[xe-1]),Y[xe].x==0&&Y[xe].y==0&&Y[xe].z==0&&Y[xe].copyFrom(Y[xe-1]),xe>0){let z=j[xe-1];m.Dot(z,j[xe])<0&&j[xe].scaleInPlace(-1),z=L[xe-1],m.Dot(z,L[xe])<0&&L[xe].scaleInPlace(-1),z=Y[xe-1],m.Dot(z,Y[xe])<0&&Y[xe].scaleInPlace(-1)}}let De=0;const Ve=()=>ue!==null?ue:1,Me=Ee&&oe?oe:()=>ae!==null?ae:0,Re=Ee&&le?le:Ve;let Pe=ge===k.NO_CAP||ge===k.CAP_END?0:2;const ft=B.Matrix[0];for(let xe=0;xe<F.length;xe++){const z=[],K=Me(xe,te[xe]),he=Re(xe,te[xe]);O.RotationAxisToRef(j[xe],De,ft);for(let Ce=0;Ce<D.length;Ce++){const ye=j[xe].scale(D[Ce].z).add(L[xe].scale(D[Ce].x)).add(Y[xe].scale(D[Ce].y)),be=m.Zero();m.TransformCoordinatesToRef(ye,ft,be),be.scaleInPlace(he).addInPlace(F[xe]),z[Ce]=be}H[Pe]=z,De+=K,Pe++}const Wt=xe=>{const z=Array(),K=m.Zero();let he;for(he=0;he<xe.length;he++)K.addInPlace(xe[he]);for(K.scaleInPlace(1/xe.length),he=0;he<xe.length;he++)z.push(K);return z};switch(ge){case k.NO_CAP:break;case k.CAP_START:H[0]=Wt(H[2]),H[1]=H[2];break;case k.CAP_END:H[Pe]=H[Pe-1],H[Pe+1]=Wt(H[Pe-1]);break;case k.CAP_ALL:H[0]=Wt(H[2]),H[1]=H[2],H[Pe]=H[Pe-1],H[Pe+1]=Wt(H[Pe-1]);break}return H};let T,C;if(p){const D=p._creationDataStorage;return T=v?D.path3D.update(t,v):D.path3D.update(t),C=A(e,t,D.path3D,D.pathArray,i,r,s,a,D.cap,u,x),p=ro("",{pathArray:C,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},h||void 0),p}T=v?new ic(t,v):new ic(t);const y=new Array;c=c<0||c>3?0:c,C=A(e,t,T,y,i,r,s,a,c,u,x);const P=ro(n,{pathArray:C,closeArray:o,closePath:l,updatable:f,sideOrientation:d,invertUV:_,frontUVs:g||void 0,backUVs:E||void 0},h);return P._creationDataStorage.pathArray=C,P._creationDataStorage.path3D=T,P._creationDataStorage.cap=c,P}k.ExtrudeShape=(n,e,t,i,r,s,a=null,o,l,c)=>{const u={shape:e,path:t,scale:i,rotation:r,cap:s===0?0:s||k.NO_CAP,sideOrientation:l,instance:c,updatable:o};return Gp(n,u,a)};k.ExtrudeShapeCustom=(n,e,t,i,r,s,a,o,l,c,u,h)=>{const f={shape:e,path:t,scaleFunction:i,rotationFunction:r,ribbonCloseArray:s,ribbonClosePath:a,cap:o===0?0:o||k.NO_CAP,sideOrientation:u,instance:h,updatable:c};return AC(n,f,l)};k._instancedMeshFactory=(n,e)=>{const t=new el(n,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class el extends $t{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;((t=this._sourceMesh)==null?void 0:t.receiveShadows)!==e&&J.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;((t=this._sourceMesh)==null?void 0:t.material)!==e&&J.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;((t=this._sourceMesh)==null?void 0:t.visibility)!==e&&J.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;((t=this._sourceMesh)==null?void 0:t.skeleton)!==e&&J.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||w.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};const r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(i,null,b.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||w.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==ot.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new O);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,B.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(B.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){const s=(r||this._sourceMesh).createInstance(e);if(cr.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(s.parent=t),!i)for(let a=0;a<this.getScene().meshes.length;a++){const o=this.getScene().meshes[a];o.parent===this&&o.clone(o.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(const s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}}k.prototype.registerInstancedBuffer=function(n,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)==null?void 0:t.vertexBuffers[n])==null||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const r of this.instances)r.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[n]=null,this._userInstancedBuffersStorage.strides[n]=e,this._userInstancedBuffersStorage.sizes[n]=e*32,this._userInstancedBuffersStorage.data[n]=new Float32Array(this._userInstancedBuffersStorage.sizes[n]),this._userInstancedBuffersStorage.vertexBuffers[n]=new b(this.getEngine(),this._userInstancedBuffersStorage.data[n],n,!0,!1,e,!0);for(const r of this.instances)r.instancedBuffers[n]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};k.prototype._processInstancedBuffers=function(n,e){const t=n?n.length:0;for(const i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i];const s=this._userInstancedBuffersStorage.strides[i],a=(t+1)*s;for(;r<a;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const c=this.instancedBuffers[i];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=s}for(let c=0;c<t;c++){const h=n[c].instancedBuffers[i];h.toArray?h.toArray(o,l):h.copyToArray?h.copyToArray(o,l):o[l]=h,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new b(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}};k.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const n in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[n]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};k.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const n in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[n]&&this._userInstancedBuffersStorage.vertexBuffers[n].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};$("BABYLON.InstancedMesh",el);class hl extends pe{constructor(e,t,i=!0,r=!1){super(e,t,void 0,r),this._normalMatrix=new O,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null,i){super._afterBind(e,t,i),this.getScene()._cachedEffect=t,i?i._drawWrapper._forceRebindOnNextCall=!1:this._drawWrapper._forceRebindOnNextCall=!1}_mustRebind(e,t,i,r=1){return i._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,r)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}const Mf={effect:null,subMesh:null};class $n extends hl{constructor(e,t,i,r={},s=!0){super(e,t,s),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new O,this._cachedWorldViewProjectionMatrix=new O,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...r}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",r=this.options.defines.findIndex(s=>s===e||s.startsWith(i));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){const r=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){const T=r?i._drawWrapper:this._drawWrapper;if(T.effect&&T._wasPreviouslyReady&&T._wasPreviouslyUsingInstances===t)return!0}const s=this.getScene(),a=s.getEngine(),o=[],l=[],c=new co;let u=this._shaderPath,h=this._options.uniforms,f=this._options.uniformBuffers,d=this._options.samplers;a.getCaps().multiview&&s.activeCamera&&s.activeCamera.outputRenderTarget&&s.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,o.push("#define MULTIVIEW"),h.indexOf("viewProjection")!==-1&&h.indexOf("viewProjectionR")===-1&&h.push("viewProjectionR"));for(let T=0;T<this._options.defines.length;T++){const C=this._options.defines[T].indexOf("#define")===0?this._options.defines[T]:`#define ${this._options.defines[T]}`;o.push(C)}for(let T=0;T<this._options.attributes.length;T++)l.push(this._options.attributes[T]);if(e&&e.isVerticesDataPresent(b.ColorKind)&&(l.indexOf(b.ColorKind)===-1&&l.push(b.ColorKind),o.push("#define VERTEXCOLOR")),t&&(o.push("#define INSTANCES"),ch(l,this._materialHelperNeedsPreviousMatrices),e!=null&&e.hasThinInstances&&(o.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(b.ColorInstanceKind)&&(l.push(b.ColorInstanceKind),o.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){l.push(b.MatricesIndicesKind),l.push(b.MatricesWeightsKind),e.numBoneInfluencers>4&&(l.push(b.MatricesIndicesExtraKind),l.push(b.MatricesWeightsExtraKind));const T=e.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),c.addCPUSkinningFallback(0,e),T.isUsingTextureForMatrices?(o.push("#define BONETEXTURE"),h.indexOf("boneTextureWidth")===-1&&h.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(o.push("#define BonesPerMesh "+(T.bones.length+1)),h.indexOf("mBones")===-1&&h.push("mBones"))}else o.push("#define NUM_BONE_INFLUENCERS 0");let p=0;const _=e?e.morphTargetManager:null;if(_){const T=_.supportsUVs&&o.indexOf("#define UV1")!==-1,C=_.supportsTangents&&o.indexOf("#define TANGENT")!==-1,y=_.supportsNormals&&o.indexOf("#define NORMAL")!==-1;p=_.numMaxInfluencers||_.numInfluencers,T&&o.push("#define MORPHTARGETS_UV"),C&&o.push("#define MORPHTARGETS_TANGENT"),y&&o.push("#define MORPHTARGETS_NORMAL"),p>0&&o.push("#define MORPHTARGETS"),_.isUsingTextureForTargets&&(o.push("#define MORPHTARGETS_TEXTURE"),h.indexOf("morphTargetTextureIndices")===-1&&h.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),o.push("#define NUM_MORPH_INFLUENCERS "+p);for(let P=0;P<p;P++)l.push(b.PositionKind+P),y&&l.push(b.NormalKind+P),C&&l.push(b.TangentKind+P),T&&l.push(b.UVKind+"_"+P);p>0&&(h=h.slice(),h.push("morphTargetInfluences"),h.push("morphTargetCount"),h.push("morphTargetTextureInfo"),h.push("morphTargetTextureIndices"))}else o.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const T=e.bakedVertexAnimationManager;T&&T.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),h.indexOf("bakedVertexAnimationSettings")===-1&&h.push("bakedVertexAnimationSettings"),h.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&h.push("bakedVertexAnimationTextureSizeInverted"),h.indexOf("bakedVertexAnimationTime")===-1&&h.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),bp(l,e,o)}for(const T in this._textures)if(!this._textures[T].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&o.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(Zn(h),xc(this,s,o)),s.fogEnabled&&(e!=null&&e.applyFog)&&s.fogMode!==ht.FOGMODE_NONE&&(o.push("#define FOG"),h.indexOf("view")===-1&&h.push("view"),h.indexOf("vFogInfos")===-1&&h.push("vFogInfos"),h.indexOf("vFogColor")===-1&&h.push("vFogColor")),this._useLogarithmicDepth&&(o.push("#define LOGARITHMICDEPTH"),h.indexOf("logarithmicDepthConstant")===-1&&h.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(h=h.slice(),f=f.slice(),d=d.slice(),u=this.customShaderNameResolve(this.name,h,f,d,o,l));const g=r?i._getDrawWrapper(void 0,!0):this._drawWrapper,E=(g==null?void 0:g.effect)??null,v=(g==null?void 0:g.defines)??null,x=o.join(`
`);let A=E;return v!==x&&(A=a.createEffect(u,{attributes:l,uniformsNames:h,uniformBuffersNames:f,samplers:d,defines:x,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},a),r?i.setEffect(A,x,this._materialContext):g&&g.setEffect(A,x),this._onEffectCreatedObservable&&(Mf.effect=A,Mf.subMesh=i??(e==null?void 0:e.subMeshes[0])??null,this._onEffectCreatedObservable.notifyObservers(Mf))),g._wasPreviouslyUsingInstances=!!t,A!=null&&A.isReady()?(E!==A&&s.resetCachedMaterial(),g._wasPreviouslyReady=!0,!0):!1}bindOnlyWorldMatrix(e,t){const i=this.getScene(),r=t??this.getEffect();r&&(this._options.uniforms.indexOf("world")!==-1&&r.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),r.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),r.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),this._options.uniforms.indexOf("view")!==-1&&r.setMatrix("view",i.getViewMatrix()))}bindForSubMesh(e,t,i){var r;this.bind(e,t,(r=i._drawWrapperOverride)==null?void 0:r.effect,i)}bind(e,t,i,r){var h;const s=r&&this._storeEffectOnSubMeshes,a=i??(s?r.effect:this.getEffect());if(!a)return;const o=this.getScene();this._activeEffect=a,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let c=!1;if(a&&l&&l.length>0&&o.getEngine().supportsUniformBuffers)for(let f=0;f<l.length;++f)switch(l[f]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e));break;case"Scene":yp(a,o.getSceneUniformBuffer()),o.finalizeSceneUbo(),c=!0;break}const u=t&&s?this._mustRebind(o,a,r,t.visibility):o.getCachedMaterial()!==this;if(a&&u){!c&&this._options.uniforms.indexOf("view")!==-1&&a.setMatrix("view",o.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&a.setMatrix("projection",o.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(a.setMatrix("viewProjection",o.getTransformMatrix()),this._multiview&&a.setMatrix("viewProjectionR",o._transformMatrixR)),o.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&a.setVector3("cameraPosition",o.activeCamera.globalPosition),ul(t,a),Sn(a,this,o),this._useLogarithmicDepth&&Qn(s?r.materialDefines:a.defines,a,o),t&&uo(o,t,a);let f;for(f in this._textures)a.setTexture(f,this._textures[f]);for(f in this._textureArrays)a.setTextureArray(f,this._textureArrays[f]);for(f in this._ints)a.setInt(f,this._ints[f]);for(f in this._uints)a.setUInt(f,this._uints[f]);for(f in this._floats)a.setFloat(f,this._floats[f]);for(f in this._floatsArrays)a.setArray(f,this._floatsArrays[f]);for(f in this._colors3)a.setColor3(f,this._colors3[f]);for(f in this._colors3Arrays)a.setArray3(f,this._colors3Arrays[f]);for(f in this._colors4){const E=this._colors4[f];a.setFloat4(f,E.r,E.g,E.b,E.a)}for(f in this._colors4Arrays)a.setArray4(f,this._colors4Arrays[f]);for(f in this._vectors2)a.setVector2(f,this._vectors2[f]);for(f in this._vectors3)a.setVector3(f,this._vectors3[f]);for(f in this._vectors4)a.setVector4(f,this._vectors4[f]);for(f in this._quaternions)a.setQuaternion(f,this._quaternions[f]);for(f in this._matrices)a.setMatrix(f,this._matrices[f]);for(f in this._matrixArrays)a.setMatrices(f,this._matrixArrays[f]);for(f in this._matrices3x3)a.setMatrix3x3(f,this._matrices3x3[f]);for(f in this._matrices2x2)a.setMatrix2x2(f,this._matrices2x2[f]);for(f in this._vectors2Arrays)a.setArray2(f,this._vectors2Arrays[f]);for(f in this._vectors3Arrays)a.setArray3(f,this._vectors3Arrays[f]);for(f in this._vectors4Arrays)a.setArray4(f,this._vectors4Arrays[f]);for(f in this._quaternionsArrays)a.setArray4(f,this._quaternionsArrays[f]);for(f in this._uniformBuffers){const E=this._uniformBuffers[f].getBuffer();E&&a.bindUniformBuffer(E,f)}const d=o.getEngine(),p=d.setExternalTexture;if(p)for(f in this._externalTextures)p.call(d,f,this._externalTextures[f]);const _=d.setTextureSampler;if(_)for(f in this._textureSamplers)_.call(d,f,this._textureSamplers[f]);const g=d.setStorageBuffer;if(g)for(f in this._storageBuffers)g.call(d,f,this._storageBuffers[f])}if(a&&t&&(u||!this.isFrozen)){const f=t.morphTargetManager;f&&f.numInfluencers>0&&cl(t,a);const d=t.bakedVertexAnimationManager;if(d&&d.isEnabled){const p=s?r._drawWrapper:this._drawWrapper;(h=t.bakedVertexAnimationManager)==null||h.bind(a,!!p._wasPreviouslyUsingInstances)}}this._afterBind(t,a,r)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let r=0;r<i.length;r++)if(i[r]===e)return!0}return!1}clone(e){const t=Ke.Clone(()=>new $n(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(i=>{const r=this._options[i];Array.isArray(r)&&(this._options[i]=r.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays){const s=this._textureArrays[r];for(let a=0;a<s.length;a++)s[a].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=Ke.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.floatsArrays={};for(t in this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const r=Ke.Parse(()=>new $n(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let s;e.stencil&&r.stencil.parse(e.stencil,t,i);for(s in e.textures)r.setTexture(s,Z.Parse(e.textures[s],t,i));for(s in e.textureArrays){const a=e.textureArrays[s],o=[];for(let l=0;l<a.length;l++)o.push(Z.Parse(a[l],t,i));r.setTextureArray(s,o)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)r.setColor3(s,fe.FromArray(e.colors3[s]));for(s in e.colors3Arrays){const a=e.colors3Arrays[s].reduce((o,l,c)=>(c%3===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>fe.FromArray(o));r.setColor3Array(s,a)}for(s in e.colors4)r.setColor4(s,Be.FromArray(e.colors4[s]));for(s in e.colors4Arrays){const a=e.colors4Arrays[s].reduce((o,l,c)=>(c%4===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>Be.FromArray(o));r.setColor4Array(s,a)}for(s in e.vectors2)r.setVector2(s,se.FromArray(e.vectors2[s]));for(s in e.vectors3)r.setVector3(s,m.FromArray(e.vectors3[s]));for(s in e.vectors4)r.setVector4(s,We.FromArray(e.vectors4[s]));for(s in e.quaternions)r.setQuaternion(s,ce.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,O.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((s,a)=>{const o=new Gi;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){const l=JSON.parse(o.responseText),c=this.Parse(l,i||$e.LastCreatedScene,r);e&&(c.name=e),s(c)}else a("Unable to load the ShaderMaterial")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((r,s)=>{const a=new Gi;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.shaderMaterial),c=this.Parse(l,t||$e.LastCreatedScene,i);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}}$n.SnippetUrl="https://snippet.babylonjs.com";$n.CreateFromSnippetAsync=$n.ParseFromSnippetAsync;$("BABYLON.ShaderMaterial",$n);k._LinesMeshParser=(n,e)=>da.Parse(n,e);class da extends k{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,t=null,i=null,r=null,s,a,o,l){super(e,t,i,r,s),this.useVertexColor=a,this.useVertexAlpha=o,this.color=new fe(1,1,1),this.alpha=1,this._shaderLanguage=0,r&&(this.color=r.color.clone(),this.alpha=r.alpha,this.useVertexColor=r.useVertexColor,this.useVertexAlpha=r.useVertexAlpha),this.intersectionThreshold=.1;const c=[],u={attributes:[b.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:c,useClipPlane:null,shaderLanguage:0};o===!1?u.needAlphaBlending=!1:u.defines.push("#define VERTEXALPHA"),a?(u.defines.push("#define VERTEXCOLOR"),u.attributes.push(b.ColorKind)):(u.uniforms.push("color"),this._color4=new Be),l?this.material=l:(this.getScene().getEngine().isWebGPU&&!da.ForceGLSL&&(this._shaderLanguage=1),u.shaderLanguage=this._shaderLanguage,u.extraInitializationsAsync=async()=>{this._shaderLanguage===1?await Promise.all([re(()=>Promise.resolve().then(()=>p3),void 0),re(()=>Promise.resolve().then(()=>u3),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>l3),void 0),re(()=>Promise.resolve().then(()=>s3),void 0)])},this.material=new $n("colorShader",this.getScene(),"color",u,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=pe.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r,g:s,b:a}=this.color;this._color4.set(r,s,a,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const r=this.getScene().getEngine();return this._unIndexed?r.drawArraysType(pe.LineListDrawMode,e.verticesStart,e.verticesCount,i):r.drawElementsType(pe.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new da(e,this.getScene(),t,this,i)}createInstance(e){const t=new V1(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new da(e.name,t);return i.color=fe.FromArray(e.color),i.alpha=e.alpha,i}}da.ForceGLSL=!1;class V1 extends el{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function yC(n){const e=[],t=[],i=n.lines,r=n.colors,s=[];let a=0;for(let l=0;l<i.length;l++){const c=i[l];for(let u=0;u<c.length;u++){const{x:h,y:f,z:d}=c[u];if(t.push(h,f,d),r){const p=r[l],{r:_,g,b:E,a:v}=p[u];s.push(_,g,E,v)}u>0&&(e.push(a-1),e.push(a)),a++}}const o=new de;return o.indices=e,o.positions=t,r&&(o.colors=s),o}function bC(n){const e=n.dashSize||3,t=n.gapSize||1,i=n.dashNb||200,r=n.points,s=[],a=[],o=m.Zero();let l=0,c=0,u=0,h=0,f=0,d=0,p=0;for(p=0;p<r.length-1;p++)r[p+1].subtractToRef(r[p],o),l+=o.length();for(u=l/i,h=e*u/(e+t),p=0;p<r.length-1;p++){r[p+1].subtractToRef(r[p],o),c=Math.floor(o.length()/u),o.normalize();for(let g=0;g<c;g++)f=u*g,s.push(r[p].x+f*o.x,r[p].y+f*o.y,r[p].z+f*o.z),s.push(r[p].x+(f+h)*o.x,r[p].y+(f+h)*o.y,r[p].z+(f+h)*o.z),a.push(d,d+1),d+=2}const _=new de;return _.positions=s,_.indices=a,_}function RC(n,e,t=null){const i=e.instance,r=e.lines,s=e.colors;if(i){const c=i.getVerticesData(b.PositionKind);let u,h;s&&(u=i.getVerticesData(b.ColorKind));let f=0,d=0;for(let p=0;p<r.length;p++){const _=r[p];for(let g=0;g<_.length;g++)c[f]=_[g].x,c[f+1]=_[g].y,c[f+2]=_[g].z,s&&u&&(h=s[p],u[d]=h[g].r,u[d+1]=h[g].g,u[d+2]=h[g].b,u[d+3]=h[g].a,d+=4),f+=3}return i.updateVerticesData(b.PositionKind,c,!1,!1),s&&u&&i.updateVerticesData(b.ColorKind,u,!1,!1),i.refreshBoundingInfo(),i}const a=!!s,o=new da(n,t,null,void 0,void 0,a,e.useVertexAlpha,e.material);return yC(e).applyToMesh(o,e.updatable),o}function zp(n,e,t=null){const i=e.colors?[e.colors]:null;return RC(n,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function PC(n,e,t=null){const i=e.points,r=e.instance,s=e.gapSize||1,a=e.dashSize||3;if(r){const c=u=>{const h=m.Zero(),f=u.length/6;let d=0,p=0,_=0,g=0,E=0,v=0,x=0,A=0;for(x=0;x<i.length-1;x++)i[x+1].subtractToRef(i[x],h),d+=h.length();_=d/f;const T=r._creationDataStorage.dashSize,C=r._creationDataStorage.gapSize;for(g=T*_/(T+C),x=0;x<i.length-1;x++)for(i[x+1].subtractToRef(i[x],h),p=Math.floor(h.length()/_),h.normalize(),A=0;A<p&&v<u.length;)E=_*A,u[v]=i[x].x+E*h.x,u[v+1]=i[x].y+E*h.y,u[v+2]=i[x].z+E*h.z,u[v+3]=i[x].x+(E+g)*h.x,u[v+4]=i[x].y+(E+g)*h.y,u[v+5]=i[x].z+(E+g)*h.z,v+=6,A++;for(;v<u.length;)u[v]=i[x].x,u[v+1]=i[x].y,u[v+2]=i[x].z,v+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&w.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(c,!1),r}const o=new da(n,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return bC(e).applyToMesh(o,e.updatable),o._creationDataStorage=new xC,o._creationDataStorage.dashSize=a,o._creationDataStorage.gapSize=s,o}de.CreateLineSystem=yC;de.CreateDashedLines=bC;k.CreateLines=(n,e,t=null,i=!1,r=null)=>zp(n,{points:e,updatable:i,instance:r},t);k.CreateDashedLines=(n,e,t,i,r,s=null,a,o)=>PC(n,{points:e,dashSize:t,gapSize:i,dashNb:r,updatable:a,instance:o},s);class hn{constructor(e=!0,t=Ammo,i=null){if(this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new ce,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new m,this._tmpContactNormal=new m,this._tmpVec3=new m,this._tmpMatrix=new O,typeof t=="function"){w.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=t;if(!this.isSupported()){w.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=r=>{r=this.bjsAMMO.wrapPointer(r,this.bjsAMMO.btManifoldPoint);const s=r.getPositionWorldOnA(),a=r.m_normalWorldOnB;this._tmpContactPoint.x=s.x(),this._tmpContactPoint.y=s.y(),this._tmpContactPoint.z=s.z(),this._tmpContactNormal.x=a.x(),this._tmpContactNormal.y=a.y(),this._tmpContactNormal.z=a.z(),this._tmpContactImpulse=r.getAppliedImpulse(),this._tmpContactDistance=r.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new vh,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(t==0)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const i of t)i.soft||i.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const i of t)if(i.soft?this._afterSoftStep(i):i.afterStep(),i._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(i))for(const r of i._onPhysicsCollideCallbacks)for(const s of r.otherImpostors)(i.physicsBody.isActive()||s.physicsBody.isActive())&&this._isImpostorPairInContact(i,s)&&(i.onCollide({body:s.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),s.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===ct.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let r,s,a,o,l;const c=new Array;for(let f=0;f<i;f++)r=t.at(f),s=r.get_m_x(),a=s.x(),o=s.y(),l=s.z(),c.push(new m(a,o,l));const u=e.object,h=e.getParam("shape");e._isFromLine?e.object=zp("lines",{points:c,instance:u}):e.object=Gp("ext",{shape:h,path:c,instance:u})}_softbodyOrClothStep(e){const t=e.type===ct.ClothImpostor?1:-1,i=e.object;let r=i.getVerticesData(b.PositionKind);r||(r=[]);let s=i.getVerticesData(b.NormalKind);s||(s=[]);const a=r.length/3,o=e.physicsBody.get_m_nodes();let l,c,u,h,f,d,p,_;for(let E=0;E<a;E++){l=o.at(E),c=l.get_m_x(),u=c.x(),h=c.y(),f=c.z()*t;const v=l.get_m_n();d=v.x(),p=v.y(),_=v.z()*t,r[3*E]=u,r[3*E+1]=h,r[3*E+2]=f,s[3*E]=d,s[3*E+1]=p,s[3*E+2]=_}const g=new de;g.positions=r,g.normals=s,g.uvs=i.getVerticesData(b.UVKind),g.colors=i.getVerticesData(b.ColorKind),i&&i.getIndices&&(g.indices=i.getIndices()),g.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)w.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),s.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(s,r)}}applyForce(e,t,i){if(e.soft)w.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const a=e.object.getWorldMatrix().getTranslation();r.setValue(i.x-a.x,i.y-a.y,i.z-a.z)}else r.setValue(i.x,i.y,i.z);s.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(s,r)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(hn._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===ct.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const r=new this.bjsAMMO.btVector3(0,0,0),s=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),s.setIdentity(),i!==0&&t.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),s.setOrigin(this._tmpAmmoVectorA),s.setRotation(this._tmpAmmoQuaternion);const a=new this.bjsAMMO.btDefaultMotionState(s),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,a,t,r),l=new this.bjsAMMO.btRigidBody(o);if(i===0&&(l.setCollisionFlags(l.getCollisionFlags()|hn._KINEMATIC_FLAG),l.setActivationState(hn._DISABLE_DEACTIVATION_FLAG)),e.type==ct.NoImpostor&&!t.getChildShape&&l.setCollisionFlags(l.getCollisionFlags()|hn._DISABLE_COLLISION_FLAG),e.type!==ct.MeshImpostor&&e.type!==ct.NoImpostor){const h=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(h.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const c=e.getParam("group"),u=e.getParam("mask");c&&u?this.world.addRigidBody(l,c,u):this.world.addRigidBody(l),e.physicsBody=l,e._pluginData.toDispose=e._pluginData.toDispose.concat([l,o,a,s,r,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach(t=>{this.bjsAMMO.destroy(t)}),e._pluginData.toDispose=[]))}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i||e.joint.physicsJoint)return;const r=e.joint.jointData;r.mainPivot||(r.mainPivot=new m(0,0,0)),r.connectedPivot||(r.connectedPivot=new m(0,0,0));let s;switch(e.joint.type){case ci.DistanceJoint:{const a=r.maxDistance;a&&(r.mainPivot=new m(0,-a/2,0),r.connectedPivot=new m(0,a/2,0));const o=this._tmpAmmoVectorA;o.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const l=this._tmpAmmoVectorB;l.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,o,l);break}case ci.HingeJoint:{r.mainAxis||(r.mainAxis=new m(0,0,0)),r.connectedAxis||(r.connectedAxis=new m(0,0,0));const a=this._tmpAmmoVectorA;a.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z);const l=this._tmpAmmoVectorC;l.setValue(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z);const c=this._tmpAmmoVectorD;c.setValue(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z),s=new this.bjsAMMO.btHingeConstraint(t,i,a,o,l,c);break}case ci.BallAndSocketJoint:{const a=this._tmpAmmoVectorA;a.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,a,o);break}default:{w.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");const a=this._tmpAmmoVectorA;a.setValue(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z);const o=this._tmpAmmoVectorB;o.setValue(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z),s=new this.bjsAMMO.btPoint2PointConstraint(t,i,a,o);break}}this.world.addConstraint(s,!e.joint.jointData.collision),e.joint.physicsJoint=s}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint),this.bjsAMMO.destroy(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let a=i.getVerticesData(b.PositionKind);a||(a=[]);let o;if(t&&t!==i){let c;t.rotationQuaternion?c=t.rotationQuaternion:t.rotation?c=ce.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):c=ce.Identity(),O.Compose(m.One(),c,t.position).invertToRef(this._tmpMatrix),o=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else O.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),o=this._tmpMatrix;const l=s.length/3;for(let c=0;c<l;c++){const u=[];for(let h=0;h<3;h++){let f=new m(a[s[c*3+h]*3+0],a[s[c*3+h]*3+1],a[s[c*3+h]*3+2]);f=m.TransformCoordinates(f,o);let d;h==0?d=this._tmpAmmoVectorA:h==1?d=this._tmpAmmoVectorB:d=this._tmpAmmoVectorC,d.setValue(f.x,f.y,f.z),u.push(d)}e.addTriangle(u[0],u[1],u[2]),r++}i.getChildMeshes().forEach(c=>{r+=this._addMeshVerts(e,t,c)})}return r}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){t.getIndices();let i=t.getVerticesData(b.PositionKind);i||(i=[]);let r=t.getVerticesData(b.NormalKind);r||(r=[]),t.computeWorldMatrix(!1);const s=[],a=[];for(let l=0;l<i.length;l+=3){let c=new m(i[l],i[l+1],i[l+2]),u=new m(r[l],r[l+1],r[l+2]);c=m.TransformCoordinates(c,t.getWorldMatrix()),u=m.TransformNormal(u,t.getWorldMatrix()),s.push(c.x,c.y,c.z),a.push(u.x,u.y,u.z)}const o=new de;return o.positions=s,o.normals=a,o.uvs=t.getVerticesData(b.UVKind),o.colors=t.getVerticesData(b.ColorKind),t&&t.getIndices&&(o.indices=t.getIndices()),o.applyToMesh(t),t.position=m.Zero(),t.rotationQuaternion=null,t.rotation=m.Zero(),t.computeWorldMatrix(!0),o}return de.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const r=this._softVertexData(e),s=r.positions,a=r.normals;if(s===null||a===null)return new this.bjsAMMO.btCompoundShape;{const o=[],l=[];for(let p=0;p<s.length;p+=3){const _=new m(s[p],s[p+1],s[p+2]),g=new m(a[p],a[p+1],a[p+2]);o.push(_.x,_.y,-_.z),l.push(g.x,g.y,-g.z)}const c=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),o,t.getIndices(),i.length/3,!0),u=s.length/3,h=c.get_m_nodes();let f,d;for(let p=0;p<u;p++)f=h.at(p),d=f.get_m_n(),d.setX(l[3*p]),d.setY(l[3*p+1]),d.setZ(l[3*p+2]);return c}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){t.getIndices();const i=this._softVertexData(e),r=i.positions,s=i.normals;if(r===null||s===null)return new this.bjsAMMO.btCompoundShape;{const a=r.length,o=Math.sqrt(a/3);e.segments=o;const l=o-1;return this._tmpAmmoVectorA.setValue(r[0],r[1],r[2]),this._tmpAmmoVectorB.setValue(r[3*l],r[3*l+1],r[3*l+2]),this._tmpAmmoVectorD.setValue(r[a-3],r[a-2],r[a-1]),this._tmpAmmoVectorC.setValue(r[a-3-3*l],r[a-2-3*l],r[a-1-3*l]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,o,o,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const r=this._softVertexData(e),s=r.positions,a=r.normals;if(s===null||a===null)return new this.bjsAMMO.btCompoundShape;r.applyToMesh(e.object,!0),e._isFromLine=!0;const o=a.map(f=>f*f),l=(f,d)=>f+d;if(o.reduce(l)===0)t=s.length,i=t/3-1,this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[t-3],s[t-2],s[t-1]);else{e._isFromLine=!1;const f=e.getParam("path");if(e.getParam("shape")===null)return w.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=f.length,i=t-1,this._tmpAmmoVectorA.setValue(f[0].x,f[0].y,f[0].z),this._tmpAmmoVectorB.setValue(f[t-1].x,f[t-1].y,f[t-1].z)}e.segments=i;let u=e.getParam("fixedPoints");u=u>3?3:u;const h=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,u);return h.get_m_cfg().set_collisions(17),h}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),t==null&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let a=i.getVerticesData(b.PositionKind);a||(a=[]),i.computeWorldMatrix(!1);const o=s.length/3;for(let l=0;l<o;l++){const c=[];for(let u=0;u<3;u++){let h=new m(a[s[l*3+u]*3+0],a[s[l*3+u]*3+1],a[s[l*3+u]*3+2]);O.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),h=m.TransformCoordinates(h,this._tmpMatrix);let f;u==0?f=this._tmpAmmoVectorA:u==1?f=this._tmpAmmoVectorB:f=this._tmpAmmoVectorC,f.setValue(h.x,h.y,h.z),c.push(f)}e.addPoint(c[0],!0),e.addPoint(c[1],!0),e.addPoint(c[2],!0),r++}i.getChildMeshes().forEach(l=>{r+=this._addHullVerts(e,t,l)})}return r}_createShape(e,t=!1){const i=e.object;let r;const s=e.getObjectExtents();if(!t){const a=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];r=new this.bjsAMMO.btCompoundShape;let o=0;if(a.forEach(l=>{const c=l.getPhysicsImpostor();if(c){if(c.type==ct.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const u=this._createShape(c),h=l.parent.getWorldMatrix().clone(),f=new m;h.decompose(f),this._tmpAmmoTransform.getOrigin().setValue(l.position.x*f.x,l.position.y*f.y,l.position.z*f.z),this._tmpAmmoQuaternion.setValue(l.rotationQuaternion.x,l.rotationQuaternion.y,l.rotationQuaternion.z,l.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,u),c.dispose(),o++}}),o>0){if(e.type!=ct.NoImpostor){const l=this._createShape(e,!0);l&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),r.addChildShape(this._tmpAmmoTransform,l))}return r}else this.bjsAMMO.destroy(r),r=null}switch(e.type){case ct.SphereImpostor:if(Qt(s.x,s.y,1e-4)&&Qt(s.x,s.z,1e-4))r=new this.bjsAMMO.btSphereShape(s.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);const a=[this._tmpAmmoVectorA],o=[1];r=new this.bjsAMMO.btMultiSphereShape(a,o,1),this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r.setLocalScaling(this._tmpAmmoVectorA)}break;case ct.CapsuleImpostor:{const a=s.x/2;r=new this.bjsAMMO.btCapsuleShape(a,s.y-a*2)}break;case ct.CylinderImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case ct.PlaneImpostor:case ct.BoxImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),r=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case ct.MeshImpostor:if(e.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)r=this.onCreateCustomMeshImpostor(e);else{const a=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(a),this._addMeshVerts(a,i,i)==0?r=new this.bjsAMMO.btCompoundShape:r=new this.bjsAMMO.btBvhTriangleMeshShape(a)}break}case ct.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)r=this.onCreateCustomConvexHullImpostor(e);else{const a=new this.bjsAMMO.btConvexHullShape;this._addHullVerts(a,i,i)==0?(e._pluginData.toDispose.push(a),r=new this.bjsAMMO.btCompoundShape):r=a}break}case ct.NoImpostor:r=new this.bjsAMMO.btSphereShape(s.x/2);break;case ct.CustomImpostor:r=this._createCustom(e);break;case ct.SoftbodyImpostor:r=this._createSoftbody(e);break;case ct.ClothImpostor:r=this._createCloth(e);break;case ct.RopeImpostor:r=this._createRope(e);break;default:w.Warn("The impostor type is not currently supported by the ammo plugin.");break}return r}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-t.x)>pt||Math.abs(r.getOrigin().y()-t.y)>pt||Math.abs(r.getOrigin().z()-t.z)>pt||Math.abs(r.getRotation().x()-i.x)>pt||Math.abs(r.getRotation().y()-i.y)>pt||Math.abs(r.getRotation().z()-i.z)>pt||Math.abs(r.getRotation().w()-i.w)>pt)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),e.mass==0){const s=e.physicsBody.getMotionState();s&&s.setWorldTransform(r)}else e.physicsBody.activate()}isSupported(){return this.bjsAMMO!==void 0}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(e.soft?t=e.physicsBody.linearVelocity():t=e.physicsBody.getLinearVelocity(),!t)return null;const i=new m(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(e.soft?t=e.physicsBody.angularVelocity():t=e.physicsBody.getAngularVelocity(),!t)return null;const i=new m(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(w.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===ct.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):w.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(w.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=t<0?0:t,t=t>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):w.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(w.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):w.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(w.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):w.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,r,s=1,a=!1){const o=e.segments,l=Math.round((o-1)*i),c=Math.round((o-1)*r),u=o-1-c,h=l+o*u;e.physicsBody.appendAnchor(h,t.physicsBody,a,s)}appendHook(e,t,i,r=1,s=!1){const a=Math.round(e.segments*i);e.physicsBody.appendAnchor(a,t.physicsBody,s,r)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){w.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){w.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(e,t),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}hn._DISABLE_COLLISION_FLAG=4;hn._KINEMATIC_FLAG=2;hn._DISABLE_DEACTIVATION_FLAG=4;class fE{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=m.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new vh}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(r){r.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(r=>{r.afterStep(),this._tmpImpostorsArray[r.uniqueId]=r});let i=this.world.contacts;for(;i!==null;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const r=this._tmpImpostorsArray[+i.body1.name],s=this._tmpImpostorsArray[+i.body2.name];if(!r||!s){i=i.next;continue}r.onCollide({body:s.physicsBody,point:null,distance:0,impulse:0,normal:null}),s.onCollide({body:r.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){const r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){w.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:e.getParam("mass")!==0,density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(o=>{o.getChildMeshes&&o.getChildMeshes().forEach(function(l){l.physicsImpostor&&i.push(l.physicsImpostor)})})(e.object);const s=o=>Math.max(o,pt),a=new ce;i.forEach(o=>{if(!o.object.rotationQuaternion)return;const l=o.object.rotationQuaternion;a.copyFrom(l),o.object.rotationQuaternion.set(0,0,0,1),o.object.computeWorldMatrix(!0);const c=a.toEulerAngles(),u=o.getObjectExtents(),h=57.29577951308232;if(o===e){const f=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(f,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(f.x),t.pos.push(f.y),t.pos.push(f.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const f=o.object.position.clone();t.posShape.push(f.x),t.posShape.push(f.y),t.posShape.push(f.z),t.rotShape.push(c.x*h,c.y*h,c.z*h)}switch(o.object.rotationQuaternion.copyFrom(a),o.type){case ct.ParticleImpostor:w.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case ct.SphereImpostor:{const f=u.x,d=u.y,p=u.z,_=Math.max(s(f),s(d),s(p))/2;t.type.push("sphere"),t.size.push(_),t.size.push(_),t.size.push(_);break}case ct.CylinderImpostor:{const f=s(u.x)/2,d=s(u.y);t.type.push("cylinder"),t.size.push(f),t.size.push(d),t.size.push(d);break}case ct.PlaneImpostor:case ct.BoxImpostor:default:{const f=s(u.x),d=s(u.y),p=s(u.z);t.type.push("box"),t.size.push(f),t.size.push(d),t.size.push(p);break}}o.object.rotationQuaternion=l}),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(a),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const r=e.joint.jointData,s=r.nativeParams||{};let a;const o={body1:t,body2:i,axe1:s.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:s.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:s.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:s.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:s.min,max:s.max,collision:s.collision||r.collision,spring:s.spring,world:this.world};switch(e.joint.type){case ci.BallAndSocketJoint:a="jointBall";break;case ci.SpringJoint:{w.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const l=r;o.min=l.length||o.min,o.max=Math.max(o.min,o.max)}case ci.DistanceJoint:a="jointDistance",o.max=r.maxDistance;break;case ci.PrismaticJoint:a="jointPrisme";break;case ci.SliderJoint:a="jointSlide";break;case ci.WheelJoint:a="jointWheel";break;case ci.HingeJoint:default:a="jointHinge";break}o.type=a,e.joint.physicsJoint=this.world.add(o)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){w.Warn(t)}}isSupported(){return this.BJSOIMO!==void 0}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new m(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new m(t.x,t.y,t.z):null}setBodyMass(e,t){const i=t===0;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,i!==void 0&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){i!==void 0?w.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setMotor(t,i)}setLimit(e,t,i,r){const s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setLimit(t,i===void 0?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=i.halfWidth*2,t.y=i.halfHeight*2,t.z=i.halfDepth*2}dispose(){this.world.clear()}raycast(e,t){return w.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){w.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}class Wp{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw rt("")}constructor(e,t=Wp.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new m(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){const r=new vh;return this._physicsPlugin.raycast(e,t,r,i),r}}var dE;(function(n){n[n.FREE=0]="FREE",n[n.LIMITED=1]="LIMITED",n[n.LOCKED=2]="LOCKED"})(dE||(dE={}));var pE;(function(n){n[n.LINEAR_X=0]="LINEAR_X",n[n.LINEAR_Y=1]="LINEAR_Y",n[n.LINEAR_Z=2]="LINEAR_Z",n[n.ANGULAR_X=3]="ANGULAR_X",n[n.ANGULAR_Y=4]="ANGULAR_Y",n[n.ANGULAR_Z=5]="ANGULAR_Z",n[n.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"})(pE||(pE={}));var _E;(function(n){n[n.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",n[n.DISTANCE=2]="DISTANCE",n[n.HINGE=3]="HINGE",n[n.SLIDER=4]="SLIDER",n[n.LOCK=5]="LOCK",n[n.PRISMATIC=6]="PRISMATIC",n[n.SIX_DOF=7]="SIX_DOF"})(_E||(_E={}));var va;(function(n){n[n.SPHERE=0]="SPHERE",n[n.CAPSULE=1]="CAPSULE",n[n.CYLINDER=2]="CYLINDER",n[n.BOX=3]="BOX",n[n.CONVEX_HULL=4]="CONVEX_HULL",n[n.CONTAINER=5]="CONTAINER",n[n.MESH=6]="MESH",n[n.HEIGHTFIELD=7]="HEIGHTFIELD"})(va||(va={}));var mE;(function(n){n[n.NONE=0]="NONE",n[n.VELOCITY=1]="VELOCITY",n[n.POSITION=2]="POSITION"})(mE||(mE={}));var gE;(function(n){n.COLLISION_STARTED="COLLISION_STARTED",n.COLLISION_CONTINUED="COLLISION_CONTINUED",n.COLLISION_FINISHED="COLLISION_FINISHED",n.TRIGGER_ENTERED="TRIGGER_ENTERED",n.TRIGGER_EXITED="TRIGGER_EXITED"})(gE||(gE={}));var gd;(function(n){n[n.STATIC=0]="STATIC",n[n.ANIMATED=1]="ANIMATED",n[n.DYNAMIC=2]="DYNAMIC"})(gd||(gd={}));var Vn;(function(n){n[n.DISABLED=0]="DISABLED",n[n.TELEPORT=1]="TELEPORT",n[n.ACTION=2]="ACTION"})(Vn||(Vn={}));var EE;(function(n){n[n.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",n[n.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",n[n.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE"})(EE||(EE={}));class Hp{get disablePreStep(){return this._prestepType==Vn.DISABLED}set disablePreStep(e){this._prestepType=e?Vn.DISABLED:Vn.TELEPORT}constructor(e,t,i,r){if(this._pluginData=void 0,this._pluginDataInstances=[],this._collisionCBEnabled=!1,this._collisionEndedCBEnabled=!1,this.disableSync=!1,this._isDisposed=!1,this._shape=null,this._prestepType=Vn.DISABLED,!r)return;const s=r.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(this._physicsEngine=s,s.getPluginVersion()!=2)throw new Error("Plugin version is incorrect. Expected version 2.");const a=s.getPhysicsPlugin();if(!a)throw new Error("No Physics Plugin available.");this._physicsPlugin=a,e.rotationQuaternion||(e.rotationQuaternion=ce.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z)),this.startAsleep=i,this._motionType=t,this.disableSync=t==0;const o=e;o.hasThinInstances?this._physicsPlugin.initBodyInstances(this,t,o):(e.parent&&e.computeWorldMatrix(!0),this._physicsPlugin.initBody(this,t,e.absolutePosition,e.absoluteRotationQuaternion)),this.transformNode=e,e.physicsBody=this,s.addBody(this),this._nodeDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}getClassName(){return"PhysicsBody"}clone(e){const t=new Hp(e,this.getMotionType(),this.startAsleep,this.transformNode.getScene());return t.shape=this.shape,t.setMassProperties(this.getMassProperties()),t.setLinearDamping(this.getLinearDamping()),t.setAngularDamping(this.getAngularDamping()),t}updateBodyInstances(){const e=this.transformNode;e.hasThinInstances&&this._physicsPlugin.updateBodyInstances(this,e)}get numInstances(){return this._pluginDataInstances.length}get motionType(){return this._motionType}set shape(e){this._shape=e,e&&this._physicsPlugin.setShape(this,e)}get shape(){return this._shape}getBoundingBox(){return this._physicsPlugin.getBodyBoundingBox(this)}setEventMask(e,t){this._physicsPlugin.setEventMask(this,e,t)}getEventMask(e){return this._physicsPlugin.getEventMask(this,e)}setMotionType(e,t){this.disableSync=e==0,this._physicsPlugin.setMotionType(this,e,t)}getMotionType(e){return this._physicsPlugin.getMotionType(this,e)}setPrestepType(e){this._prestepType=e}getPrestepType(){return this._prestepType}computeMassProperties(e){return this._physicsPlugin.computeMassProperties(this,e)}setMassProperties(e,t){this._physicsPlugin.setMassProperties(this,e,t)}getMassProperties(e){return this._physicsPlugin.getMassProperties(this,e)}setLinearDamping(e,t){this._physicsPlugin.setLinearDamping(this,e,t)}getLinearDamping(e){return this._physicsPlugin.getLinearDamping(this,e)}setAngularDamping(e,t){this._physicsPlugin.setAngularDamping(this,e,t)}getAngularDamping(e){return this._physicsPlugin.getAngularDamping(this,e)}setLinearVelocity(e,t){this._physicsPlugin.setLinearVelocity(this,e,t)}getLinearVelocityToRef(e,t){this._physicsPlugin.getLinearVelocityToRef(this,e,t)}getLinearVelocity(e){const t=new m;return this.getLinearVelocityToRef(t,e),t}setAngularVelocity(e,t){this._physicsPlugin.setAngularVelocity(this,e,t)}getAngularVelocityToRef(e,t){this._physicsPlugin.getAngularVelocityToRef(this,e,t)}getAngularVelocity(e){const t=new m;return this.getAngularVelocityToRef(t,e),t}applyImpulse(e,t,i){this._physicsPlugin.applyImpulse(this,e,t,i)}applyAngularImpulse(e,t){this._physicsPlugin.applyAngularImpulse(this,e,t)}applyForce(e,t,i){this._physicsPlugin.applyForce(this,e,t,i)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}getCollisionObservable(){return this._physicsPlugin.getCollisionObservable(this)}getCollisionEndedObservable(){return this._physicsPlugin.getCollisionEndedObservable(this)}setCollisionCallbackEnabled(e){this._collisionCBEnabled=e,this._physicsPlugin.setCollisionCallbackEnabled(this,e)}setCollisionEndedCallbackEnabled(e){this._collisionEndedCBEnabled=e,this._physicsPlugin.setCollisionEndedCallbackEnabled(this,e)}getObjectCenterWorld(e){const t=new m;return this.getObjectCenterWorldToRef(t,e)}getObjectCenterWorldToRef(e,t){var i;if(((i=this._pluginDataInstances)==null?void 0:i.length)>0){const r=t||0,s=this.transformNode._thinInstanceDataStorage.matrixData;s&&e.set(s[r*16+12],s[r*16+13],s[r*16+14])}else e.copyFrom(this.transformNode.position);return e}addConstraint(e,t,i,r){this._physicsPlugin.addConstraint(this,e,t,i,r)}syncWithBone(e,t,i,r,s,a){const o=this.transformNode;if(o.rotationQuaternion)if(s){const u=B.Quaternion[0];e.getRotationQuaternionToRef(1,t,u),u.multiplyToRef(s,o.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,o.rotationQuaternion);const l=B.Vector3[0],c=B.Vector3[1];a||(a=B.Vector3[2],a.x=0,a.y=1,a.z=0),e.getDirectionToRef(a,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),o.setAbsolutePosition(l)}iterateOverAllInstances(e){var t;if(((t=this._pluginDataInstances)==null?void 0:t.length)>0)for(let i=0;i<this._pluginDataInstances.length;i++)e(this,i);else e(this,void 0)}setGravityFactor(e,t){this._physicsPlugin.setGravityFactor(this,e,t)}getGravityFactor(e){return this._physicsPlugin.getGravityFactor(this,e)}setTargetTransform(e,t,i){this._physicsPlugin.setTargetTransform(this,e,t,i)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._collisionCBEnabled&&this.setCollisionCallbackEnabled(!1),this._collisionEndedCBEnabled&&this.setCollisionEndedCallbackEnabled(!1),this._nodeDisposeObserver&&(this.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this.transformNode.physicsBody=null,this._pluginData=null,this._pluginDataInstances.length=0,this._isDisposed=!0,this.shape=null)}}class MC{constructor(e,t){if(this._pluginData=void 0,this._isTrigger=!1,this._isDisposed=!1,!t)return;const i=t.getPhysicsEngine();if(!i)throw new Error("No Physics Engine available.");if(i.getPluginVersion()!=2)throw new Error("Plugin version is incorrect. Expected version 2.");const r=i.getPhysicsPlugin();if(!r)throw new Error("No Physics Plugin available.");if(this._physicsPlugin=r,e.pluginData!==void 0&&e.pluginData!==null)this._pluginData=e.pluginData,this._type=this._physicsPlugin.getShapeType(this);else if(e.type!==void 0&&e.type!==null){this._type=e.type;const s=e.parameters??{};this._physicsPlugin.initShape(this,e.type,s)}}getClassName(){return"PhysicsShape"}get type(){return this._type}set filterMembershipMask(e){this._physicsPlugin.setShapeFilterMembershipMask(this,e)}get filterMembershipMask(){return this._physicsPlugin.getShapeFilterMembershipMask(this)}set filterCollideMask(e){this._physicsPlugin.setShapeFilterCollideMask(this,e)}get filterCollideMask(){return this._physicsPlugin.getShapeFilterCollideMask(this)}set material(e){this._physicsPlugin.setMaterial(this,e),this._material=e}get material(){return this._material||(this._material=this._physicsPlugin.getMaterial(this)),this._material}set density(e){this._physicsPlugin.setDensity(this,e)}get density(){return this._physicsPlugin.getDensity(this)}addChildFromParent(e,t,i){const r=i.computeWorldMatrix(!0),s=e.computeWorldMatrix(!0),a=B.Matrix[0];r.multiplyToRef(O.Invert(s),a);const o=B.Vector3[0],l=B.Quaternion[0],c=B.Vector3[1];a.decompose(c,l,o),this._physicsPlugin.addChild(this,t,o,l,c)}addChild(e,t,i,r){this._physicsPlugin.addChild(this,e,t,i,r)}removeChild(e){this._physicsPlugin.removeChild(this,e)}getNumChildren(){return this._physicsPlugin.getNumChildren(this)}getBoundingBox(){return this._physicsPlugin.getBoundingBox(this)}set isTrigger(e){this._isTrigger!==e&&(this._isTrigger=e,this._physicsPlugin.setTrigger(this,e))}get isTrigger(){return this._isTrigger}dispose(){this._isDisposed||(this._physicsPlugin.disposeShape(this),this._isDisposed=!0)}}var vE;(function(n){n[n.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",n[n.MINIMUM=1]="MINIMUM",n[n.MAXIMUM=2]="MAXIMUM",n[n.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",n[n.MULTIPLY=4]="MULTIPLY"})(vE||(vE={}));class tl{constructor(e,t,i={mass:0},r){if(this.transformNode=e,this.type=t,this._options=i,this._scene=r,this._disposeShapeWhenDisposed=!0,!this.transformNode){w.Error("No object was provided. A physics object is obligatory");return}const s=e;if(this.transformNode.parent&&this._options.mass!==0&&s.hasThinInstances&&w.Warn("A physics body has been created for an object which has a parent and thin instances. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),!this._scene)return;this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution;const a=this._options.mass===0?0:2,o=this._options.startAsleep??!1;this.body=new Hp(e,a,o,this._scene),this._addSizeOptions(),t.getClassName&&t.getClassName()==="PhysicsShape"?(this.shape=t,this._disposeShapeWhenDisposed=!1):this.shape=new MC({type:t,parameters:this._options},this._scene),this._options.isTriggerShape&&(this.shape.isTrigger=!0),this.material={friction:this._options.friction,restitution:this._options.restitution},this.body.shape=this.shape,this.shape.material=this.material,this.body.setMassProperties({mass:this._options.mass}),this._nodeDisposeObserver=this.transformNode.onDisposeObservable.add(()=>{this.dispose()})}_getObjectBoundingBox(){return this.transformNode.getRawBoundingInfo?this.transformNode.getRawBoundingInfo().boundingBox:new hs(new m(-.5,-.5,-.5),new m(.5,.5,.5))}_hasVertices(e){return(e==null?void 0:e.getTotalVertices())>0}_addSizeOptions(){this.transformNode.computeWorldMatrix(!0);const e=this._getObjectBoundingBox(),t=B.Vector3[0];t.copyFrom(e.extendSize),t.scaleInPlace(2),t.multiplyInPlace(this.transformNode.absoluteScaling),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z);const i=B.Vector3[1];if(i.copyFrom(e.minimum),i.multiplyInPlace(this.transformNode.absoluteScaling),!this._options.center){const r=new m;r.copyFrom(e.center),r.multiplyInPlace(this.transformNode.absoluteScaling),this._options.center=r}switch(this.type){case 0:!this._options.radius&&Qt(t.x,t.y,1e-4)&&Qt(t.x,t.z,1e-4)?this._options.radius=t.x/2:this._options.radius||(w.Warn("Non uniform scaling is unsupported for sphere shapes. Setting the radius to the biggest bounding box extent."),this._options.radius=Math.max(t.x,t.y,t.z)/2);break;case 1:{const r=t.x/2;this._options.radius=this._options.radius??r,this._options.pointA=this._options.pointA??new m(0,i.y+r,0),this._options.pointB=this._options.pointB??new m(0,i.y+t.y-r,0)}break;case 2:{const r=t.x/2;this._options.radius=this._options.radius??r,this._options.pointA=this._options.pointA??new m(0,i.y,0),this._options.pointB=this._options.pointB??new m(0,i.y+t.y,0)}break;case 6:case 4:case 7:if(!this._options.mesh&&this._hasVertices(this.transformNode))this._options.mesh=this.transformNode;else if(!this._options.mesh||!this._hasVertices(this._options.mesh))throw new Error("No valid mesh was provided for mesh or convex hull shape parameter. Please provide a mesh with valid geometry (number of vertices greater than 0).");break;case 3:this._options.extents=this._options.extents??new m(t.x,t.y,t.z),this._options.rotation=this._options.rotation??ce.Identity();break}}dispose(){this._nodeDisposeObserver&&(this.body.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this.body.dispose(),this._disposeShapeWhenDisposed&&this.shape.dispose()}}class U1{constructor(e,t,i){this._vertices=[],this._indices=[],this._isRightHanded=i.useRightHandedSystem,this._collectIndices=t}addNodeMeshes(e,t){e.computeWorldMatrix(!0);const i=B.Matrix[0];if(O.ScalingToRef(e.absoluteScaling.x,e.absoluteScaling.y,e.absoluteScaling.z,i),e instanceof k?this._addMesh(e,i):e instanceof el&&this._addMesh(e.sourceMesh,i),t){const r=B.Matrix[1];e.computeWorldMatrix().invertToRef(r);const s=B.Matrix[2];r.multiplyToRef(i,s),e.getChildMeshes(!1).filter(o=>!o.physicsBody).forEach(o=>{const l=o.computeWorldMatrix(),c=B.Matrix[3];l.multiplyToRef(s,c),o instanceof k?this._addMesh(o,c):o instanceof el&&this._addMesh(o.sourceMesh,c)})}}_addMesh(e,t){const i=e.getVerticesData(b.PositionKind)||[],r=i.length/3,s=this._vertices.length;for(let a=0;a<r;a++){const o=new m(i[a*3+0],i[a*3+1],i[a*3+2]);this._vertices.push(m.TransformCoordinates(o,t))}if(this._collectIndices){const a=e.getIndices();if(a)for(let o=0;o<a.length;o+=3)this._isRightHanded?(this._indices.push(a[o+0]+s),this._indices.push(a[o+1]+s),this._indices.push(a[o+2]+s)):(this._indices.push(a[o+2]+s),this._indices.push(a[o+1]+s),this._indices.push(a[o+0]+s))}}getVertices(e){const t=this._vertices.length*3,r=t*4,s=e._malloc(r),a=new Float32Array(e.HEAPU8.buffer,s,t);for(let o=0;o<this._vertices.length;o++)a[o*3+0]=this._vertices[o].x,a[o*3+1]=this._vertices[o].y,a[o*3+2]=this._vertices[o].z;return{offset:s,numObjects:t}}freeBuffer(e,t){e._free(t.offset)}getTriangles(e){const i=this._indices.length*4,r=e._malloc(i),s=new Int32Array(e.HEAPU8.buffer,r,this._indices.length);for(let a=0;a<this._indices.length;a++)s[a]=this._indices[a];return{offset:r,numObjects:this._indices.length}}}class SE{constructor(e){this.hpBodyId=e,this.userMassProps={centerOfMass:void 0,mass:void 0,inertia:void 0,inertiaOrientation:void 0}}}class TE{constructor(){this.bodyId=BigInt(0),this.position=new m,this.normal=new m}}class xE{constructor(){this.contactOnA=new TE,this.contactOnB=new TE,this.impulseApplied=0,this.type=0}static readToRef(e,t,i){const r=new Int32Array(e,t),s=new Float32Array(e,t),a=2;i.contactOnA.bodyId=BigInt(r[a]),i.contactOnA.position.set(s[a+8],s[a+9],s[a+10]),i.contactOnA.normal.set(s[a+11],s[a+12],s[a+13]);const o=18;i.contactOnB.bodyId=BigInt(r[o]),i.contactOnB.position.set(s[o+8],s[o+9],s[o+10]),i.contactOnB.normal.set(s[o+11],s[o+12],s[o+13]),i.impulseApplied=s[o+13+3],i.type=r[0]}}class CE{constructor(){this.bodyIdA=BigInt(0),this.bodyIdB=BigInt(0),this.type=0}static readToRef(e,t,i){const r=new Int32Array(e,t);i.type=r[0],i.bodyIdA=BigInt(r[2]),i.bodyIdB=BigInt(r[6])}}class k1{constructor(e=!0,t=HK){if(this._useDeltaForWorldStep=e,this._hknp={},this.name="HavokPlugin",this._fixedTimeStep=1/60,this._tmpVec3=ms(3,m.Zero),this._bodies=new Map,this._shapes=new Map,this._bodyCollisionObservable=new Map,this._constraintToBodyIdPair=new Map,this._bodyCollisionEndedObservable=new Map,this.onCollisionObservable=new Q,this.onCollisionEndedObservable=new Q,this.onTriggerCollisionObservable=new Q,typeof t=="function"){w.Error("Havok is not ready. Please make sure you await HK() before using the plugin.");return}else this._hknp=t;if(!this.isSupported()){w.Error("Havok is not available. Please make sure you included the js file.");return}this.world=this._hknp.HP_World_Create()[1],this._queryCollector=this._hknp.HP_QueryCollector_Create(1)[1]}isSupported(){return this._hknp!==void 0}setGravity(e){this._hknp.HP_World_SetGravity(this.world,this._bVecToV3(e))}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){for(const r of t)r.disablePreStep||this.setPhysicsBodyTransformation(r,r.transformNode);const i=this._useDeltaForWorldStep?e:this._fixedTimeStep;this._hknp.HP_World_SetIdealStepTime(this.world,i),this._hknp.HP_World_Step(this.world,i),this._bodyBuffer=this._hknp.HP_World_GetBodyBuffer(this.world)[1];for(const r of t)r.disableSync||this.sync(r);this._notifyCollisions(),this._notifyTriggers()}getPluginVersion(){return 2}setVelocityLimits(e,t){this._hknp.HP_World_SetSpeedLimit(this.world,e,t)}getMaxLinearVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[1]}getMaxAngularVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[2]}initBody(e,t,i,r){e._pluginData=new SE(this._hknp.HP_Body_Create()[1]),this._internalSetMotionType(e._pluginData,t);const s=[this._bVecToV3(i),this._bQuatToV4(r)];this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,s),this._hknp.HP_World_AddBody(this.world,e._pluginData.hpBodyId,e.startAsleep),this._bodies.set(e._pluginData.hpBodyId[0],{body:e,index:0})}removeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._bodyCollisionObservable.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._bodies.delete(t.hpBodyId[0]);e._pluginData&&(this._bodyCollisionObservable.delete(e._pluginData.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,e._pluginData.hpBodyId),this._bodies.delete(e._pluginData.hpBodyId[0]))}initBodyInstances(e,t,i){var a;const r=((a=i._thinInstanceDataStorage)==null?void 0:a.instancesCount)??0,s=i._thinInstanceDataStorage.matrixData;s&&(this._createOrUpdateBodyInstances(e,t,s,0,r,!1),e._pluginDataInstances.forEach((o,l)=>{this._bodies.set(o.hpBodyId[0],{body:e,index:l})}))}_createOrUpdateBodyInstances(e,t,i,r,s,a){const o=B.Quaternion[0],l=O.Identity();for(let c=r;c<s;c++){const u=[i[c*16+12],i[c*16+13],i[c*16+14]];let h;a?h=e._pluginDataInstances[c].hpBodyId:h=this._hknp.HP_Body_Create()[1],l.setRowFromFloats(0,i[c*16+0],i[c*16+1],i[c*16+2],0),l.setRowFromFloats(1,i[c*16+4],i[c*16+5],i[c*16+6],0),l.setRowFromFloats(2,i[c*16+8],i[c*16+9],i[c*16+10],0),ce.FromRotationMatrixToRef(l,o);const f=[u,[o.x,o.y,o.z,o.w]];if(this._hknp.HP_Body_SetQTransform(h,f),!a){const d=new SE(h);e._pluginDataInstances.length&&(d.userMassProps=e._pluginDataInstances[0].userMassProps),this._internalSetMotionType(d,t),this._internalUpdateMassProperties(d),e._pluginDataInstances.push(d),this._hknp.HP_World_AddBody(this.world,h,e.startAsleep),d.worldTransformOffset=this._hknp.HP_Body_GetWorldTransformOffset(h)[1]}}}updateBodyInstances(e,t){var o,l;const i=((o=t._thinInstanceDataStorage)==null?void 0:o.instancesCount)??0,r=t._thinInstanceDataStorage.matrixData;if(!r)return;const s=e._pluginDataInstances.length,a=this.getMotionType(e);if(i>s){this._createOrUpdateBodyInstances(e,a,r,s,i,!1);const c=this._hknp.HP_Body_GetShape(e._pluginDataInstances[0].hpBodyId)[1];c[0]||(c[0]=(l=e.shape)==null?void 0:l._pluginData[0]);for(let u=s;u<i;u++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[u].hpBodyId,c),this._internalUpdateMassProperties(e._pluginDataInstances[u]),this._bodies.set(e._pluginDataInstances[u].hpBodyId[0],{body:e,index:u})}else if(i<s){const c=s-i;for(let u=0;u<c;u++){const h=e._pluginDataInstances.pop();this._bodies.delete(h.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,h.hpBodyId),this._hknp.HP_Body_Release(h.hpBodyId)}this._createOrUpdateBodyInstances(e,a,r,0,i,!0)}}sync(e){this.syncTransform(e,e.transformNode)}syncTransform(e,t){var i;if(e._pluginDataInstances.length){const r=t,s=r._thinInstanceDataStorage.matrixData;if(!s)return;const a=e._pluginDataInstances.length;for(let o=0;o<a;o++){const l=e._pluginDataInstances[o].worldTransformOffset,c=new Float32Array(this._hknp.HEAPU8.buffer,this._bodyBuffer+l,16),u=o*16;for(let h=0;h<15;h++)(h&3)!=3&&(s[u+h]=c[h]);s[u+15]=1}r.thinInstanceBufferUpdated("matrix")}else try{const r=this._hknp.HP_Body_GetQTransform(e._pluginData.hpBodyId)[1],s=r[0],a=r[1],o=B.Quaternion[0];o.set(a[0],a[1],a[2],a[3]);const l=t.parent;if(l&&!l.getWorldMatrix().isIdentity()){l.computeWorldMatrix(!0),B.Vector3[1].copyFrom(t.scaling),o.normalize();const c=B.Matrix[0],u=B.Vector3[0];u.copyFromFloats(s[0],s[1],s[2]),O.ComposeToRef(t.absoluteScaling,o,u,c);const h=B.Matrix[1];l.getWorldMatrix().invertToRef(h);const f=B.Matrix[2];c.multiplyToRef(h,f),f.decomposeToTransformNode(t),(i=t.rotationQuaternion)==null||i.normalize(),t.scaling.copyFrom(B.Vector3[1])}else t.position.set(s[0],s[1],s[2]),t.rotationQuaternion?t.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(t.rotation)}catch(r){w.Error(`Syncing transform failed for node ${t.name}: ${r.message}...`)}}setShape(e,t){var a,o;const i=t&&t._pluginData?t._pluginData:BigInt(0);if(!(e.transformNode instanceof k)||!((a=e.transformNode._thinInstanceDataStorage)!=null&&a.matrixData)){this._hknp.HP_Body_SetShape(e._pluginData.hpBodyId,i),this._internalUpdateMassProperties(e._pluginData);return}const s=((o=e.transformNode._thinInstanceDataStorage)==null?void 0:o.instancesCount)??0;for(let l=0;l<s;l++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[l].hpBodyId,i),this._internalUpdateMassProperties(e._pluginDataInstances[l])}_getPluginReference(e,t){var i;return(i=e._pluginDataInstances)!=null&&i.length?e._pluginDataInstances[t??0]:e._pluginData}getShape(e){const t=this._getPluginReference(e),i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1];if(i!=0){const r=e.transformNode.getScene();return new MC({pluginData:i},r)}return null}getShapeType(e){return e.type?e.type:this._hknp.HP_Shape_GetType(e._pluginData)}setEventMask(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_SetEventMask(r.hpBodyId,t)},i)}getEventMask(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1]}_fromMassPropertiesTuple(e){return{centerOfMass:m.FromArray(e[0]),mass:e[1],inertia:m.FromArray(e[2]),inertiaOrientation:ce.FromArray(e[3])}}_internalUpdateMassProperties(e){const t=this._internalComputeMassProperties(e),i=e.userMassProps;i.centerOfMass&&(t[0]=i.centerOfMass.asArray()),i.mass!=null&&(t[1]=i.mass),i.inertia&&(t[2]=i.inertia.asArray()),i.inertiaOrientation&&(t[3]=i.inertiaOrientation.asArray()),this._hknp.HP_Body_SetMassProperties(e.hpBodyId,t)}_internalSetMotionType(e,t){switch(t){case 0:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.STATIC);break;case 1:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.KINEMATIC);break;case 2:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.DYNAMIC);break}}setMotionType(e,t,i){this._applyToBodyOrInstances(e,r=>{this._internalSetMotionType(r,t)},i)}getMotionType(e,t){const i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMotionType(i.hpBodyId)[1];switch(r){case this._hknp.MotionType.STATIC:return 0;case this._hknp.MotionType.KINEMATIC:return 1;case this._hknp.MotionType.DYNAMIC:return 2}throw new Error("Unknown motion type: "+r)}setActivationControl(e,t){switch(t){case 1:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_ACTIVE);break;case 2:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_INACTIVE);break;case 0:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.SIMULATION_CONTROLLED);break}}_internalComputeMassProperties(e){const t=this._hknp.HP_Body_GetShape(e.hpBodyId);if(t[0]==this._hknp.Result.RESULT_OK){const i=this._hknp.HP_Shape_BuildMassProperties(t[1]);if(i[0]==this._hknp.Result.RESULT_OK)return i[1]}return[[0,0,0],1,[1,1,1],[0,0,0,1]]}computeMassProperties(e,t){const i=this._getPluginReference(e,t),r=this._internalComputeMassProperties(i);return this._fromMassPropertiesTuple(r)}setMassProperties(e,t,i){this._applyToBodyOrInstances(e,r=>{r.userMassProps=t,this._internalUpdateMassProperties(r)},i)}getMassProperties(e,t){const i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMassProperties(i.hpBodyId)[1];return this._fromMassPropertiesTuple(r)}setLinearDamping(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_SetLinearDamping(r.hpBodyId,t)},i)}getLinearDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetLinearDamping(i.hpBodyId)[1]}setAngularDamping(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_SetAngularDamping(r.hpBodyId,t)},i)}getAngularDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetAngularDamping(i.hpBodyId)[1]}setLinearVelocity(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_SetLinearVelocity(r.hpBodyId,this._bVecToV3(t))},i)}getLinearVelocityToRef(e,t,i){const r=this._getPluginReference(e,i),s=this._hknp.HP_Body_GetLinearVelocity(r.hpBodyId)[1];this._v3ToBvecRef(s,t)}_applyToBodyOrInstances(e,t,i){var r;if(((r=e._pluginDataInstances)==null?void 0:r.length)>0&&i===void 0)for(let s=0;s<e._pluginDataInstances.length;s++)t(e._pluginDataInstances[s]);else t(this._getPluginReference(e,i))}applyImpulse(e,t,i,r){this._applyToBodyOrInstances(e,s=>{this._hknp.HP_Body_ApplyImpulse(s.hpBodyId,this._bVecToV3(i),this._bVecToV3(t))},r)}applyAngularImpulse(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_ApplyAngularImpulse(r.hpBodyId,this._bVecToV3(t))},i)}applyForce(e,t,i,r){t.scaleToRef(this.getTimeStep(),this._tmpVec3[0]),this.applyImpulse(e,this._tmpVec3[0],i,r)}setAngularVelocity(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_SetAngularVelocity(r.hpBodyId,this._bVecToV3(t))},i)}getAngularVelocityToRef(e,t,i){const r=this._getPluginReference(e,i),s=this._hknp.HP_Body_GetAngularVelocity(r.hpBodyId)[1];this._v3ToBvecRef(s,t)}setPhysicsBodyTransformation(e,t){if(e.getPrestepType()==Vn.TELEPORT){const i=e.transformNode;if(e.numInstances>0){const s=i._thinInstanceDataStorage.matrixData;if(!s)return;const a=e.numInstances;this._createOrUpdateBodyInstances(e,e.getMotionType(),s,0,a,!0)}else this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,this._getTransformInfos(t))}else e.getPrestepType()==Vn.ACTION?this.setTargetTransform(e,t.absolutePosition,t.absoluteRotationQuaternion):e.getPrestepType()==Vn.DISABLED?w.Warn("Prestep type is set to DISABLED. Unable to set physics body transformation."):w.Warn("Invalid prestep type set to physics body.")}setTargetTransform(e,t,i,r){this._applyToBodyOrInstances(e,s=>{this._hknp.HP_Body_SetTargetQTransform(s.hpBodyId,[this._bVecToV3(t),this._bQuatToV4(i)])},r)}setGravityFactor(e,t,i){this._applyToBodyOrInstances(e,r=>{this._hknp.HP_Body_SetGravityFactor(r.hpBodyId,t)},i)}getGravityFactor(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetGravityFactor(i.hpBodyId)[1]}disposeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._hknp.HP_Body_Release(t.hpBodyId),t.hpBodyId=void 0;e._pluginData&&(this._hknp.HP_Body_Release(e._pluginData.hpBodyId),e._pluginData.hpBodyId=void 0)}_createOptionsFromGroundMesh(e){const t=e.groundMesh;if(!t)return;let i=t.getVerticesData(b.PositionKind);const r=t.computeWorldMatrix(!0),s=[];let a;for(a=0;a<i.length;a+=3)m.FromArrayToRef(i,a,B.Vector3[0]),m.TransformCoordinatesToRef(B.Vector3[0],r,B.Vector3[1]),B.Vector3[1].toArray(s,a);i=s;const o=~~(Math.sqrt(i.length/3)-1),l=t.getBoundingInfo(),c=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.z),u=l.boundingBox.minimumWorld.x,h=l.boundingBox.minimumWorld.y,f=l.boundingBox.minimumWorld.z,d=new Float32Array((o+1)*(o+1)),p=c*2/o;for(let _=0;_<d.length;_++)d[_]=h;for(let _=0;_<i.length;_=_+3){const g=Math.round((i[_+0]-u)/p),E=o-Math.round((i[_+2]-f)/p),v=i[_+1]-h;d[E*(o+1)+g]=v}e.numHeightFieldSamplesX=o+1,e.numHeightFieldSamplesZ=o+1,e.heightFieldSizeX=l.boundingBox.extendSizeWorld.x*2,e.heightFieldSizeZ=l.boundingBox.extendSizeWorld.z*2,e.heightFieldData=d}initShape(e,t,i){switch(t){case 0:{const r=i.radius||1,s=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateSphere(s,r)[1]}break;case 3:{const r=i.rotation?this._bQuatToV4(i.rotation):[0,0,0,1],s=i.extents?this._bVecToV3(i.extents):[1,1,1],a=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateBox(a,r,s)[1]}break;case 1:{const r=i.pointA?this._bVecToV3(i.pointA):[0,0,0],s=i.pointB?this._bVecToV3(i.pointB):[0,1,0],a=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCapsule(r,s,a)[1]}break;case 5:e._pluginData=this._hknp.HP_Shape_CreateContainer()[1];break;case 2:{const r=i.pointA?this._bVecToV3(i.pointA):[0,0,0],s=i.pointB?this._bVecToV3(i.pointB):[0,1,0],a=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCylinder(r,s,a)[1]}break;case 4:case 6:{const r=i.mesh;if(r){const s=!!i.includeChildMeshes,a=t!=4,o=new U1(r,a,r==null?void 0:r.getScene());o.addNodeMeshes(r,s);const l=o.getVertices(this._hknp),c=l.numObjects/3;if(t==4)e._pluginData=this._hknp.HP_Shape_CreateConvexHull(l.offset,c)[1];else{const u=o.getTriangles(this._hknp),h=u.numObjects/3;e._pluginData=this._hknp.HP_Shape_CreateMesh(l.offset,c,u.offset,h)[1],o.freeBuffer(this._hknp,u)}o.freeBuffer(this._hknp,l)}else throw new Error("No mesh provided to create physics shape.")}break;case 7:if(i.groundMesh&&this._createOptionsFromGroundMesh(i),i.numHeightFieldSamplesX&&i.numHeightFieldSamplesZ&&i.heightFieldSizeX&&i.heightFieldSizeZ&&i.heightFieldData){const r=i.numHeightFieldSamplesX*i.numHeightFieldSamplesZ,s=r*4,a=this._hknp._malloc(s),o=new Float32Array(this._hknp.HEAPU8.buffer,a,r);for(let u=0;u<i.numHeightFieldSamplesX;u++)for(let h=0;h<i.numHeightFieldSamplesZ;h++){const f=h*i.numHeightFieldSamplesX+u,d=(i.numHeightFieldSamplesX-1-u)*i.numHeightFieldSamplesZ+h;o[f]=i.heightFieldData[d]}const l=i.heightFieldSizeX/(i.numHeightFieldSamplesX-1),c=i.heightFieldSizeZ/(i.numHeightFieldSamplesZ-1);e._pluginData=this._hknp.HP_Shape_CreateHeightField(i.numHeightFieldSamplesX,i.numHeightFieldSamplesZ,[l,1,c],a)[1],this._hknp._free(a)}else throw new Error("Missing required heightfield parameters");break;default:throw new Error("Unsupported Shape Type.")}this._shapes.set(e._pluginData[0],e)}setShapeFilterMembershipMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[t,i])}getShapeFilterMembershipMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0]}setShapeFilterCollideMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[i,t])}getShapeFilterCollideMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1]}setMaterial(e,t){const i=t.friction??.5,r=t.staticFriction??i,s=t.restitution??0,a=t.frictionCombine??1,o=t.restitutionCombine??2,l=[r,i,s,this._materialCombineToNative(a),this._materialCombineToNative(o)];this._hknp.HP_Shape_SetMaterial(e._pluginData,l)}getMaterial(e){const t=this._hknp.HP_Shape_GetMaterial(e._pluginData)[1];return{staticFriction:t[0],friction:t[1],restitution:t[2],frictionCombine:this._nativeToMaterialCombine(t[3]),restitutionCombine:this._nativeToMaterialCombine(t[4])}}setDensity(e,t){this._hknp.HP_Shape_SetDensity(e._pluginData,t)}getDensity(e){return this._hknp.HP_Shape_GetDensity(e._pluginData)[1]}_getTransformInfos(e){if(e.parent)return e.computeWorldMatrix(!0),[this._bVecToV3(e.absolutePosition),this._bQuatToV4(e.absoluteRotationQuaternion)];let t=B.Quaternion[0];if(e.rotationQuaternion)t=e.rotationQuaternion;else{const r=e.rotation;ce.FromEulerAnglesToRef(r.x,r.y,r.z,t)}return[this._bVecToV3(e.position),this._bQuatToV4(t)]}addChild(e,t,i,r,s){const a=[i?this._bVecToV3(i):[0,0,0],r?this._bQuatToV4(r):[0,0,0,1],s?this._bVecToV3(s):[1,1,1]];this._hknp.HP_Shape_AddChild(e._pluginData,t._pluginData,a)}removeChild(e,t){this._hknp.HP_Shape_RemoveChild(e._pluginData,t)}getNumChildren(e){return this._hknp.HP_Shape_GetNumChildren(e._pluginData)[1]}setTrigger(e,t){this._hknp.HP_Shape_SetTrigger(e._pluginData,t)}getBoundingBox(e){const t=this._hknp.HP_Shape_GetBoundingBox(e._pluginData,[[0,0,0],[0,0,0,1]])[1];return B.Vector3[0].set(t[0][0],t[0][1],t[0][2]),B.Vector3[1].set(t[1][0],t[1][1],t[1][2]),new hs(B.Vector3[0],B.Vector3[1],O.IdentityReadOnly)}getBodyBoundingBox(e){const t=this.getBoundingBox(e.shape);return new hs(t.minimum,t.maximum,e.transformNode.getWorldMatrix())}getBodyGeometry(e){var u;const t=((u=e._pluginDataInstances)==null?void 0:u.length)>0?e._pluginDataInstances[0]:e._pluginData,i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1],r=this._hknp.HP_Shape_CreateDebugDisplayGeometry(i);if(r[0]!=this._hknp.Result.RESULT_OK)return{positions:[],indices:[]};const s=this._hknp.HP_DebugGeometry_GetInfo(r[1])[1],a=new Float32Array(this._hknp.HEAPU8.buffer,s[0],s[1]*3),o=new Uint32Array(this._hknp.HEAPU8.buffer,s[2],s[3]*3),l=a.slice(0),c=o.slice(0);return this._hknp.HP_DebugGeometry_Release(r[1]),{positions:l,indices:c}}disposeShape(e){this._hknp.HP_Shape_Release(e._pluginData),e._pluginData=void 0}initConstraint(e,t,i,r,s){const a=e.type,o=e.options;if(!a||!o){w.Warn("No constraint type or options. Constraint is invalid.");return}if(t._pluginDataInstances.length>0&&r===void 0||i._pluginDataInstances.length>0&&s===void 0){w.Warn("Body is instanced but no instance index was specified. Constraint will not be applied.");return}e._pluginData=e._pluginData??[];const l=this._hknp.HP_Constraint_Create()[1];e._pluginData.push(l);const c=this._getPluginReference(t,r).hpBodyId,u=this._getPluginReference(i,s).hpBodyId;this._hknp.HP_Constraint_SetParentBody(l,c),this._hknp.HP_Constraint_SetChildBody(l,u),this._constraintToBodyIdPair.set(l[0],[c[0],u[0]]);const h=o.pivotA?this._bVecToV3(o.pivotA):this._bVecToV3(m.Zero()),f=o.axisA??new m(1,0,0),d=this._tmpVec3[0];o.perpAxisA?d.copyFrom(o.perpAxisA):f.getNormalToRef(d),this._hknp.HP_Constraint_SetAnchorInParent(l,h,this._bVecToV3(f),this._bVecToV3(d));const p=o.pivotB?this._bVecToV3(o.pivotB):this._bVecToV3(m.Zero()),_=o.axisB??new m(1,0,0),g=this._tmpVec3[0];if(o.perpAxisB?g.copyFrom(o.perpAxisB):_.getNormalToRef(g),this._hknp.HP_Constraint_SetAnchorInChild(l,p,this._bVecToV3(_),this._bVecToV3(g)),e._initOptions||(e._initOptions={axisA:f.clone(),axisB:_.clone(),perpAxisA:d.clone(),perpAxisB:g.clone(),pivotA:new m(h[0],h[1],h[2]),pivotB:new m(p[0],p[1],p[2])}),a==5)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(a==2){const v=o.maxDistance||0,x=this._hknp.ConstraintAxis.LINEAR_DISTANCE;this._hknp.HP_Constraint_SetAxisMode(l,x,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(l,x,v),this._hknp.HP_Constraint_SetAxisMaxLimit(l,x,v)}else if(a==3)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(a==6)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(a==4)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(a==1)this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(l,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(a==7){const v=e;for(const x of v.limits){const A=this._constraintAxisToNative(x.axis);(x.minLimit??-1)==0&&(x.maxLimit??-1)==0?this._hknp.HP_Constraint_SetAxisMode(l,A,this._hknp.ConstraintAxisLimitMode.LOCKED):(x.minLimit!=null&&(this._hknp.HP_Constraint_SetAxisMode(l,A,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(l,A,x.minLimit)),x.maxLimit!=null&&(this._hknp.HP_Constraint_SetAxisMode(l,A,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMaxLimit(l,A,x.maxLimit))),x.stiffness&&this._hknp.HP_Constraint_SetAxisStiffness(l,A,x.stiffness),x.damping&&this._hknp.HP_Constraint_SetAxisDamping(l,A,x.damping)}}else throw new Error("Unsupported Constraint Type.");const E=!!o.collision;this._hknp.HP_Constraint_SetCollisionsEnabled(l,E),this._hknp.HP_Constraint_SetEnabled(l,!0)}getBodiesUsingConstraint(e){const t=[];for(const i of e._pluginData){const r=this._constraintToBodyIdPair.get(i[0]);if(r){const s=this._bodies.get(r[0]),a=this._bodies.get(r[1]);s&&a&&t.push({parentBody:s.body,parentBodyIndex:s.index,childBody:a.body,childBodyIndex:a.index})}}return t}addConstraint(e,t,i,r,s){this.initConstraint(i,e,t,r,s)}setEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetEnabled(i,t)}getEnabled(e){const t=e._pluginData&&e._pluginData[0];return t?this._hknp.HP_Constraint_GetEnabled(t)[1]:!1}setCollisionsEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetCollisionsEnabled(i,t)}getCollisionsEnabled(e){const t=e._pluginData&&e._pluginData[0];return t?this._hknp.HP_Constraint_GetCollisionsEnabled(t)[1]:!1}setAxisFriction(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisFriction(r,this._constraintAxisToNative(t),i)}getAxisFriction(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisFriction(i,this._constraintAxisToNative(t))[1]:null}setAxisMode(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMode(r,this._constraintAxisToNative(t),this._limitModeToNative(i))}getAxisMode(e,t){const i=e._pluginData&&e._pluginData[0];if(i){const r=this._hknp.HP_Constraint_GetAxisMode(i,this._constraintAxisToNative(t))[1];return this._nativeToLimitMode(r)}return null}setAxisMinLimit(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMinLimit(r,this._constraintAxisToNative(t),i)}getAxisMinLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMinLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMaxLimit(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMaxLimit(r,this._constraintAxisToNative(t),i)}getAxisMaxLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMaxLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMotorType(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorType(r,this._constraintAxisToNative(t),this._constraintMotorTypeToNative(i))}getAxisMotorType(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._nativeToMotorType(this._hknp.HP_Constraint_GetAxisMotorType(i,this._constraintAxisToNative(t))[1]):null}setAxisMotorTarget(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorTarget(r,this._constraintAxisToNative(t),i)}getAxisMotorTarget(e,t){return e._pluginData&&e._pluginData[0]?this._hknp.HP_Constraint_GetAxisMotorTarget(e._pluginData,this._constraintAxisToNative(t))[1]:null}setAxisMotorMaxForce(e,t,i){for(const r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorMaxForce(r,this._constraintAxisToNative(t),i)}getAxisMotorMaxForce(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMotorMaxForce(i,this._constraintAxisToNative(t))[1]:null}disposeConstraint(e){for(const t of e._pluginData)this._hknp.HP_Constraint_SetEnabled(t,!1),this._hknp.HP_Constraint_Release(t);e._pluginData.length=0}_populateHitData(e,t){const i=this._bodies.get(e[0][0]);t.body=i==null?void 0:i.body,t.bodyIndex=i==null?void 0:i.index;const r=this._shapes.get(e[1][0]);t.shape=r;const s=e[3],a=e[4],o=e[5];t.setHitData({x:a[0],y:a[1],z:a[2]},{x:s[0],y:s[1],z:s[2]},o)}raycast(e,t,i,r){const s=(r==null?void 0:r.membership)??-1,a=(r==null?void 0:r.collideWith)??-1,o=(r==null?void 0:r.shouldHitTriggers)??!1;i.reset(e,t);const l=[BigInt(0)],c=[this._bVecToV3(e),this._bVecToV3(t),[s,a],o,l];if(this._hknp.HP_World_CastRayWithCollector(this.world,this._queryCollector,c),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[,u]=this._hknp.HP_QueryCollector_GetCastRayResult(this._queryCollector,0)[1];this._populateHitData(u,i),i.calculateHitDistance()}}pointProximity(e,t){var o,l;const i=((o=e==null?void 0:e.collisionFilter)==null?void 0:o.membership)??-1,r=((l=e==null?void 0:e.collisionFilter)==null?void 0:l.collideWith)??-1;t.reset();const s=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],a=[this._bVecToV3(e.position),e.maxDistance,[i,r],e.shouldHitTriggers,s];if(this._hknp.HP_World_PointProximityWithCollector(this.world,this._queryCollector,a),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[c,u]=this._hknp.HP_QueryCollector_GetPointProximityResult(this._queryCollector,0)[1];this._populateHitData(u,t),t.setHitDistance(c)}}shapeProximity(e,t,i){t.reset(),i.reset();const r=e.shape._pluginData,s=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],a=[r,this._bVecToV3(e.position),this._bQuatToV4(e.rotation),e.maxDistance,e.shouldHitTriggers,s];if(this._hknp.HP_World_ShapeProximityWithCollector(this.world,this._queryCollector,a),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[o,l,c]=this._hknp.HP_QueryCollector_GetShapeProximityResult(this._queryCollector,0)[1];this._populateHitData(l,t),this._populateHitData(c,i),t.setHitDistance(o),i.setHitDistance(o)}}shapeCast(e,t,i){t.reset(),i.reset();const r=e.shape._pluginData,s=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],a=[r,this._bQuatToV4(e.rotation),this._bVecToV3(e.startPosition),this._bVecToV3(e.endPosition),e.shouldHitTriggers,s];if(this._hknp.HP_World_ShapeCastWithCollector(this.world,this._queryCollector,a),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[o,l,c]=this._hknp.HP_QueryCollector_GetShapeCastResult(this._queryCollector,0)[1];this._populateHitData(l,t),this._populateHitData(c,i),t.setHitFraction(o),i.setHitFraction(o)}}getCollisionObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionObservable.get(t);return i||(i=new Q,this._bodyCollisionObservable.set(t,i)),i}getCollisionEndedObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionEndedObservable.get(t);return i||(i=new Q,this._bodyCollisionEndedObservable.set(t,i)),i}setCollisionCallbackEnabled(e,t){const i=this._hknp.EventType.COLLISION_STARTED.value|this._hknp.EventType.COLLISION_CONTINUED.value|this._hknp.EventType.COLLISION_FINISHED.value;e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach(r=>{this._hknp.HP_Body_SetEventMask(r.hpBodyId,t?i:0)}):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,t?i:0)}setCollisionEndedCallbackEnabled(e,t){const i=this._getPluginReference(e);let r=this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1];r=t?r|this._hknp.EventType.COLLISION_FINISHED.value:r&~this._hknp.EventType.COLLISION_FINISHED.value,e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach(s=>{this._hknp.HP_Body_SetEventMask(s.hpBodyId,r)}):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,r)}_notifyTriggers(){let e=this._hknp.HP_World_GetTriggerEvents(this.world)[1];const t=new CE;for(;e;){CE.readToRef(this._hknp.HEAPU8.buffer,e,t);const i=this._bodies.get(t.bodyIdA),r=this._bodies.get(t.bodyIdB);if(i&&r){const s={collider:i.body,colliderIndex:i.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,type:this._nativeTriggerCollisionValueToCollisionType(t.type)};this.onTriggerCollisionObservable.notifyObservers(s)}e=this._hknp.HP_World_GetNextTriggerEvent(this.world,e)}}_notifyCollisions(){let e=this._hknp.HP_World_GetCollisionEvents(this.world)[1];const t=new xE,i=Number(this.world);for(;e;){xE.readToRef(this._hknp.HEAPU8.buffer,e,t);const r=this._bodies.get(t.contactOnA.bodyId),s=this._bodies.get(t.contactOnB.bodyId);if(r&&s){const a={collider:r.body,colliderIndex:r.index,collidedAgainst:s.body,collidedAgainstIndex:s.index,type:this._nativeCollisionValueToCollisionType(t.type)};if(a.type==="COLLISION_FINISHED")this.onCollisionEndedObservable.notifyObservers(a);else{t.contactOnB.position.subtractToRef(t.contactOnA.position,this._tmpVec3[0]);const o=m.Dot(this._tmpVec3[0],t.contactOnA.normal);a.point=t.contactOnA.position,a.distance=o,a.impulse=t.impulseApplied,a.normal=t.contactOnA.normal,this.onCollisionObservable.notifyObservers(a)}if(this._bodyCollisionObservable.size&&a.type!=="COLLISION_FINISHED"){const o=this._bodyCollisionObservable.get(t.contactOnA.bodyId),l=this._bodyCollisionObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const c=m.Dot(this._tmpVec3[0],t.contactOnB.normal);if(o&&o.notifyObservers(a),l){const u={collider:s.body,colliderIndex:s.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,point:t.contactOnB.position,distance:c,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};l.notifyObservers(u)}}else if(this._bodyCollisionEndedObservable.size){const o=this._bodyCollisionEndedObservable.get(t.contactOnA.bodyId),l=this._bodyCollisionEndedObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const c=m.Dot(this._tmpVec3[0],t.contactOnB.normal);if(o&&o.notifyObservers(a),l){const u={collider:s.body,colliderIndex:s.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,point:t.contactOnB.position,distance:c,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};l.notifyObservers(u)}}}e=this._hknp.HP_World_GetNextCollisionEvent(i,e)}}get numBodies(){return this._hknp.HP_World_GetNumBodies(this.world)[1]}dispose(){this._queryCollector&&(this._hknp.HP_QueryCollector_Release(this._queryCollector),this._queryCollector=void 0),this.world&&(this._hknp.HP_World_Release(this.world),this.world=void 0)}_v3ToBvecRef(e,t){t.set(e[0],e[1],e[2])}_bVecToV3(e){return[e._x,e._y,e._z]}_bQuatToV4(e){return[e._x,e._y,e._z,e._w]}_constraintMotorTypeToNative(e){switch(e){case 2:return this._hknp.ConstraintMotorType.POSITION;case 1:return this._hknp.ConstraintMotorType.VELOCITY}return this._hknp.ConstraintMotorType.NONE}_nativeToMotorType(e){switch(e){case this._hknp.ConstraintMotorType.POSITION:return 2;case this._hknp.ConstraintMotorType.VELOCITY:return 1}return 0}_materialCombineToNative(e){switch(e){case 0:return this._hknp.MaterialCombine.GEOMETRIC_MEAN;case 1:return this._hknp.MaterialCombine.MINIMUM;case 2:return this._hknp.MaterialCombine.MAXIMUM;case 3:return this._hknp.MaterialCombine.ARITHMETIC_MEAN;case 4:return this._hknp.MaterialCombine.MULTIPLY}}_nativeToMaterialCombine(e){switch(e){case this._hknp.MaterialCombine.GEOMETRIC_MEAN:return 0;case this._hknp.MaterialCombine.MINIMUM:return 1;case this._hknp.MaterialCombine.MAXIMUM:return 2;case this._hknp.MaterialCombine.ARITHMETIC_MEAN:return 3;case this._hknp.MaterialCombine.MULTIPLY:return 4;default:return}}_constraintAxisToNative(e){switch(e){case 0:return this._hknp.ConstraintAxis.LINEAR_X;case 1:return this._hknp.ConstraintAxis.LINEAR_Y;case 2:return this._hknp.ConstraintAxis.LINEAR_Z;case 3:return this._hknp.ConstraintAxis.ANGULAR_X;case 4:return this._hknp.ConstraintAxis.ANGULAR_Y;case 5:return this._hknp.ConstraintAxis.ANGULAR_Z;case 6:return this._hknp.ConstraintAxis.LINEAR_DISTANCE}}_nativeToLimitMode(e){switch(e){case this._hknp.ConstraintAxisLimitMode.FREE:return 0;case this._hknp.ConstraintAxisLimitMode.LIMITED:return 1;case this._hknp.ConstraintAxisLimitMode.LOCKED:return 2}return 0}_limitModeToNative(e){switch(e){case 0:return this._hknp.ConstraintAxisLimitMode.FREE;case 1:return this._hknp.ConstraintAxisLimitMode.LIMITED;case 2:return this._hknp.ConstraintAxisLimitMode.LOCKED}}_nativeCollisionValueToCollisionType(e){switch(e){case this._hknp.EventType.COLLISION_STARTED.value:return"COLLISION_STARTED";case this._hknp.EventType.COLLISION_FINISHED.value:return"COLLISION_FINISHED";case this._hknp.EventType.COLLISION_CONTINUED.value:return"COLLISION_CONTINUED"}return"COLLISION_STARTED"}_nativeTriggerCollisionValueToCollisionType(e){switch(e){case 8:return"TRIGGER_ENTERED";case 16:return"TRIGGER_EXITED"}return"TRIGGER_ENTERED"}}ht.prototype.getPhysicsEngine=function(){return this._physicsEngine};ht.prototype.enablePhysics=function(n=null,e){if(this._physicsEngine)return!0;let t=this._getComponent(we.NAME_PHYSICSENGINE);t||(t=new G1(this),this._addComponent(t));try{if(!e||(e==null?void 0:e.getPluginVersion())===1)this._physicsEngine=new SC(n,e);else if((e==null?void 0:e.getPluginVersion())===2)this._physicsEngine=new Wp(n,e);else throw new Error("Unsupported Physics plugin version.");return this._physicsTimeAccumulator=0,!0}catch(i){return w.Error(i.message),!1}};ht.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)};ht.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0};ht.prototype.deleteCompoundImpostor=function(n){const e=n.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)};ht.prototype._advancePhysicsEngineStep=function(n){if(this._physicsEngine){const e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=n;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(n/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class G1{constructor(e){this.name=we.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new Q,this.scene.onAfterPhysicsObservable=new Q,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?this.scene._physicsEngine.getTimeStep()*1e3:1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(ot.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(n){this._physicsBody!==n&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=n,n&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)})))},enumerable:!0,configurable:!0});ot.prototype.getPhysicsBody=function(){return this.physicsBody};ot.prototype.applyImpulse=function(n,e){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(n,e),this};ot.prototype.applyAngularImpulse=function(n){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(n),this};function Xp(n){const e=(n.segments||32)|0,t=n.diameterX||n.diameter||1,i=n.diameterY||n.diameter||1,r=n.diameterZ||n.diameter||1,s=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,a=n.slice&&n.slice<=0?1:n.slice||1,o=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,l=!!n.dedupTopBottomIndices,c=new m(t/2,i/2,r/2),u=2+e,h=2*u,f=[],d=[],p=[],_=[];for(let E=0;E<=u;E++){const v=E/u,x=v*Math.PI*a;for(let A=0;A<=h;A++){const T=A/h,C=T*Math.PI*2*s,y=O.RotationZ(-x),P=O.RotationY(C),D=m.TransformCoordinates(m.Up(),y),F=m.TransformCoordinates(D,P),W=F.multiply(c),H=F.divide(c).normalize();d.push(W.x,W.y,W.z),p.push(H.x,H.y,H.z),_.push(T,v)}if(E>0){const A=d.length/3;for(let T=A-2*(h+1);T+h+2<A;T++)l?(E>1&&(f.push(T),f.push(T+1),f.push(T+h+1)),(E<u||a<1)&&(f.push(T+h+1),f.push(T+1),f.push(T+h+2))):(f.push(T),f.push(T+1),f.push(T+h+1),f.push(T+h+1),f.push(T+1),f.push(T+h+2))}}de._ComputeSides(o,d,f,p,_,n.frontUVs,n.backUVs);const g=new de;return g.indices=f,g.positions=d,g.normals=p,g.uvs=_,g}function Yp(n,e={},t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Xp(e).applyToMesh(i,e.updatable),i}de.CreateSphere=Xp;k.CreateSphere=(n,e,t,i,r,s)=>Yp(n,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:r},i);function $p(n){const e=n.height||2;let t=n.diameterTop===0?0:n.diameterTop||n.diameter||1,i=n.diameterBottom===0?0:n.diameterBottom||n.diameter||1;t=t||1e-5,i=i||1e-5;const r=(n.tessellation||24)|0,s=(n.subdivisions||1)|0,a=!!n.hasRings,o=!!n.enclose,l=n.cap===0?0:n.cap||k.CAP_ALL,c=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,u=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,h=n.faceUV||new Array(3),f=n.faceColors,d=c!==1&&o?2:0,p=a?s:1,_=2+(1+d)*p;let g;for(g=0;g<_;g++)f&&f[g]===void 0&&(f[g]=new Be(1,1,1,1));for(g=0;g<_;g++)h&&h[g]===void 0&&(h[g]=new We(0,0,1,1));const E=[],v=[],x=[],A=[],T=[],C=Math.PI*2*c/r;let y,P,D;const F=(i-t)/2/e,W=m.Zero(),H=m.Zero(),ue=m.Zero(),ae=m.Zero(),le=m.Zero(),oe=ys.Y;let ge,Ee,ne,j=1,L=1,Y=0,te=0;for(ge=0;ge<=s;ge++)for(P=ge/s,D=(P*(t-i)+i)/2,j=a&&ge!==0&&ge!==s?2:1,ne=0;ne<j;ne++){for(a&&(L+=ne),o&&(L+=2*ne),Ee=0;Ee<=r;Ee++)y=Ee*C,W.x=Math.cos(-y)*D,W.y=-e/2+P*e,W.z=Math.sin(-y)*D,t===0&&ge===s?(H.x=x[x.length-(r+1)*3],H.y=x[x.length-(r+1)*3+1],H.z=x[x.length-(r+1)*3+2]):(H.x=W.x,H.z=W.z,H.y=Math.sqrt(H.x*H.x+H.z*H.z)*F,H.normalize()),Ee===0&&(ue.copyFrom(W),ae.copyFrom(H)),v.push(W.x,W.y,W.z),x.push(H.x,H.y,H.z),a?te=Y!==L?h[L].y:h[L].w:te=h[L].y+(h[L].w-h[L].y)*P,A.push(h[L].x+(h[L].z-h[L].x)*Ee/r,te),f&&T.push(f[L].r,f[L].g,f[L].b,f[L].a);c!==1&&o&&(v.push(W.x,W.y,W.z),v.push(0,W.y,0),v.push(0,W.y,0),v.push(ue.x,ue.y,ue.z),m.CrossToRef(oe,H,le),le.normalize(),x.push(le.x,le.y,le.z,le.x,le.y,le.z),m.CrossToRef(ae,oe,le),le.normalize(),x.push(le.x,le.y,le.z,le.x,le.y,le.z),a?te=Y!==L?h[L+1].y:h[L+1].w:te=h[L+1].y+(h[L+1].w-h[L+1].y)*P,A.push(h[L+1].x,te),A.push(h[L+1].z,te),a?te=Y!==L?h[L+2].y:h[L+2].w:te=h[L+2].y+(h[L+2].w-h[L+2].y)*P,A.push(h[L+2].x,te),A.push(h[L+2].z,te),f&&(T.push(f[L+1].r,f[L+1].g,f[L+1].b,f[L+1].a),T.push(f[L+1].r,f[L+1].g,f[L+1].b,f[L+1].a),T.push(f[L+2].r,f[L+2].g,f[L+2].b,f[L+2].a),T.push(f[L+2].r,f[L+2].g,f[L+2].b,f[L+2].a))),Y!==L&&(Y=L)}const De=c!==1&&o?r+4:r;for(ge=0,L=0;L<s;L++){let Me=0,Re=0,Pe=0,ft=0;for(Ee=0;Ee<r;Ee++)Me=ge*(De+1)+Ee,Re=(ge+1)*(De+1)+Ee,Pe=ge*(De+1)+(Ee+1),ft=(ge+1)*(De+1)+(Ee+1),E.push(Me,Re,Pe),E.push(ft,Pe,Re);c!==1&&o&&(E.push(Me+2,Re+2,Pe+2),E.push(ft+2,Pe+2,Re+2),E.push(Me+4,Re+4,Pe+4),E.push(ft+4,Pe+4,Re+4)),ge=a?ge+2:ge+1}const Ve=Me=>{const Re=Me?t/2:i/2;if(Re===0)return;let Pe,ft,Wt;const xe=Me?h[_-1]:h[0];let z=null;f&&(z=Me?f[_-1]:f[0]);const K=v.length/3,he=Me?e/2:-e/2,Ce=new m(0,he,0);v.push(Ce.x,Ce.y,Ce.z),x.push(0,Me?1:-1,0);const ye=xe.y+(xe.w-xe.y)*.5;A.push(xe.x+(xe.z-xe.x)*.5,ye),z&&T.push(z.r,z.g,z.b,z.a);const be=new se(.5,.5);for(Wt=0;Wt<=r;Wt++){Pe=Math.PI*2*Wt*c/r;const Je=Math.cos(-Pe),qe=Math.sin(-Pe);ft=new m(Je*Re,he,qe*Re);const Ge=new se(Je*be.x+.5,qe*be.y+.5);v.push(ft.x,ft.y,ft.z),x.push(0,Me?1:-1,0);const Le=xe.y+(xe.w-xe.y)*Ge.y;A.push(xe.x+(xe.z-xe.x)*Ge.x,Le),z&&T.push(z.r,z.g,z.b,z.a)}for(Wt=0;Wt<r;Wt++)Me?(E.push(K),E.push(K+(Wt+2)),E.push(K+(Wt+1))):(E.push(K),E.push(K+(Wt+1)),E.push(K+(Wt+2)))};(l===k.CAP_START||l===k.CAP_ALL)&&Ve(!1),(l===k.CAP_END||l===k.CAP_ALL)&&Ve(!0),de._ComputeSides(u,v,E,x,A,n.frontUVs,n.backUVs);const ve=new de;return ve.indices=E,ve.positions=v,ve.normals=x,ve.uvs=A,f&&(ve.colors=T),ve}function DC(n,e={},t){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,$p(e).applyToMesh(i,e.updatable),i}de.CreateCylinder=$p;k.CreateCylinder=(n,e,t,i,r,s,a,o,l)=>((a===void 0||!(a instanceof ht))&&(a!==void 0&&(l=o||k.DEFAULTSIDE,o=a),a=s,s=1),DC(n,{height:e,diameterTop:t,diameterBottom:i,tessellation:r,subdivisions:s,sideOrientation:l,updatable:o},a));class yt{constructor(e,t,i=Number.MAX_VALUE,r=pt){this.origin=e,this.direction=t,this.length=i,this.epsilon=r}clone(){return new yt(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const r=yt._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),s=yt._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let a=0,o=Number.MAX_VALUE,l,c,u,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,u=(s.x-this.origin.x)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,u=(s.y-this.origin.y)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,u=(s.z-this.origin.z)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,a=i*i+r*r+s*s,o=e.radius+t,l=o*o;if(a<=l)return!0;const c=i*this.direction.x+r*this.direction.y+s*this.direction.z;return c<0?!1:a-c*c<=l}intersectsTriangle(e,t,i){const r=yt._TmpVector3[0],s=yt._TmpVector3[1],a=yt._TmpVector3[2],o=yt._TmpVector3[3],l=yt._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,s),m.CrossToRef(this.direction,s,a);const c=m.Dot(r,a);if(c===0)return null;const u=1/c;this.origin.subtractToRef(e,o);const h=m.Dot(o,a)*u;if(h<-this.epsilon||h>1+this.epsilon)return null;m.CrossToRef(o,r,l);const f=m.Dot(this.direction,l)*u;if(f<-this.epsilon||h+f>1+this.epsilon)return null;const d=m.Dot(s,l)*u;return d>this.length?null:new od(1-h-f,h,d)}intersectsPlane(e){let t;const i=m.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const r=m.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new m(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new m(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new m(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,s,a=!1){const o=B.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?yt.TransformToRef(this,o,this._tmpRay):this._tmpRay=yt.Transform(this,o),e.intersects(this._tmpRay,t,i,r,s,a)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){const s=this.intersectsMesh(e[r],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const r=this.origin,s=B.Vector3[0],a=B.Vector3[1],o=B.Vector3[2],l=B.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(yt._Rayl,o),r.addToRef(o,a),e.subtractToRef(r,l);const c=m.Dot(s,s),u=m.Dot(s,o),h=m.Dot(o,o),f=m.Dot(s,l),d=m.Dot(o,l),p=c*h-u*u;let _,g=p,E,v=p;p<yt._Smallnum?(_=0,g=1,E=d,v=h):(_=u*d-h*f,E=c*d-u*f,_<0?(_=0,E=d,v=h):_>g&&(_=g,E=d+u,v=h)),E<0?(E=0,-f<0?_=0:-f>c?_=g:(_=-f,g=c)):E>v&&(E=v,-f+u<0?_=0:-f+u>c?_=g:(_=-f+u,g=c));const x=Math.abs(_)<yt._Smallnum?0:_/g,A=Math.abs(E)<yt._Smallnum?0:E/v,T=B.Vector3[4];o.scaleToRef(A,T);const C=B.Vector3[5];s.scaleToRef(x,C),C.addInPlace(l);const y=B.Vector3[6];return C.subtractToRef(T,y),A>0&&A<=this.length&&y.lengthSquared()<i*i?C.length():-1}update(e,t,i,r,s,a,o,l=!1){if(l){yt._RayDistant||(yt._RayDistant=yt.Zero()),yt._RayDistant.unprojectRayToRef(e,t,i,r,O.IdentityReadOnly,a,o);const c=B.Matrix[0];s.invertToRef(c),yt.TransformToRef(yt._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,s,a,o);return this}static Zero(){return new yt(m.Zero(),m.Zero())}static CreateNew(e,t,i,r,s,a,o){return yt.Zero().update(e,t,i,r,s,a,o)}static CreateNewFromTo(e,t,i=O.IdentityReadOnly){const r=new yt(new m(0,0,0),new m(0,0,0));return yt.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=O.IdentityReadOnly){i.origin.copyFrom(e);const s=t.subtractToRef(e,i.direction),a=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return i.length=a,i.direction.normalize(),yt.TransformToRef(i,r,i)}static Transform(e,t){const i=new yt(new m(0,0,0),new m(0,0,0));return yt.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){m.TransformCoordinatesToRef(e.origin,t,i.origin),m.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;const r=i.direction,s=r.length();if(!(s===0||s===1)){const a=1/s;r.x*=a,r.y*=a,r.z*=a,i.length*=s}return i}unprojectRayToRef(e,t,i,r,s,a,o){const l=B.Matrix[0];s.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();const c=$e.LastCreatedEngine,u=B.Vector3[0];u.x=e/i*2-1,u.y=-(t/r*2-1),u.z=c!=null&&c.useReverseDepthBuffer?1:c!=null&&c.isNDCHalfZRange?0:-1;const h=B.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),f=B.Vector3[2],d=B.Vector3[3];m._UnprojectFromInvertedMatrixToRef(u,l,f),m._UnprojectFromInvertedMatrixToRef(h,l,d),this.origin.copyFrom(f),d.subtractToRef(f,this.direction),this.direction.normalize()}}yt._TmpVector3=ms(6,m.Zero);yt._RayDistant=yt.Zero();yt._Smallnum=1e-8;yt._Rayl=1e9;function Sh(n,e,t,i,r,s=!1){const a=yt.Zero();return Th(n,e,t,i,a,r,s),a}function Th(n,e,t,i,r,s,a=!1,o=!1){const l=n.getEngine();if(!s&&!(s=n.activeCamera))return n;const c=s.viewport,u=l.getRenderHeight(),{x:h,y:f,width:d,height:p}=c.toGlobal(l.getRenderWidth(),u),_=1/l.getHardwareScalingLevel();return e=e*_-h,t=t*_-(u-f-p),r.update(e,t,d,p,i||O.IdentityReadOnly,a?O.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),o),n}function OC(n,e,t,i){const r=yt.Zero();return xh(n,e,t,r,i),r}function xh(n,e,t,i,r){if(!es)return n;const s=n.getEngine();if(!r&&!(r=n.activeCamera))throw new Error("Active camera not set");const a=r.viewport,o=s.getRenderHeight(),{x:l,y:c,width:u,height:h}=a.toGlobal(s.getRenderWidth(),o),f=O.Identity(),d=1/s.getHardwareScalingLevel();return e=e*d-l,t=t*d-(o-c-h),i.update(e,t,u,h,f,f,r.getProjectionMatrix()),n}function NC(n,e,t,i,r,s,a,o){const l=e(i,t.enableDistantPicking),c=t.intersects(l,r,a,s,i,o);return!c||!c.hit||!r&&n!=null&&c.distance>=n.distance?null:c}function Kp(n,e,t,i,r,s){let a=null;const o=!!(n.activeCameras&&n.activeCameras.length>1&&n.cameraToUseForPointers!==n.activeCamera),l=n.cameraToUseForPointers||n.activeCamera,c=NC;for(let u=0;u<n.meshes.length;u++){const h=n.meshes[u];if(t){if(!t(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const f=o&&h.isWorldMatrixCameraDependent(),d=h.computeWorldMatrix(f,l);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const p=c(a,e,h,d,!0,!0,s);if(p){if(r)return p;const _=B.Matrix[1],g=h.thinInstanceGetWorldMatrices();for(let E=0;E<g.length;E++){if(t&&!t(h,E))continue;g[E].multiplyToRef(d,_);const x=c(a,e,h,_,i,r,s,!0);if(x&&(a=x,a.thinInstanceIndex=E,i))return a}}}else{const p=c(a,e,h,d,i,r,s);if(p&&(a=p,i))return a}}return a||new es}function LC(n,e,t,i){if(!es)return null;const r=[],s=!!(n.activeCameras&&n.activeCameras.length>1&&n.cameraToUseForPointers!==n.activeCamera),a=n.cameraToUseForPointers||n.activeCamera,o=NC;for(let l=0;l<n.meshes.length;l++){const c=n.meshes[l];if(t){if(!t(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const u=s&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,a);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(o(null,e,c,h,!0,!0,i)){const d=B.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let _=0;_<p.length;_++){if(t&&!t(c,_))continue;p[_].multiplyToRef(h,d);const E=o(null,e,c,d,!1,!1,i,!0);E&&(E.thinInstanceIndex=_,r.push(E))}}}else{const f=o(null,e,c,h,!1,!1,i);f&&r.push(f)}}return r}function z1(n,e,t,i,r,s){if(!es)return null;const a=Kp(n,o=>(n._tempPickingRay||(n._tempPickingRay=yt.Zero()),Th(n,e,t,o,n._tempPickingRay,s||null),n._tempPickingRay),i,r,!0);return a&&(a.ray=Sh(n,e,t,O.Identity(),s||null)),a}function W1(n,e,t,i,r,s,a,o=!1){const l=Kp(n,(c,u)=>(n._tempPickingRay||(n._tempPickingRay=yt.Zero()),Th(n,e,t,c,n._tempPickingRay,s||null,!1,u),n._tempPickingRay),i,r,!1,a);return l&&(l.ray=Sh(n,e,t,O.Identity(),s||null)),l}function H1(n,e,t,i,r){const s=Kp(n,a=>(n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=O.Identity()),a.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=yt.Zero()),yt.TransformToRef(e,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform),t,i,!1,r);return s&&(s.ray=e),s}function X1(n,e,t,i,r,s){return LC(n,a=>Sh(n,e,t,a,r||null),i,s)}function Y1(n,e,t,i){return LC(n,r=>(n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=O.Identity()),r.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=yt.Zero()),yt.TransformToRef(e,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform),t,i)}function AE(n,e,t=100,i,r){i||(i=n.getWorldMatrix()),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(n.position);const s=B.Vector3[2];s.set(0,0,n._scene.useRightHandedSystem?-1:1);const a=B.Vector3[3];return m.TransformNormalToRef(s,i,a),m.NormalizeToRef(a,e.direction),e}function $1(n,e){e&&(e.prototype.getForwardRay=function(t=100,i,r){return AE(this,new yt(m.Zero(),m.Zero(),t),t,i,r)},e.prototype.getForwardRayToRef=function(t,i=100,r,s){return AE(this,t,i,r,s)}),n&&(dp._IsPickingAvailable=!0,n.prototype.createPickingRay=function(t,i,r,s,a=!1){return Sh(this,t,i,r,s,a)})}$1(ht,He);ht.prototype.createPickingRayToRef=function(n,e,t,i,r,s=!1,a=!1){return Th(this,n,e,t,i,r,s,a)};ht.prototype.createPickingRayInCameraSpace=function(n,e,t){return OC(this,n,e,t)};ht.prototype.createPickingRayInCameraSpaceToRef=function(n,e,t,i){return xh(this,n,e,t,i)};ht.prototype.pickWithBoundingInfo=function(n,e,t,i,r){return z1(this,n,e,t,i,r)};ht.prototype.pick=function(n,e,t,i,r,s,a=!1){return W1(this,n,e,t,i,r,s,a)};ht.prototype.pickWithRay=function(n,e,t,i){return H1(this,n,e,t,i)};ht.prototype.multiPick=function(n,e,t,i,r){return X1(this,n,e,t,i,r)};ht.prototype.multiPickWithRay=function(n,e,t){return Y1(this,n,e,t)};m.Zero();var IE;(function(n){n[n.Constant=0]="Constant",n[n.Linear=1]="Linear"})(IE||(IE={}));var yE;(function(n){n[n.Center=0]="Center",n[n.Perpendicular=1]="Perpendicular"})(yE||(yE={}));const bE=.8;class ir extends jt{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(O.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach(s=>r+=s),new ir(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){const s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const a=new ir(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=s,a}constructor(e,t,i=null,r=!1,s=null,a=null,o=null,l=5,c=!1,u=null,h=!1,f=bE,d=0,p,_){var v;super(t),this.onLoadObservable=new Q,this.boundingBoxPosition=m.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new O,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=O.Identity(),this.coordinatesMode=Z.CUBIC_MODE;let g=null,E=null;i!==null&&!Array.isArray(i)?(g=i.extensions??null,this._noMipmap=i.noMipmap??!1,s=i.files??null,E=i.buffer??null,this._format=i.format??5,c=i.prefiltered??!1,u=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??bE,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,a=i.onLoad??null,o=i.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=h,g=i,this._loaderOptions=p,this._useSRGBBuffer=_,this._lodScale=f,this._lodOffset=d),!(!e&&!s)&&this.updateURL(e,u,a,c,o,g,(v=this.getScene())==null?void 0:v.useDelayedTextureLoading,s,E)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,s=null,a=null,o=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const u=e.lastIndexOf("."),h=t||(u>-1?e.substring(u).toLowerCase():""),f=h.indexOf(".dds")===0,d=h.indexOf(".env")===0,p=h.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!p&&!d&&!f&&!a&&(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let _=0;_<a.length;_++)this._files.push(e+a[_]);this._extensions=a}this._buffer=c,o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var s,a;if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&((s=this.getScene())==null||s.markAllMaterialsAsDirty(1,o=>o.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e,!((a=this.getScene())!=null&&a.useRightHandedSystem)))return;const t=B.Vector3[0],i=B.Quaternion[0],r=B.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,O.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return(e=this.getScene())!=null&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var o;const i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const s=()=>{var l;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),(l=this.getScene())==null||l.markAllMaterialsAsDirty(1)),e&&e()},a=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),Z.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?J.SetImmediate(()=>s()):this._texture.onLoadedObservable.add(()=>s()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),(o=this._texture)==null||o.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const r=Ke.Parse(()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new ir(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.animations)for(let s=0;s<e.animations.length;s++){const a=e.animations[s],o=Ai("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}return r}clone(){let e=0;const t=Ke.Clone(()=>{const i=new ir(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}I([M()],ir.prototype,"url",void 0);I([Ar()],ir.prototype,"boundingBoxPosition",void 0);I([Ar()],ir.prototype,"boundingBoxSize",null);I([M("rotationY")],ir.prototype,"rotationY",null);I([M("files")],ir.prototype,"_files",void 0);I([M("forcedExtension")],ir.prototype,"_forcedExtension",void 0);I([M("extensions")],ir.prototype,"_extensions",void 0);I([nT("textureMatrix")],ir.prototype,"_textureMatrix",void 0);I([nT("textureMatrixRefraction")],ir.prototype,"_textureMatrixRefraction",void 0);Z._CubeTextureParser=ir.Parse;$("BABYLON.CubeTexture",ir);class ba{static ConvertPanoramaToCubemap(e,t,i,r,s=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";const a=this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,i,s),o=this.CreateCubemapTexture(r,this.FACE_BACK,e,t,i,s),l=this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,i,s),c=this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,i,s),u=this.CreateCubemapTexture(r,this.FACE_UP,e,t,i,s),h=this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,i,s);return{front:a,back:o,left:l,right:c,up:u,down:h,size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,r,s,a=!1){const o=new ArrayBuffer(e*e*4*3),l=new Float32Array(o),c=a?Math.max(1,Math.round(r/4/e)):1,u=1/c,h=u*u,f=t[1].subtract(t[0]).scale(u/e),d=t[3].subtract(t[2]).scale(u/e),p=1/e;let _=0;for(let g=0;g<e;g++)for(let E=0;E<c;E++){let v=t[0],x=t[2];for(let A=0;A<e;A++)for(let T=0;T<c;T++){const C=x.subtract(v).scale(_).add(v);C.normalize();const y=this.CalcProjectionSpherical(C,i,r,s);l[g*e*3+A*3+0]+=y.r*h,l[g*e*3+A*3+1]+=y.g*h,l[g*e*3+A*3+2]+=y.b*h,v=v.add(f),x=x.add(d)}_+=p*u}return l}static CalcProjectionSpherical(e,t,i,r){let s=Math.atan2(e.z,e.x);const a=Math.acos(e.y);for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;let o=s/Math.PI;const l=a/Math.PI;o=o*.5+.5;let c=Math.round(o*i);c<0?c=0:c>=i&&(c=i-1);let u=Math.round(l*r);u<0?u=0:u>=r&&(u=r-1);const h=r-u-1,f=t[h*i*3+c*3+0],d=t[h*i*3+c*3+1],p=t[h*i*3+c*3+2];return{r:f,g:d,b:p}}}ba.FACE_LEFT=[new m(-1,-1,-1),new m(1,-1,-1),new m(-1,1,-1),new m(1,1,-1)];ba.FACE_RIGHT=[new m(1,-1,1),new m(-1,-1,1),new m(1,1,1),new m(-1,1,1)];ba.FACE_FRONT=[new m(1,-1,-1),new m(1,-1,1),new m(1,1,-1),new m(1,1,1)];ba.FACE_BACK=[new m(-1,-1,1),new m(-1,-1,-1),new m(-1,1,1),new m(-1,1,-1)];ba.FACE_DOWN=[new m(1,1,-1),new m(1,1,1),new m(-1,1,-1),new m(-1,1,1)];ba.FACE_UP=[new m(-1,-1,-1),new m(-1,-1,1),new m(1,-1,-1),new m(1,-1,1)];function K1(n,e){return e>1023?n*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?n*Math.pow(2,-1074)*Math.pow(2,e+1074):n*Math.pow(2,e)}function FC(n,e,t,i,r,s){r>0?(r=K1(1,r-136),n[s+0]=e*r,n[s+1]=t*r,n[s+2]=i*r):(n[s+0]=0,n[s+1]=0,n[s+2]=0)}function Df(n,e){let t="",i="";for(let r=e;r<n.length-e&&(i=String.fromCharCode(n[r]),i!=`
`);r++)t+=i;return t}function j1(n){let e=0,t=0,i=Df(n,0);if(i[0]!="#"||i[1]!="?")throw"Bad HDR Format.";let r=!1,s=!1,a=0;do a+=i.length+1,i=Df(n,a),i=="FORMAT=32-bit_rle_rgbe"?s=!0:i.length==0&&(r=!0);while(!r);if(!s)throw"HDR Bad header format, unsupported FORMAT";a+=i.length+1,i=Df(n,a);const l=/^-Y (.*) \+X (.*)$/g.exec(i);if(!l||l.length<3)throw"HDR Bad header format, no size";if(t=parseInt(l[2]),e=parseInt(l[1]),t<8||t>32767)throw"HDR Bad header format, unsupported size";return a+=i.length+1,{height:e,width:t,dataPosition:a}}function q1(n,e,t=!1){const i=new Uint8Array(n),r=j1(i),s=Z1(i,r);return ba.ConvertPanoramaToCubemap(s,r.width,r.height,e,t)}function Z1(n,e){return Q1(n,e)}function Q1(n,e){let t=e.height;const i=e.width;let r,s,a,o,l,c=e.dataPosition,u=0,h=0,f=0;const d=new ArrayBuffer(i*4),p=new Uint8Array(d),_=new ArrayBuffer(e.width*e.height*4*3),g=new Float32Array(_);for(;t>0;){if(r=n[c++],s=n[c++],a=n[c++],o=n[c++],r!=2||s!=2||a&128||e.width<8||e.width>32767)return J1(n,e);if((a<<8|o)!=i)throw"HDR Bad header format, wrong scan line width";for(u=0,f=0;f<4;f++)for(h=(f+1)*i;u<h;)if(r=n[c++],s=n[c++],r>128){if(l=r-128,l==0||l>h-u)throw"HDR Bad Format, bad scanline data (run)";for(;l-- >0;)p[u++]=s}else{if(l=r,l==0||l>h-u)throw"HDR Bad Format, bad scanline data (non-run)";if(p[u++]=s,--l>0)for(let E=0;E<l;E++)p[u++]=n[c++]}for(f=0;f<i;f++)r=p[f],s=p[f+i],a=p[f+2*i],o=p[f+3*i],FC(g,r,s,a,o,(e.height-t)*i*3+f*3);t--}return g}function J1(n,e){let t=e.height;const i=e.width;let r,s,a,o,l,c=e.dataPosition;const u=new ArrayBuffer(e.width*e.height*4*3),h=new Float32Array(u);for(;t>0;){for(l=0;l<e.width;l++)r=n[c++],s=n[c++],a=n[c++],o=n[c++],FC(h,r,s,a,o,(e.height-t)*i*3+l*3);t--}return h}class ew{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=mc(t)+1,r=this._effectWrapper.effect,s=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();const a=e.getInternalTexture();a&&this._engine.updateTextureSamplingMode(3,a,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new m(0,0,-1),new m(0,-1,0),new m(1,0,0)],[new m(0,0,1),new m(0,-1,0),new m(-1,0,0)],[new m(1,0,0),new m(0,0,1),new m(0,1,0)],[new m(1,0,0),new m(0,0,-1),new m(0,-1,0)],[new m(1,0,0),new m(0,-1,0),new m(0,0,1)],[new m(-1,0,0),new m(0,-1,0),new m(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let u=0;u<6;u++){r.setVector3("up",o[u][0]),r.setVector3("right",o[u][1]),r.setVector3("front",o[u][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(s,u,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let f=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;h===0&&(f=0),r.setFloat("alphaG",f),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);const l=s.texture.type,c=s.texture.format;return s._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){const i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");const r=this._engine.isWebGPU;return new Or({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:async()=>{r?await Promise.all([re(()=>Promise.resolve().then(()=>kW),void 0),re(()=>Promise.resolve().then(()=>zW),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>wW),void 0),re(()=>Promise.resolve().then(()=>VW),void 0)])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new _T(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(w.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class ja extends jt{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(O.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,r=!1,s=!0,a=!1,o=!1,l=null,c=null,u=!1){var h;super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=m.Zero(),this.onLoadObservable=new Q,e&&(this._coordinatesMode=Z.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=O.Identity(),this._prefilterOnLoad=o,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=c,this.gammaSpace=a,this._noMipmap=r,this._size=i,this._supersample=u,this._generateHarmonics=s,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?J.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):(h=this.getScene())!=null&&h.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2);const r=s=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const a=q1(s,this._size,this._supersample);if(this._generateHarmonics){const u=ol.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=u}const o=[];let l=null,c=null;for(let u=0;u<6;u++){i===2?c=new Uint16Array(this._size*this._size*3):i===0&&(l=new Uint8Array(this._size*this._size*3));const h=a[ja._FacesMapping[u]];if(this.gammaSpace||c||l){for(let f=0;f<this._size*this._size;f++)if(this.gammaSpace&&(h[f*3+0]=Math.pow(h[f*3+0],ou),h[f*3+1]=Math.pow(h[f*3+1],ou),h[f*3+2]=Math.pow(h[f*3+2],ou)),c&&(c[f*3+0]=Ur(h[f*3+0]),c[f*3+1]=Ur(h[f*3+1]),c[f*3+2]=Ur(h[f*3+2])),l){let d=Math.max(h[f*3+0]*255,0),p=Math.max(h[f*3+1]*255,0),_=Math.max(h[f*3+2]*255,0);const g=Math.max(Math.max(d,p),_);if(g>255){const E=255/g;d*=E,p*=E,_*=E}l[f*3+0]=d,l[f*3+1]=p,l[f*3+2]=_}}c?o.push(c):l?o.push(l):o.push(h)}return o};if(e._features.allowTexturePrefiltering&&this._prefilterOnLoad){const s=this._onLoad,a=new ew(e);this._onLoad=()=>{a.prefilter(this,s)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,r,null,this._onLoad,this._onError)}clone(){const e=new ja(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())==null||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let r=null;return e.name&&!e.isRenderTarget&&(r=new ja(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),r.name=e.name,r.hasAlpha=e.hasAlpha,r.level=e.level,r.coordinatesMode=e.coordinatesMode,r.isBlocking=e.isBlocking),r&&(e.boundingBoxPosition&&(r.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.rotationY&&(r.rotationY=e.rotationY)),r}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}ja._FacesMapping=["right","left","up","down","front","back"];$("BABYLON.HDRCubeTexture",ja);class il{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new il(this.name,this.from,this.to)}}const wC=Object.freeze(new ce(0,0,0,0)),BC=Object.freeze(m.Zero()),VC=Object.freeze(se.Zero()),UC=Object.freeze(xs.Zero()),kC=Object.freeze(fe.Black()),GC=Object.freeze(new Be(0,0,0,0)),ws={key:0,repeatCount:0,loopMode:2};class me{static _PrepareAnimation(e,t,i,r,s,a,o,l){let c;if(!isNaN(parseFloat(s))&&isFinite(s)?c=me.ANIMATIONTYPE_FLOAT:s instanceof ce?c=me.ANIMATIONTYPE_QUATERNION:s instanceof m?c=me.ANIMATIONTYPE_VECTOR3:s instanceof se?c=me.ANIMATIONTYPE_VECTOR2:s instanceof fe?c=me.ANIMATIONTYPE_COLOR3:s instanceof Be?c=me.ANIMATIONTYPE_COLOR4:s instanceof xs&&(c=me.ANIMATIONTYPE_SIZE),c==null)return null;const u=new me(e,t,i,c,o),h=[{frame:0,value:s},{frame:r,value:a}];return u.setKeys(h),l!==void 0&&u.setEasingFunction(l),u}static CreateAnimation(e,t,i,r){const s=new me(e+"Animation",e,i,t,me.ANIMATIONLOOPMODE_CONSTANT);return s.setEasingFunction(r),s}static CreateAndStartAnimation(e,t,i,r,s,a,o,l,c,u,h){const f=me._PrepareAnimation(e,i,r,s,a,o,l,c);return!f||(t.getScene&&(h=t.getScene()),!h)?null:h.beginDirectAnimation(t,[f],0,s,f.loopMode===1,1,u)}static CreateAndStartHierarchyAnimation(e,t,i,r,s,a,o,l,c,u,h){const f=me._PrepareAnimation(e,r,s,a,o,l,c,u);return f?t.getScene().beginDirectHierarchyAnimation(t,i,[f],0,a,f.loopMode===1,1,h):null}static CreateMergeAndStartAnimation(e,t,i,r,s,a,o,l,c,u){const h=me._PrepareAnimation(e,i,r,s,a,o,l,c);return h?(t.animations.push(h),t.getScene().beginAnimation(t,0,s,h.loopMode===1,1,u)):null}static MakeAnimationAdditive(e,t,i,r=!1,s){let a;typeof t=="object"?a=t:a={referenceFrame:t??0,range:i,cloneOriginalAnimation:r,clonedAnimationName:s};let o=e;if(a.cloneOriginalAnimation&&(o=e.clone(),o.name=a.clonedAnimationName||o.name),!o._keys.length)return o;const l=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0;let c=0;const u=o._keys[0];let h=o._keys.length-1;const f=o._keys[h],d={referenceValue:u.value,referencePosition:B.Vector3[0],referenceQuaternion:B.Quaternion[0],referenceScaling:B.Vector3[1],keyPosition:B.Vector3[2],keyQuaternion:B.Quaternion[1],keyScaling:B.Vector3[3]};let p=u.frame,_=f.frame;if(a.range){const v=o.getRange(a.range);v&&(p=v.from,_=v.to)}else p=a.fromFrame??p,_=a.toFrame??_;if(p!==u.frame&&(c=o.createKeyForFrame(p)),_!==f.frame&&(h=o.createKeyForFrame(_)),o._keys.length===1){const v=o._getKeyValue(o._keys[0]);d.referenceValue=v.clone?v.clone():v}else if(l<=u.frame){const v=o._getKeyValue(u.value);d.referenceValue=v.clone?v.clone():v}else if(l>=f.frame){const v=o._getKeyValue(f.value);d.referenceValue=v.clone?v.clone():v}else{ws.key=0;const v=o._interpolate(l,ws);d.referenceValue=v.clone?v.clone():v}o.dataType===me.ANIMATIONTYPE_QUATERNION?d.referenceValue.normalize().conjugateInPlace():o.dataType===me.ANIMATIONTYPE_MATRIX&&(d.referenceValue.decompose(d.referenceScaling,d.referenceQuaternion,d.referencePosition),d.referenceQuaternion.normalize().conjugateInPlace());let g=Number.MAX_VALUE;const E=a.clipKeys?[]:null;for(let v=c;v<=h;v++){let x=o._keys[v];if((E||a.cloneOriginalAnimation)&&(x={frame:x.frame,value:x.value.clone?x.value.clone():x.value,inTangent:x.inTangent,outTangent:x.outTangent,interpolation:x.interpolation,lockedTangent:x.lockedTangent},E&&(g===Number.MAX_VALUE&&(g=x.frame),x.frame-=g,E.push(x))),!(v&&o.dataType!==me.ANIMATIONTYPE_FLOAT&&x.value===u.value))switch(o.dataType){case me.ANIMATIONTYPE_MATRIX:x.value.decompose(d.keyScaling,d.keyQuaternion,d.keyPosition),d.keyPosition.subtractInPlace(d.referencePosition),d.keyScaling.divideInPlace(d.referenceScaling),d.referenceQuaternion.multiplyToRef(d.keyQuaternion,d.keyQuaternion),O.ComposeToRef(d.keyScaling,d.keyQuaternion,d.keyPosition,x.value);break;case me.ANIMATIONTYPE_QUATERNION:d.referenceValue.multiplyToRef(x.value,x.value);break;case me.ANIMATIONTYPE_VECTOR2:case me.ANIMATIONTYPE_VECTOR3:case me.ANIMATIONTYPE_COLOR3:case me.ANIMATIONTYPE_COLOR4:x.value.subtractToRef(d.referenceValue,x.value);break;case me.ANIMATIONTYPE_SIZE:x.value.width-=d.referenceValue.width,x.value.height-=d.referenceValue.height;break;default:x.value-=d.referenceValue}}return E&&o.setKeys(E,!0),o}static TransitionTo(e,t,i,r,s,a,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;const c=s*(o/1e3);a.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(a);const u=r.beginAnimation(i,0,c,!1);return u.onAnimationEnd=l,u}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,s,a){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=s,this.enableBlending=a,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=s===void 0?me.ANIMATIONLOOPMODE_CYCLE:s,this.uniqueId=me._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new il(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const r=i.from,s=i.to;for(let a=this._keys.length-1;a>=0;a--)this._keys[a].frame>=r&&this._keys[a].frame<=s&&this._keys.splice(a,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return ar(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,s){return JS(e,t,i,r,s)}quaternionInterpolateFunction(e,t,i){return ce.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,r,s){return ce.Hermite(e,t,i,r,s).normalize()}vector3InterpolateFunction(e,t,i){return m.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,r,s){return m.Hermite(e,t,i,r,s)}vector2InterpolateFunction(e,t,i){return se.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,r,s){return se.Hermite(e,t,i,r,s)}sizeInterpolateFunction(e,t,i){return xs.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return fe.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,s){return fe.Hermite(e,t,i,r,s)}color4InterpolateFunction(e,t,i){return Be.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,s){return Be.Hermite(e,t,i,r,s)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return ws.key=0,this._interpolate(e,ws)}_interpolate(e,t,i=!1){if(t.loopMode===me.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const r=this._keys,s=r.length;let a=t.key;for(;a>=0&&e<r[a].frame;)--a;for(;a+1<=s-1&&e>=r[a+1].frame;)++a;if(t.key=a,a<0)return i?void 0:this._getKeyValue(r[0].value);if(a+1>s-1)return i?void 0:this._getKeyValue(r[s-1].value);const o=r[a],l=r[a+1];if(i&&(e===o.frame||e===l.frame))return;const c=this._getKeyValue(o.value),u=this._getKeyValue(l.value);if(o.interpolation===1)return l.frame>e?c:u;const h=o.outTangent!==void 0&&l.inTangent!==void 0,f=l.frame-o.frame;let d=(e-o.frame)/f;const p=o.easingFunction||this.getEasingFunction();switch(p!==null&&(d=p.ease(d)),this.dataType){case me.ANIMATIONTYPE_FLOAT:{const _=h?this.floatInterpolateFunctionWithTangents(c,o.outTangent*f,u,l.inTangent*f,d):this.floatInterpolateFunction(c,u,d);switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return _;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+_}break}case me.ANIMATIONTYPE_QUATERNION:{const _=h?this.quaternionInterpolateFunctionWithTangents(c,o.outTangent.scale(f),u,l.inTangent.scale(f),d):this.quaternionInterpolateFunction(c,u,d);switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return _;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return _.addInPlace((t.offsetValue||wC).scale(t.repeatCount))}return _}case me.ANIMATIONTYPE_VECTOR3:{const _=h?this.vector3InterpolateFunctionWithTangents(c,o.outTangent.scale(f),u,l.inTangent.scale(f),d):this.vector3InterpolateFunction(c,u,d);switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return _;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return _.add((t.offsetValue||BC).scale(t.repeatCount))}break}case me.ANIMATIONTYPE_VECTOR2:{const _=h?this.vector2InterpolateFunctionWithTangents(c,o.outTangent.scale(f),u,l.inTangent.scale(f),d):this.vector2InterpolateFunction(c,u,d);switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return _;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return _.add((t.offsetValue||VC).scale(t.repeatCount))}break}case me.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(c,u,d);case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(c,u,d).add((t.offsetValue||UC).scale(t.repeatCount))}break}case me.ANIMATIONTYPE_COLOR3:{const _=h?this.color3InterpolateFunctionWithTangents(c,o.outTangent.scale(f),u,l.inTangent.scale(f),d):this.color3InterpolateFunction(c,u,d);switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return _;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return _.add((t.offsetValue||kC).scale(t.repeatCount))}break}case me.ANIMATIONTYPE_COLOR4:{const _=h?this.color4InterpolateFunctionWithTangents(c,o.outTangent.scale(f),u,l.inTangent.scale(f),d):this.color4InterpolateFunction(c,u,d);switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return _;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return _.add((t.offsetValue||GC).scale(t.repeatCount))}break}case me.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case me.ANIMATIONLOOPMODE_CYCLE:case me.ANIMATIONLOOPMODE_CONSTANT:case me.ANIMATIONLOOPMODE_YOYO:return me.AllowMatricesInterpolation?this.matrixInterpolateFunction(c,u,d,t.workValue):c;case me.ANIMATIONLOOPMODE_RELATIVE:case me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return c}break}}return 0}matrixInterpolateFunction(e,t,i,r){return me.AllowMatrixDecomposeForInterpolation?r?(O.DecomposeLerpToRef(e,t,i,r),r):O.DecomposeLerp(e,t,i):r?(O.LerpToRef(e,t,i,r),r):O.Lerp(e,t,i)}clone(){const e=new me(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){ws.key=0;const t=this._interpolate(e,ws,!0);if(!t)return this._keys[ws.key].frame===e?ws.key:ws.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(ws.key+1,0,i),ws.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let r=0;r<i.length;r++){const s=i[r],a={};switch(a.frame=s.frame,t){case me.ANIMATIONTYPE_FLOAT:a.values=[s.value],s.inTangent!==void 0&&a.values.push(s.inTangent),s.outTangent!==void 0&&(s.inTangent===void 0&&a.values.push(void 0),a.values.push(s.outTangent)),s.interpolation!==void 0&&(s.inTangent===void 0&&a.values.push(void 0),s.outTangent===void 0&&a.values.push(void 0),a.values.push(s.interpolation));break;case me.ANIMATIONTYPE_QUATERNION:case me.ANIMATIONTYPE_MATRIX:case me.ANIMATIONTYPE_VECTOR3:case me.ANIMATIONTYPE_COLOR3:case me.ANIMATIONTYPE_COLOR4:a.values=s.value.asArray(),s.inTangent!=null&&a.values.push(s.inTangent.asArray()),s.outTangent!=null&&(s.inTangent===void 0&&a.values.push(void 0),a.values.push(s.outTangent.asArray())),s.interpolation!==void 0&&(s.inTangent===void 0&&a.values.push(void 0),s.outTangent===void 0&&a.values.push(void 0),a.values.push(s.interpolation));break}e.keys.push(a)}e.ranges=[];for(const r in this._ranges){const s=this._ranges[r];if(!s)continue;const a={};a.name=r,a.from=s.from,a.to=s.to,e.ranges.push(a)}return e}static _UniversalLerp(e,t,i){const r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new me(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[];let s,a;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),a=0;a<e.keys.length;a++){const o=e.keys[a];let l,c,u;switch(i){case me.ANIMATIONTYPE_FLOAT:s=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(c=o.values[2]),o.values.length>=4&&(u=o.values[3]);break;case me.ANIMATIONTYPE_QUATERNION:if(s=ce.FromArray(o.values),o.values.length>=8){const f=ce.FromArray(o.values.slice(4,8));f.equals(ce.Zero())||(l=f)}if(o.values.length>=12){const f=ce.FromArray(o.values.slice(8,12));f.equals(ce.Zero())||(c=f)}o.values.length>=13&&(u=o.values[12]);break;case me.ANIMATIONTYPE_MATRIX:s=O.FromArray(o.values),o.values.length>=17&&(u=o.values[16]);break;case me.ANIMATIONTYPE_COLOR3:s=fe.FromArray(o.values),o.values[3]&&(l=fe.FromArray(o.values[3])),o.values[4]&&(c=fe.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break;case me.ANIMATIONTYPE_COLOR4:s=Be.FromArray(o.values),o.values[4]&&(l=Be.FromArray(o.values[4])),o.values[5]&&(c=Be.FromArray(o.values[5])),o.values[6]&&(u=Be.FromArray(o.values[6]));break;case me.ANIMATIONTYPE_VECTOR3:default:s=m.FromArray(o.values),o.values[3]&&(l=m.FromArray(o.values[3])),o.values[4]&&(c=m.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break}const h={};h.frame=o.frame,h.value=s,l!=null&&(h.inTangent=l),c!=null&&(h.outTangent=c),u!=null&&(h.interpolation=u),r.push(h)}if(t.setKeys(r),e.ranges)for(a=0;a<e.ranges.length;a++)s=e.ranges[a],t.createRange(s.name,s.from,s.to);return t}static AppendSerializedAnimations(e,t){Ke.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,r)=>{const s=new Gi;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let a=JSON.parse(s.responseText);if(a.animations&&(a=a.animations),a.length){const o=[];for(const l of a)o.push(this.Parse(l));i(o)}else{const o=this.Parse(a);e&&(o.name=e),i(o)}}else r("Unable to load the animation")}),s.open("GET",t),s.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const r=new Gi;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){const s=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(s.animations){const a=JSON.parse(s.animations),o=[];for(const l of a.animations){const c=this.Parse(l);c.snippetId=e,o.push(c)}t(o)}else{const a=JSON.parse(s.animation),o=this.Parse(a);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}}me._UniqueIdGenerator=0;me.AllowMatricesInterpolation=!1;me.AllowMatrixDecomposeForInterpolation=!0;me.SnippetUrl="https://snippet.babylonjs.com";me.ANIMATIONTYPE_FLOAT=0;me.ANIMATIONTYPE_VECTOR3=1;me.ANIMATIONTYPE_QUATERNION=2;me.ANIMATIONTYPE_MATRIX=3;me.ANIMATIONTYPE_COLOR3=4;me.ANIMATIONTYPE_COLOR4=7;me.ANIMATIONTYPE_VECTOR2=5;me.ANIMATIONTYPE_SIZE=6;me.ANIMATIONLOOPMODE_RELATIVE=0;me.ANIMATIONLOOPMODE_CYCLE=1;me.ANIMATIONLOOPMODE_CONSTANT=2;me.ANIMATIONLOOPMODE_YOYO=4;me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5;me.CreateFromSnippetAsync=me.ParseFromSnippetAsync;$("BABYLON.Animation",me);Lt._AnimationRangeFactory=(n,e,t)=>new il(n,e,t);class ui extends Lt{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,s=null,a=null,o=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=(r==null?void 0:r.clone())??O.Identity(),this._restMatrix=s??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new O,this._absoluteBindMatrix=new O,this._absoluteInverseBindMatrix=new O,this._finalMatrix=new O,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const e=B.Vector3[0],t=B.Quaternion[0],i=B.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??ce.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=m.Zero(),this._localRotation=ce.Zero(),this._localPosition=m.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,O.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,r=!0){const s=this.getLocalMatrix();if(t==0)r?(s.addAtIndex(12,e.x),s.addAtIndex(13,e.y),s.addAtIndex(14,e.z)):s.setTranslationFromFloats(e.x,e.y,e.z);else{let a=null;i&&(a=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const o=ui._TmpMats[0],l=ui._TmpVecs[0];this.parent?i&&a?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(a,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):O.IdentityToRef(o),r&&o.setTranslationFromFloats(0,0,0),o.invert(),m.TransformCoordinatesToRef(e,o,l),r?(s.addAtIndex(12,l.x),s.addAtIndex(13,l.y),s.addAtIndex(14,l.z)):s.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,r=!1){const s=this.getLocalMatrix(),a=ui._TmpMats[0];O.ScalingToRef(e,t,i,a),a.multiplyToRef(s,s),a.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(const o of this.children)o.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=0,s){if(r===0){const l=ui._TmpQuat;ce.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,s);return}const a=ui._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,s))return;const o=ui._TmpMats[1];O.RotationYawPitchRollToRef(e,t,i,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,r,s)}rotate(e,t,i=0,r){const s=ui._TmpMats[0];s.setTranslationFromFloats(0,0,0),O.RotationAxisToRef(e,t,s),this._rotateWithMatrix(s,i,r)}setAxisAngle(e,t,i=0,r){if(i===0){const o=ui._TmpQuat;ce.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,r);return}const s=ui._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,r))return;const a=ui._TmpMats[1];O.RotationAxisToRef(e,t,a),s.multiplyToRef(a,a),this._rotateWithMatrix(a,i,r)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(t===0){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const r=ui._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;const s=ui._TmpMats[1];O.FromQuaternionToRef(e,s),r.multiplyToRef(s,s),this._rotateWithMatrix(s,t,i)}setRotationMatrix(e,t=0,i){if(t===0){const a=ui._TmpQuat;ce.FromRotationMatrixToRef(e,a),this.setRotationQuaternion(a,t,i);return}const r=ui._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;const s=ui._TmpMats[1];s.copyFrom(e),r.multiplyToRef(e,s),this._rotateWithMatrix(s,t,i)}_rotateWithMatrix(e,t=0,i){const r=this.getLocalMatrix(),s=r.m[12],a=r.m[13],o=r.m[14],l=this.getParent(),c=ui._TmpMats[3],u=ui._TmpMats[4];l&&t==1?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),u.copyFrom(c),u.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):t==1&&i?(c.copyFrom(i.getWorldMatrix()),u.copyFrom(c),u.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(s,a,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=ui._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),O.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):O.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){const i=m.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(e==0){const r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=ui._TmpMats[0];t&&r?(s.copyFrom(this.getAbsoluteMatrix()),s.multiplyToRef(r,s)):s=this.getAbsoluteMatrix(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=m.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=m.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=ui._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),m.TransformNormalToRef(e,s,i),i.normalize()}getRotation(e=0,t=null){const i=m.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){const r=ui._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){const i=ce.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(e==0)this._decompose(),i.copyFrom(this._localRotation);else{const r=ui._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){const i=O.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(e==0)this.getLocalMatrix().getRotationMatrixToRef(i);else{const r=ui._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(s),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=m.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=ui._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),m.TransformCoordinatesToRef(e,s,i)}getLocalPositionFromAbsolute(e,t=null){const i=m.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const s=ui._TmpMats[0];s.copyFrom(this.getAbsoluteMatrix()),t&&r&&s.multiplyToRef(r,s),s.invert(),m.TransformCoordinatesToRef(e,s,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}ui._TmpVecs=ms(2,m.Zero);ui._TmpQuat=ce.Identity();ui._TmpMats=ms(5,O.Identity);class tw{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===me.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=O.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(const o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const s=t.getEvents();s&&s.length>0&&s.forEach(a=>{this._events.push(a._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let s=0;s<i.length-1;s++){const a=i[s];if(r=r[a],r===void 0)throw new Error(`Invalid property (${a}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(this._activeTargets[t][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getLocalMatrix&&this._targetPath==="_matrix"?t=i.getLocalMatrix():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){const i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,r,s){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?me.AllowMatrixDecomposeForInterpolation?this._currentValue?O.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=O.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?O.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=O.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=me._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const a=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._registerTargetForLateAnimationBinding(this,this._originalValue[s]):this._animationState.loopMode===me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[s],t[this._targetPath]):t[this._targetPath]=this._originalValue[s]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){const i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);const r=this._events;if(r.length)for(let a=0;a<r.length;a++)r[a].onlyOnce||(r[a].isDone=r[a].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,t)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,s,a=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const u=i-t;let h,f=e*(o.framePerSecond*s)/1e3+this._absoluteFrameOffset,d=0,p=!1;const _=r&&this._animationState.loopMode===me.ANIMATIONLOOPMODE_YOYO;if(_){const x=(f-t)/u,A=Math.sin(x*Math.PI);f=Math.abs(A)*u+t;const C=A>=0?1:-1;this._yoyoDirection!==C&&(p=!0),this._yoyoDirection=C}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=f,!r&&i>=t&&(f>=u&&s>0||f<=0&&s<0))c=!1,d=o._getKeyValue(this._maxValue);else if(!r&&t>=i&&(f<=u&&s<0||f>=0&&s>0))c=!1,d=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==me.ANIMATIONLOOPMODE_CYCLE){const x=i.toString()+t.toString();if(!this._offsetsCache[x]){this._animationState.repeatCount=0,this._animationState.loopMode=me.ANIMATIONLOOPMODE_CYCLE;const A=o._interpolate(t,this._animationState),T=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case me.ANIMATIONTYPE_FLOAT:this._offsetsCache[x]=T-A;break;case me.ANIMATIONTYPE_QUATERNION:this._offsetsCache[x]=T.subtract(A);break;case me.ANIMATIONTYPE_VECTOR3:this._offsetsCache[x]=T.subtract(A);break;case me.ANIMATIONTYPE_VECTOR2:this._offsetsCache[x]=T.subtract(A);break;case me.ANIMATIONTYPE_SIZE:this._offsetsCache[x]=T.subtract(A);break;case me.ANIMATIONTYPE_COLOR3:this._offsetsCache[x]=T.subtract(A);break}this._highLimitsCache[x]=T}d=this._highLimitsCache[x],h=this._offsetsCache[x]}if(h===void 0)switch(o.dataType){case me.ANIMATIONTYPE_FLOAT:h=0;break;case me.ANIMATIONTYPE_QUATERNION:h=wC;break;case me.ANIMATIONTYPE_VECTOR3:h=BC;break;case me.ANIMATIONTYPE_VECTOR2:h=VC;break;case me.ANIMATIONTYPE_SIZE:h=UC;break;case me.ANIMATIONTYPE_COLOR3:h=kC;break;case me.ANIMATIONTYPE_COLOR4:h=GC;break}let g;if(this._host&&this._host.syncRoot){const x=this._host.syncRoot,A=(x.masterFrame-x.fromFrame)/(x.toFrame-x.fromFrame);g=t+u*A}else f>0&&t>i||f<0&&t<i?g=c&&u!==0?i+f%u:t:g=c&&u!==0?t+f%u:i;const E=this._events;if(!_&&(s>0&&this.currentFrame>g||s<0&&this.currentFrame<g)||_&&p){this._onLoop();for(let x=0;x<E.length;x++)E[x].onlyOnce||(E[x].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=g,this._animationState.repeatCount=u===0?0:f/u>>0,this._animationState.highLimitValue=d,this._animationState.offsetValue=h;const v=o._interpolate(g,this._animationState);if(this.setValue(v,a),E.length){for(let x=0;x<E.length;x++)if(u>=0&&g>=E[x].frame&&E[x].frame>=t||u<0&&g<=E[x].frame&&E[x].frame<=t){const A=E[x];A.isDone||(A.onlyOnce&&(E.splice(x,1),x--),A.isDone=!0,A.action(g))}}return c||(this._stopped=!0),c}}class RE{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,s=!1,a=1,o,l,c,u=!1,h=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=u,this.playOrder=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new Q,this.onAnimationLoopObservable=new Q,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const r=t[i],s=new tw(e,r,this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){const i=this._runtimeAnimations;if(i[0]){const r=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;const s=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/r*1e3/this.speedRatio;this._manualJumpDelay=-s}for(let r=0;r<i.length;r++)i[r].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const a=this._runtimeAnimations;for(let o=a.length-1;o>=0;o--){const l=a[o];e&&l.animation.name!=e||t&&!t(l.target)||(l.dispose(),a.splice(o,1))}a.length==0&&(i||this._scene._activeAnimatables.splice(s,1),r||this._raiseOnAnimationEnd())}}else{const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){i||this._scene._activeAnimatables.splice(s,1);const a=this._runtimeAnimations;for(let o=0;o<a.length;o++)a[o].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let r;for(r=0;r<i.length;r++){const a=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||a}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}function iw(n){if(n.totalWeight===0&&n.totalAdditiveWeight===0)return n.originalValue;let e=1;const t=B.Vector3[0],i=B.Vector3[1],r=B.Quaternion[0];let s=0;const a=n.animations[0],o=n.originalValue;let l=1,c=!1;if(n.totalWeight<1)l=1-n.totalWeight,o.decompose(i,r,t);else{if(s=1,e=n.totalWeight,l=a.weight/e,l==1)if(n.totalAdditiveWeight)c=!0;else return a.currentValue;a.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let h=s;h<n.animations.length;h++){const f=n.animations[h];if(f.weight===0)continue;l=f.weight/e;const d=B.Vector3[2],p=B.Vector3[3],_=B.Quaternion[1];f.currentValue.decompose(p,_,d),p.scaleAndAddToRef(l,i),_.scaleAndAddToRef(ce.Dot(r,_)>0?l:-l,r),d.scaleAndAddToRef(l,t)}r.normalize()}for(let h=0;h<n.additiveAnimations.length;h++){const f=n.additiveAnimations[h];if(f.weight===0)continue;const d=B.Vector3[2],p=B.Vector3[3],_=B.Quaternion[1];f.currentValue.decompose(p,_,d),p.multiplyToRef(i,p),m.LerpToRef(i,p,f.weight,i),r.multiplyToRef(_,_),ce.SlerpToRef(r,_,f.weight,r),d.scaleAndAddToRef(f.weight,t)}const u=a?a._animationState.workValue:B.Matrix[0].clone();return O.ComposeToRef(i,r,t,u),u}function rw(n,e){if(n.totalWeight===0&&n.totalAdditiveWeight===0)return e;const t=n.animations[0],i=n.originalValue;let r=e;if(n.totalWeight===0&&n.totalAdditiveWeight>0)r.copyFrom(i);else if(n.animations.length===1){if(ce.SlerpToRef(i,t.currentValue,Math.min(1,n.totalWeight),r),n.totalAdditiveWeight===0)return r}else if(n.animations.length>1){let s=1,a,o;if(n.totalWeight<1){const c=1-n.totalWeight;a=[],o=[],a.push(i),o.push(c)}else{if(n.animations.length===2&&(ce.SlerpToRef(n.animations[0].currentValue,n.animations[1].currentValue,n.animations[1].weight/n.totalWeight,e),n.totalAdditiveWeight===0))return e;a=[],o=[],s=n.totalWeight}for(let c=0;c<n.animations.length;c++){const u=n.animations[c];a.push(u.currentValue),o.push(u.weight/s)}let l=0;for(let c=0;c<a.length;){if(!c){ce.SlerpToRef(a[c],a[c+1],o[c+1]/(o[c]+o[c+1]),e),r=e,l=o[c]+o[c+1],c+=2;continue}l+=o[c],ce.SlerpToRef(r,a[c],o[c]/l,r),c++}}for(let s=0;s<n.additiveAnimations.length;s++){const a=n.additiveAnimations[s];a.weight!==0&&(r.multiplyToRef(a.currentValue,B.Quaternion[0]),ce.SlerpToRef(r,B.Quaternion[0],a.weight,r))}return r}function sw(n){if(n._registeredForLateAnimationBindings.length){for(let e=0;e<n._registeredForLateAnimationBindings.length;e++){const t=n._registeredForLateAnimationBindings.data[e];for(const i in t._lateAnimationHolders){const r=t._lateAnimationHolders[i],s=r.animations[0],a=r.originalValue;if(a==null)continue;const o=me.AllowMatrixDecomposeForInterpolation&&a.m;let l=t[i];if(o)l=iw(r);else if(a.w!==void 0)l=rw(r,l||ce.Identity());else{let u=0,h=1;const f=s&&s._animationState.loopMode===me.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(r.totalWeight<1)f?l=a.clone?a.clone():a:s&&a.scale?l=a.scale(1-r.totalWeight):s?l=a*(1-r.totalWeight):a.clone?l=a.clone():l=a;else if(s){h=r.totalWeight;const d=s.weight/h;d!==1?s.currentValue.scale?l=s.currentValue.scale(d):l=s.currentValue*d:l=s.currentValue,f&&(l.addToRef?l.addToRef(a,l):l+=a),u=1}for(let d=u;d<r.animations.length;d++){const p=r.animations[d],_=p.weight/h;if(_)p.currentValue.scaleAndAddToRef?p.currentValue.scaleAndAddToRef(_,l):l+=p.currentValue*_;else continue}for(let d=0;d<r.additiveAnimations.length;d++){const p=r.additiveAnimations[d],_=p.weight;if(_)p.currentValue.scaleAndAddToRef?p.currentValue.scaleAndAddToRef(_,l):l+=p.currentValue*_;else continue}}t[i]=l}t._lateAnimationHolders={}}n._registeredForLateAnimationBindings.reset()}}function nw(n,e){e&&(e.prototype.copyAnimationRange=function(t,i,r,s=!1,a=null){this.animations.length===0&&(this.animations.push(new me(this.name,"_matrix",t.animations[0].framePerSecond,me.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const o=t.animations[0].getRange(i);if(!o)return!1;const l=o.from,c=o.to,u=t.animations[0].getKeys(),h=t.length,f=t.getParent(),d=this.getParent(),p=s&&f&&h&&this.length&&h!==this.length,_=p&&d&&f?d.length/f.length:1,g=s&&!d&&a&&(a.x!==1||a.y!==1||a.z!==1),E=this.animations[0].getKeys();let v,x,A;for(let T=0,C=u.length;T<C;T++)v=u[T],v.frame>=l&&v.frame<=c&&(s?(A=v.value.clone(),p?(x=A.getTranslation(),A.setTranslation(x.scaleInPlace(_))):g&&a?(x=A.getTranslation(),A.setTranslation(x.multiplyInPlace(a))):A=v.value):A=v.value,E.push({frame:v.frame+r,value:A}));return this.animations[0].createRange(i,l+r,c+r),!0}),n&&(n.prototype._animate=function(t){if(!this.animationsEnabled)return;const i=Tr.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=i}this.deltaTime=t!==void 0?t:this.useConstantAnimationDeltaTime?16:(i-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=i;const r=this._activeAnimatables;if(r.length===0)return;this._animationTime+=this.deltaTime;const s=this._animationTime;for(let a=0;a<r.length;a++){const o=r[a];!o._animate(s)&&o.disposeOnEnd&&a--}sw(this)},n.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((t,i)=>t.playOrder-i.playOrder)},n.prototype.beginWeightedAnimation=function(t,i,r,s=1,a,o=1,l,c,u,h,f=!1){const d=this.beginAnimation(t,i,r,a,o,l,c,!1,u,h,f);return d.weight=s,d},n.prototype.beginAnimation=function(t,i,r,s,a=1,o,l,c=!0,u,h,f=!1){if(a<0){const p=i;i=r,r=p,a=-a}i>r&&(a=-a),c&&this.stopAnimation(t,void 0,u),l||(l=new RE(this,t,i,r,s,a,o,void 0,h,f));const d=u?u(t):!0;if(t.animations&&d&&l.appendAnimations(t,t.animations),t.getAnimatables){const p=t.getAnimatables();for(let _=0;_<p.length;_++)this.beginAnimation(p[_],i,r,s,a,o,l,c,u,h)}return l.reset(),l},n.prototype.beginHierarchyAnimation=function(t,i,r,s,a,o=1,l,c,u=!0,h,f,d=!1){const p=t.getDescendants(i),_=[];_.push(this.beginAnimation(t,r,s,a,o,l,c,u,h,void 0,d));for(const g of p)_.push(this.beginAnimation(g,r,s,a,o,l,c,u,h,void 0,d));return _},n.prototype.beginDirectAnimation=function(t,i,r,s,a,o=1,l,c,u=!1){if(o<0){const f=r;r=s,s=f,o=-o}return r>s&&(o=-o),new RE(this,t,r,s,a,o,l,i,c,u)},n.prototype.beginDirectHierarchyAnimation=function(t,i,r,s,a,o,l,c,u,h=!1){const f=t.getDescendants(i),d=[];d.push(this.beginDirectAnimation(t,r,s,a,o,l,c,u,h));for(const p of f)d.push(this.beginDirectAnimation(p,r,s,a,o,l,c,u,h));return d},n.prototype.getAnimatableByTarget=function(t){for(let i=0;i<this._activeAnimatables.length;i++)if(this._activeAnimatables[i].target===t)return this._activeAnimatables[i];return null},n.prototype.getAllAnimatablesByTarget=function(t){const i=[];for(let r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].target===t&&i.push(this._activeAnimatables[r]);return i},n.prototype.stopAnimation=function(t,i,r){const s=this.getAllAnimatablesByTarget(t);for(const a of s)a.stop(i,r)},n.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const t of this.animationGroups)t.stop()})}nw(ht,ui);class zC{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class Js{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(!this.mask&&!e){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let t=0;t<this._animatables.length;++t){const i=this._animatables[t];!this.mask||this.mask.disabled||this.mask.retainsTarget(i.target.name)?(this._numActiveAnimatables++,i.paused&&i.restart()):i.paused||i.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.fromFrame=this._from}}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.toFrame=this._to}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;const i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,r){if(e.length===0)return null;r=r??e[0].weight;let s=Number.MAX_VALUE,a=-Number.MAX_VALUE;if(i)for(const l of e)l.from<s&&(s=l.from),l.to>a&&(a=l.to);const o=new Js(e[0].name+"_merged",e[0]._scene,r);for(const l of e){i&&l.normalize(s,a);for(const c of l.targetedAnimations)o.addTargetedAnimation(c.animation,c.target);t&&l.dispose()}return o}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new Q,this.onAnimationLoopObservable=new Q,this.onAnimationGroupLoopObservable=new Q,this.onAnimationGroupEndObservable=new Q,this.onAnimationGroupPauseObservable=new Q,this.onAnimationGroupPlayObservable=new Q,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||$e.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new zC;i.animation=e,i.target=t;const r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._enableBlending!==null&&(e.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),a=s[0],o=s[s.length-1];if(a.frame>e){const l={frame:e,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};s.splice(0,0,l)}if(o.frame<t){const l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};s.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,s){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let a=0;a<this._targetedAnimations.length;a++){const o=this._targetedAnimations[a],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,s!==void 0?s:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,a),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;const t=this._animatables.slice();for(let r=0;r<t.length;r++)t[r].stop(void 0,void 0,!0,e);let i=0;for(let r=0;r<this._scene._activeAnimatables.length;r++){const s=this._scene._activeAnimatables[r];s._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=s:e&&this._checkAnimationGroupEnded(s,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e,t=!1){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(e,t);return this}getCurrentFrame(){var e;return((e=this.animatables[0])==null?void 0:e.masterFrame)||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){const i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),this._animatables.length===0&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const r=new Js(e||this.name,this._scene,this._weight,this._playOrder);r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask;for(const s of this._targetedAnimations)r.addTargetedAnimation(i?s.animation.clone():s.animation,t?t(s.target):s.target);return r}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return Pt&&Pt.HasTags(this)&&(e.tags=Pt.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new Js(e.name,t,e.weight,e.playOrder);for(let r=0;r<e.targetedAnimations.length;r++){const s=e.targetedAnimations[r],a=me.Parse(s.animation),o=s.targetId;if(s.animation.property==="influence"){const l=t.getMorphTargetById(o);l&&i.addTargetedAnimation(a,l)}else{const l=t.getNodeById(o);l!=null&&i.addTargetedAnimation(a,l)}}return Pt&&Pt.AddTagsTo(i,e.tags),e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),e.speedRatio!==void 0&&(i._speedRatio=e.speedRatio),e.loopAnimation!==void 0&&(i._loopAnimation=e.loopAnimation),e.isAdditive!==void 0&&(i._isAdditive=e.isAdditive),e.weight!==void 0&&(i._weight=e.weight),e.playOrder!==void 0&&(i._playOrder=e.playOrder),e.enableBlending!==void 0&&(i._enableBlending=e.enableBlending),e.blendingSpeed!==void 0&&(i._blendingSpeed=e.blendingSpeed),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,r=!1,s){let a;typeof t=="object"?a=t:a={referenceFrame:t,range:i,cloneOriginalAnimationGroup:r,clonedAnimationName:s};let o=e;a.cloneOriginalAnimationGroup&&(o=e.clone(a.clonedAnimationGroupName||o.name));const l=o.targetedAnimations;for(let c=0;c<l.length;c++){const u=l[c];u.animation=me.MakeAnimationAdditive(u.animation,a)}if(o.isAdditive=!0,a.clipKeys){let c=Number.MAX_VALUE,u=-Number.MAX_VALUE;const h=o.targetedAnimations;for(let f=0;f<h.length;f++){const _=h[f].animation.getKeys();c>_[0].frame&&(c=_[0].frame),u<_[_.length-1].frame&&(u=_[_.length-1].frame)}o._from=c,o._to=u}return o}static ClipKeys(e,t,i,r,s){const a=e.clone(r||e.name);return Js.ClipKeysInPlace(a,t,i,s)}static ClipKeysInPlace(e,t,i,r){return Js.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,s){const a=e.clone(r||e.name);return Js.ClipFramesInPlace(a,t,i,s)}static ClipFramesInPlace(e,t,i,r){return Js.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,s=!1){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE;const l=e.targetedAnimations;for(let c=0;c<l.length;c++){const u=l[c],h=r?u.animation:u.animation.clone();s&&(h.createKeyForFrame(t),h.createKeyForFrame(i));const f=h.getKeys(),d=[];let p=Number.MAX_VALUE;for(let _=0;_<f.length;_++){const g=f[_];if(!s&&_>=t&&_<=i||s&&g.frame>=t&&g.frame<=i){const E={frame:g.frame,value:g.value.clone?g.value.clone():g.value,inTangent:g.inTangent,outTangent:g.outTangent,interpolation:g.interpolation,lockedTangent:g.lockedTangent};p===Number.MAX_VALUE&&(p=E.frame),E.frame-=p,d.push(E)}}if(d.length===0){l.splice(c,1),c--;continue}a>d[0].frame&&(a=d[0].frame),o<d[d.length-1].frame&&(o=d[d.length-1].frame),h.setKeys(d,!0),u.animation=h}return e._from=a,e._to=o,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}const L5=Object.freeze(Object.defineProperty({__proto__:null,AnimationGroup:Js,TargetedAnimation:zC},Symbol.toStringTag,{value:"Module"}));class WC{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}class aw extends WC{}class ow{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class lw extends WC{constructor(e){super(),this._wasAddedToScene=!1,e=e||$e.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const o of e)t.set(o.uniqueId,o);const i={dependsOn:new Map,dependedBy:new Map};for(const o of e){const l=o.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const o of e){const l=o.uniqueId,c=i.dependsOn.get(l);if(o instanceof el){const h=o.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),i.dependedBy.get(h.uniqueId).add(l))}const u=i.dependedBy.get(l);for(const h of o.getDescendants()){const f=h.uniqueId;t.has(f)&&(u.add(f),i.dependsOn.get(f).add(l))}}const r=[],s=[];for(const o of e){const l=o.uniqueId;i.dependsOn.get(l).size===0&&(s.push(o),t.delete(l))}const a=s;for(;a.length>0;){const o=a.shift();r.push(o);const l=i.dependedBy.get(o.uniqueId);for(const c of Array.from(l.values())){const u=i.dependsOn.get(c);u.delete(o.uniqueId),u.size===0&&t.get(c)&&(a.push(t.get(c)),t.delete(c))}}return t.size>0&&(w.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(o=>w.Error(o.name))),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(const s of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,s,r)}}_isNodeInContainer(e){return e instanceof $t&&this.meshes.indexOf(e)!==-1||e instanceof ot&&this.transformNodes.indexOf(e)!==-1||e instanceof Tt&&this.lights.indexOf(e)!==-1||e instanceof He&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return w.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||J.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const r={},s={},a=new ow,o=[],l=[],c={doNotInstantiate:!0,...i},u=(_,g)=>{if(r[_.uniqueId]=g.uniqueId,s[g.uniqueId]=g,e&&(g.name=e(_.name)),g instanceof k){const E=g;if(E.morphTargetManager){const v=_.morphTargetManager;E.morphTargetManager=v.clone();for(let x=0;x<v.numTargets;x++){const A=v.getTarget(x),T=E.morphTargetManager.getTarget(x);r[A.uniqueId]=T.uniqueId,s[T.uniqueId]=T}}}},h=[],f=new Set;for(const _ of this.transformNodes)_.parent===null&&this._addNodeAndDescendantsToList(h,f,_,c.predicate);for(const _ of this.meshes)_.parent===null&&this._addNodeAndDescendantsToList(h,f,_,c.predicate);const d=this._topologicalSort(h),p=(_,g)=>{if(u(_,g),_.parent){const E=r[_.parent.uniqueId],v=s[E];v?g.parent=v:g.parent=_.parent}if(g.position&&_.position&&g.position.copyFrom(_.position),g.rotationQuaternion&&_.rotationQuaternion&&g.rotationQuaternion.copyFrom(_.rotationQuaternion),g.rotation&&_.rotation&&g.rotation.copyFrom(_.rotation),g.scaling&&_.scaling&&g.scaling.copyFrom(_.scaling),g.material){const E=g;if(E.material)if(t){const v=_.material;if(l.indexOf(v)===-1){let x=v.clone(e?e(v.name):"Clone of "+v.name);if(l.push(v),r[v.uniqueId]=x.uniqueId,s[x.uniqueId]=x,v.getClassName()==="MultiMaterial"){const A=v;for(const T of A.subMaterials)T&&(x=T.clone(e?e(T.name):"Clone of "+T.name),l.push(T),r[T.uniqueId]=x.uniqueId,s[x.uniqueId]=x);A.subMaterials=A.subMaterials.map(T=>T&&s[r[T.uniqueId]])}}E.getClassName()!=="InstancedMesh"&&(E.material=s[r[v.uniqueId]])}else E.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(E.material)===-1&&this.scene.addMultiMaterial(E.material):this.scene.materials.indexOf(E.material)===-1&&this.scene.addMaterial(E.material)}g.parent===null&&a.rootNodes.push(g)};return d.forEach(_=>{if(_.getClassName()==="InstancedMesh"){const g=_,E=g.sourceMesh,v=r[E.uniqueId],A=(typeof v=="number"?s[v]:E).createInstance(g.name);p(g,A)}else{let g=!0;_.getClassName()==="TransformNode"||_.getClassName()==="Node"||_.skeleton||!_.getTotalVertices||_.getTotalVertices()===0?g=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?g=!c.doNotInstantiate(_):g=!c.doNotInstantiate);const E=g?_.createInstance(`instance of ${_.name}`):_.clone(`Clone of ${_.name}`,null,!0);if(!E)throw new Error(`Could not clone or instantiate node on Asset Container ${_.name}`);p(_,E)}}),this.skeletons.forEach(_=>{if(c.predicate&&!c.predicate(_))return;const g=_.clone(e?e(_.name):"Clone of "+_.name);for(const E of this.meshes)if(E.skeleton===_&&!E.isAnInstance){const v=s[r[E.uniqueId]];if(!v||v.isAnInstance||(v.skeleton=g,o.indexOf(g)!==-1))continue;o.push(g);for(const x of g.bones)x._linkedTransformNode&&(x._linkedTransformNode=s[r[x._linkedTransformNode.uniqueId]])}a.skeletons.push(g)}),this.animationGroups.forEach(_=>{if(c.predicate&&!c.predicate(_))return;const g=_.clone(e?e(_.name):"Clone of "+_.name,E=>s[r[E.uniqueId]]||E);a.animationGroups.push(g)}),a}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||J.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach(i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))}),this.lights.forEach(i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))}),this.meshes.forEach(i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.addSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.addAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.addAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.addMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.addMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.addMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.addGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.addActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.addTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.addReflectionProbe(i)});for(const i of t)i.parent&&this.scene.getNodes().indexOf(i.parent)===-1&&(i.setParent?i.setParent(null):i.parent=null)}removeAllFromScene(){this._isValidHierarchy()||J.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t,!0)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(const r of e){let s=!0;if(i){for(const a of i)if(r===a){s=!1;break}}s&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new aw);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new k("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=$e.LastCreatedScene,t,i=null){if(!e)return w.Error("No scene available to merge animations to"),[];const r=i||(o=>{let l=null;const c=o.animations.length?o.animations[0].targetProperty:"",u=o.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(o.name)||e.getTransformNodeByName(u);break;case"influence":l=e.getMorphTargetByName(o.name)||e.getMorphTargetByName(u);break;default:l=e.getNodeByName(o.name)||e.getNodeByName(u)}return l});this.getNodes().forEach(o=>{const l=r(o);if(l!==null){for(const c of o.animations){const u=l.animations.filter(h=>h.targetProperty===c.targetProperty);for(const h of u){const f=l.animations.indexOf(h,0);f>-1&&l.animations.splice(f,1)}}l.animations=l.animations.concat(o.animations)}});const a=[];return this.animationGroups.slice().forEach(o=>{a.push(o.clone(o.name,r)),o.animatables.forEach(l=>{l.stop()})}),t.forEach(o=>{const l=r(o.target);l&&(e.beginAnimation(l,o.fromFrame,o.toFrame,o.loopAnimation,o.speedRatio,o.onAnimationEnd?o.onAnimationEnd:void 0,void 0,!0,void 0,o.onAnimationLoop?o.onAnimationLoop:void 0),e.stopAnimation(o.target))}),a}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.lights.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.cameras.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)})}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const r=t.pop();if(r instanceof k?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof ot?this.transformNodes.push(r):r instanceof Tt?this.lights.push(r):r instanceof He&&this.cameras.push(r),r instanceof $t){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(const s of r.material.getActiveTextures())this.textures.indexOf(s)===-1&&this.textures.push(s)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(const s of r.getChildren())i.has(s)||t.push(s);i.add(r)}this.populateRootNodes()}}class Ii{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new Q,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){return null}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const r=this._condition.serialize();return r.children.push(i),t&&t.children.push(r),r}return t&&t.children.push(i),i}}Ii._SerializeValueAsString=n=>typeof n=="number"?n.toString():typeof n=="boolean"?n?"true":"false":n instanceof se?n.x+", "+n.y:n instanceof m?n.x+", "+n.y+", "+n.z:n instanceof fe?n.r+", "+n.g+", "+n.b:n instanceof Be?n.r+", "+n.g+", "+n.b+", "+n.a:n;Ii._GetTargetProperty=n=>({name:"target",targetType:n._isMesh?"MeshProperties":n._isLight?"LightProperties":n._isCamera?"CameraProperties":n._isMaterial?"MaterialProperties":"SceneProperties",value:n._isScene?"Scene":n.name});$("BABYLON.Action",Ii);class nc{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class Qi extends nc{static get IsEqual(){return Qi._IsEqual}static get IsDifferent(){return Qi._IsDifferent}static get IsGreater(){return Qi._IsGreater}static get IsLesser(){return Qi._IsLesser}constructor(e,t,i,r,s=Qi.IsEqual){super(e),this.propertyPath=i,this.value=r,this.operator=s,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case Qi.IsGreater:return this._effectiveTarget[this._property]>this.value;case Qi.IsLesser:return this._effectiveTarget[this._property]<this.value;case Qi.IsEqual:case Qi.IsDifferent:{let e;return this.value.equals?e=this.value.equals(this._effectiveTarget[this._property]):e=this.value===this._effectiveTarget[this._property],this.operator===Qi.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[Ii._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ii._SerializeValueAsString(this.value)},{name:"operator",value:Qi.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case Qi._IsEqual:return"IsEqual";case Qi._IsDifferent:return"IsDifferent";case Qi._IsGreater:return"IsGreater";case Qi._IsLesser:return"IsLesser";default:return""}}}Qi._IsEqual=0;Qi._IsDifferent=1;Qi._IsGreater=2;Qi._IsLesser=3;class cw extends nc{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class uw extends nc{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[Ii._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}$("BABYLON.ValueCondition",Qi);$("BABYLON.PredicateCondition",cw);$("BABYLON.StateCondition",uw);class hw extends Ii{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[Ii._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class fw extends Ii{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[Ii._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class dw extends Ii{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[Ii._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ii._SerializeValueAsString(this.value)}]},e)}}class pw extends Ii{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&w.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[Ii._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Ii._SerializeValueAsString(this.value)}]},e)}}class _w extends Ii{constructor(e,t,i,r,s,a){super(e,a),this.from=i,this.to=r,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[Ii._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:Ii._SerializeValueAsString(this.loop)||!1}]},e)}}class mw extends Ii{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[Ii._GetTargetProperty(this._target)]},e)}}class HC extends Ii{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class gw extends Ii{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}}class Ew extends Ii{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class XC extends Ii{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=m.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[Ii._GetTargetProperty(this._target),Ii._GetTargetProperty(this._parent)]},e)}}$("BABYLON.SetParentAction",XC);$("BABYLON.ExecuteCodeAction",Ew);$("BABYLON.DoNothingAction",HC);$("BABYLON.StopAnimationAction",mw);$("BABYLON.PlayAnimationAction",_w);$("BABYLON.IncrementValueAction",pw);$("BABYLON.SetValueAction",dw);$("BABYLON.SetStateAction",fw);$("BABYLON.SetParentAction",XC);$("BABYLON.SwitchBooleanAction",hw);$("BABYLON.CombineAction",gw);class Gt extends cs{constructor(e){super(),e=e||$e.LastCreatedScene,e&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let i=0;i<this.actions.length;i++){const r=this.actions[i];Gt.Triggers[r.trigger]--,Gt.Triggers[r.trigger]===0&&delete Gt.Triggers[r.trigger]}this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1);const t=this._scene.meshes.filter(i=>i.actionManager===this);for(const i of t)i.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(e==r.trigger||t==r.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e)if(t){if(t(r.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=Gt.OnPickTrigger&&t.trigger<=Gt.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=Gt.OnPickTrigger&&t.trigger<=Gt.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===Gt.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(w.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,Gt.Triggers[e.trigger]?Gt.Triggers[e.trigger]++:Gt.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return t!==-1?(this.actions.splice(t,1),Gt.Triggers[e.trigger]-=1,Gt.Triggers[e.trigger]===0&&delete Gt.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const r=this.actions[i];if(r.trigger===e){if(t&&(e===Gt.OnKeyUpTrigger||e===Gt.OnKeyDownTrigger)){const s=r.getTriggerParameter();if(typeof s=="function"){if(!s(t))continue}else if(s&&s!==t.sourceEvent.keyCode){if(!s.toLowerCase)continue;const a=s.toLowerCase();if(a!==t.sourceEvent.key){const o=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(o).toLowerCase()!==a)continue}}}r._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let r=0;r<i.length-1;r++)e=e[i[r]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let i=0;i<this.actions.length;i++){const r={type:0,children:new Array,name:Gt.GetTriggerName(this.actions[i].trigger),properties:new Array},s=this.actions[i].triggerOptions;if(s&&typeof s!="number")if(s.parameter instanceof Node)r.properties.push(Ii._GetTargetProperty(s.parameter));else if(typeof s.parameter=="object"){const a={};cr.DeepCopy(s.parameter,a,["mesh"]),s.parameter&&s.parameter.mesh&&(a._meshId=s.parameter.mesh.id),r.properties.push({name:"parameter",targetType:null,value:a})}else r.properties.push({name:"parameter",targetType:null,value:s.parameter});this.actions[i].serialize(r),t.children.push(r)}return t}static Parse(e,t,i){const r=new Gt(i);t===null?i.actionManager=r:t.actionManager=r;const s=(l,c)=>{const u=Ai("BABYLON."+l);return u&&new u(...c)},a=(l,c,u,h)=>{if(h===null){const _=parseFloat(c);return c==="true"||c==="false"?c==="true":isNaN(_)?c:_}const f=h.split("."),d=c.split(",");for(let _=0;_<f.length;_++)u=u[f[_]];if(typeof u=="boolean")return d[0]==="true";if(typeof u=="string")return d[0];const p=[];for(let _=0;_<d.length;_++)p.push(parseFloat(d[_]));return u instanceof m?m.FromArray(p):u instanceof We?We.FromArray(p):u instanceof fe?fe.FromArray(p):u instanceof Be?Be.FromArray(p):parseFloat(d[0])},o=(l,c,u,h,f=null)=>{if(l.detached)return;const d=[];let p=null,_=null;const g=l.combine&&l.combine.length>0;if(l.type===2?d.push(r):d.push(c),g){const v=[];for(let x=0;x<l.combine.length;x++)o(l.combine[x],Gt.NothingTrigger,u,h,v);d.push(v)}else for(let v=0;v<l.properties.length;v++){let x=l.properties[v].value;const A=l.properties[v].name,T=l.properties[v].targetType;A==="target"?T==="SceneProperties"?x=p=i:T==="MaterialProperties"?x=p=i.getMaterialByName(x):x=p=i.getNodeByName(x):A==="parent"?x=i.getNodeByName(x):A==="sound"?i.getSoundByName&&(x=i.getSoundByName(x)):A!=="propertyPath"?l.type===2&&A==="operator"?x=Qi[x]:x=a(A,x,p,A==="value"?_:null):_=x,d.push(x)}if(f===null?d.push(u):d.push(null),l.name==="InterpolateValueAction"){const v=d[d.length-2];d[d.length-1]=v,d[d.length-2]=u}let E=s(l.name,d);if(E instanceof nc&&u!==null){const v=new HC(c,u);h?h.then(v):r.registerAction(v),h=v}f===null?E instanceof nc?(u=E,E=h):(u=null,h?h.then(E):r.registerAction(E)):f.push(E);for(let v=0;v<l.children.length;v++)o(l.children[v],c,u,E,null)};for(let l=0;l<e.children.length;l++){let c;const u=e.children[l];if(u.properties.length>0){const h=u.properties[0].value,f=u.properties[0].targetType===null?h:i.getMeshByName(h);f._meshId&&(f.mesh=i.getMeshById(f._meshId)),c={trigger:Gt[u.name],parameter:f}}else c=Gt[u.name];for(let h=0;h<u.children.length;h++)u.detached||o(u.children[h],c,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}Gt.NothingTrigger=0;Gt.OnPickTrigger=1;Gt.OnLeftPickTrigger=2;Gt.OnRightPickTrigger=3;Gt.OnCenterPickTrigger=4;Gt.OnPickDownTrigger=5;Gt.OnDoublePickTrigger=6;Gt.OnPickUpTrigger=7;Gt.OnPickOutTrigger=16;Gt.OnLongPressTrigger=8;Gt.OnPointerOverTrigger=9;Gt.OnPointerOutTrigger=10;Gt.OnEveryFrameTrigger=11;Gt.OnIntersectionEnterTrigger=12;Gt.OnIntersectionExitTrigger=13;Gt.OnKeyDownTrigger=14;Gt.OnKeyUpTrigger=15;class ki extends Z{constructor(e,t,i,r,s,a=!0,o=!1,l=3,c=0,u,h){super(null,s,!a,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,a,o,l,null,c,u??0,h??!1),this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}clone(){if(!this._texture)return super.clone();const e=new ki(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}static CreateLuminanceTexture(e,t,i,r,s=!0,a=!1,o=3){return new ki(e,t,i,1,r,s,a,o)}static CreateLuminanceAlphaTexture(e,t,i,r,s=!0,a=!1,o=3){return new ki(e,t,i,2,r,s,a,o)}static CreateAlphaTexture(e,t,i,r,s=!0,a=!1,o=3){return new ki(e,t,i,0,r,s,a,o)}static CreateRGBTexture(e,t,i,r,s=!0,a=!1,o=3,l=0,c=0,u=!1){return new ki(e,t,i,4,r,s,a,o,l,c,u)}static CreateRGBATexture(e,t,i,r,s=!0,a=!1,o=3,l=0,c=0,u=!1){return new ki(e,t,i,5,r,s,a,o,l,c,u)}static CreateRGBAStorageTexture(e,t,i,r,s=!0,a=!1,o=3,l=0,c=!1){return new ki(e,t,i,5,r,s,a,o,l,1,c)}static CreateRTexture(e,t,i,r,s=!0,a=!1,o=Z.TRILINEAR_SAMPLINGMODE,l=1){return new ki(e,t,i,6,r,s,a,o,l)}static CreateRStorageTexture(e,t,i,r,s=!0,a=!1,o=Z.TRILINEAR_SAMPLINGMODE,l=1){return new ki(e,t,i,6,r,s,a,o,l,1)}}class ac{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=O.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new Q,this.bones=[],this._scene=i||$e.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new il(e,t,i);for(let r=0,s=this.bones.length;r<s;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0;const s=this._getHighestAnimationFrame()+1,a={},o=e.bones;let l,c;for(c=0,l=o.length;c<l;c++)a[o[c].name]=o[c];this.bones.length!==o.length&&(w.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),r=!1);const u=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const f=this.bones[c].name,d=a[f];d?r=r&&this.bones[c].copyAnimationRange(d,t,s,i,u):(w.Warn("copyAnimationRange: not same rig, missing source bone "+f),r=!1)}const h=e.getAnimationRange(t);return h&&(this._ranges[t]=new il(t,h.from+s,h.to+s)),r}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){const s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){const r=e.getAnimationRange(i);if(!r)return null;const s=e._scene.getAllAnimatablesByTarget(e);let a=null;for(let l=0;l<s.length;l++){const c=s[l];if(c.fromFrame===(r==null?void 0:r.from)&&c.toFrame===(r==null?void 0:r.to)){a=c;break}}const o=e.getAnimatables();for(let l=0;l<o.length;l++){const u=o[l].animations;if(u)for(let h=0;h<u.length;h++)me.MakeAnimationAdditive(u[h],t,i)}return a&&(a.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const r=this.bones[i];r._childUpdateId++;const s=r.getParent();if(s?r.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){const a=r._index===null?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,a*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(const t of this.bones)if(t._linkedTransformNode){const i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const i=t.getPoseMatrix();let r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const s of this.bones)s.getParent()||(s.getBindMatrix().multiplyToRef(i,B.Matrix[1]),s._updateAbsoluteBindMatrices(B.Matrix[1]));if(this.isUsingTextureForMatrices){const s=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==s)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=ki.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=ki.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new ac(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let r=0;r<this.bones.length;r++){const s=this.bones[r];let a=null;const o=s.getParent();if(o){const c=this.bones.indexOf(o);a=i.bones[c]}const l=new ui(s.name,i,a,s.getBindMatrix().clone(),s.getRestMatrix().clone());l._index=s._index,s._linkedTransformNode&&l.linkTransformNode(s._linkedTransformNode),cr.DeepCopy(s.animations,l.animations)}if(this._ranges){i._ranges={};for(const r in this._ranges){const s=this._ranges[r];s&&(i._ranges[r]=s.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var t;const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const r=this.bones[i],s=r.getParent(),a={parentBoneIndex:s?this.bones.indexOf(s):-1,index:r.getIndex(),name:r.name,id:r.id,matrix:r.getBindMatrix().asArray(),rest:r.getRestMatrix().asArray(),linkedTransformNodeId:(t=r.getTransformNode())==null?void 0:t.id};e.bones.push(a),r.length&&(a.length=r.length),r.metadata&&(a.metadata=r.metadata),r.animations&&r.animations.length>0&&(a.animation=r.animations[0].serialize()),e.ranges=[];for(const o in this._ranges){const l=this._ranges[o];if(!l)continue;const c={};c.name=o,c.from=l.from,c.to=l.to,e.ranges.push(c)}}return e}static Parse(e,t){const i=new ac(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=m.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let r;for(r=0;r<e.bones.length;r++){const s=e.bones[r],a=e.bones[r].index;let o=null;s.parentBoneIndex>-1&&(o=i.bones[s.parentBoneIndex]);const l=s.rest?O.FromArray(s.rest):null,c=new ui(s.name,i,o,O.FromArray(s.matrix),l,null,a);s.id!==void 0&&s.id!==null&&(c.id=s.id),s.length&&(c.length=s.length),s.metadata&&(c.metadata=s.metadata),s.animation&&c.animations.push(me.Parse(s.animation)),s.linkedTransformNodeId!==void 0&&s.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){const s=e.ranges[r];i.createAnimationRange(s.name,s.from,s.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);const s=r.getParent();s&&this._sortBones(this.bones.indexOf(s),t,i),t.push(r)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}class Go{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new Q,this._onDataLayoutChanged=new Q,this._animationPropertiesOverride=null,this.id=e,this._scene=i||$e.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=Ke.Clone(()=>new Go(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),Ke.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new Go(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let r=0;r<e.animations.length;r++){const s=e.animations[r],a=Ai("BABYLON.Animation");a&&i.animations.push(a.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const r=new Go(t,i,e.getScene());return r.setPositions(e.getVerticesData(b.PositionKind)),e.isVerticesDataPresent(b.NormalKind)&&r.setNormals(e.getVerticesData(b.NormalKind)),e.isVerticesDataPresent(b.TangentKind)&&r.setTangents(e.getVerticesData(b.TangentKind)),e.isVerticesDataPresent(b.UVKind)&&r.setUVs(e.getVerticesData(b.UVKind)),r}}I([M()],Go.prototype,"id",void 0);class jp extends Z{get depth(){return this._depth}constructor(e,t,i,r,s,a,o=!0,l=!1,c=Z.TRILINEAR_SAMPLINGMODE,u=0,h){super(null,a,!o,l),this.format=s,this._texture=a.getEngine().createRawTexture2DArray(e,t,i,r,s,o,l,c,null,u,h),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,s,a=!0,o=!1,l=3,c=0){return new jp(e,t,i,r,5,s,a,o,l,c)}}class Un{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new pr(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=$e.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._syncActiveTargets(!0))}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return Un.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!((e=this._scene)!=null&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setInt("morphTargetCount",this.numInfluencers)}clone(){const e=new Un(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const r of this._targets){if(i++,r.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=Un.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(r),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=r.influence,this._supportsNormals=this._supportsNormals&&r.hasNormals,this._supportsTangents=this._supportsTangents&&r.hasTangents,this._supportsUVs=this._supportsUVs&&r.hasUVs;const s=r.getPositions();if(s){const a=s.length/3;if(this._vertexCount===0)this._vertexCount=a;else if(this._vertexCount!==a){w.Error("Incompatible target. Targets must all have the same vertices count.");return}}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(let r=0;r<t;r++)this._influences[r]=this._tempInfluences[r];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&(this._vertexCount||this.numMaxInfluencers>0)){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const i=this._targetStoreTexture.getSize();i.width===this._textureWidth&&i.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const i=this._targets.length,r=new Float32Array(i*this._textureWidth*this._textureHeight*4);let s=0;for(let a=0;a<i;a++){const o=this._targets[a],l=o.getPositions(),c=o.getNormals(),u=o.getUVs(),h=o.getTangents();if(!l){a===0&&w.Error("Invalid morph target. Target must have positions.");return}s=a*this._textureWidth*this._textureHeight*4;for(let f=0;f<this._vertexCount;f++)r[s]=l[f*3],r[s+1]=l[f*3+1],r[s+2]=l[f*3+2],s+=4,this._supportsNormals&&c&&(r[s]=c[f*3],r[s+1]=c[f*3+1],r[s+2]=c[f*3+2],s+=4),this._supportsUVs&&u&&(r[s]=u[f*2],r[s+1]=u[f*2+1],s+=4),this._supportsTangents&&h&&(r[s]=h[f*3],r[s+1]=h[f*3+1],r[s+2]=h[f*3+2],s+=4)}this._targetStoreTexture=jp.CreateRGBATexture(r,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new Un(t);for(const r of e.targets)i.addTarget(Go.Parse(r,t));return i}}Un.EnableTextureStorage=!0;Un.MaxActiveMorphTargetsInVertexAttributeMode=8;ht.prototype.removeReflectionProbe=function(n){if(!this.reflectionProbes)return-1;const e=this.reflectionProbes.indexOf(n);return e!==-1&&this.reflectionProbes.splice(e,1),e};ht.prototype.addReflectionProbe=function(n){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(n)};class yc{constructor(e,t,i,r=!0,s=!1,a=!1){if(this.name=e,this._viewMatrix=O.Identity(),this._target=m.Zero(),this._add=m.Zero(),this._invertYAxis=!1,this.position=m.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let u=0;u<6;++u)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${u}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let o=0;if(s){const u=this._scene.getEngine().getCaps();u.textureHalfFloatRender?o=2:u.textureFloatRender&&(o=1)}this._renderTargetTexture=new mr(e,t,i,r,!0,o,!0),this._renderTargetTexture.gammaSpace=!a,this._renderTargetTexture.invertZ=i.useRightHandedSystem;const l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(u=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[u]),i.getSceneUniformBuffer().unbindEffect()),u){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1);break}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const h=i.useRightHandedSystem?O.LookAtRHToRef:O.LookAtLHToRef,f=i.useRightHandedSystem?O.PerspectiveFovRH:O.PerspectiveFovLH;h(this.position,this._target,m.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=f(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position});let c;this._renderTargetTexture.onBeforeBindObservable.add(()=>{var u,h;this._currentSceneUBO=i.getSceneUniformBuffer(),(h=(u=i.getEngine())._debugPushGroup)==null||h.call(u,`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,a&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{var u,h;i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),(h=(u=i.getEngine())._debugPopGroup)==null||h.call(u,1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(e!==-1&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=Ke.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let s=0;s<t.reflectionProbes.length;s++){const a=t.reflectionProbes[s];if(a.name===e.name){r=a;break}}return r=Ke.Parse(()=>r||new yc(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}}I([eh()],yc.prototype,"_attachedMesh",void 0);I([Ar()],yc.prototype,"position",void 0);class vw{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,s){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=s,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}class qp extends vw{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new Q,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new Be(1,1,1,1),this.position=m.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,s=null){this._onAnimationEnd=s,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){const e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){const i=new qp(e.name,t);return i.position=m.FromArray(e.position),i.color=Be.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}ht.prototype._internalPickSprites=function(n,e,t,i){if(!es)return null;let r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){const a=this.spriteManagers[s];if(!a.isPickable)continue;const o=a.intersects(n,i,e,t);if(!(!o||!o.hit)&&!(!t&&r!=null&&o.distance>=r.distance)&&(r=o,t))break}return r||new es};ht.prototype._internalMultiPickSprites=function(n,e,t){if(!es)return null;let i=[];if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){const s=this.spriteManagers[r];if(!s.isPickable)continue;const a=s.multiIntersects(n,t,e);a!==null&&(i=i.concat(a))}return i};ht.prototype.pickSprite=function(n,e,t,i,r){if(!this._tempSpritePickingRay)return null;xh(this,n,e,this._tempSpritePickingRay,r);const s=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return s&&(s.ray=OC(this,n,e,r)),s};ht.prototype.pickSpriteWithRay=function(n,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}yt.TransformToRef(n,i.getViewMatrix(),this._tempSpritePickingRay);const r=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return r&&(r.ray=n),r};ht.prototype.multiPickSprite=function(n,e,t,i){return xh(this,n,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)};ht.prototype.multiPickSpriteWithRay=function(n,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return yt.TransformToRef(n,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)};ht.prototype.setPointerOverSprite=function(n){this._pointerOverSprite!==n&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,Ei.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=n,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,Ei.CreateNewFromSprite(this._pointerOverSprite,this)))};ht.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class Sw{constructor(e){this.name=we.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=yt?yt.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new Q,this.scene.onAfterSpritesRenderingObservable=new Q,this._spritePredicate=t=>t.actionManager?t.isPickable&&t.actionManager.hasPointerTriggers:!1}register(){this.scene._pointerMoveStage.registerStep(we.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(we.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(we.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();const e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,s){const a=this.scene.pickSprite(t,i,this._spritePredicate,r,s);return a&&(a.ray=e?e.ray:null),a}_pointerMove(e,t,i,r,s){const a=this.scene;return r?a.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,a.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite?(a.setPointerOverSprite(i.pickedSprite),!a.doNotHandleCursors&&s&&(a._pointerOverSprite&&a._pointerOverSprite.actionManager&&a._pointerOverSprite.actionManager.hoverCursor?s.style.cursor=a._pointerOverSprite.actionManager.hoverCursor:s.style.cursor=a.hoverCursor)):a.setPointerOverSprite(null)),i}_pointerDown(e,t,i,r){const s=this.scene;if(s._pickedDownSprite=null,s.spriteManagers&&s.spriteManagers.length>0&&(i=s.pickSprite(e,t,this._spritePredicate,!1,s.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager)){switch(s._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,Ei.CreateNewFromSprite(i.pickedSprite,s,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,Ei.CreateNewFromSprite(i.pickedSprite,s,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,Ei.CreateNewFromSprite(i.pickedSprite,s,r));break}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,Ei.CreateNewFromSprite(i.pickedSprite,s,r))}return i}_pointerUp(e,t,i,r,s){const a=this.scene;if(a.spriteManagers&&a.spriteManagers.length>0){const o=a.pickSprite(e,t,this._spritePredicate,!1,a.cameraToUseForPointers||void 0);o&&(o.hit&&o.pickedSprite&&o.pickedSprite.actionManager&&(o.pickedSprite.actionManager.processTrigger(7,Ei.CreateNewFromSprite(o.pickedSprite,a,r)),o.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||o.pickedSprite.actionManager.processTrigger(1,Ei.CreateNewFromSprite(o.pickedSprite,a,r)),s&&o.pickedSprite.actionManager.processTrigger(6,Ei.CreateNewFromSprite(o.pickedSprite,a,r)))),a._pickedDownSprite&&a._pickedDownSprite.actionManager&&a._pickedDownSprite!==o.pickedSprite&&a._pickedDownSprite.actionManager.processTrigger(16,Ei.CreateNewFromSprite(a._pickedDownSprite,a,r)))}return i}}class Ch{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){var i;const t=!!((i=this._scene)!=null&&i.getEngine().getCaps().fragmentDepthSupported);e&&!t&&w.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,r=null,s){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=(s==null?void 0:s.pixelPerfect)??!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=r,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new tr(e,this._vertexData,!0,this._vertexBufferSize);const a=this._buffer.createVertexBuffer(b.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),o=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let l=6,c;if(this._useInstancing){const d=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new tr(e,d,!1,2),c=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else c=this._buffer.createVertexBuffer("offsets",l,2,this._vertexBufferSize,this._useInstancing),l+=2;const u=this._buffer.createVertexBuffer("inverts",l,2,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("cellInfo",l+2,4,this._vertexBufferSize,this._useInstancing),f=this._buffer.createVertexBuffer(b.ColorKind,l+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[b.PositionKind]=a,this._vertexBuffers.options=o,this._vertexBuffers.offsets=c,this._vertexBuffers.inverts=u,this._vertexBuffers.cellInfo=h,this._vertexBuffers[b.ColorKind]=f,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!Ch.ForceGLSL?(this._shaderLanguage=1,await Promise.all([re(()=>import("./sprites.vertex-DWuL22xs.js"),[]),re(()=>import("./sprites.fragment-C12EQ442.js"),[])])):await Promise.all([re(()=>import("./sprites.vertex-CcsV6oEH.js"),[]),re(()=>import("./sprites.fragment-MJIlLiKX.js"),[])]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){var t,i;if(this._isDisposed||!this._shadersLoaded)return;(t=this._drawWrapperBase)==null||t.dispose(),(i=this._drawWrapperDepth)==null||i.dispose(),this._drawWrapperBase=new ds(this._engine),this._drawWrapperDepth=new ds(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+=`#define PIXEL_PERFECT
`),this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&this._fogEnabled&&(e+=`#define FOG
`),this._useLogarithmicDepth&&(e+=`#define LOGARITHMICDEPTH
`),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[b.PositionKind,"options","offsets","inverts","cellInfo",b.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,s=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!e.length)return;const a=this._drawWrapperBase,o=this._drawWrapperDepth,l=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0,c=a.effect;if(!c.isReady())return;const u=this._engine,h=!!(this._scene&&this._scene.useRightHandedSystem),f=Math.min(this._capacity,e.length);let d=0,p=!0;for(let v=0;v<f;v++){const x=e[v];if(!x||!x.isVisible)continue;p=!1,x._animate(t);const A=this.texture.getBaseSize();this._appendSpriteVertex(d++,x,0,0,A,h,s),this._useInstancing||(this._appendSpriteVertex(d++,x,1,0,A,h,s),this._appendSpriteVertex(d++,x,1,1,A,h,s),this._appendSpriteVertex(d++,x,0,1,A,h,s))}if(p)return;this._buffer.update(this._vertexData);const _=!!u.depthCullingState.cull,g=u.depthCullingState.zOffset,E=u.depthCullingState.zOffsetUnits;if(u.setState(_,g,!1,!1,void 0,void 0,E),u.enableEffect(a),c.setTexture("diffuseSampler",this.texture),c.setMatrix("view",i),c.setMatrix("projection",r),l){const v=this._scene;c.setFloat4("vFogInfos",v.fogMode,v.fogStart,v.fogEnd,v.fogDensity),c.setColor3("vFogColor",v.fogColor)}this.useLogarithmicDepth&&this._scene&&Qn(a.defines,c,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=u.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,c)),u.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):u.bindBuffers(this._vertexBuffers,this._indexBuffer,c),u.depthCullingState.depthFunc=u.useReverseDepthBuffer?518:515,this.disableDepthWrite||(c.setBool("alphaTest",!0),u.setColorWrite(!1),u.enableEffect(o),this._useInstancing?u.drawArraysType(7,0,4,d):u.drawElementsType(0,0,d/4*6),u.enableEffect(a),u.setColorWrite(!0),c.setBool("alphaTest",!1)),u.setAlphaMode(this.blendMode),this._useInstancing?u.drawArraysType(7,0,4,d):u.drawElementsType(0,0,d/4*6),this.autoResetAlpha&&u.setAlphaMode(0),h&&this._scene.getEngine().setState(_,g,!1,!0,void 0,void 0,E),u.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,s,a,o){let l=e*this._vertexBufferSize;if(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),o)o(t,s);else{t.cellIndex||(t.cellIndex=0);const c=s.width/this.cellWidth,u=t.cellIndex/c>>0;t._xOffset=(t.cellIndex-u*c)*this.cellWidth/s.width,t._yOffset=u*this.cellHeight/s.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x,this._vertexData[l+1]=t.position.y,this._vertexData[l+2]=t.position.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=i,this._vertexData[l+7]=r),a?this._vertexData[l+8]=t.invertU?0:1:this._vertexData[l+8]=t.invertU?1:0,this._vertexData[l+9]=t.invertV?1:0,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/s.width,this._vertexData[l+13]=t._ySize/s.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){var e;this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(const t in this._vertexBuffers)this._vertexBuffers[t]._rebuild();(e=this._spriteBuffer)==null||e._rebuild()}dispose(){var e,t;this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),(e=this._drawWrapperBase)==null||e.dispose(),(t=this._drawWrapperDepth)==null||t.dispose(),this._isDisposed=!0}}Ch.ForceGLSL=!1;class kn{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=Z.CLAMP_ADDRESSMODE,e.wrapV=Z.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&this.texture.samplingMode!==3&&this.texture.updateSamplingMode(3)}constructor(e,t,i,r,s,a=.01,o=Z.TRILINEAR_SAMPLINGMODE,l=!1,c=null,u){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new Q,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(f,d)=>{f.cellRef||(f.cellIndex=0);const p=f.cellIndex;typeof p=="number"&&isFinite(p)&&Math.floor(p)===p&&(f.cellRef=this._spriteMap[f.cellIndex]),f._xOffset=this._cellData[f.cellRef].frame.x/d.width,f._yOffset=this._cellData[f.cellRef].frame.y/d.height,f._xSize=this._cellData[f.cellRef].frame.w,f._ySize=this._cellData[f.cellRef].frame.h},s||(s=$e.LastCreatedScene),s._getComponent(we.NAME_SPRITE)||s._addComponent(new Sw(s)),this._fromPacked=l,this._scene=s;const h=this._scene.getEngine();if(this._spriteRenderer=new Ch(h,i,a,s,u==null?void 0:u.spriteRendererOptions),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(r!==void 0)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new Z(t,s,!0,!1,o)),this._fromPacked&&this._makePacked(t,c)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(t!==null)try{let i;if(typeof t=="string"?i=JSON.parse(t):i=t,i.frames.length){const s={};for(let a=0;a<i.frames.length;a++){const o=i.frames[a];if(typeof Object.keys(o)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");const l=o[Object.keys(o)[0]];s[l]=o}i.frames=s}const r=Reflect.ownKeys(i.frames);this._spriteMap=r,this._packedAndReady=!0,this._cellData=i.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{const i=/\./g;let r;do r=i.lastIndex,i.test(e);while(i.lastIndex>0);const s=e.substring(0,r-1)+".json",a=()=>{w.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},o=l=>{try{const c=JSON.parse(l),u=Reflect.ownKeys(c.frames);this._spriteMap=u,this._packedAndReady=!0,this._cellData=c.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};J.LoadFile(s,o,void 0,void 0,!1,a)}}_checkTextureAlpha(e,t,i,r,s){if(!e.useAlphaForPicking||!this.texture)return!0;const a=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(a.width*a.height*4),this.texture.readPixels(0,0,this._textureContent));const o=B.Vector3[0];o.copyFrom(t.direction),o.normalize(),o.scaleInPlace(i),o.addInPlace(t.origin);const l=(o.x-r.x)/(s.x-r.x),c=1-(o.y-r.y)/(s.y-r.y),u=e._xOffset*a.width+l*e._xSize|0,h=e._yOffset*a.height+c*e._ySize|0;return this._textureContent[(u+h*a.width)*4+3]>.5}intersects(e,t,i,r){const s=Math.min(this.capacity,this.sprites.length),a=m.Zero(),o=m.Zero();let l=Number.MAX_VALUE,c=null;const u=B.Vector3[0],h=B.Vector3[1],f=t.getViewMatrix();let d=e,p=e;for(let _=0;_<s;_++){const g=this.sprites[_];if(g){if(i){if(!i(g))continue}else if(!g.isPickable)continue;if(m.TransformCoordinatesToRef(g.position,f,h),g.angle?(O.TranslationToRef(-h.x,-h.y,0,B.Matrix[1]),O.TranslationToRef(h.x,h.y,0,B.Matrix[2]),O.RotationZToRef(-g.angle,B.Matrix[3]),B.Matrix[1].multiplyToRef(B.Matrix[3],B.Matrix[4]),B.Matrix[4].multiplyToRef(B.Matrix[2],B.Matrix[0]),d=e.clone(),m.TransformCoordinatesToRef(e.origin,B.Matrix[0],d.origin),m.TransformNormalToRef(e.direction,B.Matrix[0],d.direction)):d=e,a.copyFromFloats(h.x-g.width/2,h.y-g.height/2,h.z),o.copyFromFloats(h.x+g.width/2,h.y+g.height/2,h.z),d.intersectsBoxMinMax(a,o)){const E=m.Distance(h,d.origin);if(l>E){if(!this._checkTextureAlpha(g,d,E,a,o))continue;if(p=d,l=E,c=g,r)break}}}}if(c){const _=new es;f.invertToRef(B.Matrix[0]),_.hit=!0,_.pickedSprite=c,_.distance=l;const g=B.Vector3[2];return g.copyFrom(p.direction),g.normalize(),g.scaleInPlace(l),p.origin.addToRef(g,u),_.pickedPoint=m.TransformCoordinates(u,B.Matrix[0]),_}return null}multiIntersects(e,t,i){const r=Math.min(this.capacity,this.sprites.length),s=m.Zero(),a=m.Zero();let o;const l=[],c=B.Vector3[0].copyFromFloats(0,0,0),u=B.Vector3[1].copyFromFloats(0,0,0),h=t.getViewMatrix();for(let f=0;f<r;f++){const d=this.sprites[f];if(d){if(i){if(!i(d))continue}else if(!d.isPickable)continue;if(m.TransformCoordinatesToRef(d.position,h,u),s.copyFromFloats(u.x-d.width/2,u.y-d.height/2,u.z),a.copyFromFloats(u.x+d.width/2,u.y+d.height/2,u.z),e.intersectsBoxMinMax(s,a)){if(o=m.Distance(u,e.origin),!this._checkTextureAlpha(d,e,o,s,a))continue;const p=new es;l.push(p),h.invertToRef(B.Matrix[0]),p.hit=!0,p.pickedSprite=d,p.distance=o;const _=B.Vector3[2];_.copyFrom(e.direction),_.normalize(),_.scaleInPlace(o),e.origin.addToRef(_,c),p.pickedPoint=m.TransformCoordinates(c,B.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;const t=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){var e;(e=this._spriteRenderer)==null||e.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){const e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){const t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(const i of this.sprites)t.sprites.push(i.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){const r=new kn(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);e.fogEnabled!==void 0&&(r.fogEnabled=e.fogEnabled),e.blendMode!==void 0&&(r.blendMode=e.blendMode),e.disableDepthWrite!==void 0&&(r.disableDepthWrite=e.disableDepthWrite),e.pixelPerfect!==void 0&&(r.pixelPerfect=e.pixelPerfect),e.useLogarithmicDepth!==void 0&&(r.useLogarithmicDepth=e.useLogarithmicDepth),e.metadata!==void 0&&(r.metadata=e.metadata),e.texture?r.texture=Z.Parse(e.texture,t,i):e.textureName&&(r.texture=new Z(i+e.textureUrl,t,!1,e.invertY!==void 0?e.invertY:!0));for(const s of e.sprites)qp.Parse(s,r);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((s,a)=>{const o=new Gi;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){const l=JSON.parse(o.responseText),c=kn.Parse(l,i||$e.LastCreatedScene,r);e&&(c.name=e),s(c)}else a("Unable to load the sprite manager")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return e==="_BLANK"?Promise.resolve(new kn("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise((r,s)=>{const a=new Gi;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.spriteManager),c=kn.Parse(l,t||$e.LastCreatedScene,i);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}}kn.SnippetUrl="https://snippet.babylonjs.com";kn.CreateFromSnippetAsync=kn.ParseFromSnippetAsync;class du{}du.LoaderInjectedPhysicsEngine=void 0;let bo={},la={},zo={};const PE=(n,e,t,i)=>{if(!e.materials)return null;for(let r=0,s=e.materials.length;r<s;r++){const a=e.materials[r];if(n(a))return{parsedMaterial:a,material:pe.Parse(a,t,i)}}return null},Tw=(n,e,t)=>{for(const i in e)if(n.name===e[i])return t.push(n.id),!0;return n.parentId!==void 0&&t.indexOf(n.parentId)!==-1?(t.push(n.id),!0):!1},Mo=(n,e)=>n+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),YC=(n,e)=>{const t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){const i=e._waitingData.lods.ids,r=t.isEnabled(!1);if(e._waitingData.lods.distances){const s=e._waitingData.lods.distances;if(s.length>=i.length){const a=s.length>i.length?s[s.length-1]:0;t.setEnabled(!1);for(let o=0;o<i.length;o++){const l=i[o],c=n.getMeshById(l);c!=null&&t.addLODLevel(s[o],c)}a>0&&t.addLODLevel(a,null),r===!0&&t.setEnabled(!0)}else J.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},Zc=(n,e,t)=>{if(typeof n!="number"){const r=t.getLastEntryById(n);return r&&e!==void 0&&e!==null?r.instances[parseInt(e)]:r}const i=bo[n];return i&&e!==void 0&&e!==null?i.instances[parseInt(e)]:i},Nu=(n,e)=>typeof n!="number"?e.getLastMaterialById(n,!0):la[n],ME=(n,e,t,i,r=!1)=>{const s=new lw(n);let a="importScene has failed JSON parse";try{var o=JSON.parse(e);a="";const l=wi.loggingLevel===wi.DETAILED_LOGGING;let c,u;if(o.environmentTexture!==void 0&&o.environmentTexture!==null){const f=o.isPBR!==void 0?o.isPBR:!0;if(o.environmentTextureType&&o.environmentTextureType==="BABYLON.HDRCubeTexture"){const d=o.environmentTextureSize?o.environmentTextureSize:128,p=new ja((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,n,d,!0,!f,void 0,o.environmentTexturePrefilterOnLoad);o.environmentTextureRotationY&&(p.rotationY=o.environmentTextureRotationY),n.environmentTexture=p}else if(typeof o.environmentTexture=="object"){const d=ir.Parse(o.environmentTexture,n,t);n.environmentTexture=d}else if(o.environmentTexture.endsWith(".env")){const d=new ir((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,n,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(d.rotationY=o.environmentTextureRotationY),n.environmentTexture=d}else{const d=ir.CreateFromPrefilteredData((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,n,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(d.rotationY=o.environmentTextureRotationY),n.environmentTexture=d}if(o.createDefaultSkybox===!0){const d=n.activeCamera!==void 0&&n.activeCamera!==null?(n.activeCamera.maxZ-n.activeCamera.minZ)/2:1e3,p=o.skyboxBlurLevel||0;n.createDefaultSkybox(n.environmentTexture,f,d,p)}s.environmentTexture=n.environmentTexture}if(o.environmentIntensity!==void 0&&o.environmentIntensity!==null&&(n.environmentIntensity=o.environmentIntensity),o.lights!==void 0&&o.lights!==null)for(c=0,u=o.lights.length;c<u;c++){const f=o.lights[c],d=Tt.Parse(f,n);d&&(bo[f.uniqueId]=d,s.lights.push(d),d._parentContainer=s,a+=c===0?`
	Lights:`:"",a+=`
		`+d.toString(l))}if(o.reflectionProbes!==void 0&&o.reflectionProbes!==null)for(c=0,u=o.reflectionProbes.length;c<u;c++){const f=o.reflectionProbes[c],d=yc.Parse(f,n,t);d&&(s.reflectionProbes.push(d),d._parentContainer=s,a+=c===0?`
	Reflection Probes:`:"",a+=`
		`+d.toString(l))}if(o.animations!==void 0&&o.animations!==null)for(c=0,u=o.animations.length;c<u;c++){const f=o.animations[c],d=Ai("BABYLON.Animation");if(d){const p=d.Parse(f);n.animations.push(p),s.animations.push(p),a+=c===0?`
	Animations:`:"",a+=`
		`+p.toString(l)}}if(o.materials!==void 0&&o.materials!==null)for(c=0,u=o.materials.length;c<u;c++){const f=o.materials[c],d=pe.Parse(f,n,t);d&&(la[f.uniqueId||f.id]=d,s.materials.push(d),d._parentContainer=s,a+=c===0?`
	Materials:`:"",a+=`
		`+d.toString(l),d.getActiveTextures().forEach(_=>{s.textures.indexOf(_)==-1&&(s.textures.push(_),_._parentContainer=s)}))}if(o.multiMaterials!==void 0&&o.multiMaterials!==null)for(c=0,u=o.multiMaterials.length;c<u;c++){const f=o.multiMaterials[c],d=Yn.ParseMultiMaterial(f,n);la[f.uniqueId||f.id]=d,s.multiMaterials.push(d),d._parentContainer=s,a+=c===0?`
	MultiMaterials:`:"",a+=`
		`+d.toString(l),d.getActiveTextures().forEach(_=>{s.textures.indexOf(_)==-1&&(s.textures.push(_),_._parentContainer=s)})}if(o.morphTargetManagers!==void 0&&o.morphTargetManagers!==null)for(const f of o.morphTargetManagers){const d=Un.Parse(f,n);zo[f.id]=d,s.morphTargetManagers.push(d),d._parentContainer=s}if(o.skeletons!==void 0&&o.skeletons!==null)for(c=0,u=o.skeletons.length;c<u;c++){const f=o.skeletons[c],d=ac.Parse(f,n);s.skeletons.push(d),d._parentContainer=s,a+=c===0?`
	Skeletons:`:"",a+=`
		`+d.toString(l)}const h=o.geometries;if(h!=null){const f=new Array,d=h.vertexData;if(d!=null)for(c=0,u=d.length;c<u;c++){const p=d[c];f.push(dr.Parse(p,n,t))}f.forEach(p=>{p&&(s.geometries.push(p),p._parentContainer=s)})}if(o.transformNodes!==void 0&&o.transformNodes!==null)for(c=0,u=o.transformNodes.length;c<u;c++){const f=o.transformNodes[c],d=ot.Parse(f,n,t);bo[f.uniqueId]=d,s.transformNodes.push(d),d._parentContainer=s}if(o.meshes!==void 0&&o.meshes!==null)for(c=0,u=o.meshes.length;c<u;c++){const f=o.meshes[c],d=k.Parse(f,n,t);if(bo[f.uniqueId]=d,s.meshes.push(d),d._parentContainer=s,d.hasInstances)for(const p of d.instances)s.meshes.push(p),p._parentContainer=s;a+=c===0?`
	Meshes:`:"",a+=`
		`+d.toString(l)}if(o.cameras!==void 0&&o.cameras!==null)for(c=0,u=o.cameras.length;c<u;c++){const f=o.cameras[c],d=He.Parse(f,n);bo[f.uniqueId]=d,s.cameras.push(d),d._parentContainer=s,a+=c===0?`
	Cameras:`:"",a+=`
		`+d.toString(l)}if(o.postProcesses!==void 0&&o.postProcesses!==null)for(c=0,u=o.postProcesses.length;c<u;c++){const f=o.postProcesses[c],d=Jt.Parse(f,n,t);d&&(s.postProcesses.push(d),d._parentContainer=s,a+=c===0?`
Postprocesses:`:"",a+=`
		`+d.toString())}if(o.animationGroups!==void 0&&o.animationGroups!==null)for(c=0,u=o.animationGroups.length;c<u;c++){const f=o.animationGroups[c],d=Js.Parse(f,n);s.animationGroups.push(d),d._parentContainer=s,a+=c===0?`
	AnimationGroups:`:"",a+=`
		`+d.toString(l)}if(o.spriteManagers)for(let f=0,d=o.spriteManagers.length;f<d;f++){const p=o.spriteManagers[f],_=kn.Parse(p,n,t);a+=`
		SpriteManager `+_.name}for(c=0,u=n.cameras.length;c<u;c++){const f=n.cameras[c];f._waitingParentId!==null&&(f.parent=Zc(f._waitingParentId,f._waitingParentInstanceIndex,n),f._waitingParentId=null,f._waitingParentInstanceIndex=null)}for(c=0,u=n.lights.length;c<u;c++){const f=n.lights[c];f&&f._waitingParentId!==null&&(f.parent=Zc(f._waitingParentId,f._waitingParentInstanceIndex,n),f._waitingParentId=null,f._waitingParentInstanceIndex=null)}for(c=0,u=n.transformNodes.length;c<u;c++){const f=n.transformNodes[c];f._waitingParentId!==null&&(f.parent=Zc(f._waitingParentId,f._waitingParentInstanceIndex,n),f._waitingParentId=null,f._waitingParentInstanceIndex=null)}for(c=0,u=n.meshes.length;c<u;c++){const f=n.meshes[c];f._waitingParentId!==null&&(f.parent=Zc(f._waitingParentId,f._waitingParentInstanceIndex,n),f._waitingParentId=null,f._waitingParentInstanceIndex=null),f._waitingData.lods&&YC(n,f)}for(n.multiMaterials.forEach(f=>{f._waitingSubMaterialsUniqueIds.forEach(d=>{f.subMaterials.push(Nu(d,n))}),f._waitingSubMaterialsUniqueIds=[]}),n.meshes.forEach(f=>{f._waitingMaterialId!==null&&(f.material=Nu(f._waitingMaterialId,n),f._waitingMaterialId=null)}),n.meshes.forEach(f=>{f._waitingMorphTargetManagerId!==null&&(f.morphTargetManager=zo[f._waitingMorphTargetManagerId],f._waitingMorphTargetManagerId=null)}),c=0,u=n.skeletons.length;c<u;c++){const f=n.skeletons[c];f._hasWaitingData&&(f.bones!=null&&f.bones.forEach(d=>{if(d._waitingTransformNodeId){const p=n.getLastEntryById(d._waitingTransformNodeId);p&&d.linkTransformNode(p),d._waitingTransformNodeId=null}}),f._hasWaitingData=null)}for(c=0,u=n.meshes.length;c<u;c++){const f=n.meshes[c];f._waitingData.freezeWorldMatrix?(f.freezeWorldMatrix(),f._waitingData.freezeWorldMatrix=null):f.computeWorldMatrix(!0)}for(c=0,u=n.lights.length;c<u;c++){const f=n.lights[c];if(f._excludedMeshesIds.length>0){for(let d=0;d<f._excludedMeshesIds.length;d++){const p=n.getMeshById(f._excludedMeshesIds[d]);p&&f.excludedMeshes.push(p)}f._excludedMeshesIds=[]}if(f._includedOnlyMeshesIds.length>0){for(let d=0;d<f._includedOnlyMeshesIds.length;d++){const p=n.getMeshById(f._includedOnlyMeshesIds[d]);p&&f.includedOnlyMeshes.push(p)}f._includedOnlyMeshesIds=[]}}for(n.geometries.forEach(f=>{f._loadedUniqueId=""}),zL(o,n,s,t),c=0,u=n.meshes.length;c<u;c++){const f=n.meshes[c];f._waitingData.actions&&(Gt.Parse(f._waitingData.actions,f,n),f._waitingData.actions=null)}o.actions!==void 0&&o.actions!==null&&Gt.Parse(o.actions,null,n)}catch(l){const c=Mo("loadAssets",o?o.producer:"Unknown")+a;if(i)i(c,l);else throw w.Log(c),l}finally{bo={},la={},zo={},r||s.removeAllFromScene(),a!==null&&wi.loggingLevel!==wi.NO_LOGGING&&w.Log(Mo("loadAssets",o?o.producer:"Unknown")+(wi.loggingLevel!==wi.MINIMAL_LOGGING?a:""))}return s};wi.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:n=>n.indexOf("babylon")!==-1,importMesh:(n,e,t,i,r,s,a,o)=>{let l="importMesh has failed JSON parse";try{var c=JSON.parse(t);l="";const u=wi.loggingLevel===wi.DETAILED_LOGGING;n?Array.isArray(n)||(n=[n]):n=null;const h=[],f=new Map,d=[];if(c.transformNodes!==void 0&&c.transformNodes!==null)for(let p=0,_=c.transformNodes.length;p<_;p++){const g=c.transformNodes[p],E=ot.Parse(g,e,i);d.push(E),f.set(E._waitingParsedUniqueId,E),E._waitingParsedUniqueId=null}if(c.meshes!==void 0&&c.meshes!==null){const p=[],_=[],g=[],E=[];for(let x=0,A=c.meshes.length;x<A;x++){const T=c.meshes[x];if(n===null||Tw(T,n,h)){if(n!==null&&delete n[n.indexOf(T.name)],T.geometryId!==void 0&&T.geometryId!==null&&c.geometries!==void 0&&c.geometries!==null){let y=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(P=>{y===!0||!c.geometries[P]||!Array.isArray(c.geometries[P])||c.geometries[P].forEach(D=>{if(D.id===T.geometryId){switch(P){case"vertexData":dr.Parse(D,e,i);break}y=!0}})}),y===!1&&w.Warn("Geometry not found for mesh "+T.id)}if(T.materialUniqueId||T.materialId){const y=T.materialUniqueId?g:_;let P=y.indexOf(T.materialUniqueId||T.materialId)!==-1;if(P===!1&&c.multiMaterials!==void 0&&c.multiMaterials!==null){const D=(F,W)=>{y.push(F);const H=PE(W,c,e,i);H&&H.material&&(la[H.parsedMaterial.uniqueId||H.parsedMaterial.id]=H.material,l+=`
	Material `+H.material.toString(u))};for(let F=0,W=c.multiMaterials.length;F<W;F++){const H=c.multiMaterials[F];if(T.materialUniqueId&&H.uniqueId===T.materialUniqueId||H.id===T.materialId){H.materialsUniqueIds?H.materialsUniqueIds.forEach(ae=>D(ae,le=>le.uniqueId===ae)):H.materials.forEach(ae=>D(ae,le=>le.id===ae)),y.push(H.uniqueId||H.id);const ue=Yn.ParseMultiMaterial(H,e);la[H.uniqueId||H.id]=ue,ue&&(P=!0,l+=`
	Multi-Material `+ue.toString(u));break}}}if(P===!1){y.push(T.materialUniqueId||T.materialId);const D=PE(F=>T.materialUniqueId&&F.uniqueId===T.materialUniqueId||F.id===T.materialId,c,e,i);!D||!D.material?w.Warn("Material not found for mesh "+T.id):(la[D.parsedMaterial.uniqueId||D.parsedMaterial.id]=D.material,l+=`
	Material `+D.material.toString(u))}}if(T.skeletonId!==null&&T.skeletonId!==void 0&&c.skeletonId!==-1&&c.skeletons!==void 0&&c.skeletons!==null&&!(p.indexOf(T.skeletonId)>-1))for(let P=0,D=c.skeletons.length;P<D;P++){const F=c.skeletons[P];if(F.id===T.skeletonId){const W=ac.Parse(F,e);a.push(W),p.push(F.id),l+=`
	Skeleton `+W.toString(u)}}if(T.morphTargetManagerId>-1&&c.morphTargetManagers!==void 0&&c.morphTargetManagers!==null&&!(E.indexOf(T.morphTargetManagerId)>-1))for(let P=0;P<c.morphTargetManagers.length;P++){const D=c.morphTargetManagers[P];if(D.id===T.morphTargetManagerId){const F=Un.Parse(D,e);zo[D.id]=F,E.push(D.id),l+=`
Morph target manager`+F.toString()}}const C=k.Parse(T,e,i);r.push(C),f.set(C._waitingParsedUniqueId,C),C._waitingParsedUniqueId=null,l+=`
	Mesh `+C.toString(u)}}e.multiMaterials.forEach(x=>{x._waitingSubMaterialsUniqueIds.forEach(A=>{x.subMaterials.push(Nu(A,e))}),x._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(x=>{x._waitingMaterialId!==null&&(x.material=Nu(x._waitingMaterialId,e),x._waitingMaterialId=null)}),e.meshes.forEach(x=>{x._waitingMorphTargetManagerId!==null&&(x.morphTargetManager=zo[x._waitingMorphTargetManagerId],x._waitingMorphTargetManagerId=null)});for(let x=0,A=e.transformNodes.length;x<A;x++){const T=e.transformNodes[x];if(T._waitingParentId!==null){let C=f.get(parseInt(T._waitingParentId))||null;C===null&&(C=e.getLastEntryById(T._waitingParentId));let y=C;T._waitingParentInstanceIndex&&(y=C.instances[parseInt(T._waitingParentInstanceIndex)],T._waitingParentInstanceIndex=null),T.parent=y,T._waitingParentId=null}}let v;for(let x=0,A=e.meshes.length;x<A;x++){if(v=e.meshes[x],v._waitingParentId){let T=f.get(parseInt(v._waitingParentId))||null;T===null&&(T=e.getLastEntryById(v._waitingParentId));let C=T;v._waitingParentInstanceIndex&&(C=T.instances[parseInt(v._waitingParentInstanceIndex)],v._waitingParentInstanceIndex=null),v.parent=C,v._waitingParentId=null}v._waitingData.lods&&YC(e,v)}for(const x of d)x.getChildMeshes(!1).length||x.dispose();for(let x=0,A=e.skeletons.length;x<A;x++){const T=e.skeletons[x];T._hasWaitingData&&(T.bones!=null&&T.bones.forEach(C=>{if(C._waitingTransformNodeId){const y=e.getLastEntryById(C._waitingTransformNodeId);y&&C.linkTransformNode(y),C._waitingTransformNodeId=null}}),T._hasWaitingData=null)}for(let x=0,A=e.meshes.length;x<A;x++)v=e.meshes[x],v._waitingData.freezeWorldMatrix?(v.freezeWorldMatrix(),v._waitingData.freezeWorldMatrix=null):v.computeWorldMatrix(!0)}if(c.particleSystems!==void 0&&c.particleSystems!==null){const p=Sx(we.NAME_PARTICLESYSTEM);if(p)for(let _=0,g=c.particleSystems.length;_<g;_++){const E=c.particleSystems[_];h.indexOf(E.emitterId)!==-1&&s.push(p(E,e,i))}}return e.geometries.forEach(p=>{p._loadedUniqueId=""}),!0}catch(u){const h=Mo("importMesh",c?c.producer:"Unknown")+l;if(o)o(h,u);else throw w.Log(h),u}finally{l!==null&&wi.loggingLevel!==wi.NO_LOGGING&&w.Log(Mo("importMesh",c?c.producer:"Unknown")+(wi.loggingLevel!==wi.MINIMAL_LOGGING?l:"")),la={},zo={}}return!1},load:(n,e,t,i)=>{let r="importScene has failed JSON parse";try{var s=JSON.parse(e);switch(r="",s.useDelayedTextureLoading!==void 0&&s.useDelayedTextureLoading!==null&&(n.useDelayedTextureLoading=s.useDelayedTextureLoading&&!wi.ForceFullSceneLoadingForIncremental),s.autoClear!==void 0&&s.autoClear!==null&&(n.autoClear=s.autoClear),s.clearColor!==void 0&&s.clearColor!==null&&(n.clearColor=Be.FromArray(s.clearColor)),s.ambientColor!==void 0&&s.ambientColor!==null&&(n.ambientColor=fe.FromArray(s.ambientColor)),s.gravity!==void 0&&s.gravity!==null&&(n.gravity=m.FromArray(s.gravity)),s.useRightHandedSystem!==void 0&&(n.useRightHandedSystem=!!s.useRightHandedSystem),s.fogMode!==void 0&&s.fogMode!==null&&(n.fogMode=s.fogMode),s.fogColor!==void 0&&s.fogColor!==null&&(n.fogColor=fe.FromArray(s.fogColor)),s.fogStart!==void 0&&s.fogStart!==null&&(n.fogStart=s.fogStart),s.fogEnd!==void 0&&s.fogEnd!==null&&(n.fogEnd=s.fogEnd),s.fogDensity!==void 0&&s.fogDensity!==null&&(n.fogDensity=s.fogDensity),r+="	Fog mode for scene:  ",n.fogMode){case 0:r+=`none
`;break;case 1:r+=`exp
`;break;case 2:r+=`exp2
`;break;case 3:r+=`linear
`;break}if(s.physicsEnabled){let o;s.physicsEngine==="cannon"||s.physicsEngine===md.name?o=new md(void 0,void 0,du.LoaderInjectedPhysicsEngine):s.physicsEngine==="oimo"||s.physicsEngine===fE.name?o=new fE(void 0,du.LoaderInjectedPhysicsEngine):(s.physicsEngine==="ammo"||s.physicsEngine===hn.name)&&(o=new hn(void 0,du.LoaderInjectedPhysicsEngine,void 0)),r="	Physics engine "+(s.physicsEngine?s.physicsEngine:"oimo")+` enabled
`;const l=s.gravity?m.FromArray(s.gravity):s.physicsGravity?m.FromArray(s.physicsGravity):null;n.enablePhysics(l,o)}return s.metadata!==void 0&&s.metadata!==null&&(n.metadata=s.metadata),s.collisionsEnabled!==void 0&&s.collisionsEnabled!==null&&(n.collisionsEnabled=s.collisionsEnabled),ME(n,e,t,i,!0)?(s.autoAnimate&&n.beginAnimation(n,s.autoAnimateFrom,s.autoAnimateTo,s.autoAnimateLoop,s.autoAnimateSpeed||1),s.activeCameraID!==void 0&&s.activeCameraID!==null&&n.setActiveCameraById(s.activeCameraID),!0):!1}catch(a){const o=Mo("importScene",s?s.producer:"Unknown")+r;if(i)i(o,a);else throw w.Log(o),a}finally{r!==null&&wi.loggingLevel!==wi.NO_LOGGING&&w.Log(Mo("importScene",s?s.producer:"Unknown")+(wi.loggingLevel!==wi.MINIMAL_LOGGING?r:""))}return!1},loadAssetContainer:(n,e,t,i)=>ME(n,e,t,i)});class ca{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const r=this._renderingCanvas.getBoundingClientRect(),s=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position=s==="fixed"?"fixed":"absolute",this._loadingDiv.style.left=r.left+"px",this._loadingDiv.style.top=r.top+"px",this._loadingDiv.style.width=r.width+"px",this._loadingDiv.style.height=r.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css";const e=`@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;this._style.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(this._style);const t=!!window.SVGSVGElement,i=new Image;ca.DefaultLogoUrl?i.src=ca.DefaultLogoUrl:i.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",i.style.width="150px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const r=document.createElement("div");r.style.width="300px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";const s=new Image;if(ca.DefaultSpinnerUrl?s.src=ca.DefaultSpinnerUrl:s.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",!t){const a={w:16,h:18.5},o={w:30,h:30};i.style.width=`${a.w}vh`,i.style.height=`${a.h}vh`,i.style.left=`calc(50% - ${a.w/2}vh)`,i.style.top=`calc(50% - ${a.h/2}vh)`,s.style.width=`${o.w}vh`,s.style.height=`${o.h}vh`,s.style.left=`calc(50% - ${o.w/2}vh)`,s.style.top=`calc(50% - ${o.h/2}vh)`}r.appendChild(s),this._loadingDiv.appendChild(i),this._loadingDiv.appendChild(r),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){if(!this._loadingDiv)return;const e=()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",e)}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}ca.DefaultLogoUrl="";ca.DefaultSpinnerUrl="";q.DefaultLoadingScreenFactory=n=>new ca(n);Object.defineProperty($t.prototype,"decalMap",{get:function(){return this._decalMap},set:function(n){this._decalMap=n},enumerable:!0,configurable:!0});class xw{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const r=this._pendingActions.shift();r?this._execute(e,r):e.idle=!0})})}}class bc extends xw{constructor(e,t,i=bc.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,r)=>{t(i,()=>{r(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(a=>{a.terminate()});const s=this._workerInfos.indexOf(e);s!==-1&&this._workerInfos.splice(s,1)},this._options.idleTimeElapsedBeforeRelease))})})}}bc.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};function Ed(n,e,t,i,r){let s=null,a=null,o=null;try{s=new n.Decoder,a=new n.DecoderBuffer,a.Init(e,e.byteLength);let l;const c=s.GetEncodedGeometryType(a);switch(c){case n.TRIANGULAR_MESH:{const f=new n.Mesh;if(l=s.DecodeBufferToMesh(a,f),!l.ok()||f.ptr===0)throw new Error(l.error_msg());const p=f.num_faces()*3,_=p*4,g=n._malloc(_);try{s.GetTrianglesUInt32Array(f,_,g);const E=new Uint32Array(p);E.set(new Uint32Array(n.HEAPF32.buffer,g,p)),i(E)}finally{n._free(g)}o=f;break}case n.POINT_CLOUD:{const f=new n.PointCloud;if(l=s.DecodeBufferToPointCloud(a,f),!l.ok()||!f.ptr)throw new Error(l.error_msg());o=f;break}default:throw new Error(`Invalid geometry type ${c}`)}const u=o.num_points(),h=(f,d,p,_)=>{const g=_.data_type(),E=_.num_components(),v=_.normalized(),x=_.byte_stride(),A=_.byte_offset(),C={[n.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:n.HEAPF32},[n.DT_INT8]:{typedArrayConstructor:Int8Array,heap:n.HEAP8},[n.DT_INT16]:{typedArrayConstructor:Int16Array,heap:n.HEAP16},[n.DT_INT32]:{typedArrayConstructor:Int32Array,heap:n.HEAP32},[n.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:n.HEAPU8},[n.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:n.HEAPU16},[n.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:n.HEAPU32}}[g];if(!C)throw new Error(`Invalid data type ${g}`);const y=u*E,P=y*C.typedArrayConstructor.BYTES_PER_ELEMENT,D=n._malloc(P);try{f.GetAttributeDataArrayForAllPoints(d,_,g,P,D);const F=new C.typedArrayConstructor(C.heap.buffer,D,y);r(p,F.slice(),E,A,x,v)}finally{n._free(D)}};if(t)for(const f in t){const d=t[f],p=s.GetAttributeByUniqueId(o,d);h(s,o,f,p)}else{const f={position:n.POSITION,normal:n.NORMAL,color:n.COLOR,uv:n.TEX_COORD};for(const d in f){const p=s.GetAttributeId(o,f[d]);if(p!==-1){const _=s.GetAttribute(o,p);h(s,o,d,_)}}}return u}finally{o&&n.destroy(o),a&&n.destroy(a),s&&n.destroy(s)}}function Cw(){let n;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const i=t.decoder;i.url&&importScripts(i.url);const r=i.wasmBinary?{wasmBinary:i.wasmBinary}:{};n=DracoDecoderModule(r),postMessage({id:"initDone"});break}case"decodeMesh":{if(!n)throw new Error("Draco decoder module is not available");n.then(i=>{const r=Ed(i,t.dataView,t.attributes,s=>{postMessage({id:"indices",data:s},[s.buffer])},(s,a,o,l,c,u)=>{postMessage({id:"attribute",kind:s,data:a,size:o,byteOffset:l,byteStride:c,normalized:u},[a.buffer])});postMessage({id:"decodeMeshDone",totalVertices:r})});break}}}}function Aw(n,e,t){return new Promise((i,r)=>{const s=o=>{n.removeEventListener("error",s),n.removeEventListener("message",a),r(o)},a=o=>{o.data.id==="initDone"&&(n.removeEventListener("error",s),n.removeEventListener("message",a),i(n))};if(n.addEventListener("error",s),n.addEventListener("message",a),!e)n.postMessage({id:"init",decoder:{url:t}});else{const o=e.slice(0);n.postMessage({id:"init",decoder:{url:t,wasmBinary:o}},[o])}})}function Iw(n,e){return new Promise(t=>{(e||DracoDecoderModule)({wasmBinary:n}).then(i=>{t({module:i})})})}class Yr{static get DecoderAvailable(){const e=Yr.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return Yr._Default||(Yr._Default=new Yr),Yr._Default}static ResetDefault(e){Yr._Default&&(e||Yr._Default.dispose(),Yr._Default=null)}constructor(e=Yr.DefaultNumWorkers){const t=Yr.Configuration.decoder;if(t.workerPool||typeof e=="object"&&e.workerPool)this._workerPoolPromise=Promise.resolve(t.workerPool||e.workerPool);else{const i=t.wasmBinary||typeof e=="object"&&e.wasmBinary,r=typeof e=="number"?e:e.numWorkers,s=r&&typeof Worker=="function"&&typeof URL=="function",a=s||!s&&!t.jsModule,o=t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:a?J.GetBabylonScriptURL(t.wasmUrl,!0):"",wasmBinaryPromise:i?Promise.resolve(i):J.LoadFileAsync(J.GetBabylonScriptURL(t.wasmBinaryUrl,!0))}:{url:a?J.GetBabylonScriptURL(t.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};s?this._workerPoolPromise=o.wasmBinaryPromise.then(l=>{const c=`${Ed}(${Cw})()`,u=URL.createObjectURL(new Blob([c],{type:"application/javascript"}));return new bc(r,()=>{const h=new Worker(u);return Aw(h,l,o.url)})}):this._decoderModulePromise=o.wasmBinaryPromise.then(async l=>{if(typeof DracoDecoderModule>"u"&&!t.jsModule){if(!o.url)throw new Error("Draco decoder module is not available");await J.LoadBabylonScriptAsync(o.url)}return await Iw(l,t.jsModule)})}}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}async whenReadyAsync(){if(this._workerPoolPromise){await this._workerPoolPromise;return}if(this._decoderModulePromise){await this._decoderModulePromise;return}}decodeMeshToMeshDataAsync(e,t,i){const r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),s=(a,o)=>i&&i[a]!==void 0?(o!==i[a]&&w.Warn(`Normalized flag from Draco data (${o}) does not match normalized flag from glTF accessor (${i[a]}). Using flag from glTF accessor.`),i[a]):o;if(this._workerPoolPromise)return this._workerPoolPromise.then(a=>new Promise((o,l)=>{a.push((c,u)=>{let h=null;const f=[],d=g=>{c.removeEventListener("error",d),c.removeEventListener("message",p),l(g),u()},p=g=>{const E=g.data;switch(E.id){case"decodeMeshDone":{c.removeEventListener("error",d),c.removeEventListener("message",p),o({indices:h,attributes:f,totalVertices:E.totalVertices}),u();break}case"indices":{h=E.data;break}case"attribute":{f.push({kind:E.kind,data:E.data,size:E.size,byteOffset:E.byteOffset,byteStride:E.byteStride,normalized:s(E.kind,E.normalized)});break}}};c.addEventListener("error",d),c.addEventListener("message",p);const _=r.slice();c.postMessage({id:"decodeMesh",dataView:_,attributes:t},[_.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(a=>{let o=null;const l=[],c=Ed(a.module,r,t,u=>{o=u},(u,h,f,d,p,_)=>{l.push({kind:u,data:h,size:f,byteOffset:d,byteStride:p,normalized:_})});return{indices:o,attributes:l,totalVertices:c}});throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,i,r){const s=await this.decodeMeshToMeshDataAsync(i,r),a=new dr(e,t);s.indices&&a.setIndices(s.indices);for(const o of s.attributes)a.setVerticesBuffer(new b(t.getEngine(),o.data,o.kind,!1,void 0,o.byteStride,void 0,o.byteOffset,o.size,void 0,o.normalized,!0),s.totalVertices);return a}async _decodeMeshToGeometryForGltfAsync(e,t,i,r,s){const a=await this.decodeMeshToMeshDataAsync(i,r,s),o=new dr(e,t);a.indices&&o.setIndices(a.indices);for(const l of a.attributes)o.setVerticesBuffer(new b(t.getEngine(),l.data,l.kind,!1,void 0,l.byteStride,void 0,l.byteOffset,l.size,void 0,l.normalized,!0),a.totalVertices);return o}async decodeMeshAsync(e,t){const i=await this.decodeMeshToMeshDataAsync(e,t),r=new de;i.indices&&(r.indices=i.indices);for(const s of i.attributes){const a=b.GetFloatData(s.data,s.size,b.GetDataType(s.data),s.byteOffset,s.byteStride,s.normalized,i.totalVertices);r.set(a,s.kind)}return r}}Yr.Configuration={decoder:{wasmUrl:`${J._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${J._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${J._DefaultCdnUrl}/draco_decoder_gltf.js`}};Yr.DefaultNumWorkers=Yr.GetDefaultNumWorkers();Yr._Default=null;class oa{static get Default(){return oa._Default||(oa._Default=new oa),oa._Default}constructor(){const e=oa.Configuration.decoder;this._decoderModulePromise=J.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,s){return this._decoderModulePromise.then(async()=>{MeshoptDecoder.useWorkers(1);const a=await MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,s);return MeshoptDecoder.useWorkers(0),a})}}oa.Configuration={decoder:{url:`${J._DefaultCdnUrl}/meshopt_decoder.js`}};oa._Default=null;let Qc=0;class oc{constructor(e,t,i,r){this.pos=e,this.normal=t,this.uv=i,this.vertColor=r}clone(){var e,t;return new oc(this.pos.clone(),this.normal.clone(),(e=this.uv)==null?void 0:e.clone(),(t=this.vertColor)==null?void 0:t.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new oc(m.Lerp(this.pos,e.pos,t),m.Lerp(this.normal,e.normal,t),this.uv&&e.uv?se.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?Be.Lerp(this.vertColor,e.vertColor,t):void 0)}}class Wa{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){const r=i.subtract(e),s=t.subtract(e);if(r.lengthSquared()===0||s.lengthSquared()===0)return null;const a=m.Normalize(m.Cross(r,s));return new Wa(a,m.Dot(a,e))}clone(){return new Wa(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,r,s){let u=0;const h=[];let f,d;for(f=0;f<e.vertices.length;f++){d=m.Dot(this.normal,e.vertices[f].pos)-this.w;const p=d<-Wa.EPSILON?2:d>Wa.EPSILON?1:0;u|=p,h.push(p)}switch(u){case 0:(m.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:r.push(e);break;case 2:s.push(e);break;case 3:{const p=[],_=[];for(f=0;f<e.vertices.length;f++){const E=(f+1)%e.vertices.length,v=h[f],x=h[E],A=e.vertices[f],T=e.vertices[E];if(v!==2&&p.push(A),v!==1&&_.push(v!==2?A.clone():A),(v|x)===3){d=(this.w-m.Dot(this.normal,A.pos))/m.Dot(this.normal,T.pos.subtract(A.pos));const C=A.interpolate(T,d);p.push(C),_.push(C.clone())}}let g;p.length>=3&&(g=new rl(p,e.shared),g.plane&&r.push(g)),_.length>=3&&(g=new rl(_,e.shared),g.plane&&s.push(g));break}}}}Wa.EPSILON=1e-5;class rl{constructor(e,t){this.vertices=e,this.shared=t,this.plane=Wa.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){const e=this.vertices.map(t=>t.clone());return new rl(e,this.shared)}flip(){this.vertices.reverse().map(e=>{e.flip()}),this.plane.flip()}}let Ms=class pu{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){const e=new pu;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map(t=>t.clone()),e}invert(){for(let t=0;t<this._polygons.length;t++)this._polygons[t].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();const e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),this._back?i=this._back.clipPolygons(i):i=[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());const t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new pu),this._front.build(t)),i.length&&(this._back||(this._back=new pu),this._back.build(i))}};class en{constructor(){this._polygons=new Array}static FromVertexData(e){let t,i,r;const s=[],a=e.indices,o=e.positions,l=e.normals,c=e.uvs,u=e.colors;if(!a||!o)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let f=0;f<a.length;f+=3){r=[];for(let d=0;d<3;d++){const p=f+d,_=a[p],g=l?m.FromArray(l,_*3):m.Zero(),E=c?se.FromArray(c,_*2):void 0,v=u?Be.FromArray(u,_*4):void 0,x=m.FromArray(o,_*3);t=new oc(x,g,E,v),r.push(t)}i=new rl(r,{subMeshId:0,meshId:Qc,materialIndex:0}),i.plane&&s.push(i)}const h=en._FromPolygons(s);return h.matrix=O.Identity(),h.position=m.Zero(),h.rotation=m.Zero(),h.scaling=m.One(),h.rotationQuaternion=ce.Identity(),Qc++,h}static FromMesh(e,t=!1){let i,r,s,a,o,l,c;const u=[];let h,f,d,p=null,_,g=!1;if(e instanceof k)e.computeWorldMatrix(!0),h=e.getWorldMatrix(),f=e.position.clone(),d=e.rotation.clone(),e.rotationQuaternion&&(p=e.rotationQuaternion.clone()),_=e.scaling.clone(),e.material&&t&&(g=e.material.sideOrientation===0);else throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";const E=e.getIndices(),v=e.getVerticesData(b.PositionKind),x=e.getVerticesData(b.NormalKind),A=e.getVerticesData(b.UVKind),T=e.getVerticesData(b.ColorKind);if(E===null)throw"BABYLON.CSG: Mesh has no indices";if(v===null)throw"BABYLON.CSG: Mesh has no positions";if(x===null)throw"BABYLON.CSG: Mesh has no normals";const C=e.subMeshes;for(let P=0,D=C.length;P<D;P++)for(let F=C[P].indexStart,W=C[P].indexCount+C[P].indexStart;F<W;F+=3){c=[];for(let H=0;H<3;H++){const ue=H===0?F+H:g?F+3-H:F+H,ae=new m(x[E[ue]*3],x[E[ue]*3+1],x[E[ue]*3+2]);A&&(s=new se(A[E[ue]*2],A[E[ue]*2+1])),T&&(o=new Be(T[E[ue]*4],T[E[ue]*4+1],T[E[ue]*4+2],T[E[ue]*4+3]));const le=new m(v[E[ue]*3],v[E[ue]*3+1],v[E[ue]*3+2]);a=m.TransformCoordinates(le,h),r=m.TransformNormal(ae,h),i=new oc(a,r,s,o),c.push(i)}l=new rl(c,{subMeshId:P,meshId:Qc,materialIndex:C[P].materialIndex}),l.plane&&u.push(l)}const y=en._FromPolygons(u);return y.matrix=t?O.Identity():h,y.position=t?m.Zero():f,y.rotation=t?m.Zero():d,y.scaling=t?m.One():_,y.rotationQuaternion=t&&p?ce.Identity():p,Qc++,y}static _FromPolygons(e){const t=new en;return t._polygons=e,t}clone(){const e=new en;return e._polygons=this._polygons.map(t=>t.clone()),e.copyTransformAttributes(this),e}union(e){const t=new Ms(this.clone()._polygons),i=new Ms(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),en._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){const t=new Ms(this._polygons),i=new Ms(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){const t=new Ms(this.clone()._polygons),i=new Ms(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),en._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){const t=new Ms(this._polygons),i=new Ms(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){const t=new Ms(this.clone()._polygons),i=new Ms(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),en._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){const t=new Ms(this._polygons),i=new Ms(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){const e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map(e=>{e.flip()})}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){const i=this.matrix.clone();i.invert();const r=this._polygons,s=[],a=[],o=[];let l=null,c=null;const u=m.Zero(),h=m.Zero(),f=se.Zero(),d=new Be(0,0,0,0),p=[0,0,0],_={};let g;for(let v=0,x=r.length;v<x;v++){const A=r[v];e&&e(A);for(let T=2,C=A.vertices.length;T<C;T++){p[0]=0,p[1]=T-1,p[2]=T;for(let y=0;y<3;y++){u.copyFrom(A.vertices[p[y]].pos),h.copyFrom(A.vertices[p[y]].normal),A.vertices[p[y]].uv&&(l||(l=[]),f.copyFrom(A.vertices[p[y]].uv)),A.vertices[p[y]].vertColor&&(c||(c=[]),d.copyFrom(A.vertices[p[y]].vertColor));const P=m.TransformCoordinates(u,i),D=m.TransformNormal(h,i);g=_[P.x+","+P.y+","+P.z];let F=!1;l&&!(l[g*2]===f.x||l[g*2+1]===f.y)&&(F=!0);let W=!1;c&&!(c[g*4]===d.r||c[g*4+1]===d.g||c[g*4+2]===d.b||c[g*4+3]===d.a)&&(W=!0),(!(typeof g<"u"&&o[g*3]===D.x&&o[g*3+1]===D.y&&o[g*3+2]===D.z)||F||W)&&(s.push(P.x,P.y,P.z),l&&l.push(f.x,f.y),o.push(h.x,h.y,h.z),c&&c.push(d.r,d.g,d.b,d.a),g=_[P.x+","+P.y+","+P.z]=s.length/3-1),a.push(g),t&&t()}}}const E=new de;return E.positions=s,E.normals=o,l&&(E.uvs=l),c&&(E.colors=c),E.indices=a,E}buildMeshGeometry(e,t,i){const r=new k(e,t),s=this._polygons;let a=0;const o={};let l;if(i&&s.sort((u,h)=>u.shared.meshId===h.shared.meshId?u.shared.subMeshId-h.shared.subMeshId:u.shared.meshId-h.shared.meshId),this.toVertexData(u=>{o[u.shared.meshId]||(o[u.shared.meshId]={}),o[u.shared.meshId][u.shared.subMeshId]||(o[u.shared.meshId][u.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:u.shared.materialIndex}),l=o[u.shared.meshId][u.shared.subMeshId]},()=>{l.indexStart=Math.min(a,l.indexStart),l.indexEnd=Math.max(a,l.indexEnd),a++}).applyToMesh(r),i){let u=0,h;r.subMeshes=[];for(const f in o){h=-1;for(const d in o[f])l=o[f][d],_r.CreateFromIndices(l.materialIndex+u,l.indexStart,l.indexEnd-l.indexStart+1,r),h=Math.max(l.materialIndex,h);u+=++h}}return r}toMesh(e,t=null,i,r){const s=this.buildMeshGeometry(e,i,r);return s.material=t,s.position.copyFrom(this.position),s.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(s.rotationQuaternion=this.rotationQuaternion.clone()),s.scaling.copyFrom(this.scaling),s.computeWorldMatrix(!0),s}}k._GroundMeshParser=(n,e)=>Rc.Parse(n,e);class Rc extends k{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),r=B.Matrix[5];i.invertToRef(r);const s=B.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,r,s),e=s.x,t=s.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t),o=-(a.x*e+a.z*t+a.w)/a.y;return m.TransformCoordinatesFromFloatsToRef(0,o,0,i,s),s.y}getNormalAtCoordinates(e,t){const i=new m(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const r=this.getWorldMatrix(),s=B.Matrix[5];r.invertToRef(s);const a=B.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,s,a),e=a.x,t=a.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return m.TransformNormalFromFloatsToRef(o.x,o.y,o.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[r*this._subdivisionsX+i];let a;return t<s.slope.x*e+s.slope.y?a=s.facet1:a=s.facet2,a}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let r=0;r<e;r++){const s={slope:se.Zero(),facet1:new We(0,0,0,0),facet2:new We(0,0,0,0)};this._heightQuads[i*e+r]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(b.PositionKind);if(!e)return this;const t=B.Vector3[3],i=B.Vector3[2],r=B.Vector3[1],s=B.Vector3[0],a=B.Vector3[4],o=B.Vector3[5],l=B.Vector3[6],c=B.Vector3[7],u=B.Vector3[8];let h=0,f=0,d=0,p=0,_=0,g=0,E=0;const v=this._subdivisionsX,x=this._subdivisionsY;for(let A=0;A<x;A++)for(let T=0;T<v;T++){h=T*3,f=A*(v+1)*3,d=(A+1)*(v+1)*3,t.x=e[f+h],t.y=e[f+h+1],t.z=e[f+h+2],i.x=e[f+h+3],i.y=e[f+h+4],i.z=e[f+h+5],r.x=e[d+h],r.y=e[d+h+1],r.z=e[d+h+2],s.x=e[d+h+3],s.y=e[d+h+4],s.z=e[d+h+5],p=(s.z-t.z)/(s.x-t.x),_=t.z-p*t.x,i.subtractToRef(t,a),r.subtractToRef(t,o),s.subtractToRef(t,l),m.CrossToRef(l,o,c),m.CrossToRef(a,l,u),c.normalize(),u.normalize(),g=-(c.x*t.x+c.y*t.y+c.z*t.z),E=-(u.x*i.x+u.y*i.y+u.z*i.z);const C=this._heightQuads[A*v+T];C.slope.copyFromFloats(p,_),C.facet1.copyFromFloats(c.x,c.y,c.z,g),C.facet2.copyFromFloats(u.x,u.y,u.z,E)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Rc(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}k._GoldbergMeshParser=(n,e)=>Ah.Parse(n,e);class Ah extends k{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(w.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(w.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(w.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],a=e[i][2];for(let o=r;o<s+1;o++)this.goldbergData.faceColors[o]=a}const t=[];for(let i=0;i<12;i++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(b.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(b.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(b.UVKind);for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1],a=e[i][2],o=e[i][3],l=e[i][4],c=[],u=[];let h,f;for(let d=0;d<5;d++)h=a.x+o*Math.cos(l+d*Math.PI/2.5),f=a.y+o*Math.sin(l+d*Math.PI/2.5),h<0&&(h=0),h>1&&(h=1),c.push(h,f);for(let d=0;d<6;d++)h=a.x+o*Math.cos(l+d*Math.PI/3),f=a.y+o*Math.sin(l+d*Math.PI/3),h<0&&(h=0),h>1&&(h=1),u.push(h,f);for(let d=r;d<Math.min(12,s+1);d++)for(let p=0;p<5;p++)t[10*d+2*p]=c[2*p],t[10*d+2*p+1]=c[2*p+1];for(let d=Math.max(12,r);d<s+1;d++)for(let p=0;p<6;p++)t[12*d-24+2*p]=u[2*p],t[12*d-23+2*p]=u[2*p+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(b.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(b.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const r=m.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(s=>Be.FromArray(s)),i.faceCenters=i.faceCenters.map(s=>m.FromArray(s)),i.faceZaxis=i.faceZaxis.map(s=>m.FromArray(s)),i.faceXaxis=i.faceXaxis.map(s=>m.FromArray(s)),i.faceYaxis=i.faceYaxis.map(s=>m.FromArray(s));const r=new Ah(e.name,t);return r.goldbergData=i,r}}k._TrailMeshParser=(n,e)=>Lu.Parse(n,e);class Lu extends k{constructor(e,t,i,r,s=60,a=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._generator=t,typeof r=="object"&&r!==null?(this.diameter=r.diameter||1,this._length=r.length||60,this._segments=r.segments?r.segments>this._length?this._length:r.segments:this._length,this._sectionPolygonPointsCount=r.sections||4,this._doNotTaper=r.doNotTaper||!1,this._autoStart=r.autoStart||!0):(this.diameter=r||1,this._length=s,this._segments=this._length,this._doNotTaper=!1,this._autoStart=a),this._sectionVectors=[],this._sectionNormalVectors=[];for(let o=0;o<=this._sectionPolygonPointsCount;o++)this._sectionVectors[o]=m.Zero(),this._sectionNormalVectors[o]=m.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){const e=new de,t=[],i=[],r=[],s=[];let a=m.Zero();this._generator instanceof $t&&this._generator.hasBoundingInfo?a=this._generator.getBoundingInfo().boundingBox.centerWorld:a=this._generator.absolutePosition;const o=2*Math.PI/this._sectionPolygonPointsCount;for(let l=0;l<=this._sectionPolygonPointsCount;l++){const c=l!==this._sectionPolygonPointsCount?l*o:0;t.push(a.x+Math.cos(c)*this.diameter,a.y+Math.sin(c)*this.diameter,a.z),s.push(l/this._sectionPolygonPointsCount,0)}for(let l=1;l<=this._segments;l++){for(let u=0;u<=this._sectionPolygonPointsCount;u++){const h=u!==this._sectionPolygonPointsCount?u*o:0;t.push(a.x+Math.cos(h)*this.diameter,a.y+Math.sin(h)*this.diameter,a.z),s.push(u/this._sectionPolygonPointsCount,l/this._segments)}const c=t.length/3-2*(this._sectionPolygonPointsCount+1);for(let u=0;u<=this._sectionPolygonPointsCount;u++)r.push(c+u,c+u+this._sectionPolygonPointsCount,c+u+this._sectionPolygonPointsCount+1),r.push(c+u,c+u+this._sectionPolygonPointsCount+1,c+u+1)}de.ComputeNormals(t,r,i),e.positions=t,e.normals=i,e.indices=r,e.uvs=s,e.applyToMesh(this,!0),this._autoStart&&this.start()}_updateSectionVectors(){const e=this._generator.getWorldMatrix(),t=2*Math.PI/this._sectionPolygonPointsCount;for(let i=0;i<=this._sectionPolygonPointsCount;i++){const r=i!==this._sectionPolygonPointsCount?i*t:0;this._sectionVectors[i].copyFromFloats(Math.cos(r)*this.diameter,Math.sin(r)*this.diameter,0),this._sectionNormalVectors[i].copyFromFloats(Math.cos(r),Math.sin(r),0),m.TransformCoordinatesToRef(this._sectionVectors[i],e,this._sectionVectors[i]),m.TransformNormalToRef(this._sectionNormalVectors[i],e,this._sectionNormalVectors[i])}}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(()=>{this.update()}))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){const e=this.getVerticesData(b.PositionKind),t=this.getVerticesData(b.NormalKind),i=3*(this._sectionPolygonPointsCount+1);if(e&&t){if(this._doNotTaper)for(let s=i;s<e.length;s++)e[s-i]=ar(e[s-i],e[s],this._segments/this._length);else for(let s=i;s<e.length;s++)e[s-i]=ar(e[s-i],e[s],this._segments/this._length)-t[s]/this._length*this.diameter;for(let s=i;s<t.length;s++)t[s-i]=ar(t[s-i],t[s],this._segments/this._length);this._updateSectionVectors();const r=e.length-3*(this._sectionPolygonPointsCount+1);for(let s=0;s<=this._sectionPolygonPointsCount;s++)e[r+3*s]=this._sectionVectors[s].x,e[r+3*s+1]=this._sectionVectors[s].y,e[r+3*s+2]=this._sectionVectors[s].z,t[r+3*s]=this._sectionNormalVectors[s].x,t[r+3*s+1]=this._sectionNormalVectors[s].y,t[r+3*s+2]=this._sectionNormalVectors[s].z;this.updateVerticesData(b.PositionKind,e,!0,!1),this.updateVerticesData(b.NormalKind,t,!0,!1)}}reset(){const e=this.getVerticesData(b.PositionKind),t=this.getVerticesData(b.NormalKind);if(e&&t){this._updateSectionVectors();for(let i=0;i<=this._segments;i++){const r=3*i*(this._sectionPolygonPointsCount+1);for(let s=0;s<=this._sectionPolygonPointsCount;s++)e[r+3*s]=this._sectionVectors[s].x,e[r+3*s+1]=this._sectionVectors[s].y,e[r+3*s+2]=this._sectionVectors[s].z,t[r+3*s]=this._sectionNormalVectors[s].x,t[r+3*s+1]=this._sectionNormalVectors[s].y,t[r+3*s+2]=this._sectionNormalVectors[s].z}this.updateVerticesData(b.PositionKind,e,!0,!1),this.updateVerticesData(b.NormalKind,t,!0,!1)}}clone(e="",t){const i={diameter:this.diameter,length:this._length,segments:this._segments,sections:this._sectionPolygonPointsCount,doNotTaper:this._doNotTaper,autoStart:this._autoStart};return new Lu(e,t??this._generator,this.getScene(),i)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){const i=t.getLastMeshById(e.generatorId)??t.getLastTransformNodeById(e.generatorId);if(!i)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);const r={diameter:e.diameter??e._diameter,length:e._length,segments:e._segments,sections:e._sectionPolygonPointsCount,doNotTaper:e._doNotTaper,autoStart:e._autoStart};return new Lu(e.name,i,t,r)}}function Zp(n){const e=[],t=[],i=[],r=[],s=n.radius||.5,a=n.tessellation||64,o=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,l=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);const c=Math.PI*2*o,u=o===1?c/a:c/(a-1);let h=0;for(let p=0;p<a;p++){const _=Math.cos(h),g=Math.sin(h),E=(_+1)/2,v=(1-g)/2;e.push(s*_,s*g,0),r.push(E,v),h+=u}o===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],r[3]));const f=e.length/3;for(let p=1;p<f-1;p++)t.push(p+1,0,p);de.ComputeNormals(e,t,i),de._ComputeSides(l,e,t,i,r,n.frontUVs,n.backUVs);const d=new de;return d.indices=t,d.positions=e,d.normals=i,d.uvs=r,d}function Qp(n,e={},t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Zp(e).applyToMesh(i,e.updatable),i}de.CreateDisc=Zp;k.CreateDisc=(n,e,t,i=null,r,s)=>Qp(n,{radius:e,tessellation:t,sideOrientation:s,updatable:r},i);function sn(n){const e=[],t=[],i=[],r=[];let s,a;const o=n.width||n.size||1,l=n.height||n.size||1,c=(n.subdivisionsX||n.subdivisions||1)|0,u=(n.subdivisionsY||n.subdivisions||1)|0;for(s=0;s<=u;s++)for(a=0;a<=c;a++){const f=new m(a*o/c-o/2,0,(u-s)*l/u-l/2),d=new m(0,1,0);t.push(f.x,f.y,f.z),i.push(d.x,d.y,d.z),r.push(a/c,1-s/u)}for(s=0;s<u;s++)for(a=0;a<c;a++)e.push(a+1+(s+1)*(c+1)),e.push(a+1+s*(c+1)),e.push(a+s*(c+1)),e.push(a+(s+1)*(c+1)),e.push(a+1+(s+1)*(c+1)),e.push(a+s*(c+1));const h=new de;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function $C(n){const e=n.xmin!==void 0&&n.xmin!==null?n.xmin:-1,t=n.zmin!==void 0&&n.zmin!==null?n.zmin:-1,i=n.xmax!==void 0&&n.xmax!==null?n.xmax:1,r=n.zmax!==void 0&&n.zmax!==null?n.zmax:1,s=n.subdivisions||{w:1,h:1},a=n.precision||{w:1,h:1},o=[],l=[],c=[],u=[];let h,f,d,p;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;const _={w:(i-e)/s.w,h:(r-t)/s.h};function g(v,x,A,T){const C=l.length/3,y=a.w+1;for(h=0;h<a.h;h++)for(f=0;f<a.w;f++){const F=[C+f+h*y,C+(f+1)+h*y,C+(f+1)+(h+1)*y,C+f+(h+1)*y];o.push(F[1]),o.push(F[2]),o.push(F[3]),o.push(F[0]),o.push(F[1]),o.push(F[3])}const P=m.Zero(),D=new m(0,1,0);for(h=0;h<=a.h;h++)for(P.z=h*(T-x)/a.h+x,f=0;f<=a.w;f++)P.x=f*(A-v)/a.w+v,P.y=0,l.push(P.x,P.y,P.z),c.push(D.x,D.y,D.z),u.push(f/a.w,h/a.h)}for(d=0;d<s.h;d++)for(p=0;p<s.w;p++)g(e+p*_.w,t+d*_.h,e+(p+1)*_.w,t+(d+1)*_.h);const E=new de;return E.indices=o,E.positions=l,E.normals=c,E.uvs=u,E}function KC(n){const e=[],t=[],i=[],r=[];let s,a;const o=n.colorFilter||new fe(.3,.59,.11),l=n.alphaFilter||0;let c=!1;if(n.minHeight>n.maxHeight){c=!0;const h=n.maxHeight;n.maxHeight=n.minHeight,n.minHeight=h}for(s=0;s<=n.subdivisions;s++)for(a=0;a<=n.subdivisions;a++){const h=new m(a*n.width/n.subdivisions-n.width/2,0,(n.subdivisions-s)*n.height/n.subdivisions-n.height/2),f=(h.x+n.width/2)/n.width*(n.bufferWidth-1)|0,d=(1-(h.z+n.height/2)/n.height)*(n.bufferHeight-1)|0,p=(f+d*n.bufferWidth)*4;let _=n.buffer[p]/255,g=n.buffer[p+1]/255,E=n.buffer[p+2]/255;const v=n.buffer[p+3]/255;c&&(_=1-_,g=1-g,E=1-E);const x=_*o.r+g*o.g+E*o.b;v>=l?h.y=n.minHeight+(n.maxHeight-n.minHeight)*x:h.y=n.minHeight-pt,n.heightBuffer&&(n.heightBuffer[s*(n.subdivisions+1)+a]=h.y),t.push(h.x,h.y,h.z),i.push(0,0,0),r.push(a/n.subdivisions,1-s/n.subdivisions)}for(s=0;s<n.subdivisions;s++)for(a=0;a<n.subdivisions;a++){const h=a+1+(s+1)*(n.subdivisions+1),f=a+1+s*(n.subdivisions+1),d=a+s*(n.subdivisions+1),p=a+(s+1)*(n.subdivisions+1),_=t[h*3+1]>=n.minHeight,g=t[f*3+1]>=n.minHeight,E=t[d*3+1]>=n.minHeight;_&&g&&E&&(e.push(h),e.push(f),e.push(d)),t[p*3+1]>=n.minHeight&&_&&E&&(e.push(p),e.push(h),e.push(d))}de.ComputeNormals(t,e,i);const u=new de;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function Jp(n,e={},t){const i=new Rc(n,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,sn(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function jC(n,e,t=null){const i=new k(n,t);return $C(e).applyToMesh(i,e.updatable),i}function qC(n,e,t={},i=null){const r=t.width||10,s=t.height||10,a=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new fe(.3,.59,.11),u=t.alphaFilter||0,h=t.updatable,f=t.onReady;i=i||$e.LastCreatedScene;const d=new Rc(n,i);d._subdivisionsX=a,d._subdivisionsY=a,d._width=r,d._height=s,d._maxX=d._width/2,d._maxZ=d._height/2,d._minX=-d._maxX,d._minZ=-d._maxZ,d._setReady(!1);let p;t.passHeightBufferInCallback&&(p=new Float32Array((a+1)*(a+1)));const _=(g,E,v)=>{KC({width:r,height:s,subdivisions:a,minHeight:o,maxHeight:l,colorFilter:c,buffer:g,bufferWidth:E,bufferHeight:v,alphaFilter:u,heightBuffer:p}).applyToMesh(d,h),f&&f(d,p),d._setReady(!0)};if(typeof e=="string"){const g=E=>{const v=E.width,x=E.height;if(i.isDisposed)return;const A=i==null?void 0:i.getEngine().resizeImageBitmap(E,v,x);_(A,v,x)};J.LoadImage(e,g,t.onError?t.onError:()=>{},i.offlineProvider)}else _(e.data,e.width,e.height);return d}de.CreateGround=sn;de.CreateTiledGround=$C;de.CreateGroundFromHeightMap=KC;k.CreateGround=(n,e,t,i,r,s)=>Jp(n,{width:e,height:t,subdivisions:i,updatable:s},r);k.CreateTiledGround=(n,e,t,i,r,s,a,o,l)=>jC(n,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:s,precision:a,updatable:l},o);k.CreateGroundFromHeightMap=(n,e,t,i,r,s,a,o,l,c,u)=>qC(n,e,{width:t,height:i,subdivisions:r,minHeight:s,maxHeight:a,updatable:l,onReady:c,alphaFilter:u},o);function ZC(n){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[];let s=[];const a=n.width||n.size||1,o=n.height||n.size||1,l=n.depth||n.size||1,c=n.wrap||!1;let u=n.topBaseAt===void 0?1:n.topBaseAt,h=n.bottomBaseAt===void 0?0:n.bottomBaseAt;u=(u+4)%4,h=(h+4)%4;const f=[2,0,3,1],d=[2,0,1,3];let p=f[u],_=d[h],g=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],g=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let y=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],P=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const D=[17,18,19,16],F=[22,23,20,21];for(;p>0;)y.unshift(y.pop()),D.unshift(D.pop()),p--;for(;_>0;)P.unshift(P.pop()),F.unshift(F.pop()),_--;y=y.flat(),P=P.flat(),g=g.concat(y).concat(P),t.push(D[0],D[2],D[3],D[0],D[1],D[2]),t.push(F[0],F[2],F[3],F[0],F[1],F[2])}const E=[a/2,o/2,l/2];s=g.reduce((y,P,D)=>y.concat(P*E[D%3]),[]);const v=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,x=n.faceUV||new Array(6),A=n.faceColors,T=[];for(let y=0;y<6;y++)x[y]===void 0&&(x[y]=new We(0,0,1,1)),A&&A[y]===void 0&&(A[y]=new Be(1,1,1,1));for(let y=0;y<6;y++)if(r.push(x[y].z,x[y].w),r.push(x[y].x,x[y].w),r.push(x[y].x,x[y].y),r.push(x[y].z,x[y].y),A)for(let P=0;P<4;P++)T.push(A[y].r,A[y].g,A[y].b,A[y].a);de._ComputeSides(v,s,t,i,r,n.frontUVs,n.backUVs);const C=new de;if(C.indices=t,C.positions=s,C.normals=i,C.uvs=r,A){const y=v===de.DOUBLESIDE?T.concat(T):T;C.colors=y}return C}function yw(n){const e=n.width||n.size||1,t=n.height||n.size||1,i=n.depth||n.size||1,r=(n.widthSegments||n.segments||1)|0,s=(n.heightSegments||n.segments||1)|0,a=(n.depthSegments||n.segments||1)|0,o=new O,l=new O,c=new O,u=sn({width:e,height:i,subdivisionsX:r,subdivisionsY:a});O.TranslationToRef(0,-t/2,0,l),O.RotationZToRef(Math.PI,o),o.multiplyToRef(l,c),u.transform(c);const h=sn({width:e,height:i,subdivisionsX:r,subdivisionsY:a});O.TranslationToRef(0,t/2,0,c),h.transform(c);const f=sn({width:t,height:i,subdivisionsX:s,subdivisionsY:a});O.TranslationToRef(-e/2,0,0,l),O.RotationZToRef(Math.PI/2,o),o.multiplyToRef(l,c),f.transform(c);const d=sn({width:t,height:i,subdivisionsX:s,subdivisionsY:a});O.TranslationToRef(e/2,0,0,l),O.RotationZToRef(-Math.PI/2,o),o.multiplyToRef(l,c),d.transform(c);const p=sn({width:e,height:t,subdivisionsX:r,subdivisionsY:s});O.TranslationToRef(0,0,-i/2,l),O.RotationXToRef(-Math.PI/2,o),o.multiplyToRef(l,c),p.transform(c);const _=sn({width:e,height:t,subdivisionsX:r,subdivisionsY:s});return O.TranslationToRef(0,0,i/2,l),O.RotationXToRef(Math.PI/2,o),o.multiplyToRef(l,c),_.transform(c),u.merge([h,d,f,p,_],!0),u}function fl(n,e={},t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,ZC(e).applyToMesh(i,e.updatable),i}de.CreateBox=ZC;k.CreateBox=(n,e,t=null,i,r)=>fl(n,{size:e,sideOrientation:r,updatable:i},t);function Wl(n){const e=n.pattern||k.NO_FLIP,t=n.tileWidth||n.tileSize||1,i=n.tileHeight||n.tileSize||1,r=n.alignHorizontal||0,s=n.alignVertical||0,a=n.width||n.size||1,o=Math.floor(a/t);let l=a-o*t;const c=n.height||n.size||1,u=Math.floor(c/i);let h=c-u*i;const f=t*o/2,d=i*u/2;let p=0,_=0,g=0,E=0,v=0,x=0;if(l>0||h>0){switch(g=-f,E=-d,v=f,x=d,r){case k.CENTER:l/=2,g-=l,v+=l;break;case k.LEFT:v+=l,p=-l/2;break;case k.RIGHT:g-=l,p=l/2;break}switch(s){case k.CENTER:h/=2,E-=h,x+=h;break;case k.BOTTOM:x+=h,_=-h/2;break;case k.TOP:E-=h,_=h/2;break}}const A=[],T=[],C=[];C[0]=[0,0,1,0,1,1,0,1],C[1]=[0,0,1,0,1,1,0,1],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(C[1]=[1,1,0,1,0,0,1,0]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(C[1]=[1,0,0,0,0,1,1,1]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(C[1]=[0,1,1,1,1,0,0,0]);let y=[];const P=[],D=[];let F=0;for(let ae=0;ae<u;ae++)for(let le=0;le<o;le++)A.push(-f+le*t+p,-d+ae*i+_,0),A.push(-f+(le+1)*t+p,-d+ae*i+_,0),A.push(-f+(le+1)*t+p,-d+(ae+1)*i+_,0),A.push(-f+le*t+p,-d+(ae+1)*i+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?y=y.concat(C[(le%2+ae%2)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?y=y.concat(C[ae%2]):y=y.concat(C[0]),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),F+=4;if(l>0||h>0){const ae=h>0&&(s===k.CENTER||s===k.TOP),le=h>0&&(s===k.CENTER||s===k.BOTTOM),oe=l>0&&(r===k.CENTER||r===k.RIGHT),ge=l>0&&(r===k.CENTER||r===k.LEFT);let Ee=[],ne,j,L,Y;if(ae&&oe&&(A.push(g+p,E+_,0),A.push(-f+p,E+_,0),A.push(-f+p,E+h+_,0),A.push(g+p,E+h+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,ne=1-l/t,j=1-h/i,L=1,Y=1,Ee=[ne,j,L,j,L,Y,ne,Y],e===k.ROTATE_ROW&&(Ee=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),e===k.FLIP_ROW&&(Ee=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),e===k.FLIP_N_ROTATE_ROW&&(Ee=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]),y=y.concat(Ee),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ae&&ge&&(A.push(f+p,E+_,0),A.push(v+p,E+_,0),A.push(v+p,E+h+_,0),A.push(f+p,E+h+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,ne=0,j=1-h/i,L=l/t,Y=1,Ee=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_ROW||e===k.ROTATE_TILE&&o%2===0)&&(Ee=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_ROW||e===k.FLIP_TILE&&o%2===0)&&(Ee=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_ROW||e===k.FLIP_N_ROTATE_TILE&&o%2===0)&&(Ee=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]),y=y.concat(Ee),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),le&&oe&&(A.push(g+p,d+_,0),A.push(-f+p,d+_,0),A.push(-f+p,x+_,0),A.push(g+p,x+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,ne=1-l/t,j=0,L=1,Y=h/i,Ee=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_ROW&&u%2===1||e===k.ROTATE_TILE&&u%1===0)&&(Ee=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_ROW&&u%2===1||e===k.FLIP_TILE&&u%2===0)&&(Ee=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_ROW&&u%2===1||e===k.FLIP_N_ROTATE_TILE&&u%2===0)&&(Ee=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]),y=y.concat(Ee),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),le&&ge&&(A.push(f+p,d+_,0),A.push(v+p,d+_,0),A.push(v+p,x+_,0),A.push(f+p,x+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,ne=0,j=0,L=l/t,Y=h/i,Ee=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_ROW&&u%2===1||e===k.ROTATE_TILE&&(u+o)%2===1)&&(Ee=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_ROW&&u%2===1||e===k.FLIP_TILE&&(u+o)%2===1)&&(Ee=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_ROW&&u%2===1||e===k.FLIP_N_ROTATE_TILE&&(u+o)%2===1)&&(Ee=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]),y=y.concat(Ee),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ae){const te=[];ne=0,j=1-h/i,L=1,Y=1,te[0]=[ne,j,L,j,L,Y,ne,Y],te[1]=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(te[1]=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(te[1]=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(te[1]=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]);for(let De=0;De<o;De++)A.push(-f+De*t+p,E+_,0),A.push(-f+(De+1)*t+p,E+_,0),A.push(-f+(De+1)*t+p,E+h+_,0),A.push(-f+De*t+p,E+h+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?y=y.concat(te[(De+1)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?y=y.concat(te[1]):y=y.concat(te[0]),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(le){const te=[];ne=0,j=0,L=1,Y=h/i,te[0]=[ne,j,L,j,L,Y,ne,Y],te[1]=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(te[1]=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(te[1]=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(te[1]=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]);for(let De=0;De<o;De++)A.push(-f+De*t+p,x-h+_,0),A.push(-f+(De+1)*t+p,x-h+_,0),A.push(-f+(De+1)*t+p,x+_,0),A.push(-f+De*t+p,x+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?y=y.concat(te[(De+u)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?y=y.concat(te[u%2]):y=y.concat(te[0]),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(oe){const te=[];ne=1-l/t,j=0,L=1,Y=1,te[0]=[ne,j,L,j,L,Y,ne,Y],te[1]=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(te[1]=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(te[1]=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(te[1]=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]);for(let De=0;De<u;De++)A.push(g+p,-d+De*i+_,0),A.push(g+l+p,-d+De*i+_,0),A.push(g+l+p,-d+(De+1)*i+_,0),A.push(g+p,-d+(De+1)*i+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?y=y.concat(te[(De+1)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?y=y.concat(te[De%2]):y=y.concat(te[0]),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ge){const te=[];ne=0,j=0,L=l/i,Y=1,te[0]=[ne,j,L,j,L,Y,ne,Y],te[1]=[ne,j,L,j,L,Y,ne,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(te[1]=[1-ne,1-j,1-L,1-j,1-L,1-Y,1-ne,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(te[1]=[1-ne,j,1-L,j,1-L,Y,1-ne,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(te[1]=[ne,1-j,L,1-j,L,1-Y,ne,1-Y]);for(let De=0;De<u;De++)A.push(v-l+p,-d+De*i+_,0),A.push(v+p,-d+De*i+_,0),A.push(v+p,-d+(De+1)*i+_,0),A.push(v-l+p,-d+(De+1)*i+_,0),D.push(F,F+1,F+3,F+1,F+2,F+3),F+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?y=y.concat(te[(De+o)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?y=y.concat(te[De%2]):y=y.concat(te[0]),P.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),T.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const W=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE;de._ComputeSides(W,A,D,T,y,n.frontUVs,n.backUVs);const H=new de;H.indices=D,H.positions=A,H.normals=T,H.uvs=y;const ue=W===de.DOUBLESIDE?P.concat(P):P;return H.colors=ue,H}function bw(n,e,t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Wl(e).applyToMesh(i,e.updatable),i}de.CreateTiledPlane=Wl;function QC(n){const t=n.faceUV||new Array(6),i=n.faceColors,r=n.pattern||k.NO_FLIP,s=n.width||n.size||1,a=n.height||n.size||1,o=n.depth||n.size||1,l=n.tileWidth||n.tileSize||1,c=n.tileHeight||n.tileSize||1,u=n.alignHorizontal||0,h=n.alignVertical||0,f=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE;for(let L=0;L<6;L++)t[L]===void 0&&(t[L]=new We(0,0,1,1)),i&&i[L]===void 0&&(i[L]=new Be(1,1,1,1));const d=s/2,p=a/2,_=o/2,g=[];for(let L=0;L<2;L++)g[L]=Wl({pattern:r,tileWidth:l,tileHeight:c,width:s,height:a,alignVertical:h,alignHorizontal:u,sideOrientation:f});for(let L=2;L<4;L++)g[L]=Wl({pattern:r,tileWidth:l,tileHeight:c,width:o,height:a,alignVertical:h,alignHorizontal:u,sideOrientation:f});let E=h;h===k.BOTTOM?E=k.TOP:h===k.TOP&&(E=k.BOTTOM);for(let L=4;L<6;L++)g[L]=Wl({pattern:r,tileWidth:l,tileHeight:c,width:s,height:o,alignVertical:E,alignHorizontal:u,sideOrientation:f});let v=[],x=[],A=[],T=[];const C=[],y=[],P=[],D=[];let F=0,W=0;for(let L=0;L<6;L++){const Y=g[L].positions.length;y[L]=[],P[L]=[];for(let te=0;te<Y/3;te++)y[L].push(new m(g[L].positions[3*te],g[L].positions[3*te+1],g[L].positions[3*te+2])),P[L].push(new m(g[L].normals[3*te],g[L].normals[3*te+1],g[L].normals[3*te+2]));F=g[L].uvs.length,D[L]=[];for(let te=0;te<F;te+=2)D[L][te]=t[L].x+(t[L].z-t[L].x)*g[L].uvs[te],D[L][te+1]=t[L].y+(t[L].w-t[L].y)*g[L].uvs[te+1];if(A=A.concat(D[L]),T=T.concat(g[L].indices.map(te=>te+W)),W+=y[L].length,i)for(let te=0;te<4;te++)C.push(i[L].r,i[L].g,i[L].b,i[L].a)}const H=new m(0,0,_),ue=O.RotationY(Math.PI);v=y[0].map(L=>m.TransformNormal(L,ue).add(H)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[]),x=P[0].map(L=>m.TransformNormal(L,ue)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[]),v=v.concat(y[1].map(L=>L.subtract(H)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[])),x=x.concat(P[1].map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[]));const ae=new m(d,0,0),le=O.RotationY(-Math.PI/2);v=v.concat(y[2].map(L=>m.TransformNormal(L,le).add(ae)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[])),x=x.concat(P[2].map(L=>m.TransformNormal(L,le)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[]));const oe=O.RotationY(Math.PI/2);v=v.concat(y[3].map(L=>m.TransformNormal(L,oe).subtract(ae)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[])),x=x.concat(P[3].map(L=>m.TransformNormal(L,oe)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[]));const ge=new m(0,p,0),Ee=O.RotationX(Math.PI/2);v=v.concat(y[4].map(L=>m.TransformNormal(L,Ee).add(ge)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[])),x=x.concat(P[4].map(L=>m.TransformNormal(L,Ee)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[]));const ne=O.RotationX(-Math.PI/2);v=v.concat(y[5].map(L=>m.TransformNormal(L,ne).subtract(ge)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[])),x=x.concat(P[5].map(L=>m.TransformNormal(L,ne)).map(L=>[L.x,L.y,L.z]).reduce((L,Y)=>L.concat(Y),[])),de._ComputeSides(f,v,T,x,A);const j=new de;if(j.indices=T,j.positions=v,j.normals=x,j.uvs=A,i){const L=f===de.DOUBLESIDE?C.concat(C):C;j.colors=L}return j}function Rw(n,e,t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,QC(e).applyToMesh(i,e.updatable),i}de.CreateTiledBox=QC;function e_(n){const e=[],t=[],i=[],r=[],s=n.diameter||1,a=n.thickness||.5,o=(n.tessellation||16)|0,l=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,c=o+1;for(let h=0;h<=o;h++){const f=h/o,d=h*Math.PI*2/o-Math.PI/2,p=O.Translation(s/2,0,0).multiply(O.RotationY(d));for(let _=0;_<=o;_++){const g=1-_/o,E=_*Math.PI*2/o+Math.PI,v=Math.cos(E),x=Math.sin(E);let A=new m(v,x,0),T=A.scale(a/2);const C=new se(f,g);T=m.TransformCoordinates(T,p),A=m.TransformNormal(A,p),t.push(T.x,T.y,T.z),i.push(A.x,A.y,A.z),r.push(C.x,C.y);const y=(h+1)%c,P=(_+1)%c;e.push(h*c+_),e.push(h*c+P),e.push(y*c+_),e.push(h*c+P),e.push(y*c+P),e.push(y*c+_)}}de._ComputeSides(l,t,e,i,r,n.frontUVs,n.backUVs);const u=new de;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function JC(n,e={},t){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,e_(e).applyToMesh(i,e.updatable),i}de.CreateTorus=e_;k.CreateTorus=(n,e,t,i,r,s,a)=>JC(n,{diameter:e,thickness:t,tessellation:i,sideOrientation:a,updatable:s},r);function eA(n){const e=[],t=[],i=[],r=[],s=n.radius||2,a=n.tube||.5,o=n.radialSegments||32,l=n.tubularSegments||32,c=n.p||2,u=n.q||3,h=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,f=g=>{const E=Math.cos(g),v=Math.sin(g),x=u/c*g,A=Math.cos(x),T=s*(2+A)*.5*E,C=s*(2+A)*v*.5,y=s*Math.sin(x)*.5;return new m(T,C,y)};let d,p;for(d=0;d<=o;d++){const E=d%o/o*2*c*Math.PI,v=f(E),x=f(E+.01),A=x.subtract(v);let T=x.add(v);const C=m.Cross(A,T);for(T=m.Cross(C,A),C.normalize(),T.normalize(),p=0;p<l;p++){const P=p%l/l*2*Math.PI,D=-a*Math.cos(P),F=a*Math.sin(P);t.push(v.x+D*T.x+F*C.x),t.push(v.y+D*T.y+F*C.y),t.push(v.z+D*T.z+F*C.z),r.push(d/o),r.push(p/l)}}for(d=0;d<o;d++)for(p=0;p<l;p++){const g=(p+1)%l,E=d*l+p,v=(d+1)*l+p,x=(d+1)*l+g,A=d*l+g;e.push(A),e.push(v),e.push(E),e.push(A),e.push(x),e.push(v)}de.ComputeNormals(t,e,i),de._ComputeSides(h,t,e,i,r,n.frontUVs,n.backUVs);const _=new de;return _.indices=e,_.positions=t,_.normals=i,_.uvs=r,_}function tA(n,e={},t){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,eA(e).applyToMesh(i,e.updatable),i}de.CreateTorusKnot=eA;k.CreateTorusKnot=(n,e,t,i,r,s,a,o,l,c)=>tA(n,{radius:e,tube:t,radialSegments:i,tubularSegments:r,p:s,q:a,sideOrientation:c,updatable:l},o);class Pw extends se{constructor(e,t){super(e.x,e.y),this.index=t}}class Of{constructor(){this.elements=[]}add(e){const t=[];return e.forEach(i=>{const r=new Pw(i,this.elements.length);t.push(r),this.elements.push(r)}),t}computeBounds(){const e=new se(this.elements[0].x,this.elements[0].y),t=new se(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class Mw{_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){this._points=new Of,this._outlinepoints=new Of,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||$e.LastCreatedScene;let s;t instanceof Ju?s=t.getPoints():s=t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),typeof this.bjsEarcut>"u"&&w.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);const t=new Of;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const r=new k(this._name,this._scene),s=this.buildVertexData(t,i);return r.setVerticesData(b.PositionKind,s.positions,e),r.setVerticesData(b.NormalKind,s.normals,e),r.setVerticesData(b.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){const i=new de,r=[],s=[],a=[],o=this._points.computeBounds();this._points.elements.forEach(u=>{r.push(0,1,0),s.push(u.x,0,u.y),a.push((u.x-o.min.x)/o.width,(u.y-o.min.y)/o.height)});const l=[],c=this.bjsEarcut(this._epoints,this._eholes,2);for(let u=0;u<c.length;u++)l.push(c[u]);if(e>0){const u=s.length/3;this._points.elements.forEach(f=>{r.push(0,-1,0),s.push(f.x,-e,f.y),a.push(1-(f.x-o.min.x)/o.width,1-(f.y-o.min.y)/o.height)});const h=l.length;for(let f=0;f<h;f+=3){const d=l[f+0],p=l[f+1],_=l[f+2];l.push(_+u),l.push(p+u),l.push(d+u)}this._addSide(s,r,a,l,o,this._outlinepoints,e,!1,t),this._holes.forEach(f=>{this._addSide(s,r,a,l,o,f,e,!0,t)})}return i.indices=l,i.positions=s,i.normals=r,i.uvs=a,i}_addSide(e,t,i,r,s,a,o,l,c){let u=e.length/3,h=0;for(let f=0;f<a.elements.length;f++){const d=a.elements[f],p=a.elements[(f+1)%a.elements.length];e.push(d.x,0,d.y),e.push(d.x,-o,d.y),e.push(p.x,0,p.y),e.push(p.x,-o,p.y);const _=a.elements[(f+a.elements.length-1)%a.elements.length],g=a.elements[(f+2)%a.elements.length];let E=new m(-(p.y-d.y),0,p.x-d.x),v=new m(-(d.y-_.y),0,d.x-_.x),x=new m(-(g.y-p.y),0,g.x-p.x);l||(E=E.scale(-1),v=v.scale(-1),x=x.scale(-1));const A=E.normalizeToNew();let T=v.normalizeToNew(),C=x.normalizeToNew();const y=m.Dot(T,A);y>c?y<pt-1?T=new m(d.x,0,d.y).subtract(new m(p.x,0,p.y)).normalize():T=v.add(E).normalize():T=A;const P=m.Dot(x,E);P>c?P<pt-1?C=new m(p.x,0,p.y).subtract(new m(d.x,0,d.y)).normalize():C=x.add(E).normalize():C=A,i.push(h/s.width,0),i.push(h/s.width,1),h+=E.length(),i.push(h/s.width,0),i.push(h/s.width,1),t.push(T.x,T.y,T.z),t.push(T.x,T.y,T.z),t.push(C.x,C.y,C.z),t.push(C.x,C.y,C.z),l?(r.push(u),r.push(u+2),r.push(u+1),r.push(u+1),r.push(u+2),r.push(u+3)):(r.push(u),r.push(u+1),r.push(u+2),r.push(u+1),r.push(u+3),r.push(u+2)),u+=4}}}function iA(n,e,t,i,r,s,a){const o=t||new Array(3),l=i,c=[],u=a||!1;for(let D=0;D<3;D++)o[D]===void 0&&(o[D]=new We(0,0,1,1)),l&&l[D]===void 0&&(l[D]=new Be(1,1,1,1));const h=n.getVerticesData(b.PositionKind),f=n.getVerticesData(b.NormalKind),d=n.getVerticesData(b.UVKind),p=n.getIndices(),_=h.length/9;let g=0,E=0,v=0,x=0,A=0;const T=[0];if(u)for(let D=_;D<h.length/3;D+=4)E=h[3*(D+2)]-h[3*D],v=h[3*(D+2)+2]-h[3*D+2],x=Math.sqrt(E*E+v*v),A+=x,T.push(A);let C=0,y=0;for(let D=0;D<f.length;D+=3)Math.abs(f[D+1])<.001&&(y=1),Math.abs(f[D+1]-1)<.001&&(y=0),Math.abs(f[D+1]+1)<.001&&(y=2),C=D/3,y===1?(g=C-_,g%4<1.5?u?d[2*C]=o[y].x+(o[y].z-o[y].x)*T[Math.floor(g/4)]/A:d[2*C]=o[y].x:u?d[2*C]=o[y].x+(o[y].z-o[y].x)*T[Math.floor(g/4)+1]/A:d[2*C]=o[y].z,g%2===0?d[2*C+1]=o[y].w:d[2*C+1]=o[y].y):(d[2*C]=(1-d[2*C])*o[y].x+d[2*C]*o[y].z,d[2*C+1]=(1-d[2*C+1])*o[y].y+d[2*C+1]*o[y].w),l&&c.push(l[y].r,l[y].g,l[y].b,l[y].a);de._ComputeSides(e,h,p,f,d,r,s);const P=new de;if(P.indices=p,P.positions=h,P.normals=f,P.uvs=d,l){const D=e===de.DOUBLESIDE?c.concat(c):c;P.colors=D}return P}function t_(n,e,t=null,i=earcut){e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation);const r=e.shape,s=e.holes||[],a=e.depth||0,o=e.smoothingThreshold||2,l=[];let c=[];for(let p=0;p<r.length;p++)l[p]=new se(r[p].x,r[p].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();const h=new Mw(n,l,t||$e.LastCreatedScene,i);for(let p=0;p<s.length;p++){c=[];for(let _=0;_<s[p].length;_++)c.push(new se(s[p][_].x,s[p][_].z));h.addHole(c)}const f=h.build(!1,a,o);return f._originalBuilderSideOrientation=e.sideOrientation,iA(f,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(f,e.updatable),f}function i_(n,e,t=null,i=earcut){return t_(n,e,t,i)}de.CreatePolygon=iA;k.CreatePolygon=(n,e,t,i,r,s,a=earcut)=>t_(n,{shape:e,holes:i,updatable:r,sideOrientation:s},t,a);k.ExtrudePolygon=(n,e,t,i,r,s,a,o=earcut)=>i_(n,{shape:e,holes:r,depth:t,updatable:s,sideOrientation:a},i,o);function rA(n,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,s=e.shape,a=e.radius||1,o=e.tessellation||64,l=e.clip||0,c=e.updatable,u=k._GetDefaultSideOrientation(e.sideOrientation),h=e.cap||k.NO_CAP,f=Math.PI*2,d=[],p=e.invertUV||!1;let _=0,g=0;const E=f/o*i;let v,x;for(_=0;_<=o-l;_++){for(x=[],(h==k.CAP_START||h==k.CAP_ALL)&&(x.push(new m(0,s[0].y,0)),x.push(new m(Math.cos(_*E)*s[0].x*a,s[0].y,Math.sin(_*E)*s[0].x*a))),g=0;g<s.length;g++)v=new m(Math.cos(_*E)*s[g].x*a,s[g].y,Math.sin(_*E)*s[g].x*a),x.push(v);(h==k.CAP_END||h==k.CAP_ALL)&&(x.push(new m(Math.cos(_*E)*s[s.length-1].x*a,s[s.length-1].y,Math.sin(_*E)*s[s.length-1].x*a)),x.push(new m(0,s[s.length-1].y,0))),d.push(x)}return ro(n,{pathArray:d,closeArray:r,sideOrientation:u,updatable:c,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}k.CreateLathe=(n,e,t,i,r,s,a)=>rA(n,{shape:e,radius:t,tessellation:i,sideOrientation:a,updatable:s},r);function sA(n){const e=[],t=[],i=[],r=[],s=n.width||n.size||1,a=n.height||n.size||1,o=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,l=s/2,c=a/2;t.push(-l,-c,0),i.push(0,0,-1),r.push(0,0),t.push(l,-c,0),i.push(0,0,-1),r.push(1,0),t.push(l,c,0),i.push(0,0,-1),r.push(1,1),t.push(-l,c,0),i.push(0,0,-1),r.push(0,1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),de._ComputeSides(o,t,e,i,r,n.frontUVs,n.backUVs);const u=new de;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function nA(n,e={},t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,sA(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}de.CreatePlane=sA;k.CreatePlane=(n,e,t,i,r)=>nA(n,{size:e,width:e,height:e,sideOrientation:r,updatable:i},t);function aA(n,e,t=null){const i=e.path;let r=e.instance,s=1;e.radius!==void 0?s=e.radius:r&&(s=r._creationDataStorage.radius);const a=e.tessellation||64,o=e.radiusFunction||null;let l=e.cap||k.NO_CAP;const c=e.invertUV||!1,u=e.updatable,h=k._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const f=(E,v,x,A,T,C,y,P)=>{const D=v.getTangents(),F=v.getNormals(),W=v.getDistances(),ue=Math.PI*2/T*P,le=C||(()=>A);let oe,ge,Ee,ne;const j=B.Matrix[0];let L=y===k.NO_CAP||y===k.CAP_END?0:2;for(let te=0;te<E.length;te++){ge=le(te,W[te]),oe=Array(),Ee=F[te];for(let De=0;De<T;De++)O.RotationAxisToRef(D[te],ue*De,j),ne=oe[De]?oe[De]:m.Zero(),m.TransformCoordinatesToRef(Ee,j,ne),ne.scaleInPlace(ge).addInPlace(E[te]),oe[De]=ne;x[L]=oe,L++}const Y=(te,De)=>{const Ve=Array();for(let ve=0;ve<te;ve++)Ve.push(E[De]);return Ve};switch(y){case k.NO_CAP:break;case k.CAP_START:x[0]=Y(T,0),x[1]=x[2].slice(0);break;case k.CAP_END:x[L]=x[L-1].slice(0),x[L+1]=Y(T,E.length-1);break;case k.CAP_ALL:x[0]=Y(T,0),x[1]=x[2].slice(0),x[L]=x[L-1].slice(0),x[L+1]=Y(T,E.length-1);break}return x};let d,p;if(r){const E=r._creationDataStorage,v=e.arc||E.arc;return d=E.path3D.update(i),p=f(i,d,E.pathArray,s,E.tessellation,o,E.cap,v),r=ro("",{pathArray:p,instance:r}),E.path3D=d,E.pathArray=p,E.arc=v,E.radius=s,r}d=new ic(i);const _=new Array;l=l<0||l>3?0:l,p=f(i,d,_,s,a,o,l,e.arc);const g=ro(n,{pathArray:p,closePath:!0,closeArray:!1,updatable:u,sideOrientation:h,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return g._creationDataStorage.pathArray=p,g._creationDataStorage.path3D=d,g._creationDataStorage.tessellation=a,g._creationDataStorage.cap=l,g._creationDataStorage.arc=e.arc,g._creationDataStorage.radius=s,g}k.CreateTube=(n,e,t,i,r,s,a,o,l,c)=>aA(n,{path:e,radius:t,tessellation:i,radiusFunction:r,arc:1,cap:s,updatable:o,sideOrientation:l,instance:c},a);function oA(n){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const t=n.type&&(n.type<0||n.type>=e.length)?0:n.type||0,i=n.size,r=n.sizeX||i||1,s=n.sizeY||i||1,a=n.sizeZ||i||1,o=n.custom||e[t],l=o.face.length,c=n.faceUV||new Array(l),u=n.faceColors,h=n.flat===void 0?!0:n.flat,f=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,d=[],p=[],_=[],g=[],E=[];let v=0,x=0;const A=[];let T=0,C=0,y,P,D,F,W,H;if(h)for(C=0;C<l;C++)u&&u[C]===void 0&&(u[C]=new Be(1,1,1,1)),c&&c[C]===void 0&&(c[C]=new We(0,0,1,1));if(h)for(C=0;C<l;C++){const ae=o.face[C].length;for(D=2*Math.PI/ae,F=.5*Math.tan(D/2),W=.5,T=0;T<ae;T++)d.push(o.vertex[o.face[C][T]][0]*r,o.vertex[o.face[C][T]][1]*s,o.vertex[o.face[C][T]][2]*a),A.push(v),v++,y=c[C].x+(c[C].z-c[C].x)*(.5+F),P=c[C].y+(c[C].w-c[C].y)*(W-.5),g.push(y,P),H=F*Math.cos(D)-W*Math.sin(D),W=F*Math.sin(D)+W*Math.cos(D),F=H,u&&E.push(u[C].r,u[C].g,u[C].b,u[C].a);for(T=0;T<ae-2;T++)p.push(A[0+x],A[T+2+x],A[T+1+x]);x+=ae}else{for(T=0;T<o.vertex.length;T++)d.push(o.vertex[T][0]*r,o.vertex[T][1]*s,o.vertex[T][2]*a),g.push(0,0);for(C=0;C<l;C++)for(T=0;T<o.face[C].length-2;T++)p.push(o.face[C][0],o.face[C][T+2],o.face[C][T+1])}de.ComputeNormals(d,p,_),de._ComputeSides(f,d,p,_,g,n.frontUVs,n.backUVs);const ue=new de;return ue.positions=d,ue.indices=p,ue.normals=_,ue.uvs=g,u&&h&&(ue.colors=E),ue}function r_(n,e={},t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,oA(e).applyToMesh(i,e.updatable),i}de.CreatePolyhedron=oA;k.CreatePolyhedron=(n,e,t)=>r_(n,e,t);function s_(n){const e=n.sideOrientation||de.DEFAULTSIDE,t=n.radius||1,i=n.flat===void 0?!0:n.flat,r=(n.subdivisions||4)|0,s=n.radiusX||t,a=n.radiusY||t,o=n.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],u=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],h=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],f=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],d=138/1024,p=239/1024,_=60/1024,g=26/1024,E=-40/1024,v=20/1024,x=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],A=[],T=[],C=[],y=[];let P=0;const D=new Array(3),F=new Array(3);let W;for(W=0;W<3;W++)D[W]=m.Zero(),F[W]=se.Zero();for(let ue=0;ue<20;ue++){for(W=0;W<3;W++){const le=u[3*ue+W];D[W].copyFromFloats(c[3*h[le]],c[3*h[le]+1],c[3*h[le]+2]),D[W].normalize(),F[W].copyFromFloats(f[2*le]*d+_+x[ue]*E,f[2*le+1]*p+g+x[ue]*v)}const ae=(le,oe,ge,Ee)=>{const ne=m.Lerp(D[0],D[2],oe/r),j=m.Lerp(D[1],D[2],oe/r),L=r===oe?D[2]:m.Lerp(ne,j,le/(r-oe));L.normalize();let Y;if(i){const ve=m.Lerp(D[0],D[2],Ee/r),Me=m.Lerp(D[1],D[2],Ee/r);Y=m.Lerp(ve,Me,ge/(r-Ee))}else Y=new m(L.x,L.y,L.z);Y.x/=s,Y.y/=a,Y.z/=o,Y.normalize();const te=se.Lerp(F[0],F[2],oe/r),De=se.Lerp(F[1],F[2],oe/r),Ve=r===oe?F[2]:se.Lerp(te,De,le/(r-oe));T.push(L.x*s,L.y*a,L.z*o),C.push(Y.x,Y.y,Y.z),y.push(Ve.x,Ve.y),A.push(P),P++};for(let le=0;le<r;le++)for(let oe=0;oe+le<r;oe++)ae(oe,le,oe+1/3,le+1/3),ae(oe+1,le,oe+1/3,le+1/3),ae(oe,le+1,oe+1/3,le+1/3),oe+le+1<r&&(ae(oe+1,le,oe+2/3,le+2/3),ae(oe+1,le+1,oe+2/3,le+2/3),ae(oe,le+1,oe+2/3,le+2/3))}de._ComputeSides(e,T,A,C,y,n.frontUVs,n.backUVs);const H=new de;return H.indices=A,H.positions=T,H.normals=C,H.uvs=y,H}function lA(n,e={},t=null){const i=new k(n,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,s_(e).applyToMesh(i,e.updatable),i}de.CreateIcoSphere=s_;k.CreateIcoSphere=(n,e,t)=>lA(n,e,t);const Dw=new m(1,0,0),Ow=new m(-1,0,0),Nw=new m(0,1,0),Lw=new m(0,-1,0),Fw=new m(0,0,1),ww=new m(0,0,-1);class Fu{constructor(e=m.Zero(),t=m.Up(),i=se.Zero(),r=0,s=0,a=null,o=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=a,this.localNormalOverride=o,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){var e,t,i,r;return new Fu(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,(e=this.localPositionOverride)==null?void 0:e.slice(),(t=this.localNormalOverride)==null?void 0:t.slice(),(i=this.matrixIndicesOverride)==null?void 0:i.slice(),(r=this.matrixWeightsOverride)==null?void 0:r.slice())}}function cA(n,e,t){var oe,ge,Ee,ne;const i=!!e.skeleton,r=t.localMode||i,s=e.getIndices(),a=i?e.getPositionData(!0,!0):e.getVerticesData(b.PositionKind),o=i?e.getNormalsData(!0,!0):e.getVerticesData(b.NormalKind),l=r?i?e.getVerticesData(b.PositionKind):a:null,c=r?i?e.getVerticesData(b.NormalKind):o:null,u=e.getVerticesData(b.UVKind),h=i?e.getVerticesData(b.MatricesIndicesKind):null,f=i?e.getVerticesData(b.MatricesWeightsKind):null,d=i?e.getVerticesData(b.MatricesIndicesExtraKind):null,p=i?e.getVerticesData(b.MatricesWeightsExtraKind):null,_=t.position||m.Zero();let g=t.normal||m.Up();const E=t.size||m.One(),v=t.angle||0;if(!g){const j=new m(0,0,1),L=e.getScene().activeCamera,Y=m.TransformCoordinates(j,L.getWorldMatrix());g=L.globalPosition.subtract(Y)}const x=-Math.atan2(g.z,g.x)-Math.PI/2,A=Math.sqrt(g.x*g.x+g.z*g.z),T=Math.atan2(g.y,A),C=new de;C.indices=[],C.positions=[],C.normals=[],C.uvs=[],C.matricesIndices=i?[]:null,C.matricesWeights=i?[]:null,C.matricesIndicesExtra=d?[]:null,C.matricesWeightsExtra=p?[]:null;let y=0;const P=(j,L)=>{const Y=new Fu;if(!s||!a||!o)return Y;const te=s[j];if(Y.vertexIdx=te*3,Y.vertexIdxForBones=te*4,Y.position=new m(a[te*3],a[te*3+1],a[te*3+2]),m.TransformCoordinatesToRef(Y.position,L,Y.position),Y.normal=new m(o[te*3],o[te*3+1],o[te*3+2]),m.TransformNormalToRef(Y.normal,L,Y.normal),t.captureUVS&&u){const De=u[te*2+1];Y.uv=new se(u[te*2],De)}return Y},D=[0,0,0,0],F=(j,L)=>{if(j.length===0)return j;const Y=.5*Math.abs(m.Dot(E,L)),te=(ve,Me,Re,Pe)=>{for(let ft=0;ft<Pe;++ft)if(ve[Re+ft]===Me)return Re+ft;return-1},De=(ve,Me)=>{const Re=m.GetClipFactor(ve.position,Me.position,L,Y);let Pe=D,ft=D;if(h&&f){const bt=ve.matrixIndicesOverride?0:ve.vertexIdxForBones,Ht=ve.matrixIndicesOverride??h,Ut=ve.matrixWeightsOverride??f,yi=Me.matrixIndicesOverride?0:Me.vertexIdxForBones,Ct=Me.matrixIndicesOverride??h,Mi=Me.matrixWeightsOverride??f;Pe=[0,0,0,0],ft=[0,0,0,0];let di=0;for(let Ki=0;Ki<4;++Ki)if(Ut[bt+Ki]>0){const Di=te(Ct,Ht[bt+Ki],yi,4);Pe[di]=Ht[bt+Ki],ft[di]=ar(Ut[bt+Ki],Di>=0?Mi[Di]:0,Re),di++}for(let Ki=0;Ki<4&&di<4;++Ki){const Di=Ct[yi+Ki];te(Ht,Di,bt,4)===-1&&(Pe[di]=Di,ft[di]=ar(0,Mi[yi+Ki],Re),di++)}const Wr=ft[0]+ft[1]+ft[2]+ft[3];ft[0]/=Wr,ft[1]/=Wr,ft[2]/=Wr,ft[3]/=Wr}const Wt=ve.localPositionOverride?ve.localPositionOverride[0]:(l==null?void 0:l[ve.vertexIdx])??0,xe=ve.localPositionOverride?ve.localPositionOverride[1]:(l==null?void 0:l[ve.vertexIdx+1])??0,z=ve.localPositionOverride?ve.localPositionOverride[2]:(l==null?void 0:l[ve.vertexIdx+2])??0,K=Me.localPositionOverride?Me.localPositionOverride[0]:(l==null?void 0:l[Me.vertexIdx])??0,he=Me.localPositionOverride?Me.localPositionOverride[1]:(l==null?void 0:l[Me.vertexIdx+1])??0,Ce=Me.localPositionOverride?Me.localPositionOverride[2]:(l==null?void 0:l[Me.vertexIdx+2])??0,ye=ve.localNormalOverride?ve.localNormalOverride[0]:(c==null?void 0:c[ve.vertexIdx])??0,be=ve.localNormalOverride?ve.localNormalOverride[1]:(c==null?void 0:c[ve.vertexIdx+1])??0,Je=ve.localNormalOverride?ve.localNormalOverride[2]:(c==null?void 0:c[ve.vertexIdx+2])??0,qe=Me.localNormalOverride?Me.localNormalOverride[0]:(c==null?void 0:c[Me.vertexIdx])??0,Ge=Me.localNormalOverride?Me.localNormalOverride[1]:(c==null?void 0:c[Me.vertexIdx+1])??0,Le=Me.localNormalOverride?Me.localNormalOverride[2]:(c==null?void 0:c[Me.vertexIdx+2])??0,mt=ye+(qe-ye)*Re,it=be+(Ge-be)*Re,dt=Je+(Le-Je)*Re,xt=Math.sqrt(mt*mt+it*it+dt*dt);return new Fu(m.Lerp(ve.position,Me.position,Re),m.Lerp(ve.normal,Me.normal,Re).normalize(),se.Lerp(ve.uv,Me.uv,Re),-1,-1,l?[Wt+(K-Wt)*Re,xe+(he-xe)*Re,z+(Ce-z)*Re]:null,c?[mt/xt,it/xt,dt/xt]:null,Pe,ft)};let Ve=null;j.length>3&&(Ve=[]);for(let ve=0;ve<j.length;ve+=3){let Me=0,Re=null,Pe=null,ft=null,Wt=null;const xe=m.Dot(j[ve].position,L)-Y,z=m.Dot(j[ve+1].position,L)-Y,K=m.Dot(j[ve+2].position,L)-Y,he=xe>0,Ce=z>0,ye=K>0;switch(Me=(he?1:0)+(Ce?1:0)+(ye?1:0),Me){case 0:j.length>3?(Ve.push(j[ve]),Ve.push(j[ve+1]),Ve.push(j[ve+2])):Ve=j;break;case 1:if(Ve=Ve??new Array,he&&(Re=j[ve+1],Pe=j[ve+2],ft=De(j[ve],Re),Wt=De(j[ve],Pe)),Ce){Re=j[ve],Pe=j[ve+2],ft=De(j[ve+1],Re),Wt=De(j[ve+1],Pe),Ve.push(ft),Ve.push(Pe.clone()),Ve.push(Re.clone()),Ve.push(Pe.clone()),Ve.push(ft.clone()),Ve.push(Wt);break}ye&&(Re=j[ve],Pe=j[ve+1],ft=De(j[ve+2],Re),Wt=De(j[ve+2],Pe)),Re&&Pe&&ft&&Wt&&(Ve.push(Re.clone()),Ve.push(Pe.clone()),Ve.push(ft),Ve.push(Wt),Ve.push(ft.clone()),Ve.push(Pe.clone()));break;case 2:Ve=Ve??new Array,he||(Re=j[ve].clone(),Pe=De(Re,j[ve+1]),ft=De(Re,j[ve+2]),Ve.push(Re),Ve.push(Pe),Ve.push(ft)),Ce||(Re=j[ve+1].clone(),Pe=De(Re,j[ve+2]),ft=De(Re,j[ve]),Ve.push(Re),Ve.push(Pe),Ve.push(ft)),ye||(Re=j[ve+2].clone(),Pe=De(Re,j[ve]),ft=De(Re,j[ve+1]),Ve.push(Re),Ve.push(Pe),Ve.push(ft));break}}return Ve},W=e instanceof k?e:null,H=W==null?void 0:W._thinInstanceDataStorage.matrixData,ue=(W==null?void 0:W.thinInstanceCount)||1,ae=B.Matrix[0];ae.copyFrom(O.IdentityReadOnly);for(let j=0;j<ue;++j){if(W!=null&&W.hasThinInstances&&H){const ve=j*16;ae.setRowFromFloats(0,H[ve+0],H[ve+1],H[ve+2],H[ve+3]),ae.setRowFromFloats(1,H[ve+4],H[ve+5],H[ve+6],H[ve+7]),ae.setRowFromFloats(2,H[ve+8],H[ve+9],H[ve+10],H[ve+11]),ae.setRowFromFloats(3,H[ve+12],H[ve+13],H[ve+14],H[ve+15])}const L=O.RotationYawPitchRoll(x,T,v).multiply(O.Translation(_.x,_.y,_.z)),Y=O.Invert(L),te=e.getWorldMatrix(),De=ae.multiply(te).multiply(Y),Ve=new Array(3);for(let ve=0;ve<s.length;ve+=3){let Me=Ve;if(Me[0]=P(ve,De),Me[1]=P(ve+1,De),Me[2]=P(ve+2,De),!(t.cullBackFaces&&-Me[0].normal.z<=0&&-Me[1].normal.z<=0&&-Me[2].normal.z<=0)&&(Me=F(Me,Dw),!!Me&&(Me=F(Me,Ow),!!Me&&(Me=F(Me,Nw),!!Me&&(Me=F(Me,Lw),!!Me&&(Me=F(Me,Fw),!!Me&&(Me=F(Me,ww),!!Me)))))))for(let Re=0;Re<Me.length;Re++){const Pe=Me[Re];if(C.indices.push(y),r?(Pe.localPositionOverride?(C.positions[y*3]=Pe.localPositionOverride[0],C.positions[y*3+1]=Pe.localPositionOverride[1],C.positions[y*3+2]=Pe.localPositionOverride[2]):l&&(C.positions[y*3]=l[Pe.vertexIdx],C.positions[y*3+1]=l[Pe.vertexIdx+1],C.positions[y*3+2]=l[Pe.vertexIdx+2]),Pe.localNormalOverride?(C.normals[y*3]=Pe.localNormalOverride[0],C.normals[y*3+1]=Pe.localNormalOverride[1],C.normals[y*3+2]=Pe.localNormalOverride[2]):c&&(C.normals[y*3]=c[Pe.vertexIdx],C.normals[y*3+1]=c[Pe.vertexIdx+1],C.normals[y*3+2]=c[Pe.vertexIdx+2])):(Pe.position.toArray(C.positions,y*3),Pe.normal.toArray(C.normals,y*3)),C.matricesIndices&&C.matricesWeights&&(Pe.matrixIndicesOverride?(C.matricesIndices[y*4]=Pe.matrixIndicesOverride[0],C.matricesIndices[y*4+1]=Pe.matrixIndicesOverride[1],C.matricesIndices[y*4+2]=Pe.matrixIndicesOverride[2],C.matricesIndices[y*4+3]=Pe.matrixIndicesOverride[3]):(h&&(C.matricesIndices[y*4]=h[Pe.vertexIdxForBones],C.matricesIndices[y*4+1]=h[Pe.vertexIdxForBones+1],C.matricesIndices[y*4+2]=h[Pe.vertexIdxForBones+2],C.matricesIndices[y*4+3]=h[Pe.vertexIdxForBones+3]),d&&C.matricesIndicesExtra&&(C.matricesIndicesExtra[y*4]=d[Pe.vertexIdxForBones],C.matricesIndicesExtra[y*4+1]=d[Pe.vertexIdxForBones+1],C.matricesIndicesExtra[y*4+2]=d[Pe.vertexIdxForBones+2],C.matricesIndicesExtra[y*4+3]=d[Pe.vertexIdxForBones+3])),Pe.matrixWeightsOverride?(C.matricesWeights[y*4]=Pe.matrixWeightsOverride[0],C.matricesWeights[y*4+1]=Pe.matrixWeightsOverride[1],C.matricesWeights[y*4+2]=Pe.matrixWeightsOverride[2],C.matricesWeights[y*4+3]=Pe.matrixWeightsOverride[3]):(f&&(C.matricesWeights[y*4]=f[Pe.vertexIdxForBones],C.matricesWeights[y*4+1]=f[Pe.vertexIdxForBones+1],C.matricesWeights[y*4+2]=f[Pe.vertexIdxForBones+2],C.matricesWeights[y*4+3]=f[Pe.vertexIdxForBones+3]),p&&C.matricesWeightsExtra&&(C.matricesWeightsExtra[y*4]=p[Pe.vertexIdxForBones],C.matricesWeightsExtra[y*4+1]=p[Pe.vertexIdxForBones+1],C.matricesWeightsExtra[y*4+2]=p[Pe.vertexIdxForBones+2],C.matricesWeightsExtra[y*4+3]=p[Pe.vertexIdxForBones+3]))),t.captureUVS)Pe.uv.toArray(C.uvs,y*2);else{C.uvs.push(.5+Pe.position.x/E.x);const ft=.5+Pe.position.y/E.y;C.uvs.push(ft)}y++}}}C.indices.length===0&&(C.indices=null),C.positions.length===0&&(C.positions=null),C.normals.length===0&&(C.normals=null),C.uvs.length===0&&(C.uvs=null),((oe=C.matricesIndices)==null?void 0:oe.length)===0&&(C.matricesIndices=null),((ge=C.matricesWeights)==null?void 0:ge.length)===0&&(C.matricesWeights=null),((Ee=C.matricesIndicesExtra)==null?void 0:Ee.length)===0&&(C.matricesIndicesExtra=null),((ne=C.matricesWeightsExtra)==null?void 0:ne.length)===0&&(C.matricesWeightsExtra=null);const le=new k(n,e.getScene());return C.applyToMesh(le),r?(le.skeleton=e.skeleton,le.parent=e):(le.position=_.clone(),le.rotation=new m(T,x,v)),le.computeWorldMatrix(!0),le.refreshBoundingInfo(!0,!0),le}k.CreateDecal=(n,e,t,i,r,s)=>cA(n,e,{position:t,normal:i,size:r,angle:s});function n_(n={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(n.subdivisions?n.subdivisions:2,1)|0,t=Math.max(n.tessellation?n.tessellation:16,3)|0,i=Math.max(n.height?n.height:1,0),r=Math.max(n.radius?n.radius:.25,0),s=Math.max(n.capSubdivisions?n.capSubdivisions:6,1)|0,a=t,o=e,l=Math.max(n.radiusTop?n.radiusTop:r,0),c=Math.max(n.radiusBottom?n.radiusBottom:r,0),u=i-(l+c),h=0,f=2*Math.PI,d=Math.max(n.topCapSubdivisions?n.topCapSubdivisions:s,1),p=Math.max(n.bottomCapSubdivisions?n.bottomCapSubdivisions:s,1),_=Math.acos((c-l)/i);let g=[];const E=[],v=[],x=[];let A=0;const T=[],C=u*.5,y=Math.PI*.5;let P,D;const F=m.Zero(),W=m.Zero(),H=Math.cos(_),ue=Math.sin(_),ae=new se(l*ue,C+l*H).subtract(new se(c*ue,-C+c*H)).length(),le=l*_+ae+c*(y-_);let oe=0;for(D=0;D<=d;D++){const j=[],L=y-_*(D/d);oe+=l*_/d;const Y=Math.cos(L),te=Math.sin(L),De=Y*l;for(P=0;P<=a;P++){const Ve=P/a,ve=Ve*f+h,Me=Math.sin(ve),Re=Math.cos(ve);W.x=De*Me,W.y=C+te*l,W.z=De*Re,E.push(W.x,W.y,W.z),F.set(Y*Me,te,Y*Re),v.push(F.x,F.y,F.z),x.push(Ve,1-oe/le),j.push(A),A++}T.push(j)}const ge=i-l-c+H*l-H*c,Ee=ue*(c-l)/ge;for(D=1;D<=o;D++){const j=[];oe+=ae/o;const L=ue*(D*(c-l)/o+l);for(P=0;P<=a;P++){const Y=P/a,te=Y*f+h,De=Math.sin(te),Ve=Math.cos(te);W.x=L*De,W.y=C+H*l-D*ge/o,W.z=L*Ve,E.push(W.x,W.y,W.z),F.set(De,Ee,Ve).normalize(),v.push(F.x,F.y,F.z),x.push(Y,1-oe/le),j.push(A),A++}T.push(j)}for(D=1;D<=p;D++){const j=[],L=y-_-(Math.PI-_)*(D/p);oe+=c*_/p;const Y=Math.cos(L),te=Math.sin(L),De=Y*c;for(P=0;P<=a;P++){const Ve=P/a,ve=Ve*f+h,Me=Math.sin(ve),Re=Math.cos(ve);W.x=De*Me,W.y=-C+te*c,W.z=De*Re,E.push(W.x,W.y,W.z),F.set(Y*Me,te,Y*Re),v.push(F.x,F.y,F.z),x.push(Ve,1-oe/le),j.push(A),A++}T.push(j)}for(P=0;P<a;P++)for(D=0;D<d+o+p;D++){const j=T[D][P],L=T[D+1][P],Y=T[D+1][P+1],te=T[D][P+1];g.push(j),g.push(L),g.push(te),g.push(L),g.push(Y),g.push(te)}if(g=g.reverse(),n.orientation&&!n.orientation.equals(m.Up())){const j=new O;n.orientation.clone().scale(Math.PI*.5).cross(m.Up()).toQuaternion().toRotationMatrix(j);const L=m.Zero();for(let Y=0;Y<E.length;Y+=3)L.set(E[Y],E[Y+1],E[Y+2]),m.TransformCoordinatesToRef(L.clone(),j,L),E[Y]=L.x,E[Y+1]=L.y,E[Y+2]=L.z}const ne=new de;return ne.positions=E,ne.normals=v,ne.uvs=x,ne.indices=g,ne}function a_(n,e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new k(n,t);return n_(e).applyToMesh(i,e.updatable),i}k.CreateCapsule=(n,e,t)=>a_(n,e,t);de.CreateCapsule=n_;class Ti{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(e=Math.floor(e),w.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(t=Math.floor(t),w.Warn("y is not an integer, floor(y) used"))}clone(){return new Ti(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),w.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),w.Warn("n not an integer only floor(n) used"));const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),w.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),w.Warn("n is not an integer,   floor(n) used"));const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=m.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new Ti(0,0)}}class uA{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new vd("icosahedron","Regular",[[0,Hi,-1],[-Hi,1,0],[-1,0,-Hi],[1,0,-Hi],[Hi,1,0],[0,Hi,1],[-1,0,Hi],[-Hi,-1,0],[0,-Hi,-1],[Hi,-1,0],[1,0,Hi],[0,-Hi,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,r=this.n;let s=i,a=1,o=0;r!==0&&(s=tc(i,r)),a=i/s,o=r/s;let l,c,u,h,f;const d=Ti.Zero(),p=new Ti(i,r),_=new Ti(-r,i+r),g=Ti.Zero(),E=Ti.Zero(),v=Ti.Zero();let x=[],A,T,C,y;const P=[],D=this.vertByDist,F=(W,H,ue,ae)=>{A=W+"|"+ue,T=H+"|"+ae,A in t||T in t?A in t&&!(T in t)?t[T]=t[A]:T in t&&!(A in t)&&(t[A]=t[T]):(t[A]=e,t[T]=e,e++),D[ue][0]>2?P[t[A]]=[-D[ue][0],D[ue][1],t[A]]:P[t[A]]=[x[D[ue][0]],D[ue][1],t[A]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let W=0;W<20;W++){if(x=this.IDATA.face[W],u=x[2],h=x[1],f=x[0],C=d.x+"|"+d.y,A=W+"|"+C,A in t||(t[A]=u,P[u]=[x[D[C][0]],D[C][1]]),C=p.x+"|"+p.y,A=W+"|"+C,A in t||(t[A]=h,P[h]=[x[D[C][0]],D[C][1]]),C=_.x+"|"+_.y,A=W+"|"+C,A in t||(t[A]=f,P[f]=[x[D[C][0]],D[C][1]]),l=this.IDATA.edgematch[W][0],c=this.IDATA.edgematch[W][1],c==="B")for(let H=1;H<s;H++)E.x=i-H*(a+o),E.y=r+H*a,v.x=-H*o,v.y=H*(a+o),C=E.x+"|"+E.y,y=v.x+"|"+v.y,F(W,l,C,y);if(c==="O")for(let H=1;H<s;H++)v.x=-H*o,v.y=H*(a+o),g.x=H*a,g.y=H*o,C=v.x+"|"+v.y,y=g.x+"|"+g.y,F(W,l,C,y);if(l=this.IDATA.edgematch[W][2],c=this.IDATA.edgematch[W][3],c&&c==="A")for(let H=1;H<s;H++)g.x=H*a,g.y=H*o,E.x=i-(s-H)*(a+o),E.y=r+(s-H)*a,C=g.x+"|"+g.y,y=E.x+"|"+E.y,F(W,l,C,y);for(let H=0;H<this.vertices.length;H++)C=this.vertices[H].x+"|"+this.vertices[H].y,A=W+"|"+C,A in t||(t[A]=e++,D[C][0]>2?P[t[A]]=[-D[C][0],D[C][1],t[A]]:P[t[A]]=[x[D[C][0]],D[C][1],t[A]])}this.closestTo=P,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-i*(e-t)/r,this.cobv=i*(2*e+t)/r}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let r=this.min[i];r<this.max[i]+1;r++)r<this.max[i]&&r<this.max[i+1]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+r+"|"+(i+1),"|"+(r+1)+"|"+i]),i>0&&r<this.max[i-1]&&r+1<this.max[i]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+(r+1)+"|"+i,"|"+(r+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new Ti(-t,e+t);for(let r=1;r<e+t;r++){const s=new Ti(this.min[r],r),a=new Ti(this.min[r-1],r-1),o=new Ti(this.min[r+1],r+1),l=s.clone(),c=a.clone(),u=o.clone();l.rotate60About(i),c.rotate60About(i),u.rotate60About(i);const h=new Ti(this.max[l.y],l.y),f=new Ti(this.max[l.y-1],l.y-1),d=new Ti(this.max[l.y-1]-1,l.y-1);(l.x!==h.x||l.y!==h.y)&&(l.x!==f.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,h])):l.y===u.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,a,f]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,f,o])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,a,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,h])))}}mapABOBtoOBOA(){const e=new Ti(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===0&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new Ti(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===1&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],r=i[2],s=i[1],a=i[0],o=m.FromArray(this.IDATA.vertex[r]),l=m.FromArray(this.IDATA.vertex[s]),c=m.FromArray(this.IDATA.vertex[a]),u=l.subtract(o),h=c.subtract(o),f=u.scale(this.coau).add(h.scale(this.cobu)),d=u.scale(this.coav).add(h.scale(this.cobv));let p,_=B.Vector3[0];for(let g=0;g<this.cartesian.length;g++)_=f.scale(this.cartesian[g].x).add(d.scale(this.cartesian[g].y)).add(o),_.x,_.y,_.z,p=e+"|"+this.vertices[g].x+"|"+this.vertices[g].y,t.vertex[this.vecToidx[p]]=[_.x,_.y,_.z]}build(e,t){const i=[],r=Ti.Zero(),s=new Ti(e,t),a=new Ti(-t,e+t);i.push(r,s,a);for(let T=t;T<e+1;T++)for(let C=0;C<e+1-T;C++)i.push(new Ti(C,T));if(t>0){const T=tc(e,t),C=e/T,y=t/T;for(let D=1;D<T;D++)i.push(new Ti(D*C,D*y)),i.push(new Ti(-D*y,D*(C+y))),i.push(new Ti(e-D*(C+y),t+D*C));const P=e/t;for(let D=1;D<t;D++)for(let F=0;F<D*P;F++)i.push(new Ti(F,D)),i.push(new Ti(F,D).rotate120(e,t)),i.push(new Ti(F,D).rotateNeg120(e,t))}i.sort((T,C)=>T.x-C.x),i.sort((T,C)=>T.y-C.y);const o=new Array(e+t+1),l=new Array(e+t+1);for(let T=0;T<o.length;T++)o[T]=1/0,l[T]=-1/0;let c=0,u=0;const h=i.length;for(let T=0;T<h;T++)u=i[T].x,c=i[T].y,o[c]=Math.min(u,o[c]),l[c]=Math.max(u,l[c]);const f=(T,C)=>{const y=T.clone();return C==="A"&&y.rotateNeg120(e,t),C==="B"&&y.rotate120(e,t),y.x<0?y.y:y.x+y.y},d=[],p=[],_=[],g=[],E={},v=[];let x=-1,A=-1;for(let T=0;T<h;T++)d[T]=i[T].toCartesianOrigin(new Ti(0,0),.5),p[T]=f(i[T],"O"),_[T]=f(i[T],"A"),g[T]=f(i[T],"B"),p[T]===_[T]&&_[T]===g[T]?(x=3,A=p[T]):p[T]===_[T]?(x=4,A=p[T]):_[T]===g[T]?(x=5,A=_[T]):g[T]===p[T]&&(x=6,A=p[T]),p[T]<_[T]&&p[T]<g[T]&&(x=2,A=p[T]),_[T]<p[T]&&_[T]<g[T]&&(x=1,A=_[T]),g[T]<_[T]&&g[T]<p[T]&&(x=0,A=g[T]),v.push([x,A,i[T].x,i[T].y]);v.sort((T,C)=>T[2]-C[2]),v.sort((T,C)=>T[3]-C[3]),v.sort((T,C)=>T[1]-C[1]),v.sort((T,C)=>T[0]-C[0]);for(let T=0;T<v.length;T++)E[v[T][2]+"|"+v[T][3]]=[v[T][0],v[T][1],T];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=E,this.cartesian=d,this.min=o,this.max=l,this}}class vd{constructor(e,t,i,r){this.name=e,this.category=t,this.vertex=i,this.face=r}}class Ih extends vd{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(r=>t.vecToidx[e+r]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){const s=[];for(let a=0;a<3;a++)t.vertexTypes[r][a]===0?s.push(e+"|"+t.isoVecsABOB[r][a].x+"|"+t.isoVecsABOB[r][a].y):s.push(i+"|"+t.isoVecsABOB[r][a].x+"|"+t.isoVecsABOB[r][a].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){const s=[];for(let a=0;a<3;a++)t.vertexTypes[r][a]===1?s.push(e+"|"+t.isoVecsOBOA[r][a].x+"|"+t.isoVecsOBOA[r][a].y):s.push(i+"|"+t.isoVecsOBOA[r][a].x+"|"+t.isoVecsOBOA[r][a].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){const s=[];for(let a=0;a<3;a++)t.vertexTypes[r][a]===1?s.push(e+"|"+t.isoVecsBAOA[r][a].x+"|"+t.isoVecsBAOA[r][a].y):s.push(i+"|"+t.isoVecsBAOA[r][a].x+"|"+t.isoVecsBAOA[r][a].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){const t=[];for(let a=0;a<13;a++)t[a]=[];const i=e.closestTo;for(let a=0;a<i.length;a++)i[a][0]>-1?i[a][1]>0&&t[i[a][0]].push([a,i[a][1]]):t[12].push([a,i[a][0]]);const r=[];for(let a=0;a<12;a++)r[a]=a;let s=12;for(let a=0;a<12;a++){t[a].sort((o,l)=>o[1]-l[1]);for(let o=0;o<t[a].length;o++)r[t[a][o][0]]=s++}for(let a=0;a<t[12].length;a++)r[t[12][a][0]]=s++;for(let a=0;a<this.vertex.length;a++)this.vertex[a].push(r[a]);this.vertex.sort((a,o)=>a[3]-o[3]);for(let a=0;a<this.vertex.length;a++)this.vertex[a].pop();for(let a=0;a<this.face.length;a++)for(let o=0;o<this.face[a].length;o++)this.face[a][o]=r[this.face[a][o]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],r=[];let s=t.pop();r.push(s);let a=this.face[s].indexOf(e);a=(a+2)%3;let o=this.face[s][a];i.push(o);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(o)>-1?(a=(this.face[s].indexOf(o)+1)%3,o=this.face[s][a],i.push(o),r.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),r}toGoldbergPolyhedronData(){const e=new vd("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let c=0;c<t;c++)i[c]=[];for(let c=0;c<this.face.length;c++)for(let u=0;u<3;u++)i[this.face[c][u]].push(c);let r=0,s=0,a=0,o=[],l=[];this.adjacentFaces=[];for(let c=0;c<i.length;c++)e.face[c]=this.setOrder(c,i[c].concat([])),i[c].forEach(u=>{r=0,s=0,a=0,o=this.face[u];for(let h=0;h<3;h++)l=this.vertex[o[h]],r+=l[0],s+=l[1],a+=l[2];e.vertex[u]=[r/3,s/3,a/3]});return e}static BuildGeodesicData(e){const t=new Ih("Geodesic-m-n","Geodesic",[[0,Hi,-1],[-Hi,1,0],[-1,0,-Hi],[1,0,-Hi],[Hi,1,0],[0,Hi,1],[-1,0,Hi],[-Hi,-1,0],[0,-Hi,-1],[Hi,-1,0],[1,0,Hi],[0,-Hi,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let r=0;r<e.IDATA.face.length;r++)e.MapToFace(r,t),t.innerToData(r,e),e.IDATA.edgematch[r][1]==="B"&&t.mapABOBtoDATA(r,e),e.IDATA.edgematch[r][1]==="O"&&t.mapOBOAtoDATA(r,e),e.IDATA.edgematch[r][3]==="A"&&t.mapBAOAtoDATA(r,e);t.orderData(e);const i=1;return t.vertex=t.vertex.map(function(r){const s=r[0],a=r[1],o=r[2],l=Math.sqrt(s*s+a*a+o*o);return r[0]*=i/l,r[1]*=i/l,r[2]*=i/l,r}),t}}function Bw(n,e,t=null){let i=e.m||1;i!==Math.floor(i)&&(i=Math.floor(i),w.Warn("m not an integer only floor(m) used"));let r=e.n||0;if(r!==Math.floor(r)&&(r=Math.floor(r),w.Warn("n not an integer only floor(n) used")),r>i){const c=r;r=i,i=c,w.Warn("n > m therefore m and n swapped")}const s=new uA;s.build(i,r);const o={custom:Ih.BuildGeodesicData(s),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs};return r_(n,o,t)}function Vw(n,e){const t=n.size,i=n.sizeX||t||1,r=n.sizeY||t||1,s=n.sizeZ||t||1,a=n.sideOrientation===0?0:n.sideOrientation||de.DEFAULTSIDE,o=[],l=[],c=[],u=[];let h=1/0,f=-1/0,d=1/0,p=-1/0;for(let E=0;E<e.vertex.length;E++)h=Math.min(h,e.vertex[E][0]*i),f=Math.max(f,e.vertex[E][0]*i),d=Math.min(d,e.vertex[E][1]*r),p=Math.max(p,e.vertex[E][1]*r);let _=0;for(let E=0;E<e.face.length;E++){const v=e.face[E],x=m.FromArray(e.vertex[v[0]]),A=m.FromArray(e.vertex[v[2]]),T=m.FromArray(e.vertex[v[1]]),C=A.subtract(x),y=T.subtract(x),P=m.Cross(y,C).normalize();for(let D=0;D<v.length;D++){c.push(P.x,P.y,P.z);const F=e.vertex[v[D]];o.push(F[0]*i,F[1]*r,F[2]*s);const W=(F[1]*r-d)/(p-d);u.push((F[0]*i-h)/(f-h),W)}for(let D=0;D<v.length-2;D++)l.push(_,_+D+2,_+D+1);_+=v.length}de._ComputeSides(a,o,l,c,u);const g=new de;return g.positions=o,g.indices=l,g.normals=c,g.uvs=u,g}function Uw(n,e,t=null){const i=e.size,r=e.sizeX||i||1,s=e.sizeY||i||1,a=e.sizeZ||i||1;let o=e.m||1;o!==Math.floor(o)&&(o=Math.floor(o),w.Warn("m not an integer only floor(m) used"));let l=e.n||0;if(l!==Math.floor(l)&&(l=Math.floor(l),w.Warn("n not an integer only floor(n) used")),l>o){const p=l;l=o,o=p,w.Warn("n > m therefore m and n swapped")}const c=new uA;c.build(o,l);const u=Ih.BuildGeodesicData(c),h=u.toGoldbergPolyhedronData(),f=new Ah(n,t);e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),f._originalBuilderSideOrientation=e.sideOrientation,Vw(e,h).applyToMesh(f,e.updatable),f.goldbergData.nbSharedFaces=u.sharedNodes,f.goldbergData.nbUnsharedFaces=u.poleNodes,f.goldbergData.adjacentFaces=u.adjacentFaces,f.goldbergData.nbFaces=f.goldbergData.nbSharedFaces+f.goldbergData.nbUnsharedFaces,f.goldbergData.nbFacesAtPole=(f.goldbergData.nbUnsharedFaces-12)/12;for(let p=0;p<u.vertex.length;p++)f.goldbergData.faceCenters.push(m.FromArray(u.vertex[p])),f.goldbergData.faceCenters[p].x*=r,f.goldbergData.faceCenters[p].y*=s,f.goldbergData.faceCenters[p].z*=a,f.goldbergData.faceColors.push(new Be(1,1,1,1));for(let p=0;p<h.face.length;p++){const _=h.face[p],g=m.FromArray(h.vertex[_[0]]),E=m.FromArray(h.vertex[_[2]]),v=m.FromArray(h.vertex[_[1]]),x=E.subtract(g),A=v.subtract(g),T=m.Cross(A,x).normalize(),C=m.Cross(A,T).normalize();f.goldbergData.faceXaxis.push(A.normalize()),f.goldbergData.faceYaxis.push(T),f.goldbergData.faceZaxis.push(C)}return f}class kw{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new Ju(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,r){this._currentPath.addQuadraticCurveTo(e,t,i,r,this._resolution)}bezierCurveTo(e,t,i,r,s,a){this._currentPath.addBezierCurveTo(e,t,i,r,s,a,this._resolution)}extractHoles(){for(const e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){const e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}}function Gw(n,e,t,i,r,s){const a=s.glyphs[n]||s.glyphs["?"];if(!a)return null;const o=new kw(r);if(a.o){const l=a.o.split(" ");for(let c=0,u=l.length;c<u;)switch(l[c++]){case"m":{const f=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i;o.moveTo(f,d);break}case"l":{const f=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i;o.lineTo(f,d);break}case"q":{const f=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i,p=parseInt(l[c++])*e+t,_=parseInt(l[c++])*e+i;o.quadraticCurveTo(p,_,f,d);break}case"b":{const f=parseInt(l[c++])*e+t,d=parseInt(l[c++])*e+i,p=parseInt(l[c++])*e+t,_=parseInt(l[c++])*e+i,g=parseInt(l[c++])*e+t,E=parseInt(l[c++])*e+i;o.bezierCurveTo(p,_,g,E,f,d);break}}}return o.extractHoles(),{offsetX:a.ha*e,shapePath:o}}function hA(n,e,t,i){const r=Array.from(n),s=e/i.resolution,a=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*s,o=[];let l=0,c=0;for(let u=0;u<r.length;u++){const h=r[u];if(h===`
`)l=0,c-=a;else{const f=Gw(h,s,l,c,t,i);f&&(l+=f.offsetX,o.push(f.shapePath))}}return o}function zw(n,e,t,i={size:50,resolution:8,depth:1},r=null,s=earcut){var u,h;const a=hA(e,i.size||50,i.resolution||8,t),o=[];let l=0;for(const f of a){if(!f.paths.length)continue;const d=f.holes.slice();for(const p of f.paths){const _=[],g=[],E=p.getPoints();for(const A of E)g.push(new m(A.x,0,A.y));const v=d.slice();for(const A of v){const T=A.getPoints();let C=!1;for(const P of T)if(p.isPointInside(P)){C=!0;break}if(!C)continue;const y=[];for(const P of T)y.push(new m(P.x,0,P.y));_.push(y),d.splice(d.indexOf(A),1)}if(!_.length&&d.length)for(const A of d){const T=A.getPoints(),C=[];for(const y of T)C.push(new m(y.x,0,y.y));_.push(C)}const x=i_(n,{shape:g,holes:_.length?_:void 0,depth:i.depth||1,faceUV:i.faceUV||((u=i.perLetterFaceUV)==null?void 0:u.call(i,l)),faceColors:i.faceColors||((h=i.perLetterFaceColors)==null?void 0:h.call(i,l)),sideOrientation:k._GetDefaultSideOrientation(i.sideOrientation||k.DOUBLESIDE)},r,s);o.push(x),l++}}const c=k.MergeMeshes(o,!0,!0);if(c){const f=c.getBoundingInfo().boundingBox;c.position.x+=-(f.minimumWorld.x+f.maximumWorld.x)/2,c.position.y+=-(f.minimumWorld.y+f.maximumWorld.y)/2,c.position.z+=-(f.minimumWorld.z+f.maximumWorld.z)/2+f.extendSize.z,c.name=n;const d=new ot("pivot",r);d.rotation.x=-Math.PI/2,c.parent=d,c.bakeCurrentTransformIntoVertices(),c.parent=null,d.dispose()}return c}const Ww={CreateBox:fl,CreateTiledBox:Rw,CreateSphere:Yp,CreateDisc:Qp,CreateIcoSphere:lA,CreateRibbon:ro,CreateCylinder:DC,CreateTorus:JC,CreateTorusKnot:tA,CreateLineSystem:RC,CreateLines:zp,CreateDashedLines:PC,ExtrudeShape:Gp,ExtrudeShapeCustom:AC,CreateLathe:rA,CreateTiledPlane:bw,CreatePlane:nA,CreateGround:Jp,CreateTiledGround:jC,CreateGroundFromHeightMap:qC,CreatePolygon:t_,ExtrudePolygon:i_,CreateTube:aA,CreatePolyhedron:r_,CreateGeodesic:Bw,CreateGoldberg:Uw,CreateDecal:cA,CreateCapsule:a_,CreateText:zw};class Hw{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,r=>{t.distance!==void 0&&e.mesh.addLODLevel(t.distance,r),r.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{const t=this._getSimplifier(e),i=(r,s)=>{t.simplify(r,a=>{r.distance!==void 0&&e.mesh.addLODLevel(r.distance,a),a.isVisible=!0,s()})};Os.Run(e.settings.length,r=>{i(e.settings[r.index],()=>{r.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){switch(e.simplificationType){case 0:default:return new Kw(e.mesh)}}}var DE;(function(n){n[n.QUADRATIC=0]="QUADRATIC"})(DE||(DE={}));class Xw{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class Yw{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new Wo,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class Wo{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,s,a,o,l,c){return this.data[e]*this.data[s]*this.data[c]+this.data[i]*this.data[r]*this.data[l]+this.data[t]*this.data[a]*this.data[o]-this.data[i]*this.data[s]*this.data[o]-this.data[e]*this.data[a]*this.data[l]-this.data[t]*this.data[r]*this.data[c]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new Wo;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new Wo(Wo.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}}class $w{constructor(e,t){this.vertexId=e,this.triangleId=t}}class Kw{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=pt}simplify(e,t){this._initDecimatedMesh(),Os.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){const r=~~(this._triangles.length*e.quality);let s=0;const a=this._triangles.length,o=(l,c)=>{setTimeout(()=>{l%5===0&&this._updateMesh(l===0);for(let f=0;f<this._triangles.length;++f)this._triangles[f].isDirty=!1;const u=1e-9*Math.pow(l+3,this.aggressiveness),h=f=>{const d=~~((this._triangles.length/2+f)%this._triangles.length),p=this._triangles[d];if(p&&!(p.error[3]>u||p.deleted||p.isDirty)){for(let _=0;_<3;++_)if(p.error[_]<u){const g=[],E=[],v=p._vertices[_],x=p._vertices[(_+1)%3];if(v.isBorder||x.isBorder)continue;const A=m.Zero();this._calculateError(v,x,A);const T=[];if(this._isFlipped(v,x,A,g,T)||this._isFlipped(x,v,A,E,T)||g.indexOf(!0)<0||E.indexOf(!0)<0)continue;const C=[];if(T.forEach(D=>{C.indexOf(D)===-1&&(D.deletePending=!0,C.push(D))}),C.length%2!==0)continue;v.q=x.q.add(v.q),v.updatePosition(A);const y=this._references.length;s=this._updateTriangles(v,v,g,s),s=this._updateTriangles(v,x,E,s);const P=this._references.length-y;if(P<=v.triangleCount){if(P)for(let D=0;D<P;D++)this._references[v.triangleStart+D]=this._references[y+D]}else v.triangleStart=y;v.triangleCount=P;break}}};Os.SyncAsyncForLoop(this._triangles.length,this.syncIterations,h,c,()=>a-s<=r)},0)};Os.Run(this.decimationIterations,l=>{a-s<=r?l.breakLoop():o(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const r=this._mesh.getVerticesData(b.PositionKind),s=this._mesh.getIndices(),a=this._mesh.subMeshes[e],o=h=>{if(i){for(let f=0;f<this._vertices.length;++f)if(this._vertices[f].position.equalsWithEpsilon(h,1e-4))return this._vertices[f]}return null},l=[],c=h=>{if(!r)return;const f=h+a.verticesStart,d=m.FromArray(r,f*3),p=o(d)||new Yw(d,this._vertices.length);p.originalOffsets.push(f),p.id===this._vertices.length&&this._vertices.push(p),l.push(p.id)},u=a.verticesCount;Os.SyncAsyncForLoop(u,this.syncIterations/4>>0,c,()=>{const h=f=>{if(!s)return;const p=(a.indexStart/3+f)*3,_=s[p+0],g=s[p+1],E=s[p+2],v=this._vertices[l[_-a.verticesStart]],x=this._vertices[l[g-a.verticesStart]],A=this._vertices[l[E-a.verticesStart]],T=new Xw([v,x,A]);T.originalOffset=p,this._triangles.push(T)};Os.SyncAsyncForLoop(a.indexCount/3,this.syncIterations,h,()=>{this._init(t)})})}_init(e){const t=i=>{const r=this._triangles[i];r.normal=m.Cross(r._vertices[1].position.subtract(r._vertices[0].position),r._vertices[2].position.subtract(r._vertices[0].position)).normalize();for(let s=0;s<3;s++)r._vertices[s].q.addArrayInPlace(Wo.DataFromNumbers(r.normal.x,r.normal.y,r.normal.z,-m.Dot(r.normal,r._vertices[0].position)))};Os.SyncAsyncForLoop(this._triangles.length,this.syncIterations,t,()=>{const i=r=>{const s=this._triangles[r];for(let a=0;a<3;++a)s.error[a]=this._calculateError(s._vertices[a],s._vertices[(a+1)%3]);s.error[3]=Math.min(s.error[0],s.error[1],s.error[2])};Os.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i,()=>{e()})})}_reconstructMesh(e){const t=[];let i;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;let r,s;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(r=this._triangles[i],s=0;s<3;++s)r._vertices[s].triangleCount=1;t.push(r)}const a=this._reconstructedMesh.getVerticesData(b.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(b.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(b.UVKind)||[],c=this._reconstructedMesh.getVerticesData(b.ColorKind)||[],u=this._mesh.getVerticesData(b.NormalKind),h=this._mesh.getVerticesData(b.UVKind),f=this._mesh.getVerticesData(b.ColorKind);let d=0;for(i=0;i<this._vertices.length;++i){const A=this._vertices[i];A.id=d,A.triangleCount&&A.originalOffsets.forEach(T=>{a.push(A.position.x),a.push(A.position.y),a.push(A.position.z),u&&u.length&&(o.push(u[T*3]),o.push(u[T*3+1]),o.push(u[T*3+2])),h&&h.length&&(l.push(h[T*2]),l.push(h[T*2+1])),f&&f.length&&(c.push(f[T*4]),c.push(f[T*4+1]),c.push(f[T*4+2]),c.push(f[T*4+3])),++d})}const p=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),g=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const E=this._reconstructedMesh.getIndices(),v=this._mesh.getIndices();for(i=0;i<t.length;++i)r=t[i],[0,1,2].forEach(A=>{const T=v[r.originalOffset+A];let C=r._vertices[A].originalOffsets.indexOf(T);C<0&&(C=0),E.push(r._vertices[A].id+C+_)});this._reconstructedMesh.setIndices(E),this._reconstructedMesh.setVerticesData(b.PositionKind,a),o.length>0&&this._reconstructedMesh.setVerticesData(b.NormalKind,o),l.length>0&&this._reconstructedMesh.setVerticesData(b.UVKind,l),c.length>0&&this._reconstructedMesh.setVerticesData(b.ColorKind,c);const x=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],g.forEach(A=>{_r.AddToMesh(A.materialIndex,A.verticesStart,A.verticesCount,A.indexStart,A.indexCount,A.getMesh())}),_r.AddToMesh(x.materialIndex,_,d,p,t.length*3,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new k(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,s){for(let a=0;a<e.triangleCount;++a){const o=this._triangles[this._references[e.triangleStart+a].triangleId];if(o.deleted)continue;const l=this._references[e.triangleStart+a].vertexId,c=o._vertices[(l+1)%3],u=o._vertices[(l+2)%3];if(c===t||u===t){r[a]=!0,s.push(o);continue}let h=c.position.subtract(i);h=h.normalize();let f=u.position.subtract(i);if(f=f.normalize(),Math.abs(m.Dot(h,f))>.999)return!0;const d=m.Cross(h,f).normalize();if(r[a]=!1,m.Dot(d,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,r){let s=r;for(let a=0;a<t.triangleCount;++a){const o=this._references[t.triangleStart+a],l=this._triangles[o.triangleId];if(!l.deleted){if(i[a]&&l.deletePending){l.deleted=!0,s++;continue}l._vertices[o.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(o)}}return s}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],r=this._vertices[e];let s;for(s=0;s<r.triangleCount;++s){const a=this._triangles[this._references[r.triangleStart+s].triangleId];for(let o=0;o<3;o++){let l=0;const c=a._vertices[o];for(;l<t.length&&i[l]!==c.id;)++l;l===t.length?(t.push(1),i.push(c.id)):t[l]++}}for(s=0;s<t.length;++s)t[s]===1?this._vertices[i[s]].isBorder=!0:this._vertices[i[s]].isBorder=!1}}_updateMesh(e=!1){let t;if(!e){const l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;let i,r,s;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)s=i._vertices[r],s.triangleCount++;let a=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=a,a+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(this._triangles.length*3);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)s=i._vertices[r],o[s.triangleStart+s.triangleCount]=new $w(r,t),s.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,r=t.y,s=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*s+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*s+2*e.data[6]*r+e.data[7]*s*s+2*e.data[8]*s+e.data[9]}_calculateError(e,t,i){const r=e.q.add(t.q),s=e.isBorder&&t.isBorder;let a=0;const o=r.det(0,1,2,1,4,5,2,5,7);if(o!==0&&!s)i||(i=m.Zero()),i.x=-1/o*r.det(1,2,3,4,5,6,5,7,8),i.y=1/o*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*r.det(0,1,3,1,4,6,2,5,8),a=this._vertexError(r,i);else{const l=e.position.add(t.position).divide(new m(2,2,2)),c=this._vertexError(r,e.position),u=this._vertexError(r,t.position),h=this._vertexError(r,l);a=Math.min(c,u,h),a===c?i&&i.copyFrom(e.position):a===u?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}return a}}Object.defineProperty(ht.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new Hw;let n=this._getComponent(we.NAME_SIMPLIFICATIONQUEUE);n||(n=new jw(this),this._addComponent(n))}return this._simplificationQueue},set:function(n){this._simplificationQueue=n},enumerable:!0,configurable:!0});k.prototype.simplify=function(n,e=!0,t=0,i){return this.getScene().simplificationQueue.addTask({settings:n,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};class jw{constructor(e){this.name=we.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(we.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}_r.prototype._projectOnTrianglesToRef=function(n,e,t,i,r,s){const a=B.Vector3[0],o=B.Vector3[1];let l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){const u=t[c],h=t[c+1],f=t[c+2];if(r&&f===4294967295){c+=2;continue}const d=e[u],p=e[h],_=e[f];if(!d||!p||!_)continue;const g=m.ProjectOnTriangleToRef(n,d,p,_,o);g<l&&(a.copyFrom(o),l=g)}return s.copyFrom(a),l};_r.prototype._projectOnUnIndexedTrianglesToRef=function(n,e,t,i){const r=B.Vector3[0],s=B.Vector3[1];let a=1/0;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=e[o],c=e[o+1],u=e[o+2],h=m.ProjectOnTriangleToRef(n,l,c,u,s);h<a&&(r.copyFrom(s),a=h)}return i.copyFrom(r),a};_r.prototype.projectToRef=function(n,e,t,i){const r=this.getMaterial();if(!r)return-1;let s=3,a=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,a=!0;break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(n,e,t,i):this._projectOnTrianglesToRef(n,e,t,s,a,i)};class qw{getClassName(){return"Lattice"}get resolutionX(){return this._resolutionX}get resolutionY(){return this._resolutionY}get resolutionZ(){return this._resolutionZ}get size(){return this._size}get position(){return this._position}get data(){return this._data}get cellSize(){return this._cellSize}get min(){return this._min}get max(){return this._max}constructor(e){this._cellSize=new m,this._min=new m(-.5,-.5,-.5),this._max=new m(.5,.5,.5),this._localPos=new m,this._tmpVector=new m,this._lerpVector0=new m,this._lerpVector1=new m,this._lerpVector2=new m,this._lerpVector3=new m,this._lerpVector4=new m,this._lerpVector5=new m;const t={resolutionX:3,resolutionY:3,resolutionZ:3,position:m.Zero(),size:m.One(),...e};this._resolutionX=t.resolutionX,this._resolutionY=t.resolutionY,this._resolutionZ=t.resolutionZ,this._position=t.position,this._size=t.autoAdaptToMesh?t.autoAdaptToMesh.getBoundingInfo().boundingBox.extendSize.scale(2):t.size,this._allocateData(),this.update()}_allocateData(){this._data=new Array(this.resolutionX);for(let e=0;e<this.resolutionX;e++){this._data[e]=new Array(this.resolutionY);for(let t=0;t<this.resolutionY;t++){this._data[e][t]=new Array(this.resolutionZ);for(let i=0;i<this.resolutionZ;i++)this._data[e][t][i]=m.Zero()}}}update(){for(let e=0;e<this.resolutionX;e++)for(let t=0;t<this.resolutionY;t++)for(let i=0;i<this.resolutionZ;i++){const r=-this.size.x/2+this.size.x*(e/(this.resolutionX-1)),s=-this.size.y/2+this.size.y*(t/(this.resolutionY-1)),a=-this.size.z/2+this.size.z*(i/(this.resolutionZ-1));this._data[e][t][i].set(r,s,a)}}deformMesh(e){const t=e.getVerticesData(b.PositionKind);t&&(this.deform(t),e.setVerticesData(b.PositionKind,t,!0))}updateInternals(){const e=this._resolutionX,t=this._resolutionY,i=this._resolutionZ;this._cellSize.set(this.size.x/(e-1),this.size.y/(t-1),this.size.z/(i-1)),this._min.set(this.position.x-this.size.x/2,this.position.y-this.size.y/2,this.position.z-this.size.z/2),this._min.addToRef(this._size,this._max)}deform(e,t){const i=this._resolutionX,r=this._resolutionY,s=this._resolutionZ;this.updateInternals();const a=this._min,o=this._max;for(let l=0;l<e.length;l+=3){const c=this._tmpVector.fromArray(e,l);if(c.x<a.x||c.x>o.x||c.y<a.y||c.y>o.y||c.z<a.z||c.z>o.z){t&&c.toArray(t,l);continue}const u=this._localPos.set((c.x-a.x)/this._cellSize.x,(c.y-a.y)/this._cellSize.y,(c.z-a.z)/this._cellSize.z),h=Math.floor(u.x),f=Math.floor(u.y),d=Math.floor(u.z),p=Math.min(h+1,i-1),_=Math.min(f+1,r-1),g=Math.min(d+1,s-1),E=u.x-h,v=u.y-f,x=u.z-d,A=vt(h,0,i-1),T=vt(f,0,r-1),C=vt(d,0,s-1),y=vt(p,0,i-1),P=vt(_,0,r-1),D=vt(g,0,s-1),F=this._data[A][T][C],W=this._data[y][T][C],H=this._data[A][P][C],ue=this._data[y][P][C],ae=this._data[A][T][D],le=this._data[y][T][D],oe=this._data[A][P][D],ge=this._data[y][P][D],Ee=m.LerpToRef(F,W,E,this._lerpVector0),ne=m.LerpToRef(ae,le,E,this._lerpVector1),j=m.LerpToRef(H,ue,E,this._lerpVector2),L=m.LerpToRef(oe,ge,E,this._lerpVector3),Y=m.LerpToRef(Ee,j,v,this._lerpVector4),te=m.LerpToRef(ne,L,v,this._lerpVector5),De=m.LerpToRef(Y,te,x,this._lerpVector0);De.addInPlace(this.position),De.toArray(t||e,l)}}}const Zw=new RegExp("^([gimus]+)!");class ua{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let r=0;r<this._plugins.length;++r)if(this._plugins[r].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt&&(this._material.resetDrawCache(),this._material._createUniformBuffer()),!e.isCompatible(this._material.shaderLanguage))throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because the plugin is not compatible with the shader language of the material.`;const t=e.getClassName();ua._MaterialPluginClassToMainDefine[t]||(ua._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++ua._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(r,s)=>this._handlePluginEvent(r,s),this._plugins.push(e),this._plugins.sort((r,s)=>r.priority-s.priority),this._codeInjectionPoints={};const i={};i[ua._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const r of this._plugins)r.collectDefines(i),this._collectPointNames("vertex",r.getCustomCode("vertex",this._material.shaderLanguage)),this._collectPointNames("fragment",r.getCustomCode("fragment",this._material.shaderLanguage));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case 512:{const i=t;for(const r of this._activePlugins)r.getActiveTextures(i.activeTextures);break}case 256:{const i=t;for(const r of this._activePlugins)r.getAnimatables(i.animatables);break}case 1024:{const i=t;let r=!1;for(const s of this._activePlugins)if(r=s.hasTexture(i.texture),r)break;i.hasTexture=r;break}case 2:{const i=t;for(const r of this._plugins)r.dispose(i.forceDisposeTextures);break}case 4:{const i=t;i.defineNames=this._defineNamesFromPlugins;break}case 128:{const i=t;for(const r of this._activePlugins)i.fallbackRank=r.addFallbacks(i.defines,i.fallbacks,i.fallbackRank),r.getAttributes(i.attributes,this._scene,i.mesh);this._uniformList.length>0&&i.uniforms.push(...this._uniformList),this._samplerList.length>0&&i.samplers.push(...this._samplerList),this._uboList.length>0&&i.uniformBuffersNames.push(...this._uboList),i.customCode=this._injectCustomCode(i,i.customCode);break}case 8:{const i=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];const r=this._material.shaderLanguage===1;for(const s of this._plugins){const a=s.getUniforms(this._material.shaderLanguage);if(a){if(a.ubo)for(const o of a.ubo){if(o.size&&o.type){const l=o.arraySize??0;if(i.ubo.addUniform(o.name,o.size,l),r){let c;switch(o.type){case"mat4":c="mat4x4f";break;case"float":c="f32";break;default:c=`${o.type}f`;break}this._uboDeclaration+=`uniform ${o.name}: ${c}${l>0?`[${l}]`:""};
`}else this._uboDeclaration+=`${o.type} ${o.name}${l>0?`[${l}]`:""};
`}this._uniformList.push(o.name)}a.vertex&&(this._vertexDeclaration+=a.vertex+`
`),a.fragment&&(this._fragmentDeclaration+=a.fragment+`
`)}s.getSamplers(this._samplerList),s.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,r)=>{var o,l;t&&(r=t(i,r)),this._uboDeclaration&&(r=r.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(r=r.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(r=r.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const s=(o=this._codeInjectionPoints)==null?void 0:o[i];if(!s)return r;let a=null;for(let c in s){let u="";for(const h of this._activePlugins){let f=(l=h.getCustomCode(i,this._material.shaderLanguage))==null?void 0:l[c];f&&(h.resolveIncludes&&(a===null&&(a={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:V.GetShadersRepository(0),includesShadersStore:V.GetIncludesShadersStore(0),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}),a.isFragment=i==="fragment",Ql(f,a,d=>f=d)),u+=f+`
`)}if(u.length>0)if(c.charAt(0)==="!"){c=c.substring(1);let h="g";if(c.charAt(0)==="!")h="",c=c.substring(1);else{const _=Zw.exec(c);_&&_.length>=2&&(h=_[1],c=c.substring(h.length+1))}h.indexOf("g")<0&&(h+="g");const f=r,d=new RegExp(c,h);let p=d.exec(f);for(;p!==null;){let _=u;for(let g=0;g<p.length;++g)_=_.replace("$"+g,p[g]);r=r.replace(p[0],_),p=d.exec(f)}}else{const h="#define "+c;r=r.replace(h,`
`+u+`
`+h)}}return r}}}ua._MaterialPluginClassToMainDefine={};ua._MaterialPluginCounter=0;$e.OnEnginesDisposedObservable.add(()=>{Jw()});const Qw=[];let OE=null;function Jw(){Qw.length=0,pe.OnEventObservable.remove(OE),OE=null}class is{isCompatible(e){switch(e){case 0:return!0;default:return!1}}_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,r,s=!0,a=!1,o=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=o,e.pluginManager||(e.pluginManager=new ua(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=r,this._pluginManager=e.pluginManager,s&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,r){return!0}hardBindForSubMesh(e,t,i,r){}bindForSubMesh(e,t,i,r){}dispose(e){}getCustomCode(e,t=0){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(e=0){return{}}copyTo(e){Ke.Clone(()=>e,this)}serialize(){return Ke.Serialize(this)}parse(e,t,i){Ke.Parse(()=>this,e,t,i)}}I([M()],is.prototype,"name",void 0);I([M()],is.prototype,"priority",void 0);I([M()],is.prototype,"resolveIncludes",void 0);I([M()],is.prototype,"registerForExtraEvents",void 0);$("BABYLON.MaterialPluginBase",is);function eB(n,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=Yp("",{slice:.5,diameter:e.diameter,segments:e.segments},t),r=Qp("",{radius:e.diameter/2,tessellation:e.segments*3+(4-e.segments)},t);r.rotation.x=-Math.PI/2,r.parent=i;const s=k.MergeMeshes([r,i],!0);return s.name=n,s}k.CreateHemisphere=(n,e,t,i)=>eB(n,{segments:e,diameter:t},i);class wu{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,s){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(t.prePassRenderer.getIndex(2)!==-1||t.prePassRenderer.getIndex(11)!==-1)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const a=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==a.frameId&&(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}}class Gr{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var r,s,a,o;const t=((s=(r=this._externalProperties)==null?void 0:r[e])==null?void 0:s.type)??typeof this[e],i=(o=(a=this._externalProperties)==null?void 0:a[e])==null?void 0:o.default;switch(t){case"number":this[e]=i??0;break;case"string":this[e]=i??"";break;default:this[e]=i??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+`
`;break;default:r&&(e+="#define "+i+`
`);break}}return e}}class _e{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,q.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,q.MarkAllMaterialsAsDirty(1))}}_e._DiffuseTextureEnabled=!0;_e._DetailTextureEnabled=!0;_e._DecalMapEnabled=!0;_e._AmbientTextureEnabled=!0;_e._OpacityTextureEnabled=!0;_e._ReflectionTextureEnabled=!0;_e._EmissiveTextureEnabled=!0;_e._SpecularTextureEnabled=!0;_e._BumpTextureEnabled=!0;_e._LightmapTextureEnabled=!0;_e._RefractionTextureEnabled=!0;_e._ColorGradingTextureEnabled=!0;_e._FresnelEnabled=!0;_e._ClearCoatTextureEnabled=!0;_e._ClearCoatBumpTextureEnabled=!0;_e._ClearCoatTintTextureEnabled=!0;_e._SheenTextureEnabled=!0;_e._AnisotropicTextureEnabled=!0;_e._ThicknessTextureEnabled=!0;_e._RefractionIntensityTextureEnabled=!0;_e._TranslucencyIntensityTextureEnabled=!0;_e._TranslucencyColorTextureEnabled=!0;_e._IridescenceTextureEnabled=!0;class tB extends Gr{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class Ra extends is{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DetailMap",140,new tB,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=pe.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&_e.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&_e.DetailTextureEnabled&&this._isEnabled?(ai(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&_e.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),oi(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&_e.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)==null||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}I([Rt("detailTexture"),ie("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"texture",void 0);I([M()],Ra.prototype,"diffuseBlendLevel",void 0);I([M()],Ra.prototype,"roughnessBlendLevel",void 0);I([M()],Ra.prototype,"bumpLevel",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"normalBlendMethod",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Ra.prototype,"isEnabled",void 0);var NE;(function(n){n[n.Zero=0]="Zero",n[n.One=1]="One",n[n.MaxViewZ=2]="MaxViewZ"})(NE||(NE={}));class Dr{static CreateConfiguration(e){return Dr._Configurations[e]={defines:{},previousWorldMatrices:{},previousViewProjection:O.Zero(),currentViewProjection:O.Zero(),previousBones:{},lastUpdateFrameId:-1,excludedSkinnedMesh:[]},Dr._Configurations[e]}static DeleteConfiguration(e){delete Dr._Configurations[e]}static GetConfiguration(e){return Dr._Configurations[e]}static AddUniformsAndSamplers(e,t){e.push("previousWorld","previousViewProjection","mPreviousBones")}static MarkAsDirty(e,t){for(const i of t)if(i.subMeshes)for(const r of i.subMeshes)r._removeDrawWrapper(e)}static PrepareDefines(e,t,i){if(!i._arePrePassDirty)return;const r=Dr._Configurations[e];if(!r)return;i.PREPASS=!0,i.PREPASS_COLOR=!1,i.PREPASS_COLOR_INDEX=-1;let s=0;for(let a=0;a<Dr.GeometryTextureDescriptions.length;a++){const o=Dr.GeometryTextureDescriptions[a],l=o.define,c=o.defineIndex,u=r.defines[c];u!==void 0?(i[l]=!0,i[c]=u,s++):(i[l]=!1,delete i[c])}i.SCENE_MRT_COUNT=s,i.BONES_VELOCITY_ENABLED=t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&!t.skeleton.isUsingTextureForMatrices&&r.excludedSkinnedMesh.indexOf(t)===-1}static Bind(e,t,i,r){const s=Dr._Configurations[e];if(s&&(s.defines.PREPASS_VELOCITY_INDEX!==void 0||s.defines.PREPASS_VELOCITY_LINEAR_INDEX!==void 0)){s.previousWorldMatrices[i.uniqueId]||(s.previousWorldMatrices[i.uniqueId]=r.clone());const a=i.getScene();s.previousViewProjection||(s.previousViewProjection=a.getTransformMatrix().clone(),s.currentViewProjection=a.getTransformMatrix().clone());const o=a.getEngine();if(s.currentViewProjection.updateFlag!==a.getTransformMatrix().updateFlag?(s.lastUpdateFrameId=o.frameId,s.previousViewProjection.copyFrom(s.currentViewProjection),s.currentViewProjection.copyFrom(a.getTransformMatrix())):s.lastUpdateFrameId!==o.frameId&&(s.lastUpdateFrameId=o.frameId,s.previousViewProjection.copyFrom(s.currentViewProjection)),t.setMatrix("previousWorld",s.previousWorldMatrices[i.uniqueId]),t.setMatrix("previousViewProjection",s.previousViewProjection),s.previousWorldMatrices[i.uniqueId]=r.clone(),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const l=i.skeleton;if(!l.isUsingTextureForMatrices||t.getUniformIndex("boneTextureWidth")===-1){const c=l.getTransformMatrices(i);c&&(s.previousBones[i.uniqueId]||(s.previousBones[i.uniqueId]=c.slice()),t.setMatrices("mPreviousBones",s.previousBones[i.uniqueId]),s.previousBones[i.uniqueId].set(c))}}}}}Dr.GeometryTextureDescriptions=[{type:0,name:"Irradiance",clearType:0,define:"PREPASS_IRRADIANCE",defineIndex:"PREPASS_IRRADIANCE_INDEX"},{type:1,name:"WorldPosition",clearType:0,define:"PREPASS_POSITION",defineIndex:"PREPASS_POSITION_INDEX"},{type:2,name:"Velocity",clearType:0,define:"PREPASS_VELOCITY",defineIndex:"PREPASS_VELOCITY_INDEX"},{type:3,name:"Reflectivity",clearType:0,define:"PREPASS_REFLECTIVITY",defineIndex:"PREPASS_REFLECTIVITY_INDEX"},{type:5,name:"ViewDepth",clearType:2,define:"PREPASS_DEPTH",defineIndex:"PREPASS_DEPTH_INDEX"},{type:6,name:"ViewNormal",clearType:0,define:"PREPASS_NORMAL",defineIndex:"PREPASS_NORMAL_INDEX"},{type:7,name:"AlbedoSqrt",clearType:0,define:"PREPASS_ALBEDO_SQRT",defineIndex:"PREPASS_ALBEDO_SQRT_INDEX"},{type:8,name:"WorldNormal",clearType:0,define:"PREPASS_WORLD_NORMAL",defineIndex:"PREPASS_WORLD_NORMAL_INDEX"},{type:9,name:"LocalPosition",clearType:0,define:"PREPASS_LOCAL_POSITION",defineIndex:"PREPASS_LOCAL_POSITION_INDEX"},{type:10,name:"ScreenDepth",clearType:1,define:"PREPASS_SCREENSPACE_DEPTH",defineIndex:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:11,name:"LinearVelocity",clearType:0,define:"PREPASS_VELOCITY_LINEAR",defineIndex:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:12,name:"Albedo",clearType:0,define:"PREPASS_ALBEDO",defineIndex:"PREPASS_ALBEDO_INDEX"}];Dr._Configurations={};const Nf={effect:null,subMesh:null};class iB extends Gr{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class Ie extends hl{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t,void 0,i||Ie.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new fe(0,0,0),this.diffuseColor=new fe(1,1,1),this.specularColor=new fe(1,1,1),this.emissiveColor=new fe(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new pr(16),this._worldViewProjectionMatrix=O.Zero(),this._globalAmbientColor=new fe(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Ra(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new wu,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Ie.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),Ie.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return Ie.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||Ie.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===pe.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==pe.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new iB(this._eventInfo.defineNames));const s=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();a._needNormals=Ac(s,e,a,!0,this._maxSimultaneousLights,this._disableLighting),ph(s,a);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Op(s,a,this.canRenderToMRT&&!l),YT(s,a,l),Dr.PrepareDefines(o.currentRenderPassId,e,a),a._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a._needUVs=!1;for(let u=1;u<=6;++u)a["MAINUV"+u]=!1;if(s.texturesEnabled){if(a.DIFFUSEDIRECTUV=0,a.BUMPDIRECTUV=0,a.AMBIENTDIRECTUV=0,a.OPACITYDIRECTUV=0,a.EMISSIVEDIRECTUV=0,a.SPECULARDIRECTUV=0,a.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&Ie.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())ai(this._diffuseTexture,a,"DIFFUSE");else return!1;else a.DIFFUSE=!1;if(this._ambientTexture&&Ie.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())ai(this._ambientTexture,a,"AMBIENT");else return!1;else a.AMBIENT=!1;if(this._opacityTexture&&Ie.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())ai(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else a.OPACITY=!1;if(this._reflectionTexture&&Ie.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===Z.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,a.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case Z.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case Z.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case Z.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case Z.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case Z.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case Z.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case Z.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case Z.CUBIC_MODE:case Z.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC");break}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else a.REFLECTION=!1,a.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&Ie.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())ai(this._emissiveTexture,a,"EMISSIVE");else return!1;else a.EMISSIVE=!1;if(this._lightmapTexture&&Ie.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())ai(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,a.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else a.LIGHTMAP=!1;if(this._specularTexture&&Ie.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())ai(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else a.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&Ie.BumpTextureEnabled){if(this._bumpTexture.isReady())ai(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAX_RHS=s.useRightHandedSystem,a.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1,a.PARALLAX=!1,a.PARALLAX_RHS=!1,a.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&Ie.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube,a.RGBDREFRACTION=this._refractionTexture.isRGBD,a.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,a.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}a._areFresnelDirty&&(Ie.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),hh(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,a,this._applyDecalMapAfterDetailMap),fh(s,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=a,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),dh(e,a,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(a.isDirty){const u=a._areLightsDisposed;a.markAsProcessed();const h=new co;a.REFLECTION&&h.addFallback(0,"REFLECTION"),a.SPECULAR&&h.addFallback(0,"SPECULAR"),a.BUMP&&h.addFallback(0,"BUMP"),a.PARALLAX&&h.addFallback(1,"PARALLAX"),a.PARALLAX_RHS&&h.addFallback(1,"PARALLAX_RHS"),a.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&h.addFallback(1,"FOG"),a.POINTSIZE&&h.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),Mp(a,h,this._maxSimultaneousLights),a.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&h.addFallback(4,"FRESNEL"),a.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const f=[b.PositionKind];a.NORMAL&&f.push(b.NormalKind),a.TANGENT&&f.push(b.TangentKind);for(let C=1;C<=6;++C)a["UV"+C]&&f.push(`uv${C===1?"":C}`);a.VERTEXCOLOR&&f.push(b.ColorKind),Pp(f,e,a,h),uh(f,a),Ip(f,e,a),bp(f,e,a);let d="default";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],_=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=a,this._eventInfo.uniforms=p,this._eventInfo.attributes=f,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(128,this._eventInfo),Dr.AddUniformsAndSamplers(p,_),wu.AddUniforms(p),It&&(It.PrepareUniforms(p,a),It.PrepareSamplers(_,a)),_h({uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:a,maxSimultaneousLights:this._maxSimultaneousLights}),Zn(p);const v={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,p,g,_,a,f,v));const x=a.toString(),A=t.effect;let T=s.getEngine().createEffect(d,{attributes:f,uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:x,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:E,processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:a.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this._shaderLanguage===1?await Promise.all([re(()=>Promise.resolve().then(()=>BX),void 0),re(()=>Promise.resolve().then(()=>NX),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>PX),void 0),re(()=>Promise.resolve().then(()=>IX),void 0)]),this._shadersLoaded=!0}},o);if(this._eventInfo.customCode=void 0,T)if(this._onEffectCreatedObservable&&(Nf.effect=T,Nf.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Nf)),this.allowShaderHotSwapping&&A&&!T.isReady()){if(T=A,a.markAsUnprocessed(),c=this.isFrozen,u)return a._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(T,a,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(a._renderId=s.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var c;const r=this.getScene(),s=i.materialDefines;if(!s)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),Dr.Bind(r.getEngine().currentRenderPassId,this._activeEffect,t,e),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const o=this._mustRebind(r,a,i,t.visibility);ul(t,a);const l=this._uniformBuffer;if(o){if(this.bindViewProjection(a),!l.useUbo||!this.isFrozen||!l.isSync||i._drawWrapper._forceRebindOnNextCall){if(Ie.FresnelEnabled&&s.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new fe(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&Ie.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),oi(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&Ie.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),oi(this._ambientTexture,l,"ambient")),this._opacityTexture&&Ie.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),oi(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&Ie.ReflectionTextureEnabled&&(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const u=this._reflectionTexture;l.updateVector3("vReflectionPosition",u.boundingBoxPosition),l.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this._emissiveTexture&&Ie.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),oi(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&Ie.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),oi(this._lightmapTexture,l,"lightmap")),this._specularTexture&&Ie.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),oi(this._specularTexture,l,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&Ie.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),oi(this._bumpTexture,l,"bump"),r._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&Ie.RefractionTextureEnabled){let u=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(u=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const h=this._refractionTexture;l.updateVector3("vRefractionPosition",h.boundingBoxPosition),l.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",Ie.EmissiveTextureEnabled?this.emissiveColor:fe.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&Ie.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&Ie.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Ie.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&Ie.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?a.setTexture("reflectionCubeSampler",this._reflectionTexture):a.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&Ie.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Ie.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&Ie.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&Ie.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&Ie.RefractionTextureEnabled&&(this._refractionTexture.isCube?a.setTexture("refractionCubeSampler",this._refractionTexture):a.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Sn(a,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&Cc(r,t,a,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==ht.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||s.PREPASS)&&this.bindView(a),uo(r,t,a),s.NUM_MORPH_INFLUENCERS&&cl(t,a),s.BAKED_VERTEX_ANIMATION_TEXTURE&&((c=t.bakedVertexAnimationManager)==null||c.bind(a,s.INSTANCES)),this.useLogarithmicDepth&&Qn(s,a,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),l.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,r,s,a,o,l,c,u,h;t&&((i=this._diffuseTexture)==null||i.dispose(),(r=this._ambientTexture)==null||r.dispose(),(s=this._opacityTexture)==null||s.dispose(),(a=this._reflectionTexture)==null||a.dispose(),(o=this._emissiveTexture)==null||o.dispose(),(l=this._specularTexture)==null||l.dispose(),(c=this._bumpTexture)==null||c.dispose(),(u=this._lightmapTexture)==null||u.dispose(),(h=this._refractionTexture)==null||h.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const r=Ke.Clone(()=>new Ie(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){const r=Ke.Parse(()=>new Ie(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),pe._ParsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return _e.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){_e.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return _e.DetailTextureEnabled}static set DetailTextureEnabled(e){_e.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return _e.AmbientTextureEnabled}static set AmbientTextureEnabled(e){_e.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return _e.OpacityTextureEnabled}static set OpacityTextureEnabled(e){_e.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return _e.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){_e.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return _e.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){_e.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return _e.SpecularTextureEnabled}static set SpecularTextureEnabled(e){_e.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return _e.BumpTextureEnabled}static set BumpTextureEnabled(e){_e.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return _e.LightmapTextureEnabled}static set LightmapTextureEnabled(e){_e.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return _e.RefractionTextureEnabled}static set RefractionTextureEnabled(e){_e.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return _e.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){_e.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return _e.FresnelEnabled}static set FresnelEnabled(e){_e.FresnelEnabled=e}}Ie.ForceGLSL=!1;I([Rt("diffuseTexture")],Ie.prototype,"_diffuseTexture",void 0);I([ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ie.prototype,"diffuseTexture",void 0);I([Rt("ambientTexture")],Ie.prototype,"_ambientTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"ambientTexture",void 0);I([Rt("opacityTexture")],Ie.prototype,"_opacityTexture",void 0);I([ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ie.prototype,"opacityTexture",void 0);I([Rt("reflectionTexture")],Ie.prototype,"_reflectionTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"reflectionTexture",void 0);I([Rt("emissiveTexture")],Ie.prototype,"_emissiveTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"emissiveTexture",void 0);I([Rt("specularTexture")],Ie.prototype,"_specularTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"specularTexture",void 0);I([Rt("bumpTexture")],Ie.prototype,"_bumpTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"bumpTexture",void 0);I([Rt("lightmapTexture")],Ie.prototype,"_lightmapTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"lightmapTexture",void 0);I([Rt("refractionTexture")],Ie.prototype,"_refractionTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"refractionTexture",void 0);I([hi("ambient")],Ie.prototype,"ambientColor",void 0);I([hi("diffuse")],Ie.prototype,"diffuseColor",void 0);I([hi("specular")],Ie.prototype,"specularColor",void 0);I([hi("emissive")],Ie.prototype,"emissiveColor",void 0);I([M()],Ie.prototype,"specularPower",void 0);I([M("useAlphaFromDiffuseTexture")],Ie.prototype,"_useAlphaFromDiffuseTexture",void 0);I([ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ie.prototype,"useAlphaFromDiffuseTexture",void 0);I([M("useEmissiveAsIllumination")],Ie.prototype,"_useEmissiveAsIllumination",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useEmissiveAsIllumination",void 0);I([M("linkEmissiveWithDiffuse")],Ie.prototype,"_linkEmissiveWithDiffuse",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"linkEmissiveWithDiffuse",void 0);I([M("useSpecularOverAlpha")],Ie.prototype,"_useSpecularOverAlpha",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useSpecularOverAlpha",void 0);I([M("useReflectionOverAlpha")],Ie.prototype,"_useReflectionOverAlpha",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useReflectionOverAlpha",void 0);I([M("disableLighting")],Ie.prototype,"_disableLighting",void 0);I([ie("_markAllSubMeshesAsLightsDirty")],Ie.prototype,"disableLighting",void 0);I([M("useObjectSpaceNormalMap")],Ie.prototype,"_useObjectSpaceNormalMap",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useObjectSpaceNormalMap",void 0);I([M("useParallax")],Ie.prototype,"_useParallax",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useParallax",void 0);I([M("useParallaxOcclusion")],Ie.prototype,"_useParallaxOcclusion",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useParallaxOcclusion",void 0);I([M()],Ie.prototype,"parallaxScaleBias",void 0);I([M("roughness")],Ie.prototype,"_roughness",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"roughness",void 0);I([M()],Ie.prototype,"indexOfRefraction",void 0);I([M()],Ie.prototype,"invertRefractionY",void 0);I([M()],Ie.prototype,"alphaCutOff",void 0);I([M("useLightmapAsShadowmap")],Ie.prototype,"_useLightmapAsShadowmap",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useLightmapAsShadowmap",void 0);I([gc("diffuseFresnelParameters")],Ie.prototype,"_diffuseFresnelParameters",void 0);I([ie("_markAllSubMeshesAsFresnelDirty")],Ie.prototype,"diffuseFresnelParameters",void 0);I([gc("opacityFresnelParameters")],Ie.prototype,"_opacityFresnelParameters",void 0);I([ie("_markAllSubMeshesAsFresnelAndMiscDirty")],Ie.prototype,"opacityFresnelParameters",void 0);I([gc("reflectionFresnelParameters")],Ie.prototype,"_reflectionFresnelParameters",void 0);I([ie("_markAllSubMeshesAsFresnelDirty")],Ie.prototype,"reflectionFresnelParameters",void 0);I([gc("refractionFresnelParameters")],Ie.prototype,"_refractionFresnelParameters",void 0);I([ie("_markAllSubMeshesAsFresnelDirty")],Ie.prototype,"refractionFresnelParameters",void 0);I([gc("emissiveFresnelParameters")],Ie.prototype,"_emissiveFresnelParameters",void 0);I([ie("_markAllSubMeshesAsFresnelDirty")],Ie.prototype,"emissiveFresnelParameters",void 0);I([M("useReflectionFresnelFromSpecular")],Ie.prototype,"_useReflectionFresnelFromSpecular",void 0);I([ie("_markAllSubMeshesAsFresnelDirty")],Ie.prototype,"useReflectionFresnelFromSpecular",void 0);I([M("useGlossinessFromSpecularMapAlpha")],Ie.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"useGlossinessFromSpecularMapAlpha",void 0);I([M("maxSimultaneousLights")],Ie.prototype,"_maxSimultaneousLights",void 0);I([ie("_markAllSubMeshesAsLightsDirty")],Ie.prototype,"maxSimultaneousLights",void 0);I([M("invertNormalMapX")],Ie.prototype,"_invertNormalMapX",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"invertNormalMapX",void 0);I([M("invertNormalMapY")],Ie.prototype,"_invertNormalMapY",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"invertNormalMapY",void 0);I([M("twoSidedLighting")],Ie.prototype,"_twoSidedLighting",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],Ie.prototype,"twoSidedLighting",void 0);I([M("applyDecalMapAfterDetailMap")],Ie.prototype,"_applyDecalMapAfterDetailMap",void 0);I([ie("_markAllSubMeshesAsMiscDirty")],Ie.prototype,"applyDecalMapAfterDetailMap",void 0);$("BABYLON.StandardMaterial",Ie);ht.DefaultMaterialFactory=n=>new Ie("default material",n);const rB="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let sB=0;const o_=n=>{if(!n.environmentBRDFTexture){const e=n.useDelayedTextureLoading;n.useDelayedTextureLoading=!1;const t=n._blockEntityCollection;n._blockEntityCollection=!1;const i=Z.CreateFromBase64String(rB,"EnvironmentBRDFTexture"+sB++,n,!0,!1,Z.BILINEAR_SAMPLINGMODE);n._blockEntityCollection=t;const r=n.getEngine().getLoadedTexturesCache(),s=r.indexOf(i.getInternalTexture());s!==-1&&r.splice(s,1),i.isRGBD=!0,i.wrapU=Z.CLAMP_ADDRESSMODE,i.wrapV=Z.CLAMP_ADDRESSMODE,n.environmentBRDFTexture=i,n.useDelayedTextureLoading=e,ag.ExpandRGBDTexture(i);const a=n.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const o=n.onBeforeRenderObservable.add(()=>{i.isReady()&&(n.onBeforeRenderObservable.remove(o),ag.ExpandRGBDTexture(i))})});n.onDisposeObservable.add(()=>{n.getEngine().onContextRestoredObservable.remove(a)})}return n.environmentBRDFTexture};class nB extends Gr{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class yr extends is{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new nB,t),this._useEnergyConservation=yr.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=yr.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=yr.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=yr.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=yr.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=yr.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=yr.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=yr.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}yr.DEFAULT_USE_ENERGY_CONSERVATION=!0;yr.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;yr.DEFAULT_USE_SPHERICAL_HARMONICS=!0;yr.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;I([M(),ie("_markAllSubMeshesAsMiscDirty")],yr.prototype,"useEnergyConservation",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],yr.prototype,"useSmithVisibilityHeightCorrelated",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],yr.prototype,"useSphericalHarmonics",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],yr.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);class aB extends Gr{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class rr extends is{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new aB,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=rr._DefaultIndexOfRefraction,this.indexOfRefraction=rr._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=fe.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const r=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&_e.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&_e.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&_e.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.ClearCoatTextureEnabled?ai(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&_e.ClearCoatTextureEnabled?ai(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&_e.ClearCoatBumpTextureEnabled?ai(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===rr._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&_e.ClearCoatTintTextureEnabled?(ai(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){var u,h,f,d;if(!this._isEnabled)return;const s=r.materialDefines,a=this._material.isFrozen,o=this._material._disableBumpMap,l=this._material._invertNormalMapX,c=this._material._invertNormalMapY;if(!e.useUbo||!a||!e.isSync){(this._texture||this._textureRoughness)&&_e.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",((u=this._texture)==null?void 0:u.coordinatesIndex)??0,((h=this._texture)==null?void 0:h.level)??0,((f=this._textureRoughness)==null?void 0:f.coordinatesIndex)??0,((d=this._textureRoughness)==null?void 0:d.level)??0),this._texture&&oi(this._texture,e,"clearCoat"),this._textureRoughness&&!s.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&oi(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&_e.ClearCoatTextureEnabled&&!o&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),oi(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,c?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,c?-1:1)),this._tintTexture&&_e.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),oi(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const p=1-this._indexOfRefraction,_=1+this._indexOfRefraction,g=Math.pow(-p/_,2),E=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",g,E,p,_),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&_e.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!s.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&_e.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&_e.ClearCoatBumpTextureEnabled&&!o&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&_e.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,r,s;e&&((t=this._texture)==null||t.dispose(),(i=this._textureRoughness)==null||i.dispose(),(r=this._bumpTexture)==null||r.dispose(),(s=this._tintTexture)==null||s.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}rr._DefaultIndexOfRefraction=1.5;I([M(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"isEnabled",void 0);I([M()],rr.prototype,"intensity",void 0);I([M()],rr.prototype,"roughness",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"indexOfRefraction",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"texture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"useRoughnessFromMainTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"textureRoughness",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"remapF0OnInterfaceChange",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"bumpTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"isTintEnabled",void 0);I([hi()],rr.prototype,"tintColor",void 0);I([M()],rr.prototype,"tintColorAtDistance",void 0);I([M()],rr.prototype,"tintThickness",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],rr.prototype,"tintTexture",void 0);class oB extends Gr{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class Lr extends is{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new oB,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Lr._DefaultMinimumThickness,this.maximumThickness=Lr._DefaultMaximumThickness,this.indexOfRefraction=Lr._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&_e.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.IridescenceTextureEnabled?ai(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&_e.IridescenceTextureEnabled?ai(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){var r,s,a,o;if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&((this._texture||this._thicknessTexture)&&_e.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",((r=this._texture)==null?void 0:r.coordinatesIndex)??0,((s=this._texture)==null?void 0:s.level)??0,((a=this._thicknessTexture)==null?void 0:a.coordinatesIndex)??0,((o=this._thicknessTexture)==null?void 0:o.level)??0),this._texture&&oi(this._texture,e,"iridescence"),this._thicknessTexture&&oi(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&_e.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&_e.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)==null||t.dispose(),(i=this._thicknessTexture)==null||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Lr._DefaultMinimumThickness=100;Lr._DefaultMaximumThickness=400;Lr._DefaultIndexOfRefraction=1.3;I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Lr.prototype,"isEnabled",void 0);I([M()],Lr.prototype,"intensity",void 0);I([M()],Lr.prototype,"minimumThickness",void 0);I([M()],Lr.prototype,"maximumThickness",void 0);I([M()],Lr.prototype,"indexOfRefraction",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],Lr.prototype,"texture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],Lr.prototype,"thicknessTexture",void 0);class lB extends Gr{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class dl extends is{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new lB,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new se(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&_e.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(b.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.AnisotropicTextureEnabled?ai(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&_e.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),oi(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&_e.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}}I([M(),ie("_markAllSubMeshesAsTexturesDirty")],dl.prototype,"isEnabled",void 0);I([M()],dl.prototype,"intensity",void 0);I([np()],dl.prototype,"direction",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],dl.prototype,"texture",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],dl.prototype,"legacy",void 0);class cB extends Gr{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class xn extends is{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new cB,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=fe.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&_e.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&_e.SheenTextureEnabled?(ai(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&_e.SheenTextureEnabled?ai(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){var o,l,c,u;if(!this._isEnabled)return;const s=r.materialDefines,a=this._material.isFrozen;(!e.useUbo||!a||!e.isSync)&&((this._texture||this._textureRoughness)&&_e.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",((o=this._texture)==null?void 0:o.coordinatesIndex)??0,((l=this._texture)==null?void 0:l.level)??0,((c=this._textureRoughness)==null?void 0:c.coordinatesIndex)??0,((u=this._textureRoughness)==null?void 0:u.level)??0),this._texture&&oi(this._texture,e,"sheen"),this._textureRoughness&&!s.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&oi(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&_e.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!s.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&_e.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)==null||t.dispose(),(i=this._textureRoughness)==null||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}I([M(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"isEnabled",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"linkSheenWithAlbedo",void 0);I([M()],xn.prototype,"intensity",void 0);I([hi()],xn.prototype,"color",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"texture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"useRoughnessFromMainTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"roughness",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"textureRoughness",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"albedoScaling",void 0);class uB extends Gr{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}}class vi extends is{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new uB,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=fe.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=fe.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&_e.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()||this._translucencyColorTexture&&_e.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking()||this._translucencyIntensityTexture&&_e.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&_e.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0;return}if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&_e.ThicknessTextureEnabled&&ai(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&_e.RefractionIntensityTextureEnabled&&ai(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&_e.TranslucencyIntensityTextureEnabled&&ai(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&_e.TranslucencyColorTextureEnabled&&ai(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&_e.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled))if(this.maximumThickness===0&&this.minimumThickness===0)e.updateFloat2("vThicknessParam",0,0);else{r.getRenderingMesh().getWorldMatrix().decompose(B.Vector3[0]);const s=Math.max(Math.abs(B.Vector3[0].x),Math.abs(B.Vector3[0].y),Math.abs(B.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*s,(this.maximumThickness-this.minimumThickness)*s)}}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const s=r.materialDefines,a=this._material.isFrozen,o=this._material.realTimeFiltering,l=s.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!a||!e.isSync){if(this._thicknessTexture&&_e.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),oi(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&_e.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),oi(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&_e.TranslucencyColorTextureEnabled&&s.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),oi(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&_e.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),oi(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&_e.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let u=1;c.isCube||c.depth&&(u=c.depth);const h=c.getSize().width,f=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/f,u,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",h,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",h,Math.log2(h)),c.boundingBoxSize){const d=c;e.updateVector3("vRefractionPosition",d.boundingBoxPosition),e.updateVector3("vRefractionSize",d.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&_e.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&_e.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&_e.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&_e.TranslucencyColorTextureEnabled&&s.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&_e.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){_e.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(_e.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"isRefractionEnabled",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"isTranslucencyEnabled",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"isDispersionEnabled",void 0);I([M(),ie("_markScenePrePassDirty")],vi.prototype,"isScatteringEnabled",void 0);I([M()],vi.prototype,"_scatteringDiffusionProfileIndex",void 0);I([M()],vi.prototype,"refractionIntensity",void 0);I([M()],vi.prototype,"translucencyIntensity",void 0);I([M()],vi.prototype,"useAlbedoToTintRefraction",void 0);I([M()],vi.prototype,"useAlbedoToTintTranslucency",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"thicknessTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"refractionTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"indexOfRefraction",void 0);I([M()],vi.prototype,"_volumeIndexOfRefraction",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"volumeIndexOfRefraction",null);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"invertRefractionY",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"linkRefractionWithTransparency",void 0);I([M()],vi.prototype,"minimumThickness",void 0);I([M()],vi.prototype,"maximumThickness",void 0);I([M()],vi.prototype,"useThicknessAsDepth",void 0);I([hi()],vi.prototype,"tintColor",void 0);I([M()],vi.prototype,"tintColorAtDistance",void 0);I([M()],vi.prototype,"dispersion",void 0);I([hi()],vi.prototype,"diffusionDistance",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"useMaskFromThicknessTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"refractionIntensityTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"translucencyIntensityTexture",void 0);I([hi()],vi.prototype,"translucencyColor",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"translucencyColorTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],vi.prototype,"useGltfStyleTextures",void 0);const Co={effect:null,subMesh:null};class LE extends Gr{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class wt extends hl{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t,i=!1){super(e,t,void 0,i||wt.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new We(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=wt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=fe.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new fe(0,0,0),this._albedoColor=new fe(1,1,1),this._reflectivityColor=new fe(1,1,1),this._reflectionColor=new fe(1,1,1),this._emissiveColor=new fe(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=wt.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new pr(16),this._globalAmbientColor=new fe(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new yr(this),this.clearCoat=new rr(this),this.iridescence=new Lr(this),this.anisotropy=new dl(this),this.sheen=new xn(this),this.subSurface=new vi(this),this.detailMap=new Ra(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),_e.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=o_(this.getScene()),this.prePassConfiguration=new wu}get hasRenderTargetTextures(){return _e.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===wt.PBRMATERIAL_OPAQUE||this._transparencyMode===wt.PBRMATERIAL_ALPHATEST||((e=this.subSurface)==null?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._forceAlphaTest?!0:(e=this.subSurface)!=null&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===wt.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==wt.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var f;this._uniformBufferLayoutBuilt||this.buildUniformLayout();const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new LE(this._eventInfo.defineNames));const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=this.getScene(),o=a.getEngine();if(s._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&_e.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&_e.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&_e.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const d=this._getReflectionTexture();if(d&&_e.ReflectionTextureEnabled){if(!d.isReadyOrNotBlocking())return!1;if(d.irradianceTexture){if(!d.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!d.sphericalPolynomial&&((f=d.getInternalTexture())!=null&&f._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&_e.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&_e.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(_e.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&_e.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&_e.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||s._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(b.NormalKind)&&(e.createNormals(!0),w.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=s._areLightsDisposed;let u=this._prepareEffect(e,s,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),h=!1;if(u)if(this._onEffectCreatedObservable&&(Co.effect=u,Co.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Co)),this.allowShaderHotSwapping&&l&&!u.isReady()){if(u=l,s.markAsUnprocessed(),h=this.isFrozen,c)return s._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(u,s,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(s._renderId=a.getRenderId(),r._wasPreviouslyReady=!h,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,r=null,s=null,a=null,o){if(this._prepareDefines(e,t,s,a,o),!t.isDirty)return null;t.markAsProcessed();const c=this.getScene().getEngine(),u=new co;let h=0;t.USESPHERICALINVERTEX&&u.addFallback(h++,"USESPHERICALINVERTEX"),t.FOG&&u.addFallback(h,"FOG"),t.SPECULARAA&&u.addFallback(h,"SPECULARAA"),t.POINTSIZE&&u.addFallback(h,"POINTSIZE"),t.LOGARITHMICDEPTH&&u.addFallback(h,"LOGARITHMICDEPTH"),t.PARALLAX&&u.addFallback(h,"PARALLAX"),t.PARALLAX_RHS&&u.addFallback(h,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&u.addFallback(h++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&u.addFallback(h++,"ENVIRONMENTBRDF"),t.TANGENT&&u.addFallback(h++,"TANGENT"),t.BUMP&&u.addFallback(h++,"BUMP"),h=Mp(t,u,this._maxSimultaneousLights,h++),t.SPECULARTERM&&u.addFallback(h++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&u.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&u.addFallback(h++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&u.addFallback(h++,"LIGHTMAP"),t.NORMAL&&u.addFallback(h++,"NORMAL"),t.AMBIENT&&u.addFallback(h++,"AMBIENT"),t.EMISSIVE&&u.addFallback(h++,"EMISSIVE"),t.VERTEXCOLOR&&u.addFallback(h++,"VERTEXCOLOR"),t.MORPHTARGETS&&u.addFallback(h++,"MORPHTARGETS"),t.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const f=[b.PositionKind];t.NORMAL&&f.push(b.NormalKind),t.TANGENT&&f.push(b.TangentKind);for(let T=1;T<=6;++T)t["UV"+T]&&f.push(`uv${T===1?"":T}`);t.VERTEXCOLOR&&f.push(b.ColorKind),Pp(f,e,t,u),uh(f,t),Ip(f,e,t),bp(f,e,t);let d="pbr";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],_=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=h,this._eventInfo.defines=t,this._eventInfo.uniforms=p,this._eventInfo.attributes=f,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(128,this._eventInfo),Dr.AddUniformsAndSamplers(p,_),wu.AddUniforms(p),Zn(p),It&&(It.PrepareUniforms(p,t),It.PrepareSamplers(_,t)),_h({uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const v={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,p,g,_,t,f,v));const x=t.toString(),A=c.createEffect(d,{attributes:f,uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:x,fallbacks:u,onCompiled:i,onError:r,indexParameters:E,processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([re(()=>Promise.resolve().then(()=>dy),void 0),re(()=>Promise.resolve().then(()=>xy),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>Iy),void 0),re(()=>Promise.resolve().then(()=>Ly),void 0)]),this._shadersLoaded=!0}},c);return this._eventInfo.customCode=void 0,A}_prepareDefines(e,t,i=null,r=null,s=!1){const a=this.getScene(),o=a.getEngine();Ac(a,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,ph(a,t);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Op(a,t,this.canRenderToMRT&&!l),YT(a,t,l),Dr.PrepareDefines(o.currentRenderPassId,e,t),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let c=1;c<=6;++c)t["MAINUV"+c]=!1;if(a.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,o.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&_e.DiffuseTextureEnabled?(ai(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&_e.AmbientTextureEnabled?(ai(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&_e.OpacityTextureEnabled?(ai(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const c=this._getReflectionTexture();if(c&&_e.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=c.gammaSpace,t.RGBDREFLECTION=c.isRGBD,t.LODINREFLECTIONALPHA=c.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=c.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,o._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=c.coordinatesMode===Z.INVCUBIC_MODE,t.REFLECTIONMAP_3D=c.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!c.invertZ:c.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,c.coordinatesMode){case Z.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case Z.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case Z.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case Z.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case Z.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case Z.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Z.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Z.CUBIC_MODE:case Z.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!c.boundingBoxSize;break}c.coordinatesMode!==Z.SKYBOX_MODE&&(c.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):c.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||o.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&_e.LightmapTextureEnabled?(ai(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&_e.EmissiveTextureEnabled?(ai(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,_e.SpecularTextureEnabled?(this._metallicTexture?(ai(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(ai(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(ai(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(ai(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?ai(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),o.getCaps().standardDerivatives&&this._bumpTexture&&_e.BumpTextureEnabled&&!this._disableBumpMap?(ai(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&_e.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=a.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&_e.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===wt.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===wt.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=o.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(hh(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(b.NormalKind),t.DEBUGMODE=this._debugMode),fh(a,o,this,t,!!i,r,s),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),dh(e,t,!0,!0,!0,this._transparencyMode!==wt.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const a=new LE(this._eventInfo.defineNames),o=this._prepareEffect(e,a,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Co.effect=o,Co.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Co)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})})()}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var h,f,d;const r=this.getScene(),s=i.materialDefines;if(!s)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e);const o=r.getEngine();this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),Dr.Bind(o.currentRenderPassId,this._activeEffect,t,e),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=this._mustRebind(r,a,i,t.visibility);ul(t,this._activeEffect,this.prePassConfiguration);let c=null;const u=this._uniformBuffer;if(l){if(this.bindViewProjection(a),c=this._getReflectionTexture(),!u.useUbo||!this.isFrozen||!u.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){if(this._albedoTexture&&_e.DiffuseTextureEnabled&&(u.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),oi(this._albedoTexture,u,"albedo")),this._ambientTexture&&_e.AmbientTextureEnabled&&(u.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),oi(this._ambientTexture,u,"ambient")),this._opacityTexture&&_e.OpacityTextureEnabled&&(u.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),oi(this._opacityTexture,u,"opacity")),c&&_e.ReflectionTextureEnabled){if(u.updateMatrix("reflectionMatrix",c.getReflectionTextureMatrix()),u.updateFloat2("vReflectionInfos",c.level,0),c.boundingBoxSize){const p=c;u.updateVector3("vReflectionPosition",p.boundingBoxPosition),u.updateVector3("vReflectionSize",p.boundingBoxSize)}if(this.realTimeFiltering){const p=c.getSize().width;u.updateFloat2("vReflectionFilteringInfo",p,Math.log2(p))}if(!s.USEIRRADIANCEMAP){const p=c.sphericalPolynomial;if(s.USESPHERICALFROMREFLECTIONMAP&&p)if(s.SPHERICAL_HARMONICS){const _=p.preScaledHarmonics;u.updateVector3("vSphericalL00",_.l00),u.updateVector3("vSphericalL1_1",_.l1_1),u.updateVector3("vSphericalL10",_.l10),u.updateVector3("vSphericalL11",_.l11),u.updateVector3("vSphericalL2_2",_.l2_2),u.updateVector3("vSphericalL2_1",_.l2_1),u.updateVector3("vSphericalL20",_.l20),u.updateVector3("vSphericalL21",_.l21),u.updateVector3("vSphericalL22",_.l22)}else u.updateFloat3("vSphericalX",p.x.x,p.x.y,p.x.z),u.updateFloat3("vSphericalY",p.y.x,p.y.y,p.y.z),u.updateFloat3("vSphericalZ",p.z.x,p.z.y,p.z.z),u.updateFloat3("vSphericalXX_ZZ",p.xx.x-p.zz.x,p.xx.y-p.zz.y,p.xx.z-p.zz.z),u.updateFloat3("vSphericalYY_ZZ",p.yy.x-p.zz.x,p.yy.y-p.zz.y,p.yy.z-p.zz.z),u.updateFloat3("vSphericalZZ",p.zz.x,p.zz.y,p.zz.z),u.updateFloat3("vSphericalXY",p.xy.x,p.xy.y,p.xy.z),u.updateFloat3("vSphericalYZ",p.yz.x,p.yz.y,p.yz.z),u.updateFloat3("vSphericalZX",p.zx.x,p.zx.y,p.zx.z)}u.updateFloat3("vReflectionMicrosurfaceInfos",c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset)}this._emissiveTexture&&_e.EmissiveTextureEnabled&&(u.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),oi(this._emissiveTexture,u,"emissive")),this._lightmapTexture&&_e.LightmapTextureEnabled&&(u.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),oi(this._lightmapTexture,u,"lightmap")),_e.SpecularTextureEnabled&&(this._metallicTexture?(u.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),oi(this._metallicTexture,u,"reflectivity")):this._reflectivityTexture&&(u.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),oi(this._reflectivityTexture,u,"reflectivity")),this._metallicReflectanceTexture&&(u.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),oi(this._metallicReflectanceTexture,u,"metallicReflectance")),this._reflectanceTexture&&s.REFLECTANCE&&(u.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),oi(this._reflectanceTexture,u,"reflectance")),this._microSurfaceTexture&&(u.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),oi(this._microSurfaceTexture,u,"microSurfaceSampler"))),this._bumpTexture&&o.getCaps().standardDerivatives&&_e.BumpTextureEnabled&&!this._disableBumpMap&&(u.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),oi(this._bumpTexture,u,"bump"),r._mirroredCameraPosition?u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&u.updateFloat("pointSize",this.pointSize),s.METALLICWORKFLOW){Ot.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,Ot.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,u.updateColor4("vReflectivityColor",Ot.Color3[0],1);const p=((h=this.subSurface)==null?void 0:h._indexOfRefraction)??1.5,_=1,g=Math.pow((p-_)/(p+_),2);this._metallicReflectanceColor.scaleToRef(g*this._metallicF0Factor,Ot.Color3[0]);const E=this._metallicF0Factor;u.updateColor4("vMetallicReflectanceFactors",Ot.Color3[0],E)}else u.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);u.updateColor3("vEmissiveColor",_e.EmissiveTextureEnabled?this._emissiveColor:fe.BlackReadOnly),u.updateColor3("vReflectionColor",this._reflectionColor),!s.SS_REFRACTION&&((f=this.subSurface)!=null&&f._linkRefractionWithTransparency)?u.updateColor4("vAlbedoColor",this._albedoColor,1):u.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,u.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),u.updateColor3("vAmbientColor",this._globalAmbientColor),u.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}r.texturesEnabled&&(this._albedoTexture&&_e.DiffuseTextureEnabled&&u.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&_e.AmbientTextureEnabled&&u.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&_e.OpacityTextureEnabled&&u.setTexture("opacitySampler",this._opacityTexture),c&&_e.ReflectionTextureEnabled&&(s.LODBASEDMICROSFURACE?u.setTexture("reflectionSampler",c):(u.setTexture("reflectionSampler",c._lodTextureMid||c),u.setTexture("reflectionSamplerLow",c._lodTextureLow||c),u.setTexture("reflectionSamplerHigh",c._lodTextureHigh||c)),s.USEIRRADIANCEMAP&&u.setTexture("irradianceSampler",c.irradianceTexture)),s.ENVIRONMENTBRDF&&u.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&_e.EmissiveTextureEnabled&&u.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&_e.LightmapTextureEnabled&&u.setTexture("lightmapSampler",this._lightmapTexture),_e.SpecularTextureEnabled&&(this._metallicTexture?u.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&u.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&u.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&s.REFLECTANCE&&u.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&u.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&o.getCaps().standardDerivatives&&_e.BumpTextureEnabled&&!this._disableBumpMap&&u.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Sn(this._activeEffect,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&Cc(r,t,this._activeEffect,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==ht.FOGMODE_NONE||c||this.subSurface.refractionTexture||t.receiveShadows||s.PREPASS)&&this.bindView(a),uo(r,t,this._activeEffect,!0),s.NUM_MORPH_INFLUENCERS&&cl(t,this._activeEffect),s.BAKED_VERTEX_ANIMATION_TEXTURE&&((d=t.bakedVertexAnimationManager)==null||d.bind(a,s.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),Qn(s,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),u.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var t;if(!((t=this.subSurface)!=null&&t.isScatteringEnabled))return!1;const e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){var i,r,s,a,o,l,c,u,h,f,d,p;this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)==null||i.dispose(),(r=this._ambientTexture)==null||r.dispose(),(s=this._opacityTexture)==null||s.dispose(),(a=this._reflectionTexture)==null||a.dispose(),(o=this._emissiveTexture)==null||o.dispose(),(l=this._metallicTexture)==null||l.dispose(),(c=this._reflectivityTexture)==null||c.dispose(),(u=this._bumpTexture)==null||u.dispose(),(h=this._lightmapTexture)==null||h.dispose(),(f=this._metallicReflectanceTexture)==null||f.dispose(),(d=this._reflectanceTexture)==null||d.dispose(),(p=this._microSurfaceTexture)==null||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}wt.PBRMATERIAL_OPAQUE=pe.MATERIAL_OPAQUE;wt.PBRMATERIAL_ALPHATEST=pe.MATERIAL_ALPHATEST;wt.PBRMATERIAL_ALPHABLEND=pe.MATERIAL_ALPHABLEND;wt.PBRMATERIAL_ALPHATESTANDBLEND=pe.MATERIAL_ALPHATESTANDBLEND;wt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;wt.LIGHTFALLOFF_PHYSICAL=0;wt.LIGHTFALLOFF_GLTF=1;wt.LIGHTFALLOFF_STANDARD=2;wt.ForceGLSL=!1;I([sT()],wt.prototype,"_imageProcessingConfiguration",void 0);I([ie("_markAllSubMeshesAsMiscDirty")],wt.prototype,"debugMode",void 0);class at extends wt{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===wt.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=wt.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=wt.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===wt.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=wt.LIGHTFALLOFF_GLTF:this._lightFalloff=wt.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=at.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=fe.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new fe(0,0,0),this.albedoColor=new fe(1,1,1),this.reflectivityColor=new fe(1,1,1),this.reflectionColor=new fe(1,1,1),this.emissiveColor=new fe(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=o_(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const r=Ke.Clone(()=>new at(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const r=Ke.Parse(()=>new at(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),pe._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}at.PBRMATERIAL_OPAQUE=wt.PBRMATERIAL_OPAQUE;at.PBRMATERIAL_ALPHATEST=wt.PBRMATERIAL_ALPHATEST;at.PBRMATERIAL_ALPHABLEND=wt.PBRMATERIAL_ALPHABLEND;at.PBRMATERIAL_ALPHATESTANDBLEND=wt.PBRMATERIAL_ALPHATESTANDBLEND;at.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=wt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"directIntensity",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"emissiveIntensity",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"environmentIntensity",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"specularIntensity",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"disableBumpMap",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"albedoTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientTextureStrength",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"opacityTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectionTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"emissiveTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectivityTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallic",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"roughness",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicF0Factor",void 0);I([hi(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicReflectanceColor",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"metallicReflectanceTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectanceTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"microSurfaceTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"bumpTexture",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty",null)],at.prototype,"lightmapTexture",void 0);I([hi("ambient"),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"ambientColor",void 0);I([hi("albedo"),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"albedoColor",void 0);I([hi("reflectivity"),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectivityColor",void 0);I([hi("reflection"),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"reflectionColor",void 0);I([hi("emissive"),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"emissiveColor",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"microSurface",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useLightmapAsShadowmap",void 0);I([M(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"useAlphaFromAlbedoTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"forceAlphaTest",void 0);I([M(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],at.prototype,"alphaCutOff",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useSpecularOverAlpha",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRoughnessFromMetallicTextureGreen",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useMetallnessFromMetallicTextureBlue",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAmbientInGrayScale",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);I([M()],at.prototype,"usePhysicalLightFalloff",null);I([M()],at.prototype,"useGLTFLightFalloff",null);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRadianceOverAlpha",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useObjectSpaceNormalMap",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useParallax",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useParallaxOcclusion",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"parallaxScaleBias",void 0);I([M(),ie("_markAllSubMeshesAsLightsDirty")],at.prototype,"disableLighting",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"forceIrradianceInFragment",void 0);I([M(),ie("_markAllSubMeshesAsLightsDirty")],at.prototype,"maxSimultaneousLights",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"invertNormalMapX",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"invertNormalMapY",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"twoSidedLighting",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useAlphaFresnel",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useLinearAlphaFresnel",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"environmentBRDFTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"forceNormalForward",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"enableSpecularAntiAliasing",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useHorizonOcclusion",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],at.prototype,"useRadianceOcclusion",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],at.prototype,"unlit",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],at.prototype,"applyDecalMapAfterDetailMap",void 0);$("BABYLON.PBRMaterial",at);class br{}br.DEFAULT_COLOR=fe.White();br.DEFAULT_WIDTH_ATTENUATED=1;br.DEFAULT_WIDTH=.1;class Xt{static ConvertPoints(e,t){if(e.length&&Array.isArray(e)&&typeof e[0]=="number")return[e];if(e.length&&Array.isArray(e[0])&&typeof e[0][0]=="number")return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof m){const i=[];for(let r=0;r<e.length;r++){const s=e[r];i.push(s.x,s.y,s.z)}return[i]}else if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof m){const i=[];return e.forEach(s=>{i.push(s.flatMap(a=>[a.x,a.y,a.z]))}),i}else if(e instanceof Float32Array)if(t!=null&&t.floatArrayStride){const i=[],r=t.floatArrayStride*3;for(let s=0;s<e.length;s+=r){const a=new Array(r);for(let o=0;o<r;o++)a[o]=e[s+o];i.push(a)}return i}else return[Array.from(e)];else if(e.length&&e[0]instanceof Float32Array){const i=[];return e.forEach(r=>{i.push(Array.from(r))}),i}return[]}static OmitZeroLengthPredicate(e,t,i){const r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),r.length===0?null:r}static OmitDuplicatesPredicate(e,t,i,r){const s=[];return Xt._SearchInPoints(e,t,r)||s.push([e,t]),Xt._SearchInPoints(t,i,r)||s.push([t,i]),Xt._SearchInPoints(i,e,r)||s.push([i,e]),s.length===0?null:s}static _SearchInPoints(e,t,i){var r,s,a;for(const o of i)for(let l=0;l<o.length;l++)if((r=o[l])!=null&&r.equals(e)&&((s=o[l+1])!=null&&s.equals(t)||(a=o[l-1])!=null&&a.equals(t)))return!0;return!1}static MeshesToLines(e,t){const i=[];return e.forEach((r,s)=>{const a=r.getVerticesData(b.PositionKind),o=r.getIndices();if(a&&o)for(let l=0,c=0;l<o.length;l++){const u=o[c++]*3,h=o[c++]*3,f=o[c++]*3,d=new m(a[u],a[u+1],a[u+2]),p=new m(a[h],a[h+1],a[h+2]),_=new m(a[f],a[f+1],a[f+2]);if(t){const g=t(d,p,_,i,l,u,r,s,a,o);if(g)for(const E of g)i.push(E)}else i.push([d,p],[p,_],[_,d])}}),i}static ToVector3Array(e){if(Array.isArray(e[0])){const r=[],s=e;for(const a of s){const o=[];for(let l=0;l<a.length;l+=3)o.push(new m(a[l],a[l+1],a[l+2]));r.push(o)}return r}const t=e,i=[];for(let r=0;r<t.length;r+=3)i.push(new m(t[r],t[r+1],t[r+2]));return i}static ToNumberArray(e){return e.flatMap(t=>[t.x,t.y,t.z])}static GetPointsCountInfo(e){const t=new Array(e.length);let i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){if(e.length===0)return 0;let t;typeof e[0]=="number"?t=Xt.ToVector3Array(e):t=e;const i=B.Vector3[0];let r=0;for(let s=0;s<t.length-1;s++){const a=t[s],o=t[s+1];r+=o.subtractToRef(a,i).length()}return r}static GetLineLengthArray(e){const t=new Float32Array(e.length/3);let i=0;for(let r=0,s=e.length/3-1;r<s;r++){let a=e[r*3+0],o=e[r*3+1],l=e[r*3+2];a-=e[r*3+3],o-=e[r*3+4],l-=e[r*3+5];const c=Math.sqrt(a*a+o*o+l*l);i+=c,t[r+1]=i}return t}static SegmentizeSegmentByCount(e,t,i){const r=[],s=t.subtract(e),a=B.Vector3[0];a.setAll(i);const o=B.Vector3[1];s.divideToRef(a,o);let l=e.clone();r.push(l);for(let c=0;c<i;c++)l=l.clone(),r.push(l.addInPlace(o));return r}static SegmentizeLineBySegmentLength(e,t){const i=e[0]instanceof m?Xt.GetLineSegments(e):typeof e[0]=="number"?Xt.GetLineSegments(Xt.ToVector3Array(e)):e,r=[];return i.forEach(s=>{s.length>t?Xt.SegmentizeSegmentByCount(s.point1,s.point2,Math.ceil(s.length/t)).forEach(o=>{r.push(o)}):(r.push(s.point1),r.push(s.point2))}),r}static SegmentizeLineBySegmentCount(e,t){const i=typeof e[0]=="number"?Xt.ToVector3Array(e):e,r=Xt.GetLineLength(i)/t;return Xt.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){const t=[];for(let i=0;i<e.length-1;i++){const r=e[i],s=e[i+1],a=s.subtract(r).length();t.push({point1:r,point2:s,length:a})}return t}static GetMinMaxSegmentLength(e){const i=Xt.GetLineSegments(e).sort(r=>r.length);return{min:i[0].length,max:i[i.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){const s=t*i;let a=0,o=0;const l=e.length;for(let u=0;u<l;u++){if(s<=a+e[u].length){o=u;break}a+=e[u].length}const c=(s-a)/e[o].length;return e[o].point2.subtractToRef(e[o].point1,B.Vector3[0]),B.Vector3[1]=B.Vector3[0].multiplyByFloats(c,c,c),r||B.Vector3[1].addInPlace(e[o].point1),B.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,r=e,s=Math.PI*2/t){const a=[];for(let o=0;o<=t;o++)a.push(new m(Math.cos(o*s)*e,Math.sin(o*s)*r,i));return a}static GetBezierLinePoints(e,t,i,r){return Nn.CreateQuadraticBezier(e,t,i,r).getPoints().flatMap(s=>[s.x,s.y,s.z])}static GetArrowCap(e,t,i,r,s,a=0,o=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,s,a,o]}}static GetPointsFromText(e,t,i,r,s=0,a=!0){const o=[],l=hA(e,t,i,r);for(const c of l){for(const u of c.paths){const h=[],f=u.getPoints();for(const d of f)h.push(d.x,d.y,s);o.push(h)}if(a)for(const u of c.holes){const h=[],f=u.getPoints();for(const d of f)h.push(d.x,d.y,s);o.push(h)}}return o}static Color3toRGBAUint8(e){const t=new Uint8Array(e.length*4);for(let i=0,r=0;i<e.length;i++)t[r++]=e[i].r*255,t[r++]=e[i].g*255,t[r++]=e[i].b*255,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){const s=r.getEngine().getCaps().maxTextureSize??1,a=t.length>s?s:t.length,o=Math.ceil(t.length/s);o>1&&(t=[...t,...Array(a*o-t.length).fill(t[0])]);const l=Xt.Color3toRGBAUint8(t),c=new ki(l,a,o,Se.TEXTUREFORMAT_RGBA,r,!1,!0,i);return c.name=e,c}static PrepareEmptyColorsTexture(e){if(!br.EmptyColorsTexture){const t=new Uint8Array(4);br.EmptyColorsTexture=new ki(t,1,1,Se.TEXTUREFORMAT_RGBA,e,!1,!1,ki.NEAREST_NEAREST),br.EmptyColorsTexture.name="grlEmptyColorsTexture"}return br.EmptyColorsTexture}static DisposeEmptyColorsTexture(){var e;(e=br.EmptyColorsTexture)==null||e.dispose(),br.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}}class hB extends Gr{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0}}class so extends is{constructor(e,t,i){i=i||{color:br.DEFAULT_COLOR};const r=new hB;r.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,r.GREASED_LINE_SIZE_ATTENUATION=i.sizeAttenuation??!1,r.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=i.colorDistributionType===1,r.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(t??e.getScene()).useRightHandedSystem,r.GREASED_LINE_CAMERA_FACING=i.cameraFacing??!0,super(e,so.GREASED_LINE_MATERIAL_NAME,200,r),this.colorsTexture=null,this._scene=t??e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=i.cameraFacing??!0,this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.width=i.width?i.width:i.sizeAttenuation?br.DEFAULT_WIDTH_ATTENUATED:br.DEFAULT_WIDTH,this._sizeAttenuation=i.sizeAttenuation??!1,this.colorMode=i.colorMode??0,this._color=i.color??null,this.useColors=i.useColors??!1,this._colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??ki.NEAREST_NEAREST,this._colors=i.colors??null,this.dashCount=i.dashCount??1,this.resolution=i.resolution??new se(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=Xt.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??br.DEFAULT_COLOR,Xt.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add(()=>{Xt.DisposeEmptyColorsTexture()}),this._enable(!0)}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(){const e=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&e.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),{ubo:e,vertex:this._cameraFacing?`
                uniform vec4 grl_aspect_resolution_lineWidth;
                uniform mat4 grl_projection;
                `:"",fragment:`
                uniform vec4 grl_dashOptions;
                uniform vec2 grl_textureSize;
                uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;
                uniform vec3 grl_singleColor;
                `}}get isEnabled(){return!0}bindForSubMesh(e){if(this._cameraFacing){const s=this._scene.activeCamera;if(s){const o=s.getProjectionMatrix();e.updateMatrix("grl_projection",o)}else throw Error("GreasedLinePluginMaterial requires an active camera.");const a=B.Vector4[0];a.x=this._aspect,a.y=this._resolution.x,a.z=this._resolution.y,a.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",a)}const t=B.Vector4[0];t.x=Xt.BooleanToNumber(this.useDash),t.y=this._dashArray,t.z=this.dashOffset,t.w=this.dashRatio,e.updateVector4("grl_dashOptions",t);const i=B.Vector4[1];i.x=this.colorMode,i.y=this.visibility,i.z=this.colorsTexture?this.colorsTexture.getSize().width:0,i.w=Xt.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",i),this._color&&e.updateColor3("grl_singleColor",this._color);const r=this.colorsTexture??br.EmptyColorsTexture;e.setTexture("grl_colors",r),e.updateFloat2("grl_textureSize",(r==null?void 0:r.getSize().width)??1,(r==null?void 0:r.getSize().height)??1)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=this._colorsDistributionType===1,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing}getClassName(){return so.GREASED_LINE_MATERIAL_NAME}getCustomCode(e){if(e==="vertex"){const t={CUSTOM_VERTEX_DEFINITIONS:`
                attribute float grl_widths;
                attribute vec3 grl_offsets;
                attribute float grl_colorPointers;
                varying float grlCounters;
                varying float grlColorPointer;

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute vec4 grl_previousAndSide;
                    attribute vec4 grl_nextAndCounters;

                    vec2 grlFix( vec4 i, float aspect ) {
                        vec2 res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute vec3 grl_slopes;
                    attribute float grl_counters;
                #endif
                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_CAMERA_FACING
                    vec3 grlPositionOffset = grl_offsets;
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                grlColorPointer = grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    float grlAspect = grl_aspect_resolution_lineWidth.x;
                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;


                    vec3 grlPrevious = grl_previousAndSide.xyz;
                    float grlSide = grl_previousAndSide.w;

                    vec3 grlNext = grl_nextAndCounters.xyz;
                    grlCounters = grl_nextAndCounters.w;

                    mat4 grlMatrix = viewProjection * finalWorld;
                    vec4 grlFinalPosition = grlMatrix * vec4( positionUpdated , 1.0 );
                    vec4 grlPrevPos = grlMatrix * vec4( grlPrevious + grlPositionOffset, 1.0 );
                    vec4 grlNextPos = grlMatrix * vec4( grlNext + grlPositionOffset, 1.0 );

                    vec2 grlCurrentP = grlFix( grlFinalPosition, grlAspect );
                    vec2 grlPrevP = grlFix( grlPrevPos, grlAspect );
                    vec2 grlNextP = grlFix( grlNextPos, grlAspect );

                    float grlWidth = grlBaseWidth * grl_widths;

                    vec2 grlDir;
                    if( grlNextP == grlCurrentP ) grlDir = normalize( grlCurrentP - grlPrevP );
                    else if( grlPrevP == grlCurrentP ) grlDir = normalize( grlNextP - grlCurrentP );
                    else {
                        vec2 grlDir1 = normalize( grlCurrentP - grlPrevP );
                        vec2 grlDir2 = normalize( grlNextP - grlCurrentP );
                        grlDir = normalize( grlDir1 + grlDir2 );
                    }
                    vec4 grlNormal = vec4( -grlDir.y, grlDir.x, 0., 1. );
                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
                        grlNormal.xy *= -.5 * grlWidth;
                    #else
                        grlNormal.xy *= .5 * grlWidth;
                    #endif

                    grlNormal *= grl_projection;

                    #ifdef GREASED_LINE_SIZE_ATTENUATION
                        grlNormal.xy *= grlFinalPosition.w;
                        grlNormal.xy /= ( vec4( grl_aspect_resolution_lineWidth.yz, 0., 1. ) * grl_projection ).xy;
                    #endif

                    grlFinalPosition.xy += grlNormal.xy * grlSide;
                    gl_Position = grlFinalPosition;

                    vPositionW = vec3(grlFinalPosition);
                #else
                    grlCounters = grl_counters;
                #endif
                `};return this._cameraFacing&&(t["!gl_Position\\=viewProjection\\*worldPos;"]="//"),t}return e==="fragment"?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    varying float grlCounters;
                    varying float grlColorPointer;
                    uniform sampler2D grl_colors;
                `,CUSTOM_FRAGMENT_MAIN_END:`
                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;
                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;
                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;
                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;

                    float grlUseDash = grl_dashOptions.x;
                    float grlDashArray = grl_dashOptions.y;
                    float grlDashOffset = grl_dashOptions.z;
                    float grlDashRatio = grl_dashOptions.w;

                    gl_FragColor.a *= step(grlCounters, grlVisibility);
                    if( gl_FragColor.a == 0. ) discard;

                    if(grlUseDash == 1.){
                        gl_FragColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));
                        if (gl_FragColor.a == 0.) discard;
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == 0.) {
                            gl_FragColor.rgb = grl_singleColor;
                        } else if (grlColorMode == 1.) {
                            gl_FragColor.rgb += grl_singleColor;
                        } else if (grlColorMode == 2.) {
                            gl_FragColor.rgb *= grl_singleColor;
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);
                            #else
                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));
                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);
                            #endif
                            if (grlColorMode == 0.) {
                                gl_FragColor = grlColor;
                            } else if (grlColorMode == 1.) {
                                gl_FragColor += grlColor;
                            } else if (grlColorMode == 2.) {
                                gl_FragColor *= grlColor;
                            }
                        }
                    #endif

                `}:null}dispose(){var e;(e=this.colorsTexture)==null||e.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var s,a,o;const r=((s=this._colors)==null?void 0:s.length)??0;if(this._colors=e,e===null||e.length===0){(a=this.colorsTexture)==null||a.dispose();return}if(!(t&&!i))if(this.colorsTexture&&r===e.length&&!i){const l=Xt.Color3toRGBAUint8(e);this.colorsTexture.update(l)}else(o=this.colorsTexture)==null||o.dispose(),this.colorsTexture=Xt.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){this._color===null&&e!==null||this._color!==null&&e===null?(this._color=e,!t&&this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var s;super.parse(e,t,i);const r=e.greasedLineMaterialOptions;(s=this.colorsTexture)==null||s.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=Xt.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):Xt.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){var i;const t=e;(i=t.colorsTexture)==null||i.dispose(),this._colors&&(t.colorsTexture=Xt.CreateColorsTexture(`${t._material.name}-colors-texture`,this._colors,t.colorsSampling,this._scene)),t.setColor(this.color,!0),t.colorsDistributionType=this.colorsDistributionType,t.colorsSampling=this.colorsSampling,t.colorMode=this.colorMode,t.useColors=this.useColors,t.visibility=this.visibility,t.useDash=this.useDash,t.dashCount=this.dashCount,t.dashRatio=this.dashRatio,t.dashOffset=this.dashOffset,t.width=this.width,t.sizeAttenuation=this.sizeAttenuation,t.resolution=this.resolution,t.markAllDefinesAsDirty()}}so.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial";$(`BABYLON.${so.GREASED_LINE_MATERIAL_NAME}`,so);const fB="greasedLinePixelShader",dB=`precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}
if (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { 
textureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}
if (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}
`;V.ShadersStore[fB]=dB;const pB="greasedLineVertexShader",_B=`precision highp float;
#include<instancesDeclaration>
attribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;
#ifdef GREASED_LINE_CAMERA_FACING
attribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}
#else
attribute vec3 grl_slopes;attribute float grl_counters;
#endif
void main() {
#include<instancesVertex>
grlColorPointer=grl_colorPointers;mat4 grlMatrix=viewProjection*finalWorld ;
#ifdef GREASED_LINE_CAMERA_FACING
float grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;vec3 grlPositionOffset=grl_offsets;vec4 grlFinalPosition=grlMatrix*vec4( position+grlPositionOffset ,1.0 );vec4 grlPrevPos=grlMatrix*vec4( grlPrevious+grlPositionOffset,1.0 );vec4 grlNextPos=grlMatrix*vec4( grlNext+grlPositionOffset,1.0 );vec2 grlCurrentP=grlFix( grlFinalPosition,grlAspect );vec2 grlPrevP=grlFix( grlPrevPos,grlAspect );vec2 grlNextP=grlFix( grlNextPos,grlAspect );float grlWidth=grlBaseWidth*grl_widths;vec2 grlDir;if( grlNextP==grlCurrentP ) grlDir=normalize( grlCurrentP-grlPrevP );else if( grlPrevP==grlCurrentP ) grlDir=normalize( grlNextP-grlCurrentP );else {vec2 grlDir1=normalize( grlCurrentP-grlPrevP );vec2 grlDir2=normalize( grlNextP-grlCurrentP );grlDir=normalize( grlDir1+grlDir2 );}
vec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );
#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
grlNormal.xy*=-.5*grlWidth;
#else
grlNormal.xy*=.5*grlWidth;
#endif
grlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}
grlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;
#else
grlCounters=grl_counters;vec4 grlFinalPosition=grlMatrix*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;
#endif
}
`;V.ShadersStore[pB]=_B;class mB extends $n{constructor(e,t,i){const r=["COLOR_DISTRIBUTION_TYPE_LINE 1.","COLOR_DISTRIBUTION_TYPE_SEGMENT 0.","COLOR_MODE_SET 0.","COLOR_MODE_ADD 1.","COLOR_MODE_MULTIPLY 2."],s=["position","grl_widths","grl_offsets","grl_colorPointers"];t.useRightHandedSystem&&r.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM"),i.cameraFacing?(r.push("GREASED_LINE_CAMERA_FACING"),s.push("grl_previousAndSide","grl_nextAndCounters")):(s.push("grl_slopes"),s.push("grl_counters")),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{attributes:s,uniforms:["world","viewProjection","view","projection","grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility"],samplers:["grlColors"],defines:r}),this._color=fe.White(),this._colorsDistributionType=0,this._colorsTexture=null,i=i||{color:br.DEFAULT_COLOR};const a=t.getEngine();this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.dashCount=i.dashCount??1,this.width=i.width?i.width:i.sizeAttenuation&&i.cameraFacing?br.DEFAULT_WIDTH_ATTENUATED:br.DEFAULT_WIDTH,this.sizeAttenuation=i.sizeAttenuation??!1,this.color=i.color??fe.White(),this.useColors=i.useColors??!1,this.colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??ki.NEAREST_NEAREST,this.colorMode=i.colorMode??0,this._colors=i.colors??null,this._cameraFacing=i.cameraFacing??!0,this.resolution=i.resolution??new se(a.getRenderWidth(),a.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this.colorsTexture=Xt.PrepareEmptyColorsTexture(t),this._colors&&this.useColors&&(this.colorsTexture=Xt.CreateColorsTexture(`${this.name}-colors-texture`,this._colors,this.colorsSampling,t)),a.onDisposeObservable.add(()=>{Xt.DisposeEmptyColorsTexture()})}dispose(){var e;(e=this._colorsTexture)==null||e.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new se(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){var s,a,o;const r=((s=this._colors)==null?void 0:s.length)??0;if(this._colors=e,e===null||e.length===0){(a=this._colorsTexture)==null||a.dispose();return}if(!(t&&!i))if(this._colorsTexture&&r===e.length&&!i){const l=Xt.Color3toRGBAUint8(e);this._colorsTexture.update(l)}else(o=this._colorsTexture)==null||o.dispose(),this.colorsTexture=Xt.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",Xt.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",Xt.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",Xt.BooleanToNumber(e))}get color(){return this._color}set color(e){this.setColor(e)}setColor(e){e=e??br.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){const e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){var s;const r=e.greasedLineMaterialOptions;(s=this._colorsTexture)==null||s.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=Xt.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=Xt.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}var FE;(function(n){n[n.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",n[n.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS"})(FE||(FE={}));var wE;(function(n){n[n.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",n[n.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",n[n.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED"})(wE||(wE={}));var BE;(function(n){n[n.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",n[n.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",n[n.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",n[n.AUTO_DIRECTIONS_FACE_TO=3]="AUTO_DIRECTIONS_FACE_TO",n[n.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE"})(BE||(BE={}));class fA extends k{constructor(e,t,i){super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=i.lazy??!1,this._updatable=i.updatable??!1,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=i.colorPointers??[],this._widths=i.widths??new Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(const r of this._points)t+=r.length;const i=t/3*2-this._widths.length;for(let r=0;r<i;r++)this._widths.push(e)}updateLazy(){var e,t;this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers((e=this._options.ribbonOptions)==null?void 0:e.smoothShading),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo(),(t=this.greasedLineMaterial)==null||t.updateLazy()}addPoints(e,t){for(const i of e)this._points.push(i);this._lazy||this.setPoints(this._points,t)}dispose(e,t=!1){super.dispose(e,t)}isLazy(){return this._lazy}get uvs(){return this._uvs}set uvs(e){this._uvs=e instanceof Float32Array?e:new Float32Array(e),this._createVertexBuffers()}get offsets(){return this._offsets}set offsets(e){this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){var t,i;if(this.material&&this.material instanceof mB)return this.material;const e=(i=(t=this.material)==null?void 0:t.pluginManager)==null?void 0:i.getPlugin(so.GREASED_LINE_MATERIAL_NAME);if(e)return e}get points(){const e=[];return cr.DeepCopy(this._points,e),e}setPoints(e,t){this._points=Xt.ConvertPoints(e,(t==null?void 0:t.pointsOptions)??this._options.pointsOptions),this._updateWidths(),t!=null&&t.colorPointers||this._updateColorPointers(),this._setPoints(this._points,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){const t=new de;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],de.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){const t=this._scene.getEngine(),i=new tr(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}k._GreasedLineMeshParser=(n,e)=>hr.Parse(n,e);class hr extends fA{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(Xt.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[],this._points.forEach(t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)})}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,s=0,a=0;e.forEach(E=>{i+=E.length*2,r+=(E.length-3)*2,s+=E.length*4/3,a+=E.length*8/3});const o=new Float32Array(i),l=i>65535?new Uint32Array(r):new Uint16Array(r),c=new Float32Array(s),u=new Float32Array(a),h=new Float32Array(a);let f=0,d=0,p=0,_=0,g=0;e.forEach(E=>{const v=Xt.GetLineLengthArray(E),x=v[v.length-1];for(let F=0,W=0;W<E.length;F++,W+=3){const H=f+W*2;if(o[H+0]=E[W+0],o[H+1]=E[W+1],o[H+2]=E[W+2],o[H+3]=E[W+0],o[H+4]=E[W+1],o[H+5]=E[W+2],W<E.length-3){const ue=F*2+t,ae=d+W*2;l[ae+0]=ue,l[ae+1]=ue+1,l[ae+2]=ue+2,l[ae+3]=ue+2,l[ae+4]=ue+1,l[ae+5]=ue+3}}t+=E.length/3*2;const A=E.length*2,T=o.subarray(f,f+A);f+=A,d+=(E.length-3)*2;const C=new Float32Array(T.length),y=new Float32Array(T.length),P=T.length/6;let D;hr._CompareV3(0,P-1,T)?D=T.subarray((P-2)*6,(P-1)*6):D=T.subarray(0,6),C.set(D),C.set(T.subarray(0,T.length-6),6),y.set(T.subarray(6)),hr._CompareV3(P-1,0,T)?D=T.subarray(6,12):D=T.subarray((P-1)*6,P*6),y.set(D,y.length-6);for(let F=0,W=T.length/3;F<W;F++)u[_++]=C[F*3],u[_++]=C[F*3+1],u[_++]=C[F*3+2],u[_++]=1-((F&1)<<1),h[g++]=y[F*3],h[g++]=y[F*3+1],h[g++]=y[F*3+2],h[g++]=v[F>>1]/x;if(this._options.uvs)for(let F=0;F<this._options.uvs.length;F++)c[p++]=this._options.uvs[F];else for(let F=0;F<P;F++){const W=v[F]/x,H=p+F*4;c[H+0]=W,c[H+1]=0,c[H+2]=W,c[H+3]=1}}),this._vertexPositions=o,this._indices=l,this._uvs=c,this._previousAndSide=u,this._nextAndCounters=h,this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={};cr.DeepCopy(i,r,["instance"],void 0,!0);const s=new hr(e,this._scene,r);return t&&(s.parent=t),s.material=this.material,s}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){const i=e.lineOptions,r=e.name;return new hr(r,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,s,a=!1){const o=new es,l=this.findAllIntersections(e,t,i,r,s,a,!0);if((l==null?void 0:l.length)===1){const c=l[0];o.hit=!0,o.distance=c.distance,o.ray=e,o.pickedMesh=this,o.pickedPoint=c.point}return o}findAllIntersections(e,t,i,r=!1,s,a=!1,o=!1){var d;if(r&&!a&&e.intersectsSphere(this._boundingSphere,this.intersectionThreshold)===!1)return;const l=this.getIndices(),c=this.getVerticesData(b.PositionKind),u=this._widths,h=((d=this.greasedLineMaterial)==null?void 0:d.width)??1,f=[];if(l&&c&&u){let p=0,_=0;for(p=0,_=l.length-1;p<_;p+=3){const g=l[p],E=l[p+1];hr._V_START.fromArray(c,g*3),hr._V_END.fromArray(c,E*3),this._offsets&&(hr._V_OFFSET_START.fromArray(this._offsets,g*3),hr._V_OFFSET_END.fromArray(this._offsets,E*3),hr._V_START.addInPlace(hr._V_OFFSET_START),hr._V_END.addInPlace(hr._V_OFFSET_END));const v=Math.floor(p/3),x=u[v]!==void 0?u[v]:1,A=this.intersectionThreshold*(h*x)/2,T=e.intersectionSegment(hr._V_START,hr._V_END,A);if(T!==-1&&(f.push({distance:T,point:e.direction.normalize().multiplyByFloats(T,T,T).add(e.origin)}),o))return f}p=_}return f}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){const r=e*6,s=t*6;return i[r]===i[s]&&i[r+1]===i[s+1]&&i[r+2]===i[s+2]}_createVertexBuffers(){const e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new tr(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));const r=new tr(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));const s=new tr(t,this._widths,this._updatable,1);this.setVerticesBuffer(s.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=s;const a=new tr(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(a.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=a,e}}hr._V_START=new m;hr._V_END=new m;hr._V_OFFSET_START=new m;hr._V_OFFSET_END=new m;k._GreasedLineRibbonMeshParser=(n,e)=>Vi.Parse(n,e);class Vi extends fA{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(Xt.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){const{options:i,pathCount:r}=this._pathsOptions[t],s=this._points[t];if(i.ribbonOptions.pointsMode===0)for(let a=0;a<r;a++)for(let o=0;o<s.length;o+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let a=0;a<s.length;a+=3){for(let o=0;o<r;o++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){var s,a;if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let i=0,r;for(let o=0,l=0;o<this._pathsOptions.length;o++){const{options:c,pathCount:u}=this._pathsOptions[o],h=e.slice(l,l+u);if(l+=u,((s=c.ribbonOptions)==null?void 0:s.pointsMode)===1)i=this._preprocess(Xt.ToVector3Array(h),i,c);else{if(((a=c.ribbonOptions)==null?void 0:a.directionsAutoMode)===99){if(!c.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";r=Vi._GetDirectionPlanesFromDirectionsOption(h.length,c.ribbonOptions.directions)}h.forEach((f,d)=>{const p=Vi._ConvertToRibbonPath(f,c.ribbonOptions,this._scene.useRightHandedSystem,r&&r[d]);i=this._preprocess(p,i,c)})}}this._lazy||(this._createVertexBuffers(),!this.doNotSyncBoundingInfo&&this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:new Array(e).fill(t)}static _CreateRibbonVertexData(e,t){var u,h;const i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";const r=[],s=[],a=e[0];for(let f=0;f<a.length;f++)for(let d=0;d<e.length;d++){const p=e[d][f];r.push(p.x,p.y,p.z)}const o=[1,0,i],l=((u=t.ribbonOptions)==null?void 0:u.facesMode)===2,c=((h=t.ribbonOptions)==null?void 0:h.pointsMode)===1&&t.ribbonOptions.closePath;if(i>2)for(let f=0;f<a.length-1;f++){o[0]=1+i*f,o[1]=i*f,o[2]=(f+1)*i;for(let d=0;d<(i-1)*2;d++)d%2!==0&&(o[2]+=1),d%2===0&&d>0&&(o[0]+=1,o[1]+=1),s.push(o[1]+(d%2!==0?i:0),o[0],o[2]),l&&s.push(o[0],o[1]+(d%2!==0?i:0),o[2])}else for(let f=0;f<r.length/3-3;f+=2)s.push(f,f+1,f+2),s.push(f+2,f+1,f+3),l&&(s.push(f+1,f,f+2),s.push(f+1,f+2,f+3));if(c){let f=i*(a.length-1);for(let d=0;d<i-1;d++)s.push(f,d+1,d),s.push(f+1,d+1,f),l&&(s.push(d,d+1,f),s.push(f,d+1,f+1)),f++}return{positions:r,indices:s}}_preprocess(e,t,i){var d,p;this._paths=e;const r=Vi._CreateRibbonVertexData(e,i),s=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";const a=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=a;const o=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=o;const l=Array.isArray(this._indices)?this._indices:Array.from(this._indices);this._indices=l;for(const _ of s)a.push(_);let c=e;if(((d=i.ribbonOptions)==null?void 0:d.pointsMode)===1&&i.ribbonOptions.closePath){c=[];for(let _=0;_<e.length;_++){const g=e[_].slice();g.push(e[_][0].clone()),c.push(g)}}this._calculateSegmentLengths(c);const u=c.length,h=new Array(u).fill(0);for(let _=0;_<c[0].length;_++){let g=0;for(let E=0;E<u;E++){const v=h[E]+this._vSegmentLengths[E][_]/this._vTotalLengths[E];this._counters.push(v),o.push(v,g),h[E]=v,g+=this._uSegmentLengths[_][E]/this._uTotalLengths[_]}}for(let _=0,g=0;_<c[0].length;_++){const E=this._uSegmentLengths[_][0]/2,v=this._uSegmentLengths[_][u-1]/2;this._ribbonWidths.push(((this._widths[g++]??1)-1)*E);for(let x=0;x<u-2;x++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[g++]??1)-1)*v)}const f=((p=i.ribbonOptions)==null?void 0:p.pointsMode)===1?new Array(c[0].length*c.length*6).fill(0):Vi._CalculateSlopes(c);for(const _ of f)this._slopes.push(_);if(r.indices)for(let _=0;_<r.indices.length;_++)l.push(r.indices[_]+t);return t+=s.length/3,t}static _ConvertToRibbonPath(e,t,i,r){if(t.pointsMode===0&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";const s=[],a=[];if(t.pointsMode===0){const o=t.width/2,l=Xt.ToVector3Array(e);let c=null,u=null;if(t.directionsAutoMode===0&&(r=Vi._GetDirectionFromPoints(l[0],l[1],null)),t.directionsAutoMode===3&&!(t.directions instanceof m))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";B.Vector3[1]=t.directions instanceof m?t.directions:Vi.DIRECTION_XZ;for(let h=0;h<l.length-(r?0:1);h++){const f=l[h],d=l[h+1];if(r)c=r;else if(t.directionsAutoMode===3)d.subtractToRef(f,B.Vector3[0]),c=m.CrossToRef(B.Vector3[0],B.Vector3[1],B.Vector3[2]).normalize();else if(t.directionsAutoMode===1)c=Vi._GetDirectionFromPoints(f,d,c);else{const p=d.subtract(f);p.applyRotationQuaternionInPlace(p.x>p.y&&p.x>p.z?i?Vi._RightHandedForwardReadOnlyQuaternion:Vi._LeftHandedForwardReadOnlyQuaternion:Vi._LeftReadOnlyQuaternion),c=p.normalize()}u=c.multiplyByFloats(o,o,o),s.push(f.add(u)),a.push(f.subtract(u))}r||(s.push(l[l.length-1].add(u)),a.push(l[l.length-1].subtract(u)))}return[s,a]}static _GetDirectionFromPoints(e,t,i){return e.x===t.x&&(!i||(i==null?void 0:i.x)===1)?Vi.DIRECTION_YZ:e.y===t.y?Vi.DIRECTION_XZ:e.z===t.z?Vi.DIRECTION_XY:Vi.DIRECTION_XZ}clone(e=`${this.name}-cloned`,t){const i=this._createLineOptions(),r={},s=[];cr.DeepCopy(this._pathsOptions,s,void 0,void 0,!0),cr.DeepCopy(i,r,["instance"],void 0,!0);const a=new Vi(e,this._scene,r,s);return t&&(a.parent=t),a.material=this.material,a}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){const i=e.lineOptions,r=e.name,s=e.pathOptions;return new Vi(r,t,i,s)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){const t=e.length;this._vSegmentLengths=new Array(t),this._vTotalLengths=new Array(t);let i=0;for(let a=0;a<t;a++){const o=e[a];this._vSegmentLengths[a]=[0],i=0;for(let l=0;l<o.length-1;l++){const c=Math.abs(o[l].subtract(o[l+1]).lengthSquared());i+=c,this._vSegmentLengths[a].push(c)}this._vTotalLengths[a]=i}const r=e[0].length;this._uSegmentLengths=new Array(r).fill([]),this._uTotalLengths=new Array(r).fill([]);const s=new m;for(let a=0;a<r;a++){i=0;for(let o=1;o<t;o++){e[o][a].subtractToRef(e[o-1][a],s);const l=s.length();i+=l,this._uSegmentLengths[a].push(l)}this._uTotalLengths[a]=i}}static _CalculateSlopes(e){const t=e[0],i=e.length===2?e[1]:e[e.length-1],r=[],s=new m;for(let a=0;a<t.length;a++)for(let o=0;o<e.length;o++)o===0||o===e.length-1?(t[a].subtract(i[a]).normalizeToRef(s),r.push(s.x,s.y,s.z),r.push(-s.x,-s.y,-s.z)):r.push(0,0,0,0,0,0);return r}_createVertexBuffers(){var a;this._uvs=this._options.uvs??this._uvs;const e=super._createVertexBuffers((a=this._options.ribbonOptions)==null?void 0:a.smoothShading),t=new tr(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));const i=new tr(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));const r=new tr(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));const s=new tr(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(s.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=s,e}}Vi.DEFAULT_WIDTH=.1;Vi._RightHandedForwardReadOnlyQuaternion=ce.RotationAxis(m.RightHandedForwardReadOnly,Math.PI/2);Vi._LeftHandedForwardReadOnlyQuaternion=ce.RotationAxis(m.LeftHandedForwardReadOnly,Math.PI/2);Vi._LeftReadOnlyQuaternion=ce.RotationAxis(m.LeftReadOnly,Math.PI/2);Vi.DIRECTION_XY=m.LeftHandedForwardReadOnly;Vi.DIRECTION_XZ=m.UpReadOnly;Vi.DIRECTION_YZ=m.LeftReadOnly;var VE;(function(n){n[n.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",n[n.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",n[n.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",n[n.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",n[n.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",n[n.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END"})(VE||(VE={}));var UE;(function(n){n[n.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",n[n.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",n[n.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",n[n.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",n[n.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",n[n.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"})(UE||(UE={}));let Jc=0;function gB(n,e){return new Promise((t,i)=>{let r,s;if(Yi())r=window,s="window";else if(typeof self<"u")r=self,s="self";else{i(new Error("Cannot load script module outside of a window or a worker"));return}r._LoadScriptModuleResolve||(r._LoadScriptModuleResolve={}),r._LoadScriptModuleResolve[Jc]=t,n+=`
            ${s}._LoadScriptModuleResolve[${Jc}](returnedValue);
            ${s}._LoadScriptModuleResolve[${Jc}] = undefined;
        `,Jc++,J.LoadScript(n,void 0,(a,o)=>{i(o||new Error(a))},e,!0)})}let Ho,Sd,_u;class lc{get numProp(){return this._numProp}constructor(e,t,i){this._manifold=e,this._numProp=t,this._vertexStructure=i}_process(e,t){if(this.numProp!==t.numProp)throw new Error("CSG must be used with geometries having the same number of properties");return new lc(Ho[e](this._manifold,t._manifold),this.numProp,this._vertexStructure)}subtract(e){return this._process("difference",e)}intersect(e){return this._process("intersection",e)}add(e){return this._process("union",e)}printDebug(){w.Log("Genus:"+this._manifold.genus());const e=this._manifold.getProperties();w.Log("Volume:"+e.volume),w.Log("surface area:"+e.surfaceArea)}toVertexData(e){const t={rebuildNormals:!1,...e},i=new de,r=this._vertexStructure.find(l=>l.kind===b.NormalKind),s=this._manifold.getMesh(t.rebuildNormals&&r?[3,4,5]:void 0);i.indices=s.triVerts.length>65535?new Uint32Array(s.triVerts):new Uint16Array(s.triVerts);for(let l=0;l<s.triVerts.length;l+=3)i.indices[l]=s.triVerts[l+2],i.indices[l+1]=s.triVerts[l+1],i.indices[l+2]=s.triVerts[l];const a=s.vertProperties.length/s.numProp;let o=0;for(let l=0;l<this._vertexStructure.length;l++){const c=this._vertexStructure[l],u=new Float32Array(a*c.stride);for(let h=0;h<a;h++)for(let f=0;f<c.stride;f++)u[h*c.stride+f]=s.vertProperties[h*s.numProp+o+f];i.set(u,c.kind),o+=c.stride}return i}toMesh(e,t,i){const r={rebuildNormals:!1,centerMesh:!0,...i},s=this.toVertexData({rebuildNormals:r.rebuildNormals}),a=this._vertexStructure.find(p=>p.kind===b.NormalKind),o=this._manifold.getMesh(r.rebuildNormals&&a?[3,4,5]:void 0),l=o.vertProperties.length/o.numProp,c=new k(e,t);if(s.applyToMesh(c),r.centerMesh){const p=c.getBoundingInfo().boundingSphere.center;c.position.set(-p.x,-p.y,-p.z),c.bakeCurrentTransformIntoVertices()}let u=o.runOriginalID[0],h=o.runIndex[0],f=0;const d=[];t=c.getScene();for(let p=0;p<o.numRun;++p){const _=o.runOriginalID[p+1];if(_!==u){const g=o.runIndex[p+1];new _r(f,0,l,h,g-h,c),d.push(t.getMaterialByUniqueID(u-_u)||t.defaultMaterial),u=_,h=g,f++}}if(r.materialToUse)c.material=r.materialToUse;else if(d.length>1){const p=new Yn(e,t);p.subMaterials=d,c.material=p}else c.material=d[0];return c}dispose(){this._manifold&&(this._manifold.delete(),this._manifold=null)}static _ProcessData(e,t,i,r,s,a){const o=new Float32Array(e*i.reduce((u,h)=>u+h.stride,0));for(let u=0;u<e;u++){let h=0;for(let f=0;f<i.length;f++){const d=i[f];for(let p=0;p<d.stride;p++)o[u*r+h+p]=d.data[u*d.stride+p];h+=d.stride}}const l=new Sd({numProp:r,vertProperties:o,triVerts:t,runIndex:s,runOriginalID:a});l.merge();let c;try{c=new lc(new Ho(l),r,i)}catch(u){throw new Error("Error while creating the CSG: "+u.message)}return c}static _Construct(e,t,i,r){const s=new Uint32Array(e.indices.length);for(let h=0;h<e.indices.length;h+=3)s[h]=e.indices[h+2],s[h+1]=e.indices[h+1],s[h+2]=e.indices[h];const a=new m;let o=3;const l=[{stride:3,kind:b.PositionKind}];if(!t)l[0].data=e.positions;else{const h=new Float32Array(e.positions.length);for(let f=0;f<e.positions.length;f+=3)m.TransformCoordinatesFromFloatsToRef(e.positions[f],e.positions[f+1],e.positions[f+2],t,a),a.toArray(h,f);l[0].data=h}const c=e.normals;if(c)if(o+=3,l.push({stride:3,kind:b.NormalKind}),!t)l[1].data=c;else{const h=new Float32Array(c.length);for(let f=0;f<c.length;f+=3)m.TransformNormalFromFloatsToRef(c[f],c[f+1],c[f+2],t,a),a.toArray(h,f);l[1].data=h}for(const h of[b.UVKind,b.UV2Kind,b.UV3Kind,b.UV4Kind,b.UV5Kind,b.UV6Kind]){const f=e[h===b.UVKind?"uvs":h];f&&(o+=2,l.push({stride:2,kind:h,data:f}))}const u=e.colors;return u&&(o+=4,l.push({stride:4,kind:b.ColorKind,data:u})),this._ProcessData(e.positions.length/3,s,l,o,i,r)}static FromVertexData(e){const t=e.positions,i=e.indices;if(!t||!i)throw new Error("The vertexData must at least have positions and indices");return this._Construct(e,null)}static FromMesh(e,t=!1){const i=e.getVerticesData(b.PositionKind),r=e.getIndices(),s=e.computeWorldMatrix(!0);if(!i||!r)throw new Error("The mesh must at least have positions and indices");const a=[...Array(e.subMeshes.length)].map((p,_)=>e.subMeshes[_].indexStart),o=e.material||e.getScene().defaultMaterial,l=o.getClassName()==="MultiMaterial",c=[...Array(e.subMeshes.length)].map((p,_)=>l?_u+o.subMaterials[e.subMeshes[_].materialIndex].uniqueId:_u+o.uniqueId),u=Array.from(a.keys());u.sort((p,_)=>a[p]-a[_]);const h=new Uint32Array(u.map(p=>a[p])),f=new Uint32Array(u.map(p=>c[p])),d={positions:i,indices:r,normals:e.getVerticesData(b.NormalKind),colors:e.getVerticesData(b.ColorKind),uvs:e.getVerticesData(b.UVKind),uvs2:e.getVerticesData(b.UV2Kind),uvs3:e.getVerticesData(b.UV3Kind),uvs4:e.getVerticesData(b.UV4Kind),uvs5:e.getVerticesData(b.UV5Kind),uvs6:e.getVerticesData(b.UV6Kind)};return this._Construct(d,t?null:s,h,f)}}function EB(){return Ho!==void 0}async function vB(n){const e={manifoldUrl:"https://unpkg.com/manifold-3d@2.5.1",...n};if(e.manifoldInstance)Ho=e.manifoldInstance,Sd=e.manifoldMeshInstance;else{const t=await gB(`
            import Module from '${e.manifoldUrl}/manifold.js';
            const wasm = await Module();
            wasm.setup();
            const {Manifold, Mesh} = wasm;
            const returnedValue =  {Manifold, Mesh};
        `);Ho=t.Manifold,Sd=t.Mesh}_u=Ho.reserveIDs(65536)}k.prototype.thinInstanceAdd=function(n,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return w.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(n)?n.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(n))for(let i=0;i<n.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,n[i],i===n.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,n,e);return t};k.prototype.thinInstanceAddSelf=function(n=!0){return this.thinInstanceAdd(O.IdentityReadOnly,n)};k.prototype.thinInstanceRegisterAttribute=function(n,e){n===b.ColorKind&&(n=b.ColorInstanceKind),this.removeVerticesData(n),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[n]=e,this._userThinInstanceBuffersStorage.sizes[n]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[n]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[n]),this._userThinInstanceBuffersStorage.vertexBuffers[n]=new b(this.getEngine(),this._userThinInstanceBuffersStorage.data[n],n,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n])};k.prototype.thinInstanceSetMatrixAt=function(n,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||n>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,n*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[n]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};k.prototype.thinInstanceSetAttributeAt=function(n,e,t,i=!0){return n===b.ColorKind&&(n=b.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[n]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(n,0),this._userThinInstanceBuffersStorage.data[n].set(t,e*this._userThinInstanceBuffersStorage.strides[n]),i&&this.thinInstanceBufferUpdated(n),!0)};Object.defineProperty(k.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(n){var i;const e=this._thinInstanceDataStorage.matrixData??((i=this.source)==null?void 0:i._thinInstanceDataStorage.matrixData),t=e?e.length/16:0;n<=t&&(this._thinInstanceDataStorage.instancesCount=n)},enumerable:!0,configurable:!0});k.prototype._thinInstanceCreateMatrixBuffer=function(n,e,t=!0){const i=new tr(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(n+r,r*4,4));return i};k.prototype.thinInstanceSetBuffer=function(n,e,t=0,i=!0){var r,s,a;t=t||16,n==="matrix"?((r=this._thinInstanceDataStorage.matrixBuffer)==null||r.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):n==="previousMatrix"?((s=this._thinInstanceDataStorage.previousMatrixBuffer)==null||s.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(n===b.ColorKind&&(n=b.ColorInstanceKind),e===null?(a=this._userThinInstanceBuffersStorage)!=null&&a.data[n]&&(this.removeVerticesData(n),delete this._userThinInstanceBuffersStorage.data[n],delete this._userThinInstanceBuffersStorage.strides[n],delete this._userThinInstanceBuffersStorage.sizes[n],delete this._userThinInstanceBuffersStorage.vertexBuffers[n]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[n]=e,this._userThinInstanceBuffersStorage.strides[n]=t,this._userThinInstanceBuffersStorage.sizes[n]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[n]=new b(this.getEngine(),e,n,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n])))};k.prototype.thinInstanceBufferUpdated=function(n){var e,t,i;n==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(n),(e=this._thinInstanceDataStorage.matrixBuffer)==null||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):n==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(n),(t=this._thinInstanceDataStorage.previousMatrixBuffer)==null||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(n===b.ColorKind&&(n=b.ColorInstanceKind),(i=this._userThinInstanceBuffersStorage)!=null&&i.vertexBuffers[n]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[n].isUpdatable()&&this._thinInstanceRecreateBuffer(n),this._userThinInstanceBuffersStorage.vertexBuffers[n].updateDirectly(this._userThinInstanceBuffersStorage.data[n],0)))};k.prototype.thinInstancePartialBufferUpdate=function(n,e,t){var i;n==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(n===b.ColorKind&&(n=b.ColorInstanceKind),(i=this._userThinInstanceBuffersStorage)!=null&&i.vertexBuffers[n]&&this._userThinInstanceBuffersStorage.vertexBuffers[n].updateDirectly(e,t))};k.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const n=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=O.FromArray(n,e*16)}return this._thinInstanceDataStorage.worldMatrices};k.prototype.thinInstanceRefreshBoundingInfo=function(n=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(n||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);const a=this.getBoundingInfo();this.rawBoundingInfo=new Jr(a.minimum,a.maximum)}const r=this.getBoundingInfo(),s=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let a=0;a<r.boundingBox.vectors.length;++a)i.push(r.boundingBox.vectors[a].clone());B.Vector3[0].setAll(Number.POSITIVE_INFINITY),B.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let a=0;a<this._thinInstanceDataStorage.instancesCount;++a){O.FromArrayToRef(s,a*16,B.Matrix[0]);for(let o=0;o<i.length;++o)m.TransformCoordinatesToRef(i[o],B.Matrix[0],B.Vector3[2]),B.Vector3[0].minimizeInPlace(B.Vector3[2]),B.Vector3[1].maximizeInPlace(B.Vector3[2])}r.reConstruct(B.Vector3[0],B.Vector3[1]),this._updateBoundingInfo()};k.prototype._thinInstanceRecreateBuffer=function(n,e=!0){var t,i,r;n==="matrix"?((t=this._thinInstanceDataStorage.matrixBuffer)==null||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):n==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)==null||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(n===b.ColorKind&&(n=b.ColorInstanceKind),(r=this._userThinInstanceBuffersStorage.vertexBuffers[n])==null||r.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[n]=new b(this.getEngine(),this._userThinInstanceBuffersStorage.data[n],n,!e,!1,this._userThinInstanceBuffersStorage.strides[n],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n]))};k.prototype._thinInstanceUpdateBufferSize=function(n,e=1){var l,c,u;n===b.ColorKind&&(n=b.ColorInstanceKind);const t=n==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[n]))return;const i=t?16:this._userThinInstanceBuffersStorage.strides[n],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[n];let s=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[n];const a=(this._thinInstanceDataStorage.instancesCount+e)*i;let o=r;for(;o<a;)o*=2;if(!s||r!=o){if(!s)s=new Float32Array(o);else{const h=new Float32Array(o);h.set(s,0),s=h}t?((l=this._thinInstanceDataStorage.matrixBuffer)==null||l.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",s,!1),this._thinInstanceDataStorage.matrixData=s,this._thinInstanceDataStorage.matrixBufferSize=o,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((c=this._thinInstanceDataStorage.previousMatrixBuffer)==null||c.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",s,!1))):((u=this._userThinInstanceBuffersStorage.vertexBuffers[n])==null||u.dispose(),this._userThinInstanceBuffersStorage.data[n]=s,this._userThinInstanceBuffersStorage.sizes[n]=o,this._userThinInstanceBuffersStorage.vertexBuffers[n]=new b(this.getEngine(),s,n,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n]))}};k.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};k.prototype._disposeThinInstanceSpecificData=function(){var n;(n=this._thinInstanceDataStorage)!=null&&n.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};var R;(function(n){n[n.Int=1]="Int",n[n.Float=2]="Float",n[n.Vector2=4]="Vector2",n[n.Vector3=8]="Vector3",n[n.Vector4=16]="Vector4",n[n.Matrix=32]="Matrix",n[n.Geometry=64]="Geometry",n[n.Texture=128]="Texture",n[n.AutoDetect=1024]="AutoDetect",n[n.BasedOnInput=2048]="BasedOnInput",n[n.Undefined=4096]="Undefined",n[n.All=4095]="All"})(R||(R={}));var kE;(function(n){n[n.Compatible=0]="Compatible",n[n.TypeIncompatible=1]="TypeIncompatible",n[n.HierarchyIssue=2]="HierarchyIssue"})(kE||(kE={}));var GE;(function(n){n[n.Input=0]="Input",n[n.Output=1]="Output"})(GE||(GE={}));class zE{get direction(){return this._direction}get type(){if(this._type===R.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===R.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){var t;return this.isConnected?(t=this._connectedPoint)!=null&&t._storedFunction?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=R.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new Q,this.onDisconnectionObservable=new Q,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==R.AutoDetect)return e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,s=t;return this.direction===0&&(r=t,s=i),r.isAnAncestorOf(s)?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<R.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,this.value!==void 0&&this.value!==null&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class nt{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){const r=i.ownerBlock.getDescendantOfPredicate(e);if(r)return r}return null}get _isReadyState(){return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new Q,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=vc.UniqueId}registerInput(e,t,i=!1,r,s,a){const o=new zE(e,this,0);return o.type=t,o.isOptional=i,o.defaultValue=r,o.value=r,o.valueMin=s,o.valueMax=a,this._inputs.push(o),this}registerOutput(e,t,i){return i=i??new zE(e,this,1),i.type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some(i=>i.hasEndpoints)&&!this.isDebug)return!1;this.outputs.forEach(i=>i._resetCounters())}this._buildId=e.buildId;for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.notConnectedNonOptionalInputs.push(i);continue}const r=i.connectedPoint.ownerBlock;r&&r!==this&&r.build(e)}this._customBuildStep(e),e.verbose&&w.Log(`Building ${this.name} [${this.getClassName()}]`);const t=Tr.Now;return this._buildBlock(e),this._buildExecutionTime=Tr.Now-t,this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach(r=>{const s=this.inputs.find(a=>a.name===r.name);if(s&&(r.displayName&&(s.displayName=r.displayName),r.isExposedOnFrame&&(s.isExposedOnFrame=r.isExposedOnFrame,s.exposedPortPosition=r.exposedPortPosition),r.value!==void 0&&r.value!==null))if(r.valueType==="number")s.value=r.value;else{const a=Ai(r.valueType);a&&(s.value=a.FromArray(r.value))}}),i&&i.forEach((r,s)=>{r.displayName&&(this.outputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[s].isExposedOnFrame=r.isExposedOnFrame,this.outputs[s].exposedPortPosition=r.exposedPortPosition)})}_dumpPropertiesCode(){return`${this._codeVariableName}.visibleOnFrame = ${this.visibleOnFrame};
`}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let a=0;do a++,this._codeVariableName=i+a;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`);const s=this.getClassName();if(s==="GeometryInputBlock"){const o=this.type;r+=`var ${this._codeVariableName} = new BABYLON.GeometryInputBlock("${this.name}", ${o});
`}else r+=`var ${this._codeVariableName} = new BABYLON.${s}("${this.name}");
`;r+=this._dumpPropertiesCode();for(const a of this.inputs){if(!a.isConnected)continue;const l=a.connectedPoint.ownerBlock;t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}for(const a of this.outputs)if(a.hasEndpoints)for(const o of a.endpoints){const l=o.ownerBlock;l&&t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}return r}clone(){const e=this.serialize(),t=Ai(e.customType);if(t){const i=new t;return i._deserialize(e),i}return null}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose();this.onBuildObservable.clear()}}I([M("comment")],nt.prototype,"comments",void 0);class dA extends nt{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",R.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}}$("BABYLON.GeometryOutputBlock",dA);var Dt;(function(n){n[n.None=0]="None",n[n.Positions=1]="Positions",n[n.Normals=2]="Normals",n[n.Tangents=3]="Tangents",n[n.UV=4]="UV",n[n.UV2=5]="UV2",n[n.UV3=6]="UV3",n[n.UV4=7]="UV4",n[n.UV5=8]="UV5",n[n.UV6=9]="UV6",n[n.Colors=10]="Colors",n[n.VertexID=11]="VertexID",n[n.FaceID=12]="FaceID",n[n.GeometryID=13]="GeometryID",n[n.CollectionID=14]="CollectionID",n[n.LoopID=15]="LoopID",n[n.InstanceID=16]="InstanceID",n[n.LatticeID=17]="LatticeID",n[n.LatticeControl=18]="LatticeControl"})(Dt||(Dt={}));class SB{constructor(){this._rotationMatrix=new O,this._scalingMatrix=new O,this._positionMatrix=new O,this._scalingRotationMatrix=new O,this._transformMatrix=new O,this._tempVector3=new m,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;const i=this.executionContext.getExecutionIndex();switch(e){case Dt.Positions:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():!this.geometryContext||!this.geometryContext.positions?m.Zero():m.FromArray(this.geometryContext.positions,i*3);case Dt.Normals:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():!this.geometryContext||!this.geometryContext.normals?m.Zero():m.FromArray(this.geometryContext.normals,i*3);case Dt.Colors:return!this.geometryContext||!this.geometryContext.colors?We.Zero():We.FromArray(this.geometryContext.colors,i*4);case Dt.Tangents:return!this.geometryContext||!this.geometryContext.tangents?We.Zero():We.FromArray(this.geometryContext.tangents,i*4);case Dt.UV:return this.executionContext.getOverrideUVs1ContextualValue?this.executionContext.getOverrideUVs1ContextualValue():!this.geometryContext||!this.geometryContext.uvs?se.Zero():se.FromArray(this.geometryContext.uvs,i*2);case Dt.UV2:return!this.geometryContext||!this.geometryContext.uvs2?se.Zero():se.FromArray(this.geometryContext.uvs2,i*2);case Dt.UV3:return!this.geometryContext||!this.geometryContext.uvs3?se.Zero():se.FromArray(this.geometryContext.uvs3,i*2);case Dt.UV4:return!this.geometryContext||!this.geometryContext.uvs4?se.Zero():se.FromArray(this.geometryContext.uvs4,i*2);case Dt.UV5:return!this.geometryContext||!this.geometryContext.uvs5?se.Zero():se.FromArray(this.geometryContext.uvs5,i*2);case Dt.UV6:return!this.geometryContext||!this.geometryContext.uvs6?se.Zero():se.FromArray(this.geometryContext.uvs6,i*2);case Dt.VertexID:return i;case Dt.FaceID:return this.executionContext.getExecutionFaceIndex();case Dt.LoopID:return this.executionContext.getExecutionLoopIndex();case Dt.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case Dt.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case Dt.CollectionID:return!this.geometryContext||!this.geometryContext.metadata?0:this.geometryContext.metadata.collectionId||0;case Dt.LatticeID:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():m.Zero();case Dt.LatticeControl:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():m.Zero()}return null}adapt(e,t){const i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case R.Vector2:return new se(i,i);case R.Vector3:return new m(i,i,i);case R.Vector4:return new We(i,i,i,i)}return null}adaptInput(e,t,i){var s;if(!e.isConnected)return e.value||i;const r=e.getConnectedValue(this);if(((s=e._connectedPoint)==null?void 0:s.type)===t)return r;switch(t){case R.Vector2:return new se(r,r);case R.Vector3:return new m(r,r,r);case R.Vector4:return new We(r,r,r,r)}return null}emitErrors(){let e="";for(const t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(const t of this.noContextualData)e+=`Contextual input ${Dt[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).
`;if(e)throw`Build of NodeGeometry failed:
`+e}_instantiate(e,t,i,r,s){O.ScalingToRef(r.x,r.y,r.z,this._scalingMatrix),O.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),O.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let a=0;a<e.positions.length;a+=3)this._tempVector3.fromArray(e.positions,a),m.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,a),e.normals&&(this._tempVector3.fromArray(e.normals,a),m.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,a));s.push(e)}_instantiateWithMatrix(e,t,i){for(let r=0;r<e.positions.length;r+=3)this._tempVector3.fromArray(e.positions,r),m.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,r),e.normals&&(this._tempVector3.fromArray(e.normals,r),m.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,r));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,r){O.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let s=0;s<e.positions.length;s+=3)this._tempVector3.fromArray(e.positions,s),m.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,s),e.normals&&(this._tempVector3.fromArray(e.normals,s),m.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,s));r.push(e)}}class zi extends nt{get type(){if(this._type===R.AutoDetect&&this.value!=null){if(!isNaN(this.value))return this._type=R.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=R.Vector2,this._type;case"Vector3":return this._type=R.Vector3,this._type;case"Vector4":return this._type=R.Vector4,this._type;case"Matrix":return this._type=R.Matrix,this._type}}return this._type}get isContextual(){return this._contextualSource!==Dt.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case Dt.Positions:case Dt.Normals:case Dt.LatticeID:case Dt.LatticeControl:this._type=R.Vector3;break;case Dt.Colors:case Dt.Tangents:this._type=R.Vector4;break;case Dt.UV:case Dt.UV2:case Dt.UV3:case Dt.UV4:case Dt.UV5:case Dt.UV6:this._type=R.Vector2;break;case Dt.VertexID:case Dt.GeometryID:case Dt.CollectionID:case Dt.FaceID:case Dt.LoopID:case Dt.InstanceID:this._type=R.Int;break}this.output&&(this.output.type=this._type)}constructor(e,t=R.AutoDetect){super(e),this._type=R.Undefined,this._contextualSource=Dt.None,this.min=0,this.max=0,this.groupInInspector="",this.onValueChangedObservable=new Q,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===R.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=Dt.None,this.type){case R.Int:case R.Float:this.value=0;break;case R.Vector2:this.value=se.Zero();break;case R.Vector3:this.value=m.Zero();break;case R.Vector4:this.value=We.Zero();break;case R.Matrix:this.value=O.Identity();break}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=t=>t.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${Dt[this._contextualSource]};
`;const t=[];let i="";switch(this.type){case R.Float:case R.Int:i=`${this.value}`;break;case R.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case R.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case R.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break}return t.push(`${e}.value = ${i}`),(this.type===R.Float||this.type===R.Int)&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}serialize(){const e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,this._storedValue!==null&&!this.isContextual&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const t=Ai(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}$("BABYLON.GeometryInputBlock",zi);var WE;(function(n){n[n.Boolean=0]="Boolean",n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=3]="Vector2",n[n.List=4]="List",n[n.Color4=5]="Color4",n[n.SamplingMode=6]="SamplingMode",n[n.TextureFormat=7]="TextureFormat",n[n.TextureType=8]="TextureType"})(WE||(WE={}));function Ne(n,e=0,t="PROPERTIES",i){return(r,s)=>{let a=r._propStore;a||(a=[],r._propStore=a),a.push({propertyName:s,displayName:n,type:e,groupName:t,options:i??{},className:r.constructor.name})}}class l_ extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",R.Float,!0,1),this.registerInput("width",R.Float,!0,0),this.registerInput("height",R.Float,!0,0),this.registerInput("depth",R.Float,!0,0),this.registerInput("subdivisions",R.Int,!0,1),this.registerInput("subdivisionsX",R.Int,!0,0),this.registerInput("subdivisionsY",R.Int,!0,0),this.registerInput("subdivisionsZ",R.Int,!0,0),this.registerOutput("geometry",R.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){const e=new zi("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){const e=new zi("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new zi("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){const e=new zi("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){const t={},i=r=>{t.size=this.size.getConnectedValue(r),t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),t.depth=this.depth.getConnectedValue(r);const s=this.subdivisions.getConnectedValue(r),a=this.subdivisionsX.getConnectedValue(r),o=this.subdivisionsY.getConnectedValue(r),l=this.subdivisionsZ.getConnectedValue(r);return s&&(t.segments=s),a&&(t.widthSegments=a),o&&(t.heightSegments=o),l&&(t.depthSegments=l),yw(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],l_.prototype,"evaluateContext",void 0);$("BABYLON.BoxBlock",l_);class ls{_getGlobalNodeGeometryEditor(){if(typeof NODEGEOMETRYEDITOR<"u")return NODEGEOMETRYEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeGeometryEditor<"u")return BABYLON}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=ls._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new Q,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}get vertexData(){return this._vertexData}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return J.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise(t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),typeof this.BJSNODEGEOMETRYEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:ls.EditorURL;J.LoadBabylonScript(i,()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(e==null?void 0:e.nodeGeometryEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeGeometryEditorConfig),t()})}_createNodeEditor(e){const t={nodeGeometry:this,...e};this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";const r=Tr.Now;this._initializeBlock(this.outputBlock,i);const s=[];for(const o of this.attachedBlocks)o._isReadyState&&s.push(o._isReadyState);if(s.length){Promise.all(s).then(()=>{this.build(e,t,i)});return}const a=new SB;a.buildId=this._buildId,a.verbose=e;try{this.outputBlock.build(a)}finally{t&&(this._buildId=ls._BuildIdGenerator++)}this._buildExecutionTime=Tr.Now-r,a.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=a.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;const i=new k(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),this._vertexData?(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e):!1}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1&&this.attachedBlocks.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._initializeBlock(s,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();const i={};for(const r of e.blocks){const s=Ai(r.customType);if(s){const a=new s;a._deserialize(r),i[r.id]=a,this.attachedBlocks.push(a)}}for(const r of this.attachedBlocks)if(r.isTeleportOut){const s=r,a=s._tempEntryPointUniqueId;if(a){const o=i[a];o&&o.attachToEndpoint(s)}}for(let r=0;r<e.blocks.length;r++){const s=e.blocks[r],a=i[s.id];a&&(a.inputs.length&&s.inputs.some(o=>o.targetConnectionName)&&!t||this._restoreConnections(a,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){const r=e.locations||e.editorData.locations;for(const a of r)i[a.blockId]&&(a.blockId=i[a.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);const s=[];for(const a in i)s[a]=i[a].uniqueId;this.editorData.map=s}this.comment=e.comment}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const a=i[s.id];if(a){for(const o of s.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let r=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");
`;for(const s of t)s.isInput&&e.indexOf(s)===-1&&(r+=s._dumpCode(i,e));return this.outputBlock&&(e=[],r+=`// Connections
`,r+=this.outputBlock._dumpCodeForOutputConnections(e),r+=`// Output nodes
`,r+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};
`,r+=`nodeGeometry.build();
`),r}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;const e=new l_("Box");e.autoConfigure();const t=new dA("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){const t=this.serialize(),i=Ke.Clone(()=>new ls(e),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){const t=e?{}:Ke.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}dispose(){for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){const t=new ls(e);return t.setToDefault(),t.build(),t}static Parse(e){const t=Ke.Parse(()=>new ls(e.name),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return e==="_BLANK"?Promise.resolve(ls.CreateDefault("blank")):new Promise((r,s)=>{const a=new Gi;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.nodeGeometry);t||(t=Ke.Parse(()=>new ls(e),l,null)),t.parseSerializedObject(l),t.snippetId=e;try{i||t.build(),r(t)}catch(c){s(c)}}else s("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}}ls._BuildIdGenerator=0;ls.EditorURL=`${J._DefaultCdnUrl}/v${q.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`;ls.SnippetUrl="https://snippet.babylonjs.com";I([M()],ls.prototype,"name",void 0);I([M("comment")],ls.prototype,"comment",void 0);class yh extends nt{getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}constructor(e){super(e),this.evaluateContext=!0,this.epsilon=pt,this.optimizeFaces=!1,this.registerInput("geometry",R.Geometry),this.registerInput("selector",R.Int,!0),this.registerOutput("output",R.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get selector(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(!this.geometry.isConnected)return null;const r=this.geometry.getConnectedValue(i),s=[],a={};i.pushExecutionContext(this),i.pushGeometryContext(r);for(let u=0;u<r.positions.length;u+=3){if(this._currentIndex=u/3,this.selector.isConnected&&!this.selector.getConnectedValue(i))continue;const h=r.positions[u],f=r.positions[u+1],d=r.positions[u+2];let p=!1;for(let _=0;_<s.length;_+=3)if(Qt(h,s[_],this.epsilon)&&Qt(f,s[_+1],this.epsilon)&&Qt(d,s[_+2],this.epsilon)){a[u/3]=_/3,p=!0;continue}p||(a[u/3]=s.length/3,s.push(h,f,d))}const o=new de;o.positions=s;const l=r.indices.map(u=>a[u]),c=[];if(this.optimizeFaces){for(let u=0;u<l.length;u+=3){const h=l[u],f=l[u+1],d=l[u+2];if(h===f||f==d||d===h)continue;let p=!1;for(let _=0;_<c.length;_+=3){if(h===c[_]&&f===c[_+1]&&d===c[_+2]){p=!0;continue}if(h===c[_+1]&&f===c[_+2]&&d===c[_]){p=!0;continue}if(h===c[_+2]&&f===c[_]&&d===c[_+1]){p=!0;continue}}p||c.push(h,f,d)}o.indices=c}else o.indices=l;return o};e.restoreGeometryContext(),e.restoreExecutionContext(),this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};
`,e+=`${this._codeVariableName}.optimizeFaces = ${this.optimizeFaces?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e.optimizeFaces=this.optimizeFaces,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon,this.optimizeFaces=e.optimizeFaces}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],yh.prototype,"evaluateContext",void 0);I([Ne("Epsilon",1,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],yh.prototype,"epsilon",void 0);I([Ne("Optimize faces",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],yh.prototype,"optimizeFaces",void 0);$("BABYLON.GeometryOptimizeBlock",yh);class pA extends nt{constructor(e){super(e),this._rotationMatrix=new O,this.evaluateContext=!1,this.registerInput("size",R.Float,!0,1),this.registerInput("width",R.Float,!0,0),this.registerInput("height",R.Float,!0,0),this.registerInput("subdivisions",R.Int,!0,1),this.registerInput("subdivisionsX",R.Int,!0,0),this.registerInput("subdivisionsY",R.Int,!0,0),this.registerOutput("geometry",R.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get subdivisionsX(){return this._inputs[4]}get subdivisionsY(){return this._inputs[5]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){const e=new zi("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){const e=new zi("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new zi("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){const t={},i=r=>{t.size=this.size.getConnectedValue(r),t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r);const s=this.subdivisions.getConnectedValue(r),a=this.subdivisionsX.getConnectedValue(r),o=this.subdivisionsY.getConnectedValue(r);s&&(t.subdivisions=s),a&&(t.subdivisionsX=a),o&&(t.subdivisionsY=o);const l=sn(t);return O.RotationYawPitchRollToRef(-Math.PI/2,0,Math.PI/2,this._rotationMatrix),l.transform(this._rotationMatrix),l};if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],pA.prototype,"evaluateContext",void 0);$("BABYLON.PlaneBlock",pA);class _A extends nt{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",R.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh){this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null;return}const e=de.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){const i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){const e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=de.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=de.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}}I([Ne("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],_A.prototype,"serializedCachedData",void 0);$("BABYLON.MeshBlock",_A);class mA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",R.Float,!0,1),this.registerInput("radiusX",R.Float,!0,0),this.registerInput("radiusY",R.Float,!0,0),this.registerInput("radiusZ",R.Float,!0,0),this.registerInput("subdivisions",R.Int,!0,4),this.registerOutput("geometry",R.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new zi("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=r=>(t.radius=this.radius.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.radiusX=this.radiusX.getConnectedValue(r),t.radiusY=this.radiusY.getConnectedValue(r),t.radiusZ=this.radiusZ.getConnectedValue(r),s_(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],mA.prototype,"evaluateContext",void 0);$("BABYLON.IcoSphereBlock",mA);class gA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",R.Int,!0,32),this.registerInput("diameter",R.Float,!0,1),this.registerInput("diameterX",R.Float,!0,0),this.registerInput("diameterY",R.Float,!0,0),this.registerInput("diameterZ",R.Float,!0,0),this.registerInput("arc",R.Float,!0,1),this.registerInput("slice",R.Float,!0,1),this.registerOutput("geometry",R.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new zi("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=r=>(t.segments=this.segments.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.diameterX=this.diameterX.getConnectedValue(r),t.diameterY=this.diameterY.getConnectedValue(r),t.diameterZ=this.diameterZ.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),t.slice=this.slice.getConnectedValue(r),Xp(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],gA.prototype,"evaluateContext",void 0);$("BABYLON.SphereBlock",gA);class EA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",R.Float,!0,1),this.registerInput("height",R.Float,!0,1),this.registerInput("subdivisions",R.Int,!0,1),this.registerInput("subdivisionsX",R.Int,!0,0),this.registerInput("subdivisionsY",R.Int,!0,0),this.registerOutput("geometry",R.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){const e=new zi("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){const e=new zi("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=r=>(t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.subdivisionsX=this.subdivisionsX.getConnectedValue(r),t.subdivisionsY=this.subdivisionsY.getConnectedValue(r),sn(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],EA.prototype,"evaluateContext",void 0);$("BABYLON.GridBlock",EA);class vA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",R.Float,!0,1),this.registerInput("thickness",R.Float,!0,.5),this.registerInput("tessellation",R.Int,!0,16),this.registerOutput("geometry",R.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new zi("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){const t={},i=r=>(t.thickness=this.thickness.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),e_(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],vA.prototype,"evaluateContext",void 0);$("BABYLON.TorusBlock",vA);class SA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",R.Float,!0,25),this.registerInput("diameter",R.Float,!0,1),this.registerInput("diameterTop",R.Float,!0,-1),this.registerInput("diameterBottom",R.Float,!0,-1),this.registerInput("subdivisions",R.Int,!0,1),this.registerInput("tessellation",R.Int,!0,24),this.registerInput("arc",R.Float,!0,1),this.registerOutput("geometry",R.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){const e=new zi("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){const e=new zi("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){const t={},i=r=>(t.height=this.height.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.diameterTop=this.diameterTop.getConnectedValue(r),t.diameterBottom=this.diameterBottom.getConnectedValue(r),t.diameterTop===-1&&(t.diameterTop=t.diameter),t.diameterBottom===-1&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),$p(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],SA.prototype,"evaluateContext",void 0);$("BABYLON.CylinderBlock",SA);class TA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",R.Float,!0,1),this.registerInput("radius",R.Float,!0,.25),this.registerInput("tessellation",R.Int,!0,16),this.registerInput("subdivisions",R.Int,!0,2),this.registerOutput("geometry",R.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){const e=new zi("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){const e=new zi("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=r=>(t.height=this.height.getConnectedValue(r),t.radius=this.radius.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),n_(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],TA.prototype,"evaluateContext",void 0);$("BABYLON.CapsuleBlock",TA);class xA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",R.Float,!0,.5),this.registerInput("tessellation",R.Int,!0,64),this.registerInput("arc",R.Float,!0,1),this.registerOutput("geometry",R.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){const e=new zi("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){const t={},i=r=>(t.radius=this.radius.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),Zp(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{const r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],xA.prototype,"evaluateContext",void 0);$("BABYLON.DiscBlock",xA);class TB extends nt{constructor(e){super(e),this.registerOutput("geometry",R.Geometry),this.registerOutput("vector",R.Vector3)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}get vector(){return this._outputs[1]}_buildBlock(){this.geometry._storedValue=null,this.vector._storedValue=null}}$("BABYLON.NullBlock",TB);class CA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("positions",R.Vector3),this.registerOutput("output",R.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_remapVector3Data(e,t){const i=[];for(let r=0;r<e.length;r+=3)t[r/3]!==void 0&&i.push(e[r],e[r+1],e[r+2]);return i}_remapVector4Data(e,t){const i=[];for(let r=0;r<e.length;r+=4)t[r/4]!==void 0&&i.push(e[r],e[r+1],e[r+2],e[r+3]);return i}_remapVector2Data(e,t){const i=[];for(let r=0;r<e.length;r+=2)t[r/2]!==void 0&&i.push(e[r],e[r+1]);return i}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}const r={},s=this._vertexData.positions.length/3,a=[];let o=0,l=!1;for(this._currentIndex=0;this._currentIndex<s;this._currentIndex++){const c=this.positions.getConnectedValue(i);c?(c.toArray(a,o*3),r[this._currentIndex]=o,o++):l=!0}if(l){if(this._vertexData.indices){const c=[];for(let u=0;u<this._vertexData.indices.length;u+=3){const h=this._vertexData.indices[u],f=this._vertexData.indices[u+1],d=this._vertexData.indices[u+2],p=r[h],_=r[f],g=r[d];p!==void 0&&_!==void 0&&g!==void 0&&(c.push(p),c.push(_),c.push(g))}this._vertexData.indices=c}this._vertexData.normals&&(this._vertexData.normals=this._remapVector3Data(this._vertexData.normals,r)),this._vertexData.tangents&&(this._vertexData.tangents=this._remapVector4Data(this._vertexData.tangents,r)),this._vertexData.colors&&(this._vertexData.colors=this._remapVector4Data(this._vertexData.colors,r)),this._vertexData.uvs&&(this._vertexData.uvs=this._remapVector2Data(this._vertexData.uvs,r)),this._vertexData.uvs2&&(this._vertexData.uvs2=this._remapVector2Data(this._vertexData.uvs2,r)),this._vertexData.uvs3&&(this._vertexData.uvs3=this._remapVector2Data(this._vertexData.uvs3,r)),this._vertexData.uvs4&&(this._vertexData.uvs4=this._remapVector2Data(this._vertexData.uvs4,r)),this._vertexData.uvs5&&(this._vertexData.uvs5=this._remapVector2Data(this._vertexData.uvs5,r)),this._vertexData.uvs6&&(this._vertexData.uvs6=this._remapVector2Data(this._vertexData.uvs6,r))}return this._vertexData.positions=a,i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],CA.prototype,"evaluateContext",void 0);$("BABYLON.SetPositionsBlock",CA);class AA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("normals",R.Vector3),this.registerOutput("output",R.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.normals.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.normals||(this._vertexData.normals=[]);const r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const s=this.normals.getConnectedValue(i);s&&s.toArray(this._vertexData.normals,this._currentIndex*3)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],AA.prototype,"evaluateContext",void 0);$("BABYLON.SetNormalsBlock",AA);class c_ extends nt{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",R.Geometry),this.registerInput("uvs",R.Vector2),this.registerOutput("output",R.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.uvs.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}const r=[],s=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<s;this._currentIndex++){const a=this.uvs.getConnectedValue(i);a&&a.toArray(r,this._currentIndex*2)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=r;break;case 1:this._vertexData.uvs2=r;break;case 2:this._vertexData.uvs3=r;break;case 3:this._vertexData.uvs4=r;break;case 4:this._vertexData.uvs5=r;break;case 5:this._vertexData.uvs6=r;break}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};
`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],c_.prototype,"evaluateContext",void 0);I([Ne("Texture coordinates index",4,"ADVANCED",{notifiers:{update:!0},embedded:!0,options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],c_.prototype,"textureCoordinateIndex",void 0);$("BABYLON.SetUVsBlock",c_);class IA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("colors",R.AutoDetect),this.registerOutput("output",R.Geometry),this._inputs[1].excludedConnectionPointTypes.push(R.Int),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Vector2),this._inputs[1].excludedConnectionPointTypes.push(R.Texture),this._inputs[1].excludedConnectionPointTypes.push(R.Texture)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{var s;if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.colors.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.colors||(this._vertexData.colors=[]);const r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++)if(((s=this.colors.connectedPoint)==null?void 0:s.type)===R.Vector3){const a=this.colors.getConnectedValue(i);a&&(a.toArray(this._vertexData.colors,this._currentIndex*4),this._vertexData.colors[this._currentIndex*4+3]=1,this._vertexData.hasVertexAlpha=!1)}else{const a=this.colors.getConnectedValue(i);a&&(a.toArray(this._vertexData.colors,this._currentIndex*4),this._vertexData.hasVertexAlpha=!0)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],IA.prototype,"evaluateContext",void 0);$("BABYLON.SetColorsBlock",IA);class yA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("tangents",R.Vector4),this.registerOutput("output",R.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.tangents.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.tangents||(this._vertexData.tangents=[]);const r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const s=this.tangents.getConnectedValue(i);s&&s.toArray(this._vertexData.tangents,this._currentIndex*4)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],yA.prototype,"evaluateContext",void 0);$("BABYLON.SetTangentsBlock",yA);var wr;(function(n){n[n.Add=0]="Add",n[n.Subtract=1]="Subtract",n[n.Multiply=2]="Multiply",n[n.Divide=3]="Divide",n[n.Max=4]="Max",n[n.Min=5]="Min"})(wr||(wr={}));class bA extends nt{constructor(e){super(e),this.operation=wr.Add,this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this.output._typeConnectionSource=this.left;const t=[R.Matrix,R.Geometry,R.Texture];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.left.onDisconnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onDisconnectionObservable.add(()=>this._updateInputOutputTypes())]}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;const t=this.left,i=this.right;if(!t.isConnected||!i.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const r=t.type===R.Float||t.type===R.Int,s=i.type===R.Float||i.type===R.Int,a=r&&s;switch(this.operation){case wr.Add:{a?e=o=>t.getConnectedValue(o)+i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).add(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).add(o.adapt(i,t.type));break}case wr.Subtract:{a?e=o=>t.getConnectedValue(o)-i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).subtract(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).subtract(o.adapt(i,t.type));break}case wr.Multiply:{a?e=o=>t.getConnectedValue(o)*i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).multiply(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).multiply(o.adapt(i,t.type));break}case wr.Divide:{a?e=o=>t.getConnectedValue(o)/i.getConnectedValue(o):r?e=o=>o.adapt(t,i.type).divide(i.getConnectedValue(o)):e=o=>t.getConnectedValue(o).divide(o.adapt(i,t.type));break}case wr.Min:{if(a)e=o=>Math.min(t.getConnectedValue(o),i.getConnectedValue(o));else{const[o,l]=r?[i,t]:[t,i];switch(o.type){case R.Vector2:{e=c=>se.Minimize(o.getConnectedValue(c),c.adapt(l,o.type));break}case R.Vector3:{e=c=>m.Minimize(o.getConnectedValue(c),c.adapt(l,o.type));break}case R.Vector4:{e=c=>We.Minimize(o.getConnectedValue(c),c.adapt(l,o.type));break}}}break}case wr.Max:if(a)e=o=>Math.max(t.getConnectedValue(o),i.getConnectedValue(o));else{const[o,l]=r?[i,t]:[t,i];switch(o.type){case R.Vector2:{e=c=>se.Maximize(o.getConnectedValue(c),c.adapt(l,o.type));break}case R.Vector3:{e=c=>m.Maximize(o.getConnectedValue(c),c.adapt(l,o.type));break}case R.Vector4:{e=c=>We.Maximize(o.getConnectedValue(c),c.adapt(l,o.type));break}}break}}this.output._storedFunction=o=>t.type===R.Int?e(o)|0:e(o)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${wr[this.operation]};
`}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===R.Int||this.left.type===R.Float&&this.right.type!==R.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[R.Int,R.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===R.Int||t.type===R.Float)&&e.acceptedConnectionPointTypes.push(R.Vector2,R.Vector3,R.Vector4))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}I([Ne("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Add",value:wr.Add},{label:"Subtract",value:wr.Subtract},{label:"Multiply",value:wr.Multiply},{label:"Divide",value:wr.Divide},{label:"Max",value:wr.Max},{label:"Min",value:wr.Min}]})],bA.prototype,"operation",void 0);$("BABYLON.MathBlock",bA);class xB extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerInput("fromMin",R.Float,!0,0),this.registerInput("fromMax",R.Float,!0,1),this.registerInput("toMin",R.Float,!0,0),this.registerInput("toMax",R.Float,!0,1),this.registerOutput("output",R.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(R.Vector2),this._inputs[0].excludedConnectionPointTypes.push(R.Vector3),this._inputs[0].excludedConnectionPointTypes.push(R.Vector4),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),r=this.fromMax.getConnectedValue(e),s=this.toMin.getConnectedValue(e),a=this.toMax.getConnectedValue(e),o=(t-i)/(r-i)*(a-s)+s;return this.output.type===R.Int?Math.floor(o):o}}}$("BABYLON.MapRangeBlock",xB);var Ji;(function(n){n[n.Equal=0]="Equal",n[n.NotEqual=1]="NotEqual",n[n.LessThan=2]="LessThan",n[n.GreaterThan=3]="GreaterThan",n[n.LessOrEqual=4]="LessOrEqual",n[n.GreaterOrEqual=5]="GreaterOrEqual",n[n.Xor=6]="Xor",n[n.Or=7]="Or",n[n.And=8]="And"})(Ji||(Ji={}));class RA extends nt{constructor(e){super(e),this.test=Ji.Equal,this.registerInput("left",R.Float),this.registerInput("right",R.Float,!0,0),this.registerInput("ifTrue",R.AutoDetect,!0,1),this.registerInput("ifFalse",R.AutoDetect,!0,0),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=R.Float,this._inputs[0].acceptedConnectionPointTypes.push(R.Int),this._inputs[1].acceptedConnectionPointTypes.push(R.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);let s=!1;switch(this.test){case Ji.Equal:s=Qt(i,r,pt);break;case Ji.NotEqual:s=i!==r;break;case Ji.LessThan:s=i<r;break;case Ji.GreaterThan:s=i>r;break;case Ji.LessOrEqual:s=i<=r;break;case Ji.GreaterOrEqual:s=i>=r;break;case Ji.Xor:s=!!i&&!r||!i&&!!r;break;case Ji.Or:s=!!i||!!r;break;case Ji.And:s=!!i&&!!r;break}return s};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${Ji[this.test]};
`}serialize(){const e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}}I([Ne("Test",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:Ji.Equal},{label:"NotEqual",value:Ji.NotEqual},{label:"LessThan",value:Ji.LessThan},{label:"GreaterThan",value:Ji.GreaterThan},{label:"LessOrEqual",value:Ji.LessOrEqual},{label:"GreaterOrEqual",value:Ji.GreaterOrEqual},{label:"Xor",value:Ji.Xor},{label:"Or",value:Ji.Or},{label:"And",value:Ji.And}]})],RA.prototype,"test",void 0);$("BABYLON.ConditionBlock",RA);var Cs;(function(n){n[n.None=0]="None",n[n.LoopID=1]="LoopID",n[n.InstanceID=2]="InstanceID",n[n.Once=3]="Once"})(Cs||(Cs={}));class PA extends nt{constructor(e){super(e),this._currentLockId=-1,this.lockMode=Cs.None,this.registerInput("min",R.AutoDetect),this.registerInput("max",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Geometry),this._inputs[1].excludedConnectionPointTypes.push(R.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){const e=new zi("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){const e=new zi("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case R.Int:case R.Float:{e=t=>{const i=this.min.getConnectedValue(t)||0,r=this.max.getConnectedValue(t)||0;return i+Math.random()*(r-i)};break}case R.Vector2:{e=t=>{const i=this.min.getConnectedValue(t)||se.Zero(),r=this.max.getConnectedValue(t)||se.Zero();return new se(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y))};break}case R.Vector3:{e=t=>{const i=this.min.getConnectedValue(t)||m.Zero(),r=this.max.getConnectedValue(t)||m.Zero();return new m(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z))};break}case R.Vector4:{e=t=>{const i=this.min.getConnectedValue(t)||We.Zero(),r=this.max.getConnectedValue(t)||We.Zero();return new We(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z),i.w+Math.random()*(r.w-i.w))};break}}this.lockMode===Cs.None||!e?this.output._storedFunction=e:this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case Cs.InstanceID:i=t.getContextualValue(Dt.InstanceID,!0)||0;break;case Cs.LoopID:i=t.getContextualValue(Dt.LoopID,!0)||0;break;case Cs.Once:i=t.buildId||0;break}return(this._currentLockId!==i||this.lockMode===Cs.None)&&(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${Cs[this.lockMode]};
`}serialize(){const e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}I([Ne("LockMode",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"None",value:Cs.None},{label:"LoopID",value:Cs.LoopID},{label:"InstanceID",value:Cs.InstanceID},{label:"Once",value:Cs.Once}]})],PA.prototype,"lockMode",void 0);$("BABYLON.RandomBlock",PA);class CB extends nt{constructor(e){super(e),this.registerInput("offset",R.Vector3,!0,m.Zero()),this.registerInput("scale",R.Float,!0,1),this.registerInput("octaves",R.Float,!0,2,0,16),this.registerInput("roughness",R.Float,!0,.5,0,1),this.registerOutput("output",R.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return t!==0?-e:e}_noiseGrad(e,t,i,r){const s=e&15,a=s<8?t:i,o=s===12||s==14?t:r,l=s<4?i:o;return this._negateIf(a,s&a)+this._negateIf(l,s&2)}_fade(e){return e*e*e*(e*(e*6-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let r,s,a;return r=s=a=3735928584,a+=i,s+=t,r+=e,a^=s,a-=this._hashBitRotate(s,14),r^=a,r-=this._hashBitRotate(a,11),s^=r,s-=this._hashBitRotate(r,25),a^=s,a-=this._hashBitRotate(s,16),r^=a,r-=this._hashBitRotate(a,4),s^=r,s-=this._hashBitRotate(r,14),a^=s,a-=this._hashBitRotate(s,24),a}_mix(e,t,i,r,s,a,o,l,c,u,h){const f=1-c,d=1-u;return(1-h)*(d*(e*f+t*c)+u*(i*f+r*c))+h*(d*(s*f+a*c)+u*(o*f+l*c))}_perlinNoise(e){const t=(e.x|0)-(e.x<0?1:0),i=(e.y|0)-(e.y<0?1:0),r=(e.z|0)-(e.z<0?1:0),s=e.x-t,a=e.y-i,o=e.z-r,l=this._fade(s),c=this._fade(a),u=this._fade(o);return this._mix(this._noiseGrad(this._hash(t,i,r),s,a,o),this._noiseGrad(this._hash(t+1,i,r),s-1,a,o),this._noiseGrad(this._hash(t,i+1,r),s,a-1,o),this._noiseGrad(this._hash(t+1,i+1,r),s-1,a-1,o),this._noiseGrad(this._hash(t,i,r+1),s,a,o-1),this._noiseGrad(this._hash(t+1,i,r+1),s-1,a,o-1),this._noiseGrad(this._hash(t,i+1,r+1),s,a-1,o-1),this._noiseGrad(this._hash(t+1,i+1,r+1),s-1,a-1,o-1),l,c,u)}_perlinSigned(e){return this._perlinNoise(e)*.982}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,r,s){const a=new m(i.x*s+r.x,i.y*s+r.y,i.z*s+r.z);let o=1,l=1,c=0,u=0;e=vt(e,0,15);const h=e|0;for(let _=0;_<=h;_++){const g=this._perlin(a.scale(o));u+=g*l,c+=l,l*=vt(t,0,1),o*=2}const f=e-Math.floor(e);if(f==0)return u/c;const d=this._perlin(a.scale(o));let p=u+d*l;return u/=c,p/=c+l,(1-f)*u+f*p}_buildBlock(){this.output._storedFunction=e=>{const t=e.getContextualValue(Dt.Positions),i=this.octaves.getConnectedValue(e),r=this.roughness.getConnectedValue(e),s=this.offset.getConnectedValue(e),a=this.scale.getConnectedValue(e);return this.noise(i,r,t,s,a)}}}$("BABYLON.NoiseBlock",CB);class MA extends nt{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",R.Geometry),this.registerInput("geometry1",R.Geometry,!0),this.registerInput("geometry2",R.Geometry,!0),this.registerInput("geometry3",R.Geometry,!0),this.registerInput("geometry4",R.Geometry,!0),this.registerOutput("output",R.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{const r=[];if(this.geometry0.isConnected){const o=this.geometry0.getConnectedValue(i);o&&r.push(o)}if(this.geometry1.isConnected){const o=this.geometry1.getConnectedValue(i);o&&r.push(o)}if(this.geometry2.isConnected){const o=this.geometry2.getConnectedValue(i);o&&r.push(o)}if(this.geometry3.isConnected){const o=this.geometry3.getConnectedValue(i);o&&r.push(o)}if(this.geometry4.isConnected){const o=this.geometry4.getConnectedValue(i);o&&r.push(o)}if(r.length===0)return null;let s=r[0].clone();const a=r.slice(1);return a.length&&s&&(s=s.merge(a,!0,!1,!0,!0)),s};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],MA.prototype,"evaluateContext",void 0);$("BABYLON.MergeGeometryBlock",MA);class DA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",R.Geometry,!0),this.registerInput("geometry1",R.Geometry,!0),this.registerInput("geometry2",R.Geometry,!0),this.registerInput("geometry3",R.Geometry,!0),this.registerInput("geometry4",R.Geometry,!0),this.registerInput("geometry5",R.Geometry,!0),this.registerInput("geometry6",R.Geometry,!0),this.registerInput("geometry7",R.Geometry,!0),this.registerInput("geometry8",R.Geometry,!0),this.registerInput("geometry9",R.Geometry,!0),this.registerOutput("output",R.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,r){if(e.isConnected){const s=e.getConnectedValue(t);if(!s)return;s.metadata=s.metadata||{},s.metadata.collectionId=i,r.push(s)}}_buildBlock(e){const t=i=>{const r=[];return this._storeGeometry(this.geometry0,i,0,r),this._storeGeometry(this.geometry1,i,1,r),this._storeGeometry(this.geometry2,i,2,r),this._storeGeometry(this.geometry3,i,3,r),this._storeGeometry(this.geometry4,i,4,r),this._storeGeometry(this.geometry5,i,5,r),this._storeGeometry(this.geometry6,i,6,r),this._storeGeometry(this.geometry7,i,7,r),this._storeGeometry(this.geometry8,i,8,r),this._storeGeometry(this.geometry9,i,9,r),r.length?r[Math.round(Math.random()*(r.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],DA.prototype,"evaluateContext",void 0);$("BABYLON.GeometryCollectionBlock",DA);class OA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerOutput("output",R.Geometry)}getClassName(){return"CleanGeometryBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(!this.geometry.isConnected)return null;const r=this.geometry.getConnectedValue(i).clone();if(!r.positions||!r.indices||!r.normals)return r;const s=r.indices,a=r.positions;return ZD(a,s),r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],OA.prototype,"evaluateContext",void 0);$("BABYLON.CleanGeometryBlock",OA);class AB extends nt{constructor(e){super(e),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=r=>i.getConnectedValue(r)}}$("BABYLON.GeometryElbowBlock",AB);class IB extends nt{constructor(e){super(e),this.registerInput("geometry",R.Geometry),this.registerOutput("output",R.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;const t=this.geometry.getConnectedValue(e);return t.normals||(t.normals=[]),de.ComputeNormals(t.positions,t.indices,t.normals),t}}}$("BABYLON.ComputeNormalsBlock",IB);class yB extends nt{constructor(e){super(e),this.registerInput("xyzw ",R.Vector4,!0),this.registerInput("xyz ",R.Vector3,!0),this.registerInput("xy ",R.Vector2,!0),this.registerInput("zw ",R.Vector2,!0),this.registerInput("x ",R.Float,!0),this.registerInput("y ",R.Float,!0),this.registerInput("z ",R.Float,!0),this.registerInput("w ",R.Float,!0),this.registerOutput("xyzw",R.Vector4),this.registerOutput("xyz",R.Vector3),this.registerOutput("xy",R.Vector2),this.registerOutput("zw",R.Vector2),this.registerOutput("x",R.Float),this.registerOutput("y",R.Float),this.registerOutput("z",R.Float),this.registerOutput("w",R.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e==="x "?"xIn":e==="y "?"yIn":e==="z "?"zIn":e==="w "?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xIn,i=this.yIn,r=this.zIn,s=this.wIn,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this.xyzwOut,h=this.xyzOut,f=this.xyOut,d=this.zwOut,p=this.xOut,_=this.yOut,g=this.zOut,E=this.wOut,v=x=>{if(c.isConnected)return c.getConnectedValue(x);let A=0,T=0,C=0,y=0;if(t.isConnected&&(A=t.getConnectedValue(x)),i.isConnected&&(T=i.getConnectedValue(x)),r.isConnected&&(C=r.getConnectedValue(x)),s.isConnected&&(y=s.getConnectedValue(x)),a.isConnected){const P=a.getConnectedValue(x);P&&(A=P.x,T=P.y)}if(o.isConnected){const P=o.getConnectedValue(x);P&&(C=P.x,y=P.y)}if(l.isConnected){const P=l.getConnectedValue(x);P&&(A=P.x,T=P.y,C=P.z)}return new We(A,T,C,y)};u._storedFunction=x=>v(x),h._storedFunction=x=>{const A=v(x);return new m(A.x,A.y,A.z)},f._storedFunction=x=>{const A=v(x);return new se(A.x,A.y)},d._storedFunction=x=>{const A=v(x);return new se(A.z,A.w)},p._storedFunction=x=>v(x).x,_._storedFunction=x=>v(x).y,g._storedFunction=x=>v(x).z,E._storedFunction=x=>v(x).w}}$("BABYLON.VectorConverterBlock",yB);class bB extends nt{constructor(e){super(e),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),this.output._storedFunction=null,!this.input.isConnected){this.output._storedValue=null;return}this.output._storedFunction=t=>this.input.getConnectedValue(t).normalize()}}$("BABYLON.NormalizeVectorBlock",bB);class NA extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("id",R.Int,!0,0),this.registerOutput("output",R.Geometry),this.id.acceptedConnectionPointTypes.push(R.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const t=i=>{const r=this.geometry.getConnectedValue(i);if(!r||!r.indices||!r.positions)return r;const s=new uu;return s.materialIndex=this.id.getConnectedValue(i)|0,s.indexStart=0,s.indexCount=r.indices.length,s.verticesStart=0,s.verticesCount=r.positions.length/3,r.materialInfos=[s],r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],NA.prototype,"evaluateContext",void 0);$("BABYLON.SetMaterialIDBlock",NA);class Pc extends nt{constructor(e){super(e),this._indexVector3=new m,this._currentControl=new m,this.evaluateContext=!0,this.resolutionX=3,this.resolutionY=3,this.resolutionZ=3,this.registerInput("geometry",R.Geometry),this.registerInput("controls",R.Vector3),this.registerOutput("output",R.Geometry)}getExecutionIndex(){return this._currentIndexX+this.resolutionX*(this._currentIndexY+this.resolutionY*this._currentIndexZ)}getExecutionLoopIndex(){return this.getExecutionIndex()}getExecutionFaceIndex(){return 0}getClassName(){return"LatticeBlock"}get geometry(){return this._inputs[0]}get controls(){return this._inputs[1]}get output(){return this._outputs[0]}getOverridePositionsContextualValue(){return this._indexVector3}getOverrideNormalsContextualValue(){return this._currentControl}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),!this._vertexData||!this._vertexData.positions){i.restoreExecutionContext(),this.output._storedValue=null;return}const r=this._vertexData.positions,s=to(r,0,r.length/3);for(this._lattice=new qw({resolutionX:this.resolutionX,resolutionY:this.resolutionY,resolutionZ:this.resolutionZ,size:s.maximum.subtract(s.minimum)}),this._currentIndexX=0;this._currentIndexX<this.resolutionX;this._currentIndexX++)for(this._currentIndexY=0;this._currentIndexY<this.resolutionY;this._currentIndexY++)for(this._currentIndexZ=0;this._currentIndexZ<this.resolutionZ;this._currentIndexZ++){this._indexVector3.set(this._currentIndexX,this._currentIndexY,this._currentIndexZ);const a=this._lattice.data[this._currentIndexX][this._currentIndexY][this._currentIndexZ];this._currentControl.copyFrom(a);const o=this.controls.getConnectedValue(i);o&&a.set(o.x,o.y,o.z)}return this._lattice.deform(r),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.resolutionX = ${this.resolutionX};
`,e+=`${this._codeVariableName}.resolutionY = ${this.resolutionY};
`,e+=`${this._codeVariableName}.resolutionZ = ${this.resolutionZ};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.resolutionX=this.resolutionX,e.resolutionY=this.resolutionY,e.resolutionZ=this.resolutionZ,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext,this.resolutionX=e.resolutionX,this.resolutionY=e.resolutionY,this.resolutionZ=e.resolutionZ)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Pc.prototype,"evaluateContext",void 0);I([Ne("resolutionX",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],Pc.prototype,"resolutionX",void 0);I([Ne("resolutionY",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],Pc.prototype,"resolutionY",void 0);I([Ne("resolutionZ",2,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},min:1,max:10})],Pc.prototype,"resolutionZ",void 0);$("BABYLON.LatticeBlock",Pc);var Mt;(function(n){n[n.Cos=0]="Cos",n[n.Sin=1]="Sin",n[n.Abs=2]="Abs",n[n.Exp=3]="Exp",n[n.Round=4]="Round",n[n.Floor=5]="Floor",n[n.Ceiling=6]="Ceiling",n[n.Sqrt=7]="Sqrt",n[n.Log=8]="Log",n[n.Tan=9]="Tan",n[n.ArcTan=10]="ArcTan",n[n.ArcCos=11]="ArcCos",n[n.ArcSin=12]="ArcSin",n[n.Sign=13]="Sign",n[n.Negate=14]="Negate",n[n.OneMinus=15]="OneMinus",n[n.Reciprocal=16]="Reciprocal",n[n.ToDegrees=17]="ToDegrees",n[n.ToRadians=18]="ToRadians",n[n.Fract=19]="Fract",n[n.Exp2=20]="Exp2"})(Mt||(Mt={}));class LA extends nt{constructor(e){super(e),this.operation=Mt.Cos,this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case Mt.Cos:{t=i=>Math.cos(i);break}case Mt.Sin:{t=i=>Math.sin(i);break}case Mt.Abs:{t=i=>Math.abs(i);break}case Mt.Exp:{t=i=>Math.exp(i);break}case Mt.Exp2:{t=i=>Math.pow(2,i);break}case Mt.Round:{t=i=>Math.round(i);break}case Mt.Floor:{t=i=>Math.floor(i);break}case Mt.Ceiling:{t=i=>Math.ceil(i);break}case Mt.Sqrt:{t=i=>Math.sqrt(i);break}case Mt.Log:{t=i=>Math.log(i);break}case Mt.Tan:{t=i=>Math.tan(i);break}case Mt.ArcTan:{t=i=>Math.atan(i);break}case Mt.ArcCos:{t=i=>Math.acos(i);break}case Mt.ArcSin:{t=i=>Math.asin(i);break}case Mt.Sign:{t=i=>Math.sign(i);break}case Mt.Negate:{t=i=>-i;break}case Mt.OneMinus:{t=i=>1-i;break}case Mt.Reciprocal:{t=i=>1/i;break}case Mt.ToRadians:{t=i=>i*Math.PI/180;break}case Mt.ToDegrees:{t=i=>i*180/Math.PI;break}case Mt.Fract:{t=i=>i>=0?i-Math.floor(i):i-Math.ceil(i);break}}if(!t){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.input.type){case R.Int:case R.Float:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return t(r)};break}case R.Vector2:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new se(t(r.x),t(r.y))};break}case R.Vector3:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new m(t(r.x),t(r.y),t(r.z))};break}case R.Vector4:{this.output._storedFunction=i=>{const r=this.input.getConnectedValue(i);return new We(t(r.x),t(r.y),t(r.z),t(r.w))};break}}return this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${Mt[this.operation]};
`}}I([Ne("Operation",4,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0},options:[{label:"Cos",value:Mt.Cos},{label:"Sin",value:Mt.Sin},{label:"Abs",value:Mt.Abs},{label:"Exp",value:Mt.Exp},{label:"Exp2",value:Mt.Exp2},{label:"Round",value:Mt.Round},{label:"Floor",value:Mt.Floor},{label:"Ceiling",value:Mt.Ceiling},{label:"Sqrt",value:Mt.Sqrt},{label:"Log",value:Mt.Log},{label:"Tan",value:Mt.Tan},{label:"ArcTan",value:Mt.ArcTan},{label:"ArcCos",value:Mt.ArcCos},{label:"ArcSin",value:Mt.ArcSin},{label:"Sign",value:Mt.Sign},{label:"Negate",value:Mt.Negate},{label:"OneMinus",value:Mt.OneMinus},{label:"Reciprocal",value:Mt.Reciprocal},{label:"ToDegrees",value:Mt.ToDegrees},{label:"ToRadians",value:Mt.ToRadians},{label:"Fract",value:Mt.Fract}]})],LA.prototype,"operation",void 0);$("BABYLON.GeometryTrigonometryBlock",LA);class FA extends nt{constructor(e){super(e),this._rotationMatrix=new O,this._scalingMatrix=new O,this._translationMatrix=new O,this._scalingRotationMatrix=new O,this._pivotMatrix=new O,this._backPivotMatrix=new O,this._transformMatrix=new O,this.evaluateContext=!0,this.registerInput("value",R.AutoDetect),this.registerInput("matrix",R.Matrix,!0),this.registerInput("translation",R.Vector3,!0,m.Zero()),this.registerInput("rotation",R.Vector3,!0,m.Zero()),this.registerInput("scaling",R.Vector3,!0,m.One()),this.registerInput("pivot",R.Vector3,!0,m.Zero()),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get pivot(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const t=i=>{const r=this.value.getConnectedValue(i);if(!r)return null;let s;if(this.matrix.isConnected)s=this.matrix.getConnectedValue(i);else{const a=this.scaling.getConnectedValue(i)||m.OneReadOnly,o=this.rotation.getConnectedValue(i)||m.ZeroReadOnly,l=this.translation.getConnectedValue(i)||m.ZeroReadOnly,c=this.pivot.getConnectedValue(i)||m.ZeroReadOnly;O.TranslationToRef(-c.x,-c.y,-c.z,this._pivotMatrix),O.ScalingToRef(a.x,a.y,a.z,this._scalingMatrix),O.RotationYawPitchRollToRef(o.y,o.x,o.z,this._rotationMatrix),O.TranslationToRef(l.x+c.x,l.y+c.y,l.z+c.z,this._translationMatrix),this._pivotMatrix.multiplyToRef(this._scalingMatrix,this._backPivotMatrix),this._backPivotMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),s=this._transformMatrix}switch(this.value.type){case R.Geometry:{const a=r.clone();return a.transform(s),a}case R.Vector2:return se.Transform(r,s);case R.Vector3:return m.TransformCoordinates(r,s);case R.Vector4:return We.TransformCoordinates(r,s)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],FA.prototype,"evaluateContext",void 0);$("BABYLON.GeometryTransformBlock",FA);class RB extends nt{constructor(e){super(e),this.registerInput("angle",R.Float,!1,0),this.registerOutput("matrix",R.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new zi("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>O.RotationX(this.angle.getConnectedValue(t))}}$("BABYLON.RotationXBlock",RB);class PB extends nt{constructor(e){super(e),this.registerInput("angle",R.Float,!1,0),this.registerOutput("matrix",R.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new zi("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>O.RotationY(this.angle.getConnectedValue(t))}}$("BABYLON.RotationYBlock",PB);class MB extends nt{constructor(e){super(e),this.registerInput("angle",R.Float,!1,0),this.registerOutput("matrix",R.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new zi("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>O.RotationZ(this.angle.getConnectedValue(t))}}$("BABYLON.RotationZBlock",MB);class DB extends nt{constructor(e){super(e),this.registerInput("scale",R.Vector3,!1,m.One()),this.registerOutput("matrix",R.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){const e=new zi("Scale");e.value=new m(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{const i=this.scale.getConnectedValue(t);return O.Scaling(i.x,i.y,i.z)}}}$("BABYLON.ScalingBlock",DB);class OB extends nt{constructor(e){super(e),this.registerInput("source",R.Vector3,!0,m.Up()),this.registerInput("target",R.Vector3,!0,m.Left()),this.registerOutput("matrix",R.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{const i=this.source.getConnectedValue(t).clone(),r=this.target.getConnectedValue(t).clone(),s=new O;return i.normalize(),r.normalize(),O.RotationAlignToRef(i,r,s,!0),s}}}$("BABYLON.AlignBlock",OB);class NB extends nt{constructor(e){super(e),this.registerInput("translation",R.Vector3,!1,m.Zero()),this.registerOutput("matrix",R.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){const e=new zi("Translation");e.value=new m(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{const i=this.translation.getConnectedValue(t);return O.Translation(i.x,i.y,i.z)}}}$("BABYLON.TranslationBlock",NB);class u_ extends nt{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",R.Geometry),this.registerInput("instance",R.Geometry,!0),this.registerInput("density",R.Float,!0,1,0,1),this.registerInput("matrix",R.Matrix,!0),this.registerInput("rotation",R.Vector3,!0,m.Zero()),this.registerInput("scaling",R.Vector3,!0,m.One()),this.scaling.acceptedConnectionPointTypes.push(R.Float),this.registerOutput("output",R.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=this._vertexData.positions.length/3;const s=[],a=new m,o=[];let l=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const c=l[this._currentIndex*3],u=l[this._currentIndex*3+1],h=l[this._currentIndex*3+2];let f=!1;for(let d=0;d<o.length;d+=3)if(Math.abs(o[d]-c)<pt&&Math.abs(o[d+1]-u)<pt&&Math.abs(o[d+2]-h)<pt){f=!0;break}f||(this._indexTranslation[o.length/3]=this._currentIndex,o.push(c,u,h))}l=o,r=l.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const c=this.instance.getConnectedValue(i);if(!c||!c.positions||c.positions.length===0)continue;const u=this.density.getConnectedValue(i);if(u<1&&Math.random()>u)continue;a.fromArray(l,this._currentIndex*3);const h=c.clone();if(this.matrix.isConnected){const f=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(h,a,f,s)}else{const f=i.adaptInput(this.scaling,R.Vector3,m.OneReadOnly),d=this.rotation.getConnectedValue(i)||m.ZeroReadOnly;i._instantiate(h,a,d,f,s)}this._currentLoopIndex++}if(i.restoreGeometryContext(),i.restoreExecutionContext(),i.restoreInstancingContext(),s.length)if(s.length===1)this._vertexData=s[0];else{const c=s.splice(0,1)[0];this._vertexData=c.merge(s,!0,!1,!0,!0)}else return null;return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};
`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],u_.prototype,"evaluateContext",void 0);I([Ne("Remove duplicated positions",0,"ADVANCED",{notifiers:{update:!0}})],u_.prototype,"removeDuplicatedPositions",void 0);$("BABYLON.InstantiateOnVerticesBlock",u_);class wA extends nt{constructor(e){super(e),this._currentPosition=new m,this._currentUV=new se,this._vertex0=new m,this._vertex1=new m,this._vertex2=new m,this._tempVector0=new m,this._tempVector1=new m,this._uv0=new se,this._uv1=new se,this._uv2=new se,this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("instance",R.Geometry,!0),this.registerInput("count",R.Int,!0,256),this.registerInput("matrix",R.Matrix,!0),this.registerInput("rotation",R.Vector3,!0,m.Zero()),this.registerInput("scaling",R.Vector3,!0,m.One()),this.scaling.acceptedConnectionPointTypes.push(R.Float),this.registerOutput("output",R.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),m.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=null;const s=this.count.getConnectedValue(i),a=this._vertexData.indices.length/3,o=s/a;let l=0;const c=[];let u=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<a;this._currentFaceIndex++){l+=o;const h=(l|0)-u;if(h<1)continue;const f=this._vertexData.indices[this._currentFaceIndex*3],d=this._vertexData.indices[this._currentFaceIndex*3+1],p=this._vertexData.indices[this._currentFaceIndex*3+2];this._vertex0.fromArray(this._vertexData.positions,f*3),this._vertex1.fromArray(this._vertexData.positions,d*3),this._vertex2.fromArray(this._vertexData.positions,p*3),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,f*2),this._uv1.fromArray(this._vertexData.uvs,d*2),this._uv2.fromArray(this._vertexData.uvs,p*2));for(let _=0;_<h&&!(u>=s);_++){let g=Math.random(),E=Math.random();if(g>E){const C=g;g=E,E=C}const v=g,x=E-g,A=1-v-x;if(this._currentPosition.set(v*this._vertex0.x+x*this._vertex1.x+A*this._vertex2.x,v*this._vertex0.y+x*this._vertex1.y+A*this._vertex2.y,v*this._vertex0.z+x*this._vertex1.z+A*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(v*this._uv0.x+x*this._uv1.x+A*this._uv2.x,v*this._uv0.y+x*this._uv1.y+A*this._uv2.y),r=this.instance.getConnectedValue(i),!r||!r.positions||r.positions.length===0){l-=o;continue}const T=r.clone();if(this.matrix.isConnected){const C=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(T,this._currentPosition,C,c)}else{const C=i.adaptInput(this.scaling,R.Vector3,m.OneReadOnly),y=this.rotation.getConnectedValue(i)||m.ZeroReadOnly;i._instantiate(T,this._currentPosition,y,C,c)}u++,this._currentLoopIndex++}}if(c.length)if(c.length===1)this._vertexData=c[0];else{const h=c.splice(0,1)[0];this._vertexData=h.merge(c,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],wA.prototype,"evaluateContext",void 0);$("BABYLON.InstantiateOnFacesBlock",wA);class h_ extends nt{constructor(e){super(e),this._currentPosition=new m,this._vertex0=new m,this._vertex1=new m,this._vertex2=new m,this.evaluateContext=!0,this.gridMode=!1,this.registerInput("geometry",R.Geometry),this.registerInput("instance",R.Geometry,!0),this.registerInput("count",R.Int,!0,256),this.registerInput("matrix",R.Matrix,!0),this.registerInput("rotation",R.Vector3,!0,m.Zero()),this.registerInput("scaling",R.Vector3,!0,m.One()),this.registerInput("gridSize",R.Int,!0,10),this.scaling.acceptedConnectionPointTypes.push(R.Float),this.registerOutput("output",R.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get gridSize(){return this._inputs[6]}get output(){return this._outputs[0]}_getValueOnGrid(e,t,i,r){const s=(r-i)/t;return i+s/2+e*s}_getIndexinGrid(e,t,i,r){return e+t*r+i*r*r}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=null;const s=this.count.getConnectedValue(i),a=[],o=to(this._vertexData.positions,0,this._vertexData.positions.length/3),l=o.minimum,c=o.maximum,u=new m(.5,.8,.2),h=this._vertexData.indices.length/3,f=this.gridSize.getConnectedValue(i);this._currentLoopIndex=0;let d;if(this.gridMode){d=[];for(let p=0;p<f*f*f;p++)d[p]=!1}for(let p=0;p<s;p++){if(this.gridMode){let v=Math.floor(Math.random()*f),x=Math.floor(Math.random()*f),A=Math.floor(Math.random()*f),T=this._getIndexinGrid(v,x,A,f);if(d[T]){let C=!1;for(let y=0;y<f*f*f;y++)if(!d[y]){A=Math.floor(y/(f*f)),x=Math.floor((y-A*f*f)/f),v=y-A*f*f-x*f,T=this._getIndexinGrid(v,x,A,f),C=!0;break}if(!C)break}if(!d[T]){const C=this._getValueOnGrid(v,f,l.x,c.x),y=this._getValueOnGrid(x,f,l.y,c.y),P=this._getValueOnGrid(A,f,l.z,c.z);this._currentPosition.set(C,y,P),d[T]=!0}}else this._currentPosition.set(Math.random()*(c.x-l.x)+l.x,Math.random()*(c.y-l.y)+l.y,Math.random()*(c.z-l.z)+l.z);const _=new yt(this._currentPosition,u);let g=0;for(let v=0;v<h;v++){this._vertex0.fromArray(this._vertexData.positions,this._vertexData.indices[v*3]*3),this._vertex1.fromArray(this._vertexData.positions,this._vertexData.indices[v*3+1]*3),this._vertex2.fromArray(this._vertexData.positions,this._vertexData.indices[v*3+2]*3);const x=_.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);x&&x.distance>0&&g++}if(g%2===0){p--;continue}if(r=this.instance.getConnectedValue(i),!r||!r.positions||r.positions.length===0)continue;const E=r.clone();if(this.matrix.isConnected){const v=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(E,this._currentPosition,v,a)}else{const v=i.adaptInput(this.scaling,R.Vector3,m.OneReadOnly),x=this.rotation.getConnectedValue(i)||m.ZeroReadOnly;i._instantiate(E,this._currentPosition,x,v,a)}this._currentLoopIndex++}if(a.length)if(a.length===1)this._vertexData=a[0];else{const p=a.splice(0,1)[0];this._vertexData=p.merge(a,!0,!1,!0,!0)}return i.restoreGeometryContext(),i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.gridMode = ${this.gridMode?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.gridMode=this.gridMode,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext),e.gridMode!==void 0&&(this.gridMode=e.gridMode)}}I([Ne("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],h_.prototype,"evaluateContext",void 0);I([Ne("Grid mode",0,"MODES",{notifiers:{rebuild:!0}})],h_.prototype,"gridMode",void 0);$("BABYLON.InstantiateOnVolumeBlock",h_);class bh extends nt{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",R.Geometry,!0),this.registerInput("count",R.Int,!0,1),this.registerOutput("output",R.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],bh.prototype,"evaluateContext",void 0);class LB extends bh{constructor(e){super(e),this.registerInput("matrix",R.Matrix,!0),this.registerInput("position",R.Vector3,!0,m.Zero()),this.registerInput("rotation",R.Vector3,!0,m.Zero()),this.registerInput("scaling",R.Vector3,!0,m.One()),this.scaling.acceptedConnectionPointTypes.push(R.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){const t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);const r=this.count.getConnectedValue(i),s=[];for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const a=this.instance.getConnectedValue(i);if(!a||!a.positions||a.positions.length===0)continue;const o=a.clone();if(this.matrix.isConnected){const l=this.matrix.getConnectedValue(i);i._instantiateWithMatrix(o,l,s)}else{const l=this.position.getConnectedValue(i)||m.ZeroReadOnly,c=i.adaptInput(this.scaling,R.Vector3,m.OneReadOnly),u=this.rotation.getConnectedValue(i)||m.ZeroReadOnly;i._instantiate(o,l,u,c,s)}}if(s.length)if(s.length===1)this._vertexData=s[0];else{const a=s.splice(0,1)[0];this._vertexData=a.merge(s,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}$("BABYLON.InstantiateBlock",LB);class FB extends bh{constructor(e){super(e),this.registerInput("direction",R.Vector3,!0,new m(1,0,0)),this.registerInput("rotation",R.Vector3,!0,new m(0,0,0)),this.registerInput("scaling",R.Vector3,!0,new m(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(R.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){const t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);const r=this.count.getConnectedValue(i),s=[],a=O.Identity(),o=m.Zero(),l=m.Zero(),c=m.Zero();for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const u=this.instance.getConnectedValue(i);if(!u||!u.positions||u.positions.length===0)continue;const h=u.clone(),f=this.direction.getConnectedValue(i),d=this.rotation.getConnectedValue(i),p=i.adaptInput(this.scaling,R.Vector3,m.OneReadOnly);o.copyFrom(f.clone().scale(this._currentIndex)),l.copyFrom(d.clone().scale(this._currentIndex)),c.copyFrom(p.clone().scale(this._currentIndex)),c.addInPlaceFromFloats(1,1,1),O.ComposeToRef(c,ce.FromEulerAngles(l.x,l.y,l.z),o,a),i._instantiateWithMatrix(h,a,s)}if(s.length)if(s.length===1)this._vertexData=s[0];else{const u=s.splice(0,1)[0];this._vertexData=u.merge(s,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}$("BABYLON.InstantiateLinearBlock",FB);class wB extends bh{constructor(e){super(e),this.registerInput("radius",R.Int,!0,0,0),this.registerInput("angleStart",R.Float,!0,0),this.registerInput("angleEnd",R.Float,!0,Math.PI*2),this.registerInput("transform",R.Vector3,!0,new m(0,0,0)),this.registerInput("rotation",R.Vector3,!0,new m(0,0,0)),this.registerInput("scaling",R.Vector3,!0,new m(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(R.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){const t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);const r=this.count.getConnectedValue(i),s=[],a=O.Identity(),o=O.Identity(),l=O.Identity(),c=m.Zero(),u=m.Zero(),h=m.Zero();for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){const f=this.instance.getConnectedValue(i);if(!f||!f.positions||f.positions.length===0)continue;const d=f.clone(),p=this.radius.getConnectedValue(i),_=this.angleStart.getConnectedValue(i),g=this.angleEnd.getConnectedValue(i),E=this.transform.getConnectedValue(i),v=this.rotation.getConnectedValue(i),x=i.adaptInput(this.scaling,R.Vector3,m.OneReadOnly),T=(g-_)/r,C=_+T*this._currentIndex,y=ce.FromEulerAngles(0,C,0);c.copyFrom(E.clone().scale(this._currentIndex)),u.copyFrom(v.clone().scale(this._currentIndex)),h.copyFrom(x.clone().scale(this._currentIndex)),h.addInPlaceFromFloats(1,1,1),O.RotationYawPitchRollToRef(u.y,u.x,u.z,a),o.setTranslationFromFloats(0,0,p),O.ComposeToRef(h,y,c,l),a.multiplyToRef(o,o),o.multiplyToRef(l,l),i._instantiateWithMatrix(d,l,s)}if(s.length)if(s.length===1)this._vertexData=s[0];else{const f=s.splice(0,1)[0];this._vertexData=f.merge(s,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}$("BABYLON.InstantiateRadialBlock",wB);class BB extends nt{constructor(e){super(e),this.registerInput("float ",R.Float,!0),this.registerInput("int ",R.Int,!0),this.registerOutput("float",R.Float),this.registerOutput("int",R.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return e==="float "?"floatIn":e==="int "?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}}$("BABYLON.IntFloatConverterBlock",BB);class VB extends nt{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}get buildExecutionTime(){return-1}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.log=[];const t=i=>{const r=this.input.getConnectedValue(i);if(r==null)return this.log.push(["null",""]),r;switch(this.input.type){case R.Vector2:this.log.push([YN(r,4),r.toString()]);break;case R.Vector3:this.log.push([$N(r,4),r.toString()]);break;case R.Vector4:this.log.push([KN(r,4),r.toString()]);break;default:this.log.push([r.toString(),r.toString()]);break}return r};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}}$("BABYLON.DebugBlock",VB);class UB extends nt{constructor(e){super(e),this.registerInput("geometry",R.Geometry),this.registerOutput("output",R.Geometry),this.registerOutput("id",R.Int),this.registerOutput("collectionId",R.Int),this.registerOutput("verticesCount",R.Int),this.registerOutput("facesCount",R.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected){this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,this.output._storedFunction=null;return}this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}$("BABYLON.GeometryInfoBlock",UB);var on;(function(n){n[n.Spherical=0]="Spherical",n[n.Cylindrical=1]="Cylindrical",n[n.Cubic=2]="Cubic"})(on||(on={}));class BA extends nt{constructor(e){super(e),this.mapping=on.Spherical,this.registerInput("position",R.Vector3),this.registerInput("normal",R.Vector3),this.registerInput("center",R.Vector3,!0,m.Zero()),this.registerOutput("uv",R.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected){this.uv._storedFunction=null,this.uv._storedValue=null;return}const e=m.Zero(),t=i=>{const r=this.position.getConnectedValue(i)||m.Zero(),s=this.normal.getConnectedValue(i)||m.Zero(),a=this.center.getConnectedValue(i),o=se.Zero();switch(this.mapping){case on.Spherical:{r.subtractToRef(a,e);const l=e.length();l>0&&(o.x=Math.acos(e.y/l)/Math.PI,(e.x!==0||e.z!==0)&&(o.y=Math.atan2(e.x,e.z)/(Math.PI*2)));break}case on.Cylindrical:{r.subtractToRef(a,e);const l=e.length();l>0&&(o.x=Math.atan2(e.x/l,e.z/l)/(Math.PI*2),o.y=(e.y+1)/2);break}case on.Cubic:{const l=Math.abs(s.x),c=Math.abs(s.y),u=Math.abs(s.z),h=Math.max(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z));let f=0,d=0;l>=c&&l>=u?(f=r.y/h-a.y,d=r.z/h-a.z):c>=l&&c>=u?(f=r.x/h-a.x,d=r.z/h-a.z):(f=r.x/h-a.x,d=r.y/h-a.y),o.x=(f+1)/2,o.y=(d+1)/2}}return o};this.uv._storedFunction=i=>t(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${on[this.mapping]};
`}serialize(){const e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}I([Ne("Mapping",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Spherical",value:on.Spherical},{label:"Cylindrical",value:on.Cylindrical},{label:"Cubic",value:on.Cubic}]})],BA.prototype,"mapping",void 0);$("BABYLON.MappingBlock",BA);class kB extends nt{constructor(e){super(e),this.registerInput("matrix0",R.Matrix),this.registerInput("matrix1",R.Matrix),this.registerOutput("output",R.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;const t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return!t||!i?null:t.multiply(i)}}}$("BABYLON.MatrixComposeBlock",kB);class GB extends nt{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",R.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(const t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(const t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(const t of this.endpoints){const i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(const e of this._endpoints)e.output._storedFunction=t=>this.input.getConnectedValue(t)}}$("BABYLON.TeleportInBlock",GB);class zB extends nt{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",R.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){const e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){var t;const e=super.serialize();return e.entryPoint=((t=this.entryPoint)==null?void 0:t.uniqueId)??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}$("BABYLON.TeleportOutBlock",zB);class VA extends nt{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",R.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}_prepareImgToLoadAsync(e){return new Promise((t,i)=>{const r=new Image,s=document.createElement("canvas"),a=s.getContext("2d");r.onload=()=>{s.width=r.width,s.height=r.height,a.drawImage(r,0,0);const l=a.getImageData(0,0,r.width,r.height).data,c=new Float32Array(l.length);for(let u=0;u<l.length;u++)c[u]=l[u]/255;this._data=c,this._width=r.width,this._height=r.height,t()},r.onerror=()=>{this._data=null,i()},r.src=e})}cleanData(){this._data=null}loadTextureFromFileAsync(e){return this._prepareImgToLoadAsync(URL.createObjectURL(e))}loadTextureFromUrlAsync(e){return this._prepareImgToLoadAsync(e)}extractFromTextureAsync(e){return new Promise((t,i)=>{if(!e.isReady()){e.onLoadObservable.addOnce(()=>this.extractFromTextureAsync(e).then(t).catch(i));return}const r=e.getSize();LD.GetTextureDataAsync(e,r.width,r.height).then(async s=>{const a=new Float32Array(s.length);for(let o=0;o<s.length;o++)a[o]=s[o]/255;this._data=a,this._width=r.width,this._height=r.height,t()}).catch(i)})}_buildBlock(){if(!this._data){this.texture._storedValue=null;return}const e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){const e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}}I([Ne("Serialize cached data",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],VA.prototype,"serializedCachedData",void 0);$("BABYLON.GeometryTextureBlock",VA);class UA extends nt{constructor(e){super(e),this.clampCoordinates=!0,this.registerInput("texture",R.Texture),this.registerInput("coordinates",R.Vector2),this.registerOutput("rgba",R.Vector4),this.registerOutput("rgb",R.Vector3),this.registerOutput("r",R.Float),this.registerOutput("g",R.Float),this.registerOutput("b",R.Float),this.registerOutput("a",R.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_buildBlock(){const e=t=>{const i=this.texture.getConnectedValue(t);if(!i||!i.data)return null;const r=this.coordinates.getConnectedValue(t);if(!r)return null;const s=this.clampCoordinates?Math.max(0,Math.min(r.x,1)):this._repeatClamp(r.x),a=this.clampCoordinates?Math.max(0,Math.min(r.y,1)):this._repeatClamp(r.y),o=Math.floor(s*(i.width-1)),l=Math.floor(a*(i.height-1)),c=o+i.width*l;return We.FromArray(i.data,c*4)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{const i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{const i=e(t);return i?i.x:null},this.g._storedFunction=t=>{const i=e(t);return i?i.y:null},this.b._storedFunction=t=>{const i=e(t);return i?i.z:null},this.a._storedFunction=t=>{const i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};
`}serialize(){const e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates}}I([Ne("Clamp Coordinates",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],UA.prototype,"clampCoordinates",void 0);$("BABYLON.GeometryTextureFetchBlock",UA);class WB extends nt{constructor(e){super(e),this.registerInput("geometry",R.Geometry),this.registerOutput("min",R.Vector3),this.registerOutput("max",R.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?to(t.positions,0,t.positions.length/3).minimum:null},this.max._storedFunction=e=>{const t=this.geometry.getConnectedValue(e);return t?to(t.positions,0,t.positions.length/3).maximum:null}}}$("BABYLON.BoundingBlock",WB);var Ss;(function(n){n[n.Intersect=0]="Intersect",n[n.Subtract=1]="Subtract",n[n.Union=2]="Union"})(Ss||(Ss={}));class Rh extends nt{get _isReadyState(){return EB()?null:(this._csg2LoadingPromise||(this._csg2LoadingPromise=vB()),this._csg2LoadingPromise)}constructor(e){super(e),this.evaluateContext=!1,this.operation=Ss.Intersect,this.useOldCSGEngine=!1,this.registerInput("geometry0",R.Geometry),this.registerInput("geometry1",R.Geometry),this.registerOutput("output",R.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{const r=this.geometry0.getConnectedValue(i),s=this.geometry1.getConnectedValue(i);if(!r||!s)return null;const a=r.positions.length/3;!r.normals&&s.normals&&(r.normals=new Array(r.positions.length)),!s.normals&&r.normals&&(s.normals=new Array(s.positions.length)),!r.uvs&&s.uvs&&(r.uvs=new Array(a*2)),!s.uvs&&r.uvs&&(s.uvs=new Array(a*2)),!r.colors&&s.colors&&(r.colors=new Array(a*4)),!s.colors&&r.colors&&(s.colors=new Array(a*4));let o;if(this.useOldCSGEngine){const l=en.FromVertexData(r),c=en.FromVertexData(s);switch(this.operation){case Ss.Intersect:o=l.intersect(c);break;case Ss.Subtract:o=l.subtract(c);break;case Ss.Union:o=l.union(c);break}}else{const l=lc.FromVertexData(r),c=lc.FromVertexData(s);switch(this.operation){case Ss.Intersect:o=l.intersect(c);break;case Ss.Subtract:o=l.subtract(c);break;case Ss.Union:o=l.add(c);break}}return o.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${Ss[this.operation]};
`,e+=`${this._codeVariableName}.useOldCSGEngine = ${this.useOldCSGEngine?"true":"false"};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e.useOldCSGEngine=this.useOldCSGEngine,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation),this.useOldCSGEngine=!!e.useOldCSGEngine}}I([Ne("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Rh.prototype,"evaluateContext",void 0);I([Ne("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Intersect",value:Ss.Intersect},{label:"Subtract",value:Ss.Subtract},{label:"Union",value:Ss.Union}]})],Rh.prototype,"operation",void 0);I([Ne("Use old CSG engine",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],Rh.prototype,"useOldCSGEngine",void 0);$("BABYLON.BooleanGeometryBlock",Rh);class HB extends nt{constructor(e){super(e),this.registerInput("x",R.AutoDetect),this.registerInput("y",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.x.isConnected||!this.y.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>Math.atan2(t,i);this.output._storedFunction=t=>{const i=this.x.getConnectedValue(t),r=this.y.getConnectedValue(t);switch(this.x.type){case R.Int:case R.Float:return e(i,r);case R.Vector2:return new se(e(i.x,r.x),e(i.y,r.y));case R.Vector3:return new m(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case R.Vector4:return new We(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0}}}$("BABYLON.GeometryArcTan2Block",HB);class XB extends nt{constructor(e){super(e),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerInput("gradient",R.Float),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected||!this.gradient.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>(1-t)*i+t*r;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),s=this.gradient.getConnectedValue(t);switch(this.left.type){case R.Int:case R.Float:return e(s,i,r);case R.Vector2:return new se(e(s,i.x,r.x),e(s,i.y,r.y));case R.Vector3:return new m(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z));case R.Vector4:return new We(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z),e(s,i.w,r.w))}return 0},this}}$("BABYLON.GeometryLerpBlock",XB);class YB extends nt{constructor(e){super(e),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerInput("gradient",R.Float),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryNLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected||!this.gradient.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>(1-t)*i+t*r;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),s=this.gradient.getConnectedValue(t);switch(this.left.type){case R.Int:case R.Float:return e(s,i,r);case R.Vector2:{const a=new se(e(s,i.x,r.x),e(s,i.y,r.y));return a.normalize(),a}case R.Vector3:{const a=new m(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z));return a.normalize(),a}case R.Vector4:{const a=new We(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z),e(s,i.w,r.w));return a.normalize(),a}}return 0},this}}$("BABYLON.GeometryNLerpBlock",YB);class $B extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerInput("edge",R.Float),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryStepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.edge.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>t<i?0:1;return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge.getConnectedValue(t);switch(this.value.type){case R.Int:case R.Float:return e(i,r);case R.Vector2:return new se(e(i.x,r),e(i.y,r));case R.Vector3:return new m(e(i.x,r),e(i.y,r),e(i.z,r));case R.Vector4:return new We(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}$("BABYLON.GeometryStepBlock",$B);class KB extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerInput("edge0",R.Float),this.registerInput("edge1",R.Float),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometrySmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.edge0.isConnected||!this.edge1.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>{const s=Math.max(0,Math.min((t-i)/(r-i),1));return s*s*(3-2*s)};return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.edge0.getConnectedValue(t),s=this.edge1.getConnectedValue(t);switch(this.value.type){case R.Int:case R.Float:return e(i,r,s);case R.Vector2:return new se(e(i.x,r,s),e(i.y,r,s));case R.Vector3:return new m(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s));case R.Vector4:return new We(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s),e(i.w,r,s))}return 0},this}}$("BABYLON.GeometrySmoothStepBlock",KB);class jB extends nt{constructor(e){super(e),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>t-Math.floor(t/i)*i;return this.output._storedFunction=t=>{const i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);switch(this.left.type){case R.Int:case R.Float:return e(i,r);case R.Vector2:return new se(e(i.x,r.x),e(i.y,r.y));case R.Vector3:return new m(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case R.Vector4:return new We(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0},this}}$("BABYLON.GeometryModBlock",jB);class qB extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerInput("power",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryPowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.power.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i)=>Math.pow(t,i);return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.power.getConnectedValue(t);switch(this.value.type){case R.Int:case R.Float:return e(i,r);case R.Vector2:return new se(e(i.x,r),e(i.y,r));case R.Vector3:return new m(e(i.x,r),e(i.y,r),e(i.z,r));case R.Vector4:return new We(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}$("BABYLON.GeometryPowBlock",qB);class f_ extends nt{constructor(e){super(e),this.minimum=0,this.maximum=1,this.registerInput("value",R.AutoDetect),this.registerInput("min",R.Float,!0),this.registerInput("max",R.Float,!0),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Geometry),this._inputs[0].excludedConnectionPointTypes.push(R.Texture)}getClassName(){return"GeometryClampBlock"}get value(){return this._inputs[0]}get min(){return this._inputs[1]}get max(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}const e=(t,i,r)=>Math.max(i,Math.min(t,r));return this.output._storedFunction=t=>{const i=this.value.getConnectedValue(t),r=this.min.isConnected?this.min.getConnectedValue(t):this.minimum,s=this.max.isConnected?this.max.getConnectedValue(t):this.maximum;switch(this.value.type){case R.Int:case R.Float:return e(i,r,s);case R.Vector2:return new se(e(i.x,r,s),e(i.y,r,s));case R.Vector3:return new m(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s));case R.Vector4:return new We(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s),e(i.w,r,s))}return 0},this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};
`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e){super._deserialize(e),this.minimum=e.minimum,this.maximum=e.maximum}}I([Ne("Minimum",1,void 0,{embedded:!0})],f_.prototype,"minimum",void 0);I([Ne("Maximum",1,void 0,{embedded:!0})],f_.prototype,"maximum",void 0);$("BABYLON.GeometryClampBlock",f_);class ZB extends nt{constructor(e){super(e),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Int),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Vector2),this._inputs[1].excludedConnectionPointTypes.push(R.Int),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Vector2)}getClassName(){return"GeometryCrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);switch(this.left.type){case R.Vector3:return m.Cross(t,i);case R.Vector4:return m.Cross(t.toVector3(),i.toVector3())}return 0},this}}$("BABYLON.GeometryCrossBlock",ZB);var St;(function(n){n[n.EaseInSine=0]="EaseInSine",n[n.EaseOutSine=1]="EaseOutSine",n[n.EaseInOutSine=2]="EaseInOutSine",n[n.EaseInQuad=3]="EaseInQuad",n[n.EaseOutQuad=4]="EaseOutQuad",n[n.EaseInOutQuad=5]="EaseInOutQuad",n[n.EaseInCubic=6]="EaseInCubic",n[n.EaseOutCubic=7]="EaseOutCubic",n[n.EaseInOutCubic=8]="EaseInOutCubic",n[n.EaseInQuart=9]="EaseInQuart",n[n.EaseOutQuart=10]="EaseOutQuart",n[n.EaseInOutQuart=11]="EaseInOutQuart",n[n.EaseInQuint=12]="EaseInQuint",n[n.EaseOutQuint=13]="EaseOutQuint",n[n.EaseInOutQuint=14]="EaseInOutQuint",n[n.EaseInExpo=15]="EaseInExpo",n[n.EaseOutExpo=16]="EaseOutExpo",n[n.EaseInOutExpo=17]="EaseInOutExpo",n[n.EaseInCirc=18]="EaseInCirc",n[n.EaseOutCirc=19]="EaseOutCirc",n[n.EaseInOutCirc=20]="EaseInOutCirc",n[n.EaseInBack=21]="EaseInBack",n[n.EaseOutBack=22]="EaseOutBack",n[n.EaseInOutBack=23]="EaseInOutBack",n[n.EaseInElastic=24]="EaseInElastic",n[n.EaseOutElastic=25]="EaseOutElastic",n[n.EaseInOutElastic=26]="EaseInOutElastic"})(St||(St={}));class kA extends nt{constructor(e){super(e),this.type=St.EaseInOutSine,this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[0].excludedConnectionPointTypes.push(R.Int)}getClassName(){return"GeometryCurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e;switch(this.type){case St.EaseInSine:e=t=>1-Math.cos(t*3.1415/2);break;case St.EaseOutSine:e=t=>Math.sin(t*3.1415/2);break;case St.EaseInOutSine:e=t=>-(Math.cos(t*3.1415)-1)/2;break;case St.EaseInQuad:e=t=>t*t;break;case St.EaseOutQuad:e=t=>(1-t)*(1-t);break;case St.EaseInOutQuad:{e=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;break}case St.EaseInCubic:e=t=>t*t*t;break;case St.EaseOutCubic:{e=t=>1-Math.pow(1-t,3);break}case St.EaseInOutCubic:{e=t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;break}case St.EaseInQuart:e=t=>t*t*t*t;break;case St.EaseOutQuart:{e=t=>1-Math.pow(1-t,4);break}case St.EaseInOutQuart:{e=t=>t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2;break}case St.EaseInQuint:e=t=>t*t*t*t*t;break;case St.EaseOutQuint:{e=t=>1-Math.pow(1-t,5);break}case St.EaseInOutQuint:{e=t=>t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2;break}case St.EaseInExpo:{e=t=>t===0?0:Math.pow(2,10*t-10);break}case St.EaseOutExpo:{e=t=>t===1?1:1-Math.pow(2,-10*t);break}case St.EaseInOutExpo:{e=t=>t===0?0:t===1?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2;break}case St.EaseInCirc:{e=t=>1-Math.sqrt(1-Math.pow(t,2));break}case St.EaseOutCirc:{e=t=>Math.sqrt(1-Math.pow(t-1,2));break}case St.EaseInOutCirc:{e=t=>t<.5?(1-Math.sqrt(1-Math.pow(2*t,2)))/2:(Math.sqrt(1-Math.pow(-2*t+2,2))+1)/2;break}case St.EaseInBack:{e=t=>2.70158*t*t*t-1.70158*t*t;break}case St.EaseOutBack:{e=t=>2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2);break}case St.EaseInOutBack:{e=t=>t<.5?Math.pow(2*t,2)*(3.5949095*2*t-2.5949095)/2:(Math.pow(2*t-2,2)*(3.5949095*(t*2-2)+3.5949095)+2)/2;break}case St.EaseInElastic:{e=t=>t===0?0:t===1?1:-Math.pow(2,10*t-10)*Math.sin((t*10-10.75)*(2*3.1415/3));break}case St.EaseOutElastic:{e=t=>t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t*10-.75)*(2*3.1415/3))+1;break}case St.EaseInOutElastic:{e=t=>t===0?0:t==1?1:t<.5?-(Math.pow(2,20*t-10)*Math.sin((20*t-11.125)*(2*3.1415/4.5)))/2:Math.pow(2,-20*t+10)*Math.sin((20*t-11.125)*(2*3.1415/4.5))/2+1;break}}return this.output._storedFunction=t=>{const i=this.input.getConnectedValue(t);switch(this.input.type){case R.Float:return e(i);case R.Vector2:return new se(e(i.x),e(i.y));case R.Vector3:return new m(e(i.x),e(i.y),e(i.z));case R.Vector4:return new We(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryCurveBlockTypes.${St[this.type]};
`}}I([Ne("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:St.EaseInSine},{label:"EaseOutSine",value:St.EaseOutSine},{label:"EaseInOutSine",value:St.EaseInOutSine},{label:"EaseInQuad",value:St.EaseInQuad},{label:"EaseOutQuad",value:St.EaseOutQuad},{label:"EaseInOutQuad",value:St.EaseInOutQuad},{label:"EaseInCubic",value:St.EaseInCubic},{label:"EaseOutCubic",value:St.EaseOutCubic},{label:"EaseInOutCubic",value:St.EaseInOutCubic},{label:"EaseInQuart",value:St.EaseInQuart},{label:"EaseOutQuart",value:St.EaseOutQuart},{label:"EaseInOutQuart",value:St.EaseInOutQuart},{label:"EaseInQuint",value:St.EaseInQuint},{label:"EaseOutQuint",value:St.EaseOutQuint},{label:"EaseInOutQuint",value:St.EaseInOutQuint},{label:"EaseInExpo",value:St.EaseInExpo},{label:"EaseOutExpo",value:St.EaseOutExpo},{label:"EaseInOutExpo",value:St.EaseInOutExpo},{label:"EaseInCirc",value:St.EaseInCirc},{label:"EaseOutCirc",value:St.EaseOutCirc},{label:"EaseInOutCirc",value:St.EaseInOutCirc},{label:"EaseInBack",value:St.EaseInBack},{label:"EaseOutBack",value:St.EaseOutBack},{label:"EaseInOutBack",value:St.EaseInOutBack},{label:"EaseInElastic",value:St.EaseInElastic},{label:"EaseOutElastic",value:St.EaseOutElastic},{label:"EaseInOutElastic",value:St.EaseInOutElastic}]})],kA.prototype,"type",void 0);$("BABYLON.GeometryCurveBlock",kA);class QB extends nt{constructor(e){super(e),this.registerInput("color",R.Vector3),this.registerInput("level",R.Float,!0,0),this.registerOutput("output",R.Vector3)}getClassName(){return"GeometryDesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.color.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.color.getConnectedValue(e),i=this.level.getConnectedValue(e),r=Math.min(t.x,t.y,t.z),s=Math.max(t.x,t.y,t.z),a=.5*(r+s);return new m(t.x*(1-i)+a*i,t.y*(1-i)+a*i,t.z*(1-i)+a*i)},this}}$("BABYLON.GeometryDesaturateBlock",QB);class JB extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerInput("steps",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(R.Float)}getClassName(){return"GeometryPosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.steps.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.steps.getConnectedValue(e);let r=i;if(this.steps.type===R.Float)switch(this.value.type){case R.Vector2:r=new se(i,i);break;case R.Vector3:r=new m(i,i,i);break;case R.Vector4:r=new We(i,i,i,i);break}switch(this.value.type){case R.Vector2:return new se(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y));case R.Vector3:return new m(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z));case R.Vector4:return new We(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z),t.w/(1/r.w)*(1/r.w));default:return Math.floor(t/(1/i)*(1/i))}},this}}$("BABYLON.GeometryPosterizeBlock",JB);class e2 extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerInput("reference",R.AutoDetect),this.registerInput("distance",R.Float),this.registerInput("replacement",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix),this._inputs[3].excludedConnectionPointTypes.push(R.Float),this._inputs[3].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"GeometryReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.reference.isConnected||!this.distance.isConnected||!this.replacement.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.value.getConnectedValue(e),i=this.reference.getConnectedValue(e),r=this.distance.getConnectedValue(e),s=this.replacement.getConnectedValue(e);return t.subtract(i).length()<r?s:t},this}}$("BABYLON.GeometryReplaceColorBlock",e2);class t2 extends nt{constructor(e){super(e),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Int),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"GeometryDistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.subtract(i).length()},this}}$("BABYLON.GeometryDistanceBlock",t2);class i2 extends nt{constructor(e){super(e),this.registerInput("left",R.AutoDetect),this.registerInput("right",R.AutoDetect),this.registerOutput("output",R.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(R.Int),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix),this._inputs[1].excludedConnectionPointTypes.push(R.Float),this._inputs[1].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"GeometryDotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.dot(i)},this}}$("BABYLON.GeometryDotBlock",i2);class r2 extends nt{constructor(e){super(e),this.registerInput("value",R.AutoDetect),this.registerOutput("output",R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Int),this._inputs[0].excludedConnectionPointTypes.push(R.Float),this._inputs[0].excludedConnectionPointTypes.push(R.Matrix)}getClassName(){return"GeometryLengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>this.value.getConnectedValue(e).length(),this}}$("BABYLON.GeometryLengthBlock",r2);class s2 extends nt{constructor(e){super(e),this.registerInput("input",R.Vector2),this.registerInput("angle",R.Float),this.registerOutput("output",R.Vector2)}getClassName(){return"GeometryRotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.angle.isConnected||!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{const t=this.input.getConnectedValue(e),i=this.angle.getConnectedValue(e);return new se(Math.cos(i)*t.x-Math.sin(i)*t.y,Math.sin(i)*t.x+Math.cos(i)*t.y)},this}}$("BABYLON.GeometryRotate2dBlock",s2);class n2 extends nt{constructor(e){super(e),this.onInterceptionObservable=new Q(void 0,!0),this.registerInput("input",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return-1}getClassName(){return"GeometryInterceptorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];t._storedFunction=r=>{let s=i.getConnectedValue(r);return this.customFunction&&(s=this.customFunction(s,r)),this.onInterceptionObservable.notifyObservers(s),s}}}$("BABYLON.GeometryInterceptorBlock",n2);var ln;(function(n){n[n.Max=0]="Max",n[n.Min=1]="Min",n[n.Sum=2]="Sum"})(ln||(ln={}));class d_ extends nt{constructor(e){super(e),this.aggregation=ln.Sum,this.evaluateContext=!0,this.registerInput("geometry",R.Geometry),this.registerInput("source",R.AutoDetect),this.registerOutput("output",R.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[1]}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"AggregatorBlock"}get geometry(){return this._inputs[0]}get source(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){const t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.source.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}const r=this._vertexData.positions.length/3,s=[];for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++)s.push(this.source.getConnectedValue(i));let a=null;switch(this.aggregation){case ln.Max:{a=(l,c)=>Math.max(l,c);break}case ln.Min:{a=(l,c)=>Math.min(l,c);break}case ln.Sum:{a=(l,c)=>l+c;break}}if(!a){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedFunction=null,this.output._storedValue=null;return}let o;switch(this.source.type){case R.Int:case R.Float:{o=s.reduce(a);break}case R.Vector2:{const l=s.map(u=>u.x).reduce(a),c=s.map(u=>u.y).reduce(a);o=new se(l,c);break}case R.Vector3:{const l=s.map(h=>h.x).reduce(a),c=s.map(h=>h.y).reduce(a),u=s.map(h=>h.z).reduce(a);o=new m(l,c,u);break}case R.Vector4:{const l=s.map(f=>f.x).reduce(a),c=s.map(f=>f.y).reduce(a),u=s.map(f=>f.z).reduce(a),h=s.map(f=>f.w).reduce(a);o=new We(l,c,u,h);break}}return i.restoreGeometryContext(),i.restoreExecutionContext(),o};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.aggregation = BABYLON.Aggregations.${ln[this.aggregation]};
`,e}serialize(){const e=super.serialize();return e.evaluateContext=this.evaluateContext,e.aggregation=this.aggregation,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext),e.aggregation!==void 0&&(this.aggregation=e.aggregation)}}I([Ne("Aggregation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Max",value:ln.Max},{label:"Min",value:ln.Min},{label:"Sum",value:ln.Sum}]})],d_.prototype,"aggregation",void 0);I([Ne("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d_.prototype,"evaluateContext",void 0);$("BABYLON.AggregatorBlock",d_);const a2="logDepthDeclaration",o2=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;V.IncludesShadersStore[a2]=o2;const GA="fogFragmentDeclaration",zA=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;V.IncludesShadersStore[GA]=zA;const l2={name:GA,shader:zA},c2=Object.freeze(Object.defineProperty({__proto__:null,fogFragmentDeclaration:l2},Symbol.toStringTag,{value:"Module"})),u2="logDepthFragment",h2=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;V.IncludesShadersStore[u2]=h2;const f2="fogFragment",d2=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;V.IncludesShadersStore[f2]=d2;const p2="gaussianSplattingFragmentDeclaration",_2=`vec4 gaussianColor(vec4 inColor)
{float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*inColor.a;
#include<logDepthFragment>
vec3 color=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4(color,B);}
`;V.IncludesShadersStore[p2]=_2;const WA="gaussianSplattingPixelShader",HA=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplattingFragmentDeclaration>
void main () { 
#include<clipPlaneFragment>
gl_FragColor=gaussianColor(vColor);}
`;V.ShadersStore[WA]=HA;const m2={name:WA,shader:HA},g2=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingPixelShader:m2},Symbol.toStringTag,{value:"Module"})),E2="gaussianSplattingVertexDeclaration",v2="attribute vec2 position;uniform mat4 view;uniform mat4 projection;uniform mat4 world;";V.IncludesShadersStore[E2]=v2;const S2="gaussianSplattingUboDeclaration",T2=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute vec2 position;`;V.IncludesShadersStore[S2]=T2;const x2="fogVertexDeclaration",C2=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;V.IncludesShadersStore[x2]=C2;const A2="gaussianSplatting",I2=`#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)
mat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],
matrix[0][1],matrix[1][1],matrix[2][1],
matrix[0][2],matrix[1][2],matrix[2][2]);}
#endif
vec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}
struct Splat {vec4 center;vec4 color;vec4 covA;vec4 covB;};Splat readSplat(float splatIndex)
{Splat splat;vec2 splatUV=getDataUV(splatIndex,dataTextureSize);splat.center=texture2D(centersTexture,splatUV);splat.color=texture2D(colorsTexture,splatUV);splat.covA=texture2D(covariancesATexture,splatUV)*splat.center.w;splat.covB=texture2D(covariancesBTexture,splatUV)*splat.center.w;return splat;}
vec4 gaussianSplatting(vec2 meshPos,vec3 worldPos,vec2 scale,vec3 covA,vec3 covB,mat4 worldMatrix,mat4 viewMatrix,mat4 projectionMatrix)
{mat4 modelView=viewMatrix*worldMatrix;vec4 camspace=viewMatrix*vec4(worldPos,1.);vec4 pos2d=projectionMatrix*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds
|| pos2d.y<-bounds || pos2d.y>bounds) {return vec4(0.0,0.0,2.0,1.0);}
mat3 Vrk=mat3(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);mat3 J=mat3(
focal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.,0.,0.
);mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float lambda1=mid+radius,lambda2=mid-radius;if (lambda2<0.0)
{return vec4(0.0,0.0,2.0,1.0);}
vec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vec2 vCenter=vec2(pos2d);return vec4(
vCenter 
+ ((meshPos.x*majorAxis
+ meshPos.y*minorAxis)*invViewport*pos2d.w)*scale,pos2d.zw);}`;V.IncludesShadersStore[A2]=I2;const y2="fogVertex",b2=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;V.IncludesShadersStore[y2]=b2;const R2="logDepthVertex",P2=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;V.IncludesShadersStore[R2]=P2;const XA="gaussianSplattingVertexShader",YA=`#include<__decl__gaussianSplattingVertex>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplatting>
void main () {Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPos=world*vec4(splat.center.xyz,1.0);vColor=splat.color;vPosition=position;gl_Position=gaussianSplatting(position,worldPos.xyz,vec2(1.,1.),covA,covB,world,view,projection);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;V.ShadersStore[XA]=YA;const M2={name:XA,shader:YA},D2=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingVertexShader:M2},Symbol.toStringTag,{value:"Module"})),O2="logDepthDeclaration",N2=`#ifdef LOGARITHMICDEPTH
uniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;
#endif
`;V.IncludesShadersStoreWGSL[O2]=N2;const $A="fogFragmentDeclaration",KA=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
const E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32
{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;V.IncludesShadersStoreWGSL[$A]=KA;const L2={name:$A,shader:KA},F2=Object.freeze(Object.defineProperty({__proto__:null,fogFragmentDeclarationWGSL:L2},Symbol.toStringTag,{value:"Module"})),w2="logDepthFragment",B2=`#ifdef LOGARITHMICDEPTH
fragmentOutputs.fragDepth=log2(fragmentInputs.vFragmentDepth)*uniforms.logarithmicDepthConstant*0.5;
#endif
`;V.IncludesShadersStoreWGSL[w2]=B2;const V2="fogFragment",U2=`#ifdef FOG
var fog: f32=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color= vec4f(mix(uniforms.vFogColor,color.rgb,fog),color.a);
#endif
`;V.IncludesShadersStoreWGSL[V2]=U2;const k2="gaussianSplattingFragmentDeclaration",G2=`fn gaussianColor(inColor: vec4f,inPosition: vec2f)->vec4f
{var A : f32=-dot(inPosition,inPosition);if (A>-4.0)
{var B: f32=exp(A)*inColor.a;
#include<logDepthFragment>
var color: vec3f=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4f(color,B);} else {return vec4f(0.0);}}
`;V.IncludesShadersStoreWGSL[k2]=G2;const jA="gaussianSplattingPixelShader",qA=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplattingFragmentDeclaration>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
fragmentOutputs.color=gaussianColor(input.vColor,input.vPosition);}
`;V.ShadersStoreWGSL[jA]=qA;const z2={name:jA,shader:qA},W2=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingPixelShaderWGSL:z2},Symbol.toStringTag,{value:"Module"})),H2="fogVertexDeclaration",X2=`#ifdef FOG
varying vFogDistance: vec3f;
#endif
`;V.IncludesShadersStoreWGSL[H2]=X2;const Y2="gaussianSplatting",$2=`fn getDataUV(index: f32,dataTextureSize: vec2f)->vec2<f32> {let y: f32=floor(index/dataTextureSize.x);let x: f32=index-y*dataTextureSize.x;return vec2f((x+0.5),(y+0.5));}
struct Splat {center: vec4f,
color: vec4f,
covA: vec4f,
covB: vec4f,};fn readSplat(splatIndex: f32,dataTextureSize: vec2f)->Splat {var splat: Splat;let splatUV=getDataUV(splatIndex,dataTextureSize);let splatUVi32=vec2<i32>(i32(splatUV.x),i32(splatUV.y));splat.center=textureLoad(centersTexture,splatUVi32,0);splat.color=textureLoad(colorsTexture,splatUVi32,0);splat.covA=textureLoad(covariancesATexture,splatUVi32,0)*splat.center.w;splat.covB=textureLoad(covariancesBTexture,splatUVi32,0)*splat.center.w;return splat;}
fn gaussianSplatting(
meshPos: vec2<f32>,
worldPos: vec3<f32>,
scale: vec2<f32>,
covA: vec3<f32>,
covB: vec3<f32>,
worldMatrix: mat4x4<f32>,
viewMatrix: mat4x4<f32>,
projectionMatrix: mat4x4<f32>,
focal: vec2f,
invViewport: vec2f
)->vec4f {let modelView=viewMatrix*worldMatrix;let camspace=viewMatrix*vec4f(worldPos,1.0);let pos2d=projectionMatrix*camspace;let bounds=1.2*pos2d.w;if (pos2d.z<0. || pos2d.x<-bounds || pos2d.x>bounds || pos2d.y<-bounds || pos2d.y>bounds) {return vec4f(0.0,0.0,2.0,1.0);}
let Vrk=mat3x3<f32>(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);let J=mat3x3<f32>(
focal.x/camspace.z,0.0,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.0,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.0,0.0,0.0
);let invy=mat3x3<f32>(
1.0,0.0,0.0,
0.0,-1.0,0.0,
0.0,0.0,1.0
);let T=invy*transpose(mat3x3<f32>(
modelView[0].xyz,
modelView[1].xyz,
modelView[2].xyz))*J;let cov2d=transpose(T)*Vrk*T;let mid=(cov2d[0][0]+cov2d[1][1])/2.0;let radius=length(vec2<f32>((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));let lambda1=mid+radius;let lambda2=mid-radius;if (lambda2<0.0) {return vec4f(0.0,0.0,2.0,1.0);}
let diagonalVector=normalize(vec2<f32>(cov2d[0][1],lambda1-cov2d[0][0]));let majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;let minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2<f32>(diagonalVector.y,-diagonalVector.x);let vCenter=vec2<f32>(pos2d.x,pos2d.y);return vec4f(
vCenter+((meshPos.x*majorAxis+meshPos.y*minorAxis)*invViewport*pos2d.w)*scale,
pos2d.z,
pos2d.w
);}
`;V.IncludesShadersStoreWGSL[Y2]=$2;const K2="fogVertex",j2=`#ifdef FOG
vertexOutputs.vFogDistance=(scene.view*worldPos).xyz;
#endif
`;V.IncludesShadersStoreWGSL[K2]=j2;const q2="logDepthVertex",Z2=`#ifdef LOGARITHMICDEPTH
vertexOutputs.vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vertexOutputs.vFragmentDepth))*uniforms.logarithmicDepthConstant;
#endif
`;V.IncludesShadersStoreWGSL[q2]=Z2;const ZA="gaussianSplattingVertexShader",QA=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute splatIndex: f32;attribute position: vec2f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplatting>
@vertex
fn main(input : VertexInputs)->FragmentInputs {var splat: Splat=readSplat(input.splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vColor=splat.color;vertexOutputs.vPosition=input.position;vertexOutputs.position=gaussianSplatting(input.position,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;V.ShadersStoreWGSL[ZA]=QA;const Q2={name:ZA,shader:QA},J2=Object.freeze(Object.defineProperty({__proto__:null,gaussianSplattingVertexShaderWGSL:Q2},Symbol.toStringTag,{value:"Module"}));class e3 extends Gr{constructor(){super(),this.FOG=!1,this.THIN_INSTANCES=!0,this.LOGARITHMICDEPTH=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.rebuild()}}class qa extends hl{constructor(e,t){super(e,t),this.backFaceCulling=!1}get hasRenderTargetTextures(){return!1}needAlphaTesting(){return!1}needAlphaBlending(){return!0}isReadyForSubMesh(e,t){const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===!0)return!0;t.materialDefines||(t.materialDefines=new e3);const s=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();if(hh(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,!1,a),fh(s,o,this,a,!0,null,!0),dh(e,a,!1,!1),a.isDirty){a.markAsProcessed(),s.resetCachedMaterial();const l=[b.PositionKind,"splatIndex"];uh(l,a);const c=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal"],u=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture"],h=["Scene","Mesh"];_h({uniformsNames:c,uniformBuffersNames:h,samplers:u,defines:a}),Zn(c);const f=a.toString(),d=s.getEngine().createEffect("gaussianSplatting",{attributes:l,uniformsNames:c,uniformBuffersNames:h,samplers:u,defines:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([re(()=>Promise.resolve().then(()=>W2),void 0),re(()=>Promise.resolve().then(()=>J2),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>g2),void 0),re(()=>Promise.resolve().then(()=>D2),void 0)])}},o);t.setEffect(d,a,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(a._renderId=s.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=!0,!0)}static BindEffect(e,t,i){var h;const r=i.getEngine(),s=i.activeCamera,a=r.getRenderWidth(),o=r.getRenderHeight(),l=((h=s==null?void 0:s.rigParent)==null?void 0:h.rigCameras.length)||1;t.setFloat2("invViewport",1/(a/l),1/o);let c=1e3;if(s){const f=s.getProjectionMatrix().m[5];s.fovMode==He.FOVMODE_VERTICAL_FIXED?c=o*f/2:c=a*f/2}t.setFloat2("focal",c,c);const u=e;if(u.covariancesATexture){const f=u.covariancesATexture.getSize();t.setFloat2("dataTextureSize",f.width,f.height),t.setTexture("covariancesATexture",u.covariancesATexture),t.setTexture("covariancesBTexture",u.covariancesBTexture),t.setTexture("centersTexture",u.centersTexture),t.setTexture("colorsTexture",u.colorsTexture)}}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.materialDefines;if(!s)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._mustRebind(r,a,i,t.visibility)?(this.bindView(a),this.bindViewProjection(a),qa.BindEffect(t,this._activeEffect,r),Sn(a,this,r)):r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0),uo(r,t,a),this.useLogarithmicDepth&&Qn(s,a,r),this._afterBind(t,this._activeEffect,i)}clone(e){return Ke.Clone(()=>new qa(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return"GaussianSplattingMaterial"}static Parse(e,t,i){return Ke.Parse(()=>new qa(e.name,t),e,t,i)}}$("BABYLON.GaussianSplattingMaterial",qa);const fn=(n,e)=>{const t=(1<<e)-1;return(n&t)/t},HE=(n,e)=>{e.x=fn(n>>>21,11),e.y=fn(n>>>11,10),e.z=fn(n,11)},t3=(n,e)=>{e[0]=fn(n>>>24,8)*255,e[1]=fn(n>>>16,8)*255,e[2]=fn(n>>>8,8)*255,e[3]=fn(n,8)*255},i3=(n,e)=>{const t=1/(Math.sqrt(2)*.5),i=(fn(n>>>20,10)-.5)*t,r=(fn(n>>>10,10)-.5)*t,s=(fn(n,10)-.5)*t,a=Math.sqrt(1-(i*i+r*r+s*s));switch(n>>>30){case 0:e.set(a,i,r,s);break;case 1:e.set(i,a,r,s);break;case 2:e.set(i,r,a,s);break;case 3:e.set(i,r,s,a);break}};var XE;(function(n){n[n.FLOAT=0]="FLOAT",n[n.INT=1]="INT",n[n.UINT=2]="UINT",n[n.DOUBLE=3]="DOUBLE",n[n.UCHAR=4]="UCHAR",n[n.UNDEFINED=5]="UNDEFINED"})(XE||(XE={}));var YE;(function(n){n[n.MIN_X=0]="MIN_X",n[n.MIN_Y=1]="MIN_Y",n[n.MIN_Z=2]="MIN_Z",n[n.MAX_X=3]="MAX_X",n[n.MAX_Y=4]="MAX_Y",n[n.MAX_Z=5]="MAX_Z",n[n.MIN_SCALE_X=6]="MIN_SCALE_X",n[n.MIN_SCALE_Y=7]="MIN_SCALE_Y",n[n.MIN_SCALE_Z=8]="MIN_SCALE_Z",n[n.MAX_SCALE_X=9]="MAX_SCALE_X",n[n.MAX_SCALE_Y=10]="MAX_SCALE_Y",n[n.MAX_SCALE_Z=11]="MAX_SCALE_Z",n[n.PACKED_POSITION=12]="PACKED_POSITION",n[n.PACKED_ROTATION=13]="PACKED_ROTATION",n[n.PACKED_SCALE=14]="PACKED_SCALE",n[n.PACKED_COLOR=15]="PACKED_COLOR",n[n.X=16]="X",n[n.Y=17]="Y",n[n.Z=18]="Z",n[n.SCALE_0=19]="SCALE_0",n[n.SCALE_1=20]="SCALE_1",n[n.SCALE_2=21]="SCALE_2",n[n.DIFFUSE_RED=22]="DIFFUSE_RED",n[n.DIFFUSE_GREEN=23]="DIFFUSE_GREEN",n[n.DIFFUSE_BLUE=24]="DIFFUSE_BLUE",n[n.OPACITY=25]="OPACITY",n[n.F_DC_0=26]="F_DC_0",n[n.F_DC_1=27]="F_DC_1",n[n.F_DC_2=28]="F_DC_2",n[n.F_DC_3=29]="F_DC_3",n[n.ROT_0=30]="ROT_0",n[n.ROT_1=31]="ROT_1",n[n.ROT_2=32]="ROT_2",n[n.ROT_3=33]="ROT_3",n[n.UNDEFINED=34]="UNDEFINED"})(YE||(YE={}));class bi extends k{get covariancesATexture(){return this._covariancesATexture}get covariancesBTexture(){return this._covariancesBTexture}get centersTexture(){return this._centersTexture}get colorsTexture(){return this._colorsTexture}set material(e){this._material=e,this._material.backFaceCulling=!0,this._material.cullBackFaces=!1,e.resetDrawCache()}get material(){return this._material}constructor(e,t=null,i=null,r=!1){super(e,i),this._vertexCount=0,this._worker=null,this._frameIdLastUpdate=-1,this._modelViewMatrix=O.Identity(),this._canPostToWorker=!0,this._readyToDisplay=!1,this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._splatPositions=null,this._splatIndex=null,this._covariancesA=null,this._covariancesB=null,this._colors=null,this._keepInRam=!1,this._delayedTextureUpdate=null,this._oldDirection=new m,this._useRGBACovariants=!1,this._material=null,this._tmpCovariances=[0,0,0,0,0,0],this._sortIsDirty=!1;const s=new de;s.positions=[-3,-2,0,3,-2,0,0,4,0],s.indices=[0,1,2],s.applyToMesh(this),this.subMeshes=[],new _r(0,0,3,0,3,this),this.setEnabled(!1),this._useRGBACovariants=!this.getEngine().isWebGPU&&this.getEngine().version===1,this._keepInRam=r,t&&this.loadFileAsync(t),this._material=new qa(this.name+"_material",this._scene)}getClassName(){return"GaussianSplattingMesh"}getTotalVertices(){return this._vertexCount}isReady(e=!1){return super.isReady(e,!0)?this._readyToDisplay?!0:(this._postToWorker(!0),!1):!1}_postToWorker(e=!1){const t=this.getScene().getFrameId();if((e||t!==this._frameIdLastUpdate)&&this._worker&&this._scene.activeCamera&&this._canPostToWorker){const i=this._scene.activeCamera.getViewMatrix();this.getWorldMatrix().multiplyToRef(i,this._modelViewMatrix),i.invertToRef(B.Matrix[0]),this.getWorldMatrix().multiplyToRef(B.Matrix[0],B.Matrix[1]),m.TransformNormalToRef(m.Forward(this._scene.useRightHandedSystem),B.Matrix[1],B.Vector3[2]),B.Vector3[2].normalize();const r=m.Dot(B.Vector3[2],this._oldDirection);(e||Math.abs(r-1)>=.01)&&(this._oldDirection.copyFrom(B.Vector3[2]),this._frameIdLastUpdate=t,this._canPostToWorker=!1,this._worker.postMessage({view:this._modelViewMatrix.m,depthMix:this._depthMix,useRightHandedSystem:this._scene.useRightHandedSystem},[this._depthMix.buffer]))}}render(e,t,i){return this._postToWorker(),super.render(e,t,i)}static _TypeNameToEnum(e){switch(e){case"float":return 0;case"int":return 1;case"uint":return 2;case"double":return 3;case"uchar":return 4}return 5}static _ValueNameToEnum(e){switch(e){case"min_x":return 0;case"min_y":return 1;case"min_z":return 2;case"max_x":return 3;case"max_y":return 4;case"max_z":return 5;case"min_scale_x":return 6;case"min_scale_y":return 7;case"min_scale_z":return 8;case"max_scale_x":return 9;case"max_scale_y":return 10;case"max_scale_z":return 11;case"packed_position":return 12;case"packed_rotation":return 13;case"packed_scale":return 14;case"packed_color":return 15;case"x":return 16;case"y":return 17;case"z":return 18;case"scale_0":return 19;case"scale_1":return 20;case"scale_2":return 21;case"diffuse_red":case"red":return 22;case"diffuse_green":case"green":return 23;case"diffuse_blue":case"blue":return 24;case"f_dc_0":return 26;case"f_dc_1":return 27;case"f_dc_2":return 28;case"f_dc_3":return 29;case"opacity":return 25;case"rot_0":return 30;case"rot_1":return 31;case"rot_2":return 32;case"rot_3":return 33}return 34}static ParseHeader(e){const t=new Uint8Array(e),i=new TextDecoder().decode(t.slice(0,1024*10)),r=`end_header
`,s=i.indexOf(r);if(s<0||!i)return null;const a=parseInt(/element vertex (\d+)\n/.exec(i)[1]),o=/element chunk (\d+)\n/.exec(i);let l=0;o&&(l=parseInt(o[1]));let c=0,u=0;const h={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let f;(function(x){x[x.Vertex=0]="Vertex",x[x.Chunk=1]="Chunk"})(f||(f={}));let d=1;const p=[],_=[],g=i.slice(0,s).split(`
`);for(const x of g)if(x.startsWith("property ")){const[,A,T]=x.split(" "),C=bi._ValueNameToEnum(T),y=bi._TypeNameToEnum(A);d==1?(_.push({value:C,type:y,offset:u}),u+=h[A]):d==0&&(p.push({value:C,type:y,offset:c}),c+=h[A]),h[A]||w.Warn(`Unsupported property type: ${A}.`)}else if(x.startsWith("element ")){const[,A]=x.split(" ");A=="chunk"?d=1:A=="vertex"&&(d=0)}const E=new DataView(e,s+r.length),v=new ArrayBuffer(bi._RowOutputLength*a);return{vertexCount:a,chunkCount:l,rowVertexLength:c,rowChunkLength:u,vertexProperties:p,chunkProperties:_,dataView:E,buffer:v}}static _GetCompressedChunks(e,t){if(!e.chunkCount)return null;const i=e.dataView,r=new Array(e.chunkCount);for(let s=0;s<e.chunkCount;s++){const a={min:new m,max:new m,minScale:new m,maxScale:new m};r[s]=a;for(let o=0;o<e.chunkProperties.length;o++){const l=e.chunkProperties[o];let c;switch(l.type){case 0:c=i.getFloat32(l.offset+t.value,!0);break;default:continue}switch(l.value){case 0:a.min.x=c;break;case 1:a.min.y=c;break;case 2:a.min.z=c;break;case 3:a.max.x=c;break;case 4:a.max.y=c;break;case 5:a.max.z=c;break;case 6:a.minScale.x=c;break;case 7:a.minScale.y=c;break;case 8:a.minScale.z=c;break;case 9:a.maxScale.x=c;break;case 10:a.maxScale.y=c;break;case 11:a.maxScale.z=c;break}}t.value+=e.rowChunkLength}return r}static _GetSplat(e,t,i,r){const s=B.Quaternion[0],a=B.Vector3[0],o=bi._RowOutputLength,l=e.buffer,c=e.dataView,u=new Float32Array(l,t*o,3),h=new Float32Array(l,t*o+12,3),f=new Uint8ClampedArray(l,t*o+24,4),d=new Uint8ClampedArray(l,t*o+28,4),p=t>>8;let _=255,g=0,E=0,v=0;for(let x=0;x<e.vertexProperties.length;x++){const A=e.vertexProperties[x];let T;switch(A.type){case 0:T=c.getFloat32(r.value+A.offset,!0);break;case 1:T=c.getInt32(r.value+A.offset,!0);break;case 2:T=c.getUint32(r.value+A.offset,!0);break;case 3:T=c.getFloat64(r.value+A.offset,!0);break;case 4:T=c.getUint8(r.value+A.offset);break;default:continue}switch(A.value){case 12:{const C=i[p];HE(T,a),u[0]=vo.Lerp(C.min.x,C.max.x,a.x),u[1]=-vo.Lerp(C.min.y,C.max.y,a.y),u[2]=vo.Lerp(C.min.z,C.max.z,a.z)}break;case 13:i3(T,s),_=s.w,g=s.z,E=s.y,v=s.x;break;case 14:{const C=i[p];HE(T,a),h[0]=Math.exp(vo.Lerp(C.minScale.x,C.maxScale.x,a.x)),h[1]=Math.exp(vo.Lerp(C.minScale.y,C.maxScale.y,a.y)),h[2]=Math.exp(vo.Lerp(C.minScale.z,C.maxScale.z,a.z))}break;case 15:t3(T,f);break;case 16:u[0]=T;break;case 17:u[1]=T;break;case 18:u[2]=T;break;case 19:h[0]=Math.exp(T);break;case 20:h[1]=Math.exp(T);break;case 21:h[2]=Math.exp(T);break;case 22:f[0]=T;break;case 23:f[1]=T;break;case 24:f[2]=T;break;case 26:f[0]=(.5+bi._SH_C0*T)*255;break;case 27:f[1]=(.5+bi._SH_C0*T)*255;break;case 28:f[2]=(.5+bi._SH_C0*T)*255;break;case 29:f[3]=(.5+bi._SH_C0*T)*255;break;case 25:f[3]=1/(1+Math.exp(-T))*255;break;case 30:_=T;break;case 31:g=T;break;case 32:E=T;break;case 33:v=T;break}}s.set(g,E,v,_),s.normalize(),d[0]=s.w*128+128,d[1]=s.x*128+128,d[2]=s.y*128+128,d[3]=s.z*128+128,r.value+=e.rowVertexLength}static*ConvertPLYToSplat(e,t=!1){const i=bi.ParseHeader(e);if(!i)return e;const r={value:0},s=bi._GetCompressedChunks(i,r);for(let a=0;a<i.vertexCount;a++)bi._GetSplat(i,a,s,r),a%bi._PlyConversionBatchSize===0&&t&&(yield);return i.buffer}static async ConvertPLYToSplatAsync(e){return ad(bi.ConvertPLYToSplat(e,!0),nd())}loadDataAsync(e){return this.updateDataAsync(e)}loadFileAsync(e){return J.LoadFileAsync(e,!0).then(async t=>{bi.ConvertPLYToSplatAsync(t).then(i=>{this.updateDataAsync(i)})})}dispose(e){var t,i,r,s,a;(t=this._covariancesATexture)==null||t.dispose(),(i=this._covariancesBTexture)==null||i.dispose(),(r=this._centersTexture)==null||r.dispose(),(s=this._colorsTexture)==null||s.dispose(),this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,(a=this._worker)==null||a.terminate(),this._worker=null,super.dispose(e,!0)}_copyTextures(e){var t,i,r,s;this._covariancesATexture=(t=e.covariancesATexture)==null?void 0:t.clone(),this._covariancesBTexture=(i=e.covariancesBTexture)==null?void 0:i.clone(),this._centersTexture=(r=e.centersTexture)==null?void 0:r.clone(),this._colorsTexture=(s=e.colorsTexture)==null?void 0:s.clone()}clone(e=""){const t=new bi(e,void 0,this.getScene());t._copySource(this),t.makeGeometryUnique(),t._vertexCount=this._vertexCount,t._copyTextures(this),t._modelViewMatrix=O.Identity(),t._splatPositions=this._splatPositions,t._readyToDisplay=!1,t._instanciateWorker();const i=this.getBoundingInfo();return t.getBoundingInfo().reConstruct(i.minimum,i.maximum,this.getWorldMatrix()),t.forcedInstanceCount=t._vertexCount,t.setEnabled(!0),t}_makeSplat(e,t,i,r,s,a,o,l,c){const u=B.Matrix[0],h=B.Matrix[1],f=B.Quaternion[0],d=this._useRGBACovariants?4:2,p=i[8*e+0],_=-i[8*e+1],g=i[8*e+2];this._splatPositions[4*e+0]=p,this._splatPositions[4*e+1]=_,this._splatPositions[4*e+2]=g,l.minimizeInPlaceFromFloats(p,_,g),c.maximizeInPlaceFromFloats(p,_,g),f.set((r[32*e+28+1]-128)/128,(r[32*e+28+2]-128)/128,(r[32*e+28+3]-128)/128,-(r[32*e+28+0]-128)/128),f.toRotationMatrix(u),O.ScalingToRef(i[8*e+3+0]*2,i[8*e+3+1]*2,i[8*e+3+2]*2,h);const E=u.multiplyToRef(h,B.Matrix[0]).m,v=this._tmpCovariances;v[0]=E[0]*E[0]+E[1]*E[1]+E[2]*E[2],v[1]=E[0]*E[4]+E[1]*E[5]+E[2]*E[6],v[2]=E[0]*E[8]+E[1]*E[9]+E[2]*E[10],v[3]=E[4]*E[4]+E[5]*E[5]+E[6]*E[6],v[4]=E[4]*E[8]+E[5]*E[9]+E[6]*E[10],v[5]=E[8]*E[8]+E[9]*E[9]+E[10]*E[10];let x=-1e4;for(let T=0;T<6;T++)x=Math.max(x,Math.abs(v[T]));this._splatPositions[4*e+3]=x;const A=x;s[t*4+0]=Ur(v[0]/A),s[t*4+1]=Ur(v[1]/A),s[t*4+2]=Ur(v[2]/A),s[t*4+3]=Ur(v[3]/A),a[t*d+0]=Ur(v[4]/A),a[t*d+1]=Ur(v[5]/A),o[t*4+0]=r[32*e+24+0],o[t*4+1]=r[32*e+24+1],o[t*4+2]=r[32*e+24+2],o[t*4+3]=r[32*e+24+3]}_updateTextures(e,t,i){const r=this._getTextureSize(this._vertexCount),s=(l,c,u,h)=>new ki(l,c,u,h,this._scene,!1,!1,2,1),a=(l,c,u,h)=>new ki(l,c,u,h,this._scene,!1,!1,2,0),o=(l,c,u,h)=>new ki(l,c,u,h,this._scene,!1,!1,2,2);if(this._keepInRam&&(this._covariancesA=e,this._covariancesB=t,this._colors=i),this._covariancesATexture){this._delayedTextureUpdate={covA:e,covB:t,colors:i,centers:this._splatPositions};const l=Float32Array.from(this._splatPositions),c=this._vertexCount;this._worker.postMessage({positions:l,vertexCount:c},[l.buffer]),this._postToWorker(!0)}else this._covariancesATexture=o(e,r.x,r.y,5),this._covariancesBTexture=o(t,r.x,r.y,this._useRGBACovariants?5:7),this._centersTexture=s(this._splatPositions,r.x,r.y,5),this._colorsTexture=a(i,r.x,r.y,5),this._instanciateWorker()}*_updateData(e,t){this._covariancesATexture||(this._readyToDisplay=!1);const i=new Uint8Array(e),r=new Float32Array(i.buffer),s=i.length/bi._RowOutputLength;s!=this._vertexCount&&this._updateSplatIndexBuffer(s),this._vertexCount=s;const a=this._getTextureSize(s),o=a.x*a.y,l=bi.ProgressiveUpdateAmount??a.y,c=a.x*l;this._splatPositions=new Float32Array(4*o);const u=new Uint16Array(o*4),h=new Uint16Array((this._useRGBACovariants?4:2)*o),f=new Uint8Array(o*4),d=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),p=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(bi.ProgressiveUpdateAmount){this._updateTextures(u,h,f),this.setEnabled(!0);const _=Math.ceil(a.y/l);for(let v=0;v<_;v++){const x=v*l,A=x*a.x;for(let T=0;T<c;T++)this._makeSplat(A+T,A+T,r,i,u,h,f,d,p);this._updateSubTextures(this._splatPositions,u,h,f,x,Math.min(l,a.y-x)),this.getBoundingInfo().reConstruct(d,p,this.getWorldMatrix()),t&&(yield)}const g=Float32Array.from(this._splatPositions),E=this._vertexCount;this._worker.postMessage({positions:g,vertexCount:E},[g.buffer]),this._sortIsDirty=!0}else{for(let _=0;_<s;_++)this._makeSplat(_,_,r,i,u,h,f,d,p),t&&_%bi._SplatBatchSize===0&&(yield);this._updateTextures(u,h,f),this.getBoundingInfo().reConstruct(d,p,this.getWorldMatrix()),this.setEnabled(!0)}this._postToWorker(!0)}async updateDataAsync(e){return ad(this._updateData(e,!0),nd())}updateData(e){rh(this._updateData(e,!1))}_updateSplatIndexBuffer(e){(!this._splatIndex||e>this._splatIndex.length)&&(this._splatIndex=new Float32Array(e),this.thinInstanceSetBuffer("splatIndex",this._splatIndex,1,!1)),this.forcedInstanceCount=e}_updateSubTextures(e,t,i,r,s,a){const o=(v,x,A,T,C)=>{this.getEngine().updateTextureData(v.getInternalTexture(),x,0,T,A,C,0,0,!1)},l=(v,x,A,T,C)=>{this.getEngine().updateTextureData(v.getInternalTexture(),x,0,T,A,C,0,0,!1)},c=(v,x,A,T,C)=>{this.getEngine().updateTextureData(v.getInternalTexture(),x,0,T,A,C,0,0,!1)},u=this._getTextureSize(this._vertexCount),h=this._useRGBACovariants?4:2,f=s*u.x,d=a*u.x,p=new Uint16Array(t.buffer,f*4*Uint16Array.BYTES_PER_ELEMENT,d*4),_=new Uint16Array(i.buffer,f*h*Uint16Array.BYTES_PER_ELEMENT,d*h),g=new Uint8Array(r.buffer,f*4,d*4),E=new Float32Array(e.buffer,f*4*Float32Array.BYTES_PER_ELEMENT,d*4);c(this._covariancesATexture,p,u.x,s,a),c(this._covariancesBTexture,_,u.x,s,a),o(this._centersTexture,E,u.x,s,a),l(this._colorsTexture,g,u.x,s,a)}_instanciateWorker(){var i;if(!this._vertexCount)return;this._updateSplatIndexBuffer(this._vertexCount),(i=this._worker)==null||i.terminate(),this._worker=new Worker(URL.createObjectURL(new Blob(["(",bi._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._depthMix=new BigInt64Array(this._vertexCount);const e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._worker.onmessage=r=>{this._depthMix=r.data.depthMix;const s=new Uint32Array(r.data.depthMix.buffer);if(this._splatIndex)for(let a=0;a<this._vertexCount;a++)this._splatIndex[a]=s[2*a];if(this._delayedTextureUpdate){const a=this._getTextureSize(t);this._updateSubTextures(this._delayedTextureUpdate.centers,this._delayedTextureUpdate.covA,this._delayedTextureUpdate.covB,this._delayedTextureUpdate.colors,0,a.y),this._delayedTextureUpdate=null}this.thinInstanceBufferUpdated("splatIndex"),this._canPostToWorker=!0,this._readyToDisplay=!0,this._sortIsDirty&&(this._postToWorker(!0),this._sortIsDirty=!1)}}_getTextureSize(e){const t=this._scene.getEngine(),i=t.getCaps().maxTextureSize;let r=1;if(t.version===1&&!t.isWebGPU)for(;i*r<e;)r*=2;else r=Math.ceil(e/i);return r>i&&(w.Error("GaussianSplatting texture size: ("+i+", "+r+"), maxTextureSize: "+i),r=i),new se(i,r)}}bi._RowOutputLength=3*4+3*4+4+4;bi._SH_C0=.28209479177387814;bi._SplatBatchSize=327680;bi._PlyConversionBatchSize=32768;bi.ProgressiveUpdateAmount=0;bi._CreateWorker=function(n){let e=0,t,i,r,s;n.onmessage=a=>{if(a.data.positions)t=a.data.positions,e=a.data.vertexCount;else{const o=a.data.view;if(!t||!o)throw new Error("positions or view is not defined!");i=a.data.depthMix,r=new Uint32Array(i.buffer),s=new Float32Array(i.buffer);for(let c=0;c<e;c++)r[2*c]=c;let l=-1;a.data.useRightHandedSystem&&(l=1);for(let c=0;c<e;c++)s[2*c+1]=1e4+(o[2]*t[4*c+0]+o[6]*t[4*c+1]+o[10]*t[4*c+2])*l;i.sort(),n.postMessage({depthMix:i},[i.buffer])}}};const JA="colorPixelShader",eI=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#include<fogFragment>(color,gl_FragColor)
#define CUSTOM_FRAGMENT_MAIN_END
}`;V.ShadersStore[JA]=eI;const r3={name:JA,shader:eI},s3=Object.freeze(Object.defineProperty({__proto__:null,colorPixelShader:r3},Symbol.toStringTag,{value:"Module"})),n3="vertexColorMixing",a3=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;V.IncludesShadersStore[n3]=a3;const tI="colorVertexShader",iI=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform mat4 view;
#endif
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStore[tI]=iI;const o3={name:tI,shader:iI},l3=Object.freeze(Object.defineProperty({__proto__:null,colorVertexShader:o3},Symbol.toStringTag,{value:"Module"})),rI="colorPixelShader",sI=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vColor: vec4f;
#else
uniform color: vec4f;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
fragmentOutputs.color=input.vColor;
#else
fragmentOutputs.color=uniforms.color;
#endif
#include<fogFragment>(color,fragmentOutputs.color)
#define CUSTOM_FRAGMENT_MAIN_END
}`;V.ShadersStoreWGSL[rI]=sI;const c3={name:rI,shader:sI},u3=Object.freeze(Object.defineProperty({__proto__:null,colorPixelShaderWGSL:c3},Symbol.toStringTag,{value:"Module"})),h3="vertexColorMixing",f3=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vertexOutputs.vColor=vec4f(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vertexOutputs.vColor*=vertexInputs.color;
#else
vertexOutputs.vColor=vec4f(vertexOutputs.vColor.rgb*vertexInputs.color.rgb,vertexOutputs.vColor.a);
#endif
#endif
#ifdef INSTANCESCOLOR
vertexOutputs.vColor*=vertexInputs.instanceColor;
#endif
#endif
`;V.IncludesShadersStoreWGSL[h3]=f3;const nI="colorVertexShader",aI=`attribute position: vec3f;
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform view: mat4x4f;
#endif
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStoreWGSL[nI]=aI;const d3={name:nI,shader:aI},p3=Object.freeze(Object.defineProperty({__proto__:null,colorVertexShaderWGSL:d3},Symbol.toStringTag,{value:"Module"})),_3="meshUVSpaceRendererVertexShader",m3=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
void main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
vec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}`;V.ShadersStore[_3]=m3;const g3="meshUVSpaceRendererPixelShader",E3=`precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}
gl_FragColor=texture2D(textureSampler,vDecalTC);}
`;V.ShadersStore[g3]=E3;const v3="meshUVSpaceRendererMaskerVertexShader",S3="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";V.ShadersStore[v3]=S3;const T3="meshUVSpaceRendererMaskerPixelShader",x3=`varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}
`;V.ShadersStore[T3]=x3;const C3="meshUVSpaceRendererFinaliserPixelShader",A3=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}
`;V.ShadersStore[C3]=A3;const I3="meshUVSpaceRendererFinaliserVertexShader",y3=`precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}
`;V.ShadersStore[I3]=y3;const b3="meshUVSpaceRendererVertexShader",R3=`attribute position: vec3f;attribute normal: vec3f;attribute uv: vec2f;uniform projMatrix: mat4x4f;varying vDecalTC: vec2f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);var vNormalW: vec3f;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
var normalView: vec3f=normalize((uniforms.projMatrix* vec4f(vNormalW,0.0)).xyz);var decalTC: vec3f=(uniforms.projMatrix*worldPos).xyz;vertexOutputs.vDecalTC=decalTC.xy;vertexOutputs.position=vec4f(input.uv*2.0-1.0,select(decalTC.z,2.,normalView.z>0.0),1.0);}`;V.ShadersStoreWGSL[b3]=R3;const P3="meshUVSpaceRendererPixelShader",M3=`varying vDecalTC: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {if (input.vDecalTC.x<0. || input.vDecalTC.x>1. || input.vDecalTC.y<0. || input.vDecalTC.y>1.) {discard;}
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vDecalTC);}
`;V.ShadersStoreWGSL[P3]=M3;const D3="meshUVSpaceRendererMaskerVertexShader",O3=`attribute uv: vec2f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position= vec4f( vec2f(input.uv.x,input.uv.y)*2.0-1.0,0.,1.0);vertexOutputs.vUV=input.uv;}`;V.ShadersStoreWGSL[D3]=O3;const N3="meshUVSpaceRendererMaskerPixelShader",L3=`varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color= vec4f(1.0,1.0,1.0,1.0);}
`;V.ShadersStoreWGSL[N3]=L3;const F3="meshUVSpaceRendererFinaliserPixelShader",w3=`#define DISABLE_UNIFORMITY_ANALYSIS
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var maskTextureSamplerSampler: sampler;var maskTextureSampler: texture_2d<f32>;uniform textureSize: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var mask: vec4f=textureSample(maskTextureSampler,maskTextureSamplerSampler,input.vUV).rgba;if (mask.r>0.5) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);} else {var texelSize: vec2f=4.0/uniforms.textureSize;var uv_p01: vec2f=input.vUV+ vec2f(-1.0,0.0)*texelSize;var uv_p21: vec2f=input.vUV+ vec2f(1.0,0.0)*texelSize;var uv_p10: vec2f=input.vUV+ vec2f(0.0,-1.0)*texelSize;var uv_p12: vec2f=input.vUV+ vec2f(0.0,1.0)*texelSize;var mask_p01: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p01).r;var mask_p21: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p21).r;var mask_p10: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p10).r;var mask_p12: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p12).r;var col: vec4f= vec4f(0.0,0.0,0.0,0.0);var total_weight: f32=0.0;if (mask_p01>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {fragmentOutputs.color=col/total_weight;} else {fragmentOutputs.color=col;}}}
`;V.ShadersStoreWGSL[F3]=w3;const B3="meshUVSpaceRendererFinaliserVertexShader",V3=`attribute position: vec3f;attribute uv: vec2f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection* vec4f(input.position,1.0);vertexOutputs.positionvUV=input.uv;}
`;V.ShadersStoreWGSL[B3]=V3;class Ph{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new Q,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==tt.POINTERWHEEL)return;const i=t.event,r=i.deltaMode===ll.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,tt.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}I([M()],Ph.prototype,"wheelPrecisionX",void 0);I([M()],Ph.prototype,"wheelPrecisionY",void 0);I([M()],Ph.prototype,"wheelPrecisionZ",void 0);class p_{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let r=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{var h,f;const l=o.event,c=l.pointerType==="touch";if(o.type!==tt.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;const u=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){const d=l.movementX,p=l.movementY;this.onTouch(null,d,p),this._pointA=null,this._pointB=null}else{if(o.type!==tt.POINTERDOWN&&o.type!==tt.POINTERDOUBLETAP&&c&&((h=this._pointA)==null?void 0:h.pointerId)!==l.pointerId&&((f=this._pointB)==null?void 0:f.pointerId)!==l.pointerId)return;if(o.type===tt.POINTERDOWN&&(this._currentActiveButton===-1||c)){try{u==null||u.setPointerCapture(l.pointerId)}catch{}if(this._pointA===null)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else if(this._pointB===null)this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else return;this._currentActiveButton===-1&&!c&&(this._currentActiveButton=l.button),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}else if(o.type===tt.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(o.type===tt.POINTERUP&&(this._currentActiveButton===l.button||c)){try{u==null||u.releasePointerCapture(l.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||s)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,s,null),r=0,s=null),this._currentActiveButton=-1,this.onButtonUp(l),e||l.preventDefault()}else if(o.type===tt.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){const d=l.clientX-this._pointA.x,p=l.clientY-this._pointA.y;this._pointA.x=l.clientX,this._pointA.y=l.clientY,this.onTouch(this._pointA,d,p)}else if(this._pointA&&this._pointB){const d=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;d.x=l.clientX,d.y=l.clientY;const p=this._pointA.x-this._pointB.x,_=this._pointA.y-this._pointB.y,g=p*p+_*_,E={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,r,g,s,E),s=E,r=g}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,tt.POINTERDOWN|tt.POINTERUP|tt.POINTERMOVE|tt.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,s=null,this.onLostFocus()},this._contextMenuBind=o=>this.onContextMenu(o),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const a=this.camera.getScene().getEngine().getHostWindow();a&&J.RegisterTopRootEvents(a,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&J.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,s,a){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}I([M()],p_.prototype,"buttons",void 0);var Cr={};class Mh{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){w.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=He.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const r=this.attached[i],s=Ke.Serialize(r);t[r.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const r=Cr[i];if(r){const s=t[i],a=Ke.Parse(()=>new r,s,null);this.add(a)}}}else for(const i in this.attached){const r=Cr[this.attached[i].getClassName()];if(r){const s=Ke.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(s)}}}}class gr{get isConnected(){return this._isConnected}constructor(e,t,i,r=0,s=1,a=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=gr.GAMEPAD,this._leftStickAxisX=r,this._leftStickAxisY=s,this._rightStickAxisX=a,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)&&this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)&&this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}gr.GAMEPAD=0;gr.GENERIC=1;gr.XBOX=2;gr.POSE_ENABLED=3;gr.DUALSHOCK=4;class U3 extends gr{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new Q,this.onButtonUpObservable=new Q,this.type=gr.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Dh{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==gr.POSE_ENABLED&&(!this.gamepad||t.type===gr.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(gr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){const r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){const r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}const i=this.gamepad.leftStick;if(i&&i.y!=0){const r=i.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}I([M()],Dh.prototype,"gamepadRotationSensibility",void 0);I([M()],Dh.prototype,"gamepadMoveSensibility",void 0);Cr.ArcRotateCameraGamepadInput=Dh;class Hs{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===gn.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}I([M()],Hs.prototype,"keysUp",void 0);I([M()],Hs.prototype,"keysDown",void 0);I([M()],Hs.prototype,"keysLeft",void 0);I([M()],Hs.prototype,"keysRight",void 0);I([M()],Hs.prototype,"keysReset",void 0);I([M()],Hs.prototype,"panningSensibility",void 0);I([M()],Hs.prototype,"zoomingSensibility",void 0);I([M()],Hs.prototype,"useAltToZoom",void 0);I([M()],Hs.prototype,"angularSpeed",void 0);Cr.ArcRotateCameraKeyboardMoveInput=Hs;const k3=40;class Mc{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new m(0,0,0),this._globalOffset=new m(0,0,0),this._inertialPanning=m.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==tt.POINTERWHEEL)return;const i=t.event;let r=0;const s=i.deltaMode===ll.DOM_DELTA_LINE?k3:1,a=-(i.deltaY*s);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(a,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(a,this.camera.radius),r>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&Math.abs(l)>.001;c++)o-=l,l*=this.camera.inertia;o=vt(o,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(a,o)}}else r=a/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,tt.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Vr.FromPositionAndNormal(e.target,t)}_getPosition(){const e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,O.Identity(),e,!1);(e.targetScreenOffset.x!==0||e.targetScreenOffset.y!==0)&&(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=m.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(r))}_zoomToMouse(e){const t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){const l=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){const l=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}const s=e/i/t.radius,a=this._getPosition(),o=B.Vector3[6];a.subtractToRef(t.target,o),o.scaleInPlace(s),o.scaleInPlace(i),this._inertialPanning.addInPlace(o),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<pt&&(e.x=0),Math.abs(e.y)<pt&&(e.y=0),Math.abs(e.z)<pt&&(e.z=0)}}I([M()],Mc.prototype,"wheelPrecision",void 0);I([M()],Mc.prototype,"zoomToMouseLocation",void 0);I([M()],Mc.prototype,"wheelDeltaPercentage",void 0);Cr.ArcRotateCameraMouseWheelInput=Mc;class rs extends p_{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||rs.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,s,a){i===0&&s===null||r===0&&a===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(s,a)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(s,a)):this.multiTouchPanning?this._computeMultiTouchPanning(s,a):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}rs.MinimumRadiusForPinch=.001;I([M()],rs.prototype,"buttons",void 0);I([M()],rs.prototype,"angularSensibilityX",void 0);I([M()],rs.prototype,"angularSensibilityY",void 0);I([M()],rs.prototype,"pinchPrecision",void 0);I([M()],rs.prototype,"pinchDeltaPercentage",void 0);I([M()],rs.prototype,"useNaturalPinchZoom",void 0);I([M()],rs.prototype,"pinchZoom",void 0);I([M()],rs.prototype,"panningSensibility",void 0);I([M()],rs.prototype,"multiTouchPanning",void 0);I([M()],rs.prototype,"multiTouchPanAndZoom",void 0);Cr.ArcRotateCameraPointersInput=rs;class __ extends Mh{constructor(e){super(e)}addMouseWheel(){return this.add(new Mc),this}addPointers(){return this.add(new rs),this}addKeyboard(){return this.add(new Hs),this}}__.prototype.addVRDeviceOrientation=function(){return this.add(new oI),this};class oI{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t.addEventListener("deviceorientation",this._deviceOrientationHandler):J.Warn("Permission not granted.")}).catch(i=>{J.Error(i)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){e.alpha!==null&&(this._alpha=(+e.alpha|0)*this.alphaCorrection),e.gamma!==null&&(this._gamma=(+e.gamma|0)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}Cr.ArcRotateCameraVRDeviceOrientationInput=oI;class Pa{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(t.type===gn.KEYDOWN)(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysBackward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysLeft.indexOf(i)!==-1&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}I([M()],Pa.prototype,"keysForward",void 0);I([M()],Pa.prototype,"keysBackward",void 0);I([M()],Pa.prototype,"keysUp",void 0);I([M()],Pa.prototype,"keysDown",void 0);I([M()],Pa.prototype,"keysRight",void 0);I([M()],Pa.prototype,"keysLeft",void 0);Cr.FlyCameraKeyboardInput=Pa;class Oh{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(t=>{this._pointerInput(t)},tt.POINTERDOWN|tt.POINTERUP|tt.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,r=this.camera.getEngine();if(!this.touchEnabled&&t.pointerType==="touch"||e.type!==tt.POINTERMOVE&&this.buttons.indexOf(t.button)===-1)return;const s=t.target;if(e.type===tt.POINTERDOWN){try{s==null||s.setPointerCapture(t.pointerId)}catch{}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||t.preventDefault(),r.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===tt.POINTERUP){try{s==null||s.releasePointerCapture(t.pointerId)}catch{}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===tt.POINTERMOVE){if(!this._previousPosition){r.isPointerLock&&this._onMouseMove(e.event);return}const a=t.clientX-this._previousPosition.x,o=t.clientY-this._previousPosition.y;this._rotateCamera(a,o),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;const r=e.movementX,s=e.movementY;this._rotateCamera(r,s),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera,r=i._calculateHandednessMultiplier();e*=r;const s=e/this.angularSensibility,a=t/this.angularSensibility,o=ce.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let l;if(this.buttonsPitch.some(c=>c===this.activeButton)&&(l=ce.RotationAxis(ys.X,a),o.multiplyInPlace(l)),this.buttonsYaw.some(c=>c===this.activeButton)){l=ce.RotationAxis(ys.Y,s),o.multiplyInPlace(l);const c=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-c<i.rotation.z&&i.rotation.z<c){const u=i.bankedTurnMultiplier*-s;l=ce.RotationAxis(ys.Z,u),o.multiplyInPlace(l)}}this.buttonsRoll.some(c=>c===this.activeButton)&&(l=ce.RotationAxis(ys.Z,-s),i._trackRoll-=s,o.multiplyInPlace(l)),o.toEulerAnglesToRef(i.rotation)}}I([M()],Oh.prototype,"buttons",void 0);I([M()],Oh.prototype,"angularSensibility",void 0);Cr.FlyCameraMouseInput=Oh;class Er{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===gn.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach(e=>{this.keysHeightOffsetIncr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:this.keysHeightOffsetDecr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:this.keysRotationOffsetIncr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRotationOffsetDecr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRadiusIncr.indexOf(e)!==-1&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:this.keysRadiusDecr.indexOf(e)!==-1&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)})}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}I([M()],Er.prototype,"keysHeightOffsetIncr",void 0);I([M()],Er.prototype,"keysHeightOffsetDecr",void 0);I([M()],Er.prototype,"keysHeightOffsetModifierAlt",void 0);I([M()],Er.prototype,"keysHeightOffsetModifierCtrl",void 0);I([M()],Er.prototype,"keysHeightOffsetModifierShift",void 0);I([M()],Er.prototype,"keysRotationOffsetIncr",void 0);I([M()],Er.prototype,"keysRotationOffsetDecr",void 0);I([M()],Er.prototype,"keysRotationOffsetModifierAlt",void 0);I([M()],Er.prototype,"keysRotationOffsetModifierCtrl",void 0);I([M()],Er.prototype,"keysRotationOffsetModifierShift",void 0);I([M()],Er.prototype,"keysRadiusIncr",void 0);I([M()],Er.prototype,"keysRadiusDecr",void 0);I([M()],Er.prototype,"keysRadiusModifierAlt",void 0);I([M()],Er.prototype,"keysRadiusModifierCtrl",void 0);I([M()],Er.prototype,"keysRadiusModifierShift",void 0);I([M()],Er.prototype,"heightSensibility",void 0);I([M()],Er.prototype,"rotationSensibility",void 0);I([M()],Er.prototype,"radiusSensibility",void 0);Cr.FollowCameraKeyboardMoveInput=Er;class ho{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==tt.POINTERWHEEL)return;const i=t.event;let r=0;const s=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(+this.axisControlRadius+ +this.axisControlHeight+ +this.axisControlRotation&&w.Warn("wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?r=s*.01*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?r=s*.01*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(r=s*.01*this.wheelDeltaPercentage*this.camera.rotationOffset)):r=s*this.wheelPrecision,r&&(this.axisControlRadius?this.camera.radius+=r:this.axisControlHeight?this.camera.heightOffset-=r:this.axisControlRotation&&(this.camera.rotationOffset-=r)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,tt.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}I([M()],ho.prototype,"axisControlRadius",void 0);I([M()],ho.prototype,"axisControlHeight",void 0);I([M()],ho.prototype,"axisControlRotation",void 0);I([M()],ho.prototype,"wheelPrecision",void 0);I([M()],ho.prototype,"wheelDeltaPercentage",void 0);Cr.FollowCameraMouseWheelInput=ho;class ss extends p_{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,r,s,a){if(i===0&&s===null||r===0&&a===null)return;let o=(r-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(o*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=o*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=o*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=o*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=o),this.axisPinchControlHeight&&(this.camera.heightOffset+=o),this.axisPinchControlRadius&&(this.camera.radius-=o))}_warning(){if(!this.warningEnable||this._warningCounter++%100!==0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";+this.axisXControlRotation+ +this.axisXControlHeight+ +this.axisXControlRadius<=1&&w.Warn(e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),+this.axisYControlRotation+ +this.axisYControlHeight+ +this.axisYControlRadius<=1&&w.Warn(e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),+this.axisPinchControlRotation+ +this.axisPinchControlHeight+ +this.axisPinchControlRadius<=1&&w.Warn(e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}I([M()],ss.prototype,"angularSensibilityX",void 0);I([M()],ss.prototype,"angularSensibilityY",void 0);I([M()],ss.prototype,"pinchPrecision",void 0);I([M()],ss.prototype,"pinchDeltaPercentage",void 0);I([M()],ss.prototype,"axisXControlRadius",void 0);I([M()],ss.prototype,"axisXControlHeight",void 0);I([M()],ss.prototype,"axisXControlRotation",void 0);I([M()],ss.prototype,"axisYControlRadius",void 0);I([M()],ss.prototype,"axisYControlHeight",void 0);I([M()],ss.prototype,"axisYControlRotation",void 0);I([M()],ss.prototype,"axisPinchControlRadius",void 0);I([M()],ss.prototype,"axisPinchControlHeight",void 0);I([M()],ss.prototype,"axisPinchControlRotation",void 0);Cr.FollowCameraPointersInput=ss;class Rs{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===gn.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){const r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}I([M()],Rs.prototype,"keysUp",void 0);I([M()],Rs.prototype,"keysUpward",void 0);I([M()],Rs.prototype,"keysDown",void 0);I([M()],Rs.prototype,"keysDownward",void 0);I([M()],Rs.prototype,"keysLeft",void 0);I([M()],Rs.prototype,"keysRight",void 0);I([M()],Rs.prototype,"rotationSpeed",void 0);I([M()],Rs.prototype,"keysRotateLeft",void 0);I([M()],Rs.prototype,"keysRotateRight",void 0);I([M()],Rs.prototype,"keysRotateUp",void 0);I([M()],Rs.prototype,"keysRotateDown",void 0);Cr.FreeCameraKeyboardMoveInput=Rs;class Nh{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new Q,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{const s=r.event,a=s.pointerType==="touch";if(!this.touchEnabled&&a||r.type!==tt.POINTERMOVE&&this.buttons.indexOf(s.button)===-1)return;const o=s.target;if(r.type===tt.POINTERDOWN){if(a&&this._activePointerId!==-1||!a&&this._currentActiveButton!==-1)return;this._activePointerId=s.pointerId;try{o==null||o.setPointerCapture(s.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===tt.POINTERUP){if(a&&this._activePointerId!==s.pointerId||!a&&this._currentActiveButton!==s.button)return;try{o==null||o.releasePointerCapture(s.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(r.type===tt.POINTERMOVE&&(this._activePointerId===s.pointerId||!a)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){const l=this.camera._calculateHandednessMultiplier(),c=(s.clientX-this._previousPosition.x)*l,u=s.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=u/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:u}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;const s=this.camera._calculateHandednessMultiplier(),a=r.movementX*s;this.camera.cameraRotation.y+=a/this.angularSensibility;const o=r.movementY;this.camera.cameraRotation.x+=o/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,tt.POINTERDOWN|tt.POINTERUP|tt.POINTERMOVE),i&&(this._contextMenuBind=r=>this.onContextMenu(r),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}I([M()],Nh.prototype,"buttons",void 0);I([M()],Nh.prototype,"angularSensibility",void 0);Cr.FreeCameraMouseInput=Nh;var ri;(function(n){n[n.MoveRelative=0]="MoveRelative",n[n.RotateRelative=1]="RotateRelative",n[n.MoveScene=2]="MoveScene"})(ri||(ri={}));class Xs extends Ph{constructor(){super(...arguments),this._moveRelative=m.Zero(),this._rotateRelative=m.Zero(),this._moveScene=m.Zero(),this._wheelXAction=ri.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=ri.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==ri.MoveRelative||(this._wheelXAction=ri.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==ri.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==ri.MoveRelative||(this._wheelYAction=ri.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==ri.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==ri.MoveRelative||(this._wheelZAction=ri.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==ri.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==ri.RotateRelative||(this._wheelXAction=ri.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==ri.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==ri.RotateRelative||(this._wheelYAction=ri.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==ri.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==ri.RotateRelative||(this._wheelZAction=ri.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==ri.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==ri.MoveScene||(this._wheelXAction=ri.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==ri.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==ri.MoveScene||(this._wheelYAction=ri.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==ri.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==ri.MoveScene||(this._wheelZAction=ri.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==ri.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=O.Zero();this.camera.getViewMatrix().invertToRef(e);const t=m.Zero();m.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case ri.MoveRelative:r=this._moveRelative;break;case ri.RotateRelative:r=this._rotateRelative;break;case ri.MoveScene:r=this._moveScene;break}switch(i){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e);break}}}I([M()],Xs.prototype,"wheelXMoveRelative",null);I([M()],Xs.prototype,"wheelYMoveRelative",null);I([M()],Xs.prototype,"wheelZMoveRelative",null);I([M()],Xs.prototype,"wheelXRotateRelative",null);I([M()],Xs.prototype,"wheelYRotateRelative",null);I([M()],Xs.prototype,"wheelZRotateRelative",null);I([M()],Xs.prototype,"wheelXMoveScene",null);I([M()],Xs.prototype,"wheelYMoveScene",null);I([M()],Xs.prototype,"wheelZMoveScene",null);Cr.FreeCameraMouseWheelInput=Xs;class Lh{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=J.IsSafari()}attachControl(e){e=J.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const r=i.event,s=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&s)){if(i.type===tt.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===tt.POINTERUP){e||r.preventDefault();const a=this._pointerPressed.indexOf(r.pointerId);if(a===-1||(this._pointerPressed.splice(a,1),a!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===tt.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,tt.POINTERDOWN|tt.POINTERUP|tt.POINTERMOVE),this._onLostFocus){const r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const r=e._computeLocalCameraSpeed(),s=new m(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);O.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(m.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}I([M()],Lh.prototype,"touchAngularSensibility",void 0);I([M()],Lh.prototype,"touchMoveSensibility",void 0);Cr.FreeCameraTouchInput=Lh;class Fh extends Mh{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Rs),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Nh(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new Xs,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Lh),this}clear(){super.clear(),this._mouseInput=null}}Fh.prototype.addDeviceOrientation=function(n){return this._deviceOrientationInput||(this._deviceOrientationInput=new lI,n&&(this._deviceOrientationInput.smoothFactor=n),this.add(this._deviceOrientationInput)),this};class lI{static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let r=!1;const s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",s),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(a=>{a=="granted"?window.addEventListener("deviceorientation",s):J.Warn("Permission not granted.")}).catch(a=>{J.Error(a)}):window.addEventListener("deviceorientation",s)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new ce,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new Q,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-J.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?J.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?J.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?J.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new ce(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new ce),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():J.Warn("Permission not granted.")}).catch(i=>{J.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(ce.RotationYawPitchRollToRef(J.ToRadians(this._alpha),J.ToRadians(this._beta),-J.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}Cr.FreeCameraDeviceOrientationInput=lI;class wh{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=O.Identity(),this._deltaTransform=m.Zero(),this._vector3=m.Zero(),this._vector2=se.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==gr.POSE_ENABLED&&(!this.gamepad||t.type===gr.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(gr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):O.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),m.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}I([M()],wh.prototype,"gamepadAngularSensibility",void 0);I([M()],wh.prototype,"gamepadMoveSensibility",void 0);Cr.FreeCameraGamepadInput=wh;var $E;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})($E||($E={}));class je{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;const i={...je._GetDefaultOptions(),...t};if(e?this._leftJoystick=!0:this._leftJoystick=!1,je._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new cd,this.deltaPosition=m.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{je._VJCanvasWidth=window.innerWidth,je._VJCanvasHeight=window.innerHeight,je.Canvas&&(je.Canvas.width=je._VJCanvasWidth,je.Canvas.height=je._VJCanvasHeight),je._HalfWidth=je._VJCanvasWidth/2},!je.Canvas){window.addEventListener("resize",this._onResize,!1),je.Canvas=document.createElement("canvas"),je._VJCanvasWidth=window.innerWidth,je._VJCanvasHeight=window.innerHeight,je.Canvas.width=window.innerWidth,je.Canvas.height=window.innerHeight,je.Canvas.style.width="100%",je.Canvas.style.height="100%",je.Canvas.style.position="absolute",je.Canvas.style.backgroundColor="transparent",je.Canvas.style.top="0px",je.Canvas.style.left="0px",je.Canvas.style.zIndex="5",je.Canvas.style.touchAction="none",je.Canvas.setAttribute("touch-action","none");const r=je.Canvas.getContext("2d");if(!r)throw new Error("Unable to create canvas for virtual joystick");je._VJCanvasContext=r,je._VJCanvasContext.strokeStyle="#ffffff",je._VJCanvasContext.lineWidth=2,document.body.appendChild(je.Canvas)}je._HalfWidth=je.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&je._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new se(0,0),this._joystickPreviousPointerPos=new se(0,0),this._joystickPointerStartPos=new se(0,0),this._deltaJoystickVector=new se(0,0),this._onPointerDownHandlerRef=r=>{this._onPointerDown(r)},this._onPointerMoveHandlerRef=r=>{this._onPointerMove(r)},this._onPointerUpHandlerRef=r=>{this._onPointerUp(r)},je.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),je.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),je.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),je.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),je.Canvas.addEventListener("contextmenu",r=>{r.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),this._leftJoystick===!0?t=e.clientX<je._HalfWidth:t=e.clientX>je._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):je._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const a=new se(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),o=a.length();o>this.containerSize&&a.scaleInPlace(this.containerSize/o),this._joystickPointerPos.x=this._joystickPointerStartPos.x+a.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+a.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<je._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(je._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(je._HalfWidth,this._joystickPointerPos.x));const i=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,i));break}const s=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,s));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,s));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,s));break}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&je._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(je._AlwaysVisibleSticks++,this._alwaysVisible=!0):(je._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new se(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=0;break}}setAxisForUpDown(e){switch(e){case 0:case 1:case 2:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=1;break}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;je._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),je._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?je._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,this.containerSize*2,this.containerSize*2):(je._VJCanvasContext.beginPath(),je._VJCanvasContext.strokeStyle=this._joystickColor,je._VJCanvasContext.lineWidth=2,je._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,Math.PI*2,!0),je._VJCanvasContext.stroke(),je._VJCanvasContext.closePath(),je._VJCanvasContext.beginPath(),je._VJCanvasContext.lineWidth=6,je._VJCanvasContext.strokeStyle=this._joystickColor,je._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,Math.PI*2,!0),je._VJCanvasContext.stroke(),je._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?je._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(je._VJCanvasContext.beginPath(),je._VJCanvasContext.strokeStyle=this._joystickColor,je._VJCanvasContext.lineWidth=2,je._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),je._VJCanvasContext.stroke(),je._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(je._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),je._VJCanvasContext.beginPath(),je._VJCanvasContext.fillStyle="white",je._VJCanvasContext.beginPath(),je._VJCanvasContext.strokeStyle="red",je._VJCanvasContext.lineWidth=6,je._VJCanvasContext.arc(t.x,t.y,40,0,Math.PI*2,!0),je._VJCanvasContext.stroke(),je._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()}))}releaseCanvas(){je.Canvas&&(je.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),je.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),je.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),je.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(je.Canvas),je.Canvas=null),this._released=!0}}je._GlobalJoystickIndex=0;je._AlwaysVisibleSticks=0;Fh.prototype.addVirtualJoystick=function(){return this.add(new cI),this};class cI{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=e._computeLocalCameraSpeed()*50,i=O.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=m.TransformCoordinates(new m(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new je(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new je(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}Cr.FreeCameraVirtualJoystickInput=cI;Lt.AddNodeConstructor("TargetCamera",(n,e)=>()=>new Ui(n,m.Zero(),e));class Ui extends He{constructor(e,t,i,r=!0){super(e,t,i,r),this._tmpUpVector=m.Zero(),this._tmpTargetVector=m.Zero(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new se(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new ce,this.rotation=new m(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=m.Zero(),this._initialFocalDistance=1,this._viewMatrix=O.Zero(),this._camMatrix=O.Zero(),this._cameraTransformMatrix=O.Zero(),this._cameraRotationMatrix=O.Zero(),this._referencePoint=new m(0,0,1),this._transformedReferencePoint=m.Zero(),this._deferredPositionUpdate=new m,this._deferredRotationQuaternionUpdate=new ce,this._deferredRotationUpdate=new m,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=m.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new ce(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=pt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),O.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&ce.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(B.Matrix[0]),m.TransformNormalToRef(this.cameraDirection,B.Matrix[0],B.Vector3[0]),this._deferredPositionUpdate.addInPlace(B.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(ce.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))),t&&(Math.abs(this.cameraDirection.x)<this.speed*pt&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*pt&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*pt&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*pt&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*pt&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):O.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return m.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),m.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?ys.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(ce.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),ys.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const r=this.parent.getWorldMatrix();m.TransformCoordinatesToRef(e,r,this._globalPosition),m.TransformCoordinatesToRef(t,r,this._tmpTargetVector),m.TransformNormalToRef(i,r,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?O.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):O.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?O.LookAtRHToRef(e,t,i,this._viewMatrix):O.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==He.RIG_MODE_NONE){const i=new Ui(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode===He.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new ce),i._cameraRigParams={},i.rotationQuaternion=new ce),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case He.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case He.RIG_MODE_STEREOSCOPIC_OVERUNDER:case He.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case He.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,Ui._TargetFocalPoint),Ui._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const r=Ui._TargetFocalPoint.addInPlace(this.position);O.TranslationToRef(-r.x,-r.y,-r.z,Ui._TargetTransformMatrix),Ui._TargetTransformMatrix.multiplyToRef(O.RotationAxis(t.upVector,e),Ui._RigCamTransformMatrix),O.TranslationToRef(r.x,r.y,r.z,Ui._TargetTransformMatrix),Ui._RigCamTransformMatrix.multiplyToRef(Ui._TargetTransformMatrix,Ui._RigCamTransformMatrix),m.TransformCoordinatesToRef(this.position,Ui._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}}Ui._RigCamTransformMatrix=new O;Ui._TargetTransformMatrix=new O;Ui._TargetFocalPoint=new m;I([Ar()],Ui.prototype,"rotation",void 0);I([M()],Ui.prototype,"speed",void 0);I([eh("lockedTargetId")],Ui.prototype,"lockedTarget",void 0);class Cn extends Ui{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=m.Zero(),this._diffPosition=m.Zero(),this._newPosition=m.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,a,o=null)=>{this._newPosition.copyFrom(a),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>q.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&o&&this.onCollide(o))},this.inputs=new Fh(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=J.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new se(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}I([Ar()],Cn.prototype,"ellipsoid",void 0);I([Ar()],Cn.prototype,"ellipsoidOffset",void 0);I([M()],Cn.prototype,"checkCollisions",void 0);I([M()],Cn.prototype,"applyGravity",void 0);$("BABYLON.FreeCamera",Cn);Lt.AddNodeConstructor("TouchCamera",(n,e)=>()=>new uI(n,m.Zero(),e));class uI extends Cn{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}}class G3{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===tt.POINTERDOWN){this._isPointerDown=!0;return}i.type===tt.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=Tr.Now;let r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const s=i-this._lastInteractionTime-this._idleRotationWaitTime,a=Math.max(Math.min(s/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*a,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Tr.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<pt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Tr.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class Ws{constructor(){this._easingMode=Ws.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case Ws.EASINGMODE_EASEIN:return this.easeInCore(e);case Ws.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}Ws.EASINGMODE_EASEIN=0;Ws.EASINGMODE_EASEOUT=1;Ws.EASINGMODE_EASEINOUT=2;class z3 extends Ws{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class W3 extends Ws{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class Za{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(i&&(i.computeWorldMatrix(!0),i.getBoundingInfo)){const r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(Za.EasingFunction.setEasingMode(Za.EasingMode),this._radiusBounceTransition=me.CreateAnimation("radius",me.ANIMATIONTYPE_FLOAT,60,Za.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=me.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}Za.EasingFunction=new z3(.3);Za.EasingMode=Ws.EASINGMODE_EASEOUT;class $r{constructor(){this.onTargetFramingAnimationEndObservable=new Q,this._mode=$r.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();$r.EasingFunction.setEasingMode($r.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===tt.POINTERDOWN){this._isPointerDown=!0;return}i.type===tt.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&i.getBoundingInfo&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let a=0;a<e.length;a++){const o=e[a].getHierarchyBoundingVectors(!0);m.CheckExtends(o.min,r,s),m.CheckExtends(o.max,r,s)}this.zoomOnBoundingInfo(r,s,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let s;if(!this._attachedCamera)return!1;const a=e.y,o=t.y,l=a+(o-a)*this._positionScale,c=t.subtract(e).scale(.5);if(i)s=new m(0,l,0);else{const f=e.add(c);s=new m(f.x,l,f.z)}this._vectorTransition||(this._vectorTransition=me.CreateAnimation("target",me.ANIMATIONTYPE_VECTOR3,60,$r.EasingFunction)),this._betaIsAnimating=!0;let u=me.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);u&&this._animatables.push(u);let h=0;if(this._mode===$r.FitFrustumSidesMode){const f=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),h=f}else this._mode===$r.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const f=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/f,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=me.CreateAnimation("radius",me.ANIMATIONTYPE_FLOAT,60,$r.EasingFunction)),u=me.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),u&&this._animatables.push(u),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===$r.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Tr.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=me.CreateAnimation("beta",me.ANIMATIONTYPE_FLOAT,60,$r.EasingFunction));const r=me.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Tr.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}$r.EasingFunction=new W3;$r.EasingMode=Ws.EASINGMODE_EASEINOUT;$r.IgnoreBoundsSizeMode=0;$r.FitFrustumSidesMode=1;Lt.AddNodeConstructor("ArcRotateCamera",(n,e)=>()=>new ii(n,0,0,1,m.Zero(),e));class ii extends Ui{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new O,this._upToYMatrix=new O,this._upVector=m.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){O.RotationAlignToRef(m.UpReadOnly,this._upVector,this._yToUpMatrix),O.RotationAlignToRef(this._upVector,m.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Za,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new $r,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new G3,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,s,a,o=!0){super(e,m.Zero(),a,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=m.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=se.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._viewMatrix=new O,this.panningAxis=new m(1,1,0),this._transformedDirection=new m,this.mapPanning=!1,this._progressiveRestore=!1,this.onMeshTargetChangedObservable=new Q,this.checkCollisions=!1,this.collisionRadius=new m(.5,.5,.5),this._previousPosition=m.Zero(),this._collisionVelocity=m.Zero(),this._newPosition=m.Zero(),this._computationVector=m.Zero(),this._onCollisionPositionChange=(l,c,u=null)=>{u?(this.setPosition(c),this.onCollide&&this.onCollide(u)):this._previousPosition.copyFrom(this._position);const h=Math.cos(this.alpha),f=Math.sin(this.alpha),d=Math.cos(this.beta);let p=Math.sin(this.beta);p===0&&(p=1e-4);const _=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*h*p,this.radius*d,this.radius*f*p),_.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let g=this.upVector;this.allowUpsideDown&&this.beta<0&&(g=g.clone(),g=g.negate()),this._computeViewMatrix(this._position,_,g),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=m.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new __(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=se.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this._goalAlpha=this.alpha,this._storedBeta=this._goalBeta=this.beta,this._storedRadius=this._goalRadius=this.radius,this._storedTarget=this._goalTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this._goalTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>pt&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset),!0):super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}interpolateTo(e=this.alpha,t=this.beta,i=this.radius,r=this.target,s=this.targetScreenOffset){this._progressiveRestore=!0,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,e=vt(e,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),t=vt(t,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),i=vt(i,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),this._goalAlpha=e,this._goalBeta=t,this._goalRadius=i,this._goalTarget=r,this._goalTargetScreenOffset=s}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){const s=arguments;t=J.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof s[0]=="boolean"&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this._progressiveRestore){const e=this._scene.getEngine().getDeltaTime()/1e3,t=1-Math.pow(2,-e/this.restoreStateInterpolationFactor);this.setTarget(m.Lerp(this.getTarget(),this._goalTarget,t)),ce.RotationAlphaBetaGammaToRef(this._goalAlpha,this._goalBeta,0,B.Quaternion[0]),ce.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,B.Quaternion[1]),ce.SlerpToRef(B.Quaternion[1],B.Quaternion[0],t,B.Quaternion[2]),B.Quaternion[2].normalize(),B.Quaternion[2].toAlphaBetaGammaToRef(B.Vector3[0]),this.alpha=B.Vector3[0].x,this.beta=B.Vector3[0].y,this.radius+=(this._goalRadius-this.radius)*t,se.LerpToRef(this.targetScreenOffset,this._goalTargetScreenOffset,t,this.targetScreenOffset),(m.DistanceSquared(this.getTarget(),this._goalTarget)<pt&&B.Quaternion[2].equalsWithEpsilon(B.Quaternion[0])&&Math.pow(this._goalRadius-this.radius,2)<pt&&se.Distance(this.targetScreenOffset,this._goalTargetScreenOffset)<pt||this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0||this.inertialPanningX!==0||this.inertialPanningY!==0)&&(this._progressiveRestore=!1)}if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<pt&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<pt&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*pt&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new m(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),m.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const t=this.upVector,i=m.CrossToRef(this._transformedDirection,t,this._transformedDirection);m.CrossToRef(t,i,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),m.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){const t=B.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.transposeToRef(t),m.TransformCoordinatesToRef(this._transformedDirection,t,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*pt&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*pt&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const s=e,a=this._getTargetPosition();if(a&&!i&&a.equals(s))return;this._targetHost=null,this._target=s,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);const s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const a=this.getScene().collisionCoordinator;this._collider||(this._collider=a.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,a.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let a=this.upVector;this.allowUpsideDown&&r<0&&(a=a.negate()),this._computeViewMatrix(this._position,s,a),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=s,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=k.MinMax(e);let r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){const s=e||this.getScene().meshes;i=k.MinMax(s),r=m.Distance(i.min,i.max)}else{const s=e;i=s,r=s.distance}this._target=k.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case He.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case He.RIG_MODE_STEREOSCOPIC_OVERUNDER:case He.RIG_MODE_STEREOSCOPIC_INTERLACED:case He.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const r=new ii(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case He.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case He.RIG_MODE_STEREOSCOPIC_OVERUNDER:case He.RIG_MODE_STEREOSCOPIC_INTERLACED:case He.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const r=m.Distance(e,t),a=this.getScene().getEngine().getAspectRatio(this),o=Math.tan(this.fov/2),l=o*a,u=r*.5*i,h=u*Math.sqrt(1+1/(l*l)),f=u*Math.sqrt(1+1/(o*o));return Math.max(h,f)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}I([M()],ii.prototype,"alpha",void 0);I([M()],ii.prototype,"beta",void 0);I([M()],ii.prototype,"radius",void 0);I([M()],ii.prototype,"overrideCloneAlphaBetaRadius",void 0);I([Ar("target")],ii.prototype,"_target",void 0);I([eh("targetHost")],ii.prototype,"_targetHost",void 0);I([M()],ii.prototype,"inertialAlphaOffset",void 0);I([M()],ii.prototype,"inertialBetaOffset",void 0);I([M()],ii.prototype,"inertialRadiusOffset",void 0);I([M()],ii.prototype,"lowerAlphaLimit",void 0);I([M()],ii.prototype,"upperAlphaLimit",void 0);I([M()],ii.prototype,"lowerBetaLimit",void 0);I([M()],ii.prototype,"upperBetaLimit",void 0);I([M()],ii.prototype,"lowerRadiusLimit",void 0);I([M()],ii.prototype,"upperRadiusLimit",void 0);I([M()],ii.prototype,"inertialPanningX",void 0);I([M()],ii.prototype,"inertialPanningY",void 0);I([M()],ii.prototype,"pinchToPanMaxDistance",void 0);I([M()],ii.prototype,"panningDistanceLimit",void 0);I([Ar()],ii.prototype,"panningOriginTarget",void 0);I([M()],ii.prototype,"panningInertia",void 0);I([M()],ii.prototype,"zoomToMouseLocation",null);I([M()],ii.prototype,"zoomOnFactor",void 0);I([np()],ii.prototype,"targetScreenOffset",void 0);I([M()],ii.prototype,"allowUpsideDown",void 0);I([M()],ii.prototype,"useInputToRestoreState",void 0);I([M()],ii.prototype,"restoreStateInterpolationFactor",void 0);$("BABYLON.ArcRotateCamera",ii);Lt.AddNodeConstructor("DeviceOrientationCamera",(n,e)=>()=>new hI(n,m.Zero(),e));class hI extends Cn{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new ce,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new ce,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new ce),ce.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=ys.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new ce),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class H3 extends Mh{constructor(e){super(e)}addKeyboard(){return this.add(new Pa),this}addMouse(){return this.add(new Oh),this}}class Dc extends Ui{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new m(1,1,1),this.ellipsoidOffset=new m(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=m.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=m.Zero(),this._diffPosition=m.Zero(),this._newPosition=m.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,a,o=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>q.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&o&&this.onCollide(o))})(a)},this.inputs=new H3(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=J.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=this.rotation.z,r=t-i,s=.001;Math.abs(r)>=s&&(this.rotation.z+=r/e,Math.abs(t-this.rotation.z)<=s&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}I([Ar()],Dc.prototype,"ellipsoid",void 0);I([Ar()],Dc.prototype,"ellipsoidOffset",void 0);I([M()],Dc.prototype,"checkCollisions",void 0);I([M()],Dc.prototype,"applyGravity",void 0);$("BABYLON.FlyCamera",Dc);class X3 extends Mh{constructor(e){super(e)}addKeyboard(){return this.add(new Er),this}addMouseWheel(){return this.add(new ho),this}addPointers(){return this.add(new ss),this}addVRDeviceOrientation(){return w.Warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}Lt.AddNodeConstructor("FollowCamera",(n,e)=>()=>new gs(n,m.Zero(),e));Lt.AddNodeConstructor("ArcFollowCamera",(n,e)=>()=>new fI(n,0,0,1,null,e));class gs extends Ui{constructor(e,t,i,r=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=r,this.inputs=new X3(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=B.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),r=J.ToRadians(this.rotationOffset)+i,s=e.getAbsolutePosition(),a=s.x+Math.sin(r)*this.radius,o=s.z+Math.cos(r)*this.radius,l=a-this.position.x,c=s.y+this.heightOffset-this.position.y,u=o-this.position.z;let h=l*this.cameraAcceleration*2,f=c*this.cameraAcceleration,d=u*this.cameraAcceleration*2;(h>this.maxCameraSpeed||h<-this.maxCameraSpeed)&&(h=h<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new m(this.position.x+h,this.position.y+f,this.position.z+d),this.setTarget(s)}attachControl(e,t){t=J.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}I([M()],gs.prototype,"radius",void 0);I([M()],gs.prototype,"lowerRadiusLimit",void 0);I([M()],gs.prototype,"upperRadiusLimit",void 0);I([M()],gs.prototype,"rotationOffset",void 0);I([M()],gs.prototype,"lowerRotationOffsetLimit",void 0);I([M()],gs.prototype,"upperRotationOffsetLimit",void 0);I([M()],gs.prototype,"heightOffset",void 0);I([M()],gs.prototype,"lowerHeightOffsetLimit",void 0);I([M()],gs.prototype,"upperHeightOffsetLimit",void 0);I([M()],gs.prototype,"cameraAcceleration",void 0);I([M()],gs.prototype,"maxCameraSpeed",void 0);I([eh("lockedTargetId")],gs.prototype,"lockedTarget",void 0);class fI extends Ui{constructor(e,t,i,r,s,a){super(e,m.Zero(),a),this.alpha=t,this.beta=i,this.radius=r,this._cartesianCoordinates=m.Zero(),this.setMeshTarget(s)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}$("BABYLON.FollowCamera",gs);$("BABYLON.ArcFollowCamera",fI);var KE;(function(n){n[n.A=0]="A",n[n.B=1]="B",n[n.X=2]="X",n[n.Y=3]="Y",n[n.LB=4]="LB",n[n.RB=5]="RB",n[n.Back=8]="Back",n[n.Start=9]="Start",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick"})(KE||(KE={}));var jE;(function(n){n[n.Up=12]="Up",n[n.Down=13]="Down",n[n.Left=14]="Left",n[n.Right=15]="Right"})(jE||(jE={}));class Y3 extends gr{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new Q,this.onButtonUpObservable=new Q,this.onPadDownObservable=new Q,this.onPadUpObservable=new Q,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=gr.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,4)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var qE;(function(n){n[n.Cross=0]="Cross",n[n.Circle=1]="Circle",n[n.Square=2]="Square",n[n.Triangle=3]="Triangle",n[n.L1=4]="L1",n[n.R1=5]="R1",n[n.Share=8]="Share",n[n.Options=9]="Options",n[n.LeftStick=10]="LeftStick",n[n.RightStick=11]="RightStick"})(qE||(qE={}));var ZE;(function(n){n[n.Up=12]="Up",n[n.Down=13]="Down",n[n.Left=14]="Left",n[n.Right=15]="Right"})(ZE||(ZE={}));class $3 extends gr{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new Q,this.onButtonUpObservable=new Q,this.onPadDownObservable=new Q,this.onPadUpObservable=new Q,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=gr.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class K3{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new Q,Yi()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new Q(t=>{for(const i in this._babylonGamepads){const r=this._babylonGamepads[i];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let r;this._babylonGamepads[i.index]?(r=this._babylonGamepads[i.index],r.browserGamepad=i,r._isConnected=!0):r=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const r in this._babylonGamepads)if(this._babylonGamepads[r].index===i.index){const s=this._babylonGamepads[r];s._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=gr.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t;const i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new Y3(e.id,e.index,e,r):i?t=new $3(e.id,e.index,e):t=new U3(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(J.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&q.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}}}Object.defineProperty(ht.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new K3(this);let n=this._getComponent(we.NAME_GAMEPAD);n||(n=new j3(this),this._addComponent(n))}return this._gamepadManager},enumerable:!0,configurable:!0});Fh.prototype.addGamepad=function(){return this.add(new wh),this};__.prototype.addGamepad=function(){return this.add(new Dh),this};class j3{constructor(e){this.name=we.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}}Lt.AddNodeConstructor("FreeCamera",(n,e)=>()=>new pl(n,m.Zero(),e));class pl extends uI{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}He._CreateDefaultParsedCamera=(n,e)=>new pl(n,m.Zero(),e);Lt.AddNodeConstructor("GamepadCamera",(n,e)=>()=>new m_(n,m.Zero(),e));class m_ extends pl{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}class dI extends Jt{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,s,a){super(e,"anaglyph",null,["leftSampler"],t,i[1],r,s,a),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(o=>{o.setTextureFromPostProcess("leftSampler",this._passedProcess)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(re(()=>import("./anaglyph.fragment-DtxvfIEP.js"),[]))):t.push(re(()=>import("./anaglyph.fragment-2vhhtH2K.js"),[])),super._gatherImports(e,t)}}$("BABYLON.AnaglyphPostProcess",dI);function Bh(n){n._rigCameras[0]._rigPostProcess=new oo(n.name+"_passthru",1,n._rigCameras[0]),n._rigCameras[1]._rigPostProcess=new dI(n.name+"_anaglyph",1,n._rigCameras)}Lt.AddNodeConstructor("AnaglyphArcRotateCamera",(n,e,t)=>()=>new q3(n,0,0,1,m.Zero(),t.interaxial_distance,e));class q3 extends ii{constructor(e,t,i,r,s,a,o){super(e,t,i,r,s,o),this._setRigMode=()=>Bh(this),this.interaxialDistance=a,this.setCameraRigMode(He.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:a})}getClassName(){return"AnaglyphArcRotateCamera"}}Lt.AddNodeConstructor("AnaglyphFreeCamera",(n,e,t)=>()=>new Z3(n,m.Zero(),t.interaxial_distance,e));class Z3 extends Cn{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Bh(this),this.interaxialDistance=i,this.setCameraRigMode(He.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}Lt.AddNodeConstructor("AnaglyphGamepadCamera",(n,e,t)=>()=>new Q3(n,m.Zero(),t.interaxial_distance,e));class Q3 extends m_{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Bh(this),this.interaxialDistance=i,this.setCameraRigMode(He.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}Lt.AddNodeConstructor("AnaglyphUniversalCamera",(n,e,t)=>()=>new J3(n,m.Zero(),t.interaxial_distance,e));class J3 extends pl{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>Bh(this),this.interaxialDistance=i,this.setCameraRigMode(He.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}const eV="stereoscopicInterlacePixelShader",tV=`const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);}
`;V.ShadersStore[eV]=tV;class iV extends Jt{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,s,a,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],s,a,o,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new se(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new se(1/this.width,1/this.height)}),this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("camASampler",this._passedProcess),l.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}}function Vh(n){const e=n.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||n.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,t=n.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;n.cameraRigMode===He.RIG_MODE_STEREOSCOPIC_INTERLACED?(n._rigCameras[0]._rigPostProcess=new oo(n.name+"_passthru",1,n._rigCameras[0]),n._rigCameras[1]._rigPostProcess=new iV(n.name+"_stereoInterlace",n._rigCameras,!1,!0)):(n._rigCameras[t?1:0].viewport=new Hn(0,0,e?.5:1,e?1:.5),n._rigCameras[t?0:1].viewport=new Hn(e?.5:0,e?0:.5,e?.5:1,e?1:.5))}Lt.AddNodeConstructor("StereoscopicArcRotateCamera",(n,e,t)=>()=>new rV(n,0,0,1,m.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class rV extends ii{constructor(e,t,i,r,s,a,o,l){super(e,t,i,r,s,l),this._setRigMode=()=>Vh(this),this.interaxialDistance=a,this.isStereoscopicSideBySide=o,this.setCameraRigMode(o?He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:He.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:a})}getClassName(){return"StereoscopicArcRotateCamera"}}Lt.AddNodeConstructor("StereoscopicFreeCamera",(n,e,t)=>()=>new sV(n,m.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class sV extends Cn{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>Vh(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:He.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}Lt.AddNodeConstructor("StereoscopicGamepadCamera",(n,e,t)=>()=>new nV(n,m.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class nV extends m_{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>Vh(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:He.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}Lt.AddNodeConstructor("StereoscopicFreeCamera",(n,e,t)=>()=>new aV(n,m.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class aV extends pl{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>Vh(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?He.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:He.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}Lt.AddNodeConstructor("VirtualJoysticksCamera",(n,e)=>()=>new oV(n,m.Zero(),e));class oV extends Cn{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class _l{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return O.Translation(t,0,0)}get rightHMatrix(){const t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return O.Translation(-t,0,0)}get leftPreViewMatrix(){return O.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return O.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new _l;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class QE extends Jt{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,Z.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new se(2,2/this.aspectRatio),this._scaleFactor=new se(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new se(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(s=>{s.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),s.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),s.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),s.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(re(()=>import("./vrDistortionCorrection.fragment-F481cFWn.js"),[]))):t.push(re(()=>import("./vrDistortionCorrection.fragment-CvrE1gd8.js"),[])),super._gatherImports(e,t)}}const lV="vrMultiviewToSingleviewPixelShader",cV=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;V.ShadersStore[lV]=cV;class uV extends Jt{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,Z.BILINEAR_SAMPLINGMODE);const r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(s=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?s.setInt("imageIndex",0):s.setInt("imageIndex",1),s.setTexture("multiviewSampler",r._multiviewTexture)})}}function g_(n,e){const t=e.vrCameraMetrics||_l.GetDefault();n._rigCameras[0]._cameraRigParams.vrMetrics=t,n._rigCameras[0].viewport=new Hn(0,0,.5,1),n._rigCameras[0]._cameraRigParams.vrWorkMatrix=new O,n._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,n._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,n._rigCameras[0].getProjectionMatrix=n._rigCameras[0]._getVRProjectionMatrix,n._rigCameras[1]._cameraRigParams.vrMetrics=t,n._rigCameras[1].viewport=new Hn(.5,0,.5,1),n._rigCameras[1]._cameraRigParams.vrWorkMatrix=new O,n._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,n._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,n._rigCameras[1].getProjectionMatrix=n._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(n.getScene().getEngine().getCaps().multiview?(n._useMultiviewToSingleView=!0,n._rigPostProcess=new uV("VRMultiviewToSingleview",n,t.postProcessScaleFactor)):(w.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(n._rigCameras[0]._rigPostProcess=new QE("VR_Distort_Compensation_Left",n._rigCameras[0],!1,t),n._rigCameras[1]._rigPostProcess=new QE("VR_Distort_Compensation_Right",n._rigCameras[1],!0,t))}Lt.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(n,e)=>()=>new hV(n,0,0,1,m.Zero(),e));class hV extends ii{constructor(e,t,i,r,s,a,o=!0,l=_l.GetDefault()){super(e,t,i,r,s,a),this._setRigMode=c=>g_(this,c),l.compensateDistortion=o,this.setCameraRigMode(He.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}Lt.AddNodeConstructor("VRDeviceOrientationFreeCamera",(n,e)=>()=>new pI(n,m.Zero(),e));class pI extends hI{constructor(e,t,i,r=!0,s=_l.GetDefault()){super(e,t,i),this._setRigMode=a=>g_(this,a),s.compensateDistortion=r,this.setCameraRigMode(He.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}}Lt.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(n,e)=>()=>new fV(n,m.Zero(),e));class fV extends pI{constructor(e,t,i,r=!0,s=_l.GetDefault()){super(e,t,i,r,s),this._setRigMode=a=>g_(this,a),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}const Td=2,dV=(n,e)=>{const t=new pl("PlayerFirstViewCamera",new m(e.position.x,e.position.y+Td,e.position.z),n);t.attachControl(!0);const i=new ii("PlayerThirdViewCamera",0,0,20,new m(e.position.x,e.position.y,e.position.z),n);return n.activeCamera=t,{firstViewCamera:t,thirdViewCamera:i}},pV=(n,e,t,i)=>{var r,s,a,o,l;if(((r=n.activeCamera)==null?void 0:r.name)==="PlayerFirstViewCamera"){const c=t.rotation.y;if(c===((a=(s=e.rotationQuaternion)==null?void 0:s.toEulerAngles())==null?void 0:a.y))return;e.rotationQuaternion=ce.FromEulerAngles(0,c-Math.PI,0),t.position.set(e.position.x,e.position.y+Td,e.position.z);const u=t.getDirection(m.Forward());t.position.set(e.position.x+u.x,e.position.y+Td,e.position.z+u.z)}else if(((o=n.activeCamera)==null?void 0:o.name)==="PlayerThirdViewCamera"){if(!e.isMoving)e.rotationQuaternion=ce.FromEulerAngles(0,((l=e.rotationQuaternion)==null?void 0:l.toEulerAngles().y)||e.rotation.y,0);else{const c=-m.GetAngleBetweenVectorsOnPlane(i.getForwardRay().direction,m.Forward(),m.Up());e.rotationQuaternion=ce.RotationAxis(m.Up(),c-Math.PI)}i.target.set(e.position.x,e.position.y,e.position.z)}},_V=(n,e,t,i)=>{var r,s;e.c&&(((r=n.activeCamera)==null?void 0:r.name)==="PlayerFirstViewCamera"?(t.detachControl(),i.attachControl(!0),n.activeCamera=i):((s=n.activeCamera)==null?void 0:s.name)==="PlayerThirdViewCamera"&&(i.detachControl(),t.attachControl(!0),n.activeCamera=t))},mV=(n,e)=>{const i=e.getAnimationRange("walking"),r=e.getAnimationRange("walking"),s=e.getAnimationRange("walking"),a=e.getAnimationRange("walking"),o=null;let l=!1;const c=()=>{l=!1};return{ranges:{idle:null,walkingForward:i,walkingBackward:r,strifeLeft:s,strifeRight:a,jumping:o},actions:{onStopAllAnimations:c,onIdle:()=>{},onWalkingForward:(_=!1)=>{!i||l||(l=!0,n.getScene().beginAnimation(e,i.from+1,i.to,!1,_?1.5:1,()=>{c()}))},onWalkingBackward:()=>{!r||l||(l=!0,n.getScene().beginAnimation(e,r.from+1,r.to,!1,1,()=>{c()}))},onStrifeLeft:(_=!1)=>{!s||l||(l=!0,n.getScene().beginAnimation(e,s.from+1,s.to,!1,_?1.5:1,()=>{c()}))},onStrifeRight:(_=!1)=>{!a||l||(l=!0,n.getScene().beginAnimation(e,a.from+1,a.to,!1,_?1.5:1,()=>{c()}))}}}};var gV=(()=>{var n=import.meta.url;return function(e){e=e||{};var t=typeof e<"u"?e:{},i,r;t.ready=new Promise(function(U,X){i=U,r=X});var s=Object.assign({},t),a=(U,X)=>{throw X},o=!0,l="";function c(U){return t.locateFile?t.locateFile(U,l):l+U}var u;typeof document<"u"&&document.currentScript&&(l=document.currentScript.src),n&&(l=n),l.indexOf("blob:")!==0?l=l.substr(0,l.replace(/[?#].*/,"").lastIndexOf("/")+1):l="";var h=t.print||console.log.bind(console),f=t.printErr||console.warn.bind(console);Object.assign(t,s),s=null,t.arguments&&t.arguments,t.thisProgram&&t.thisProgram,t.quit&&(a=t.quit);var d=4,p;t.wasmBinary&&(p=t.wasmBinary);var _=t.noExitRuntime||!0;typeof WebAssembly!="object"&&be("no native wasm support detected");var g,E=!1,v,x=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0;function A(U,X,ee){for(var Te=X+ee,Ae=X;U[Ae]&&!(Ae>=Te);)++Ae;if(Ae-X>16&&U.buffer&&x)return x.decode(U.subarray(X,Ae));for(var Ue="";X<Ae;){var Xe=U[X++];if(!(Xe&128)){Ue+=String.fromCharCode(Xe);continue}var Fe=U[X++]&63;if((Xe&224)==192){Ue+=String.fromCharCode((Xe&31)<<6|Fe);continue}var Oe=U[X++]&63;if((Xe&240)==224?Xe=(Xe&15)<<12|Fe<<6|Oe:Xe=(Xe&7)<<18|Fe<<12|Oe<<6|U[X++]&63,Xe<65536)Ue+=String.fromCharCode(Xe);else{var ut=Xe-65536;Ue+=String.fromCharCode(55296|ut>>10,56320|ut&1023)}}return Ue}function T(U,X){return U?A(W,U,X):""}function C(U,X,ee,Te){if(!(Te>0))return 0;for(var Ae=ee,Ue=ee+Te-1,Xe=0;Xe<U.length;++Xe){var Fe=U.charCodeAt(Xe);if(Fe>=55296&&Fe<=57343){var Oe=U.charCodeAt(++Xe);Fe=65536+((Fe&1023)<<10)|Oe&1023}if(Fe<=127){if(ee>=Ue)break;X[ee++]=Fe}else if(Fe<=2047){if(ee+1>=Ue)break;X[ee++]=192|Fe>>6,X[ee++]=128|Fe&63}else if(Fe<=65535){if(ee+2>=Ue)break;X[ee++]=224|Fe>>12,X[ee++]=128|Fe>>6&63,X[ee++]=128|Fe&63}else{if(ee+3>=Ue)break;X[ee++]=240|Fe>>18,X[ee++]=128|Fe>>12&63,X[ee++]=128|Fe>>6&63,X[ee++]=128|Fe&63}}return X[ee]=0,ee-Ae}function y(U,X,ee){return C(U,W,X,ee)}function P(U){for(var X=0,ee=0;ee<U.length;++ee){var Te=U.charCodeAt(ee);Te<=127?X++:Te<=2047?X+=2:Te>=55296&&Te<=57343?(X+=4,++ee):X+=3}return X}var D,F,W,H,ue,ae,le,oe,ge,Ee,ne;function j(U){D=U,t.HEAP8=F=new Int8Array(U),t.HEAP16=H=new Int16Array(U),t.HEAP32=ae=new Int32Array(U),t.HEAPU8=W=new Uint8Array(U),t.HEAPU16=ue=new Uint16Array(U),t.HEAPU32=le=new Uint32Array(U),t.HEAPF32=oe=new Float32Array(U),t.HEAPF64=ne=new Float64Array(U),t.HEAP64=ge=new BigInt64Array(U),t.HEAPU64=Ee=new BigUint64Array(U)}t.INITIAL_MEMORY;var L,Y=[],te=[],De=[],Ve=[];function ve(){return _}function Me(){if(t.preRun)for(typeof t.preRun=="function"&&(t.preRun=[t.preRun]);t.preRun.length;)Wt(t.preRun.shift());xt(Y)}function Re(){xt(te)}function Pe(){xt(De)}function ft(){if(t.postRun)for(typeof t.postRun=="function"&&(t.postRun=[t.postRun]);t.postRun.length;)z(t.postRun.shift());xt(Ve)}function Wt(U){Y.unshift(U)}function xe(U){te.unshift(U)}function z(U){Ve.unshift(U)}var K=0,he=null;function Ce(U){K++,t.monitorRunDependencies&&t.monitorRunDependencies(K)}function ye(U){if(K--,t.monitorRunDependencies&&t.monitorRunDependencies(K),K==0&&he){var X=he;he=null,X()}}function be(U){t.onAbort&&t.onAbort(U),U="Aborted("+U+")",f(U),E=!0,v=1,U+=". Build with -sASSERTIONS for more info.";var X=new WebAssembly.RuntimeError(U);throw r(X),X}var Je="data:application/octet-stream;base64,";function qe(U){return U.startsWith(Je)}var Ge;t.locateFile?(Ge="HavokPhysics.wasm",qe(Ge)||(Ge=c(Ge))):Ge=new URL("/ColdEscape/assets/HavokPhysics-CjZXfFYQ.wasm",import.meta.url).toString();function Le(U){try{if(U==Ge&&p)return new Uint8Array(p);throw"both async and sync fetching of the wasm failed"}catch(X){be(X)}}function mt(){return!p&&o&&typeof fetch=="function"?fetch(Ge,{credentials:"same-origin"}).then(function(U){if(!U.ok)throw"failed to load wasm binary file at '"+Ge+"'";return U.arrayBuffer()}).catch(function(){return Le(Ge)}):Promise.resolve().then(function(){return Le(Ge)})}function it(){var U={env:w_,wasi_snapshot_preview1:w_};function X(Xe,Fe){var Oe=Xe.exports;t.asm=Oe,g=t.asm.memory,j(g.buffer),L=t.asm.__indirect_function_table,xe(t.asm.__wasm_call_ctors),ye()}Ce();function ee(Xe){X(Xe.instance)}function Te(Xe){return mt().then(function(Fe){return WebAssembly.instantiate(Fe,U)}).then(function(Fe){return Fe}).then(Xe,function(Fe){f("failed to asynchronously prepare wasm: "+Fe),be(Fe)})}function Ae(){return!p&&typeof WebAssembly.instantiateStreaming=="function"&&!qe(Ge)&&typeof fetch=="function"?fetch(Ge,{credentials:"same-origin"}).then(function(Xe){var Fe=WebAssembly.instantiateStreaming(Xe,U);return Fe.then(ee,function(Oe){return f("wasm streaming compile failed: "+Oe),f("falling back to ArrayBuffer instantiation"),Te(ee)})}):Te(ee)}if(t.instantiateWasm)try{var Ue=t.instantiateWasm(U,X);return Ue}catch(Xe){f("Module.instantiateWasm callback failed with error: "+Xe),r(Xe)}return Ae().catch(r),{}}function dt(U){this.name="ExitStatus",this.message="Program terminated with exit("+U+")",this.status=U}function xt(U){for(;U.length>0;)U.shift()(t)}function bt(U){if(U instanceof dt||U=="unwind")return v;a(1,U)}var Ht={};function Ut(U){for(;U.length;){var X=U.pop(),ee=U.pop();ee(X)}}function yi(U){return this.fromWireType(ae[U>>2])}var Ct={},Mi={},di={},Wr=48,Ki=57;function Di(U){if(U===void 0)return"_unknown";U=U.replace(/[^a-zA-Z0-9_]/g,"$");var X=U.charCodeAt(0);return X>=Wr&&X<=Ki?"_"+U:U}function Pr(U,X){return U=Di(U),new Function("body","return function "+U+`() {
    "use strict";    return body.apply(this, arguments);
};
`)(X)}function In(U,X){var ee=Pr(X,function(Te){this.name=X,this.message=Te;var Ae=new Error(Te).stack;Ae!==void 0&&(this.stack=this.toString()+`
`+Ae.replace(/^Error(:[^\n]*)?\n/,""))});return ee.prototype=Object.create(U.prototype),ee.prototype.constructor=ee,ee.prototype.toString=function(){return this.message===void 0?this.name:this.name+": "+this.message},ee}var Ma=void 0;function po(U){throw new Ma(U)}function Da(U,X,ee){U.forEach(function(Fe){di[Fe]=X});function Te(Fe){var Oe=ee(Fe);Oe.length!==U.length&&po("Mismatched type converter count");for(var ut=0;ut<U.length;++ut)Ir(U[ut],Oe[ut])}var Ae=new Array(X.length),Ue=[],Xe=0;X.forEach((Fe,Oe)=>{Mi.hasOwnProperty(Fe)?Ae[Oe]=Mi[Fe]:(Ue.push(Fe),Ct.hasOwnProperty(Fe)||(Ct[Fe]=[]),Ct[Fe].push(()=>{Ae[Oe]=Mi[Fe],++Xe,Xe===Ue.length&&Te(Ae)}))}),Ue.length===0&&Te(Ae)}function vr(U){var X=Ht[U];delete Ht[U];var ee=X.elements,Te=ee.length,Ae=ee.map(function(Fe){return Fe.getterReturnType}).concat(ee.map(function(Fe){return Fe.setterArgumentType})),Ue=X.rawConstructor,Xe=X.rawDestructor;Da([U],Ae,function(Fe){return ee.forEach((Oe,ut)=>{var pi=Fe[ut],kt=Oe.getter,Si=Oe.getterContext,Ls=Fe[ut+Te],Ps=Oe.setter,Na=Oe.setterContext;Oe.read=$s=>pi.fromWireType(kt(Si,$s)),Oe.write=($s,Jh)=>{var k_=[];Ps(Na,$s,Ls.toWireType(k_,Jh)),Ut(k_)}}),[{name:X.name,fromWireType:function(Oe){for(var ut=new Array(Te),pi=0;pi<Te;++pi)ut[pi]=ee[pi].read(Oe);return Xe(Oe),ut},toWireType:function(Oe,ut){if(Te!==ut.length)throw new TypeError("Incorrect number of tuple elements for "+X.name+": expected="+Te+", actual="+ut.length);for(var pi=Ue(),kt=0;kt<Te;++kt)ee[kt].write(pi,ut[kt]);return Oe!==null&&Oe.push(Xe,pi),pi},argPackAdvance:8,readValueFromPointer:yi,destructorFunction:Xe}]})}function _o(U){if(U===null)return"null";var X=typeof U;return X==="object"||X==="array"||X==="function"?U.toString():""+U}function Bc(){for(var U=new Array(256),X=0;X<256;++X)U[X]=String.fromCharCode(X);Sl=U}var Sl=void 0;function Sr(U){for(var X="",ee=U;W[ee];)X+=Sl[W[ee++]];return X}var Tl=void 0;function ur(U){throw new Tl(U)}function Ir(U,X,ee={}){if(!("argPackAdvance"in X))throw new TypeError("registerType registeredInstance requires argPackAdvance");var Te=X.name;if(U||ur('type "'+Te+'" must have a positive integer typeid pointer'),Mi.hasOwnProperty(U)){if(ee.ignoreDuplicateRegistrations)return;ur("Cannot register type '"+Te+"' twice")}if(Mi[U]=X,delete di[U],Ct.hasOwnProperty(U)){var Ae=Ct[U];delete Ct[U],Ae.forEach(Ue=>Ue())}}function Oa(U,X,ee){switch(X){case 0:return ee?function(Ae){return F[Ae]}:function(Ae){return W[Ae]};case 1:return ee?function(Ae){return H[Ae>>1]}:function(Ae){return ue[Ae>>1]};case 2:return ee?function(Ae){return ae[Ae>>2]}:function(Ae){return le[Ae>>2]};case 3:return ee?function(Ae){return ge[Ae>>3]}:function(Ae){return Ee[Ae>>3]};default:throw new TypeError("Unknown integer type: "+U)}}function Vc(U,X,ee,Te,Ae){X=Sr(X);var Ue=Ys(ee),Xe=X.indexOf("u")!=-1;Xe&&(Ae=(1n<<64n)-1n),Ir(U,{name:X,fromWireType:function(Fe){return Fe},toWireType:function(Fe,Oe){if(typeof Oe!="bigint"&&typeof Oe!="number")throw new TypeError('Cannot convert "'+_o(Oe)+'" to '+this.name);if(Oe<Te||Oe>Ae)throw new TypeError('Passing a number "'+_o(Oe)+'" from JS side to C/C++ side to an argument of type "'+X+'", which is outside the valid range ['+Te+", "+Ae+"]!");return Oe},argPackAdvance:8,readValueFromPointer:Oa(X,Ue,!Xe),destructorFunction:null})}function Ys(U){switch(U){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+U)}}function ea(U,X,ee,Te,Ae){var Ue=Ys(ee);X=Sr(X),Ir(U,{name:X,fromWireType:function(Xe){return!!Xe},toWireType:function(Xe,Fe){return Fe?Te:Ae},argPackAdvance:8,readValueFromPointer:function(Xe){var Fe;if(ee===1)Fe=F;else if(ee===2)Fe=H;else if(ee===4)Fe=ae;else throw new TypeError("Unknown boolean type size: "+X);return this.fromWireType(Fe[Xe>>Ue])},destructorFunction:null})}var Fr=[],ns=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function y_(U){U>4&&--ns[U].refcount===0&&(ns[U]=void 0,Fr.push(U))}function Kb(){for(var U=0,X=5;X<ns.length;++X)ns[X]!==void 0&&++U;return U}function jb(){for(var U=5;U<ns.length;++U)if(ns[U]!==void 0)return ns[U];return null}function qb(){t.count_emval_handles=Kb,t.get_first_emval=jb}var qh={toValue:U=>(U||ur("Cannot use deleted val. handle = "+U),ns[U].value),toHandle:U=>{switch(U){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:{var X=Fr.length?Fr.pop():ns.length;return ns[X]={refcount:1,value:U},X}}}};function Zb(U,X){X=Sr(X),Ir(U,{name:X,fromWireType:function(ee){var Te=qh.toValue(ee);return y_(ee),Te},toWireType:function(ee,Te){return qh.toHandle(Te)},argPackAdvance:8,readValueFromPointer:yi,destructorFunction:null})}function Qb(U,X,ee){if(U[X].overloadTable===void 0){var Te=U[X];U[X]=function(){return U[X].overloadTable.hasOwnProperty(arguments.length)||ur("Function '"+ee+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+U[X].overloadTable+")!"),U[X].overloadTable[arguments.length].apply(this,arguments)},U[X].overloadTable=[],U[X].overloadTable[Te.argCount]=Te}}function b_(U,X,ee){t.hasOwnProperty(U)?((ee===void 0||t[U].overloadTable!==void 0&&t[U].overloadTable[ee]!==void 0)&&ur("Cannot register public name '"+U+"' twice"),Qb(t,U,U),t.hasOwnProperty(ee)&&ur("Cannot register multiple overloads of a function with the same number of arguments ("+ee+")!"),t[U].overloadTable[ee]=X):(t[U]=X,ee!==void 0&&(t[U].numArguments=ee))}function Jb(U,X,ee){switch(X){case 0:return function(Te){var Ae=ee?F:W;return this.fromWireType(Ae[Te])};case 1:return function(Te){var Ae=ee?H:ue;return this.fromWireType(Ae[Te>>1])};case 2:return function(Te){var Ae=ee?ae:le;return this.fromWireType(Ae[Te>>2])};default:throw new TypeError("Unknown integer type: "+U)}}function e0(U,X,ee,Te){var Ae=Ys(ee);X=Sr(X);function Ue(){}Ue.values={},Ir(U,{name:X,constructor:Ue,fromWireType:function(Xe){return this.constructor.values[Xe]},toWireType:function(Xe,Fe){return Fe.value},argPackAdvance:8,readValueFromPointer:Jb(X,Ae,Te),destructorFunction:null}),b_(X,Ue)}function R_(U){var X=B_(U),ee=Sr(X);return yn(X),ee}function P_(U,X){var ee=Mi[U];return ee===void 0&&ur(X+" has unknown type "+R_(U)),ee}function t0(U,X,ee){var Te=P_(U,"enum");X=Sr(X);var Ae=Te.constructor,Ue=Object.create(Te.constructor.prototype,{value:{value:ee},constructor:{value:Pr(Te.name+"_"+X,function(){})}});Ae.values[ee]=Ue,Ae[X]=Ue}function i0(U,X){switch(X){case 2:return function(ee){return this.fromWireType(oe[ee>>2])};case 3:return function(ee){return this.fromWireType(ne[ee>>3])};default:throw new TypeError("Unknown float type: "+U)}}function r0(U,X,ee){var Te=Ys(ee);X=Sr(X),Ir(U,{name:X,fromWireType:function(Ae){return Ae},toWireType:function(Ae,Ue){return Ue},argPackAdvance:8,readValueFromPointer:i0(X,Te),destructorFunction:null})}function M_(U,X){if(!(U instanceof Function))throw new TypeError("new_ called with constructor type "+typeof U+" which is not a function");var ee=Pr(U.name||"unknownFunctionName",function(){});ee.prototype=U.prototype;var Te=new ee,Ae=U.apply(Te,X);return Ae instanceof Object?Ae:Te}function s0(U,X,ee,Te,Ae){var Ue=X.length;Ue<2&&ur("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var Xe=X[1]!==null&&ee!==null,Fe=!1,Oe=1;Oe<X.length;++Oe)if(X[Oe]!==null&&X[Oe].destructorFunction===void 0){Fe=!0;break}for(var ut=X[0].name!=="void",pi="",kt="",Oe=0;Oe<Ue-2;++Oe)pi+=(Oe!==0?", ":"")+"arg"+Oe,kt+=(Oe!==0?", ":"")+"arg"+Oe+"Wired";var Si="return function "+Di(U)+"("+pi+`) {
if (arguments.length !== `+(Ue-2)+`) {
throwBindingError('function `+U+" called with ' + arguments.length + ' arguments, expected "+(Ue-2)+` args!');
}
`;Fe&&(Si+=`var destructors = [];
`);var Ls=Fe?"destructors":"null",Ps=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],Na=[ur,Te,Ae,Ut,X[0],X[1]];Xe&&(Si+="var thisWired = classParam.toWireType("+Ls+`, this);
`);for(var Oe=0;Oe<Ue-2;++Oe)Si+="var arg"+Oe+"Wired = argType"+Oe+".toWireType("+Ls+", arg"+Oe+"); // "+X[Oe+2].name+`
`,Ps.push("argType"+Oe),Na.push(X[Oe+2]);if(Xe&&(kt="thisWired"+(kt.length>0?", ":"")+kt),Si+=(ut?"var rv = ":"")+"invoker(fn"+(kt.length>0?", ":"")+kt+`);
`,Fe)Si+=`runDestructors(destructors);
`;else for(var Oe=Xe?1:2;Oe<X.length;++Oe){var $s=Oe===1?"thisWired":"arg"+(Oe-2)+"Wired";X[Oe].destructorFunction!==null&&(Si+=$s+"_dtor("+$s+"); // "+X[Oe].name+`
`,Ps.push($s+"_dtor"),Na.push(X[Oe].destructorFunction))}ut&&(Si+=`var ret = retType.fromWireType(rv);
return ret;
`),Si+=`}
`,Ps.push(Si);var Jh=M_(Function,Ps).apply(null,Na);return Jh}function n0(U,X){for(var ee=[],Te=0;Te<U;Te++)ee.push(le[X+Te*4>>2]);return ee}function a0(U,X,ee){t.hasOwnProperty(U)||po("Replacing nonexistant public symbol"),t[U].overloadTable!==void 0&&ee!==void 0?t[U].overloadTable[ee]=X:(t[U]=X,t[U].argCount=ee)}var Uc=[];function o0(U){var X=Uc[U];return X||(U>=Uc.length&&(Uc.length=U+1),Uc[U]=X=L.get(U)),X}function xl(U,X){U=Sr(U);function ee(){return o0(X)}var Te=ee();return typeof Te!="function"&&ur("unknown function pointer with signature "+U+": "+X),Te}var D_=void 0;function l0(U,X){var ee=[],Te={};function Ae(Ue){if(!Te[Ue]&&!Mi[Ue]){if(di[Ue]){di[Ue].forEach(Ae);return}ee.push(Ue),Te[Ue]=!0}}throw X.forEach(Ae),new D_(U+": "+ee.map(R_).join([", "]))}function c0(U,X,ee,Te,Ae,Ue){var Xe=n0(X,ee);U=Sr(U),Ae=xl(Te,Ae),b_(U,function(){l0("Cannot call "+U+" due to unbound types",Xe)},X-1),Da([],Xe,function(Fe){var Oe=[Fe[0],null].concat(Fe.slice(1));return a0(U,s0(U,Oe,null,Ae,Ue),X-1),[]})}function u0(U,X,ee,Te,Ae){X=Sr(X);var Ue=Ys(ee),Xe=kt=>kt;if(Te===0){var Fe=32-8*ee;Xe=kt=>kt<<Fe>>>Fe}var Oe=X.includes("unsigned"),ut=(kt,Si)=>{},pi;Oe?pi=function(kt,Si){return ut(Si,this.name),Si>>>0}:pi=function(kt,Si){return ut(Si,this.name),Si},Ir(U,{name:X,fromWireType:Xe,toWireType:pi,argPackAdvance:8,readValueFromPointer:Oa(X,Ue,Te!==0),destructorFunction:null})}function h0(U,X,ee){var Te=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array],Ae=Te[X];function Ue(Xe){Xe=Xe>>2;var Fe=le,Oe=Fe[Xe],ut=Fe[Xe+1];return new Ae(D,ut,Oe)}ee=Sr(ee),Ir(U,{name:ee,fromWireType:Ue,argPackAdvance:8,readValueFromPointer:Ue},{ignoreDuplicateRegistrations:!0})}function f0(U,X){X=Sr(X);var ee=X==="std::string";Ir(U,{name:X,fromWireType:function(Te){var Ae=le[Te>>2],Ue=Te+4,Xe;if(ee)for(var Fe=Ue,Oe=0;Oe<=Ae;++Oe){var ut=Ue+Oe;if(Oe==Ae||W[ut]==0){var pi=ut-Fe,kt=T(Fe,pi);Xe===void 0?Xe=kt:(Xe+="\0",Xe+=kt),Fe=ut+1}}else{for(var Si=new Array(Ae),Oe=0;Oe<Ae;++Oe)Si[Oe]=String.fromCharCode(W[Ue+Oe]);Xe=Si.join("")}return yn(Te),Xe},toWireType:function(Te,Ae){Ae instanceof ArrayBuffer&&(Ae=new Uint8Array(Ae));var Ue,Xe=typeof Ae=="string";Xe||Ae instanceof Uint8Array||Ae instanceof Uint8ClampedArray||Ae instanceof Int8Array||ur("Cannot pass non-string to std::string"),ee&&Xe?Ue=P(Ae):Ue=Ae.length;var Fe=Qh(4+Ue+1),Oe=Fe+4;if(le[Fe>>2]=Ue,ee&&Xe)y(Ae,Oe,Ue+1);else if(Xe)for(var ut=0;ut<Ue;++ut){var pi=Ae.charCodeAt(ut);pi>255&&(yn(Oe),ur("String has UTF-16 code units that do not fit in 8 bits")),W[Oe+ut]=pi}else for(var ut=0;ut<Ue;++ut)W[Oe+ut]=Ae[ut];return Te!==null&&Te.push(yn,Fe),Fe},argPackAdvance:8,readValueFromPointer:yi,destructorFunction:function(Te){yn(Te)}})}var O_=typeof TextDecoder<"u"?new TextDecoder("utf-16le"):void 0;function d0(U,X){for(var ee=U,Te=ee>>1,Ae=Te+X/2;!(Te>=Ae)&&ue[Te];)++Te;if(ee=Te<<1,ee-U>32&&O_)return O_.decode(W.subarray(U,ee));for(var Ue="",Xe=0;!(Xe>=X/2);++Xe){var Fe=H[U+Xe*2>>1];if(Fe==0)break;Ue+=String.fromCharCode(Fe)}return Ue}function p0(U,X,ee){if(ee===void 0&&(ee=2147483647),ee<2)return 0;ee-=2;for(var Te=X,Ae=ee<U.length*2?ee/2:U.length,Ue=0;Ue<Ae;++Ue){var Xe=U.charCodeAt(Ue);H[X>>1]=Xe,X+=2}return H[X>>1]=0,X-Te}function _0(U){return U.length*2}function m0(U,X){for(var ee=0,Te="";!(ee>=X/4);){var Ae=ae[U+ee*4>>2];if(Ae==0)break;if(++ee,Ae>=65536){var Ue=Ae-65536;Te+=String.fromCharCode(55296|Ue>>10,56320|Ue&1023)}else Te+=String.fromCharCode(Ae)}return Te}function g0(U,X,ee){if(ee===void 0&&(ee=2147483647),ee<4)return 0;for(var Te=X,Ae=Te+ee-4,Ue=0;Ue<U.length;++Ue){var Xe=U.charCodeAt(Ue);if(Xe>=55296&&Xe<=57343){var Fe=U.charCodeAt(++Ue);Xe=65536+((Xe&1023)<<10)|Fe&1023}if(ae[X>>2]=Xe,X+=4,X+4>Ae)break}return ae[X>>2]=0,X-Te}function E0(U){for(var X=0,ee=0;ee<U.length;++ee){var Te=U.charCodeAt(ee);Te>=55296&&Te<=57343&&++ee,X+=4}return X}function v0(U,X,ee){ee=Sr(ee);var Te,Ae,Ue,Xe,Fe;X===2?(Te=d0,Ae=p0,Xe=_0,Ue=()=>ue,Fe=1):X===4&&(Te=m0,Ae=g0,Xe=E0,Ue=()=>le,Fe=2),Ir(U,{name:ee,fromWireType:function(Oe){for(var ut=le[Oe>>2],pi=Ue(),kt,Si=Oe+4,Ls=0;Ls<=ut;++Ls){var Ps=Oe+4+Ls*X;if(Ls==ut||pi[Ps>>Fe]==0){var Na=Ps-Si,$s=Te(Si,Na);kt===void 0?kt=$s:(kt+="\0",kt+=$s),Si=Ps+X}}return yn(Oe),kt},toWireType:function(Oe,ut){typeof ut!="string"&&ur("Cannot pass non-string to C++ string type "+ee);var pi=Xe(ut),kt=Qh(4+pi+X);return le[kt>>2]=pi>>Fe,Ae(ut,kt+4,pi+X),Oe!==null&&Oe.push(yn,kt),kt},argPackAdvance:8,readValueFromPointer:yi,destructorFunction:function(Oe){yn(Oe)}})}function S0(U,X,ee,Te,Ae,Ue){Ht[U]={name:Sr(X),rawConstructor:xl(ee,Te),rawDestructor:xl(Ae,Ue),elements:[]}}function T0(U,X,ee,Te,Ae,Ue,Xe,Fe,Oe){Ht[U].elements.push({getterReturnType:X,getter:xl(ee,Te),getterContext:Ae,setterArgumentType:Ue,setter:xl(Xe,Fe),setterContext:Oe})}function x0(U,X){X=Sr(X),Ir(U,{isVoid:!0,name:X,argPackAdvance:0,fromWireType:function(){},toWireType:function(ee,Te){}})}var C0=!0;function A0(){return C0}var I0={};function y0(U){var X=I0[U];return X===void 0?Sr(U):X}var Zh=[];function b0(U,X,ee,Te){U=Zh[U],X=qh.toValue(X),ee=y0(ee),U(X,ee,null,Te)}function R0(U){var X=Zh.length;return Zh.push(U),X}function P0(U,X){for(var ee=new Array(U),Te=0;Te<U;++Te)ee[Te]=P_(le[X+Te*d>>2],"parameter "+Te);return ee}var N_=[];function M0(U,X){var ee=P0(U,X),Te=ee[0],Ae=Te.name+"_$"+ee.slice(1).map(function(Ps){return Ps.name}).join("_")+"$",Ue=N_[Ae];if(Ue!==void 0)return Ue;for(var Xe=["retType"],Fe=[Te],Oe="",ut=0;ut<U-1;++ut)Oe+=(ut!==0?", ":"")+"arg"+ut,Xe.push("argType"+ut),Fe.push(ee[1+ut]);for(var pi=Di("methodCaller_"+Ae),kt="return function "+pi+`(handle, name, destructors, args) {
`,Si=0,ut=0;ut<U-1;++ut)kt+="    var arg"+ut+" = argType"+ut+".readValueFromPointer(args"+(Si?"+"+Si:"")+`);
`,Si+=ee[ut+1].argPackAdvance;kt+="    var rv = handle[name]("+Oe+`);
`;for(var ut=0;ut<U-1;++ut)ee[ut+1].deleteObject&&(kt+="    argType"+ut+".deleteObject(arg"+ut+`);
`);Te.isVoid||(kt+=`    return retType.toWireType(destructors, rv);
`),kt+=`};
`,Xe.push(kt);var Ls=M_(Function,Xe).apply(null,Fe);return Ue=R0(Ls),N_[Ae]=Ue,Ue}function D0(){be("")}function O0(){return Date.now()}function L_(){return 2147483648}function N0(){return L_()}var F_;F_=()=>performance.now();function L0(U,X,ee){W.copyWithin(U,X,X+ee)}function F0(U){try{return g.grow(U-D.byteLength+65535>>>16),j(g.buffer),1}catch{}}function w0(U){var X=W.length;U=U>>>0;var ee=L_();if(U>ee)return!1;let Te=(Oe,ut)=>Oe+(ut-Oe%ut)%ut;for(var Ae=1;Ae<=4;Ae*=2){var Ue=X*(1+.2/Ae);Ue=Math.min(Ue,U+100663296);var Xe=Math.min(ee,Te(Math.max(U,Ue),65536)),Fe=F0(Xe);if(Fe)return!0}return!1}var B0=[null,[],[]];function V0(U,X){var ee=B0[U];X===0||X===10?((U===1?h:f)(A(ee,0)),ee.length=0):ee.push(X)}function U0(U,X,ee,Te){for(var Ae=0,Ue=0;Ue<ee;Ue++){var Xe=le[X>>2],Fe=le[X+4>>2];X+=8;for(var Oe=0;Oe<Fe;Oe++)V0(U,W[Xe+Oe]);Ae+=Fe}return le[Te>>2]=Ae,0}function k0(U){v=U,ve()||(t.onExit&&t.onExit(U),E=!0),a(U,new dt(U))}function G0(U,X){v=U,k0(U)}Ma=t.InternalError=In(Error,"InternalError"),Bc(),Tl=t.BindingError=In(Error,"BindingError"),qb(),D_=t.UnboundTypeError=In(Error,"UnboundTypeError");var w_={_embind_finalize_value_array:vr,_embind_register_bigint:Vc,_embind_register_bool:ea,_embind_register_emval:Zb,_embind_register_enum:e0,_embind_register_enum_value:t0,_embind_register_float:r0,_embind_register_function:c0,_embind_register_integer:u0,_embind_register_memory_view:h0,_embind_register_std_string:f0,_embind_register_std_wstring:v0,_embind_register_value_array:S0,_embind_register_value_array_element:T0,_embind_register_void:x0,_emscripten_get_now_is_monotonic:A0,_emval_call_void_method:b0,_emval_decref:y_,_emval_get_method_caller:M0,abort:D0,emscripten_date_now:O0,emscripten_get_heap_max:N0,emscripten_get_now:F_,emscripten_memcpy_big:L0,emscripten_resize_heap:w0,fd_write:U0};it(),t.___wasm_call_ctors=function(){return(t.___wasm_call_ctors=t.asm.__wasm_call_ctors).apply(null,arguments)},t._HP_GetStatistics=function(){return(t._HP_GetStatistics=t.asm.HP_GetStatistics).apply(null,arguments)},t._HP_Shape_CreateSphere=function(){return(t._HP_Shape_CreateSphere=t.asm.HP_Shape_CreateSphere).apply(null,arguments)},t._HP_Shape_CreateCapsule=function(){return(t._HP_Shape_CreateCapsule=t.asm.HP_Shape_CreateCapsule).apply(null,arguments)},t._HP_Shape_CreateCylinder=function(){return(t._HP_Shape_CreateCylinder=t.asm.HP_Shape_CreateCylinder).apply(null,arguments)},t._HP_Shape_CreateBox=function(){return(t._HP_Shape_CreateBox=t.asm.HP_Shape_CreateBox).apply(null,arguments)},t._HP_Shape_CreateConvexHull=function(){return(t._HP_Shape_CreateConvexHull=t.asm.HP_Shape_CreateConvexHull).apply(null,arguments)},t._HP_Shape_CreateMesh=function(){return(t._HP_Shape_CreateMesh=t.asm.HP_Shape_CreateMesh).apply(null,arguments)},t._HP_Shape_CreateHeightField=function(){return(t._HP_Shape_CreateHeightField=t.asm.HP_Shape_CreateHeightField).apply(null,arguments)},t._HP_Shape_CreateContainer=function(){return(t._HP_Shape_CreateContainer=t.asm.HP_Shape_CreateContainer).apply(null,arguments)},t._HP_Shape_Release=function(){return(t._HP_Shape_Release=t.asm.HP_Shape_Release).apply(null,arguments)},t._HP_Shape_GetType=function(){return(t._HP_Shape_GetType=t.asm.HP_Shape_GetType).apply(null,arguments)},t._HP_Shape_AddChild=function(){return(t._HP_Shape_AddChild=t.asm.HP_Shape_AddChild).apply(null,arguments)},t._HP_Shape_RemoveChild=function(){return(t._HP_Shape_RemoveChild=t.asm.HP_Shape_RemoveChild).apply(null,arguments)},t._HP_Shape_GetNumChildren=function(){return(t._HP_Shape_GetNumChildren=t.asm.HP_Shape_GetNumChildren).apply(null,arguments)},t._HP_Shape_GetChildShape=function(){return(t._HP_Shape_GetChildShape=t.asm.HP_Shape_GetChildShape).apply(null,arguments)},t._HP_Shape_SetChildQSTransform=function(){return(t._HP_Shape_SetChildQSTransform=t.asm.HP_Shape_SetChildQSTransform).apply(null,arguments)},t._HP_Shape_GetChildQSTransform=function(){return(t._HP_Shape_GetChildQSTransform=t.asm.HP_Shape_GetChildQSTransform).apply(null,arguments)},t._HP_Shape_SetFilterInfo=function(){return(t._HP_Shape_SetFilterInfo=t.asm.HP_Shape_SetFilterInfo).apply(null,arguments)},t._HP_Shape_GetFilterInfo=function(){return(t._HP_Shape_GetFilterInfo=t.asm.HP_Shape_GetFilterInfo).apply(null,arguments)},t._HP_Shape_SetMaterial=function(){return(t._HP_Shape_SetMaterial=t.asm.HP_Shape_SetMaterial).apply(null,arguments)},t._HP_Shape_GetMaterial=function(){return(t._HP_Shape_GetMaterial=t.asm.HP_Shape_GetMaterial).apply(null,arguments)},t._HP_Shape_SetDensity=function(){return(t._HP_Shape_SetDensity=t.asm.HP_Shape_SetDensity).apply(null,arguments)},t._HP_Shape_GetDensity=function(){return(t._HP_Shape_GetDensity=t.asm.HP_Shape_GetDensity).apply(null,arguments)},t._HP_Shape_GetBoundingBox=function(){return(t._HP_Shape_GetBoundingBox=t.asm.HP_Shape_GetBoundingBox).apply(null,arguments)},t._HP_Shape_CastRay=function(){return(t._HP_Shape_CastRay=t.asm.HP_Shape_CastRay).apply(null,arguments)},t._HP_Shape_BuildMassProperties=function(){return(t._HP_Shape_BuildMassProperties=t.asm.HP_Shape_BuildMassProperties).apply(null,arguments)},t._HP_ShapePathIterator_GetNext=function(){return(t._HP_ShapePathIterator_GetNext=t.asm.HP_ShapePathIterator_GetNext).apply(null,arguments)},t._HP_Shape_SetTrigger=function(){return(t._HP_Shape_SetTrigger=t.asm.HP_Shape_SetTrigger).apply(null,arguments)},t._HP_Shape_CreateDebugDisplayGeometry=function(){return(t._HP_Shape_CreateDebugDisplayGeometry=t.asm.HP_Shape_CreateDebugDisplayGeometry).apply(null,arguments)},t._HP_DebugGeometry_GetInfo=function(){return(t._HP_DebugGeometry_GetInfo=t.asm.HP_DebugGeometry_GetInfo).apply(null,arguments)},t._HP_DebugGeometry_Release=function(){return(t._HP_DebugGeometry_Release=t.asm.HP_DebugGeometry_Release).apply(null,arguments)},t._HP_Body_Create=function(){return(t._HP_Body_Create=t.asm.HP_Body_Create).apply(null,arguments)},t._HP_Body_Release=function(){return(t._HP_Body_Release=t.asm.HP_Body_Release).apply(null,arguments)},t._HP_Body_SetShape=function(){return(t._HP_Body_SetShape=t.asm.HP_Body_SetShape).apply(null,arguments)},t._HP_Body_GetShape=function(){return(t._HP_Body_GetShape=t.asm.HP_Body_GetShape).apply(null,arguments)},t._HP_Body_SetMotionType=function(){return(t._HP_Body_SetMotionType=t.asm.HP_Body_SetMotionType).apply(null,arguments)},t._HP_Body_GetMotionType=function(){return(t._HP_Body_GetMotionType=t.asm.HP_Body_GetMotionType).apply(null,arguments)},t._HP_Body_SetEventMask=function(){return(t._HP_Body_SetEventMask=t.asm.HP_Body_SetEventMask).apply(null,arguments)},t._HP_Body_GetEventMask=function(){return(t._HP_Body_GetEventMask=t.asm.HP_Body_GetEventMask).apply(null,arguments)},t._HP_Body_SetMassProperties=function(){return(t._HP_Body_SetMassProperties=t.asm.HP_Body_SetMassProperties).apply(null,arguments)},t._HP_Body_GetMassProperties=function(){return(t._HP_Body_GetMassProperties=t.asm.HP_Body_GetMassProperties).apply(null,arguments)},t._HP_Body_SetLinearDamping=function(){return(t._HP_Body_SetLinearDamping=t.asm.HP_Body_SetLinearDamping).apply(null,arguments)},t._HP_Body_GetLinearDamping=function(){return(t._HP_Body_GetLinearDamping=t.asm.HP_Body_GetLinearDamping).apply(null,arguments)},t._HP_Body_SetAngularDamping=function(){return(t._HP_Body_SetAngularDamping=t.asm.HP_Body_SetAngularDamping).apply(null,arguments)},t._HP_Body_GetAngularDamping=function(){return(t._HP_Body_GetAngularDamping=t.asm.HP_Body_GetAngularDamping).apply(null,arguments)},t._HP_Body_SetGravityFactor=function(){return(t._HP_Body_SetGravityFactor=t.asm.HP_Body_SetGravityFactor).apply(null,arguments)},t._HP_Body_GetGravityFactor=function(){return(t._HP_Body_GetGravityFactor=t.asm.HP_Body_GetGravityFactor).apply(null,arguments)},t._HP_Body_GetWorld=function(){return(t._HP_Body_GetWorld=t.asm.HP_Body_GetWorld).apply(null,arguments)},t._HP_Body_SetPosition=function(){return(t._HP_Body_SetPosition=t.asm.HP_Body_SetPosition).apply(null,arguments)},t._HP_Body_GetPosition=function(){return(t._HP_Body_GetPosition=t.asm.HP_Body_GetPosition).apply(null,arguments)},t._HP_Body_SetOrientation=function(){return(t._HP_Body_SetOrientation=t.asm.HP_Body_SetOrientation).apply(null,arguments)},t._HP_Body_GetOrientation=function(){return(t._HP_Body_GetOrientation=t.asm.HP_Body_GetOrientation).apply(null,arguments)},t._HP_Body_SetQTransform=function(){return(t._HP_Body_SetQTransform=t.asm.HP_Body_SetQTransform).apply(null,arguments)},t._HP_Body_GetWorldTransformOffset=function(){return(t._HP_Body_GetWorldTransformOffset=t.asm.HP_Body_GetWorldTransformOffset).apply(null,arguments)},t._HP_Body_GetQTransform=function(){return(t._HP_Body_GetQTransform=t.asm.HP_Body_GetQTransform).apply(null,arguments)},t._HP_Body_SetLinearVelocity=function(){return(t._HP_Body_SetLinearVelocity=t.asm.HP_Body_SetLinearVelocity).apply(null,arguments)},t._HP_Body_GetLinearVelocity=function(){return(t._HP_Body_GetLinearVelocity=t.asm.HP_Body_GetLinearVelocity).apply(null,arguments)},t._HP_Body_SetAngularVelocity=function(){return(t._HP_Body_SetAngularVelocity=t.asm.HP_Body_SetAngularVelocity).apply(null,arguments)},t._HP_Body_GetAngularVelocity=function(){return(t._HP_Body_GetAngularVelocity=t.asm.HP_Body_GetAngularVelocity).apply(null,arguments)},t._HP_Body_ApplyImpulse=function(){return(t._HP_Body_ApplyImpulse=t.asm.HP_Body_ApplyImpulse).apply(null,arguments)},t._HP_Body_ApplyAngularImpulse=function(){return(t._HP_Body_ApplyAngularImpulse=t.asm.HP_Body_ApplyAngularImpulse).apply(null,arguments)},t._HP_Body_SetTargetQTransform=function(){return(t._HP_Body_SetTargetQTransform=t.asm.HP_Body_SetTargetQTransform).apply(null,arguments)},t._HP_Body_SetActivationState=function(){return(t._HP_Body_SetActivationState=t.asm.HP_Body_SetActivationState).apply(null,arguments)},t._HP_Body_GetActivationState=function(){return(t._HP_Body_GetActivationState=t.asm.HP_Body_GetActivationState).apply(null,arguments)},t._HP_Body_SetActivationControl=function(){return(t._HP_Body_SetActivationControl=t.asm.HP_Body_SetActivationControl).apply(null,arguments)},t._HP_Body_SetActivationPriority=function(){return(t._HP_Body_SetActivationPriority=t.asm.HP_Body_SetActivationPriority).apply(null,arguments)},t._HP_Constraint_Create=function(){return(t._HP_Constraint_Create=t.asm.HP_Constraint_Create).apply(null,arguments)},t._HP_Constraint_Release=function(){return(t._HP_Constraint_Release=t.asm.HP_Constraint_Release).apply(null,arguments)},t._HP_Constraint_SetParentBody=function(){return(t._HP_Constraint_SetParentBody=t.asm.HP_Constraint_SetParentBody).apply(null,arguments)},t._HP_Constraint_GetParentBody=function(){return(t._HP_Constraint_GetParentBody=t.asm.HP_Constraint_GetParentBody).apply(null,arguments)},t._HP_Constraint_SetChildBody=function(){return(t._HP_Constraint_SetChildBody=t.asm.HP_Constraint_SetChildBody).apply(null,arguments)},t._HP_Constraint_GetChildBody=function(){return(t._HP_Constraint_GetChildBody=t.asm.HP_Constraint_GetChildBody).apply(null,arguments)},t._HP_Constraint_SetAnchorInParent=function(){return(t._HP_Constraint_SetAnchorInParent=t.asm.HP_Constraint_SetAnchorInParent).apply(null,arguments)},t._HP_Constraint_SetAnchorInChild=function(){return(t._HP_Constraint_SetAnchorInChild=t.asm.HP_Constraint_SetAnchorInChild).apply(null,arguments)},t._HP_Constraint_SetCollisionsEnabled=function(){return(t._HP_Constraint_SetCollisionsEnabled=t.asm.HP_Constraint_SetCollisionsEnabled).apply(null,arguments)},t._HP_Constraint_GetCollisionsEnabled=function(){return(t._HP_Constraint_GetCollisionsEnabled=t.asm.HP_Constraint_GetCollisionsEnabled).apply(null,arguments)},t._HP_Constraint_SetEnabled=function(){return(t._HP_Constraint_SetEnabled=t.asm.HP_Constraint_SetEnabled).apply(null,arguments)},t._HP_Constraint_GetEnabled=function(){return(t._HP_Constraint_GetEnabled=t.asm.HP_Constraint_GetEnabled).apply(null,arguments)},t._HP_Constraint_SetAxisMinLimit=function(){return(t._HP_Constraint_SetAxisMinLimit=t.asm.HP_Constraint_SetAxisMinLimit).apply(null,arguments)},t._HP_Constraint_GetAxisMinLimit=function(){return(t._HP_Constraint_GetAxisMinLimit=t.asm.HP_Constraint_GetAxisMinLimit).apply(null,arguments)},t._HP_Constraint_SetAxisMaxLimit=function(){return(t._HP_Constraint_SetAxisMaxLimit=t.asm.HP_Constraint_SetAxisMaxLimit).apply(null,arguments)},t._HP_Constraint_GetAxisMaxLimit=function(){return(t._HP_Constraint_GetAxisMaxLimit=t.asm.HP_Constraint_GetAxisMaxLimit).apply(null,arguments)},t._HP_Constraint_GetAxisMode=function(){return(t._HP_Constraint_GetAxisMode=t.asm.HP_Constraint_GetAxisMode).apply(null,arguments)},t._HP_Constraint_SetAxisMode=function(){return(t._HP_Constraint_SetAxisMode=t.asm.HP_Constraint_SetAxisMode).apply(null,arguments)},t._HP_Constraint_SetAxisFriction=function(){return(t._HP_Constraint_SetAxisFriction=t.asm.HP_Constraint_SetAxisFriction).apply(null,arguments)},t._HP_Constraint_GetAxisFriction=function(){return(t._HP_Constraint_GetAxisFriction=t.asm.HP_Constraint_GetAxisFriction).apply(null,arguments)},t._HP_Constraint_SetAxisMotorType=function(){return(t._HP_Constraint_SetAxisMotorType=t.asm.HP_Constraint_SetAxisMotorType).apply(null,arguments)},t._HP_Constraint_GetAxisMotorType=function(){return(t._HP_Constraint_GetAxisMotorType=t.asm.HP_Constraint_GetAxisMotorType).apply(null,arguments)},t._HP_Constraint_SetAxisMotorPositionTarget=function(){return(t._HP_Constraint_SetAxisMotorPositionTarget=t.asm.HP_Constraint_SetAxisMotorPositionTarget).apply(null,arguments)},t._HP_Constraint_GetAxisMotorPositionTarget=function(){return(t._HP_Constraint_GetAxisMotorPositionTarget=t.asm.HP_Constraint_GetAxisMotorPositionTarget).apply(null,arguments)},t._HP_Constraint_SetAxisMotorVelocityTarget=function(){return(t._HP_Constraint_SetAxisMotorVelocityTarget=t.asm.HP_Constraint_SetAxisMotorVelocityTarget).apply(null,arguments)},t._HP_Constraint_GetAxisMotorVelocityTarget=function(){return(t._HP_Constraint_GetAxisMotorVelocityTarget=t.asm.HP_Constraint_GetAxisMotorVelocityTarget).apply(null,arguments)},t._HP_Constraint_SetAxisMotorMaxForce=function(){return(t._HP_Constraint_SetAxisMotorMaxForce=t.asm.HP_Constraint_SetAxisMotorMaxForce).apply(null,arguments)},t._HP_Constraint_GetAxisMotorMaxForce=function(){return(t._HP_Constraint_GetAxisMotorMaxForce=t.asm.HP_Constraint_GetAxisMotorMaxForce).apply(null,arguments)},t._HP_Constraint_SetAxisMotorStiffness=function(){return(t._HP_Constraint_SetAxisMotorStiffness=t.asm.HP_Constraint_SetAxisMotorStiffness).apply(null,arguments)},t._HP_Constraint_GetAxisMotorStiffness=function(){return(t._HP_Constraint_GetAxisMotorStiffness=t.asm.HP_Constraint_GetAxisMotorStiffness).apply(null,arguments)},t._HP_Constraint_SetAxisMotorDamping=function(){return(t._HP_Constraint_SetAxisMotorDamping=t.asm.HP_Constraint_SetAxisMotorDamping).apply(null,arguments)},t._HP_Constraint_GetAxisMotorDamping=function(){return(t._HP_Constraint_GetAxisMotorDamping=t.asm.HP_Constraint_GetAxisMotorDamping).apply(null,arguments)},t._HP_Constraint_SetAxisStiffness=function(){return(t._HP_Constraint_SetAxisStiffness=t.asm.HP_Constraint_SetAxisStiffness).apply(null,arguments)},t._HP_Constraint_SetAxisDamping=function(){return(t._HP_Constraint_SetAxisDamping=t.asm.HP_Constraint_SetAxisDamping).apply(null,arguments)},t._HP_Constraint_SetAxisMotorTarget=function(){return(t._HP_Constraint_SetAxisMotorTarget=t.asm.HP_Constraint_SetAxisMotorTarget).apply(null,arguments)},t._HP_Constraint_GetAxisMotorTarget=function(){return(t._HP_Constraint_GetAxisMotorTarget=t.asm.HP_Constraint_GetAxisMotorTarget).apply(null,arguments)},t._HP_World_Create=function(){return(t._HP_World_Create=t.asm.HP_World_Create).apply(null,arguments)},t._HP_World_Release=function(){return(t._HP_World_Release=t.asm.HP_World_Release).apply(null,arguments)},t._HP_World_GetBodyBuffer=function(){return(t._HP_World_GetBodyBuffer=t.asm.HP_World_GetBodyBuffer).apply(null,arguments)},t._HP_World_SetGravity=function(){return(t._HP_World_SetGravity=t.asm.HP_World_SetGravity).apply(null,arguments)},t._HP_World_GetGravity=function(){return(t._HP_World_GetGravity=t.asm.HP_World_GetGravity).apply(null,arguments)},t._HP_World_AddBody=function(){return(t._HP_World_AddBody=t.asm.HP_World_AddBody).apply(null,arguments)},t._HP_World_RemoveBody=function(){return(t._HP_World_RemoveBody=t.asm.HP_World_RemoveBody).apply(null,arguments)},t._HP_World_GetNumBodies=function(){return(t._HP_World_GetNumBodies=t.asm.HP_World_GetNumBodies).apply(null,arguments)},t._HP_World_CastRayWithCollector=function(){return(t._HP_World_CastRayWithCollector=t.asm.HP_World_CastRayWithCollector).apply(null,arguments)},t._HP_World_PointProximityWithCollector=function(){return(t._HP_World_PointProximityWithCollector=t.asm.HP_World_PointProximityWithCollector).apply(null,arguments)},t._HP_World_ShapeProximityWithCollector=function(){return(t._HP_World_ShapeProximityWithCollector=t.asm.HP_World_ShapeProximityWithCollector).apply(null,arguments)},t._HP_World_ShapeCastWithCollector=function(){return(t._HP_World_ShapeCastWithCollector=t.asm.HP_World_ShapeCastWithCollector).apply(null,arguments)},t._HP_World_Step=function(){return(t._HP_World_Step=t.asm.HP_World_Step).apply(null,arguments)},t._HP_World_SetIdealStepTime=function(){return(t._HP_World_SetIdealStepTime=t.asm.HP_World_SetIdealStepTime).apply(null,arguments)},t._HP_World_SetSpeedLimit=function(){return(t._HP_World_SetSpeedLimit=t.asm.HP_World_SetSpeedLimit).apply(null,arguments)},t._HP_World_GetSpeedLimit=function(){return(t._HP_World_GetSpeedLimit=t.asm.HP_World_GetSpeedLimit).apply(null,arguments)},t._HP_World_GetNextCollisionEvent=function(){return(t._HP_World_GetNextCollisionEvent=t.asm.HP_World_GetNextCollisionEvent).apply(null,arguments)},t._HP_World_GetNextTriggerEvent=function(){return(t._HP_World_GetNextTriggerEvent=t.asm.HP_World_GetNextTriggerEvent).apply(null,arguments)},t._HP_QueryCollector_Create=function(){return(t._HP_QueryCollector_Create=t.asm.HP_QueryCollector_Create).apply(null,arguments)},t._HP_QueryCollector_Release=function(){return(t._HP_QueryCollector_Release=t.asm.HP_QueryCollector_Release).apply(null,arguments)},t._HP_QueryCollector_GetNumHits=function(){return(t._HP_QueryCollector_GetNumHits=t.asm.HP_QueryCollector_GetNumHits).apply(null,arguments)},t._HP_QueryCollector_GetCastRayResult=function(){return(t._HP_QueryCollector_GetCastRayResult=t.asm.HP_QueryCollector_GetCastRayResult).apply(null,arguments)},t._HP_QueryCollector_GetPointProximityResult=function(){return(t._HP_QueryCollector_GetPointProximityResult=t.asm.HP_QueryCollector_GetPointProximityResult).apply(null,arguments)},t._HP_QueryCollector_GetShapeProximityResult=function(){return(t._HP_QueryCollector_GetShapeProximityResult=t.asm.HP_QueryCollector_GetShapeProximityResult).apply(null,arguments)},t._HP_QueryCollector_GetShapeCastResult=function(){return(t._HP_QueryCollector_GetShapeCastResult=t.asm.HP_QueryCollector_GetShapeCastResult).apply(null,arguments)},t._main=function(){return(t._main=t.asm.main).apply(null,arguments)};var Qh=t._malloc=function(){return(Qh=t._malloc=t.asm.malloc).apply(null,arguments)},yn=t._free=function(){return(yn=t._free=t.asm.free).apply(null,arguments)};t._HP_Debug_StartRecordingStats=function(){return(t._HP_Debug_StartRecordingStats=t.asm.HP_Debug_StartRecordingStats).apply(null,arguments)},t._HP_Debug_StopRecordingStats=function(){return(t._HP_Debug_StopRecordingStats=t.asm.HP_Debug_StopRecordingStats).apply(null,arguments)},t.___errno_location=function(){return(t.___errno_location=t.asm.__errno_location).apply(null,arguments)},t._htons=function(){return(t._htons=t.asm.htons).apply(null,arguments)},t._ntohs=function(){return(t._ntohs=t.asm.ntohs).apply(null,arguments)};var B_=t.___getTypeName=function(){return(B_=t.___getTypeName=t.asm.__getTypeName).apply(null,arguments)};t.__embind_initialize_bindings=function(){return(t.__embind_initialize_bindings=t.asm._embind_initialize_bindings).apply(null,arguments)},t._htonl=function(){return(t._htonl=t.asm.htonl).apply(null,arguments)},t._setThrew=function(){return(t._setThrew=t.asm.setThrew).apply(null,arguments)},t._saveSetjmp=function(){return(t._saveSetjmp=t.asm.saveSetjmp).apply(null,arguments)},t.stackSave=function(){return(t.stackSave=t.asm.stackSave).apply(null,arguments)},t.stackRestore=function(){return(t.stackRestore=t.asm.stackRestore).apply(null,arguments)},t.stackAlloc=function(){return(t.stackAlloc=t.asm.stackAlloc).apply(null,arguments)};var kc;he=function U(){kc||V_(),kc||(he=U)};function z0(U){var X=t._main,ee=0,Te=0;try{var Ae=X(ee,Te);return G0(Ae,!0),Ae}catch(Ue){return bt(Ue)}}function V_(U){if(K>0||(Me(),K>0))return;function X(){kc||(kc=!0,t.calledRun=!0,!E&&(Re(),Pe(),i(t),t.onRuntimeInitialized&&t.onRuntimeInitialized(),U_&&z0(),ft()))}t.setStatus?(t.setStatus("Running..."),setTimeout(function(){setTimeout(function(){t.setStatus("")},1),X()},1)):X()}if(t.preInit)for(typeof t.preInit=="function"&&(t.preInit=[t.preInit]);t.preInit.length>0;)t.preInit.pop()();var U_=!0;return t.noInitialRun&&(U_=!1),V_(),e.ready}})();const _I=-9.81,EV=async n=>{const e=await gV(),t=new k1(!0,e);return n.enablePhysics(new m(0,_I,0),t),t};var qs=(n=>(n.FORWARD="forward",n.BACKWARD="backward",n.RIGHT="right",n.LEFT="left",n.JUMP="jump",n))(qs||{});const vV="gpuTransformVertexShader",SV=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
out vec3 outPosition;const mat4 identity=mat4(
vec4(1.0,0.0,0.0,0.0),
vec4(0.0,1.0,0.0,0.0),
vec4(0.0,0.0,1.0,0.0),
vec4(0.0,0.0,0.0,1.0)
);void main(void) {vec3 positionUpdated=position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
mat4 finalWorld=identity;
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);outPosition=worldPos.xyz;}`;V.ShadersStore[vV]=SV;const TV="gpuTransformPixelShader",xV=`#version 300 es
void main() {discard;}
`;V.ShadersStore[TV]=xV;class Gn{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,r={}){if(this._bindings={},this._samplers={},this._contextIsDirty=!1,this.fastMode=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=vc.UniqueId,t.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new gp),!this._engine.getCaps().supportComputeShaders){w.Error("This engine does not support compute shaders!");return}if(!r.bindingsMapping){w.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...r}}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const r=this._bindings[e];this._bindings[e]={type:i?0:4,object:t,indexInGroupEntries:r==null?void 0:r.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:1,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setExternalTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:6,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setVideoTexture(e,t){return t.externalTexture?(this.setExternalTexture(e,t.externalTexture),!0):!1}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Gn._BufferIsDataBuffer(t)?7:2,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Gn._BufferIsDataBuffer(t)?7:3,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:5,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}isReady(){let e=this._effect;for(const s in this._bindings){const a=this._bindings[s],o=a.type,l=a.object;switch(o){case 0:case 4:case 1:{if(!l.isReady())return!1;break}case 6:{if(!l.isReady())return!1;break}}}const t=[],i=this._shaderPath;if(this._options.defines)for(let s=0;s<this._options.defines.length;s++)t.push(this._options.defines[s]);const r=t.join(`
`);return this._cachedDefines!==r&&(this._cachedDefines=r,e=this._engine.createComputeEffect(i,{defines:r,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){return!this.fastMode&&!this._checkContext()?!1:(this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping,this.gpuTimeInFrame),!0)}dispatchIndirect(e,t=0){if(!this.fastMode&&!this._checkContext())return!1;const i=Gn._BufferIsDataBuffer(e)?e:e.getBuffer();return this._engine.computeDispatchIndirect(this._effect,this._context,this._bindings,i,t,this._options.bindingsMapping,this.gpuTimeInFrame),!0}_checkContext(){var e;if(!this.isReady())return!1;for(const t in this._bindings){const i=this._bindings[t];if(!this._options.bindingsMapping[t])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+t+"'");switch(i.type){case 0:{const r=this._samplers[t],s=i.object;(!r||!s._texture||!r.compareSampler(s._texture))&&(this._samplers[t]=new GS().setParameters(s.wrapU,s.wrapV,s.wrapR,s.anisotropicFilteringLevel,s._texture.samplingMode,(e=s._texture)==null?void 0:e._comparisonFunction),this._contextIsDirty=!0);break}case 6:{this._contextIsDirty=!0;break}case 2:{const r=i.object;r.getBuffer()!==i.buffer&&(i.buffer=r.getBuffer(),this._contextIsDirty=!0);break}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),!0}dispatchWhenReady(e,t,i,r=10){return new Promise(s=>{const a=()=>{this.dispatch(e,t,i)?s():setTimeout(a,r)};a()})}serialize(){const e=Ke.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],r=i.object;switch(i.type){case 0:case 4:case 1:{const s=r.serialize();s&&(e.textures[t]=s,e.bindings[t]={type:i.type});break}}}return e}static Parse(e,t,i){const r=Ke.Parse(()=>new Gn(e.name,t.getEngine(),e.shaderPath,e.options),e,t,i);for(const s in e.textures){const a=e.bindings[s],o=Z.Parse(e.textures[s],t,i);a.type===0?r.setTexture(s,o):a.type===4?r.setTexture(s,o,!1):r.setStorageTexture(s,o)}return r}static _BufferIsDataBuffer(e){return e.underlyingResource!==void 0}}I([M()],Gn.prototype,"name",void 0);I([M()],Gn.prototype,"fastMode",void 0);$("BABYLON.ComputeShader",Gn);class CV{constructor(e,t,i=3,r){this._engine=e,this._label=r,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i,r){return this._engine.readFromStorageBuffer(this._buffer,e,t,i,r)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}const AV="boundingInfoComputeShader",IV=`struct Results {minX : atomic<i32>,
minY : atomic<i32>,
minZ : atomic<i32>,
maxX : atomic<i32>,
maxY : atomic<i32>,
maxZ : atomic<i32>,
dummy1 : i32,
dummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}
fn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}
fn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
const identity=mat4x4f(
vec4f(1.0,0.0,0.0,0.0),
vec4f(0.0,1.0,0.0,0.0),
vec4f(0.0,0.0,1.0,0.0),
vec4f(0.0,0.0,0.0,1.0)
);struct Settings {morphTargetTextureInfo: vec3f,
morphTargetCount: i32,
indexResult : u32,};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;
#if NUM_BONE_INFLUENCERS>0
@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;
#if NUM_BONE_INFLUENCERS>4
@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;
#endif
#endif
#ifdef MORPHTARGETS
@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;
#endif
#ifdef MORPHTARGETS
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}
#endif
@compute @workgroup_size(256,1,1)
fn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}
let position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
let matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;
#endif 
#endif 
finalWorld=finalWorld*influence;
#endif
#ifdef MORPHTARGETS
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=settings.morphTargetCount) {break;}
positionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}
#endif
var worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}
`;V.ShadersStoreWGSL[AV]=IV;class Bu{constructor(e,t,i,r,s,a){this.entries=[],this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=s,this._creationFunc=a,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(hs.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(hs.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let s=0;s<this.blocks.length;s++)this.blocks[s].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){Bu._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,s,a,o,l){o.blocks=new Array;const c=new m((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let u=0;u<2;u++)for(let h=0;h<2;h++)for(let f=0;f<2;f++){const d=e.add(c.multiplyByFloats(u,h,f)),p=e.add(c.multiplyByFloats(u+1,h+1,f+1)),_=new Bu(d,p,r,s+1,a,l);_.addEntries(i),o.blocks.push(_)}}}class sl{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=t||64,this._selectionContent=new na(1024),this._creationFunc=e}update(e,t,i){Bu._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}sl.CreationFuncForMeshes=(n,e)=>{const t=n.getBoundingInfo();!n.isBlocked&&t.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(n)};sl.CreationFuncForSubMeshes=(n,e)=>{n.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(n)};ht.prototype.createOrUpdateSelectionOctree=function(n=64,e=2){let t=this._getComponent(we.NAME_OCTREE);t||(t=new mI(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new sl(sl.CreationFuncForMeshes,n,e));const i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree};Object.defineProperty(ht.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});$t.prototype.createOrUpdateSubmeshesOctree=function(n=64,e=2){const t=this.getScene();let i=t._getComponent(we.NAME_OCTREE);i||(i=new mI(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new sl(sl.CreationFuncForSubMeshes,n,e)),this.computeWorldMatrix(!0);const s=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(s.minimumWorld,s.maximumWorld,this.subMeshes),this._submeshesOctree};class mI{constructor(e){this.name=we.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new yt(m.Zero(),new m(1,1,1)),e=e||$e.LastCreatedScene,e&&(this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=t=>this.getActiveSubMeshCandidates(t),this.scene.getCollidingSubMeshCandidates=(t,i)=>this.getCollidingSubMeshCandidates(t,i),this.scene.getIntersectingSubMeshCandidates=(t,i)=>this.getIntersectingSubMeshCandidates(t,i))}register(){this.scene.onMeshRemovedObservable.add(e=>{const t=this.scene.selectionOctree;if(t!=null){const i=t.dynamicContent.indexOf(e);i!==-1&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{const t=this.scene.selectionOctree;t!=null&&t.addMesh(e)})}getActiveMeshCandidates(){var e;return((e=this.scene._selectionOctree)==null?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(yt.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}const JE=(n,e,t,i)=>{var o;const r=new yt(n.position,m.Down(),8),s=l=>{let c=!1;return l.name===t.name&&(c=!0),Object.values(i).forEach(u=>{if(l.name===u.name){c=!0;return}}),c},a=n.getScene().pickWithRay(r,s,!0);return a!=null&&a.hit?n.walkingOnMeshName=((o=a==null?void 0:a.pickedMesh)==null?void 0:o.name)||e.name:n.walkingOnMeshName=e.name,a};class Nr{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if((e=q.audioEngine)!=null&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:q.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,r=null,s){var a;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new Q,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=m.Zero(),this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||$e.LastCreatedScene,!!i)if(this._scene=i,Nr._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=(o,l,c,u,h)=>l<c?o*(1-l/c):0,s&&(this.autoplay=s.autoplay||!1,this._loop=s.loop||!1,s.volume!==void 0&&(this._volume=s.volume),this._spatialSound=s.spatialSound??!1,this.maxDistance=s.maxDistance??100,this.useCustomAttenuation=s.useCustomAttenuation??!1,this.rolloffFactor=s.rolloffFactor||1,this.refDistance=s.refDistance||1,this.distanceModel=s.distanceModel||"linear",this._playbackRate=s.playbackRate||1,this._streaming=s.streaming??!1,this._length=s.length,this._offset=s.offset),(a=q.audioEngine)!=null&&a.canUseWebAudio&&q.audioEngine.audioContext){this._soundGain=q.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let o=!0;if(t)try{typeof t=="string"?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let l=[],c=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=q.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=q.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(c=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":l.push(t);case"Array":l.length===0&&(l=t);for(let u=0;u<l.length;u++){const h=l[u];if(c=s&&s.skipCodecCheck||h.indexOf(".mp3",h.length-4)!==-1&&q.audioEngine.isMP3supported||h.indexOf(".ogg",h.length-4)!==-1&&q.audioEngine.isOGGsupported||h.indexOf(".wav",h.length-4)!==-1||h.indexOf(".m4a",h.length-4)!==-1||h.indexOf(".mp4",h.length-4)!==-1||h.indexOf("blob:")!==-1,c){this._streaming?(this._htmlAudioElement=new Audio(h),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,J.SetCorsBehavior(h,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(h,f=>{this._soundLoaded(f)},void 0,!0,!0,f=>{f&&w.Error("XHR "+f.status+" error on: "+h+"."),w.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:o=!1;break}o?c||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):w.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{w.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),q.audioEngine&&!q.audioEngine.WarnedWebAudioUnsupported&&(w.Error("Web Audio is not supported by your browser."),q.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;(e=q.audioEngine)!=null&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;(t=q.audioEngine)!=null&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;(t=q.audioEngine)!=null&&t.audioContext&&q.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{w.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;(t=q.audioEngine)!=null&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e;(e=q.audioEngine)!=null&&e.canUseWebAudio&&q.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??q.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,(e=this._soundPanner)==null||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;(e=q.audioEngine)!=null&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){w.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){w.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){w.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=m.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if((e=q.audioEngine)!=null&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var r,s,a,o;if(this._isReadyToPlay&&this._scene.audioEnabled&&((r=q.audioEngine)!=null&&r.audioContext))try{this._clearTimeoutsAndObservers();let l=e?((s=q.audioEngine)==null?void 0:s.audioContext.currentTime)+e:(a=q.audioEngine)==null?void 0:a.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=q.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){const c=()=>{var u,h;if((u=q.audioEngine)!=null&&u.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=t??0;const f=this._htmlAudioElement.play();f!==void 0&&f.catch(()=>{var d,p;(d=q.audioEngine)==null||d.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(p=q.audioEngine)==null?void 0:p.onAudioUnlockedObservable.addOnce(()=>{c()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(h=q.audioEngine)==null?void 0:h.onAudioUnlockedObservable.addOnce(()=>{c()}))};c()}}else{const c=()=>{var u,h,f;if((u=q.audioEngine)!=null&&u.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const d=this._soundSource;d.onended=()=>{d.disconnect()}}if(this._soundSource=(h=q.audioEngine)==null?void 0:h.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((f=q.audioEngine)==null?void 0:f.audioContext.currentTime)+e:q.audioEngine.audioContext.currentTime;const d=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(l,d,this.loop?void 0:i)}}};((o=q.audioEngine)==null?void 0:o.audioContext.state)==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{var u;((u=q.audioEngine)==null?void 0:u.audioContext.state)==="suspended"?(q.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=q.audioEngine.onAudioUnlockedObservable.addOnce(()=>{c()}))):c()},500):c()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){w.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t,i;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):(t=this._streamingSource)==null||t.disconnect(),this.isPlaying=!1;else if((i=q.audioEngine)!=null&&i.audioContext&&this._soundSource){const r=e?q.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(r)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e,t;this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():(e=this._streamingSource)==null||e.disconnect(),this.isPlaying=!1,this.isPaused=!0):(t=q.audioEngine)!=null&&t.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=q.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;(i=q.audioEngine)!=null&&i.canUseWebAudio&&this._soundGain&&(t&&q.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(q.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,q.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,q.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const r=e.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new Nr(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){const s=e.name;let a;e.url?a=i+e.url:a=i+s;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!r)l=new Nr(s,a,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);else{const c=()=>{r._isReadyToPlay?(l._audioBuffer=r.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):setTimeout(c,300)};l=new Nr(s,new ArrayBuffer(0),t,null,o),c()}if(e.position){const c=m.FromArray(e.position);l.setPosition(c)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const c=m.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(c)}if(e.connectedMeshId){const c=t.getMeshById(e.connectedMeshId);c&&l.attachToMesh(c)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&((e=q.audioEngine)==null||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}Nr._SceneComponentInitialization=n=>{throw rt("AudioSceneComponent")};$("BABYLON.Sound",Nr);class yV{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||$e.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;(e=q.audioEngine)!=null&&e.canUseWebAudio&&q.audioEngine.audioContext&&(this._outputAudioNode=q.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(q.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(q.audioEngine&&q.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){var t;(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if((e=q.audioEngine)!=null&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if((e=q.audioEngine)!=null&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,(t=q.audioEngine)!=null&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,q.audioEngine.masterGain))}}Lp(we.NAME_AUDIO,(n,e,t,i)=>{var a;let r=[],s;if(t.sounds=t.sounds||[],n.sounds!==void 0&&n.sounds!==null)for(let o=0,l=n.sounds.length;o<l;o++){const c=n.sounds[o];(a=q.audioEngine)!=null&&a.canUseWebAudio?(c.url||(c.url=c.name),r[c.url]?t.sounds.push(Nr.Parse(c,e,i,r[c.url])):(s=Nr.Parse(c,e,i),r[c.url]=s,t.sounds.push(s))):t.sounds.push(new Nr(c.name,null,e))}r=[]});Object.defineProperty(ht.prototype,"mainSoundTrack",{get:function(){let n=this._getComponent(we.NAME_AUDIO);return n||(n=new ts(this),this._addComponent(n)),this._mainSoundTrack||(this._mainSoundTrack=new yV(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});ht.prototype.getSoundByName=function(n){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===n)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===n)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(ht.prototype,"audioEnabled",{get:function(){let n=this._getComponent(we.NAME_AUDIO);return n||(n=new ts(this),this._addComponent(n)),n.audioEnabled},set:function(n){let e=this._getComponent(we.NAME_AUDIO);e||(e=new ts(this),this._addComponent(e)),n?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(ht.prototype,"headphone",{get:function(){let n=this._getComponent(we.NAME_AUDIO);return n||(n=new ts(this),this._addComponent(n)),n.headphone},set:function(n){let e=this._getComponent(we.NAME_AUDIO);e||(e=new ts(this),this._addComponent(e)),n?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(ht.prototype,"audioListenerPositionProvider",{get:function(){let n=this._getComponent(we.NAME_AUDIO);return n||(n=new ts(this),this._addComponent(n)),n.audioListenerPositionProvider},set:function(n){let e=this._getComponent(we.NAME_AUDIO);if(e||(e=new ts(this),this._addComponent(e)),n&&typeof n!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=n},enumerable:!0,configurable:!0});Object.defineProperty(ht.prototype,"audioListenerRotationProvider",{get:function(){let n=this._getComponent(we.NAME_AUDIO);return n||(n=new ts(this),this._addComponent(n)),n.audioListenerRotationProvider},set:function(n){let e=this._getComponent(we.NAME_AUDIO);if(e||(e=new ts(this),this._addComponent(e)),n&&typeof n!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=n},enumerable:!0,configurable:!0});Object.defineProperty(ht.prototype,"audioPositioningRefreshRate",{get:function(){let n=this._getComponent(we.NAME_AUDIO);return n||(n=new ts(this),this._addComponent(n)),n.audioPositioningRefreshRate},set:function(n){let e=this._getComponent(we.NAME_AUDIO);e||(e=new ts(this),this._addComponent(e)),e.audioPositioningRefreshRate=n},enumerable:!0,configurable:!0});class ts{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=we.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new m,this._cachedCameraPosition=new m,this._lastCheck=0,this._invertMatrixTemp=new O,this._cameraDirectionTemp=new m,e=e||$e.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(we.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;this._audioEnabled=!1,q.audioEngine&&q.audioEngine.audioContext&&q.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;this._audioEnabled=!0,q.audioEngine&&q.audioEngine.audioContext&&q.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=Tr.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;const i=q.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){const a=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(a.x||0,a.y||0,a.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const a=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(a.x||0,a.y||0,a.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),m.TransformNormalToRef(ts._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let s;for(s=0;s<t.mainSoundTrack.soundCollection.length;s++){const a=t.mainSoundTrack.soundCollection[s];a.useCustomAttenuation&&a.updateDistanceFromListener()}if(t.soundTracks)for(s=0;s<t.soundTracks.length;s++)for(let a=0;a<t.soundTracks[s].soundCollection.length;a++){const o=t.soundTracks[s].soundCollection[a];o.useCustomAttenuation&&o.updateDistanceFromListener()}}}}ts._CameraDirection=new m(0,0,-1);Nr._SceneComponentInitialization=n=>{let e=n._getComponent(we.NAME_AUDIO);e||(e=new ts(n),n._addComponent(e))};const bV=n=>({walkingOnSnow:new Nr("walkingOnSnowSound","human_footsteps_snow.mp3",n,null,{loop:!1,autoplay:!1}),walkingOnIce:new Nr("walkingOnIceSound","human_footsteps_ice.mp3",n,null,{loop:!1,autoplay:!1}),walkingOnTiles:new Nr("walkingOnTilesSound","human_footsteps_tiles.mp3",n,null,{loop:!1,autoplay:!1}),fallingOnSnow:new Nr("fallingOnSnowSound","human_falling_snow.mp3",n,null,{loop:!1,autoplay:!1}),fallingOnIce:new Nr("fallingOnIceSound","human_falling_ice.mp3",n,null,{loop:!1,autoplay:!1})}),RV=(n,e,t,i)=>{const r=bV(n.getScene());let s=!1,a=null;const o=h=>{s||(s=!0,h.play(),h.onended=()=>{s=!1})},l=()=>{Object.values(r).forEach(h=>{h.stop()})};return{stop:l,moving:()=>{if(n.isMoving){if(a!==n.walkingOnMeshName&&l(),n.walkingOnMeshName===e.name){a=n.walkingOnMeshName,o(r.walkingOnSnow);return}if(n.walkingOnMeshName===t.name){a=n.walkingOnMeshName,o(r.walkingOnIce);return}if(i[n.walkingOnMeshName]){a=n.walkingOnMeshName,o(r.walkingOnTiles);return}}},touchDown:()=>{if(n.walkingOnMeshName===e.name){o(r.fallingOnSnow);return}if(n.walkingOnMeshName===t.name){o(r.fallingOnIce);return}if(i[n.walkingOnMeshName]){o(r.walkingOnTiles);return}}}},PV=async(n,e,t,i,r)=>{const{meshes:s,skeletons:a}=await wi.ImportMeshAsync("","/ColdEscape/","Low_Poly_Male.babylon",n),o={player:null,playerHair:null};if(s.forEach(A=>{A.id==="Player"&&(o.player=A),A.id==="Hair"&&(o.playerHair=A)}),!o.player)throw new Error("Player Mesh not found");o.playerHair&&o.player.addChild(o.playerHair);let l=a_("player",{height:8.5,radius:2},n);l.bakeCurrentTransformIntoVertices(),l.isVisible=!1,l.addChild(o.player);const c=()=>{const A=e.getHeightAtCoordinates(l.position.x,l.position.z);return A<i.position.y?i.position.y+3.8:A+3.8};l.position.set(0,c(),-100),l.playerPhysics=new tl(l,va.CAPSULE,{mass:1,restitution:0,friction:.5},n),l.playerPhysics.body.disablePreStep=!1,l.playerPhysics.body.setMotionType(gd.DYNAMIC),l.playerPhysics.body.setMassProperties({mass:60,inertia:m.ZeroReadOnly});const u=a[0],h=mV(l,u);h.actions.onIdle();const f=RV(l,e,i,r);l.onMoving=({direction:A,isRunning:T})=>{A===qs.FORWARD&&h.actions.onWalkingForward(T),A===qs.BACKWARD&&h.actions.onWalkingBackward(),A===qs.LEFT&&h.actions.onStrifeLeft(T),A===qs.RIGHT&&h.actions.onStrifeRight(T),JE(l,e,i,r),f.moving()},l.onTouchDown=()=>{JE(l,e,i,r),f.touchDown()};const d={runningMultiplier:1.5,forwardSpeed:40,backwardSpeed:35,strafeSpeed:35,jumpSpeed:80},p=A=>{let T=d.forwardSpeed,C=d.strafeSpeed;const y=c();l.position.y<y&&(l.position.y=y);const P=y+1;l.isFalling&&l.position.y<=P&&l.onTouchDown(),l.isFalling=l.position.y>P;const D=l.position;let F=!1;A.Shift&&(F=!0,T=d.forwardSpeed*d.runningMultiplier,C=d.strafeSpeed*d.runningMultiplier),l.isMoving=!1;const W=[];if((A.w||A.W)&&(W.push(l.forward.scaleInPlace(-T)),l.isMoving=!0,l.onMoving({direction:qs.FORWARD,isRunning:F})),(A.s||A.S)&&(W.push(l.forward.scaleInPlace(d.backwardSpeed)),l.isMoving=!0,l.onMoving({direction:qs.BACKWARD})),(A.d||A.D)&&(W.push(l.right.scaleInPlace(-C)),l.isMoving=!0,l.onMoving({direction:qs.RIGHT,isRunning:F})),(A.a||A.A)&&(W.push(l.right.scaleInPlace(C)),l.isMoving=!0,l.onMoving({direction:qs.LEFT,isRunning:F})),A[" "]&&!l.isFalling&&(W.push(l.up.scaleInPlace(d.jumpSpeed)),l.isMoving=!0,l.isFalling=!0,l.onMoving({direction:qs.JUMP})),W.length){const H=W.reduce((ue,ae)=>(ue=ue.add(ae),ue),new m(0,l.isFalling?l.playerPhysics.body.getLinearVelocity().y:_I,0));l.playerPhysics.body.setLinearVelocity(H)}l.playerPhysics.body.setGravityFactor(l.isFalling?40:200),l.intersectsMesh(t)||(l.position=new m(D.x>0?D.x-1:D.x+1,l.position.y,D.z>0?D.z-1:D.z+1))},_=A=>{A.stopAllAnimations(),l.isMoving=!1,h.actions.onStopAllAnimations(),f.stop()},{firstViewCamera:g,thirdViewCamera:E}=dV(n,l);return{player:l,onPlayerCamera:()=>{pV(n,l,g,E)},mapPlayerMovements:p,mapPlayerStopMovements:_,onSwitchCameras:A=>{_V(n,A,g,E)}}};class MV extends Gr{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class At extends hl{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=At.StandardReflectance0*t,this.reflectionReflectance90=At.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=At.StandardReflectance0+(1-At.StandardReflectance0)*t,this.reflectionReflectance90=At.StandardReflectance90+(1-At.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=fe.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=m.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new pr(16),this._reflectionControls=We.Zero(),this._white=fe.White(),this._primaryShadowColor=fe.Black(),this._primaryHighlightColor=fe.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new MV);const s=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=s.getEngine();if(Ac(s,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,ph(s,a),a._areTexturesDirty){if(a._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&_e.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;ai(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;const l=this._reflectionTexture;if(l&&_e.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;switch(a.REFLECTION=!0,a.GAMMAREFLECTION=l.gammaSpace,a.RGBDREFLECTION=l.isRGBD,a.REFLECTIONBLUR=this._reflectionBlur>0,a.LODINREFLECTIONALPHA=l.lodLevelInAlpha,a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,l.coordinatesMode===Z.INVCUBIC_MODE&&(a.INVERTCUBICMAP=!0),a.REFLECTIONMAP_3D=l.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,l.coordinatesMode){case Z.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=!0;break;case Z.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=!0;break;case Z.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=!0;break;case Z.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=!0;break;case Z.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=!0;break;case Z.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case Z.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case Z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case Z.CUBIC_MODE:case Z.INVCUBIC_MODE:default:a.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTION=!1,a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1,a.REFLECTIONMAP_3D=!1,a.REFLECTIONMAP_SPHERICAL=!1,a.REFLECTIONMAP_PLANAR=!1,a.REFLECTIONMAP_CUBIC=!1,a.REFLECTIONMAP_PROJECTION=!1,a.REFLECTIONMAP_SKYBOX=!1,a.REFLECTIONMAP_EXPLICIT=!1,a.REFLECTIONMAP_EQUIRECTANGULAR=!1,a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,a.INVERTCUBICMAP=!1,a.REFLECTIONMAP_OPPOSITEZ=!1,a.LODINREFLECTIONALPHA=!1,a.GAMMAREFLECTION=!1,a.RGBDREFLECTION=!1}a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(a._areMiscDirty&&(a.REFLECTIONMAP_3D&&this._enableGroundProjection?(a.PROJECTED_GROUND=!0,a.REFLECTIONMAP_SKYBOX=!0):a.PROJECTED_GROUND=!1),hh(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),a),fh(s,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),dh(e,a,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(b.NormalKind)&&(e.createNormals(!0),w.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),a.isDirty){a.markAsProcessed(),s.resetCachedMaterial();const l=new co;a.FOG&&l.addFallback(0,"FOG"),a.POINTSIZE&&l.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),Mp(a,l,this._maxSimultaneousLights);const c=[b.PositionKind];a.NORMAL&&c.push(b.NormalKind),a.UV1&&c.push(b.UVKind),a.UV2&&c.push(b.UV2Kind),Pp(c,e,a,l),uh(c,a);const u=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Zn(u);const h=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],f=["Material","Scene"];It&&(It.PrepareUniforms(u,a),It.PrepareSamplers(h,a)),_h({uniformsNames:u,uniformBuffersNames:f,samplers:h,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});const d=a.toString(),p=s.getEngine().createEffect("background",{attributes:c,uniformsNames:u,uniformBuffersNames:f,samplers:h,defines:d,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([re(()=>Promise.resolve().then(()=>VV),void 0),re(()=>Promise.resolve().then(()=>eU),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>fU),void 0),re(()=>Promise.resolve().then(()=>OU),void 0)]),this._shadersLoaded=!0}},o);t.setEffect(p,a,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(a._renderId=s.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.materialDefines;if(!s)return;const a=i.effect;if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e),ul(t,this._activeEffect);const o=this._mustRebind(r,a,i,t.visibility);if(o){this._uniformBuffer.bindToEffect(a,"Material"),this.bindViewProjection(a);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||i._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&_e.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),oi(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&_e.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&_e.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&_e.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),s.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Sn(this._activeEffect,this,r),r.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(a,"Material"),this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&Cc(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(a),uo(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Qn(s,a,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return Ke.Clone(()=>new At(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return Ke.Parse(()=>new At(e.name,t),e,t,i)}}At.StandardReflectance0=.05;At.StandardReflectance90=.5;I([hi()],At.prototype,"_primaryColor",void 0);I([ie("_markAllSubMeshesAsLightsDirty")],At.prototype,"primaryColor",void 0);I([hi()],At.prototype,"__perceptualColor",void 0);I([M()],At.prototype,"_primaryColorShadowLevel",void 0);I([M()],At.prototype,"_primaryColorHighlightLevel",void 0);I([ie("_markAllSubMeshesAsLightsDirty")],At.prototype,"primaryColorHighlightLevel",null);I([Rt()],At.prototype,"_reflectionTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionTexture",void 0);I([M()],At.prototype,"_reflectionBlur",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionBlur",void 0);I([Rt()],At.prototype,"_diffuseTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"diffuseTexture",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"shadowLights",void 0);I([M()],At.prototype,"_shadowLevel",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"shadowLevel",void 0);I([Ar()],At.prototype,"_sceneCenter",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"sceneCenter",void 0);I([M()],At.prototype,"_opacityFresnel",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"opacityFresnel",void 0);I([M()],At.prototype,"_reflectionFresnel",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionFresnel",void 0);I([M()],At.prototype,"_reflectionFalloffDistance",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionFalloffDistance",void 0);I([M()],At.prototype,"_reflectionAmount",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionAmount",void 0);I([M()],At.prototype,"_reflectionReflectance0",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionReflectance0",void 0);I([M()],At.prototype,"_reflectionReflectance90",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"reflectionReflectance90",void 0);I([M()],At.prototype,"_useRGBColor",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"useRGBColor",void 0);I([M()],At.prototype,"_enableNoise",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"enableNoise",void 0);I([M()],At.prototype,"_maxSimultaneousLights",void 0);I([ie("_markAllSubMeshesAsTexturesDirty")],At.prototype,"maxSimultaneousLights",void 0);I([M()],At.prototype,"_shadowOnly",void 0);I([ie("_markAllSubMeshesAsLightsDirty")],At.prototype,"shadowOnly",void 0);I([sT()],At.prototype,"_imageProcessingConfiguration",void 0);I([M(),ie("_markAllSubMeshesAsMiscDirty")],At.prototype,"enableGroundProjection",void 0);I([M()],At.prototype,"projectedGroundRadius",void 0);I([M()],At.prototype,"projectedGroundHeight",void 0);$("BABYLON.BackgroundMaterial",At);const DV="backgroundUboDeclaration",OV=`uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos: vec2f;uniform vReflectionInfos: vec2f;uniform diffuseMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;
#include<sceneUboDeclaration>
`;V.IncludesShadersStoreWGSL[DV]=OV;const gI="lightVxUboDeclaration",EI=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[gI]=EI;const NV={name:gI,shader:EI},LV=Object.freeze(Object.defineProperty({__proto__:null,lightVxUboDeclarationWGSL:NV},Symbol.toStringTag,{value:"Module"})),vI="shadowsVertex",SI=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;
#if SHADOWCSMNUM_CASCADES{X}>0
vertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#if SHADOWCSMNUM_CASCADES{X}>1
vertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>2
vertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>3
vertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[vI]=SI;const FV={name:vI,shader:SI},wV=Object.freeze(Object.defineProperty({__proto__:null,shadowsVertexWGSL:FV},Symbol.toStringTag,{value:"Module"})),TI="backgroundVertexShader",xI=`#include<backgroundUboDeclaration>
#include<helperFunctions>
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif
#ifdef MAINUV2
varying vMainUV2: vec2f;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vDiffuseUV: vec2f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=input.position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}
#else
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);
#endif
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef NORMAL
var normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*input.normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
var screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}
#endif
#endif
#ifndef UV1
var uv: vec2f=vec2f(0.,0.);
#else
var uv=input.uv;
#endif
#ifndef UV2
var uv2: vec2f=vec2f(0.,0.);
#else
var uv2=input.uv2;
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uv;
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (uniforms.vDiffuseInfos.x==0.)
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}
else
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vertexOutputs.vColor=vertexInputs.color;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;V.ShadersStoreWGSL[TI]=xI;const BV={name:TI,shader:xI},VV=Object.freeze(Object.defineProperty({__proto__:null,backgroundVertexShaderWGSL:BV},Symbol.toStringTag,{value:"Module"})),CI="reflectionFunction",AI=`fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }
fn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }
fn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}
fn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}
fn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}
fn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix*(view*worldPos)).xyz;}
fn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}
#ifdef REFLECTION
fn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);
#endif
#ifndef REFLECTIONMAP_CUBIC
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3f(0,0,0);
#endif
}
#endif
`;V.IncludesShadersStoreWGSL[CI]=AI;const UV={name:CI,shader:AI},kV=Object.freeze(Object.defineProperty({__proto__:null,reflectionFunctionWGSL:UV},Symbol.toStringTag,{value:"Module"})),II="imageProcessingDeclaration",yI=`#ifdef EXPOSURE
uniform exposureLinear: f32;
#endif
#ifdef CONTRAST
uniform contrast: f32;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vInverseScreenSize: vec2f;
#endif
#ifdef VIGNETTE
uniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;
#endif
#ifdef COLORCURVES
uniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
var txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;
#else
var txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;
#endif
uniform colorTransformSettings: vec4f;
#endif
#ifdef DITHER
uniform ditherIntensity: f32;
#endif
`;V.IncludesShadersStoreWGSL[II]=yI;const GV={name:II,shader:yI},zV=Object.freeze(Object.defineProperty({__proto__:null,imageProcessingDeclarationWGSL:GV},Symbol.toStringTag,{value:"Module"})),bI="lightUboDeclaration",RI=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;
#else 
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d_array<f32>;
#endif
#ifdef SHADOWCSMDEBUG{X}
const vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>
(
vec3f ( 1.5,0.0,0.0 ),
vec3f ( 0.0,1.5,0.0 ),
vec3f ( 0.0,0.0,5.5 ),
vec3f ( 1.5,0.0,5.5 ),
vec3f ( 1.5,1.5,0.0 ),
vec3f ( 1.0,1.0,1.0 ),
vec3f ( 0.0,1.0,5.5 ),
vec3f ( 0.5,3.5,0.75 )
);
#endif
#elif defined(SHADOWCUBE{X})
var shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; 
var depthTexture{X}: texture_2d<f32>;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;
#else
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d<f32>;
#endif
uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[bI]=RI;const WV={name:bI,shader:RI},HV=Object.freeze(Object.defineProperty({__proto__:null,lightUboDeclarationWGSL:WV},Symbol.toStringTag,{value:"Module"})),PI="lightsFragmentFunctions",MI=`struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef NDOTL
ndl: f32,
#endif
};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)
{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var attenuation: f32=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}`;V.IncludesShadersStoreWGSL[PI]=MI;const XV={name:PI,shader:MI},YV=Object.freeze(Object.defineProperty({__proto__:null,lightsFragmentFunctionsWGSL:XV},Symbol.toStringTag,{value:"Module"})),DI="shadowsFragmentFunctions",OI=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
fn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32
{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
fn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
return select(darkness,1.0,depth>shadow);}
fn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};
#else
if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};
#endif
return min(1.0,visibility+darkness);}
fn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
fn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
fn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}
fn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}
fn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
#else
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32
{
#ifdef IS_NDC_HALF_ZRANGE
return clipSpace.z;
#else
return uvDepth.z;
#endif
}
const GREATEST_LESS_THAN_ONE: f32=0.99999994;
#define DISABLE_UNIFORMITY_ANALYSIS
fn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (
vec3f(0.06407013,0.05409927,0.),
vec3f(0.7366577,0.5789394,0.),
vec3f(-0.6270542,-0.5320278,0.),
vec3f(-0.4096107,0.8411095,0.),
vec3f(0.6849564,-0.4990818,0.),
vec3f(-0.874181,-0.04579735,0.),
vec3f(0.9989998,0.0009880066,0.),
vec3f(-0.004920578,-0.9151649,0.),
vec3f(0.1805763,0.9747483,0.),
vec3f(-0.2138451,0.2635818,0.),
vec3f(0.109845,0.3884785,0.),
vec3f(0.06876755,-0.3581074,0.),
vec3f(0.374073,-0.7661266,0.),
vec3f(0.3079132,-0.1216763,0.),
vec3f(-0.3794335,-0.8271583,0.),
vec3f(-0.203878,-0.07715034,0.),
vec3f(0.5912697,0.1469799,0.),
vec3f(-0.88069,0.3031784,0.),
vec3f(0.5040108,0.8283722,0.),
vec3f(-0.5844124,0.5494877,0.),
vec3f(0.6017799,-0.1726654,0.),
vec3f(-0.5554981,0.1559997,0.),
vec3f(-0.3016369,-0.3900928,0.),
vec3f(-0.5550632,-0.1723762,0.),
vec3f(0.925029,0.2995041,0.),
vec3f(-0.2473137,0.5538505,0.),
vec3f(0.9183037,-0.2862392,0.),
vec3f(0.2469421,0.6718712,0.),
vec3f(0.3916397,-0.4328209,0.),
vec3f(-0.03576927,-0.6220032,0.),
vec3f(-0.04661255,0.7995201,0.),
vec3f(0.4402924,0.3640312,0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.)
);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (
vec3f(-0.613392,0.617481,0.),
vec3f(0.170019,-0.040254,0.),
vec3f(-0.299417,0.791925,0.),
vec3f(0.645680,0.493210,0.),
vec3f(-0.651784,0.717887,0.),
vec3f(0.421003,0.027070,0.),
vec3f(-0.817194,-0.271096,0.),
vec3f(-0.705374,-0.668203,0.),
vec3f(0.977050,-0.108615,0.),
vec3f(0.063326,0.142369,0.),
vec3f(0.203528,0.214331,0.),
vec3f(-0.667531,0.326090,0.),
vec3f(-0.098422,-0.295755,0.),
vec3f(-0.885922,0.215369,0.),
vec3f(0.566637,0.605213,0.),
vec3f(0.039766,-0.396100,0.),
vec3f(0.751946,0.453352,0.),
vec3f(0.078707,-0.715323,0.),
vec3f(-0.075838,-0.529344,0.),
vec3f(0.724479,-0.580798,0.),
vec3f(0.222999,-0.215125,0.),
vec3f(-0.467574,-0.405438,0.),
vec3f(-0.248268,-0.814753,0.),
vec3f(0.354411,-0.887570,0.),
vec3f(0.175817,0.382366,0.),
vec3f(0.487472,-0.063082,0.),
vec3f(-0.084078,0.898312,0.),
vec3f(0.488876,-0.783441,0.),
vec3f(0.470016,0.217933,0.),
vec3f(-0.696890,-0.549791,0.),
vec3f(-0.149693,0.605762,0.),
vec3f(0.034211,0.979980,0.),
vec3f(0.503098,-0.308878,0.),
vec3f(-0.016205,-0.872921,0.),
vec3f(0.385784,-0.393902,0.),
vec3f(-0.146886,-0.859249,0.),
vec3f(0.643361,0.164098,0.),
vec3f(0.634388,-0.049471,0.),
vec3f(-0.688894,0.007843,0.),
vec3f(0.464034,-0.188818,0.),
vec3f(-0.440840,0.137486,0.),
vec3f(0.364483,0.511704,0.),
vec3f(0.034028,0.325968,0.),
vec3f(0.099094,-0.308023,0.),
vec3f(0.693960,-0.366253,0.),
vec3f(0.678884,-0.204688,0.),
vec3f(0.001801,0.780328,0.),
vec3f(0.145177,-0.898984,0.),
vec3f(0.062655,-0.611866,0.),
vec3f(0.315226,-0.604297,0.),
vec3f(-0.780145,0.486251,0.),
vec3f(-0.371868,0.882138,0.),
vec3f(0.200476,0.494430,0.),
vec3f(-0.494552,-0.711051,0.),
vec3f(0.612476,0.705252,0.),
vec3f(-0.578845,-0.768792,0.),
vec3f(-0.772454,-0.090976,0.),
vec3f(0.504440,0.372295,0.),
vec3f(0.155736,0.065157,0.),
vec3f(0.391522,0.849605,0.),
vec3f(-0.620106,-0.328104,0.),
vec3f(0.789239,-0.419965,0.),
vec3f(-0.545396,0.538133,0.),
vec3f(-0.178564,-0.596057,0.)
);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}
fn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}
blockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
exitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}
var offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}
fn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
fn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
fn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
fn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
`;V.IncludesShadersStoreWGSL[DI]=OI;const $V={name:DI,shader:OI},KV=Object.freeze(Object.defineProperty({__proto__:null,shadowsFragmentFunctionsWGSL:$V},Symbol.toStringTag,{value:"Module"})),NI="imageProcessingFunctions",LI=`#if TONEMAPPING==3
const PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}
var d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}
#endif
#if TONEMAPPING==2
const ACESInputMat: mat3x3f= mat3x3f(
vec3f(0.59719,0.07600,0.02840),
vec3f(0.35458,0.90834,0.13383),
vec3f(0.04823,0.01566,0.83777)
);const ACESOutputMat: mat3x3f= mat3x3f(
vec3f( 1.60475,-0.10208,-0.00327),
vec3f(-0.53108, 1.10813,-0.07276),
vec3f(-0.07367,-0.00605, 1.07602)
);fn RRTAndODTFit(v: vec3f)->vec3f
{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
fn ACESFitted(color: vec3f)->vec3f
{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
fn applyImageProcessing(result: vec4f)->vec4f {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
var rgb=result.rgb;;
#ifdef EXPOSURE
rgb*=uniforms.exposureLinear;
#endif
#ifdef VIGNETTE
var viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
var vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
rgb=mix(vignetteColor,rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
rgb=PBRNeutralToneMapping(rgb);
#elif TONEMAPPING==2
rgb=ACESFitted(rgb);
#elif TONEMAPPING==1
const tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);
#endif
rgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);
#ifdef CONTRAST
var resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}
#endif
#ifdef COLORGRADING
var colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;
#ifdef COLORGRADING3D
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;
#else
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;
#endif
rgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);
#endif
#ifdef COLORCURVES
var luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);
#endif
#ifdef DITHER
var rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return vec4f(rgb,result.a);}`;V.IncludesShadersStoreWGSL[NI]=LI;const jV={name:NI,shader:LI},qV=Object.freeze(Object.defineProperty({__proto__:null,imageProcessingFunctionsWGSL:jV},Symbol.toStringTag,{value:"Module"})),FI="lightFragment",wI=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
var diffuse{X}: vec4f=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSMDEBUG{X}
var shadowDebug{X}: vec3f;
#endif
#ifdef SHADOWCSM{X}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
var index{X}: i32=-1;
#else
var index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;
#endif
var diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;
#else
diff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
var frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;var nextShadow: f32=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[FI]=wI;const ZV={name:FI,shader:wI},QV=Object.freeze(Object.defineProperty({__proto__:null,lightFragmentWGSL:ZV},Symbol.toStringTag,{value:"Module"})),BI="backgroundPixelShader",VI=`#include<backgroundUboDeclaration>
#include<helperFunctions>
varying vPositionW: vec3f;
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif 
#ifdef MAINUV2 
varying vMainUV2: vec2f; 
#endif 
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vDiffuseUV: vec2f;
#endif
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
fn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }
var o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}
fn sphereIntersect(ro: vec3f,rd: vec3f,ra: f32)->f32 {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return -1.0; }
h=sqrt(h);return-b+h;}
fn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersect(eyePosition,camDir,radius);var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersect(upEyePosition,p,radius);var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f= vec3f(0.0,1.0,0.0);
#endif
var shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
var reflectionColor: vec4f= vec4f(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
var reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
var reflectionLOD: f32=uniforms.vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
textureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
var reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);
#endif
#ifdef GAMMAREFLECTION
reflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
#ifdef REFLECTIONBGR
reflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#endif
var diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;
#ifdef DIFFUSE
var diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);
#endif
diffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
var colorBase: vec3f=diffuseColor;
#else
var colorBase: vec3f=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,vec3f(0.0));
#ifdef USERGBCOLOR
var finalColor: vec3f=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
var mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);
#else
var mainColor: vec3f=uniforms.vPrimaryColor.rgb;
#endif
var finalColor: vec3f=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
var reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
var reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
var viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);
#endif
var color: vec4f= vec4f(finalColor,finalAlpha);
#else
var color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb *color.a,color.a);
#endif
#ifdef NOISE
color=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));
#endif
fragmentOutputs.color=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;V.ShadersStoreWGSL[BI]=VI;const JV={name:BI,shader:VI},eU=Object.freeze(Object.defineProperty({__proto__:null,backgroundPixelShaderWGSL:JV},Symbol.toStringTag,{value:"Module"})),tU="backgroundVertexDeclaration",iU=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;V.IncludesShadersStore[tU]=iU;const rU="backgroundUboDeclaration",sU=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};
#include<sceneUboDeclaration>
`;V.IncludesShadersStore[rU]=sU;const UI="lightVxFragmentDeclaration",kI=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;V.IncludesShadersStore[UI]=kI;const nU={name:UI,shader:kI},aU=Object.freeze(Object.defineProperty({__proto__:null,lightVxFragmentDeclaration:nU},Symbol.toStringTag,{value:"Module"})),GI="lightVxUboDeclaration",zI=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;V.IncludesShadersStore[GI]=zI;const oU={name:GI,shader:zI},lU=Object.freeze(Object.defineProperty({__proto__:null,lightVxUboDeclaration:oU},Symbol.toStringTag,{value:"Module"})),WI="shadowsVertex",HI=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;V.IncludesShadersStore[WI]=HI;const cU={name:WI,shader:HI},uU=Object.freeze(Object.defineProperty({__proto__:null,shadowsVertex:cU},Symbol.toStringTag,{value:"Module"})),XI="backgroundVertexShader",YI=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;V.ShadersStore[XI]=YI;const hU={name:XI,shader:YI},fU=Object.freeze(Object.defineProperty({__proto__:null,backgroundVertexShader:hU},Symbol.toStringTag,{value:"Module"})),dU="backgroundFragmentDeclaration",pU=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;V.IncludesShadersStore[dU]=pU;const $I="reflectionFunction",KI=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;V.IncludesShadersStore[$I]=KI;const _U={name:$I,shader:KI},mU=Object.freeze(Object.defineProperty({__proto__:null,reflectionFunction:_U},Symbol.toStringTag,{value:"Module"})),jI="imageProcessingDeclaration",qI=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;V.IncludesShadersStore[jI]=qI;const gU={name:jI,shader:qI},EU=Object.freeze(Object.defineProperty({__proto__:null,imageProcessingDeclaration:gU},Symbol.toStringTag,{value:"Module"})),ZI="lightFragmentDeclaration",QI=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#endif
`;V.IncludesShadersStore[ZI]=QI;const vU={name:ZI,shader:QI},SU=Object.freeze(Object.defineProperty({__proto__:null,lightFragmentDeclaration:vU},Symbol.toStringTag,{value:"Module"})),JI="lightUboDeclaration",ey=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;V.IncludesShadersStore[JI]=ey;const TU={name:JI,shader:ey},xU=Object.freeze(Object.defineProperty({__proto__:null,lightUboDeclaration:TU},Symbol.toStringTag,{value:"Module"})),ty="lightsFragmentFunctions",iy=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}`;V.IncludesShadersStore[ty]=iy;const CU={name:ty,shader:iy},AU=Object.freeze(Object.defineProperty({__proto__:null,lightsFragmentFunctions:CU},Symbol.toStringTag,{value:"Module"})),ry="shadowsFragmentFunctions",sy=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define DISABLE_UNIFORMITY_ANALYSIS
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;V.IncludesShadersStore[ry]=sy;const IU={name:ry,shader:sy},yU=Object.freeze(Object.defineProperty({__proto__:null,shadowsFragmentFunctions:IU},Symbol.toStringTag,{value:"Module"})),ny="imageProcessingFunctions",ay=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#if TONEMAPPING==3
const float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}
#endif
#if TONEMAPPING==2
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
result.rgb=PBRNeutralToneMapping(result.rgb);
#elif TONEMAPPING==2
result.rgb=ACESFitted(result.rgb);
#elif TONEMAPPING==1
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;V.IncludesShadersStore[ny]=ay;const bU={name:ny,shader:ay},RU=Object.freeze(Object.defineProperty({__proto__:null,imageProcessingFunctions:bU},Symbol.toStringTag,{value:"Module"})),oy="lightFragment",ly=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
vec4 diffuse{X}=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;V.IncludesShadersStore[oy]=ly;const PU={name:oy,shader:ly},MU=Object.freeze(Object.defineProperty({__proto__:null,lightFragment:PU},Symbol.toStringTag,{value:"Module"})),cy="backgroundPixelShader",uy=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
float sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }
h=sqrt(h);return-b+h;}
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;V.ShadersStore[cy]=uy;const DU={name:cy,shader:uy},OU=Object.freeze(Object.defineProperty({__proto__:null,backgroundPixelShader:DU},Symbol.toStringTag,{value:"Module"}));class Vu{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,q.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=e.bias===void 0?0:e.bias,this.power=e.power===void 0?1:e.power,this.leftColor=e.leftColor||fe.White(),this.rightColor=e.rightColor||fe.Black(),e.isEnabled===!1&&(this.isEnabled=!1)}clone(){const e=new Vu;return cr.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new Vu({isEnabled:e.isEnabled,leftColor:fe.FromArray(e.leftColor),rightColor:fe.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}Ke._FresnelParametersParser=Vu.Parse;class zr extends wt{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new fe(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}I([M(),ie("_markAllSubMeshesAsLightsDirty")],zr.prototype,"maxSimultaneousLights",void 0);I([M(),ie("_markAllSubMeshesAsLightsDirty")],zr.prototype,"disableLighting",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],zr.prototype,"environmentTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"invertNormalMapX",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"invertNormalMapY",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],zr.prototype,"normalTexture",void 0);I([hi("emissive"),ie("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"emissiveColor",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"emissiveTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],zr.prototype,"occlusionStrength",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],zr.prototype,"occlusionTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],zr.prototype,"alphaCutOff",void 0);I([M()],zr.prototype,"doubleSided",null);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty",null)],zr.prototype,"lightmapTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],zr.prototype,"useLightmapAsShadowmap",void 0);class Kn extends zr{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=Ke.Clone(()=>new Kn(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Ke.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=Ke.Parse(()=>new Kn(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}I([hi(),ie("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Kn.prototype,"baseColor",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Kn.prototype,"baseTexture",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Kn.prototype,"metallic",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Kn.prototype,"roughness",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],Kn.prototype,"metallicRoughnessTexture",void 0);$("BABYLON.PBRMetallicRoughnessMaterial",Kn);class jn extends zr{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=Ke.Clone(()=>new jn(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Ke.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const r=Ke.Parse(()=>new jn(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}I([hi("diffuse"),ie("_markAllSubMeshesAsTexturesDirty","_albedoColor")],jn.prototype,"diffuseColor",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],jn.prototype,"diffuseTexture",void 0);I([hi("specular"),ie("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],jn.prototype,"specularColor",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty","_microSurface")],jn.prototype,"glossiness",void 0);I([Rt(),ie("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],jn.prototype,"specularGlossinessTexture",void 0);$("BABYLON.PBRSpecularGlossinessMaterial",jn);const NU="pbrUboDeclaration",LU=`uniform vAlbedoInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionColor: vec3f;uniform vAlbedoColor: vec4f;uniform vLightingIntensity: vec4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;V.IncludesShadersStoreWGSL[NU]=LU;const FU="uvAttributeDeclaration",wU=`#ifdef UV{X}
attribute uv{X}: vec2f;
#endif
`;V.IncludesShadersStoreWGSL[FU]=wU;const BU="mainUVVaryingDeclaration",VU=`#ifdef MAINUV{X}
varying vMainUV{X}: vec2f;
#endif
`;V.IncludesShadersStoreWGSL[BU]=VU;const UU="prePassVertexDeclaration",kU=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;V.IncludesShadersStoreWGSL[UU]=kU;const GU="samplerVertexDeclaration",zU=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying v_VARYINGNAME_UV: vec2f;
#endif
`;V.IncludesShadersStoreWGSL[GU]=zU;const WU="harmonicsFunctions",HU=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00
+ uniforms.vSphericalL1_1*(normal.y)
+ uniforms.vSphericalL10*(normal.z)
+ uniforms.vSphericalL11*(normal.x)
+ uniforms.vSphericalL2_2*(normal.y*normal.x)
+ uniforms.vSphericalL2_1*(normal.y*normal.z)
+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ uniforms.vSphericalL21*(normal.z*normal.x)
+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}
#endif
#endif
`;V.IncludesShadersStoreWGSL[WU]=HU;const XU="bumpVertexDeclaration",YU=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#endif
`;V.IncludesShadersStoreWGSL[XU]=YU;const $U="prePassVertex",KU=`#ifdef PREPASS_DEPTH
vertexOutputs.vViewPos=(scene.view*worldPos).rgb;
#endif
#ifdef PREPASS_LOCAL_POSITION
vertexOutputs.vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=mPreviousBones[ i32(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[ i32(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[ i32(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[ i32(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
`;V.IncludesShadersStoreWGSL[$U]=KU;const jU="uvVariableDeclaration",qU=`#ifdef MAINUV{X}
#if !defined(UV{X})
var uv{X}: vec2f=vec2f(0.,0.);
#else
var uv{X}: vec2f=vertexInputs.uv{X};
#endif
vertexOutputs.vMainUV{X}=uv{X};
#endif
`;V.IncludesShadersStoreWGSL[jU]=qU;const ZU="samplerVertexImplementation",QU=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (uniforms.v_INFONAME_==0.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uvUpdated,1.0,0.0)).xy;}
#ifdef UV2
else if (uniforms.v_INFONAME_==1.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv2,1.0,0.0)).xy;}
#endif
#ifdef UV3
else if (uniforms.v_INFONAME_==2.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv3,1.0,0.0)).xy;}
#endif
#ifdef UV4
else if (uniforms.v_INFONAME_==3.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv4,1.0,0.0)).xy;}
#endif
#ifdef UV5
else if (uniforms.v_INFONAME_==4.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv5,1.0,0.0)).xy;}
#endif
#ifdef UV6
else if (uniforms.v_INFONAME_==5.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv6,1.0,0.0)).xy;}
#endif
#endif
`;V.IncludesShadersStoreWGSL[ZU]=QU;const JU="bumpVertex",ek=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];
#endif
#endif
`;V.IncludesShadersStoreWGSL[JU]=ek;const hy="pbrVertexShader",fy=`#include<pbrUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vertexOutputs.vClipSpacePosition=vertexOutputs.position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);
#endif
#ifndef UV1
var uvUpdated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStoreWGSL[hy]=fy;const tk={name:hy,shader:fy},dy=Object.freeze(Object.defineProperty({__proto__:null,pbrVertexShaderWGSL:tk},Symbol.toStringTag,{value:"Module"})),ik="prePassDeclaration",rk=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;V.IncludesShadersStoreWGSL[ik]=rk;const sk="oitDeclaration",nk=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#define MAX_DEPTH 99999.0
var oitDepthSamplerSampler: sampler;var oitDepthSampler: texture_2d<f32>;var oitFrontColorSamplerSampler: sampler;var oitFrontColorSampler: texture_2d<f32>;
#endif
`;V.IncludesShadersStoreWGSL[sk]=nk;const ak="pbrFragmentExtraDeclaration",ok=`varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
`;V.IncludesShadersStoreWGSL[ak]=ok;const lk="samplerFragmentDeclaration",ck=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
var _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;
#endif
`;V.IncludesShadersStoreWGSL[lk]=ck;const uk="samplerFragmentAlternateDeclaration",hk=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
#endif
`;V.IncludesShadersStoreWGSL[uk]=hk;const fk="pbrFragmentSamplersDeclaration",dk=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
var clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
var sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
var refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;
#endif
#else
var refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
`;V.IncludesShadersStoreWGSL[fk]=dk;const pk="subSurfaceScatteringFunctions",_k=`fn testLightingForSSS(diffusionProfile: f32)->bool
{return diffusionProfile<1.;}`;V.IncludesShadersStoreWGSL[pk]=_k;const mk="importanceSampling",gk=`fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { 
var phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;V.IncludesShadersStoreWGSL[mk]=gk;const Ek="pbrHelperFunctions",vk=`#define MINIMUMVARIANCE 0.0005
fn convertRoughnessToAverageSlope(roughness: f32)->f32
{return roughness*roughness+MINIMUMVARIANCE;}
fn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}
fn getAARoughnessFactors(normalVector: vec3f)->vec2f {
#ifdef SPECULARAA
var nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2f(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
fn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}
fn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
fn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}
fn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
fn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32
{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}
#endif
`;V.IncludesShadersStoreWGSL[Ek]=vk;const Sk="pbrDirectLightingSetupFunctions",Tk=`struct preLightingInfo
{lightOffset: vec3f,
lightDistanceSquared: f32,
lightDistance: f32,
attenuation: f32,
L: vec3f,
H: vec3f,
NdotV: f32,
NdotLUnclamped: f32,
NdotL: f32,
VdotH: f32,
roughness: f32,
#ifdef IRIDESCENCE
iridescenceIntensity: f32
#endif
};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;V.IncludesShadersStoreWGSL[Sk]=Tk;const xk="pbrDirectLightingFalloffFunctions",Ck=`fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32
{return max(0.,1.0-length(lightOffset)/range);}
fn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32
{return 1.0/maxEps(lightDistanceSquared);}
fn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32
{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
fn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
fn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32
{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
fn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32
{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; 
var concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
fn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32
{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
fn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;V.IncludesShadersStoreWGSL[xk]=Ck;const Ak="pbrBRDFFunctions",Ik=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
fn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
fn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);
#endif
return brdfLookup.rgb;}
fn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
fn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
fn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32
{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
fn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
fn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
fn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
fn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
fn getR0RemappedForClearCoat(f0: vec3f)->vec3f {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
var s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const XYZ_TO_REC709: mat3x3f= mat3x3f(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
fn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}
fn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}
fn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}
fn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
var cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}
var phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); 
var R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}
if (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}
if (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}
var opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)
{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}
return max(I, vec3f(0.0));}
#endif
fn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32
{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
fn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32
{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
fn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
fn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {
#ifdef MOBILE
var GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
var a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
fn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
var alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
fn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
fn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
fn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
fn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
fn l(x: f32,alphaG: f32)->f32
{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
fn lambdaSheen(cosTheta: f32,alphaG: f32)->f32
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
fn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
fn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
fn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
fn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}
#endif
`;V.IncludesShadersStoreWGSL[Ak]=Ik;const yk="hdrFilteringFunctions",bk=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
fn radicalInverse_VdC(value: u32)->f32 
{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }
fn hammersley(i: u32,N: u32)->vec2f
{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}
fn log4(x: f32)->f32 {return log2(x)/2.;}
const NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);if (NoL>0.) {var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpaceVec3(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
fn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;V.IncludesShadersStoreWGSL[yk]=bk;const Rk="pbrDirectLightingFunctions",Pk=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef CLEARCOAT
clearCoat: vec4f,
#endif
#ifdef SHEEN
sheen: vec3f
#endif
};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
var lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
fn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}
fn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: f32=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}
#ifdef SS_TRANSLUCENCY
fn computeDiffuseAndTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var NdotL: f32=absEps(info.NdotLUnclamped);var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);var transmittanceNdotL: vec3f=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);var diffuseTerm: f32=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
fn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
var smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
var smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
fn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
fn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
fn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
var visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
var visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
var sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;V.IncludesShadersStoreWGSL[Rk]=Pk;const Mk="pbrIBLFunctions",Dk=`#if defined(REFLECTION) || defined(SS_REFRACTION)
fn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}
fn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
fn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
fn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
fn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}
fn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;V.IncludesShadersStoreWGSL[Mk]=Dk;const py="bumpFragmentMainFunctions",_y=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; 
var a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; 
var a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(
(a11*b11-a12*b10+a13*b09)/det,
(a02*b10-a01*b11-a03*b09)/det,
(a31*b05-a32*b04+a33*b03)/det,
(a22*b04-a21*b05-a23*b03)/det,
(a12*b08-a10*b11-a13*b07)/det,
(a00*b11-a02*b08+a03*b07)/det,
(a32*b02-a30*b05-a33*b01)/det,
(a20*b05-a22*b02+a23*b01)/det,
(a10*b10-a11*b08+a13*b06)/det,
(a01*b08-a00*b10-a03*b06)/det,
(a30*b04-a31*b02+a33*b00)/det,
(a21*b02-a20*b04-a23*b00)/det,
(a11*b07-a10*b09-a12*b06)/det,
(a00*b09-a01*b07+a02*b06)/det,
(a31*b01-a30*b03-a32*b00)/det,
(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{var output=normal;
#ifdef NORMALXYSCALE
output=normalize(output* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*output);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;V.IncludesShadersStoreWGSL[py]=_y;const Ok={name:py,shader:_y},Nk=Object.freeze(Object.defineProperty({__proto__:null,bumpFragmentMainFunctionsWGSL:Ok},Symbol.toStringTag,{value:"Module"})),my="bumpFragmentFunctions",gy=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;V.IncludesShadersStoreWGSL[my]=gy;const Lk={name:my,shader:gy},Fk=Object.freeze(Object.defineProperty({__proto__:null,bumpFragmentFunctionsWGSL:Lk},Symbol.toStringTag,{value:"Module"})),wk="pbrBlockAlbedoOpacity",Bk=`struct albedoOpacityOutParams
{surfaceAlbedo: vec3f,
alpha: f32};
#define pbr_inline
fn albedoOpacityBlock(
vAlbedoColor: vec4f
#ifdef ALBEDO
,albedoTexture: vec4f
,albedoInfos: vec2f
#endif
#ifdef OPACITY
,opacityMap: vec4f
,vOpacityInfos: vec2f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
#ifdef DECAL
,decalColor: vec4f
,vDecalInfos: vec4f
#endif
)->albedoOpacityOutParams
{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=fragmentInputs.vColor.rgb;
#endif
#ifdef DETAIL
var detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;V.IncludesShadersStoreWGSL[wk]=Bk;const Vk="pbrBlockReflectivity",Uk=`struct reflectivityOutParams
{microSurface: f32,
roughness: f32,
surfaceReflectivityColor: vec3f,
#ifdef METALLICWORKFLOW
surfaceAlbedo: vec3f,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
ambientOcclusionColor: vec3f,
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
metallicRoughness: vec2f,
#ifdef REFLECTIVITY
surfaceMetallicColorMap: vec4f,
#endif
#ifndef FROSTBITE_REFLECTANCE
metallicF0: vec3f,
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColorMap: vec4f,
#endif
#endif
#endif
};
#define pbr_inline
fn reflectivityBlock(
vReflectivityColor: vec4f
#ifdef METALLICWORKFLOW
,surfaceAlbedo: vec3f
,metallicReflectanceFactors: vec4f
#endif
#ifdef REFLECTIVITY
,reflectivityInfos: vec3f
,surfaceMetallicOrReflectivityColorMap: vec4f
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,ambientOcclusionColorIn: vec3f
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel: vec4f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
)->reflectivityOutParams
{var outParams: reflectivityOutParams;var microSurface: f32=vReflectivityColor.a;var surfaceReflectivityColor: vec3f=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var metallicRoughness: vec2f=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
var aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
var detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
var metallicF0: vec3f=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0), vec3f(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);var roughness: f32=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}
`;V.IncludesShadersStoreWGSL[Vk]=Uk;const kk="pbrBlockAmbientOcclusion",Gk=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap_: vec3f,
vAmbientInfos: vec4f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;V.IncludesShadersStoreWGSL[kk]=Gk;const zk="pbrBlockAlphaFresnel",Wk=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}
#define pbr_inline
fn alphaFresnelBlock(
normalW: vec3f,
viewDirectionW: vec3f,
alpha: f32,
microSurface: f32
)->alphaFresnelOutParams
{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;
#ifdef LINEARALPHAFRESNEL
var opacity0: f32=opacityPerceptual;
#else
var opacity0: f32=opacityPerceptual*opacityPerceptual;
#endif
var opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE) {discard;}
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;V.IncludesShadersStoreWGSL[zk]=Wk;const Hk="pbrBlockAnisotropic",Xk=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
anisotropicNormal: vec3f,
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
anisotropyMapData: vec3f
#endif
};
#define pbr_inline
fn anisotropicBlock(
vAnisotropy: vec3f,
roughness: f32,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData: vec3f,
#endif
TBN: mat3x3f,
normalW: vec3f,
viewDirectionW: vec3f
)->anisotropicOutParams
{ 
var outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
var amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
amd=amd*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);
#else
anisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);
#endif
#endif
var anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;V.IncludesShadersStoreWGSL[Hk]=Xk;const Yk="pbrBlockReflection",$k=`#ifdef REFLECTION
struct reflectionOutParams
{environmentRadiance: vec4f
,environmentIrradiance: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionCoords: vec3f
#else
,reflectionCoords: vec2f
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector: vec3f
#endif
#endif
#endif
};
#define pbr_inline
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec3f
{var reflectionCoords: vec3f;
#else
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec2f
{ 
var reflectionCoords: vec2f;
#endif
#ifdef ANISOTROPIC
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
fn sampleReflectionTexture(
alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif 
)->vec4f
{var environmentRadiance: vec4f;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
var automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);
#else
var requestedReflectionLOD: f32=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
textureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
var envRadiance=environmentRadiance.rgb;
#ifdef RGBDREFLECTION
envRadiance=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
envRadiance=toLinearSpaceVec3(environmentRadiance.rgb);
#endif
envRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}
#define pbr_inline
fn reflectionBlock(
vPositionW: vec3f
,normalW: vec3f
,alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance: vec3f
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionMatrix: mat4x4f
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler 
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler 
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
)->reflectionOutParams
{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f= vec3f(0.);
#else
var reflectionCoords: vec2f= vec2f(0.);
#endif
reflectionCoords=createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif 
);environmentRadiance=sampleReflectionTexture(
alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#else
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
var irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;
#else
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;V.IncludesShadersStoreWGSL[Yk]=$k;const Kk="pbrBlockSheen",jk=`#ifdef SHEEN
struct sheenOutParams
{sheenIntensity: f32
,sheenColor: vec3f
,sheenRoughness: f32
#ifdef SHEEN_LINKWITHALBEDO
,surfaceAlbedo: vec3f
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
,sheenAlbedoScaling: f32
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,finalSheenRadianceScaled: vec3f
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,sheenEnvironmentReflectance: vec3f
#endif
#endif
};
#define pbr_inline
fn sheenBlock(
vSheenColor: vec4f
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness: f32
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData: vec4f
#endif
#endif
,roughness: f32
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
,sheenMapLevel: f32
#endif
,reflectance: f32
#ifdef SHEEN_LINKWITHALBEDO
,baseColor: vec3f
,surfaceAlbedo: vec3f
#endif
#ifdef ENVIRONMENTBRDF
,NdotV: f32
,environmentBrdf: vec3f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors: vec2f
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
,NdotVUnclamped: f32
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo: f32
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho: f32
#endif
#endif
)->sheenOutParams
{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
var sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
var sheenColor: vec3f=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor*=toLinearSpaceVec3(sheenMapData.rgb);
#else
sheenColor*=sheenMapData.rgb;
#endif
sheenColor*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
var sheenRoughness: f32=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
var sheenRoughness: f32=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
var environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
var environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);
#else
var environmentSheenBrdf: vec3f=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
var sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
var environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(
sheenAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,sheenRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;V.IncludesShadersStoreWGSL[Kk]=jk;const qk="pbrBlockClearcoat",Zk=`struct clearcoatOutParams
{specularEnvironmentR0: vec3f,
conservationFactor: f32,
clearCoatNormalW: vec3f,
clearCoatAARoughnessFactors: vec2f,
clearCoatIntensity: f32,
clearCoatRoughness: f32,
#ifdef REFLECTION
finalClearCoatRadianceScaled: vec3f,
#endif
#ifdef CLEARCOAT_TINT
absorption: vec3f,
clearCoatNdotVRefract: f32,
clearCoatColor: vec3f,
clearCoatThickness: f32,
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
energyConservationFactorClearCoat: vec3f,
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
TBNClearCoat: mat3x3f,
#endif
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData: vec2f,
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
clearCoatTintMapData: vec4f,
#endif
#ifdef REFLECTION
environmentClearCoatRadiance: vec4f,
clearCoatEnvironmentReflectance: vec3f,
#endif
clearCoatNdotV: f32
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
fn clearcoatBlock(
vPositionW: vec3f
,geometricNormalW: vec3f
,viewDirectionW: vec3f
,vClearCoatParams: vec2f
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData: vec4f
#endif
,specularEnvironmentR0: vec3f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams: vec4f
,clearCoatColorAtDistance: f32
,vClearCoatRefractionParams: vec4f
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData: vec4f
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos: vec2f
,clearCoatBumpMapData: vec4f
,vClearCoatBumpUV: vec2f
#if defined(TANGENT) && defined(NORMAL)
,vTBN: mat3x3f
#else
,vClearCoatTangentSpaceParams: vec2f
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix: mat4x4f
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal: vec3f
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,frontFacingMultiplier: f32
#endif 
)->clearcoatOutParams
{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
var clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
var specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
var specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
var clearCoatNormalScale: f32=1.0;
#else
var clearCoatNormalScale: f32=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBNClearCoat: mat3x3f=vTBN;
#else
var TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
var clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
var environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
var clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
var environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;
#else
var clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
environmentClearCoatRadiance=sampleReflectionTexture(
clearCoatAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,clearCoatNdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,clearCoatRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,clearCoatReflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
var fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;V.IncludesShadersStoreWGSL[qk]=Zk;const Qk="pbrBlockIridescence",Jk=`struct iridescenceOutParams
{iridescenceIntensity: f32,
iridescenceIOR: f32,
iridescenceThickness: f32,
specularEnvironmentR0: vec3f};
#ifdef IRIDESCENCE
fn iridescenceBlock(
vIridescenceParams: vec4f
,viewAngle: f32
,specularEnvironmentR0: vec3f
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData: vec2f
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData: vec2f
#endif
#ifdef CLEARCOAT
,NdotVUnclamped: f32
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#endif
)->iridescenceOutParams
{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
var iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; 
#ifdef CLEARCOAT
var clearCoatIntensity: f32=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));
#endif
var iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;V.IncludesShadersStoreWGSL[Qk]=Jk;const eG="pbrBlockSubSurface",tG=`struct subSurfaceOutParams
{specularEnvironmentReflectance: vec3f,
#ifdef SS_REFRACTION
finalRefraction: vec3f,
surfaceAlbedo: vec3f,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha: f32,
#endif
#ifdef REFLECTION
refractionFactorForIrradiance: f32,
#endif
#endif
#ifdef SS_TRANSLUCENCY
transmittance: vec3f,
translucencyIntensity: f32,
#ifdef REFLECTION
refractionIrradiance: vec3f,
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap: vec4f,
#endif
#ifdef SS_REFRACTION
environmentRefraction: vec4f,
refractionTransmittance: vec3f
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
fn sampleEnvironmentRefraction(
ior: f32
,thickness: f32
,refractionLOD: f32
,normalW: vec3f
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef ANISOTROPIC
var refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
var refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;
#else
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;
#endif
var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
var lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
var automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);
#else
var requestedRefractionLOD: f32=lod;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
var lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
textureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
textureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
var refraction=environmentRefraction.rgb;
#ifdef SS_RGBDREFRACTION
refraction=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
refraction=toLinearSpaceVec3(environmentRefraction.rgb);
#endif
return vec4f(refraction,environmentRefraction.a);}
#endif
#define pbr_inline
fn subSurfaceBlock(
vSubSurfaceIntensity: vec3f
,vThicknessParam: vec2f
,vTintColor: vec4f
,normalW: vec3f
,specularEnvironmentReflectance: vec3f
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap: vec4f
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap: vec4f
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap: vec4f
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix: mat4x4f
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector_: vec3f
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,vReflectionFilteringInfo: vec2f
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo: vec3f
#endif
#ifdef SS_REFRACTION
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,vLightingIntensity: vec4f
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha: f32
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped: f32
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness: f32
#endif
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
#ifdef SS_DISPERSION
,dispersion: f32
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance: vec3f
,vTranslucencyColor: vec4f
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap: vec4f
#endif
#endif
)->subSurfaceOutParams
{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
var refractionIntensity: f32=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
var translucencyIntensity: f32=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
var thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
var thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
var thickness: f32=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
var transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
var ior: f32=vRefractionInfos.y;
#else
var ior: f32=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
var refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
var refraction_ior: f32=vRefractionInfos.y;
#ifdef SS_DISPERSION
var realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];
#endif
var envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#else
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);
#endif
#ifdef SS_REFRACTION
var refractionTransmittance: vec3f= vec3f(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
var maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);
#else
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
var bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
var irradianceVector: vec3f=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
var refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo);
#else
var refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var irradianceCoords: vec3f=irradianceVector;
#else
var irradianceCoords: vec2f=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
var temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;
#ifdef RGBDREFLECTION
refractionIrradiance=fromRGBD(temp).rgb;
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance=toLinearSpaceVec3(refractionIrradiance);
#endif
#else
var refractionIrradiance: vec3f= vec3f(0.);
#endif
refractionIrradiance*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance;
#endif
return outParams;}
#endif
`;V.IncludesShadersStoreWGSL[eG]=tG;const iG="pbrBlockNormalGeometric",rG=`var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(input.vNormalW);
#else
var normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;
#endif
var geometricNormalW: vec3f=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);
#endif
`;V.IncludesShadersStoreWGSL[iG]=rG;const Ey="bumpFragment",vy=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(BUMP)
var normalScale: f32=uniforms.vBumpInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#elif defined(BUMP)
var TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#else
var TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);
#else
var bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);
#endif
`;V.IncludesShadersStoreWGSL[Ey]=vy;const sG={name:Ey,shader:vy},nG=Object.freeze(Object.defineProperty({__proto__:null,bumpFragmentWGSL:sG},Symbol.toStringTag,{value:"Module"})),aG="pbrBlockNormalFinal",oG=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
`;V.IncludesShadersStoreWGSL[aG]=oG;const lG="depthPrePass",cG=`#ifdef DEPTHPREPASS
fragmentOutputs.color= vec4f(0.,0.,0.,1.0);return fragmentOutputs;
#endif
`;V.IncludesShadersStoreWGSL[lG]=cG;const uG="pbrBlockLightmapInit",hG=`#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
`;V.IncludesShadersStoreWGSL[uG]=hG;const fG="pbrBlockGeometryInfo",dG=`var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
var environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
var ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;
#else
var ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);
#endif
var seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;V.IncludesShadersStoreWGSL[fG]=dG;const pG="pbrBlockReflectance0",_G=`var reflectance: f32=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);var specularEnvironmentR0: vec3f=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var specularEnvironmentR90: vec3f= vec3f(metallicReflectanceFactors.a);
#else 
var specularEnvironmentR90: vec3f= vec3f(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
var reflectance90: f32=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;V.IncludesShadersStoreWGSL[pG]=_G;const mG="pbrBlockReflectance",gG=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var specularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
var specularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;V.IncludesShadersStoreWGSL[mG]=gG;const EG="pbrBlockDirectLighting",vG=`var diffuseBase: vec3f=vec3f(0.,0.,0.);
#ifdef SPECULARTERM
var specularBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef CLEARCOAT
var clearCoatBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SHEEN
var sheenBase: vec3f=vec3f(0.,0.,0.);
#endif
var preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; 
var aggShadow: f32=0.;var numLights: f32=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
var absorption: vec3f=vec3f(0.);
#endif
`;V.IncludesShadersStoreWGSL[EG]=vG;const SG="pbrBlockFinalLitComponents",TG=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
var energyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
var finalIrradiance: vec3f=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
var finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
var finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
var finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
var luminanceOverAlpha: f32=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;V.IncludesShadersStoreWGSL[SG]=TG;const xG="pbrBlockFinalUnlitComponents",CG=`var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
var emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= uniforms.vEmissiveInfos.y;
#endif
finalEmissive*=uniforms.vLightingIntensity.y;
#ifdef AMBIENT
var ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);
#else
var ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;V.IncludesShadersStoreWGSL[xG]=CG;const AG="pbrBlockFinalColorComposition",IG=`var finalColor: vec4f= vec4f(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);
#else
finalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);
#endif
#endif
#endif
finalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
`;V.IncludesShadersStoreWGSL[AG]=IG;const yG="pbrBlockImageProcessing",bG=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
finalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;
#endif
`;V.IncludesShadersStoreWGSL[yG]=bG;const RG="pbrBlockPrePass",PG=`var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
var sqAlbedo : vec3f=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
var irradiance : vec3f=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;
#else
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
var scatteringDiffusionProfile : f32=255.;
#endif
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#elif defined(PREPASS_COLOR)
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
`;V.IncludesShadersStoreWGSL[RG]=PG;const MG="oitFragment",DG=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
var fragDepth: f32=fragmentInputs.position.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
var halfFloat: i32=packHalf2x16( vec2f(fragDepth));var full: vec2f=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var lastDepth: vec2f=textureLoad(oitDepthSampler,fragCoord,0).rg;var lastFrontColor: vec4f=textureLoad(oitFrontColorSampler,fragCoord,0);fragmentOutputs.depth=vec2f(-MAX_DEPTH);fragmentOutputs.frontColor=lastFrontColor;fragmentOutputs.backColor= vec4f(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
var furthestDepth: f32=-lastDepth.x;var nearestDepth: f32=lastDepth.y;
#else
var nearestDepth: f32=-lastDepth.x;var furthestDepth: f32=lastDepth.y;
#endif
var alphaMultiplier: f32=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return fragmentOutputs;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
fragmentOutputs.depth=vec2f(-fragDepth,fragDepth);return fragmentOutputs;}
#endif
`;V.IncludesShadersStoreWGSL[MG]=DG;const OG="pbrDebug",NG=`#if DEBUGMODE>0
if (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;
#if DEBUGMODE==1
color=fragmentInputs.vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
color=fragmentInputs.vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
color=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
color=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
color=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
color= vec3f(input.vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
color= vec3f(input.vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
color=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
color=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
color=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
color=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
color=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
color=lightmapColor;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
color= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
color=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
color=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
color=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
color=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
color=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
color=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
color=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
color=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
color=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
color=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
color=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
color=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
color=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
color=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
color=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
color= vec3f(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
color=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
color= vec3f(roughness);
#elif DEBUGMODE==64
color= vec3f(alphaG);
#elif DEBUGMODE==65
color= vec3f(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
color=clearcoatOut.clearCoatColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
color=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
color=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
color= vec3f(microSurface);
#elif DEBUGMODE==73
color=uniforms.vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
color=uniforms.vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
color=uniforms.vEmissiveColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
color= vec3f(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
color= vec3f(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
color= vec3f(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
color=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
color= vec3f(luminanceOverAlpha);
#elif DEBUGMODE==87
color= vec3f(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
color= vec3f(albedoTexture.a);
#elif DEBUGMODE==89
color=aoOut.ambientOcclusionColor;
#else
var stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);
#endif
color*=uniforms.vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
color=normalize(color)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
color=toGammaSpaceVec3(color);
#endif
fragmentOutputs.color=vec4f(color,1.0);
#ifdef PREPASS
fragmentOutputs.fragData0=toLinearSpaceVec3(color); 
fragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return fragmentOutputs;
#endif
}
#endif
`;V.IncludesShadersStoreWGSL[OG]=NG;const Sy="pbrPixelShader",Ty=`#define CUSTOM_FRAGMENT_BEGIN
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<pbrUboDeclaration>
#include<pbrFragmentExtraDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
var albedoOpacityOut: albedoOpacityOutParams;
#ifdef ALBEDO
var albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#endif
#ifdef DECAL
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
uniforms.vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,uniforms.vAlbedoInfos
#endif
#ifdef OPACITY
,opacityMap
,uniforms.vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
#ifdef DECAL
,decalColor
,uniforms.vDecalInfos
#endif
);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var aoOut: ambientOcclusionOutParams;
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
uniforms.vAmbientInfos
#endif 
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
var diffuseBase: vec3f= vec3f(1.,1.,1.);
#else
var baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;
#if defined(REFLECTIVITY)
var surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);
#endif
#endif
#if defined(MICROSURFACEMAP)
var microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
var metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;
#ifdef REFLECTANCE
var reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);
#endif
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
#ifdef METALLIC_REFLECTANCE
var metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
uniforms.vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,uniforms.vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
var alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
var anisotropicOut: anisotropicOutParams;
#ifdef ANISOTROPIC_TEXTURE
var anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
uniforms.vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW 
);
#endif
#ifdef REFLECTION
var reflectionOut: reflectionOutParams;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
fragmentInputs.vPositionW
,normalW
,alphaG
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
,reflectionSamplerSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,fragmentInputs.vEnvironmentIrradiance
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,uniforms.reflectionMatrix
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
var sheenOut: sheenOutParams;
#ifdef SHEEN_TEXTURE
var sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
var sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;
#endif
sheenOut=sheenBlock(
uniforms.vSheenColor
#ifdef SHEEN_ROUGHNESS
,uniforms.vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,uniforms.vSheenInfos.y
#endif
,reflectance
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
var clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
var iridescenceOut: iridescenceOutParams;
#ifdef IRIDESCENCE_TEXTURE
var iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
var iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
uniforms.vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
var clearcoatOut: clearcoatOutParams;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
var clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
var clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
var clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
fragmentInputs.vPositionW
,geometricNormalW
,viewDirectionW
,uniforms.vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,uniforms.vClearCoatTintParams
,uniforms.clearCoatColorAtDistance
,uniforms.vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,uniforms.vClearCoatBumpInfos
,clearCoatBumpMapData
,fragmentInputs.vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,uniforms.vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,uniforms.normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,select(-1.,1.,fragmentInputs.frontFacing)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
var subSurfaceOut: subSurfaceOutParams;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
var thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
var refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
var translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
var translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);
#endif
subSurfaceOut=subSurfaceBlock(
uniforms.vSubSurfaceIntensity
,uniforms.vThicknessParam
,uniforms.vTintColor
,normalW
,specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,uniforms.reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,reflectionSamplerSampler
,vReflectionFilteringInfo
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,fragmentInputs.vPositionW
,viewDirectionW
,scene.view
,uniforms.vRefractionInfos
,uniforms.refractionMatrix
,uniforms.vRefractionMicrosurfaceInfos
,uniforms.vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,uniforms.vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,uniforms.vRefractionPosition
,uniforms.vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,uniforms.vDiffusionDistance
,uniforms.vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}`;V.ShadersStoreWGSL[Sy]=Ty;const LG={name:Sy,shader:Ty},xy=Object.freeze(Object.defineProperty({__proto__:null,pbrPixelShaderWGSL:LG},Symbol.toStringTag,{value:"Module"})),FG="decalVertexDeclaration",wG=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;V.IncludesShadersStore[FG]=wG;const BG="pbrVertexDeclaration",VG=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;V.IncludesShadersStore[BG]=VG;const UG="pbrUboDeclaration",kG=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;V.IncludesShadersStore[UG]=kG;const GG="uvAttributeDeclaration",zG=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;V.IncludesShadersStore[GG]=zG;const WG="mainUVVaryingDeclaration",HG=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;V.IncludesShadersStore[WG]=HG;const XG="prePassVertexDeclaration",YG=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;V.IncludesShadersStore[XG]=YG;const $G="samplerVertexDeclaration",KG=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;V.IncludesShadersStore[$G]=KG;const jG="harmonicsFunctions",qG=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;V.IncludesShadersStore[jG]=qG;const ZG="bumpVertexDeclaration",QG=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;V.IncludesShadersStore[ZG]=QG;const JG="prePassVertex",ez=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#ifdef PREPASS_LOCAL_POSITION
vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;V.IncludesShadersStore[JG]=ez;const tz="uvVariableDeclaration",iz=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;V.IncludesShadersStore[tz]=iz;const rz="samplerVertexImplementation",sz=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;V.IncludesShadersStore[rz]=sz;const nz="bumpVertex",az=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;V.IncludesShadersStore[nz]=az;const Cy="pbrVertexShader",Ay=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStore[Cy]=Ay;const oz={name:Cy,shader:Ay},Iy=Object.freeze(Object.defineProperty({__proto__:null,pbrVertexShader:oz},Symbol.toStringTag,{value:"Module"})),lz="prePassDeclaration",cz=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_LOCAL_POSITION
varying highp vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;V.IncludesShadersStore[lz]=cz;const uz="oitDeclaration",hz=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;V.IncludesShadersStore[uz]=hz;const fz="decalFragmentDeclaration",dz=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;V.IncludesShadersStore[fz]=dz;const pz="pbrFragmentDeclaration",_z=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;V.IncludesShadersStore[pz]=_z;const mz="pbrFragmentExtraDeclaration",gz=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;V.IncludesShadersStore[mz]=gz;const Ez="samplerFragmentDeclaration",vz=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;V.IncludesShadersStore[Ez]=vz;const Sz="samplerFragmentAlternateDeclaration",Tz=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;V.IncludesShadersStore[Sz]=Tz;const xz="pbrFragmentSamplersDeclaration",Cz=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
`;V.IncludesShadersStore[xz]=Cz;const Az="subSurfaceScatteringFunctions",Iz=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;V.IncludesShadersStore[Az]=Iz;const yz="importanceSampling",bz=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;V.IncludesShadersStore[yz]=bz;const Rz="pbrHelperFunctions",Pz=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;V.IncludesShadersStore[Rz]=Pz;const Mz="pbrDirectLightingSetupFunctions",Dz=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;V.IncludesShadersStore[Mz]=Dz;const Oz="pbrDirectLightingFalloffFunctions",Nz=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;V.IncludesShadersStore[Oz]=Nz;const Lz="pbrBRDFFunctions",Fz=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
`;V.IncludesShadersStore[Lz]=Fz;const wz="hdrFilteringFunctions",Bz=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;V.IncludesShadersStore[wz]=Bz;const Vz="pbrDirectLightingFunctions",Uz=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;V.IncludesShadersStore[Vz]=Uz;const kz="pbrIBLFunctions",Gz=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;V.IncludesShadersStore[kz]=Gz;const yy="bumpFragmentMainFunctions",by=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;V.IncludesShadersStore[yy]=by;const zz={name:yy,shader:by},Wz=Object.freeze(Object.defineProperty({__proto__:null,bumpFragmentMainFunctions:zz},Symbol.toStringTag,{value:"Module"})),Ry="bumpFragmentFunctions",Py=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;V.IncludesShadersStore[Ry]=Py;const Hz={name:Ry,shader:Py},Xz=Object.freeze(Object.defineProperty({__proto__:null,bumpFragmentFunctions:Hz},Symbol.toStringTag,{value:"Module"})),Yz="decalFragment",$z=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;V.IncludesShadersStore[Yz]=$z;const Kz="pbrBlockAlbedoOpacity",jz=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
albedoOpacityOutParams albedoOpacityBlock(
in vec4 vAlbedoColor
#ifdef ALBEDO
,in vec4 albedoTexture
,in vec2 albedoInfos
#endif
#ifdef OPACITY
,in vec4 opacityMap
,in vec2 vOpacityInfos
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
#ifdef DECAL
,in vec4 decalColor
,in vec4 vDecalInfos
#endif 
)
{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;V.IncludesShadersStore[Kz]=jz;const qz="pbrBlockReflectivity",Zz=`struct reflectivityOutParams
{float microSurface;float roughness;vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
vec2 metallicRoughness;
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
#ifndef FROSTBITE_REFLECTANCE
vec3 metallicF0;
#endif
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
reflectivityOutParams reflectivityBlock(
in vec4 vReflectivityColor
#ifdef METALLICWORKFLOW
,in vec3 surfaceAlbedo
,in vec4 metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,in vec3 reflectivityInfos
,in vec4 surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,in vec3 ambientOcclusionColorIn
#endif
#ifdef MICROSURFACEMAP
,in vec4 microSurfaceTexel
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
)
{reflectivityOutParams outParams;float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}
`;V.IncludesShadersStore[qz]=Zz;const Qz="pbrBlockAmbientOcclusion",Jz=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;V.IncludesShadersStore[Qz]=Jz;const e4="pbrBlockAlphaFresnel",t4=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
alphaFresnelOutParams alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface
)
{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;V.IncludesShadersStore[e4]=t4;const i4="pbrBlockAnisotropic",r4=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
anisotropicOutParams anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW
)
{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;V.IncludesShadersStore[i4]=r4;const s4="pbrBlockReflection",n4=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
reflectionOutParams reflectionBlock(
in vec3 vPositionW
,in vec3 normalW
,in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,in float NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,in float roughness
#endif
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradiance
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in mat4 reflectionMatrix
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
)
{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;V.IncludesShadersStore[s4]=n4;const a4="pbrBlockSheen",o4=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
sheenOutParams sheenBlock(
in vec4 vSheenColor
#ifdef SHEEN_ROUGHNESS
,in float vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 sheenMapRoughnessData
#endif
#endif
,in float roughness
#ifdef SHEEN_TEXTURE
,in vec4 sheenMapData
,in float sheenMapLevel
#endif
,in float reflectance
#ifdef SHEEN_LINKWITHALBEDO
,in vec3 baseColor
,in vec3 surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,in float NdotV
,in vec3 environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,in vec2 AARoughnessFactors
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,in vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,in vec2 reflectionCoords
#endif
,in float NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,in float seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,in float eho
#endif
#endif
)
{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;V.IncludesShadersStore[a4]=o4;const l4="pbrBlockClearcoat",c4=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
clearcoatOutParams clearcoatBlock(
in vec3 vPositionW
,in vec3 geometricNormalW
,in vec3 viewDirectionW
,in vec2 vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 clearCoatMapRoughnessData
#endif
,in vec3 specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,in vec4 vClearCoatTintParams
,in float clearCoatColorAtDistance
,in vec4 vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,in vec4 clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,in vec2 vClearCoatBumpInfos
,in vec4 clearCoatBumpMapData
,in vec2 vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,in mat3 vTBN
#else
,in vec2 vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,in mat4 normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,in vec3 faceNormal
#endif
#ifdef REFLECTION
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,in float frontFacingMultiplier
#endif
)
{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;V.IncludesShadersStore[l4]=c4;const u4="pbrBlockIridescence",h4=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
iridescenceOutParams iridescenceBlock(
in vec4 vIridescenceParams
,in float viewAngle
,in vec3 specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,in vec2 iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,in vec2 iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,in float NdotVUnclamped
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#endif
)
{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;V.IncludesShadersStore[u4]=h4;const f4="pbrBlockSubSurface",d4=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
subSurfaceOutParams subSurfaceBlock(
in vec3 vSubSurfaceIntensity
,in vec2 vThicknessParam
,in vec4 vTintColor
,in vec3 normalW
,in vec3 specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,in vec4 thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,in vec4 refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,in vec4 translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,in mat4 reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in vec3 irradianceVector_
#endif
#if defined(REALTIME_FILTERING)
,in samplerCube reflectionSampler
,in vec2 vReflectionFilteringInfo
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,in vec3 surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in vec4 vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,in float alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,in float NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,in float roughness
#endif
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
#ifdef SS_DISPERSION
,in float dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,in vec3 vDiffusionDistance
,in vec4 vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,in vec4 translucencyColorMap
#endif
#endif
)
{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
return outParams;}
#endif
`;V.IncludesShadersStore[f4]=d4;const p4="pbrBlockNormalGeometric",_4=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;V.IncludesShadersStore[p4]=_4;const My="bumpFragment",Dy=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;V.IncludesShadersStore[My]=Dy;const m4={name:My,shader:Dy},g4=Object.freeze(Object.defineProperty({__proto__:null,bumpFragment:m4},Symbol.toStringTag,{value:"Module"})),E4="pbrBlockNormalFinal",v4=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;V.IncludesShadersStore[E4]=v4;const S4="depthPrePass",T4=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;V.IncludesShadersStore[S4]=T4;const x4="pbrBlockLightmapInit",C4=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;V.IncludesShadersStore[x4]=C4;const A4="pbrBlockGeometryInfo",I4=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;V.IncludesShadersStore[A4]=I4;const y4="pbrBlockReflectance0",b4=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;V.IncludesShadersStore[y4]=b4;const R4="pbrBlockReflectance",P4=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;V.IncludesShadersStore[R4]=P4;const M4="pbrBlockDirectLighting",D4=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;V.IncludesShadersStore[M4]=D4;const O4="pbrBlockFinalLitComponents",N4=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;V.IncludesShadersStore[O4]=N4;const L4="pbrBlockFinalUnlitComponents",F4=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;V.IncludesShadersStore[L4]=F4;const w4="pbrBlockFinalColorComposition",B4=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;V.IncludesShadersStore[w4]=B4;const V4="pbrBlockImageProcessing",U4=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;V.IncludesShadersStore[V4]=U4;const k4="pbrBlockPrePass",G4=`float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;
#else
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#elif defined(PREPASS_COLOR)
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
`;V.IncludesShadersStore[k4]=G4;const z4="oitFragment",W4=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;V.IncludesShadersStore[z4]=W4;const H4="pbrDebug",X4=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;V.IncludesShadersStore[H4]=X4;const Oy="pbrPixelShader",Ny=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,vAlbedoInfos
#endif
#ifdef OPACITY
,opacityMap
,vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
#ifdef DECAL
,decalColor
,vDecalInfos
#endif
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos
#endif 
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW 
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
vPositionW
,normalW
,alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionMatrix
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenOut=sheenBlock(
vSheenColor
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,vSheenInfos.y
#endif
,reflectance
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
vPositionW
,geometricNormalW
,viewDirectionW
,vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams
,clearCoatColorAtDistance
,vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos
,clearCoatBumpMapData
,vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,(gl_FrontFacing ? 1. : -1.)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#endif
subSurfaceOut=subSurfaceBlock(
vSubSurfaceIntensity
,vThicknessParam
,vTintColor
,normalW
,specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,vReflectionFilteringInfo
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,vPositionW
,viewDirectionW
,view
,vRefractionInfos
,refractionMatrix
,vRefractionMicrosurfaceInfos
,vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,vRefractionPosition
,vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance
,vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;V.ShadersStore[Oy]=Ny;const Y4={name:Oy,shader:Ny},Ly=Object.freeze(Object.defineProperty({__proto__:null,pbrPixelShader:Y4},Symbol.toStringTag,{value:"Module"}));var ev;(function(n){n[n.GLSL=0]="GLSL",n[n.WGSL=1]="WGSL"})(ev||(ev={}));class Xo extends jt{constructor(e,t,i=null){if(super(t),!!e)if(this._textureMatrix=O.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const r=this.getScene();r?r.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture():this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;e._features.support3DTextures?t=e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t=e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=s=>{if(typeof s!="string")return;let a=null,o=null,l;const c=s.split(`
`);let u=0,h=0,f=0,d=0,p=0;for(let _=0;_<c.length;_++){if(l=c[_],!Xo._NoneEmptyLineRegex.test(l)||l.indexOf("#")===0)continue;const g=l.split(" ");if(u===0){u=g.length,a=new Uint8Array(u*u*u*4),o=new Float32Array(u*u*u*4);continue}if(u!=0){const E=Math.max(parseInt(g[0]),0),v=Math.max(parseInt(g[1]),0),x=Math.max(parseInt(g[2]),0);p=Math.max(E,p),p=Math.max(v,p),p=Math.max(x,p);const A=(h+d*u+f*u*u)*4;o&&(o[A+0]=E,o[A+1]=v,o[A+2]=x),f++,f%u==0&&(d++,f=0,d%u==0&&(h++,d=0))}}if(o&&a)for(let _=0;_<o.length;_++)if(_>0&&(_+1)%4===0)a[_]=255;else{const g=o[_];a[_]=g/p*255}t.is3D?(t.updateSize(u,u,u),e.updateRawTexture3D(t,a,5,!1)):(t.updateSize(u*u,u),e.updateRawTexture(t,a,5,!1)),t.isReady=!0,this._triggerOnLoad()},r=this.getScene();return r?r._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const e=new Xo(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new Xo(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}Xo._NoneEmptyLineRegex=/\S+/;$("BABYLON.ColorGradingTexture",Xo);class Uu extends jt{constructor(e,t,i,r=!1,s=!0,a=null,o=null,l=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=Z.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=l,this._noMipmap=r,this.gammaSpace=s,this._onLoad=a,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?a&&(this._texture.isReady?J.SetImmediate(()=>a()):this._texture.onLoadedObservable.add(a)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(()=>this._loadTexture(),this._onError)}_loadImage(e,t){const i=this.getScene();if(!i)return;const r=i.getEngine().createRawCubeTexture(null,this._size,4,i.getEngine().getCaps().textureFloat?1:7,!this._noMipmap,!1,3);r.generateMipMaps=!this._noMipmap,i.addPendingData(r),r.url=this.url,r.isReady=!1,i.getEngine()._internalTexturesCache.push(r),this._texture=r;const s=document.createElement("canvas");Ec(this.url,a=>{this._width=a.width,this._height=a.height,s.width=this._width,s.height=this._height;const o=s.getContext("2d");o.drawImage(a,0,0);const l=o.getImageData(0,0,a.width,a.height);this._buffer=l.data.buffer,s.remove(),e()},(a,o)=>{i.removePendingData(r),t&&t(`${this.getClassName()} could not be loaded`,o)},i?i.offlineProvider:null)}_loadTexture(){const e=this.getScene(),t=()=>{const s=this._getFloat32ArrayFromArrayBuffer(this._buffer),a=ba.ConvertPanoramaToCubemap(s,this._width,this._height,this._size,this._supersample),o=[];for(let l=0;l<6;l++){const c=a[Uu._FacesMapping[l]];o.push(c)}return o};if(!e)return;const i=t(),r=this._texture;e.getEngine().updateRawCubeTexture(r,i,r.format,r.type,r.invertY),r.isReady=!0,e.removePendingData(r),r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),this._onLoad&&this._onLoad()}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(e.byteLength*3/4);let r=0;for(let s=0;s<e.byteLength;s++)(s+1)%4!==0&&(i[r++]=t.getUint8(s)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new Uu(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}Uu._FacesMapping=["right","left","up","down","front","back"];class E_ extends jt{constructor(e,t,i){if(super(i.scene||i.engine),this.onLoadObservable=new Q,!(!t||!i.engine&&!i.scene)){if(i={...E_._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=O.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._isVideo){const r=this._engine,s=r==null?void 0:r.createExternalTexture;s&&(this._externalTexture=s.call(r,t))}this.anisotropicFilteringLevel=1,this._createInternalTexture()}}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(this._texture==null||t==null)return;const i=this.isReady();if(this._isVideo){const r=this.element;if(r.readyState<r.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:r,e===null?!0:e)}else{const r=this.element;t.updateDynamicTexture(this._texture,r,e===null?!0:e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}E_._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null};class dn{constructor(e,t){if(this.data=e,this.isInvalid=!1,!dn.IsValid(e)){this.isInvalid=!0,w.Error("texture missing KTX identifier");return}const i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),a=r.getUint32(0,!0)===67305985;if(this.glType=r.getUint32(1*i,a),this.glTypeSize=r.getUint32(2*i,a),this.glFormat=r.getUint32(3*i,a),this.glInternalFormat=r.getUint32(4*i,a),this.glBaseInternalFormat=r.getUint32(5*i,a),this.pixelWidth=r.getUint32(6*i,a),this.pixelHeight=r.getUint32(7*i,a),this.pixelDepth=r.getUint32(8*i,a),this.numberOfArrayElements=r.getUint32(9*i,a),this.numberOfFaces=r.getUint32(10*i,a),this.numberOfMipmapLevels=r.getUint32(11*i,a),this.bytesOfKeyValueData=r.getUint32(12*i,a),this.glType!==0){w.Error("only compressed formats currently supported"),this.isInvalid=!0;return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){w.Error("only 2D textures currently supported"),this.isInvalid=!0;return}if(this.numberOfArrayElements!==0){w.Error("texture arrays not currently supported"),this.isInvalid=!0;return}if(this.numberOfFaces!==t){w.Error("number of faces expected"+t+", but found "+this.numberOfFaces),this.isInvalid=!0;return}this.loadType=dn.COMPRESSED_2D}uploadLevels(e,t){switch(this.loadType){case dn.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break}}_upload2DCompressedLevels(e,t){let i=dn.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,s=this.pixelHeight;const a=t?this.numberOfMipmapLevels:1;for(let o=0;o<a;o++){const l=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let c=0;c<this.numberOfFaces;c++){const u=new Uint8Array(this.data.buffer,this.data.byteOffset+i,l);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,r,s,u,c,o),i+=l,i+=3-(l+3)%4}r=Math.max(1,r*.5),s=Math.max(1,s*.5)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}dn.HEADER_LEN=12+13*4;dn.COMPRESSED_2D=0;dn.COMPRESSED_3D=1;dn.TEX_2D=2;dn.TEX_3D=3;var tv;(function(n){n[n.ETC1S=0]="ETC1S",n[n.UASTC4x4=1]="UASTC4x4"})(tv||(tv={}));var Hl;(function(n){n[n.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",n[n.BC7_RGBA=1]="BC7_RGBA",n[n.BC3_RGBA=2]="BC3_RGBA",n[n.BC1_RGB=3]="BC1_RGB",n[n.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",n[n.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",n[n.ETC2_RGBA=6]="ETC2_RGBA",n[n.ETC1_RGB=7]="ETC1_RGB",n[n.RGBA32=8]="RGBA32",n[n.R8=9]="R8",n[n.RG8=10]="RG8"})(Hl||(Hl={}));var iv;(function(n){n[n.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",n[n.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",n[n.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",n[n.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",n[n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",n[n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",n[n.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",n[n.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",n[n.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",n[n.RGBA8Format=32856]="RGBA8Format",n[n.R8Format=33321]="R8Format",n[n.RG8Format=33323]="RG8Format"})(iv||(iv={}));function ku(n,e){const t=(e==null?void 0:e.jsDecoderModule)||KTX2DECODER;n&&(n.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmModuleURL=n.wasmUASTCToASTC),n.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmModuleURL=n.wasmUASTCToBC7),n.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=n.wasmUASTCToRGBA_UNORM),n.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=n.wasmUASTCToRGBA_SRGB),n.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=n.wasmUASTCToR8_UNORM),n.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=n.wasmUASTCToRG8_UNORM),n.jsMSCTranscoder&&(t.MSCTranscoder.JSModuleURL=n.jsMSCTranscoder),n.wasmMSCTranscoder&&(t.MSCTranscoder.WasmModuleURL=n.wasmMSCTranscoder),n.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmModuleURL=n.wasmZSTDDecoder)),e&&(e.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmBinary=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmBinary=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(t.MSCTranscoder.JSModule=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(t.MSCTranscoder.WasmBinary=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmBinary=e.wasmZSTDDecoder))}function $4(n){typeof n>"u"&&typeof KTX2DECODER<"u"&&(n=KTX2DECODER);let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{const i=t.data.urls;i&&(i.jsDecoderModule&&typeof n>"u"&&(importScripts(i.jsDecoderModule),n=KTX2DECODER),ku(i)),t.data.wasmBinaries&&ku(void 0,{...t.data.wasmBinaries,jsDecoderModule:n}),e=new n.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{n.KTX2Decoder.DefaultDecoderOptions=t.data.options;break}case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then(i=>{const r=[];for(let s=0;s<i.mipmaps.length;++s){const a=i.mipmaps[s];a&&a.data&&r.push(a.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},r)}).catch(i=>{postMessage({action:"decoded",success:!1,msg:i})});break}}}function K4(n,e,t){return new Promise((i,r)=>{const s=o=>{n.removeEventListener("error",s),n.removeEventListener("message",a),r(o)},a=o=>{o.data.action==="init"&&(n.removeEventListener("error",s),n.removeEventListener("message",a),i(n))};n.addEventListener("error",s),n.addEventListener("message",a),n.postMessage({action:"init",urls:t,wasmBinaries:e})})}class j4{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[Hl.BC1_RGB,Hl.BC3_RGBA],yes:{transcodeFormat:Hl.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}}class si{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(si._WorkerPoolPromise||si._DecoderModulePromise)return;const t={jsDecoderModule:J.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:J.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:J.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:J.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:J.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:J.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:J.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:J.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:J.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:J.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&typeof Worker=="function"&&typeof URL<"u"?si._WorkerPoolPromise=new Promise(i=>{const r=`${ku}(${$4})()`,s=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));i(new bc(e,()=>K4(new Worker(s),void 0,t)))}):typeof si._KTX2DecoderModule>"u"?si._DecoderModulePromise=J.LoadBabylonScriptAsync(t.jsDecoderModule).then(()=>(si._KTX2DecoderModule=KTX2DECODER,si._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,si._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,ku(t,si._KTX2DecoderModule),new si._KTX2DecoderModule.KTX2Decoder)):(si._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,si._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,si._DecoderModulePromise=Promise.resolve(new si._KTX2DecoderModule.KTX2Decoder))}constructor(e,t=si.DefaultNumWorkers){var r;this._engine=e;const i=typeof t=="object"&&t.workerPool||si.WorkerPool;if(i)si._WorkerPoolPromise=Promise.resolve(i);else{typeof t=="object"?si._KTX2DecoderModule=(r=t==null?void 0:t.binariesAndModulesContainer)==null?void 0:r.jsDecoderModule:typeof KTX2DECODER<"u"&&(si._KTX2DecoderModule=KTX2DECODER);const s=typeof t=="number"?t:t.numWorkers??si.DefaultNumWorkers;si._Initialize(s)}}_uploadAsync(e,t,i){const r=this._engine.getCaps(),s={astc:!!r.astc,bptc:!!r.bptc,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,etc1:!!r.etc1};if(si._WorkerPoolPromise)return si._WorkerPoolPromise.then(a=>new Promise((o,l)=>{a.push((c,u)=>{const h=p=>{c.removeEventListener("error",h),c.removeEventListener("message",f),l(p),u()},f=p=>{if(p.data.action==="decoded"){if(c.removeEventListener("error",h),c.removeEventListener("message",f),!p.data.success)l({message:p.data.msg});else try{this._createTexture(p.data.decodedData,t,i),o()}catch(_){l({message:_})}u()}};c.addEventListener("error",h),c.addEventListener("message",f),c.postMessage({action:"setDefaultDecoderOptions",options:si.DefaultDecoderOptions._getKTX2DecoderOptions()});const d=new Uint8Array(e.byteLength);d.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:d,caps:s,options:i},[d.buffer])})}));if(si._DecoderModulePromise)return si._DecoderModulePromise.then(a=>(si.DefaultDecoderOptions.isDirty&&(si._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=si.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((o,l)=>{a.decode(e,r).then(c=>{this._createTexture(c,t),o()}).catch(c=>{l({message:c})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1;break}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let a=0;a<e.mipmaps.length;++a){const o=e.mipmaps[a];if(!o||!o.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=o.width,t.height=o.height,this._engine._uploadDataToTextureDirectly(t,o.data,0,a,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,o.width,o.height,o.data,0,a)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}si.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};si.DefaultNumWorkers=si.GetDefaultNumWorkers();si.DefaultDecoderOptions=new j4;function q4(){const n={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21};let e=null;onmessage=a=>{if(a.data.action==="init"){if(a.data.url)try{importScripts(a.data.url)}catch(o){postMessage({action:"error",error:o})}e||(e=BASIS({wasmBinary:a.data.wasmBinary})),e!==null&&e.then(o=>{BASIS=o,o.initializeBasis(),postMessage({action:"init"})})}else if(a.data.action==="transcode"){const o=a.data.config,l=a.data.imageData,c=new BASIS.BasisFile(l),u=i(c);let h=a.data.ignoreSupportedFormats?null:t(a.data.config,u),f=!1;h===null&&(f=!0,h=u.hasAlpha?n.cTFBC3:n.cTFBC1);let d=!0;c.startTranscoding()||(d=!1);const p=[];for(let _=0;_<u.images.length&&d;_++){const g=u.images[_];if(o.loadSingleImage===void 0||o.loadSingleImage===_){let E=g.levels.length;o.loadMipmapLevels===!1&&(E=1);for(let v=0;v<E;v++){const x=g.levels[v],A=r(c,_,v,h,f);if(!A){d=!1;break}x.transcodedPixels=A,p.push(x.transcodedPixels.buffer)}}}c.close(),c.delete(),f&&(h=-1),d?postMessage({action:"transcode",success:d,id:a.data.id,fileInfo:u,format:h},p):postMessage({action:"transcode",success:d,id:a.data.id})}};function t(a,o){let l=null;return a.supportedCompressionFormats&&(a.supportedCompressionFormats.astc?l=n.cTFASTC_4x4:a.supportedCompressionFormats.bc7?l=n.cTFBC7:a.supportedCompressionFormats.s3tc?l=o.hasAlpha?n.cTFBC3:n.cTFBC1:a.supportedCompressionFormats.pvrtc?l=o.hasAlpha?n.cTFPVRTC1_4_RGBA:n.cTFPVRTC1_4_RGB:a.supportedCompressionFormats.etc2?l=n.cTFETC2:a.supportedCompressionFormats.etc1?l=n.cTFETC1:l=n.cTFRGB565),l}function i(a){const o=a.getHasAlpha(),l=a.getNumImages(),c=[];for(let h=0;h<l;h++){const f={levels:[]},d=a.getNumLevels(h);for(let p=0;p<d;p++){const _={width:a.getImageWidth(h,p),height:a.getImageHeight(h,p)};f.levels.push(_)}c.push(f)}return{hasAlpha:o,images:c}}function r(a,o,l,c,u){const h=a.getImageTranscodedSizeInBytes(o,l,c);let f=new Uint8Array(h);if(!a.transcodeImage(f,o,l,c,1,0))return null;if(u){const d=a.getImageWidth(o,l)+3&-4,p=a.getImageHeight(o,l)+3&-4;f=s(f,0,d,p)}return f}function s(a,o,l,c){const u=new Uint16Array(4),h=new Uint16Array(l*c),f=l/4,d=c/4;for(let p=0;p<d;p++)for(let _=0;_<f;_++){const g=o+8*(p*f+_);u[0]=a[g]|a[g+1]<<8,u[1]=a[g+2]|a[g+3]<<8,u[2]=(2*(u[0]&31)+1*(u[1]&31))/3|(2*(u[0]&2016)+1*(u[1]&2016))/3&2016|(2*(u[0]&63488)+1*(u[1]&63488))/3&63488,u[3]=(2*(u[1]&31)+1*(u[0]&31))/3|(2*(u[1]&2016)+1*(u[0]&2016))/3&2016|(2*(u[1]&63488)+1*(u[0]&63488))/3&63488;for(let E=0;E<4;E++){const v=a[g+4+E];let x=(p*4+E)*l+_*4;h[x++]=u[v&3],h[x++]=u[v>>2&3],h[x++]=u[v>>4&3],h[x++]=u[v>>6&3]}}return h}}function Z4(n,e,t){return new Promise((i,r)=>{const s=a=>{a.data.action==="init"?(n.removeEventListener("message",s),i(n)):a.data.action==="error"&&r(a.data.error||"error initializing worker")};n.addEventListener("message",s),n.postMessage({action:"init",url:t?J.GetBabylonScriptURL(t):void 0,wasmBinary:e},[e])})}var Ln;(function(n){n[n.cTFETC1=0]="cTFETC1",n[n.cTFETC2=1]="cTFETC2",n[n.cTFBC1=2]="cTFBC1",n[n.cTFBC3=3]="cTFBC3",n[n.cTFBC4=4]="cTFBC4",n[n.cTFBC5=5]="cTFBC5",n[n.cTFBC7=6]="cTFBC7",n[n.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",n[n.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",n[n.cTFASTC_4x4=10]="cTFASTC_4x4",n[n.cTFATC_RGB=11]="cTFATC_RGB",n[n.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",n[n.cTFRGBA32=13]="cTFRGBA32",n[n.cTFRGB565=14]="cTFRGB565",n[n.cTFBGR565=15]="cTFBGR565",n[n.cTFRGBA4444=16]="cTFRGBA4444",n[n.cTFFXT1_RGB=17]="cTFFXT1_RGB",n[n.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",n[n.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",n[n.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",n[n.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(Ln||(Ln={}));const Sa={JSModuleURL:`${J._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${J._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},Q4=(n,e)=>{let t;switch(n){case Ln.cTFETC1:t=36196;break;case Ln.cTFBC1:t=33776;break;case Ln.cTFBC4:t=33779;break;case Ln.cTFASTC_4x4:t=37808;break;case Ln.cTFETC2:t=37496;break;case Ln.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t};let Lf=null,Ha=null,J4=0;const eW=!1,tW=()=>(Lf||(Lf=new Promise((n,e)=>{Ha?n(Ha):J.LoadFileAsync(J.GetBabylonScriptURL(Sa.WasmModuleURL)).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${q4})()`],{type:"application/javascript"}));Ha=new Worker(i),Z4(Ha,t,Sa.JSModuleURL).then(n,e)}).catch(e)})),Lf),iW=(n,e)=>{const t=n instanceof ArrayBuffer?new Uint8Array(n):n;return new Promise((i,r)=>{tW().then(()=>{const s=J4++,a=l=>{l.data.action==="transcode"&&l.data.id===s&&(Ha.removeEventListener("message",a),l.data.success?i(l.data):r("Transcode is not supported on this device"))};Ha.addEventListener("message",a);const o=new Uint8Array(t.byteLength);o.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),Ha.postMessage({action:"transcode",id:s,imageData:o,config:e,ignoreSupportedFormats:eW},[o.buffer])},s=>{r(s)})})},eu=(n,e)=>{var i,r;let t=(i=e._gl)==null?void 0:i.TEXTURE_2D;n.isCube&&(t=(r=e._gl)==null?void 0:r.TEXTURE_CUBE_MAP),e._bindTextureDirectly(t,n,!0)},rW=(n,e)=>{const t=n.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const r=e.fileInfo.images[i].levels[0];if(n._invertVScale=n.invertY,e.format===-1||e.format===Ln.cTFRGB565)if(n.type=10,n.format=4,t._features.basisNeedsPOT&&(Math.log2(r.width)%1!==0||Math.log2(r.height)%1!==0)){const s=new Yt(t,2);n._invertVScale=n.invertY,s.type=10,s.format=4,s.width=r.width+3&-4,s.height=r.height+3&-4,eu(s,t),t._uploadDataToTextureDirectly(s,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(s,n,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(s),eu(n,t)})}else n._invertVScale=!n.invertY,n.width=r.width+3&-4,n.height=r.height+3&-4,n.samplingMode=2,eu(n,t),t._uploadDataToTextureDirectly(n,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0);else{n.width=r.width,n.height=r.height,n.generateMipMaps=e.fileInfo.images[i].levels.length>1;const s=v_.GetInternalFormatFromBasisFormat(e.format,t);n.format=s,eu(n,t),e.fileInfo.images[i].levels.forEach((a,o)=>{t._uploadCompressedDataToTextureDirectly(n,s,a.width,a.height,a.transcodedPixels,i,o)}),t._features.basisNeedsPOT&&(Math.log2(n.width)%1!==0||Math.log2(n.height)%1!==0)&&(J.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),n._cachedWrapU=Z.CLAMP_ADDRESSMODE,n._cachedWrapV=Z.CLAMP_ADDRESSMODE)}}},v_={JSModuleURL:Sa.JSModuleURL,WasmModuleURL:Sa.WasmModuleURL,GetInternalFormatFromBasisFormat:Q4,TranscodeAsync:iW,LoadTextureFromTranscodeResult:rW};Object.defineProperty(v_,"JSModuleURL",{get:function(){return Sa.JSModuleURL},set:function(n){Sa.JSModuleURL=n}});Object.defineProperty(v_,"WasmModuleURL",{get:function(){return Sa.WasmModuleURL},set:function(n){Sa.WasmModuleURL=n}});const Fy=4,sW=4,wy=1,nW=2,aW=8,xd=65536,F5=xd>>3,oW=16,ha=14,Xl=(1<<oW)+1,S_=1<<ha,rv=S_-1,Cd=59,By=63,lW=2+By-Cd;var sv;(function(n){n[n.NO_COMPRESSION=0]="NO_COMPRESSION",n[n.RLE_COMPRESSION=1]="RLE_COMPRESSION",n[n.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",n[n.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",n[n.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",n[n.PXR24_COMPRESSION=5]="PXR24_COMPRESSION"})(sv||(sv={}));var Ad;(function(n){n[n.INCREASING_Y=0]="INCREASING_Y",n[n.DECREASING_Y=1]="DECREASING_Y"})(Ad||(Ad={}));const tu=cW();function cW(){const n=new ArrayBuffer(4),e=new Float32Array(n),t=new Uint32Array(n),i=new Uint32Array(512),r=new Uint32Array(512);for(let l=0;l<256;++l){const c=l-127;c<-27?(i[l]=0,i[l|256]=32768,r[l]=24,r[l|256]=24):c<-14?(i[l]=1024>>-c-14,i[l|256]=1024>>-c-14|32768,r[l]=-c-1,r[l|256]=-c-1):c<=15?(i[l]=c+15<<10,i[l|256]=c+15<<10|32768,r[l]=13,r[l|256]=13):c<128?(i[l]=31744,i[l|256]=64512,r[l]=24,r[l|256]=24):(i[l]=31744,i[l|256]=64512,r[l]=13,r[l|256]=13)}const s=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let l=1;l<1024;++l){let c=l<<13,u=0;for(;!(c&8388608);)c<<=1,u-=8388608;c&=-8388609,u+=947912704,s[l]=c|u}for(let l=1024;l<2048;++l)s[l]=939524096+(l-1024<<13);for(let l=1;l<31;++l)a[l]=l<<23;a[31]=1199570944,a[32]=2147483648;for(let l=33;l<63;++l)a[l]=2147483648+(l-32<<23);a[63]=3347054592;for(let l=1;l<64;++l)l!==32&&(o[l]=1024);return{floatView:e,uint32View:t,baseTable:i,shiftTable:r,mantissaTable:s,exponentTable:a,offsetTable:o}}function uW(n,e){const t=new Uint8Array(n);let i=0;for(;t[e.value+i]!=0;)i+=1;const r=new TextDecoder().decode(t.slice(e.value,e.value+i));return e.value=e.value+i+1,r}function zn(n,e){const t=n.getInt32(e.value,!0);return e.value+=Fy,t}function Yo(n,e){const t=n.getUint32(e.value,!0);return e.value+=Fy,t}function T_(n,e){const t=n.getUint8(e.value);return e.value+=wy,t}function hW(n,e){const t=n.getUint16(e.value,!0);return e.value+=nW,t}function Vy(n,e){const t=n[e.value];return e.value+=wy,t}function w5(n,e){let t;return"getBigInt64"in DataView.prototype?t=Number(n.getBigInt64(e.value,!0)):t=n.getUint32(e.value+4,!0)+Number(n.getUint32(e.value,!0)<<32),e.value+=aW,t}function Kr(n,e){const t=n.getFloat32(e.value,!0);return e.value+=sW,t}function B5(n,e){return fW(hW(n,e))}function fW(n){const e=(n&31744)>>10,t=n&1023;return(n>>15?-1:1)*(e?e===31?t?NaN:1/0:Math.pow(2,e-15)*(1+t/1024):6103515625e-14*(t/1024))}function dW(n){if(Math.abs(n)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");n=vt(n,-65504,65504),tu.floatView[0]=n;const e=tu.uint32View[0],t=e>>23&511;return tu.baseTable[t]+((e&8388607)>>tu.shiftTable[t])}function V5(n,e){return dW(Kr(n,e))}function pW(n,e,t){const i=new TextDecoder().decode(new Uint8Array(n).slice(e.value,e.value+t));return e.value=e.value+t,i}function _W(n,e){const t=zn(n,e),i=Yo(n,e);return[t,i]}function mW(n,e){const t=Yo(n,e),i=Yo(n,e);return[t,i]}function gW(n,e){const t=Kr(n,e),i=Kr(n,e);return[t,i]}function EW(n,e){const t=Kr(n,e),i=Kr(n,e),r=Kr(n,e);return[t,i,r]}function vW(n,e,t){const i=e.value,r=[];for(;e.value<i+t-1;){const s=uW(n.buffer,e),a=zn(n,e),o=T_(n,e);e.value+=3;const l=zn(n,e),c=zn(n,e);r.push({name:s,pixelType:a,pLinear:o,xSampling:l,ySampling:c})}return e.value+=1,r}function SW(n,e){const t=Kr(n,e),i=Kr(n,e),r=Kr(n,e),s=Kr(n,e),a=Kr(n,e),o=Kr(n,e),l=Kr(n,e),c=Kr(n,e);return{redX:t,redY:i,greenX:r,greenY:s,blueX:a,blueY:o,whiteX:l,whiteY:c}}function TW(n,e){return T_(n,e)}function xW(n,e){const t=zn(n,e),i=zn(n,e),r=zn(n,e),s=zn(n,e);return{xMin:t,yMin:i,xMax:r,yMax:s}}function CW(n,e){const t=T_(n,e);return Ad[t]}function U5(n,e,t,i){switch(t){case"string":case"stringvector":case"iccProfile":return pW(n.buffer,e,i);case"chlist":return vW(n,e,i);case"chromaticities":return SW(n,e);case"compression":return TW(n,e);case"box2i":return xW(n,e);case"lineOrder":return CW(n,e);case"float":return Kr(n,e);case"v2f":return gW(n,e);case"v3f":return EW(n,e);case"int":return zn(n,e);case"rational":return _W(n,e);case"timecode":return mW(n,e);case"preview":return e.value+=i,"skipped";default:e.value+=i;return}}function k5(n){for(let e=1;e<n.length;e++){const t=n[e-1]+n[e]-128;n[e]=t}}function G5(n,e){let t=0,i=Math.floor((n.length+1)/2),r=0;const s=n.length-1;for(;!(r>s||(e[r++]=n[t++],r>s));)e[r++]=n[i++]}const Uy=16,AW=1<<Uy-1,nv=(1<<Uy)-1;function z5(n,e){let t=0;for(let r=0;r<xd;++r)(r==0||n[r>>3]&1<<(r&7))&&(e[t++]=r);const i=t-1;for(;t<xd;)e[t++]=0;return i}function IW(n){for(let e=0;e<S_;e++)n[e]={},n[e].len=0,n[e].lit=0,n[e].p=null}function av(n,e,t,i,r){for(;t<n;)e=e<<8|Vy(i,r),t+=8;return t-=n,{l:e>>t&(1<<n)-1,c:e,lc:t}}function Id(n,e,t,i){return n=n<<8|Vy(t,i),e+=8,{c:n,lc:e}}function Ff(n,e,t,i,r,s,a,o,l){if(n==e){if(i<8){const h=Id(t,i,r,s);t=h.c,i=h.lc}i-=8;let c=t>>i;if(c=new Uint8Array([c])[0],o.value+c>l)return null;const u=a[o.value-1];for(;c-- >0;)a[o.value++]=u}else if(o.value<l)a[o.value++]=n;else return null;return{c:t,lc:i}}const Rl=new Array(59);function yW(n){for(let t=0;t<=58;++t)Rl[t]=0;for(let t=0;t<Xl;++t)Rl[n[t]]+=1;let e=0;for(let t=58;t>0;--t){const i=e+Rl[t]>>1;Rl[t]=e,e=i}for(let t=0;t<Xl;++t){const i=n[t];i>0&&(n[t]=i|Rl[i]++<<6)}}function bW(n,e,t,i,r,s){const a=e;let o=0,l=0;for(;i<=r;i++){if(a.value-e.value>t)return;let c=av(6,o,l,n,a);const u=c.l;if(o=c.c,l=c.lc,s[i]=u,u==By){if(a.value-e.value>t)throw new Error("Error in HufUnpackEncTable");c=av(8,o,l,n,a);let h=c.l+lW;if(o=c.c,l=c.lc,i+h>r+1)throw new Error("Error in HufUnpackEncTable");for(;h--;)s[i++]=0;i--}else if(u>=Cd){let h=u-Cd+2;if(i+h>r+1)throw new Error("Error in HufUnpackEncTable");for(;h--;)s[i++]=0;i--}}yW(s)}function ky(n){return n&63}function Gy(n){return n>>6}function RW(n,e,t,i){for(;e<=t;e++){const r=Gy(n[e]),s=ky(n[e]);if(r>>s)throw new Error("Invalid table entry");if(s>ha){const a=i[r>>s-ha];if(a.len)throw new Error("Invalid table entry");if(a.lit++,a.p){const o=a.p;a.p=new Array(a.lit);for(let l=0;l<a.lit-1;++l)a.p[l]=o[l]}else a.p=new Array(1);a.p[a.lit-1]=e}else if(s){let a=0;for(let o=1<<ha-s;o>0;o--){const l=i[(r<<ha-s)+a];if(l.len||l.p)throw new Error("Invalid table entry");l.len=s,l.lit=e,a++}}}return!0}function PW(n,e,t,i,r,s,a,o,l){let c=0,u=0;const h=a,f=Math.trunc(i.value+(r+7)/8);for(;i.value<f;){let p=Id(c,u,t,i);for(c=p.c,u=p.lc;u>=ha;){const _=c>>u-ha&rv,g=e[_];if(g.len){u-=g.len;const E=Ff(g.lit,s,c,u,t,i,o,l,h);E&&(c=E.c,u=E.lc)}else{if(!g.p)throw new Error("hufDecode issues");let E;for(E=0;E<g.lit;E++){const v=ky(n[g.p[E]]);for(;u<v&&i.value<f;)p=Id(c,u,t,i),c=p.c,u=p.lc;if(u>=v&&Gy(n[g.p[E]])==(c>>u-v&(1<<v)-1)){u-=v;const x=Ff(g.p[E],s,c,u,t,i,o,l,h);x&&(c=x.c,u=x.lc);break}}if(E==g.lit)throw new Error("HufDecode issues")}}}const d=8-r&7;for(c>>=d,u-=d;u>0;){const p=e[c<<ha-u&rv];if(p.len){u-=p.len;const _=Ff(p.lit,s,c,u,t,i,o,l,h);_&&(c=_.c,u=_.lc)}else throw new Error("HufDecode issues")}return!0}function W5(n,e,t,i,r,s){const a={value:0},o=t.value,l=Yo(e,t),c=Yo(e,t);t.value+=4;const u=Yo(e,t);if(t.value+=4,l<0||l>=Xl||c<0||c>=Xl)throw new Error("Wrong HUF_ENCSIZE");const h=new Array(Xl),f=new Array(S_);IW(f);const d=i-(t.value-o);if(bW(n,t,d,l,c,h),u>8*(i-(t.value-o)))throw new Error("Wrong hufUncompress");RW(h,l,c,f),PW(h,f,n,t,u,c,s,r,a)}function yd(n){return n&65535}function ov(n){const e=yd(n);return e>32767?e-65536:e}function Ao(n,e){const t=ov(n),r=ov(e),s=t+(r&1)+(r>>1),a=s,o=s-r;return{a,b:o}}function Io(n,e){const t=yd(n),i=yd(e),r=t-(i>>1)&nv;return{a:i+r-AW&nv,b:r}}function H5(n,e,t,i,r,s,a){const o=a<16384,l=t>r?r:t;let c=1,u,h;for(;c<=l;)c<<=1;for(c>>=1,u=c,c>>=1;c>=1;){h=0;const f=h+s*(r-u),d=s*c,p=s*u,_=i*c,g=i*u;let E,v,x,A;for(;h<=f;h+=p){let T=h;const C=h+i*(t-u);for(;T<=C;T+=g){const y=T+_,P=T+d,D=P+_;if(o){let F=Ao(n[T+e],n[P+e]);E=F.a,x=F.b,F=Ao(n[y+e],n[D+e]),v=F.a,A=F.b,F=Ao(E,v),n[T+e]=F.a,n[y+e]=F.b,F=Ao(x,A),n[P+e]=F.a,n[D+e]=F.b}else{let F=Io(n[T+e],n[P+e]);E=F.a,x=F.b,F=Io(n[y+e],n[D+e]),v=F.a,A=F.b,F=Io(E,v),n[T+e]=F.a,n[y+e]=F.b,F=Io(x,A),n[P+e]=F.a,n[D+e]=F.b}}if(t&c){const y=T+d;let P;o?P=Ao(n[T+e],n[y+e]):P=Io(n[T+e],n[y+e]),E=P.a,n[y+e]=P.b,n[T+e]=E}}if(r&c){let T=h;const C=h+i*(t-u);for(;T<=C;T+=g){const y=T+_;let P;o?P=Ao(n[T+e],n[y+e]):P=Io(n[T+e],n[y+e]),E=P.a,n[y+e]=P.b,n[T+e]=E}}u=c,c>>=1}return h}function X5(n,e,t){for(let i=0;i<t;++i)e[i]=n[e[i]]}var bd;(function(n){n[n.Float=0]="Float",n[n.HalfFloat=1]="HalfFloat"})(bd||(bd={}));class zy{}zy.DefaultOutputType=bd.HalfFloat;zy.FFLATEUrl="https://unpkg.com/fflate@0.8.2";class Uh extends mr{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,s=0,a=Z.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,r,!0,s,!1,a,o),this.mirrorPlane=new Vr(0,1,0,1),this._transformMatrix=O.Zero(),this._mirrorMatrix=O.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()}),i.getEngine().supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`));let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),O.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=m.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new En("horizontal blur",new se(1,0),this._blurKernelX,this._blurRatio,null,Z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new En("vertical blur",new se(0,1),this._blurKernelY,this._blurRatio,null,Z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Uh(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var t;super.dispose();const e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(t=this._sceneUBO)==null||t.dispose()}}Z._CreateMirror=(n,e,t,i)=>new Uh(n,e,t,i);class MW{constructor(e){this.name=we.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(we.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){J.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}J.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}class An extends Z{get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,s=null,a=!0,o=!1,l=0){super(null,r,!a),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new Q,this.onBeforeGenerationObservable=new Q,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,s!==null&&!(s instanceof Z)?(this._options=s,this._fallbackTexture=s.fallbackTexture??null):(this._options={},this._fallbackTexture=s),this._shaderLanguage=this._options.shaderLanguage??0,r=this.getScene()||$e.LastCreatedScene;let c=r._getComponent(we.NAME_PROCEDURALTEXTURE);c||(c=new MW(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=a,this._drawWrapper=new ds(this._fullEngine),this.setFragment(i);const u=this._createRtWrapper(o,t,a,l);this._texture=u.texture;const h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1),this._vertexBuffers[b.PositionKind]=new b(this._fullEngine,h,b.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[b.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===mr.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=mr.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)==null||e.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady()){e(this);return}const t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[b.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{var r;(r=this._rtWrapper)==null||r.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0},void 0,this._shaderLanguage,async()=>{this._options.extraInitializationsAsync?this.shaderLanguage===1?await Promise.all([re(()=>Promise.resolve().then(()=>cv),void 0),this._options.extraInitializationsAsync()]):await Promise.all([re(()=>Promise.resolve().then(()=>uv),void 0),this._options.extraInitializationsAsync()]):this.shaderLanguage===1?await re(()=>Promise.resolve().then(()=>cv),void 0):await re(()=>Promise.resolve().then(()=>uv),void 0)})),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var s,a,o,l;const t=this.getScene();if(!t)return;const i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(const c in this._textures)this._drawWrapper.effect.setTexture(c,this._textures[c]);for(const c in this._ints)this._drawWrapper.effect.setInt(c,this._ints[c]);for(const c in this._floats)this._drawWrapper.effect.setFloat(c,this._floats[c]);for(const c in this._floatsArrays)this._drawWrapper.effect.setArray(c,this._floatsArrays[c]);for(const c in this._colors3)this._drawWrapper.effect.setColor3(c,this._colors3[c]);for(const c in this._colors4){const u=this._colors4[c];this._drawWrapper.effect.setFloat4(c,u.r,u.g,u.b,u.a)}for(const c in this._vectors2)this._drawWrapper.effect.setVector2(c,this._vectors2[c]);for(const c in this._vectors3)this._drawWrapper.effect.setVector3(c,this._vectors3[c]);for(const c in this._vectors4)this._drawWrapper.effect.setVector4(c,this._vectors4[c]);for(const c in this._matrices)this._drawWrapper.effect.setMatrix(c,this._matrices[c])}if(!this._texture||!this._rtWrapper)return;(s=i._debugPushGroup)==null||s.call(i,`procedural texture generation for ${this.name}`,1);const r=i.currentViewport;if(this.isCube)for(let c=0;c<6;c++)i.bindFramebuffer(this._rtWrapper,c,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",c),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(pe.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let c=1;this._rtWrapper.is3D?c=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(c=this._rtWrapper.layers);for(let u=0;u<c;u++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,u),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){(a=this._drawWrapper.effect)==null||a.setFloat("layer",c!==1?u/(c-1):0),(o=this._drawWrapper.effect)==null||o.setInt("layerNum",u);for(const h in this._textures)this._drawWrapper.effect.setTexture(h,this._textures[h])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(pe.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),(l=i._debugPopGroup)==null||l.call(i,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new An(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[b.PositionKind];i&&(i.dispose(),this._vertexBuffers[b.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}I([M()],An.prototype,"isEnabled",void 0);I([M()],An.prototype,"autoClear",void 0);I([M()],An.prototype,"_generateMipMaps",void 0);I([M()],An.prototype,"_size",void 0);I([M()],An.prototype,"refreshRate",null);$("BABYLON.ProceduralTexture",An);const DW="noisePixelShader",OW=`uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)
{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}
float interpolationNoise(vec2 p)
{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); 
return ym;}
float perlinNoise2D(float x,float y)
{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)
{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}
return sum;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}
`;V.ShadersStore[DW]=OW;class Gu extends An{constructor(e,t=256,i=$e.LastCreatedScene,r,s){super(e,t,"noise",i,r,s),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(this.octaves|0)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new Gu(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){const i=new Gu(e.name,e.size,t,void 0,e.generateMipMaps);return i.brightness=e.brightness,i.octaves=e.octaves,i.persistence=e.persistence,i.animationSpeedFactor=e.animationSpeedFactor,i.time=e.time??0,i}}$("BABYLON.NoiseProceduralTexture",Gu);function lv(n){for(;n.firstChild;)n.removeChild(n.firstChild);n.srcObject=null,n.src="",n.removeAttribute("src")}class Ta extends Z{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new Q),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e==null?void 0:e.message):w.Error(e==null?void 0:e.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if((e==null?void 0:e.name)==="NotAllowedError"){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers()){this._onUserActionRequestedObservable.notifyObservers(this);return}else if(!this.video.muted){w.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,this.video.play().catch(t=>{this._processError(t)});return}}this._processError(e)})}constructor(e,t,i,r=!1,s=!1,a=Z.TRILINEAR_SAMPLINGMODE,o={},l,c=5){super(null,i,!r,s),this._externalTexture=null,this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{this._texture!=null&&this._texture.dispose(),!this._getEngine().needPOTTextures||J.IsExponentOfTwo(this.video.videoWidth)&&J.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=Z.WRAP_ADDRESSMODE,this.wrapV=Z.WRAP_ADDRESSMODE):(this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=this._format??5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(this._texture!=null)if(this._displayingPosterTexture)this._displayingPosterTexture=!1;else return;if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),!this.video.autoplay&&!this._settings.poster&&!this._settings.independentVideoSource){const d=this.video.onplaying,p=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=p,this.video.onplaying=d,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}else this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._reset=()=>{this._texture!=null&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(this._texture==null||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;const d=this.getScene().getFrameId();this._frameId!==d&&(this._frameId=d,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...o},this._onError=l,this._generateMipMaps=r,this._initialSamplingMode=a,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t);const u=this._engine,h=u==null?void 0:u.createExternalTexture;h&&(this._externalTexture=h.call(u,this.video)),this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),this._settings.autoPlay!==void 0&&(this.video.autoplay=this._settings.autoPlay),this._settings.loop!==void 0&&(this.video.loop=this._settings.loop),this._settings.muted!==void 0&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("loadeddata",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=c;const f=this.video.readyState>=this.video.HAVE_CURRENT_DATA;this._settings.poster&&(!this._settings.autoPlay||!f)?(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0):f&&this._createInternalTexture()}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return J.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return typeof e=="string"?(J.SetCorsBehavior(e,t),t.src=e):(J.SetCorsBehavior(e[0],t),e.forEach(i=>{const r=document.createElement("source");r.src=i,t.appendChild(r)})),this.onDisposeObservable.addOnce(()=>{lv(t)}),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new Ta(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){var e;super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("loadeddata",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),(e=this._externalTexture)==null||e.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){const s=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(s),s.style.transform="scale(0.0001, 0.0001)",s.style.opacity="0",s.style.position="fixed",s.style.bottom="0px",s.style.right="0px"),s.setAttribute("autoplay",""),s.setAttribute("muted","true"),s.setAttribute("playsinline",""),s.muted=!0,s.isNative||(typeof s.srcObject=="object"?s.srcObject=t:s.src=window.URL&&window.URL.createObjectURL(t)),new Promise(a=>{const o=()=>{const l=new Ta("video",s,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{s.remove()}),l.onDisposeObservable.addOnce(()=>{lv(s)}),a(l),s.removeEventListener("playing",o)};s.addEventListener("playing",o),s.play()})}static async CreateFromWebCamAsync(e,t,i=!1,r=!0){if(navigator.mediaDevices){const s=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),a=await this.CreateFromStreamAsync(e,s,t,r);return a.onDisposeObservable.addOnce(()=>{s.getTracks().forEach(o=>{o.stop()})}),a}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,r=!1,s=!0){this.CreateFromWebCamAsync(e,i,r,s).then(function(a){t&&t(a)}).catch(function(a){w.Error(a.name)})}}I([M("settings")],Ta.prototype,"_settings",void 0);I([M("src")],Ta.prototype,"_currentSrc",void 0);I([M()],Ta.prototype,"isVideo",void 0);Z._CreateVideoTexture=(n,e,t,i=!1,r=!1,s=Z.TRILINEAR_SAMPLINGMODE,a={},o,l=5)=>new Ta(n,e,t,i,r,s,a,o,l);$("BABYLON.VideoTexture",Ta);const Wy="proceduralVertexShader",Hy=`attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStoreWGSL[Wy]=Hy;const NW={name:Wy,shader:Hy},cv=Object.freeze(Object.defineProperty({__proto__:null,proceduralVertexShaderWGSL:NW},Symbol.toStringTag,{value:"Module"})),Xy="proceduralVertexShader",Yy=`attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStore[Xy]=Yy;const LW={name:Xy,shader:Yy},uv=Object.freeze(Object.defineProperty({__proto__:null,proceduralVertexShader:LW},Symbol.toStringTag,{value:"Module"})),$y="hdrFilteringVertexShader",Ky=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStore[$y]=Ky;const FW={name:$y,shader:Ky},wW=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringVertexShader:FW},Symbol.toStringTag,{value:"Module"})),jy="hdrFilteringPixelShader",qy=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}`;V.ShadersStore[jy]=qy;const BW={name:jy,shader:qy},VW=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringPixelShader:BW},Symbol.toStringTag,{value:"Module"})),Zy="hdrFilteringVertexShader",Qy=`attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStoreWGSL[Zy]=Qy;const UW={name:Zy,shader:Qy},kW=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringVertexShaderWGSL:UW},Symbol.toStringTag,{value:"Module"})),Jy="hdrFilteringPixelShader",eb=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}`;V.ShadersStoreWGSL[Jy]=eb;const GW={name:Jy,shader:eb},zW=Object.freeze(Object.defineProperty({__proto__:null,hdrFilteringPixelShaderWGSL:GW},Symbol.toStringTag,{value:"Module"}));var N;(function(n){n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Neutral=4]="Neutral",n[n.VertexAndFragment=3]="VertexAndFragment"})(N||(N={}));var S;(function(n){n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=4]="Vector2",n[n.Vector3=8]="Vector3",n[n.Vector4=16]="Vector4",n[n.Color3=32]="Color3",n[n.Color4=64]="Color4",n[n.Matrix=128]="Matrix",n[n.Object=256]="Object",n[n.AutoDetect=1024]="AutoDetect",n[n.BasedOnInput=2048]="BasedOnInput",n[n.All=4095]="All"})(S||(S={}));var hv;(function(n){n[n.Uniform=0]="Uniform",n[n.Attribute=1]="Attribute",n[n.Varying=2]="Varying",n[n.Undefined=3]="Undefined"})(hv||(hv={}));var Et;(function(n){n[n.World=1]="World",n[n.View=2]="View",n[n.Projection=3]="Projection",n[n.ViewProjection=4]="ViewProjection",n[n.WorldView=5]="WorldView",n[n.WorldViewProjection=6]="WorldViewProjection",n[n.CameraPosition=7]="CameraPosition",n[n.FogColor=8]="FogColor",n[n.DeltaTime=9]="DeltaTime",n[n.CameraParameters=10]="CameraParameters",n[n.MaterialAlpha=11]="MaterialAlpha"})(Et||(Et={}));var Mr;(function(n){n[n.Material=0]="Material",n[n.PostProcess=1]="PostProcess",n[n.Particle=2]="Particle",n[n.ProceduralTexture=3]="ProceduralTexture",n[n.GaussianSplatting=4]="GaussianSplatting"})(Mr||(Mr={}));var fv;(function(n){n[n.Compatible=0]="Compatible",n[n.TypeIncompatible=1]="TypeIncompatible",n[n.TargetIncompatible=2]="TargetIncompatible",n[n.HierarchyIssue=3]="HierarchyIssue"})(fv||(fv={}));var dv;(function(n){n[n.Input=0]="Input",n[n.Output=1]="Output"})(dv||(dv={}));class nl{static AreEquivalentTypes(e,t){switch(e){case S.Vector3:{if(t===S.Color3)return!0;break}case S.Vector4:{if(t===S.Color4)return!0;break}case S.Color3:{if(t===S.Vector3)return!0;break}case S.Color4:{if(t===S.Vector4)return!0;break}}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){var t;this._connectedPointBackingField!==e&&((t=this._connectedPointTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){var t;this._typeConnectionSourceBackingField!==e&&((t=this._typeConnectionSourceTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){var t;this._linkedConnectionSourceBackingField!==e&&((t=this._linkedConnectionSourceTypeChangedObserver)==null||t.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.declarationVariableName:this._associatedVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===S.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type}if(this._type===S.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==N.VertexAndFragment?this._target:this._ownerBlock.target===N.Fragment?N.Fragment:N.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===N.Vertex||(e.ownerBlock.target===N.Neutral||e.ownerBlock.target===N.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===N.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===N.Vertex||e.target===N.Vertex||(e.ownerBlock.target===N.Neutral||e.ownerBlock.target===N.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===N.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===N.Fragment||(e.ownerBlock.target===N.Neutral||e.ownerBlock.target===N.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=S.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new Q,this.onDisconnectionObservable=new Q,this.onTypeChangedObservable=new Q,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=N.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===N.Fragment){if(i.target===N.Vertex)return 2;for(const a of i.outputs)if(a.ownerBlock.target!=N.Neutral&&a.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==S.AutoDetect)return nl.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&nl.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,s=t;return this.direction===0&&(r=t,s=i),r.isAnAncestorOf(s)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<S.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){const t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){const t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}class ti extends nl{constructor(e,t,i,r,s){super(e,t,i),this._blockType=r,this._blockName=s,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof ti&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class ze{get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=N.Vertex,i=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this.onCodeIsReadyObservable=new Q,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===N.Neutral,this._isFinalMerger=i,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0;break}this._name=e,this.uniqueId=vc.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===N.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,i=!1,r,s){return s=s??new nl(e,this,0),s.type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return r=r??new nl(e,this,1),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===S.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===N.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){const s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===N.Vertex?!1:!!((this.target===N.VertexAndFragment||this.target===N.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);const s=t._vertexState!=null,a=e._buildTarget===N.Vertex&&e.target!==N.VertexAndFragment;if(s&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==N.VertexAndFragment&&a)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const o=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+o.declarationVariableName,o.type)){const c=t.shaderLanguage===1?"vertexOutputs.":"";t._vertexState.compilationString+=`${c}${"v_"+o.declarationVariableName} = ${o.associatedVariableName};
`}const l=t.shaderLanguage===1?"fragmentInputs.":"";i.associatedVariableName=l+"v_"+o.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==N.Neutral&&(!(i.target&this.target)||!(i.target&e.target)))continue;const r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&w.Log(`${e.target===N.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case N.Vertex:e.sharedData.checks.emitVertex=!0;break;case N.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(!i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const s=r.ownerBlock;s&&(s.target&e.target&&t.indexOf(s)!==-1||e._terminalBlocks.has(s))&&this._processBuild(s,e,r,t)}this._postBuildBlock(e);for(const i of this._outputs)if(i._forPostBuild&&i.target&e.target)for(const r of i.endpoints){const s=r.ownerBlock;s&&s.target&e.target&&t.indexOf(s)!==-1&&this._processBuild(s,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let s=0;do s++,this._codeVariableName=i+s;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`,r+=this._dumpPropertiesCode();for(const s of this.inputs){if(!s.isConnected)continue;const o=s.connectedPoint.ownerBlock;t.indexOf(o)===-1&&(r+=o._dumpCode(e,t))}for(const s of this.outputs)if(s.hasEndpoints)for(const a of s.endpoints){const o=a.ownerBlock;o&&t.indexOf(o)===-1&&(r+=o._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}clone(e,t=""){const i=this.serialize(),r=Ai(i.customType);if(r){const s=new r;return s._deserialize(i,e,t),s}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((r,s)=>{r.displayName&&(this.inputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.inputs[s].isExposedOnFrame=r.isExposedOnFrame,this.inputs[s].exposedPortPosition=r.exposedPortPosition)}),i&&i.forEach((r,s)=>{r.displayName&&(this.outputs[s].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[s].isExposedOnFrame=r.isExposedOnFrame,this.outputs[s].exposedPortPosition=r.exposedPortPosition)})}dispose(){this.onCodeIsReadyObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class zu extends ze{get transformAsDirection(){return this.complementW===0}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,N.Neutral),this.complementW=1,this.complementZ=0,this.target=N.Vertex,this.registerInput("vector",S.AutoDetect),this.registerInput("transform",S.Matrix),this.registerOutput("output",S.Vector4),this.registerOutput("xyz",S.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform,r=e._getShaderType(S.Vector4),s=e._getShaderType(S.Vector3);if(t.connectedPoint){if(this.complementW===0||this.transformAsDirection){const a=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",a),e.sharedData.blocksWithDefines.push(this);const o=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.shaderLanguage===1?e.compilationString+=`var ${o}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${o} = mat3(${i.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${o} = transposeMat3(inverseMat3(${o}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case S.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case S.Vector3:case S.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${o} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`;break}}else{const a=i.associatedVariableName;switch(t.connectedPoint.type){case S.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${a} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case S.Vector3:case S.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${a} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${a} * ${t.associatedVariableName};
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};
`,e}}I([Ne("Transform as direction",0,void 0,{embedded:!0})],zu.prototype,"transformAsDirection",null);$("BABYLON.TransformBlock",zu);class mu extends ze{constructor(e){super(e,N.Vertex,!0),this.registerInput("vector",S.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const i of e)if(i.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=e.shaderLanguage===1;if(e.shaderLanguage===1?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",S.Float),e._emitVaryingFromString("vFragmentDepth",S.Float);const r=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",s=i?"uniforms.":"",a=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${r} = 1.0 + ${a}.w;
`,e.compilationString+=`${a}.z = log2(max(0.000001, ${r})) * ${s}logarithmicDepthConstant;
`}return this}}$("BABYLON.VertexOutputBlock",mu);var cn;(function(n){n[n.NoColorSpace=0]="NoColorSpace",n[n.Gamma=1]="Gamma",n[n.Linear=2]="Linear"})(cn||(cn={}));class Xa extends ze{constructor(e){super(e,N.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",S.Color4,!0),this.registerInput("rgb",S.AutoDetect,!0),this.registerInput("a",S.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Float)}get colorSpace(){return this.convertToGammaSpace?cn.Gamma:this.convertToLinearSpace?cn.Linear:cn.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===cn.Gamma,this.convertToLinearSpace=e===cn.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&Qn(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,r=this.a,s=e.shaderLanguage===1;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",S.Float),e._emitVaryingFromString("vFragmentDepth",S.Float),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const a=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",a);let o="gl_FragColor";e.shaderLanguage===1&&(e.compilationString+=`var fragmentOutputsColor : vec4<f32>;\r
`,o="fragmentOutputsColor");const l=e._getShaderType(S.Vector4);if(t.connectedPoint)r.isConnected?e.compilationString+=`${o} = ${l}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${o}  = ${t.associatedVariableName};
`;else if(i.connectedPoint){let c="1.0";r.connectedPoint&&(c=r.associatedVariableName),i.connectedPoint.type===S.Float?e.compilationString+=`${o}  = ${l}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${c});
`:e.compilationString+=`${o}  = ${l}(${i.associatedVariableName}, ${c});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${o}  = toLinearSpace(${o});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${o}  = toGammaSpace(${o});
`,e.compilationString+=`#endif
`,e.shaderLanguage===1&&(e.compilationString+=`#if !defined(PREPASS)\r
`,e.compilationString+=`fragmentOutputs.color = fragmentOutputsColor;\r
`,e.compilationString+=`#endif\r
`),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){const c=s?"input.vFragmentDepth":"vFragmentDepth",u=s?"uniforms.":"",h=s?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${h} = log2(${c}) * ${u}logarithmicDepthConstant * 0.5;
`}return e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`${s?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${o};\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}I([Ne("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],Xa.prototype,"useLogarithmicDepth",void 0);I([Ne("Color space",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:cn.NoColorSpace},{label:"Gamma",value:cn.Gamma},{label:"Linear",value:cn.Linear}]})],Xa.prototype,"colorSpace",null);$("BABYLON.FragmentOutputBlock",Xa);var Fn;(function(n){n[n.None=0]="None",n[n.Time=1]="Time",n[n.RealTime=2]="RealTime",n[n.MouseInfo=3]="MouseInfo"})(Fn||(Fn={}));const WW={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},wf={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},pv={particle_texturemask:!0};class _t extends ze{get type(){if(this._type===S.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=S.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=S.Vector2,this._type;case"Vector3":return this._type=S.Vector3,this._type;case"Vector4":return this._type=S.Vector4,this._type;case"Color3":return this._type=S.Color3,this._type;case"Color4":return this._type=S.Color4,this._type;case"Matrix":return this._type=S.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=S.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=S.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":return this._type=S.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=S.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=S.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Et.World:case Et.WorldView:case Et.WorldViewProjection:case Et.View:case Et.ViewProjection:case Et.Projection:return this._type=S.Matrix,this._type;case Et.CameraPosition:return this._type=S.Vector3,this._type;case Et.FogColor:return this._type=S.Color3,this._type;case Et.DeltaTime:case Et.MaterialAlpha:return this._type=S.Float,this._type;case Et.CameraParameters:return this._type=S.Vector4,this._type}}return this._type}constructor(e,t=N.Vertex,i=S.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=Fn.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new Q,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===S.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===3}get isUniform(){return this._mode===0}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return this._mode===1}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return this._mode===2}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case Fn.Time:{this.type===S.Float&&(this.value+=e.getAnimationRatio()*.01);break}case Fn.RealTime:{this.type===S.Float&&(this.value=(Tr.Now-e.getEngine().startTime)/1e3);break}case Fn.MouseInfo:{if(this.type===S.Vector4){const t=e._inputManager._originMouseEvent;if(t){const i=t.offsetX,r=t.offsetY,s=t.buttons&1?1:0,a=t.buttons&2?1:0;this.value=new We(i,r,s,a)}else this.value=new We(0,0,0,0)}break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}
`:`#ifdef ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case S.Float:this.value=0;break;case S.Vector2:this.value=se.Zero();break;case S.Vector3:this.value=m.Zero();break;case S.Vector4:this.value=We.Zero();break;case S.Color3:this.value=fe.White();break;case S.Color4:this.value=new Be(1,1,1,1);break;case S.Matrix:this.value=O.Identity();break}}_emitConstant(e){switch(this.type){case S.Float:return`${e._emitFloat(this.value)}`;case S.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case S.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case S.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case S.Color3:return Ot.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Ot.Color3[0].toGammaSpaceToRef(Ot.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Ot.Color3[0].toLinearSpaceToRef(Ot.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${Ot.Color3[0].r}, ${Ot.Color3[0].g}, ${Ot.Color3[0].b})`;case S.Color4:return Ot.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Ot.Color4[0].toGammaSpaceToRef(Ot.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Ot.Color4[0].toLinearSpaceToRef(Ot.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${Ot.Color4[0].r}, ${Ot.Color4[0].g}, ${Ot.Color4[0].b}, ${Ot.Color4[0].a})`}return""}get _noContextSwitch(){return wf[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));const i=e._getShaderType(this.type);e.shaderLanguage===1?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};
`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};
`,t&&(e._uniformDeclaration+=`#endif
`);const r=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case Et.WorldView:r.needWorldViewMatrix=!0;break;case Et.WorldViewProjection:r.needWorldViewProjectionMatrix=!0;break}else this._animationType!==Fn.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=WW[this.name]??this.name,this.target===N.Vertex&&e._vertexState){wf[this.name]?pv[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),e.shaderLanguage===1&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type,t):this._emit(e._vertexState,t);return}const i=e.attributes.indexOf(this.declarationVariableName)!==-1;i||e.attributes.push(this.declarationVariableName),wf[this.name]?pv[this.name]?(i||e._emitUniformFromString(this.declarationVariableName,this.type,t),e.shaderLanguage===1&&(this._prefix="uniforms.")):(i||e._emitVaryingFromString(this.declarationVariableName,this.type,t),e.shaderLanguage===1&&(this._prefix="fragmentInputs.")):(t&&!i&&(e._attributeDeclaration+=this._emitDefine(t)),e.shaderLanguage===1?(i||(e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`),this._prefix="vertexInputs."):i||(e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`),t&&!i&&(e._attributeDeclaration+=`#endif
`))}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;const s=this._associatedVariableName;switch(this._systemValue){case Et.World:e.setMatrix(s,t);break;case Et.WorldView:e.setMatrix(s,i);break;case Et.WorldViewProjection:e.setMatrix(s,r);break}}_transmit(e,t,i){if(this.isAttribute)return;const r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case Et.World:case Et.WorldView:case Et.WorldViewProjection:return;case Et.View:e.setMatrix(r,t.getViewMatrix());break;case Et.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case Et.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case Et.CameraPosition:t.bindEyePosition(e,r,!0);break;case Et.FogColor:e.setColor3(r,t.fogColor);break;case Et.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case Et.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Et.MaterialAlpha:e.setFloat(r,i.alpha);break}return}const s=this._valueCallback?this._valueCallback():this._storedValue;if(s!==null)switch(this.type){case S.Float:e.setFloat(r,s);break;case S.Int:e.setInt(r,s);break;case S.Color3:Ot.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Ot.Color3[0].toGammaSpaceToRef(Ot.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Ot.Color3[0].toLinearSpaceToRef(Ot.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,Ot.Color3[0]);break;case S.Color4:Ot.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Ot.Color4[0].toGammaSpaceToRef(Ot.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Ot.Color4[0].toLinearSpaceToRef(Ot.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,Ot.Color4[0]);break;case S.Vector2:e.setVector2(r,s);break;case S.Vector3:e.setVector3(r,s);break;case S.Vector4:e.setVector4(r,s);break;case S.Matrix:e.setMatrix(r,s);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Et[this._systemValue]});
`;if(this.isUniform){const t=[];let i="";switch(this.type){case S.Float:i=`${this.value}`;break;case S.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case S.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case S.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case S.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case S.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case S.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return t.push(`${e}.value = ${i}`),this.type===S.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${Fn[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===0&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===1&&e.type===S.Vector3&&(this._type=S.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const r=Ai(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}}$("BABYLON.InputBlock",_t);class HW extends ze{constructor(e){super(e,N.Vertex),this._isUnique=!0,this.registerInput("splatPosition",S.Vector3,!1,N.Vertex),this.registerInput("splatScale",S.Vector2,!0,N.Vertex),this.registerInput("world",S.Matrix,!1,N.Vertex),this.registerInput("view",S.Matrix,!1,N.Vertex),this.registerInput("projection",S.Matrix,!1,N.Vertex),this.registerOutput("splatVertex",S.Vector4,N.Vertex)}getClassName(){return"GaussianSplattingBlock"}get splatPosition(){return this._inputs[0]}get splatScale(){return this._inputs[1]}get world(){return this._inputs[2]}get view(){return this._inputs[3]}get projection(){return this._inputs[4]}get splatVertex(){return this._outputs[0]}initialize(e){e._excludeVariableName("focal"),e._excludeVariableName("invViewport")}_buildBlock(e){if(super._buildBlock(e),e.target===N.Fragment)return;const t=`//${this.name}`;e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitUniformFromString("focal",S.Vector2),e._emitUniformFromString("invViewport",S.Vector2),e.attributes.push(b.PositionKind),e.sharedData.nodeMaterial.backFaceCulling=!1;const i=this.splatPosition,r=this.splatScale,s=this.world,a=this.view,o=this.projection,l=this.splatVertex;let u=`vec2${e.fSuffix}(1.,1.)`;r.isConnected&&(u=r.associatedVariableName);let h="position",f="";return e.shaderLanguage===1&&(h="input.position",f=", uniforms.focal, uniforms.invViewport"),e.compilationString+=`${e._declareOutput(l)} = gaussianSplatting(${h}, ${i.associatedVariableName}, ${u}, covA, covB, ${s.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName}${f});
`,this}}$("BABYLON.GaussianSplattingBlock",HW);class XW extends ze{constructor(e){super(e,N.Fragment),this._isUnique=!1,this.registerInput("splatColor",S.Color4,!1,N.Fragment),this.registerOutput("rgba",S.Color4,N.Fragment)}getClassName(){return"GaussianBlock"}get splatColor(){return this._inputs[0]}get rgba(){return this._outputs[0]}initialize(e){e._excludeVariableName("vPosition")}_buildBlock(e){if(super._buildBlock(e),e.target===N.Vertex)return;const t=`//${this.name}`;e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e._emitFunctionFromInclude("logDepthDeclaration",t),e._emitFunctionFromInclude("fogFragmentDeclaration",t),e._emitFunctionFromInclude("gaussianSplattingFragmentDeclaration",t),e._emitVaryingFromString("vPosition",S.Vector2);const i=this.splatColor,r=this._outputs[0];return e.shaderLanguage===1?e.compilationString+=`${e._declareOutput(r)} = gaussianColor(${i.associatedVariableName}, input.vPosition);
`:e.compilationString+=`${e._declareOutput(r)} = gaussianColor(${i.associatedVariableName});
`,this}}$("BABYLON.GaussianBlock",XW);class YW extends ze{constructor(e){super(e,N.Vertex),this._isUnique=!0,this.registerInput("splatIndex",S.Float,!1,N.Vertex),this.registerOutput("splatPosition",S.Vector3,N.Vertex),this.registerOutput("splatColor",S.Color4,N.Vertex)}getClassName(){return"SplatReaderBlock"}get splatIndex(){return this._inputs[0]}get splatPosition(){return this._outputs[0]}get splatColor(){return this._outputs[1]}initialize(e){e._excludeVariableName("covA"),e._excludeVariableName("covB"),e._excludeVariableName("vPosition"),e._excludeVariableName("covariancesATexture"),e._excludeVariableName("covariancesBTexture"),e._excludeVariableName("centersTexture"),e._excludeVariableName("colorsTexture"),e._excludeVariableName("dataTextureSize")}bind(e,t,i){if(!i)return;const r=i.getScene();qa.BindEffect(i,e,r)}_buildBlock(e){if(super._buildBlock(e),e.target===N.Fragment)return;e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emit2DSampler("covariancesATexture"),e._emit2DSampler("covariancesBTexture"),e._emit2DSampler("centersTexture"),e._emit2DSampler("colorsTexture"),e._emitFunctionFromInclude("gaussianSplattingVertexDeclaration",t),e._emitFunctionFromInclude("gaussianSplatting",t),e._emitVaryingFromString("vPosition",S.Vector2),e._emitUniformFromString("dataTextureSize",S.Vector2);const i=this.splatIndex,r=this.splatPosition,s=this.splatColor,a=e._getFreeVariableName("splat");return e.shaderLanguage===1?(e.compilationString+=`var ${a}: Splat = readSplat(${i.associatedVariableName}, uniforms.dataTextureSize);
`,e.compilationString+=`var covA: vec3f = splat.covA.xyz; var covB: vec3f = vec3f(splat.covA.w, splat.covB.xy);
`,e.compilationString+=`vertexOutputs.vPosition = input.position;
`):(e.compilationString+=`Splat ${a} = readSplat(${i.associatedVariableName});
`,e.compilationString+=`vec3 covA = splat.covA.xyz; vec3 covB = vec3(splat.covA.w, splat.covB.xy);
`,e.compilationString+=`vPosition = position;
`),e.compilationString+=`${e._declareOutput(r)} = ${a}.center.xyz;
`,e.compilationString+=`${e._declareOutput(s)} = ${a}.color;
`,this}}$("BABYLON.SplatReaderBlock",YW);class _v{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return this.shaderLanguage===1?"f":""}finalize(e){const t=e.sharedData.emitComments,i=this.target===N.Fragment;this.shaderLanguage===1?i?this.compilationString=`
${t?`//Entry point
`:""}@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.compilationString}`:this.compilationString=`
${t?`//Entry point
`:""}@vertex
fn main(input: VertexInputs) -> FragmentInputs{
${this.compilationString}`:this.compilationString=`
${t?`//Entry point
`:""}void main(void) {
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`
${t?`//Constants
`:""}${this._constantDeclaration}
${this.compilationString}`);let r="";for(const s in this.functions)r+=this.functions[s]+`
`;if(this.compilationString=`
${r}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?`//Varyings
`:""}${this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?`//Samplers
`:""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?`//Uniforms
`:""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?`//Attributes
`:""}${this._attributeDeclaration}
${this.compilationString}`),this.shaderLanguage!==1){this.compilationString=`precision highp float;
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defined(WEBGPU)
precision highp sampler2DArray;
#endif
`+this.compilationString,i&&(this.compilationString=`#if defined(PREPASS)\r
#extension GL_EXT_draw_buffers : require\r
layout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r
highp vec4 gl_FragColor;\r
#endif\r
`+this.compilationString);for(const s in this.extensions){const a=this.extensions[s];this.compilationString=`
${a}
${this.compilationString}`}}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;
`):this._samplerDeclaration+=`uniform sampler2D ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case S.Float:return"float";case S.Int:return"int";case S.Vector2:return"vec2";case S.Color3:case S.Vector3:return"vec3";case S.Color4:case S.Vector4:return"vec4";case S.Matrix:return"mat4"}return""}_getShaderType(e){const t=this.shaderLanguage===1;switch(e){case S.Float:return t?"f32":"float";case S.Int:return t?"i32":"int";case S.Vector2:return t?"vec2f":"vec2";case S.Color3:case S.Vector3:return t?"vec3f":"vec3";case S.Color4:case S.Vector4:return t?"vec4f":"vec4";case S.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){const r=V.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let s=r[e]+`
`;if(this.sharedData.emitComments&&(s=t+`
`+s),!i)return s;if(i.replaceStrings)for(let a=0;a<i.replaceStrings.length;a++){const o=i.replaceStrings[a];s=s.replace(o.search,o.replace)}return s}_emitFunctionFromInclude(e,t,i,r=""){const s=e+r;if(this.functions[s])return;const a=V.GetIncludesShadersStore(this.shaderLanguage);if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[s]=`#include<${e}>${i!=null&&i.substitutionVars?"("+(i==null?void 0:i.substitutionVars)+")":""}
`,this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]);return}if(this.functions[s]=a[e],this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/\s*?attribute .+?;/g,`
`)),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/\s*?uniform .*?;/g,`
`)),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/\s*?(varying|in) .+?;/g,`
`)),i.replaceStrings)for(let o=0;o<i.replaceStrings.length;o++){const l=i.replaceStrings[o];this.functions[s]=this.functions[s].replace(l.search,l.replace)}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){if(this.sharedData.varyings.indexOf(e)!==-1)return!1;this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}
`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);const s=this._getShaderType(t);return this.shaderLanguage===1?this.sharedData.varyingDeclaration+=`varying ${e}: ${s};
`:this.sharedData.varyingDeclaration+=`varying ${s} ${e};
`,i&&(this.sharedData.varyingDeclaration+=`#endif
`),!0}_getVaryingName(e){return this.shaderLanguage===1?(this.target!==N.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(this.uniforms.indexOf(e)!==-1)return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);const s=this._getShaderType(t);this.shaderLanguage===1?this._uniformDeclaration+=`uniform ${e}: ${s};
`:this._uniformDeclaration+=`uniform ${s} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return this.shaderLanguage===1?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return this.shaderLanguage===1?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return this.shaderLanguage===1?"textureSample":"textureCube"}_samplerFunc(){return this.shaderLanguage===1?"textureSample":"texture2D"}_samplerLODFunc(){return this.shaderLanguage===1?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return this.shaderLanguage===1?e.type===S.Color3||e.type===S.Vector3?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return this.shaderLanguage===1?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(t,i,r,s)=>`select(${s}, ${r}, ${i})`)}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(t,i,r)=>`((${i})%(${r}))`)}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){const t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;let i;for(;(i=t.exec(e))!==null;){const r=i[1],s=i[2],o=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${r}(${o}) -> ${s}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=this._convertOutParametersToWGSL(e),e=e.replace(/\[\*\]/g,"*"),e=this._convertFunctionsToWGSL(e),e=e.replace(/\s->\svoidnull/g,""),e=e.replace(/dFdx/g,"dpdx"),e=e.replace(/dFdy/g,"dpdy"),e}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(t,i,r,s)=>`${i} ? ${r} : ${s}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e),e}}class $W{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(e=null){let t="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(t+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.
`),this.checks.emitFragment||(t+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.
`);for(const i of this.checks.notConnectedNonOptionalInputs)t+=`input ${i.name} from block ${i.ownerBlock.name}[${i.ownerBlock.getClassName()}] is not connected and is not optional.
`;return t?(e&&e.notifyObservers(t),w.Error(`Build of NodeMaterial failed:
`+t),!1):!0}}class tb extends ze{constructor(e){super(e,N.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",S.AutoDetect,!1,N.VertexAndFragment),this.registerOutput("rgba",S.Color4,N.Neutral),this.registerOutput("rgb",S.Color3,N.Neutral),this.registerOutput("r",S.Float,N.Neutral),this.registerOutput("g",S.Float,N.Neutral),this.registerOutput("b",S.Float,N.Neutral),this.registerOutput("a",S.Float,N.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector2|S.Vector3|S.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?N.VertexAndFragment:N.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,S.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,S.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===N.Fragment)return;const s=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,a=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${s} ${i.associatedVariableName}${a});
`;return}const r=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===N.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${r} ${i.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===N.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===N.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==N.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}}$("BABYLON.CurrentScreenBlock",tb);class ib extends ze{constructor(e){super(e,N.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",S.AutoDetect,!1,N.VertexAndFragment),this.registerOutput("rgba",S.Color4,N.Neutral),this.registerOutput("rgb",S.Color3,N.Neutral),this.registerOutput("r",S.Float,N.Neutral),this.registerOutput("g",S.Float,N.Neutral),this.registerOutput("b",S.Float,N.Neutral),this.registerOutput("a",S.Float,N.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector2|S.Vector3|S.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="particle_uv"&&t(r));i||(i=new _t("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===N.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}}$("BABYLON.ParticleTextureBlock",ib);class rb extends ze{constructor(e){super(e,N.Fragment),this._isUnique=!0,this.registerInput("color",S.Color4,!1,N.Fragment),this.registerOutput("rampColor",S.Color4,N.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target!==N.Vertex)return e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",S.Vector4,"RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",S.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",S.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",S.Float)} = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",S.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}$("BABYLON.ParticleRampGradientBlock",rb);class sb extends ze{constructor(e){super(e,N.Fragment),this._isUnique=!0,this.registerInput("color",S.Color4,!1,N.Fragment),this.registerInput("alphaTexture",S.Float,!1,N.Fragment),this.registerInput("alphaColor",S.Float,!1,N.Fragment),this.registerOutput("blendColor",S.Color4,N.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==N.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",S.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}$("BABYLON.ParticleBlendMultiplyBlock",sb);class gu extends ze{constructor(e){super(e,N.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",S.Vector4,!0),this.registerInput("xyz ",S.Vector3,!0),this.registerInput("xy ",S.Vector2,!0),this.registerInput("zw ",S.Vector2,!0),this.registerInput("x",S.Float,!0),this.registerInput("y",S.Float,!0),this.registerInput("z",S.Float,!0),this.registerInput("w",S.Float,!0),this.registerOutput("xyzw",S.Vector4),this.registerOutput("xyz",S.Vector3),this.registerOutput("xy",S.Vector2),this.registerOutput("zw",S.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,r=this.z,s=this.w,a=this.xyIn,o=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this._outputs[0],h=this._outputs[1],f=this._outputs[2],d=this._outputs[3],p=e._getShaderType(S.Vector4),_=e._getShaderType(S.Vector3),g=e._getShaderType(S.Vector2);return c.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};
`)):l.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${p}(${l.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):a.isConnected?(u.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(u)+` = ${p}(${a.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${p}(${a.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${_}(${a.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`),d.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(d)+` = ${g}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)):(u.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),f.hasEndpoints&&(e.compilationString+=e._declareOutput(f)+` = ${g}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};
`),d.hasEndpoints&&(o.isConnected?e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(d)+` = ${g}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`,e}}$("BABYLON.VectorMergerBlock",gu);class kh extends ze{constructor(e){super(e,N.Neutral),this.sourceRange=new se(-1,1),this.targetRange=new se(0,1),this.registerInput("input",S.AutoDetect),this.registerInput("sourceMin",S.Float,!0),this.registerInput("sourceMax",S.Float,!0),this.registerInput("targetMin",S.Float,!0),this.registerInput("targetMax",S.Float,!0),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),a=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${a} - ${s}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=se.FromArray(e.sourceRange),this.targetRange=se.FromArray(e.targetRange)}}I([Ne("From",3)],kh.prototype,"sourceRange",void 0);I([Ne("To",3)],kh.prototype,"targetRange",void 0);$("BABYLON.RemapBlock",kh);class Gh extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(S.Float),this.right.acceptedConnectionPointTypes.push(S.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===S.Int||this.left.type===S.Float&&this.right.type!==S.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[S.Int,S.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===S.Int||t.type===S.Float)&&e.acceptedConnectionPointTypes.push(S.Vector2,S.Vector3,S.Vector4,S.Color3,S.Color4,S.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}}class Rd extends Gh{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}}$("BABYLON.MultiplyBlock",Rd);class KW extends Gr{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class qi{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:m.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:m.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:m.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:m.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let r=0;for(const s of t){if(s.gradient===e){t.splice(r,1);break}r++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=m.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new m(10,10,10),this.onAnimationEnd=null,this.blendMode=qi.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new se(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new m(0,0,0),this._useLogarithmicDepth=!1,this.gravity=m.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new Be(1,1,1,1),this.color2=new Be(1,1,1,1),this.colorDead=new Be(0,0,0,1),this.textureMask=new Be(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new KW,this.id=e,this.name=e}createPointEmitter(e,t){throw new Error("Method not implemented.")}createHemisphericEmitter(e=1,t=1){throw new Error("Method not implemented.")}createSphereEmitter(e=1,t=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(e=1,t=new m(0,1,0),i=new m(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(e=1,t=1,i=1,r=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(e=1,t=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new m(0,1,0),r=new m(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(e,t,i,r){throw new Error("Method not implemented.")}}qi.BLENDMODE_ONEONE=0;qi.BLENDMODE_STANDARD=1;qi.BLENDMODE_ADD=2;qi.BLENDMODE_MULTIPLY=3;qi.BLENDMODE_MULTIPLYADD=4;$("BABYLON.BaseParticleSystem",qi);class nb extends ze{constructor(e){super(e,N.Neutral),this.registerInput("rgba",S.Color4,!0),this.registerInput("rgb ",S.Color3,!0),this.registerOutput("rgb",S.Color3),this.registerOutput("r",S.Float),this.registerOutput("g",S.Float),this.registerOutput("b",S.Float),this.registerOutput("a",S.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],a=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.g;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.b;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.a;
`),this}}$("BABYLON.ColorSplitterBlock",nb);var Nt;(function(n){n[n.Cos=0]="Cos",n[n.Sin=1]="Sin",n[n.Abs=2]="Abs",n[n.Exp=3]="Exp",n[n.Exp2=4]="Exp2",n[n.Round=5]="Round",n[n.Floor=6]="Floor",n[n.Ceiling=7]="Ceiling",n[n.Sqrt=8]="Sqrt",n[n.Log=9]="Log",n[n.Tan=10]="Tan",n[n.ArcTan=11]="ArcTan",n[n.ArcCos=12]="ArcCos",n[n.ArcSin=13]="ArcSin",n[n.Fract=14]="Fract",n[n.Sign=15]="Sign",n[n.Radians=16]="Radians",n[n.Degrees=17]="Degrees",n[n.Set=18]="Set"})(Nt||(Nt={}));class x_ extends ze{constructor(e){super(e,N.Neutral),this.operation=Nt.Cos,this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case Nt.Cos:{i="cos";break}case Nt.Sin:{i="sin";break}case Nt.Abs:{i="abs";break}case Nt.Exp:{i="exp";break}case Nt.Exp2:{i="exp2";break}case Nt.Round:{i="round";break}case Nt.Floor:{i="floor";break}case Nt.Ceiling:{i="ceil";break}case Nt.Sqrt:{i="sqrt";break}case Nt.Log:{i="log";break}case Nt.Tan:{i="tan";break}case Nt.ArcTan:{i="atan";break}case Nt.ArcCos:{i="acos";break}case Nt.ArcSin:{i="asin";break}case Nt.Fract:{i="fract";break}case Nt.Sign:{i="sign";break}case Nt.Radians:{i="radians";break}case Nt.Degrees:{i="degrees";break}case Nt.Set:{i="";break}}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${Nt[this.operation]};
`}}I([Ne("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:Nt.Cos},{label:"Sin",value:Nt.Sin},{label:"Abs",value:Nt.Abs},{label:"Exp",value:Nt.Exp},{label:"Exp2",value:Nt.Exp2},{label:"Round",value:Nt.Round},{label:"Floor",value:Nt.Floor},{label:"Ceiling",value:Nt.Ceiling},{label:"Sqrt",value:Nt.Sqrt},{label:"Log",value:Nt.Log},{label:"Tan",value:Nt.Tan},{label:"ArcTan",value:Nt.ArcTan},{label:"ArcCos",value:Nt.ArcCos},{label:"ArcSin",value:Nt.ArcSin},{label:"Fract",value:Nt.Fract},{label:"Sign",value:Nt.Sign},{label:"Radians",value:Nt.Radians},{label:"Degrees",value:Nt.Degrees},{label:"Set",value:Nt.Set}]})],x_.prototype,"operation",void 0);$("BABYLON.TrigonometryBlock",x_);const Bf={effect:null,subMesh:null};class iu extends Gr{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class Ci extends hl{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="ReflectionTextureBlock"||e.getClassName()==="ReflectionBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"||e.getClassName()==="PrePassTextureBlock"}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get shaderLanguage(){return this._options.shaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||$e.LastCreatedScene),this._buildId=Ci._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new O,this._cachedWorldViewProjectionMatrix=new O,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new Q,this.onBuildErrorObservable=new Q,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=Mr.Material,this.forceAlphaBlending=!1,i&&i.shaderLanguage===1&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:Ci.DefaultShaderLanguage,...i},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return J.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&N.Vertex&&this._addVertexOutputNode(e),e.target&N.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:(e.target&N.Vertex&&this._removeVertexOutputNode(e),e.target&N.Fragment&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=N.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=N.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===N.VertexAndFragment||t.target===N.Fragment&&e.target===N.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const t=e.getClassName();for(const i of this.attachedBlocks)if(i.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(const s of e.inputs){s.associatedVariableName="";const a=s.connectedPoint;if(a&&!a._preventBubbleUp){const o=a.ownerBlock;o!==e&&this._processInitializeOnLink(o,t,i,r)}}if(e.isLoop){const s=e;if(s.loopID.hasEndpoints)for(const a of s.loopID.endpoints){const o=a.ownerBlock;o.outputs.length===0&&(t._terminalBlocks.add(o),this._processInitializeOnLink(o,t,i,r))}}else if(e.isTeleportOut){const s=e;s.entryPoint&&this._processInitializeOnLink(s.entryPoint,t,i,r)}for(const s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===N.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const r=i.connectedPoint;if(r&&!r._preventBubbleUp){const s=r.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){const i=e;if(i.loopID.hasEndpoints)for(const r of i.loopID.endpoints){const s=r.ownerBlock;s.outputs.length===0&&this._resetDualBlocks(s,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress){w.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");return}this._buildIsInProgress=!0,!this._vertexCompilationState&&!i&&(i=!0),this._buildWasSuccessful=!1;const r=this.getScene().getEngine(),s=this._mode===Mr.Particle;if(this._vertexOutputNodes.length===0&&!s)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new _v,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=N.Vertex,this._fragmentCompilationState=new _v,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=N.Fragment,this._sharedData=new $W,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;const a=[],o=[];for(const c of this._vertexOutputNodes)a.push(c),this._initializeBlock(c,this._vertexCompilationState,o,i);for(const c of this._fragmentOutputNodes)o.push(c),this._initializeBlock(c,this._fragmentCompilationState,a,i);let l=0;for(const c of this.attachedBlocks)c.codeIsReady||(l++,c.onCodeIsReadyObservable.addOnce(()=>{l--,l===0&&this._finishBuildProcess(e,t,a,o)}));l===0&&this._finishBuildProcess(e,t,a,o)}_finishBuildProcess(e=!1,t=!0,i,r){this.optimize();for(const l of i)l.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const l of r)this._resetDualBlocks(l,this._buildId-1);for(const l of r)l.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=Ci._BuildIdGenerator++);const s=this._sharedData.emitErrors(this.onBuildErrorObservable);e&&(w.Log("Vertex shader:"),w.Log(this._vertexCompilationState.compilationString),w.Log("Fragment shader:"),w.Log(this._fragmentCompilationState.compilationString)),this._buildIsInProgress=!1,this._buildWasSuccessful=!0,s&&this.onBuildObservable.notifyObservers(this);const a=this.getScene().meshes;for(const l of a)if(l.subMeshes)for(const c of l.subMeshes){if(c.getMaterial()!==this||!c.materialDefines)continue;const u=c.materialDefines;u.markAllAsDirty(),u.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const o=this.getScene().prePassRenderer;o&&o.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(b.NormalKind),t.TANGENT=e.isVerticesDataPresent(b.TangentKind);const a=e.useVertexColors&&e.isVerticesDataPresent(b.ColorKind);t.VERTEXCOLOR_NME=a;let o=!1;for(let c=1;c<=6;++c){const u=t["UV"+c];t["UV"+c]=e.isVerticesDataPresent(`uv${c===1?"":c}`),o=o||t["UV"+c]!==u}const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;Op(this.getScene(),t,!l),(i!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate(i=>i.getClassName()==="PrePassOutputBlock"),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1)),t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter(i=>i.getClassName()==="PrePassTextureBlock"),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const r of t)i.texturesRequired.includes(r)||i.texturesRequired.push(r);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,s,a=0,o=5){return this.mode!==Mr.PostProcess?(w.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,a,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,a,o=0,l=5){let c=this.name+this._buildId;const u=new iu,h=new k(c+"PostProcess",this.getScene());let f=this._buildId;return this._processDefines(h,u),ei.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new Jt(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,a,u.toString(),o,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add(d=>{f!==this._buildId&&(delete ei.ShadersStore[c+"VertexShader"],delete ei.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,u.markAllAsDirty(),f=this._buildId),this._processDefines(h,u)&&(ei.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),qo.SetImmediate(()=>e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(d)}),e}createProceduralTexture(e,t){if(this.mode!==Mr.ProceduralTexture)return w.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const r=new An(i,e,null,t),s=new k(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};const a=new iu,o=this._processDefines(s,a);ei.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[b.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString(),o==null?void 0:o.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(l);let c=this._buildId;const u=()=>{c!==this._buildId&&(delete ei.ShadersStore[i+"VertexShader"],delete ei.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,a.markAllAsDirty(),c=this._buildId);const h=this._processDefines(s,a);h&&(ei.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),qo.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[b.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString(),h==null?void 0:h.fallbacks,void 0),r._setEffect(l)})),this._checkInternals(l)};return r.onBeforeGenerationObservable.add(()=>{u()}),this.onBuildObservable.add(()=>{u()}),r}_createEffectForParticles(e,t,i,r,s,a,o,l=""){let c=this.name+this._buildId+"_"+t;a||(a=new iu),o||(o=this.getScene().getMeshByName(this.name+"Particle"),o||(o=new k(this.name+"Particle",this.getScene()),o.reservedDataStore={hidden:!0}));let u=this._buildId;const h=[];let f=l;if(!s){const d=this._processDefines(o,a);ei.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(h,t,!1),f=h.join(`
`),s=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString()+`
`+f,d==null?void 0:d.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(s,t)}s.onBindObservable.add(d=>{u!==this._buildId&&(delete ei.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,a.markAllAsDirty(),u=this._buildId),h.length=0,e.fillDefines(h,t,!1);const p=h.join(`
`);p!==f&&(a.markAllAsDirty(),f=p);const _=this._processDefines(o,a);if(_){ei.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),d=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,a.toString()+`
`+f,_==null?void 0:_.fallbacks,i,r,e),e.setCustomEffect(d,t),this._createEffectForParticles(e,t,i,r,d,a,o,l);return}this._checkInternals(d)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==Mr.Particle){w.Log("Incompatible material mode");return}this._createEffectForParticles(e,qi.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,qi.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==Mr.Material){w.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let s=null;const a=this.getScene();if($T(a,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(o=>{o.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(o=>{o.prepareDefines(e,this,t,i,r)}),t.isDirty){const o=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(f=>{f.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const l=[];this._sharedData.dynamicUniformBlocks.forEach(f=>{f.updateUniformsAndSamples(this._vertexCompilationState,this,t,l)});const c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(f=>{c.indexOf(f)===-1&&c.push(f)});const u=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(f=>{u.indexOf(f)===-1&&u.push(f)});const h=new co;this._sharedData.blocksWithFallbacks.forEach(f=>{f.provideFallbacks(e,h)}),s={lightDisposed:o,uniformBuffers:l,mergedUniforms:c,mergedSamplers:u,fallbacks:h}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const r=this.getScene();if(this._sharedData.animatedInputs){const c=r.getFrameId();if(this._animationFrame!==c){for(const u of this._sharedData.animatedInputs)u.animate(r);this._animationFrame=c}}const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new iu);const a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=r.getEngine();if(this._prepareDefinesForAttributes(e,a),this._sharedData.blockingBlocks.some(c=>!c.isReady(e,this,a,i)))return!1;const l=this._processDefines(e,a,i,t);if(l){const c=t.effect,u=a.toString();let h=o.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:l.mergedUniforms,uniformBuffersNames:l.uniformBuffers,samplers:l.mergedSamplers,defines:u,fallbacks:l.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:a.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},o);if(h)if(this._onEffectCreatedObservable&&(Bf.effect=h,Bf.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Bf)),this.allowShaderHotSwapping&&c&&!h.isReady()){if(h=c,a.markAsUnprocessed(),l.lightDisposed)return a._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,a,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(a._renderId=r.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);const a=this._mustRebind(r,s,i,t.visibility),o=this._sharedData;if(a){for(const l of o.bindableBlocks)l.bind(s,this,t,i);for(const l of o.forcedBindableBlocks)l.bind(s,this,t,i);for(const l of o.inputBlocks)l._transmit(s,r,this)}else if(!this.isFrozen)for(const l of o.forcedBindableBlocks)l.bind(s,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)Ci._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const r of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))r.dispose();for(const r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:Ci.EditorURL;J.LoadBabylonScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}else this._createNodeEditor(e==null?void 0:e.nodeEditorConfig),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;const e=new _t("Position");e.setAsAttribute("position");const t=new _t("World");t.setAsSystemValue(Et.World);const i=new zu("WorldPos");e.connectTo(i),t.connectTo(i);const r=new _t("ViewProjection");r.setAsSystemValue(Et.ViewProjection);const s=new zu("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);const a=new mu("VertexOutput");s.connectTo(a);const o=new _t("color");o.value=new Be(.8,.8,.8,1);const l=new Xa("FragmentOutput");o.connectTo(l),this.addOutputNode(a),this.addOutputNode(l),this._mode=Mr.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new _t("Position");e.setAsAttribute("position2d");const t=new _t("Constant1");t.isConstant=!0,t.value=1;const i=new gu("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new mu("VertexOutput");i.connectTo(r);const s=new _t("Scale");s.visibleInInspector=!0,s.value=new se(1,1);const a=new kh("uv0");e.connectTo(a);const o=new Rd("UV scale");a.connectTo(o),s.connectTo(o);const l=new tb("CurrentScreen");o.connectTo(l),l.texture=new Z("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const c=new Xa("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(c),this._mode=Mr.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new _t("Position");e.setAsAttribute("position2d");const t=new _t("Constant1");t.isConstant=!0,t.value=1;const i=new gu("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const r=new mu("VertexOutput");i.connectTo(r);const s=new _t("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=Fn.Time,s.isConstant=!1;const a=new _t("Color3");a.value=new fe(1,1,1),a.isConstant=!1;const o=new Xa("FragmentOutput"),l=new gu("VectorMerger");l.visibleInInspector=!1;const c=new x_("Cos");c.operation=Nt.Cos,e.connectTo(l),s.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(o.rgb),this.addOutputNode(r),this.addOutputNode(o),this._mode=Mr.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new _t("uv");e.setAsAttribute("particle_uv");const t=new ib("ParticleTexture");e.connectTo(t);const i=new _t("Color");i.setAsAttribute("particle_color");const r=new Rd("Texture * Color");t.connectTo(r),i.connectTo(r);const s=new rb("ParticleRampGradient");r.connectTo(s);const a=new nb("ColorSplitter");i.connectTo(a);const o=new sb("ParticleBlendMultiply");s.connectTo(o),t.connectTo(o,{output:"a"}),a.connectTo(o,{output:"a"});const l=new Xa("FragmentOutput");o.connectTo(l),this.addOutputNode(l),this._mode=Mr.Particle}async loadAsync(e,t=""){return Ci.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const r=i.connectedPoint;if(r){const s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const a of this._vertexOutputNodes)this._gatherBlocks(a,t);const r=[];for(const a of this._fragmentOutputNodes)this._gatherBlocks(a,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;s+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${Mr[this.mode]};
`;for(const a of t)a.isInput&&e.indexOf(a)===-1&&(s+=a._dumpCode(i,e));for(const a of r)a.isInput&&e.indexOf(a)===-1&&(s+=a._dumpCode(i,e));e=[],s+=`
// Connections
`;for(const a of this._vertexOutputNodes)s+=a._dumpCodeForOutputConnections(e);for(const a of this._fragmentOutputNodes)s+=a._dumpCodeForOutputConnections(e);s+=`
// Output nodes
`;for(const a of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${a._codeVariableName});
`;for(const a of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${a._codeVariableName});
`;return s+=`nodeMaterial.build();
`,s}serialize(e){const t=e?{}:Ke.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(const r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(const r of i)t.blocks.push(r.serialize());if(!e)for(const r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(const r of e.outputs)for(const s of t.blocks){const a=i[s.id];if(a){for(const o of s.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===r.name){const l=a.getInputByName(o.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(a,t,i);continue}}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();const s={};for(const a of e.blocks){const o=Ai(a.customType);if(o){const l=new o;l._deserialize(a,this.getScene(),t,r),s[a.id]=l,this.attachedBlocks.push(l)}}for(const a of this.attachedBlocks)if(a.isTeleportOut){const o=a,l=o._tempEntryPointUniqueId;l&&s[l].attachToEndpoint(o)}for(let a=0;a<e.blocks.length;a++){const o=e.blocks[a],l=s[o.id];l&&(l.inputs.length&&!i||this._restoreConnections(l,e,s))}if(e.outputNodes)for(const a of e.outputNodes)this.addOutputNode(s[a]);if(e.locations||e.editorData&&e.editorData.locations){const a=e.locations||e.editorData.locations;for(const l of a)s[l.blockId]&&(l.blockId=s[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&a.concat(this.editorData.locations),e.locations?this.editorData={locations:a}:(this.editorData=e.editorData,this.editorData.locations=a);const o=[];for(const l in s)o[l]=s[l].uniqueId;this.editorData.map=o}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),e.alphaMode!==void 0&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??Mr.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),r=Ke.Clone(()=>new Ci(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach(t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise((r,s)=>{i.onLoadedObservable.addOnce(()=>{r()}),i.onErrorObservable.addOnce(a=>{s(a)})}))}),Promise.all(e)}static Parse(e,t,i="",r=0){const s=Ke.Parse(()=>new Ci(e.name,t,{shaderLanguage:r}),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,r="",s=!1,a,o){const l=a??new Ci(e,i),c=await i._loadFileAsync(t),u=JSON.parse(c);return l.parseSerializedObject(u,r,void 0,o),s||l.build(),l}static ParseFromSnippetAsync(e,t=$e.LastCreatedScene,i="",r,s=!1,a=!1,o){return e==="_BLANK"?Promise.resolve(Ci.CreateDefault("blank",t)):new Promise((l,c)=>{const u=new Gi;u.addEventListener("readystatechange",()=>{if(u.readyState==4)if(u.status==200){const h=JSON.parse(JSON.parse(u.responseText).jsonPayload),f=JSON.parse(h.nodeMaterial);r||(r=Ke.Parse(()=>new Ci(e,t),f,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(f,void 0,void 0,o),r.snippetId=e,r.sideOrientation=null;try{s||r.build()}catch(d){c(d)}a?r.whenTexturesReadyAsync().then(()=>{l(r)}).catch(d=>{c(d)}):l(r)}else c("Unable to load the snippet "+e)}),u.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),u.send()})}static CreateDefault(e,t){const i=new Ci(e,t);return i.setToDefault(),i.build(),i}}Ci._BuildIdGenerator=0;Ci.EditorURL=`${J._DefaultCdnUrl}/v${q.Version}/nodeEditor/babylon.nodeEditor.js`;Ci.SnippetUrl="https://snippet.babylonjs.com";Ci.IgnoreTexturesAtLoadTime=!1;Ci.DefaultShaderLanguage=0;I([M()],Ci.prototype,"ignoreAlpha",void 0);I([M()],Ci.prototype,"maxSimultaneousLights",void 0);I([M("mode")],Ci.prototype,"_mode",void 0);I([M("comment")],Ci.prototype,"comment",void 0);I([M()],Ci.prototype,"forceAlphaBlending",void 0);$("BABYLON.NodeMaterial",Ci);class jW extends ze{constructor(e){super(e,N.Vertex),this.registerInput("matricesIndices",S.Vector4),this.registerInput("matricesWeights",S.Vector4),this.registerInput("matricesIndicesExtra",S.Vector4,!0),this.registerInput("matricesWeightsExtra",S.Vector4,!0),this.registerInput("world",S.Matrix),this.registerOutput("output",S.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>nF),void 0),re(()=>Promise.resolve().then(()=>vF),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>oL),void 0),re(()=>Promise.resolve().then(()=>bL),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="matricesIndices"&&t(r));i||(i=new _t("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="matricesWeights"&&t(r));i||(i=new _t("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.World&&t(r));i||(i=new _t("world"),i.setAsSystemValue(Et.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){ul(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&HT(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const r=this._outputs[0],s=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0
`,e.compilationString+=e._declareOutput(r)+` = ${s.associatedVariableName} * ${i};
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(r)+` = ${s.associatedVariableName};
`,e.compilationString+=`#endif
`,this}}$("BABYLON.BonesBlock",jW);class qW extends ze{constructor(e){super(e,N.Vertex),this.registerInput("world0",S.Vector4),this.registerInput("world1",S.Vector4),this.registerInput("world2",S.Vector4),this.registerInput("world3",S.Vector4),this.registerInput("world",S.Matrix,!0),this.registerOutput("output",S.Matrix),this.registerOutput("instanceID",S.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world0"&&t(r));i||(i=new _t("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world1"&&t(r));i||(i=new _t("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world2"&&t(r));i||(i=new _t("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world3"&&t(r));i||(i=new _t("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world"&&t(r));i||(i=new _t("world"),i.setAsSystemValue(Et.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,s){let a=!1;i.INSTANCES!==r&&(i.setValue("INSTANCES",r),a=!0),s&&i.THIN_INSTANCES!==!!(s!=null&&s.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(s!=null&&s.getRenderingMesh().hasThinInstances)),a=!0),a&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],r=this._outputs[1],s=this.world0,a=this.world1,o=this.world2,l=this.world3;let c="mat4",u="gl_InstanceID",h="float";return e.shaderLanguage===1&&(c="mat4x4f",u="vertexInputs.instanceIndex",h="f32"),e.compilationString+=`#ifdef INSTANCES
`,e.compilationString+=e._declareOutput(i)+` = ${c}(${s.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName}, ${l.associatedVariableName});
`,e.compilationString+=`#ifdef THIN_INSTANCES
`,e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};
`,e.compilationString+=`#endif
`,t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(r)+` = ${h}(${u});
`:e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};
`,e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#endif
`,this}}$("BABYLON.InstancesBlock",qW);class ab extends ze{constructor(e){super(e,N.Vertex),this.registerInput("position",S.Vector3),this.registerInput("normal",S.Vector3),this.registerInput("tangent",S.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(S.Color4|S.Vector4|S.Vector3),this.registerInput("uv",S.Vector2),this.registerOutput("positionOutput",S.Vector3),this.registerOutput("normalOutput",S.Vector3),this.registerOutput("tangentOutput",S.Vector4),this.registerOutput("uvOutput",S.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>gF),void 0),re(()=>Promise.resolve().then(()=>cF),void 0),re(()=>Promise.resolve().then(()=>_F),void 0),re(()=>Promise.resolve().then(()=>oF),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>CL),void 0),re(()=>Promise.resolve().then(()=>dL),void 0),re(()=>Promise.resolve().then(()=>TL),void 0),re(()=>Promise.resolve().then(()=>hL),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="position"&&t(r));i||(i=new _t("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="normal"&&t(r));i||(i=new _t("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="tangent"&&t(r));i||(i=new _t("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv"&&t(r));i||(i=new _t("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const r=e.morphTargetManager;r!=null&&r.isUsingTextureForTargets&&(r.numMaxInfluencers||r.numInfluencers)!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&XT(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(cl(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,r){const s=this.position,a=this.normal,o=this.tangent,l=this.uv,c=this.positionOutput,u=this.normalOutput,h=this.tangentOutput,f=this.uvOutput,d=e,p=r.NUM_MORPH_INFLUENCERS,_=i.morphTargetManager,g=_&&_.supportsNormals&&r.NORMAL,E=_&&_.supportsTangents&&r.TANGENT,v=_&&_.supportsUVs&&r.UV1;let x="";_!=null&&_.isUsingTextureForTargets&&p>0&&(x+=`${d._declareLocalVar("vertexID",S.Float)};
`),x+=`#ifdef MORPHTARGETS
`;const A=d.shaderLanguage===1,T=A?"uniforms.":"";if(_!=null&&_.isUsingTextureForTargets)x+=`for (${A?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {
`,x+=`if (i >= ${T}morphTargetCount) { break; }
`,x+=`vertexID = ${A?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${T}morphTargetTextureInfo.x;
`,x+=`${c.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${s.associatedVariableName}) * ${T}morphTargetInfluences[i];
`,x+=`vertexID += 1.0;
`,g&&(x+=`#ifdef MORPHTARGETS_NORMAL
`,x+=`${u.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${a.associatedVariableName}) * ${T}morphTargetInfluences[i];
`,x+=`vertexID += 1.0;
`,x+=`#endif
`),v&&(x+=`#ifdef MORPHTARGETS_UV
`,x+=`${f.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${l.associatedVariableName}) * ${T}morphTargetInfluences[i];
`,x+=`vertexID += 1.0;
`,x+=`#endif
`),E&&(x+=`#ifdef MORPHTARGETS_TANGENT
`,x+=`${h.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${o.associatedVariableName}.xyz) * ${T}morphTargetInfluences[i];
`,o.type===S.Vector4?x+=`${h.associatedVariableName}.w = ${o.associatedVariableName}.w;
`:x+=`${h.associatedVariableName}.w = 1.;
`,x+=`#endif
`),x+=`}
`;else for(let C=0;C<p;C++)x+=`${c.associatedVariableName} += (position${C} - ${s.associatedVariableName}) * ${T}morphTargetInfluences[${C}];
`,g&&(x+=`#ifdef MORPHTARGETS_NORMAL
`,x+=`${u.associatedVariableName} += (normal${C} - ${a.associatedVariableName}) * ${T}morphTargetInfluences[${C}];
`,x+=`#endif
`),v&&(x+=`#ifdef MORPHTARGETS_UV
`,x+=`${f.associatedVariableName}.xy += (uv_${C} - ${l.associatedVariableName}.xy) * ${T}morphTargetInfluences[${C}];
`,x+=`#endif
`),E&&(x+=`#ifdef MORPHTARGETS_TANGENT
`,x+=`${h.associatedVariableName}.xyz += (tangent${C} - ${o.associatedVariableName}.xyz) * ${T}morphTargetInfluences[${C}];
`,o.type===S.Vector4?x+=`${h.associatedVariableName}.w = ${o.associatedVariableName}.w;
`:x+=`${h.associatedVariableName}.w = 1.;
`,x+=`#endif
`);if(x+=`#endif
`,d.compilationString=d.compilationString.replace(this._repeatableContentAnchor,x),p>0)for(let C=0;C<p;C++)d.attributes.push(b.PositionKind+C),g&&d.attributes.push(b.NormalKind+C),E&&d.attributes.push(b.TangentKind+C),v&&d.attributes.push(b.UVKind+"_"+C)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,r=this.tangent,s=this.uv,a=this.positionOutput,o=this.normalOutput,l=this.tangentOutput,c=this.uvOutput,u=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",u),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",u,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(a)} = ${t.associatedVariableName};
`,e.compilationString+=`#ifdef NORMAL
`,e.compilationString+=`${e._declareOutput(o)} = ${i.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(o)} = vec3(0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef TANGENT
`,e.compilationString+=`${e._declareOutput(l)} = ${r.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(l)} = vec4(0., 0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef UV1
`,e.compilationString+=`${e._declareOutput(c)} = ${s.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(c)} = vec2(0., 0.);
`,e.compilationString+=`#endif
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}$("BABYLON.MorphTargetsBlock",ab);class ZW extends ze{constructor(e){super(e,N.Vertex),this.registerInput("worldPosition",S.Vector4,!1,N.Vertex),this.registerOutput("direction",S.Vector3),this.registerOutput("color",S.Color3),this.registerOutput("intensity",S.Float),this.registerOutput("shadowBias",S.Float),this.registerOutput("shadowNormalBias",S.Float),this.registerOutput("shadowDepthScale",S.Float),this.registerOutput("shadowDepthRange",S.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light;const s=t.getScene();if(!r&&s.lights.length&&(r=this.light=s.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);const a=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(a?e.setFloat3(this._lightShadowUniformName,a.bias,a.normalBias,a.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(a&&s.activeCamera){const o=r;e.setFloat2(this._lightShadowExtraUniformName,o.getDepthMinZ(s.activeCamera),o.getDepthMinZ(s.activeCamera)+o.getDepthMaxZ(s.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const r=this.light;i.setValue(this._lightTypeDefineName,!!(r&&r instanceof mh),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,r=this.intensity,s=this.shadowBias,a=this.shadowNormalBias,o=this.shadowDepthScale,l=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");const c=e.shaderLanguage===1?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,S.Vector3),e._emitUniformFromString(this._lightColorUniformName,S.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}
`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${c}${this._lightDataUniformName});
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(t)+` = ${c}${this._lightDataUniformName};
`,e.compilationString+=`#endif
`,e.compilationString+=e._declareOutput(i)+` = ${c}${this._lightColorUniformName}.rgb;
`,e.compilationString+=e._declareOutput(r)+` = ${c}${this._lightColorUniformName}.a;
`,(s.hasEndpoints||a.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,S.Vector3),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${c}${this._lightShadowUniformName}.x;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${c}${this._lightShadowUniformName}.y;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}${this._lightShadowUniformName}.z;
`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,S.Vector2),e.compilationString+=e._declareOutput(l)+` = ${this._lightShadowUniformName};
`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}$("BABYLON.LightInformationBlock",ZW);class ob extends ze{constructor(e){super(e,N.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",S.AutoDetect),this.registerOutput("output",S.Color4),this.registerOutput("rgb",S.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Color4|S.Vector3|S.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>VT),void 0),re(()=>Promise.resolve().then(()=>zV),void 0),re(()=>Promise.resolve().then(()=>qV),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>oC),void 0),re(()=>Promise.resolve().then(()=>EU),void 0),re(()=>Promise.resolve().then(()=>RU),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var a;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const t=this.color,i=this._outputs[0],r=`//${this.name}`,s=e.shaderLanguage===1?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),(a=t.connectedPoint)!=null&&a.isConnected&&(t.connectedPoint.type===S.Color4||t.connectedPoint.type===S.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};
`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${s}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`#else
`,e.compilationString+=`#ifdef IMAGEPROCESSING
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${s}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#endif
`,this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;
`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};
`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}}I([Ne("Convert input to linear space",0,"ADVANCED")],ob.prototype,"convertInputToLinearSpace",void 0);$("BABYLON.ImageProcessingBlock",ob);class ml extends ze{constructor(e){super(e,N.Fragment,!0),this.registerInput("normal",S.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(S.Color4|S.Vector4|S.Vector3),this.registerInput("tangent",S.Vector4,!1),this.registerInput("world",S.Matrix,!1),this.registerOutput("TBN",S.Object,N.Fragment,new ti("TBN",this,1,ml,"TBNBlock")),this.registerOutput("row0",S.Vector3,N.Fragment),this.registerOutput("row1",S.Vector3,N.Fragment),this.registerOutput("row2",S.Vector3,N.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return N.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.isSystemValue&&r.systemValue===Et.World&&t(r));i||(i=new _t("world"),i.setAsSystemValue(Et.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="normal"&&t(r));i||(i=new _t("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="tangent"&&r.type===S.Vector4&&t(r));i||(i=new _t("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var c,u,h,f;const r=this.normal,s=this.tangent;let a=r.isConnected;(c=r.connectInputBlock)!=null&&c.isAttribute&&!e.isVerticesDataPresent((u=r.connectInputBlock)==null?void 0:u.name)&&(a=!1);let o=s.isConnected;(h=s.connectInputBlock)!=null&&h.isAttribute&&!e.isVerticesDataPresent((f=s.connectInputBlock)==null?void 0:f.name)&&(o=!1);const l=a&&o;i.setValue("TBNBLOCK",l,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,r=this.world,s=this.TBN,a=this.row0,o=this.row1,l=this.row2,c=e.shaderLanguage===1,u=c?"mat3x3f":"mat3",h=c?"f":"";return e.target===N.Fragment&&(e.compilationString+=`
                // ${this.name}
                ${e._declareLocalVar("tbnNormal",S.Vector3)} = normalize(${t.associatedVariableName}).xyz;
                ${e._declareLocalVar("tbnTangent",S.Vector3)} = normalize(${i.associatedVariableName}.xyz);
                ${e._declareLocalVar("tbnBitangent",S.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;
                ${c?"var":"mat3"} ${s.associatedVariableName} = ${u}(${r.associatedVariableName}[0].xyz, ${r.associatedVariableName}[1].xyz, ${r.associatedVariableName}[2].xyz) * ${u}(tbnTangent, tbnBitangent, tbnNormal);
            `,a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${h}(${s.associatedVariableName}[0][0], ${s.associatedVariableName}[0][1], ${s.associatedVariableName}[0][2]);
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${h}(${s.associatedVariableName}[1[0], ${s.associatedVariableName}[1][1], ${s.associatedVariableName}[1][2]);
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = vec3${h}(${s.associatedVariableName}[2][0], ${s.associatedVariableName}[2][1], ${s.associatedVariableName}[2][2]);
`),e.sharedData.blocksWithDefines.push(this)),this}}$("BABYLON.TBNBlock",ml);class Oc extends ze{constructor(e){super(e,N.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",S.Vector4,!1),this.registerInput("worldNormal",S.Vector4,!1),this.registerInput("worldTangent",S.Vector4,!0),this.registerInput("uv",S.Vector2,!1),this.registerInput("normalMapColor",S.Color3,!1),this.registerInput("strength",S.Float,!1),this.registerInput("viewDirection",S.Vector3,!0),this.registerInput("parallaxScale",S.Float,!0),this.registerInput("parallaxHeight",S.Float,!0),this.registerInput("TBN",S.Object,!0,N.VertexAndFragment,new ti("TBN",this,0,ml,"TBNBlock")),this.registerInput("world",S.Matrix,!0),this.registerOutput("output",S.Vector4),this.registerOutput("uvOffset",S.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>nG),void 0),re(()=>Promise.resolve().then(()=>Nk),void 0),re(()=>Promise.resolve().then(()=>Fk),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>g4),void 0),re(()=>Promise.resolve().then(()=>Wz),void 0),re(()=>Promise.resolve().then(()=>Xz),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}prepareDefines(e,t,i){const r=this.normalMapColor.connectedPoint._ownerBlock.samplerName,s=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&r||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",s,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv"&&t(r));i||(i=new _t("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const i=new _t("strength");i.value=1,i.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,r=this.worldPosition,s=this.worldNormal,a=this.worldTangent,o=e.shaderLanguage===1,l=o?"mat3x3f":"mat3",c=o?"f":"",u=o?"uniforms.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,S.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,S.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,S.Matrix);let h=null;this.normalMapColor.connectedPoint&&(h=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const f=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&h||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),d=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",p=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${e._emitFloat(this.strength.connectInputBlock.value)}`:`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${this.strength.associatedVariableName}`;o||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const _={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},g={search:/varying mat3 vTBN;/g,replace:""},E={search:/uniform mat4 normalMatrix;/g,replace:""},v=this.TBN;v.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${o?"var":"mat3"} vTBN = ${v.associatedVariableName};
            #endif
            `:a.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",S.Vector3)} = normalize(${s.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnTangent",S.Vector3)} = normalize(${a.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",S.Vector3)} = cross(tbnNormal, tbnTangent) * ${o?"uniforms.":""}${this._tangentCorrectionFactorName};
`,e.compilationString+=`${o?"var":"mat3"} vTBN = ${l}(tbnTangent, tbnBitangent, tbnNormal);
`);let x=[_,g,E];o&&(x.push({search:/varying vTBN0: vec3f;/g,replace:""}),x.push({search:/varying vTBN1: vec3f;/g,replace:""}),x.push({search:/varying vTBN2: vec3f;/g,replace:""})),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:x});const A=o?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bump: texture_2d<f32>, bumpSampler: sampler)":`#define inline
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`,T=o?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,C=o?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)",y=o?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g;e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:T,replace:A},{search:y,replace:C},{search:/texture.+?bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const P=o?`textureSample(${h}, ${h+"Sampler"}`:`texture2D(${h}`,D=!f||!h?this.normalMapColor.associatedVariableName:`${P}, ${i.associatedVariableName} + uvOffset).xyz`,F=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(F,S.Vector3)+` = vec3${c}(0.);
`,x=[{search:new RegExp(`texture.+?bumpSampler${o?"Sampler,fragmentInputs.":","}vBumpUV\\)`,"g"),replace:`${D}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",S.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:new RegExp(`perturbNormal\\(TBN,texture.+?bumpSampler${o?"Sampler,fragmentInputs.":","}vBumpUV\\+uvOffset\\).xyz,${o?"uniforms.":""}vBumpInfos.y\\)`,"g"),replace:`perturbNormal(TBN, ${D}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${o?f&&this.useParallaxOcclusion?`${h}, ${h+"Sampler"}`:"bump, bumpSampler":f&&this.useParallaxOcclusion?h:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${f?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vBumpInfos.y/g,replace:p},{search:/vBumpInfos.z/g,replace:d},{search:/normalW=/g,replace:F+" = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${l}(normalMatrix) * `+F},{search:/normalW/g,replace:s.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:f?this.viewDirection.associatedVariableName:`vec3${c}(0.)`},_],o?(x.push({search:/fragmentInputs.vBumpUV/g,replace:i.associatedVariableName}),x.push({search:/input.vPositionW/g,replace:r.associatedVariableName+".xyz"}),x.push({search:/uniforms.vTangentSpaceParams/g,replace:u+this._tangentSpaceParameterName}),x.push({search:/var TBN: mat3x3f=mat3x3<f32>\(input.vTBN0,input.vTBN1,input.vTBN2\);/g,replace:"var TBN = vTBN;"})):(x.push({search:/vBumpUV/g,replace:i.associatedVariableName}),x.push({search:/vPositionW/g,replace:r.associatedVariableName+".xyz"}),x.push({search:/vTangentSpaceParams/g,replace:u+this._tangentSpaceParameterName})),e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:x}),e.compilationString+=e._declareOutput(this.output)+` = vec4${c}(${F}, 0.);
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};
`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};
`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};
`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};
`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}I([Ne("Invert X axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Oc.prototype,"invertX",void 0);I([Ne("Invert Y axis",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Oc.prototype,"invertY",void 0);I([Ne("Use parallax occlusion",0,void 0,{embedded:!0,notifiers:{update:!1}})],Oc.prototype,"useParallaxOcclusion",void 0);I([Ne("Object Space Mode",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],Oc.prototype,"useObjectSpaceNormalMap",void 0);$("BABYLON.PerturbNormalBlock",Oc);class QW extends ze{constructor(e){super(e,N.Fragment,!0),this.registerInput("value",S.Float,!0),this.registerInput("cutoff",S.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }
`,this}}$("BABYLON.DiscardBlock",QW);class JW extends ze{constructor(e){super(e,N.Fragment),this.registerOutput("output",S.Float,N.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===N.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",e.shaderLanguage===0?"gl_FrontFacing":"fragmentInputs.frontFacing")};
`,this}}$("BABYLON.FrontFacingBlock",JW);class eH extends ze{constructor(e){super(e,N.Fragment),this.registerInput("input",S.AutoDetect,!1),this.registerOutput("dx",S.BasedOnInput),this.registerOutput("dy",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let r="dFdx",s="dFdy";return e.shaderLanguage===1&&(r="dpdx",s="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${s}(${this.input.associatedVariableName});
`),this}}$("BABYLON.DerivativeBlock",eH);class tH extends ze{constructor(e){super(e,N.Fragment),this.registerOutput("xy",S.Vector2,N.Fragment),this.registerOutput("xyz",S.Vector3,N.Fragment),this.registerOutput("xyzw",S.Vector4,N.Fragment),this.registerOutput("x",S.Float,N.Fragment),this.registerOutput("y",S.Float,N.Fragment),this.registerOutput("z",S.Float,N.Fragment),this.registerOutput("w",S.Float,N.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";const i=e.shaderLanguage===1?"fragmentInputs.position":"gl_FragCoord";for(const r of this._outputs)r.hasEndpoints&&(t+=`${e._declareOutput(r)} = ${i}.${r.name};
`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===N.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}$("BABYLON.FragCoordBlock",tH);class iH extends ze{constructor(e){super(e,N.Fragment),this.registerOutput("xy",S.Vector2,N.Fragment),this.registerOutput("x",S.Float,N.Fragment),this.registerOutput("y",S.Float,N.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===N.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,S.Vector2);const t=e.shaderLanguage===1?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}}$("BABYLON.ScreenSizeBlock",iH);class rH extends ze{constructor(e){super(e,N.Fragment),this.registerInput("vector",S.AutoDetect),this.registerInput("worldViewProjection",S.Matrix),this.registerOutput("output",S.Vector2),this.registerOutput("x",S.Float),this.registerOutput("y",S.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.WorldViewProjection&&t(r));i||(i=new _t("worldViewProjection"),i.setAsSystemValue(Et.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const r=i.associatedVariableName,s=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case S.Vector3:e.compilationString+=`${e._declareLocalVar(s,S.Vector4)} = ${r} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`;break;case S.Vector4:e.compilationString+=`${e._declareLocalVar(s,S.Vector4)} = ${r} * ${t.associatedVariableName};
`;break}return e.compilationString+=`${s} = vec4${e.fSuffix}(${s}.xy / ${s}.w, ${s}.zw);`,e.compilationString+=`${s} = vec4${e.fSuffix}(${s}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${s}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${s}.xy;
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${s}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${s}.y;
`),this}}$("BABYLON.ScreenSpaceBlock",rH);class sH extends ze{constructor(e){super(e,N.Fragment),this.registerInput("input",S.Vector2),this.registerInput("strength",S.Float),this.registerInput("center",S.Vector2),this.registerInput("offset",S.Vector2),this.registerOutput("output",S.Vector2),this.registerOutput("x",S.Float),this.registerOutput("y",S.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new _t("center");e.value=new se(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new _t("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new _t("offset");e.value=new se(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),s=e._getFreeVariableName("y"),a=e._getFreeVariableName("result");return e.compilationString+=`        
            ${e._declareLocalVar(t,S.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};
            ${e._declareLocalVar(i,S.Float)} = ${this.strength.associatedVariableName} * length(${t});
            ${e._declareLocalVar(r,S.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;
            ${e._declareLocalVar(s,S.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;
            ${e._declareLocalVar(a,S.Vector2)} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${s} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);
        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${a};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${a}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${a}.y;
`),this}}$("BABYLON.TwirlBlock",sH);class zh extends ze{constructor(e){super(e,N.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",S.Float),this.registerInput("worldPosition",S.Vector3),this.registerInput("worldNormal",S.Vector3),this.registerInput("worldTangent",S.AutoDetect,!0),this.registerOutput("output",S.Vector4),this.registerOutput("xyz",S.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e.shaderLanguage===1,r=e.fSuffix;!this.generateInWorldSpace&&!this.worldTangent.isConnected&&w.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const s=this.generateInWorldSpace?"":`
            vec3 biTangent = cross(norm, tgt);
            mat3 TBN = mat3(tgt, biTangent, norm);
            `,a=this.generateInWorldSpace?"":`
            result = TBN * result;
            result = result * vec3(0.5) + vec3(0.5);
            `;let o=`
            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {
                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}
                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}
                ${s}
                vec3 worlddX = dFdx(position);
                vec3 worlddY = dFdy(position);
                vec3 crossX = cross(norm, worlddX);
                vec3 crossY = cross(worlddY, norm);
                float d = abs(dot(crossY, worlddX));
                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
                inToNormal.y *= -1.0;
                vec3 result = normalize((d * norm) - inToNormal);
                ${a}
                return vec4(result, 0.);
            }`;return i?o=e._babylonSLtoWGSL(o):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",o,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${r}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});
`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};
`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};
`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};
`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}I([Ne("Generate in world space instead of tangent space",0,"PROPERTIES",{notifiers:{update:!0}})],zh.prototype,"generateInWorldSpace",void 0);I([Ne("Force normalization for the worldNormal input",0,"PROPERTIES",{notifiers:{update:!0}})],zh.prototype,"automaticNormalizationNormal",void 0);I([Ne("Force normalization for the worldTangent input",0,"PROPERTIES",{notifiers:{update:!0}})],zh.prototype,"automaticNormalizationTangent",void 0);$("BABYLON.HeightToNormalBlock",zh);class nH extends ze{constructor(e){super(e,N.Fragment,!0),this.registerInput("depth",S.Float,!0),this.registerInput("worldPos",S.Vector4,!0),this.registerInput("viewProjection",S.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);const t=e.shaderLanguage===0?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};
`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`
                ${e._declareLocalVar("p",S.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};
                ${e._declareLocalVar("v",S.Float)} = p.z / p.w;
                #ifndef IS_NDC_HALF_ZRANGE
                    v = v * 0.5 + 0.5;
                #endif
                ${t} = v;
    
            `:w.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}$("BABYLON.FragDepthBlock",nH);class aH extends ze{constructor(e){super(e,N.Fragment),this.registerInput("worldPosition",S.Vector4,!1),this.registerInput("viewProjection",S.Matrix,!1),this.registerInput("worldNormal",S.AutoDetect,!0),this.registerOutput("depth",S.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>CF),void 0),re(()=>Promise.resolve().then(()=>XL),void 0),re(()=>Promise.resolve().then(()=>tF),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>s1),void 0),re(()=>Promise.resolve().then(()=>tL),void 0),re(()=>Promise.resolve().then(()=>BF),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=e.shaderLanguage===1;e._emitUniformFromString("biasAndScaleSM",S.Vector3),e._emitUniformFromString("lightDataSM",S.Vector3),e._emitUniformFromString("depthValuesSM",S.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`${e._declareLocalVar("worldPos",S.Vector4)} = ${this.worldPosition.associatedVariableName};
`,e.compilationString+=`${e._declareLocalVar("vPositionWSM",S.Vector3)};
`,e.compilationString+=`${e._declareLocalVar("vDepthMetricSM",S.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar("zSM",S.Float)};
`,this.worldNormal.isConnected&&(e.compilationString+=`${e._declareLocalVar("vNormalW",S.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`${e._declareLocalVar("clipPos",S.Vector4)} = ${this.viewProjection.associatedVariableName} * worldPos;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"},{search:/vertexOutputs.position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]});const r=i?"fragmentOutputs.fragDepth":"gl_FragDepth";return e.compilationString+=`
            #if SM_DEPTHTEXTURE == 1
                #ifdef IS_NDC_HALF_ZRANGE
                    ${r} = (clipPos.z / clipPos.w);
                #else
                    ${r} = (clipPos.z / clipPos.w) * 0.5 + 0.5;
                #endif
            #endif
        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3${e.fSuffix}(depthSM, 1., 1.);
`,this}}$("BABYLON.ShadowMapBlock",aH);class oH extends ze{constructor(e){super(e,N.Fragment,!0),this.registerInput("viewDepth",S.Float,!0),this.registerInput("screenDepth",S.Float,!0),this.registerInput("worldPosition",S.AutoDetect,!0),this.registerInput("localPosition",S.AutoDetect,!0),this.registerInput("viewNormal",S.AutoDetect,!0),this.registerInput("worldNormal",S.AutoDetect,!0),this.registerInput("reflectivity",S.AutoDetect,!0),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4),this.inputs[4].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4),this.inputs[5].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4),this.inputs[6].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4|S.Color3|S.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get screenDepth(){return this._inputs[1]}get worldPosition(){return this._inputs[2]}get localPosition(){return this._inputs[3]}get viewNormal(){return this._inputs[4]}get worldNormal(){return this._inputs[5]}get reflectivity(){return this._inputs[6]}_getFragData(e,t){return e?`fragmentOutputs.fragData${t}`:`gl_FragData[${t}]`}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.localPosition,r=this.viewNormal,s=this.worldNormal,a=this.viewDepth,o=this.reflectivity,l=this.screenDepth;e.sharedData.blocksWithDefines.push(this);const c=`//${this.name}`,u=e._getShaderType(S.Vector4),h=e.shaderLanguage===1;return e._emitFunctionFromInclude("helperFunctions",c),e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=h?`var fragData: array<vec4<f32>, SCENE_MRT_COUNT>;\r
`:`vec4 fragData[SCENE_MRT_COUNT];\r
`,e.compilationString+=`#ifdef PREPASS_DEPTH\r
`,a.connectedPoint?e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${u}(${a.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${u}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_SCREENSPACE_DEPTH\r
`,l.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(${l.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_POSITION\r
`,t.connectedPoint?e.compilationString+=`fragData[PREPASS_POSITION_INDEX] = ${u}(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===S.Vector4?t.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_POSITION_INDEX] = ${u}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_LOCAL_POSITION\r
`,i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===S.Vector4?i.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_NORMAL\r
`,r.connectedPoint?e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${u}(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===S.Vector4?r.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${u}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_WORLD_NORMAL\r
`,s.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(${s.associatedVariableName}.rgb, ${s.connectedPoint.type===S.Vector4?s.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_REFLECTIVITY\r
`,o.connectedPoint?e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${u}(${o.associatedVariableName}.rgb, ${o.connectedPoint.type===S.Vector4?o.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${u}(0.0, 0.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 1\r
`,e.compilationString+=`${this._getFragData(h,1)} = fragData[1];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 2\r
`,e.compilationString+=`${this._getFragData(h,2)} = fragData[2];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 3\r
`,e.compilationString+=`${this._getFragData(h,3)} = fragData[3];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 4\r
`,e.compilationString+=`${this._getFragData(h,4)} = fragData[4];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 5\r
`,e.compilationString+=`${this._getFragData(h,5)} = fragData[5];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 6\r
`,e.compilationString+=`${this._getFragData(h,6)} = fragData[6];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 7\r
`,e.compilationString+=`${this._getFragData(h,7)} = fragData[7];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this}}$("BABYLON.PrePassOutputBlock",oH);class lH extends ze{constructor(e){super(e,N.VertexAndFragment,!1),this.registerInput("worldPosition",S.Vector4,!1,N.Vertex),this.registerInput("view",S.Matrix,!1,N.Vertex),this.registerInput("input",S.AutoDetect,!1,N.Fragment),this.registerInput("fogColor",S.AutoDetect,!1,N.Fragment),this.registerOutput("output",S.Color3,N.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await re(()=>Promise.resolve().then(()=>F2),void 0):await re(()=>Promise.resolve().then(()=>c2),void 0),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.View&&t(r));i||(i=new _t("view"),i.setAsSystemValue(Et.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.FogColor&&t(r));i||(i=new _t("fogColor",void 0,S.Color3),i.setAsSystemValue(Et.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const r=e.getScene();i.setValue("FOG",t.fogEnabled&&WT(e,r))}bind(e,t,i){if(!i)return;const r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===N.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",r="";e.shaderLanguage===1?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",r="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});const s=e._getFreeVariableName("fog"),a=this.input,o=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const l=this._outputs[0];e._emitUniformFromString(this._fogParameters,S.Vector4),e.compilationString+=`#ifdef FOG
`,e.compilationString+=`${e._declareLocalVar(s,S.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${r}${this._fogParameters});
`,e.compilationString+=e._declareOutput(l)+` = ${s} * ${a.associatedVariableName}.rgb + (1.0 - ${s}) * ${o.associatedVariableName}.rgb;
`,e.compilationString+=`#else
${e._declareOutput(l)} =  ${a.associatedVariableName}.rgb;
`,e.compilationString+=`#endif
`}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,S.Vector3);const r=e.shaderLanguage===1?"vertexOutputs.":"";e.compilationString+=`${r}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;
`}return this}}$("BABYLON.FogBlock",lH);class Pd extends ze{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,w.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?N.Fragment:N.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?N.Fragment:N.Vertex}constructor(e){super(e,N.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",S.Vector4,!1,N.Vertex),this.registerInput("worldNormal",S.Vector4,!1,N.Fragment),this.registerInput("cameraPosition",S.Vector3,!1,N.Fragment),this.registerInput("glossiness",S.Float,!0,N.Fragment),this.registerInput("glossPower",S.Float,!0,N.Fragment),this.registerInput("diffuseColor",S.Color3,!0,N.Fragment),this.registerInput("specularColor",S.Color3,!0,N.Fragment),this.registerInput("view",S.Matrix,!0),this.registerOutput("diffuseOutput",S.Color3,N.Fragment),this.registerOutput("specularOutput",S.Color3,N.Fragment),this.registerOutput("shadow",S.Float,N.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>QV),void 0),re(()=>Promise.resolve().then(()=>HV),void 0),re(()=>Promise.resolve().then(()=>LV),void 0),re(()=>Promise.resolve().then(()=>VT),void 0),re(()=>Promise.resolve().then(()=>YV),void 0),re(()=>Promise.resolve().then(()=>KV),void 0),re(()=>Promise.resolve().then(()=>wV),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>SU),void 0),re(()=>Promise.resolve().then(()=>MU),void 0),re(()=>Promise.resolve().then(()=>xU),void 0),re(()=>Promise.resolve().then(()=>lU),void 0),re(()=>Promise.resolve().then(()=>aU),void 0),re(()=>Promise.resolve().then(()=>oC),void 0),re(()=>Promise.resolve().then(()=>AU),void 0),re(()=>Promise.resolve().then(()=>yU),void 0),re(()=>Promise.resolve().then(()=>uU),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.CameraPosition&&t(r));i||(i=new _t("cameraPosition"),i.setAsSystemValue(Et.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const r=e.getScene();if(!this.light)Ac(r,e,i,!0,t.maxSimultaneousLights);else{const s={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Dp(r,e,this.light,this._lightId,i,!0,s),s.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const a=e.uniforms.indexOf("vLightData"+s)>=0;Np(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,a)}}bind(e,t,i){if(!i)return;const r=i.getScene();this.light?Rp(this.light,this._lightId,r,e,!0):Cc(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,S.Vector4)&&(e.compilationString+=(e.shaderLanguage===1?"vertexOutputs.":"")+`${r} = ${t.associatedVariableName};
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",S.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",S.Matrix)} = ${this.view.associatedVariableName};
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){const t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);const t=e.shaderLanguage===1,i=t?"f":"",r=`//${this.name}`;if(e.target!==N.Fragment){this._injectVertexCode(e);return}this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const s=t?"fragmentInputs.":"";e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const a=this.worldPosition;let o=a.associatedVariableName;this.generateOnlyFragmentCode?(o=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(o,S.Vector3)};
`,r),e.compilationString+=`${o} = ${a.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${a.associatedVariableName}`:void 0})):o=s+"v_"+o+".xyz",e._emitFunctionFromInclude("helperFunctions",r);let l={search:/vPositionW/g,replace:o};if(t&&(l={search:/fragmentInputs\.vPositionW/g,replace:o}),e._emitFunctionFromInclude("lightsFragmentFunctions",r,{replaceStrings:[l]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",r,{replaceStrings:[l]}),this._injectUBODeclaration(e),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",S.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${o});
`),e.compilationString+=t?`var info: lightingInfo;
`:`lightingInfo info;
`,e.compilationString+=`${e._declareLocalVar("shadow",S.Float)} = 1.;
`,e.compilationString+=`${e._declareLocalVar("aggShadow",S.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("numLights",S.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("glossiness",S.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};
`,e.compilationString+=`${e._declareLocalVar("diffuseBase",S.Vector3)} = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("specularBase",S.Vector3)}  = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("normalW",S.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`),this.light){let h={search:/vPositionW/g,replace:o+".xyz"};t&&(h={search:/fragmentInputs\.vPositionW/g,replace:o+".xyz"}),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},h]})}else{let h=`vPositionW,${o}.xyz`;t&&(h=`fragmentInputs.vPositionW,${o}.xyz`),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:h})}this._lightId===0&&(e.compilationString+=`aggShadow = aggShadow / numLights;
`);const c=this.diffuseOutput,u=this.specularOutput;return e.compilationString+=e._declareOutput(c)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};
`,u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};
`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+` = aggShadow;
`),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}I([Ne("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Pd._OnGenerateOnlyFragmentCodeChanged}})],Pd.prototype,"generateOnlyFragmentCode",void 0);$("BABYLON.LightBlock",Pd);class us extends ze{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??$e.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,N.VertexAndFragment),this.registerOutput("source",S.Object,N.VertexAndFragment,new ti("source",this,1,us,"ImageSourceBlock")),this.registerOutput("dimensions",S.Vector2)}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),e.target===N.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let t="";e.shaderLanguage===1?t=`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:t=`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${t};
`}return e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!Ci.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(e.texture.url.indexOf("data:")===0?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=Z.Parse(e.texture,t,i))}}$("BABYLON.ImageSourceBlock",us);class Wu extends ze{get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)==null?void 0:e.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??$e.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}static _IsPrePassTextureBlock(e){return(e==null?void 0:e.getClassName())==="PrePassTextureBlock"}get _isSourcePrePass(){return Wu._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!Wu._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const t=this.texture.getScene()??$e.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const t=this.texture.getScene()??$e.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?N.Fragment:N.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",S.AutoDetect,!1,N.VertexAndFragment),this.registerInput("source",S.Object,!0,N.VertexAndFragment,new ti("source",this,0,us,"ImageSourceBlock")),this.registerInput("layer",S.Float,!0),this.registerInput("lod",S.Float,!0),this.registerOutput("rgba",S.Color4,N.Neutral),this.registerOutput("rgb",S.Color3,N.Neutral),this.registerOutput("r",S.Float,N.Neutral),this.registerOutput("g",S.Float,N.Neutral),this.registerOutput("b",S.Float,N.Neutral),this.registerOutput("a",S.Float,N.Neutral),this.registerOutput("level",S.Float,N.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector2|S.Vector3|S.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}_isTiedToFragment(e){if(e.target===N.Fragment)return!0;if(e.target===N.Vertex)return!1;if(e.target===N.Neutral||e.target===N.VertexAndFragment){const t=e.ownerBlock;if(t.target===N.Fragment)return!0;for(const i of t.inputs)if(i.isConnected&&this._isTiedToFragment(i.connectedPoint))return!0}return!1}_getEffectiveTarget(){return this._fragmentOnly?N.Fragment:!this.uv.isConnected||this.uv.sourceBlock.isInput?N.VertexAndFragment:this._isTiedToFragment(this.uv.connectedPoint)?N.Fragment:N.VertexAndFragment}get target(){return this._getEffectiveTarget()}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){if(e.mode===Mr.PostProcess){const i=e.getBlockByPredicate(r=>r.name==="uv"&&t(r));i&&i.connectTo(this)}else if(e.mode!==Mr.ProceduralTexture){const i=e.mode===Mr.Particle?"particle_uv":"uv";let r=e.getInputBlockByPredicate(s=>s.isAttribute&&s.name===i&&t(s));r||(r=new _t("uv"),r.setAsAttribute(i)),r.output.connectTo(this.uv)}}}initializeDefines(e,t,i){i._areTexturesDirty&&this._mainUVDefineName!==void 0&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),i[this._mainUVDefineName]==null&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return this._isSourcePrePass?!0:!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==N.Fragment}_injectVertexCode(e){const t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,S.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,S.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,S.Matrix,this._defineName);const i=e._getShaderType(S.Vector4),r=e._getShaderType(S.Vector2);e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${r}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`;let s="";if(e.shaderLanguage===1&&t.isConnectedToInputBlock&&t.associatedVariableName.indexOf("vertexInputs.")===-1&&(s="vertexInputs."),e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${s}${t.associatedVariableName}.xy;
`,e.compilationString+=`#endif
`,!!this._outputs.some(a=>a.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const a of this._outputs)a.hasEndpoints&&a.name!=="level"&&this._writeOutput(e,a,a.name,!0)}}_getUVW(e){var s,a,o,l;let t=e;const i=((a=(s=this._texture)==null?void 0:s._texture)==null?void 0:a.is2DArray)??!1,r=((l=(o=this._texture)==null?void 0:o._texture)==null?void 0:l.is3D)??!1;if(i){const c=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${c})`}else if(r){const c=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${c})`}return t}_samplerFunc(e){return e.shaderLanguage===1?e.target===N.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(t.shaderLanguage===1){const i=t.target===N.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};
`,e.compilationString+=`#endif
`}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===N.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===N.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};
`;return}this._generateTextureLookup(e)}_generateConversionCode(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = ${e._toLinearSpace(t)};
                #endif
            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===N.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===N.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}let s="";this.disableLevelMultiplication||(s=` * ${(e.shaderLanguage===1?"uniforms.":"")+this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${s};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){var i,r,s,a;if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===N.Vertex||this._fragmentOnly||e.target===N.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===N.Fragment||this._isMixed&&e.target===N.Vertex){if(!this._imageSource){const o=e._getFreeVariableName(this.name);this._samplerName=o+"Texture",(r=(i=this._texture)==null?void 0:i._texture)!=null&&r.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==N.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(o=>o.isConnectedInFragmentShader))return;this._isMixed&&!this._imageSource&&((a=(s=this._texture)==null?void 0:s._texture)!=null&&a.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,S.Float),this._writeTextureRead(e);for(const o of this._outputs)o.hasEndpoints&&o.name!=="level"&&this._writeOutput(e,o,o.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!Ci.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(e.texture.url.indexOf("data:")===0?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=Z.Parse(e.texture,t,i))}}$("BABYLON.TextureBlock",Wu);class cc extends ze{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??$e.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?N.Fragment:N.VertexAndFragment)}constructor(e){super(e,N.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await re(()=>Promise.resolve().then(()=>kV),void 0):await re(()=>Promise.resolve().then(()=>mU),void 0),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="position"&&t(r));i||(i=new _t("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.World&&t(r));i||(i=new _t("world"),i.setAsSystemValue(Et.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.View&&t(r));i||(i=new _t("view"),i.setAsSystemValue(Et.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this._getTexture();!r||!r.getTextureMatrix||(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLocalCubicName,!!r.boundingBoxSize,!0),i.setValue(this._defineExplicitName,r.coordinatesMode===0,!0),i.setValue(this._defineSkyboxName,r.coordinatesMode===5,!0),i.setValue(this._defineCubicName,r.coordinatesMode===3||r.coordinatesMode===6,!0),i.setValue("INVERTCUBICMAP",r.coordinatesMode===6,!0),i.setValue(this._defineSphericalName,r.coordinatesMode===1,!0),i.setValue(this._definePlanarName,r.coordinatesMode===2,!0),i.setValue(this._defineProjectionName,r.coordinatesMode===4,!0),i.setValue(this._defineEquirectangularName,r.coordinatesMode===7,!0),i.setValue(this._defineEquirectangularFixedName,r.coordinatesMode===8,!0),i.setValue(this._defineMirroredEquirectangularFixedName,r.coordinatesMode===9,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i,r){const s=this._getTexture();if(!(!i||!s)&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),s.boundingBoxSize)){const a=s;e.setVector3(this._reflectionPositionName,a.boundingBoxPosition),e.setVector3(this._reflectionSizeName,a.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===N.Vertex)return"";const t=e.shaderLanguage===1;this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,S.Matrix);let i="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const r=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(r,S.Vector4))&&(this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(r,S.Vector4)} = ${this.worldPosition.associatedVariableName};
`:i+=`${t?"vertexOutputs.":""}${r} = ${this.worldPosition.associatedVariableName};
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,S.Vector3,this._defineSkyboxName))&&(i+=`#ifdef ${this._defineSkyboxName}
`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._positionUVWName,S.Vector3)} = ${this.position.associatedVariableName}.xyz;
`:i+=`${t?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;
`,i+=`#endif
`),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,S.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(i+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})
`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._directionWName,S.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`:i+=`${t?"vertexOutputs.":""}${this._directionWName} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`,i+=`#endif
`),i}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+=`#endif
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords\(worldPos: vec4f,worldNormal: vec3f\)->vec3f/g,replace:"fn DUMMYFUNC()"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,S.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,S.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,r=!1,s=!1){i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const o=(e.shaderLanguage===1?"uniforms.":"")+this._reflectionMatrixName,l=`normalize(${this._directionWName})`,c=`${this._positionUVWName}`,u=`${this.cameraPosition.associatedVariableName}`,h=`${this.view.associatedVariableName}`;t+=".xyz";let f=`
            #ifdef ${this._defineMirroredEquirectangularFixedName}
               ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${l});
            #endif

            #ifdef ${this._defineEquirectangularFixedName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${l});
            #endif

            #ifdef ${this._defineEquirectangularName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${u}.xyz, ${o});
            #endif

            #ifdef ${this._defineSphericalName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeSphericalCoords(${i}, ${t}, ${h}, ${o});
            #endif

            #ifdef ${this._definePlanarName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computePlanarCoords(${i}, ${t}, ${u}.xyz, ${o});
            #endif

            #ifdef ${this._defineCubicName}
                #ifdef ${this._defineLocalCubicName}
                    ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${u}.xyz, ${o}, ${this._reflectionSizeName}, ${this._reflectionPositionName});
                #else
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeCubicCoords(${i}, ${t}, ${u}.xyz, ${o});
                #endif
            #endif

            #ifdef ${this._defineProjectionName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeProjectionCoords(${i}, ${h}, ${o});
            #endif

            #ifdef ${this._defineSkyboxName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = computeSkyBoxCoords(${c}, ${o});
            #endif

            #ifdef ${this._defineExplicitName}
                ${e._declareLocalVar(this._reflectionVectorName,S.Vector3)} = vec3(0, 0, 0);
            #endif
`;return s||(f+=`#ifdef ${this._defineOppositeZ}
                ${this._reflectionVectorName}.z *= -1.0;
            #endif
`),r||(f+=`
                #ifdef ${this._define3DName}
                    ${e._declareLocalVar(this._reflectionCoordsName,S.Vector3)} = ${this._reflectionVectorName};
                #else
                    ${e._declareLocalVar(this._reflectionCoordsName,S.Vector2)} = ${this._reflectionVectorName}.xy;
                    #ifdef ${this._defineProjectionName}
                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;
                    #endif
                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;
                #endif
`),f}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let r=S.Vector4;i.length===3&&(r=S.Vector3);let s=`${e._declareLocalVar(this._reflectionColorName,r)};
            #ifdef ${this._define3DName}
`;return t?s+=`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};
`:s+=`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};
`,s+=`
            #else
`,t?s+=`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};
`:s+=`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};
`,s+=`#endif
`,s}writeOutputs(e,t){let i="";if(e.target===N.Fragment)for(const r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});
`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);
`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!Ci.IgnoreTexturesAtLoadTime&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=ir.Parse(e.texture,t,i):this.texture=Z.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}I([Ne("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:cc._OnGenerateOnlyFragmentCodeChanged}})],cc.prototype,"generateOnlyFragmentCode",void 0);$("BABYLON.ReflectionTextureBaseBlock",cc);class cH extends cc{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,w.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,w.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?N.Fragment:N.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?N.Fragment:N.Vertex}constructor(e){super(e),this.registerInput("position",S.AutoDetect,!1,N.Vertex),this.registerInput("worldPosition",S.Vector4,!1,N.Vertex),this.registerInput("worldNormal",S.Vector4,!1,N.Fragment),this.registerInput("world",S.Matrix,!1,N.Vertex),this.registerInput("cameraPosition",S.Vector3,!1,N.Fragment),this.registerInput("view",S.Matrix,!1,N.Fragment),this.registerOutput("rgb",S.Color3,N.Fragment),this.registerOutput("rgba",S.Color4,N.Fragment),this.registerOutput("r",S.Float,N.Fragment),this.registerOutput("g",S.Float,N.Fragment),this.registerOutput("b",S.Float,N.Fragment),this.registerOutput("a",S.Float,N.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.CameraPosition&&t(r));i||(i=new _t("cameraPosition"),i.setAsSystemValue(Et.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==N.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,S.Vector4)} = normalize(${this.worldNormal.associatedVariableName});
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}$("BABYLON.ReflectionTextureBlock",cH);class Wh extends ze{constructor(e){super(e,N.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",S.AutoDetect,!1,N.VertexAndFragment),this.registerOutput("depth",S.Float,N.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector2|S.Vector3|S.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?N.VertexAndFragment:N.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,t.type===S.Vector3?S.Vector3:t.type===S.Vector4?S.Vector4:S.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,S.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===N.Fragment)return;const s=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,a=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)}=  ${s} ${i.associatedVariableName}.xy${a});
`;return}const r=e.shaderLanguage===0?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===N.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${r} ${i.associatedVariableName}.xy);
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===N.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===N.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==N.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}I([Ne("Use non linear depth",0,"ADVANCED",{embedded:!0,notifiers:{activatePreviewCommand:!0,callback:(n,e)=>{const t=e;let i=!1;return t.useNonLinearDepth&&(t.storeCameraSpaceZ=!1,i=!0),n&&n.disableDepthRenderer(),i}}})],Wh.prototype,"useNonLinearDepth",void 0);I([Ne("Store Camera space Z",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(n,e)=>{const t=e;let i=!1;return t.storeCameraSpaceZ&&(t.useNonLinearDepth=!1,i=!0),n&&n.disableDepthRenderer(),i}}})],Wh.prototype,"storeCameraSpaceZ",void 0);I([Ne("Force 32 bits float",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:n=>n==null?void 0:n.disableDepthRenderer()}})],Wh.prototype,"force32itsFloat",void 0);$("BABYLON.SceneDepthBlock",Wh);class uH extends ze{constructor(e){super(e,N.VertexAndFragment,!0),this.registerInput("worldPosition",S.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>JL),void 0),re(()=>Promise.resolve().then(()=>ZL),void 0),re(()=>Promise.resolve().then(()=>IF),void 0),re(()=>Promise.resolve().then(()=>dF),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>rL),void 0),re(()=>Promise.resolve().then(()=>JN),void 0),re(()=>Promise.resolve().then(()=>DL),void 0),re(()=>Promise.resolve().then(()=>_L),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get target(){return N.VertexAndFragment}set target(e){}prepareDefines(e,t,i){const r=e.getScene(),s=!!(t.clipPlane??r.clipPlane),a=!!(t.clipPlane2??r.clipPlane2),o=!!(t.clipPlane3??r.clipPlane3),l=!!(t.clipPlane4??r.clipPlane4),c=!!(t.clipPlane5??r.clipPlane5),u=!!(t.clipPlane6??r.clipPlane6);i.setValue("CLIPPLANE",s,!0),i.setValue("CLIPPLANE2",a,!0),i.setValue("CLIPPLANE3",o,!0),i.setValue("CLIPPLANE4",l,!0),i.setValue("CLIPPLANE5",c,!0),i.setValue("CLIPPLANE6",u,!0)}bind(e,t,i){if(!i)return;const r=i.getScene();Sn(e,t,r)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==N.Fragment){const i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",S.Vector4),e._emitUniformFromString("vClipPlane2",S.Vector4),e._emitUniformFromString("vClipPlane3",S.Vector4),e._emitUniformFromString("vClipPlane4",S.Vector4),e._emitUniformFromString("vClipPlane5",S.Vector4),e._emitUniformFromString("vClipPlane6",S.Vector4);return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}$("BABYLON.ClipPlanesBlock",uH);class hH extends ze{get texture(){return null}set texture(e){}constructor(e,t=N.VertexAndFragment){super(e,t,!1),this.registerOutput("position",S.Object,N.VertexAndFragment,new ti("position",this,1,us,"ImageSourceBlock")),this.registerOutput("localPosition",S.Object,N.VertexAndFragment,new ti("localPosition",this,1,us,"ImageSourceBlock")),this.registerOutput("depth",S.Object,N.VertexAndFragment,new ti("depth",this,1,us,"ImageSourceBlock")),this.registerOutput("screenDepth",S.Object,N.VertexAndFragment,new ti("screenDepth",this,1,us,"ImageSourceBlock")),this.registerOutput("normal",S.Object,N.VertexAndFragment,new ti("normal",this,1,us,"ImageSourceBlock")),this.registerOutput("worldNormal",S.Object,N.VertexAndFragment,new ti("worldNormal",this,1,us,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._localPositionSamplerName:e===this._outputs[2]?this._depthSamplerName:e===this._outputs[3]?this._screenSpaceDepthSamplerName:e===this._outputs[4]?this._normalSamplerName:e===this._outputs[5]?this._worldNormalSamplerName:""}get position(){return this._outputs[0]}get localPosition(){return this._outputs[1]}get depth(){return this._outputs[2]}get screenDepth(){return this._outputs[3]}get normal(){return this._outputs[4]}get worldNormal(){return this._outputs[5]}get positionSamplerName(){return this._positionSamplerName}get localPositionSamplerName(){return this._localPositionSamplerName}get normalSamplerName(){return this._normalSamplerName}get worldNormalSamplerName(){return this._worldNormalSamplerName}get depthSamplerName(){return this._depthSamplerName}get linearDepthSamplerName(){return this._screenSpaceDepthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==N.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",this._worldNormalSamplerName="prepassWorldNormalSampler",this._localPositionSamplerName="prepassLocalPositionSampler",this._screenSpaceDepthSamplerName="prepassScreenSpaceDepthSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.variableNames.prepassWorldNormalSampler=0,e.sharedData.variableNames.prepassLocalPositionSampler=0,e.sharedData.variableNames.prepassScreenSpaceDepthSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),this.position.isConnected&&e._emit2DSampler(this._positionSamplerName),this.depth.isConnected&&e._emit2DSampler(this._depthSamplerName),this.normal.isConnected&&e._emit2DSampler(this._normalSamplerName),this.worldNormal.isConnected&&e._emit2DSampler(this._worldNormalSamplerName),this.localPosition.isConnected&&e._emit2DSampler(this._localPositionSamplerName),this.screenDepth.isConnected&&e._emit2DSampler(this._screenSpaceDepthSamplerName),this}bind(e,t){const r=t.getScene().enablePrePassRenderer();if(!r)return;const s=r.defaultRT;s.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,s.textures[r.getIndex(1)]),this.localPosition.isConnected&&e.setTexture(this._localPositionSamplerName,s.textures[r.getIndex(9)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,s.textures[r.getIndex(5)]),this.screenDepth.isConnected&&e.setTexture(this._screenSpaceDepthSamplerName,s.textures[r.getIndex(10)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,s.textures[r.getIndex(6)]),this.worldNormal.isConnected&&e.setTexture(this._worldNormalSamplerName,s.textures[r.getIndex(8)]))}}$("BABYLON.PrePassTextureBlock",hH);class fH extends ze{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==N.VertexAndFragment)return t.target;if(e.connectedPoint.target!==N.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,N.Neutral),this._endpoints=[],this.registerInput("input",S.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some(e=>e.output.isConnectedInFragmentShader)}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name,this._outputs=this._endpoints.map(t=>t.output)}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null,this._outputs=this._endpoints.map(i=>i.output))}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}$("BABYLON.NodeMaterialTeleportInBlock",fH);class dH extends ze{constructor(e){super(e,N.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",S.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};
`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){var t;const e=super.serialize();return e.entryPoint=((t=this.entryPoint)==null?void 0:t.uniqueId)??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}$("BABYLON.NodeMaterialTeleportOutBlock",dH);class pH extends Gh{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};
`,this}}$("BABYLON.AddBlock",pH);class _H extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.AutoDetect),this.registerInput("factor",S.Float),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};
`,this}}$("BABYLON.ScaleBlock",_H);class C_ extends ze{constructor(e){super(e,N.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e.shaderLanguage===1?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};
`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}I([Ne("Minimum",1,void 0,{embedded:!0})],C_.prototype,"minimum",void 0);I([Ne("Maximum",1,void 0,{embedded:!0})],C_.prototype,"maximum",void 0);$("BABYLON.ClampBlock",C_);class mH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix),this._inputs[0].excludedConnectionPointTypes.push(S.Vector2),this._inputs[1].excludedConnectionPointTypes.push(S.Float),this._inputs[1].excludedConnectionPointTypes.push(S.Matrix),this._inputs[1].excludedConnectionPointTypes.push(S.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);
`,this}}$("BABYLON.CrossBlock",mH);class gH extends ze{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(s=>{const a=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),o=e._getGLType(s.type);t=t.replace(a,o),i=i.replace(a,o)}),this._outputs.forEach(s=>{const a=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),o=e._getGLType(s.type);t=t.replace(a,o),i=i.replace(a,o)}),e._emitFunction(i,t,""),this._outputs.forEach(s=>{e.compilationString+=e._declareOutput(s)+`;
`}),e.compilationString+=i+"(";let r=!1;return this._inputs.forEach((s,a)=>{var o,l;a>0&&(e.compilationString+=", "),this._inputSamplers&&this._inputSamplers.indexOf(s.name)!==-1?e.compilationString+=((l=(o=s.connectedPoint)==null?void 0:o.ownerBlock)==null?void 0:l.samplerName)??s.associatedVariableName:e.compilationString+=s.associatedVariableName,r=!0}),this._outputs.forEach((s,a)=>{(a>0||r)&&(e.compilationString+=", "),e.compilationString+=s.associatedVariableName}),e.compilationString+=`);
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};
`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,r;this._options=e,this._code=e.code.join(`
`)+`
`,this.name=this.name||e.name,this.target=N[e.target],(t=e.inParameters)==null||t.forEach((s,a)=>{const o=S[s.type];s.type==="sampler2D"||s.type==="samplerCube"?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(s.name),this.registerInput(s.name,S.Object,!0,N.VertexAndFragment,new ti(s.name,this,0,us,"ImageSourceBlock"))):this.registerInput(s.name,o),Object.defineProperty(this,s.name,{get:function(){return this._inputs[a]},enumerable:!0,configurable:!0})}),(i=e.outParameters)==null||i.forEach((s,a)=>{this.registerOutput(s.name,S[s.type]),Object.defineProperty(this,s.name,{get:function(){return this._outputs[a]},enumerable:!0,configurable:!0}),s.type==="BasedOnInput"&&(this._outputs[a]._typeConnectionSource=this._findInputByName(s.typeFromInput)[0])}),(r=e.inLinkedConnectionTypes)==null||r.forEach(s=>{this._linkConnectionTypes(this._findInputByName(s.input1)[1],this._findInputByName(s.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}$("BABYLON.CustomBlock",gH);class EH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix),this._inputs[1].excludedConnectionPointTypes.push(S.Float),this._inputs[1].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}$("BABYLON.DotBlock",EH);class vH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});
`,this}}$("BABYLON.NormalizeBlock",vH);class SH extends ze{constructor(e){super(e,N.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",S.Color3,!0),this.registerInput("r",S.Float,!0),this.registerInput("g",S.Float,!0),this.registerInput("b",S.Float,!0),this.registerInput("a",S.Float,!0),this.registerOutput("rgba",S.Color4),this.registerOutput("rgb",S.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return e==="rgb "?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,r=this.b,s=this.a,a=this.rgbIn,o=this._outputs[0],l=this._outputs[1],c=e._getShaderType(S.Vector4),u=e._getShaderType(S.Vector3);return a.isConnected?(o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}(${a.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${a.associatedVariableName}${this._buildSwizzle(3)};
`)):(o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${u}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";
`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";
`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";
`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";
`,e}}$("BABYLON.ColorMergerBlock",SH);class TH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("xyzw",S.Vector4,!0),this.registerInput("xyz ",S.Vector3,!0),this.registerInput("xy ",S.Vector2,!0),this.registerOutput("xyz",S.Vector3),this.registerOutput("xy",S.Vector2),this.registerOutput("zw",S.Vector2),this.registerOutput("x",S.Float),this.registerOutput("y",S.Float),this.registerOutput("z",S.Float),this.registerOutput("w",S.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],a=this._outputs[3],o=this._outputs[4],l=this._outputs[5],c=this._outputs[6],u=e._getShaderType(S.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${u}(${t.associatedVariableName}, 0.0);
`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;
`),s.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(s)+` = ${this.xyzw.associatedVariableName}.zw;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.xy;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.x;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.y;
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.z;
`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${t.associatedVariableName}.w;
`),this}}$("BABYLON.VectorSplitterBlock",TH);class xH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerInput("gradient",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(S.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});
`,this}}$("BABYLON.LerpBlock",xH);class CH extends Gh{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};
`,this}}$("BABYLON.DivideBlock",CH);class AH extends Gh{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};
`,this}}$("BABYLON.SubtractBlock",AH);class IH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.Float),this.registerInput("edge",S.Float),this.registerOutput("output",S.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});
`,this}}$("BABYLON.StepBlock",IH);class lb extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};
`,this}}$("BABYLON.OneMinusBlock",lb);$("BABYLON.OppositeBlock",lb);class cb extends ze{constructor(e){super(e,N.Neutral),this.registerInput("worldPosition",S.Vector4),this.registerInput("cameraPosition",S.Vector3),this.registerOutput("output",S.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.CameraPosition&&t(r));i||(i=new _t("cameraPosition"),i.setAsSystemValue(Et.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);
`,this}}$("BABYLON.ViewDirectionBlock",cb);const yH="fresnelFunction",bH=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;V.IncludesShadersStore[yH]=bH;class RH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("worldNormal",S.Vector4),this.registerInput("viewDirection",S.Vector3),this.registerInput("bias",S.Float),this.registerInput("power",S.Float),this.registerOutput("fresnel",S.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new cb("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const t=new _t("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new _t("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});
`,this}}$("BABYLON.FresnelBlock",RH);class PH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}$("BABYLON.MaxBlock",PH);class MH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}$("BABYLON.MinBlock",MH);class DH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix),this._inputs[1].excludedConnectionPointTypes.push(S.Float),this._inputs[1].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});
`,this}}$("BABYLON.DistanceBlock",DH);class OH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.AutoDetect),this.registerOutput("output",S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});
`,this}}$("BABYLON.LengthBlock",OH);class NH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};
`,this}}$("BABYLON.NegateBlock",NH);class LH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.AutoDetect),this.registerInput("power",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(max(${this.value.associatedVariableName}, 0.), ${this.power.associatedVariableName});
`,this}}$("BABYLON.PowBlock",LH);class FH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("seed",S.AutoDetect),this.registerOutput("output",S.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector2|S.Vector3|S.Vector4|S.Color3|S.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);
`,this}}$("BABYLON.RandomNumberBlock",FH);class wH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("x",S.Float),this.registerInput("y",S.Float),this.registerOutput("output",S.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e.shaderLanguage===1?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});
`,this}}$("BABYLON.ArcTan2Block",wH);class BH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.AutoDetect),this.registerInput("edge0",S.Float),this.registerInput("edge1",S.Float),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});
`,this}}$("BABYLON.SmoothStepBlock",BH);class VH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===S.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};
`,this}}$("BABYLON.ReciprocalBlock",VH);class UH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.AutoDetect),this.registerInput("reference",S.AutoDetect),this.registerInput("distance",S.Float),this.registerInput("replacement",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(S.Float),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix),this._inputs[1].excludedConnectionPointTypes.push(S.Float),this._inputs[1].excludedConnectionPointTypes.push(S.Matrix),this._inputs[3].excludedConnectionPointTypes.push(S.Float),this._inputs[3].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {
`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};
`,e.compilationString+=`} else {
`,e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};
`,e.compilationString+=`}
`,this}}$("BABYLON.ReplaceColorBlock",UH);class kH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("value",S.AutoDetect),this.registerInput("steps",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(S.Matrix),this._inputs[1].excludedConnectionPointTypes.push(S.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(S.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});
`,this}}$("BABYLON.PosterizeBlock",kH);var mv;(function(n){n[n.SawTooth=0]="SawTooth",n[n.Square=1]="Square",n[n.Triangle=2]="Triangle"})(mv||(mv={}));class ub extends ze{constructor(e){super(e,N.Neutral),this.kind=0,this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(S.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case 0:{e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});
`;break}case 1:{e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));
`;break}case 2:{e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;
`;break}}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}I([Ne("Kind",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"SawTooth",value:0},{label:"Square",value:1},{label:"Triangle",value:2}]})],ub.prototype,"kind",void 0);$("BABYLON.WaveBlock",ub);class Vf{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class GH extends ze{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,N.Neutral),this.colorSteps=[new Vf(0,fe.Black()),new Vf(1,fe.White())],this.onValueChangedObservable=new Q,this.registerInput("gradient",S.AutoDetect),this.registerOutput("output",S.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Float|S.Vector2|S.Vector3|S.Vector4|S.Color3|S.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){const i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(S.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);
`;return}const r=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(r,S.Vector3)} = ${this._writeColorConstant(0,i)};
`,e.compilationString+=`${e._declareLocalVar(s,S.Float)};
`;let a=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==S.Float&&(a+=".x");for(let o=1;o<this.colorSteps.length;o++){const l=this.colorSteps[o],c=this.colorSteps[o-1];e.compilationString+=`${s} = clamp((${a} - ${e._emitFloat(c.step)}) / (${e._emitFloat(l.step)} -  ${e._emitFloat(c.step)}), 0.0, 1.0) * step(${e._emitFloat(o)}, ${e._emitFloat(this.colorSteps.length-1)});
`,e.compilationString+=`${r} = mix(${r}, ${this._writeColorConstant(o,i)}, ${s});
`}return e.compilationString+=e._declareOutput(t)+` = ${r};
`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const r of e.colorSteps)this.colorSteps.push(new Vf(r.step,new fe(r.color.r,r.color.g,r.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];
`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));
`;return e}}$("BABYLON.GradientBlock",GH);class zH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerInput("gradient",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(S.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));
`,this}}$("BABYLON.NLerpBlock",zH);class hb extends ze{constructor(e){super(e,N.Neutral),this.manhattanDistance=!1,this.registerInput("seed",S.Vector3),this.registerInput("jitter",S.Float),this.registerOutput("output",S.Vector2),this.registerOutput("x",S.Float),this.registerOutput("y",S.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t=`vec3 permute(vec3 x){
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);
`,t+=`}

`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){
`,t+=`    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];
`,t+=`}

`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){
`,t+=`    float K = 0.142857142857; // 1/7
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)
`,t+=`    float Kz = 0.166666666667; // 1/6
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2
`,t+=`
`,t+=`    vec3 Pi = mod(floor(P), 289.0);
`,t+=`    vec3 Pf = fract(P) - 0.5;
`,t+=`
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);
`,t+=`
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);
`,t+=`    vec3 p2 = permute(p + Pi.y);
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);
`,t+=`
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);
`,t+=`    vec3 p12 = permute(p1 + Pi.z);
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);
`,t+=`    vec3 p22 = permute(p2 + Pi.z);
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);
`,t+=`    vec3 p32 = permute(p3 + Pi.z);
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed
`,t+=`
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;
`,t+=`
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;
`,t+=`
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;
`,t+=`
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;
`,t+=`
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;
`,t+=`
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;
`,t+=`
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;
`,t+=`
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;
`,t+=`
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;
`,t+=`
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);
`,t+=`    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);
`,t+=`
`,t+=`    vec3 d1a = min(d11, d12);
`,t+=`    d12 = max(d11, d12);
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13
`,t+=`    d13 = max(d1a, d13);
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13
`,t+=`    vec3 d2a = min(d21, d22);
`,t+=`    d22 = max(d21, d22);
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23
`,t+=`    d23 = max(d2a, d23);
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23
`,t+=`    vec3 d3a = min(d31, d32);
`,t+=`    d32 = max(d31, d32);
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33
`,t+=`    d33 = max(d3a, d33);
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33
`,t+=`    vec3 da = min(d11, d21);
`,t+=`    d21 = max(d11, d21);
`,t+=`    d11 = min(da, d31); // Smallest now in d11
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31
`,t+=`    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }
`,t+=`    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21
`,t+=`    d12 = min(d12, d22); // nor in d22
`,t+=`    d12 = min(d12, d31); // nor in d31
`,t+=`    d12 = min(d12, d32); // nor in d32
`,t+=`    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz
`,t+=`    d11.y = temp2.x;
`,t+=`    d11.z = temp2.y;
`,t+=`    d11.y = min(d11.y, d12.z); // Only two more to go
`,t+=`    d11.y = min(d11.y, d11.z); // Done! (Phew!)
`,t+=`    return sqrt(d11.xy); // F1, F2
`,t+=`}

`,e.shaderLanguage===1?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,S.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};
`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}I([Ne("Use Manhattan Distance",0,"PROPERTIES",{embedded:!0,notifiers:{update:!1}})],hb.prototype,"manhattanDistance",void 0);$("BABYLON.WorleyNoise3DBlock",hb);class WH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("seed",S.Vector3),this.registerOutput("output",S.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`const float SKEWFACTOR = 1.0/3.0;
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;
`,t+=`float SimplexPerlin3D( vec3 source ){
`,t+=`    vec3 P = source;
`,t+=`    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);
`,t+=`    vec3 l = 1.0 - g;
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );
`,t+=`    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;
`,t+=`    Pt *= Pt;
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );
`,t+=`    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];
`,t+=`    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;
`,t+=`    kernel_weights = max(0.5 - kernel_weights, vec4(0.));
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;
`,t+=`}
`,e.shaderLanguage===1?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});
`,this}}$("BABYLON.SimplexPerlin3DBlock",WH);class HH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("normalMap0",S.AutoDetect),this.registerInput("normalMap1",S.AutoDetect),this.registerOutput("output",S.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Color4|S.Vector3|S.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Color4|S.Vector3|S.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],s=e._getFreeVariableName("stepR"),a=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(s,S.Float)} = step(0.5, ${i.associatedVariableName}.r);
`,e.compilationString+=`${e._declareLocalVar(a,S.Float)} = step(0.5, ${i.associatedVariableName}.g);
`,e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${s}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${s} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${a}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${a} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;
`,this}}$("BABYLON.NormalBlendBlock",HH);class XH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.Vector2),this.registerInput("angle",S.Float),this.registerOutput("output",S.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new _t("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);
`,this}}$("BABYLON.Rotate2dBlock",XH);class YH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("incident",S.AutoDetect),this.registerInput("normal",S.AutoDetect),this.registerOutput("output",S.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4|S.Color3|S.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4|S.Color3|S.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);
`,this}}$("BABYLON.ReflectBlock",YH);class $H extends ze{constructor(e){super(e,N.Neutral),this.registerInput("incident",S.AutoDetect),this.registerInput("normal",S.AutoDetect),this.registerInput("ior",S.Float),this.registerOutput("output",S.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4|S.Color3|S.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(S.Vector3|S.Vector4|S.Color3|S.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});
`,this}}$("BABYLON.RefractBlock",$H);class KH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("color",S.Color3),this.registerInput("level",S.Float),this.registerOutput("output",S.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],r=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),a=e._getFreeVariableName("colorMax"),o=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(s,S.Float)} = min(min(${r}.x, ${r}.y), ${r}.z);
`,e.compilationString+=`${e._declareLocalVar(a,S.Float)} = max(max(${r}.x, ${r}.y), ${r}.z);
`,e.compilationString+=`${e._declareLocalVar(o,S.Float)} = 0.5 * (${s} + ${a});
`,e.compilationString+=e._declareOutput(t)+` = mix(${r}, ${e._getShaderType(S.Vector3)}(${o}, ${o}, ${o}), ${this.level.associatedVariableName});
`,this}}$("BABYLON.DesaturateBlock",KH);class gl extends ze{constructor(e){super(e,N.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",S.Float,!0,N.Fragment),this.registerInput("color",S.Color3,!0,N.Fragment),this.registerInput("roughness",S.Float,!0,N.Fragment),this.registerOutput("sheen",S.Object,N.Fragment,new ti("sheen",this,1,gl,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e,t){let i="";const r=this.color.isConnected?this.color.associatedVariableName:`vec3${t.fSuffix}(1.)`,s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",a=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",o=`vec4${t.fSuffix}(0.)`,l=t.shaderLanguage===1;return i=`#ifdef SHEEN
            ${l?"var sheenOut: sheenOutParams":"sheenOutParams sheenOut"};

            ${t._declareLocalVar("vSheenColor",S.Vector4)} = vec4${t.fSuffix}(${r}, ${s});

            sheenOut = sheenBlock(
                vSheenColor
            #ifdef SHEEN_ROUGHNESS
                , ${a}
            #endif
                , roughness
            #ifdef SHEEN_TEXTURE
                , ${o}
                ${l?`, ${o}Sampler`:""}
                , 1.0
            #endif
                , reflectance
            #ifdef SHEEN_LINKWITHALBEDO
                , baseColor
                , surfaceAlbedo
            #endif
            #ifdef ENVIRONMENTBRDF
                , NdotV
                , environmentBrdf
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                , AARoughnessFactors
                , ${l?"uniforms.":""}${e==null?void 0:e._vReflectionMicrosurfaceInfosName}
                , ${e==null?void 0:e._vReflectionInfosName}
                , ${e==null?void 0:e.reflectionColor}
                , ${l?"uniforms.":""}vLightingIntensity
                #ifdef ${e==null?void 0:e._define3DName}
                    , ${e==null?void 0:e._cubeSamplerName}                                      
                    ${l?`, ${e==null?void 0:e._cubeSamplerName}Sampler`:""}
                #else
                    , ${e==null?void 0:e._2DSamplerName}
                    ${l?`, ${e==null?void 0:e._2DSamplerName}Sampler`:""}
                #endif
                , reflectionOut.reflectionCoords
                , NdotVUnclamped
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${e==null?void 0:e._define3DName}
                        , ${e==null?void 0:e._cubeSamplerName}                        
                        ${l?`, ${e==null?void 0:e._cubeSamplerName}Sampler`:""}
                        , ${e==null?void 0:e._cubeSamplerName}
                        ${l?`, ${e==null?void 0:e._cubeSamplerName}Sampler`:""}
                    #else
                        , ${e==null?void 0:e._2DSamplerName}
                        ${l?`, ${e==null?void 0:e._2DSamplerName}Sampler`:""}
                        , ${e==null?void 0:e._2DSamplerName}
                        ${l?`, ${e==null?void 0:e._2DSamplerName}Sampler`:""}
                    #endif
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)
                    , seo
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e==null?void 0:e._define3DName})
                    , eho
                #endif
            #endif
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif
`,i}_buildBlock(e){return e.target===N.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};
`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};
`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}I([Ne("Albedo scaling",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],gl.prototype,"albedoScaling",void 0);I([Ne("Link sheen with albedo",0,"PROPERTIES",{embedded:!0,notifiers:{update:!0}})],gl.prototype,"linkSheenWithAlbedo",void 0);$("BABYLON.SheenBlock",gl);class Hh extends ze{constructor(e){super(e,N.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",S.Float,!0,N.Fragment),this.registerInput("direction",S.Vector2,!0,N.Fragment),this.registerInput("uv",S.Vector2,!0),this.registerInput("worldTangent",S.Vector4,!0),this.registerInput("TBN",S.Object,!0,N.VertexAndFragment,new ti("TBN",this,0,ml,"TBNBlock")),this.registerInput("roughness",S.Float,!0,N.Fragment),this.registerOutput("anisotropy",S.Object,N.Fragment,new ti("anisotropy",this,1,Hh,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,r=this.uv,s=this.worldPositionConnectionPoint,a=this.worldNormalConnectionPoint,o=this.worldTangent,l=e.shaderLanguage===1;r.isConnected||w.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const c={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},u=this.TBN;return u.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${l?"var TBN":"mat3 TBN"} = ${u.associatedVariableName};
            #endif
            `:o.isConnected&&(t+=`${e._declareLocalVar("tbnNormal",S.Vector3)} = normalize(${a.associatedVariableName}.xyz);
`,t+=`${e._declareLocalVar("tbnTangent",S.Vector3)} = normalize(${o.associatedVariableName}.xyz);
`,t+=`${e._declareLocalVar("tbnBitangent",S.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,t+=`${l?"var vTBN":"mat3 vTBN"} = ${l?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);
`),t+=`
            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)
                ${l?"var TBN":"mat3 TBN"} = vTBN;
            #else
                ${l?"var TBN":"mat3 TBN"} = cotangent_frame(${a.associatedVariableName+".xyz"}, ${"v_"+s.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2${e.fSuffix}(1., 1.));
            #endif
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[c]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const r=e.shaderLanguage===1,s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",a=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)",o=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return i+=`${r?"var anisotropicOut: anisotropicOutParams":"anisotropicOutParams anisotropicOut"};
            anisotropicOut = anisotropicBlock(
                vec3(${a}, ${s}),
                ${o},
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW
            );
`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===N.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,S.Float)),this}}$("BABYLON.AnisotropyBlock",Hh);class El extends cc{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,w.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?N.Fragment:N.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",S.AutoDetect,!1,N.Vertex),this.registerInput("world",S.Matrix,!1,N.Vertex),this.registerInput("color",S.Color3,!0,N.Fragment),this.registerOutput("reflection",S.Object,N.Fragment,new ti("reflection",this,1,El,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("REFLECTION",s,!0),s&&(i.setValue(this._defineLODReflectionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",r.gammaSpace,!0),i.setValue("RGBDREFLECTION",r.isRGBD,!0),r&&r.coordinatesMode!==Z.SKYBOX_MODE&&r.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);const s=this._getTexture();if(!s||!r)return;s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s);const a=s.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,a,s.lodGenerationScale,s.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,a,Math.log2(a));const o=r.materialDefines,l=s.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&l)if(o.SPHERICAL_HARMONICS){const c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);const i=e.shaderLanguage===1;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,S.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",S.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",S.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",S.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                ${e._declareLocalVar(r,S.Vector3)} = (${(i?"uniforms.":"")+this._reflectionMatrixName} * vec4${e.fSuffix}(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;
                #ifdef ${this._defineOppositeZ}
                    ${r}.z *= -1.0;
                #endif
                ${i?"vertexOutputs.":""}${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${r});
            #endif
`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e);const r=e.shaderLanguage===1;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),r||(e._emitFunction("sampleReflection",`
                #ifdef ${this._define3DName}
                    #define sampleReflection(s, c) textureCube(s, c)
                #else
                    #define sampleReflection(s, c) texture2D(s, c)
                #endif
`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`
                #ifdef ${this._define3DName}
                    #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
                #else
                    #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
                #endif
`,`//${this.name}`));const s=r?`
            fn computeReflectionCoordsPBR(worldPos: vec4f, worldNormal: vec3f) -> vec3f {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`:`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,S.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,S.Vector2),i+=`#ifdef REFLECTION
            ${e._declareLocalVar(this._vReflectionInfosName,S.Vector2)} = vec2${e.fSuffix}(1., 0.);

            ${r?"var reflectionOut: reflectionOutParams":"reflectionOutParams reflectionOut"};

            reflectionOut = reflectionBlock(
                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:(r?"input.":"")+"v_"+this.worldPosition.associatedVariableName}.xyz
                , ${t}
                , alphaG
                , ${(r?"uniforms.":"")+this._vReflectionMicrosurfaceInfosName}
                , ${this._vReflectionInfosName}
                , ${this.reflectionColor}
            #ifdef ANISOTROPIC
                ,anisotropicOut
            #endif
            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})
                ,NdotVUnclamped
            #endif
            #ifdef ${this._defineLinearSpecularReflection}
                , roughness
            #endif
            #ifdef ${this._define3DName}
                , ${this._cubeSamplerName}
                ${r?`, ${this._cubeSamplerName}Sampler`:""}
            #else
                , ${this._2DSamplerName}
                ${r?`, ${this._2DSamplerName}Sampler`:""}
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                , ${r?"input.":""}${this._vEnvironmentIrradianceName}
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    , ${this._reflectionMatrixName}
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                , irradianceSampler         // ** not handled **
                ${r?", irradianceSamplerSampler":""}
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef ${this._define3DName}
                    , ${this._cubeSamplerName}
                    ${r?`, ${this._cubeSamplerName}Sampler`:""}
                    , ${this._cubeSamplerName}
                    ${r?`, ${this._cubeSamplerName}Sampler`:""}
                #else
                    , ${this._2DSamplerName}
                    ${r?`, ${this._2DSamplerName}Sampler`:""}
                    , ${this._2DSamplerName}                    
                    ${r?`, ${this._2DSamplerName}Sampler`:""}
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                , ${this._vReflectionFilteringInfoName}
            #endif
            );
        #endif
`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==N.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};
`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};
`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};
`,e}serialize(){var t;const e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=((t=this.texture)==null?void 0:t.gammaSpace)??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}I([Ne("Spherical Harmonics",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],El.prototype,"useSphericalHarmonics",void 0);I([Ne("Force irradiance in fragment",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],El.prototype,"forceIrradianceInFragment",void 0);$("BABYLON.ReflectionBlock",El);class al extends ze{constructor(e){super(e,N.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",S.Float,!1,N.Fragment),this.registerInput("roughness",S.Float,!0,N.Fragment),this.registerInput("indexOfRefraction",S.Float,!0,N.Fragment),this.registerInput("normalMapColor",S.Color3,!0,N.Fragment),this.registerInput("uv",S.Vector2,!0,N.Fragment),this.registerInput("tintColor",S.Color3,!0,N.Fragment),this.registerInput("tintAtDistance",S.Float,!0,N.Fragment),this.registerInput("tintThickness",S.Float,!0,N.Fragment),this.registerInput("worldTangent",S.Vector4,!0),this.registerInput("worldNormal",S.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(S.Color4|S.Vector4|S.Vector3),this.registerInput("TBN",S.Object,!0,N.VertexAndFragment,new ti("TBN",this,0,ml,"TBNBlock")),this.registerOutput("clearcoat",S.Object,N.Fragment,new ti("clearcoat",this,1,al,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new _t("ClearCoat intensity",N.Fragment,S.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===rr._DefaultIndexOfRefraction:!0,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var h;super.bind(e,t,i);const r=((h=this.indexOfRefraction.connectInputBlock)==null?void 0:h.value)??rr._DefaultIndexOfRefraction,s=1-r,a=1+r,o=Math.pow(-s/a,2),l=1/r;e.setFloat4("vClearCoatRefractionParams",o,l,s,a);const c=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,u=c!=null&&c.perturbedNormal.isConnected?c.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",u!=null&&u.invertX?1:-1,u!=null&&u.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",u!=null&&u.invertX?-1:1,u!=null&&u.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let r="";const s=`//${this.name}`,a=this.worldTangent,o=e.shaderLanguage===1;o||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
                ${o?"var TBN":"mat3 TBN"} = ${c.associatedVariableName};
            #endif
            `:a.isConnected&&(r+=`${e._declareLocalVar("tbnNormal",S.Vector3)} = normalize(${i}.xyz);
`,r+=`${e._declareLocalVar("tbnTangent",S.Vector3)} = normalize(${a.associatedVariableName}.xyz);
`,r+=`${e._declareLocalVar("tbnBitangent",S.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,r+=`${o?"var vTBN":"mat3 vTBN"} = ${o?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",s,{replaceStrings:[l]}),r}static GetCode(e,t,i,r,s,a,o){let l="";const c=t!=null&&t.intensity.isConnected?t.intensity.associatedVariableName:"1.",u=t!=null&&t.roughness.isConnected?t.roughness.associatedVariableName:"0.",h=t!=null&&t.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:`vec3${e.fSuffix}(0.)`,f=t!=null&&t.uv.isConnected?t.uv.associatedVariableName:`vec2${e.fSuffix}(0.)`,d=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:`vec3${e.fSuffix}(1.)`,p=t!=null&&t.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",_=t!=null&&t.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",g=`vec4${e.fSuffix}(0.)`;if(t){e._emitUniformFromString("vClearCoatRefractionParams",S.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",S.Vector2);const v=t.worldNormal;l+=`${e._declareLocalVar("vGeometricNormaClearCoatW",S.Vector3)} = ${v.isConnected?"normalize("+v.associatedVariableName+".xyz)":"geometricNormalW"};
`}else l+=`${e._declareLocalVar("vGeometricNormaClearCoatW",S.Vector3)} = geometricNormalW;
`;s&&t&&(l+=t._generateTBNSpace(e,r,o),a=t.worldTangent.isConnected);const E=e.shaderLanguage===1;return l+=`${E?"var clearcoatOut: clearcoatOutParams":"clearcoatOutParams clearcoatOut"};

        #ifdef CLEARCOAT
            ${e._declareLocalVar("vClearCoatParams",S.Vector2)} = vec2${e.fSuffix}(${c}, ${u});
            ${e._declareLocalVar("vClearCoatTintParams",S.Vector4)} = vec4${e.fSuffix}(${d}, ${p});

            clearcoatOut = clearcoatBlock(
                ${r}.xyz
                , vGeometricNormaClearCoatW
                , viewDirectionW
                , vClearCoatParams
                , specularEnvironmentR0
            #ifdef CLEARCOAT_TEXTURE
                , vec2${e.fSuffix}(0.)
            #endif
            #ifdef CLEARCOAT_TINT
                , vClearCoatTintParams
                , ${_}
                , ${E?"uniforms.":""}vClearCoatRefractionParams
                #ifdef CLEARCOAT_TINT_TEXTURE
                    , ${g}
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                , vec2${e.fSuffix}(0., 1.)
                , vec4${e.fSuffix}(${h}, 0.)
                , ${f}
                #if defined(${a?"TANGENT":"IGNORE"}) && defined(NORMAL)
                    , vTBN
                #else
                    , ${E?"uniforms.":""}vClearCoatTangentSpaceParams
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    , normalMatrix
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                , faceNormal
            #endif
            #ifdef REFLECTION
                , ${E?"uniforms.":""}${i==null?void 0:i._vReflectionMicrosurfaceInfosName}
                , ${i==null?void 0:i._vReflectionInfosName}
                , ${i==null?void 0:i.reflectionColor}
                , ${E?"uniforms.":""}vLightingIntensity
                #ifdef ${i==null?void 0:i._define3DName}
                    , ${i==null?void 0:i._cubeSamplerName}       
                    ${E?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                #else
                    , ${i==null?void 0:i._2DSamplerName}       
                    ${E?`, ${i==null?void 0:i._2DSamplerName}Sampler`:""}
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${i==null?void 0:i._define3DName}
                        , ${i==null?void 0:i._cubeSamplerName}       
                        ${E?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                        , ${i==null?void 0:i._cubeSamplerName}
                        ${E?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                    #else
                        , ${i==null?void 0:i._2DSamplerName}
                        ${E?`, ${i==null?void 0:i._2DSamplerName}Sampler`:""}
                        , ${i==null?void 0:i._2DSamplerName}
                        ${E?`, ${i==null?void 0:i._2DSamplerName}Sampler`:""}                        
                    #endif
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                , (${e._generateTernary("1.","-1.",E?"fragmentInputs.frontFacing":"gl_FrontFacing")})
            #endif
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif
`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===N.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,S.Float)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};
`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}}I([Ne("Remap F0 on interface change",0,"ADVANCED",{embedded:!0})],al.prototype,"remapF0OnInterfaceChange",void 0);$("BABYLON.ClearCoatBlock",al);class uc extends ze{constructor(e){super(e,N.Fragment),this._isUnique=!0,this.registerInput("intensity",S.Float,!0,N.Fragment),this.registerInput("indexOfRefraction",S.Float,!0,N.Fragment),this.registerInput("thickness",S.Float,!0,N.Fragment),this.registerOutput("iridescence",S.Object,N.Fragment,new ti("iridescence",this,1,uc,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new _t("Iridescence intensity",N.Fragment,S.Float);e.value=1,e.output.connectTo(this.intensity);const t=new _t("Iridescence ior",N.Fragment,S.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new _t("Iridescence thickness",N.Fragment,S.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e,t){let i="";const r=e!=null&&e.intensity.isConnected?e.intensity.associatedVariableName:"1.",s=e!=null&&e.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:Lr._DefaultIndexOfRefraction,a=e!=null&&e.thickness.isConnected?e.thickness.associatedVariableName:Lr._DefaultMaximumThickness,o=t.shaderLanguage===1;return i+=`${o?"var iridescenceOut: iridescenceOutParams":"iridescenceOutParams iridescenceOut"};

        #ifdef IRIDESCENCE
            iridescenceOut = iridescenceBlock(
                vec4(${r}, ${s}, 1., ${a})
                , NdotV
                , specularEnvironmentR0
                #ifdef CLEARCOAT
                    , NdotVUnclamped
                #endif                
            );

            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif
`,i}_buildBlock(e){return e.target===N.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}$("BABYLON.IridescenceBlock",uc);class fo extends ze{constructor(e){super(e,N.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",S.Float,!1,N.Fragment),this.registerInput("tintAtDistance",S.Float,!0,N.Fragment),this.registerInput("volumeIndexOfRefraction",S.Float,!0,N.Fragment),this.registerOutput("refraction",S.Object,N.Fragment,new ti("refraction",this,1,fo,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){const i=new _t("Refraction intensity",N.Fragment,S.Float);i.value=1,i.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.View&&t(r));i||(i=new _t("view"),i.setAsSystemValue(Et.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("SS_REFRACTION",s,!0),s&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLODRefractionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&r.isCube?!r.invertZ:r.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",r.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",r.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!r.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var l,c;super.bind(e,t,i);const r=this._getTexture();if(!r)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),e.setMatrix(this._refractionMatrixName,r.getRefractionTextureMatrix());let s=1;r.isCube||r.depth&&(s=r.depth);const a=((l=this.volumeIndexOfRefraction.connectInputBlock)==null?void 0:l.value)??((c=this.indexOfRefractionConnectionPoint.connectInputBlock)==null?void 0:c.value)??1.5;e.setFloat4(this._vRefractionInfosName,r.level,1/a,s,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset,1/a);const o=r.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,o,Math.log2(o)),r.boundingBoxSize){const u=r;e.setVector3("vRefractionPosition",u.boundingBoxPosition),e.setVector3("vRefractionSize",u.boundingBoxSize)}}getCode(e){const t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),this._getTexture()&&(e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,void 0,!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,void 0,!0),e._samplerDeclaration+=`#endif
`),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,S.Matrix),e.shaderLanguage!==1&&(e._emitFunction("sampleRefraction",`
                #ifdef ${this._define3DName}
                    #define sampleRefraction(s, c) textureCube(s, c)
                #else
                    #define sampleRefraction(s, c) texture2D(s, c)
                #endif
`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`
                #ifdef ${this._define3DName}
                    #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
                #else
                    #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
                #endif
`,`//${this.name}`)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,S.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,S.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,S.Vector2),e._emitUniformFromString("vRefractionPosition",S.Vector3),e._emitUniformFromString("vRefractionSize",S.Vector3),t}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(this.texture.isCube?e=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");
`:e=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};
`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};
`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=ir.Parse(e.texture,t,i):this.texture=Z.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}I([Ne("Link refraction to transparency",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],fo.prototype,"linkRefractionWithTransparency",void 0);I([Ne("Invert refraction Y",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],fo.prototype,"invertRefractionY",void 0);I([Ne("Use thickness as depth",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],fo.prototype,"useThicknessAsDepth",void 0);$("BABYLON.RefractionBlock",fo);class hc extends ze{constructor(e){super(e,N.Fragment),this._isUnique=!0,this.registerInput("thickness",S.Float,!1,N.Fragment),this.registerInput("tintColor",S.Color3,!0,N.Fragment),this.registerInput("translucencyIntensity",S.Float,!0,N.Fragment),this.registerInput("translucencyDiffusionDist",S.Color3,!0,N.Fragment),this.registerInput("refraction",S.Object,!0,N.Fragment,new ti("refraction",this,0,fo,"RefractionBlock")),this.registerInput("dispersion",S.Float,!0,N.Fragment),this.registerOutput("subsurface",S.Object,N.Fragment,new ti("subsurface",this,1,hc,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new _t("SubSurface thickness",N.Fragment,S.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const r=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",r||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",r,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,r){var g;let s="";const a=t!=null&&t.thickness.isConnected?t.thickness.associatedVariableName:"0.",o=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",l=t!=null&&t.translucencyIntensity.isConnected?t==null?void 0:t.translucencyIntensity.associatedVariableName:"1.",c=t!=null&&t.translucencyDiffusionDist.isConnected?t==null?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",u=t!=null&&t.refraction.isConnected?(g=t==null?void 0:t.refraction.connectedPoint)==null?void 0:g.ownerBlock:null,h=u!=null&&u.tintAtDistance.isConnected?u.tintAtDistance.associatedVariableName:"1.",f=u!=null&&u.intensity.isConnected?u.intensity.associatedVariableName:"1.",d=u!=null&&u.view.isConnected?u.view.associatedVariableName:"",p=t!=null&&t.dispersion.isConnected?t==null?void 0:t.dispersion.associatedVariableName:"0.0",_=e.shaderLanguage===1;return s+=(u==null?void 0:u.getCode(e))??"",s+=`${_?"var subSurfaceOut: subSurfaceOutParams":"subSurfaceOutParams subSurfaceOut"};

        #ifdef SUBSURFACE
            ${e._declareLocalVar("vThicknessParam",S.Vector2)} = vec2${e.fSuffix}(0., ${a});
            ${e._declareLocalVar("vTintColor",S.Vector4)} = vec4${e.fSuffix}(${o}, ${h});
            ${e._declareLocalVar("vSubSurfaceIntensity",S.Vector3)} = vec3(${f}, ${l}, 0.);
            ${e._declareLocalVar("dispersion",S.Float)} = ${p};
            subSurfaceOut = subSurfaceBlock(
                vSubSurfaceIntensity
                , vThicknessParam
                , vTintColor
                , normalW
                , specularEnvironmentReflectance
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                , vec4${e.fSuffix}(0.)
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    , ${(_?"uniforms.":"")+(i==null?void 0:i._reflectionMatrixName)}
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            , reflectionOut.irradianceVector
                        #endif
                        #if defined(REALTIME_FILTERING)
                            , ${i==null?void 0:i._cubeSamplerName}
                            ${_?`, ${i==null?void 0:i._cubeSamplerName}Sampler`:""}
                            , ${i==null?void 0:i._vReflectionFilteringInfoName}
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        , irradianceSampler
                        ${_?", irradianceSamplerSampler":""}
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                , surfaceAlbedo
            #endif
            #ifdef SS_REFRACTION
                , ${r}.xyz
                , viewDirectionW
                , ${d}
                , ${(_?"uniforms.":"")+(u==null?void 0:u._vRefractionInfosName)}
                , ${(_?"uniforms.":"")+(u==null?void 0:u._refractionMatrixName)}
                , ${(_?"uniforms.":"")+(u==null?void 0:u._vRefractionMicrosurfaceInfosName)}
                , ${_?"uniforms.":""}vLightingIntensity
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    , alpha
                #endif
                #ifdef ${(u==null?void 0:u._defineLODRefractionAlpha)??"IGNORE"}
                    , NdotVUnclamped
                #endif
                #ifdef ${(u==null?void 0:u._defineLinearSpecularRefraction)??"IGNORE"}
                    , roughness
                #endif
                , alphaG
                #ifdef ${(u==null?void 0:u._define3DName)??"IGNORE"}
                    , ${(u==null?void 0:u._cubeSamplerName)??""}
                    ${_?`, ${u==null?void 0:u._cubeSamplerName}Sampler`:""}
                #else
                    , ${(u==null?void 0:u._2DSamplerName)??""}
                    ${_?`, ${u==null?void 0:u._2DSamplerName}Sampler`:""}
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${(u==null?void 0:u._define3DName)??"IGNORE"}
                        , ${(u==null?void 0:u._cubeSamplerName)??""}                        
                        ${_?`, ${u==null?void 0:u._cubeSamplerName}Sampler`:""}
                        , ${(u==null?void 0:u._cubeSamplerName)??""}                        
                        ${_?`, ${u==null?void 0:u._cubeSamplerName}Sampler`:""}
                    #else
                        , ${(u==null?void 0:u._2DSamplerName)??""}
                        ${_?`, ${u==null?void 0:u._2DSamplerName}Sampler`:""}
                        , ${(u==null?void 0:u._2DSamplerName)??""}
                        ${_?`, ${u==null?void 0:u._2DSamplerName}Sampler`:""}
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    , anisotropicOut
                #endif
                #ifdef REALTIME_FILTERING
                    , ${(u==null?void 0:u._vRefractionFilteringInfoName)??""}
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    , vRefractionPosition
                    , vRefractionSize
                #endif
                #ifdef SS_DISPERSION
                    , dispersion
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                , ${c}
                , vTintColor
                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
                    , vec4${e.fSuffix}(0.)
                #endif
            #endif                
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif
`,s}_buildBlock(e){return e.target===N.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}$("BABYLON.SubSurfaceBlock",hc);const jH={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class Zi extends ze{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,w.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?N.Fragment:N.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?N.Fragment:N.Vertex}constructor(e){super(e,N.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=fe.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",S.Vector4,!1,N.Vertex),this.registerInput("worldNormal",S.Vector4,!1,N.Vertex),this.registerInput("view",S.Matrix,!1),this.registerInput("cameraPosition",S.Vector3,!1,N.Fragment),this.registerInput("perturbedNormal",S.Vector4,!0,N.Fragment),this.registerInput("baseColor",S.Color3,!0,N.Fragment),this.registerInput("metallic",S.Float,!1,N.Fragment),this.registerInput("roughness",S.Float,!1,N.Fragment),this.registerInput("ambientOcc",S.Float,!0,N.Fragment),this.registerInput("opacity",S.Float,!0,N.Fragment),this.registerInput("indexOfRefraction",S.Float,!0,N.Fragment),this.registerInput("ambientColor",S.Color3,!0,N.Fragment),this.registerInput("reflection",S.Object,!0,N.Fragment,new ti("reflection",this,0,El,"ReflectionBlock")),this.registerInput("clearcoat",S.Object,!0,N.Fragment,new ti("clearcoat",this,0,al,"ClearCoatBlock")),this.registerInput("sheen",S.Object,!0,N.Fragment,new ti("sheen",this,0,gl,"SheenBlock")),this.registerInput("subsurface",S.Object,!0,N.Fragment,new ti("subsurface",this,0,hc,"SubSurfaceBlock")),this.registerInput("anisotropy",S.Object,!0,N.Fragment,new ti("anisotropy",this,0,Hh,"AnisotropyBlock")),this.registerInput("iridescence",S.Object,!0,N.Fragment,new ti("iridescence",this,0,uc,"IridescenceBlock")),this.registerOutput("ambientClr",S.Color3,N.Fragment),this.registerOutput("diffuseDir",S.Color3,N.Fragment),this.registerOutput("specularDir",S.Color3,N.Fragment),this.registerOutput("clearcoatDir",S.Color3,N.Fragment),this.registerOutput("sheenDir",S.Color3,N.Fragment),this.registerOutput("diffuseInd",S.Color3,N.Fragment),this.registerOutput("specularInd",S.Color3,N.Fragment),this.registerOutput("clearcoatInd",S.Color3,N.Fragment),this.registerOutput("sheenInd",S.Color3,N.Fragment),this.registerOutput("refraction",S.Color3,N.Fragment),this.registerOutput("lighting",S.Color3,N.Fragment),this.registerOutput("shadow",S.Float,N.Fragment),this.registerOutput("alpha",S.Float,N.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,e===1?await Promise.all([re(()=>Promise.resolve().then(()=>dy),void 0),re(()=>Promise.resolve().then(()=>xy),void 0)]):await Promise.all([re(()=>Promise.resolve().then(()=>Iy),void 0),re(()=>Promise.resolve().then(()=>Ly),void 0)]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.CameraPosition&&t(r));i||(i=new _t("cameraPosition"),i.setAsSystemValue(Et.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===Et.View&&t(r));i||(i=new _t("view"),i.setAsSystemValue(Et.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===wt.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===wt.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const r=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",r.indexOf(".")<0?r+".":r,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const s=e.getScene();if(s.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&_e.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),!!i._areLightsDirty)if(!this.light)Ac(s,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,ph(s,i);else{const o={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};Dp(s,e,this.light,this._lightId,i,!0,o),o.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){const a=e.uniforms.indexOf("vLightData"+s)>=0;Np(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,a)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var h;if(!i)return;const r=i.getScene();this.light?Rp(this.light,this._lightId,r,e,!0):Cc(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const s=this._scene.ambientColor;s&&e.setColor3("ambientFromScene",s);const a=r.useRightHandedSystem===(r._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,a?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const o=1,l=((h=this.indexOfRefraction.connectInputBlock)==null?void 0:h.value)??1.5,c=Math.pow((l-o)/(l+o),2);this._metallicReflectanceColor.scaleToRef(c*this._metallicF0Factor,Ot.Color3[0]);const u=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,Ot.Color3[0],u),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var c;const t=this.worldPosition,i=this.worldNormal,r=`//${this.name}`,s=e.shaderLanguage===1;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const a="v_"+t.associatedVariableName;e._emitVaryingFromString(a,S.Vector4)&&(e.compilationString+=(s?"vertexOutputs.":"")+`${a} = ${t.associatedVariableName};
`);const o="v_"+i.associatedVariableName;e._emitVaryingFromString(o,S.Vector4)&&(e.compilationString+=(s?"vertexOutputs.":"")+`${o} = ${i.associatedVariableName};
`);const l=this.reflection.isConnected?(c=this.reflection.connectedPoint)==null?void 0:c.ownerBlock:null;l&&(l.viewConnectionPoint=this.view),e.compilationString+=(l==null?void 0:l.handleVertexSide(e))??"",e._emitVaryingFromString("vClipSpacePosition",S.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0
`,e._injectAtEnd+=(s?"vertexOutputs.":"")+`vClipSpacePosition = ${s?"vertexOutputs.position":"gl_Position"};
`,e._injectAtEnd+=`#endif
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",S.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",S.Matrix)} = ${this.view.associatedVariableName};
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(e){let i=e.shaderLanguage===1?`var albedoOpacityOut: albedoOpacityOutParams;
`:`albedoOpacityOutParams albedoOpacityOut;
`;const r=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",s=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return i+=`albedoOpacityOut = albedoOpacityBlock(
                vec4${e.fSuffix}(${r}, 1.)
            #ifdef ALBEDO
                ,vec4${e.fSuffix}(1.)
                ,vec2${e.fSuffix}(1., 1.)
            #endif
            #ifdef OPACITY
                ,vec4${e.fSuffix}(${s})
                ,vec2${e.fSuffix}(1., 1.)
            #endif                
            );

            ${e._declareLocalVar("surfaceAlbedo",S.Vector3)} = albedoOpacityOut.surfaceAlbedo;
            ${e._declareLocalVar("alpha",S.Float)} = albedoOpacityOut.alpha;
`,i}_getAmbientOcclusionCode(e){let i=e.shaderLanguage===1?`var aoOut: ambientOcclusionOutParams;
`:`ambientOcclusionOutParams aoOut;
`;const r=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return i+=`aoOut = ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3${e.fSuffix}(${r}),
                vec4${e.fSuffix}(0., 1.0, 1.0, 0.)
            #endif
            );
`,i}_getReflectivityCode(e){const t=e.shaderLanguage===1;let i=t?`var reflectivityOut: reflectivityOutParams;
`:`reflectivityOutParams reflectivityOut;
`;const r="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,S.Vector4),i+=`${e._declareLocalVar("baseColor",S.Vector3)} = surfaceAlbedo;

            reflectivityOut = reflectivityBlock(
                vec4${e.fSuffix}(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.)
            #ifdef METALLICWORKFLOW
                , surfaceAlbedo
                , ${(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}
            #endif
            #ifdef REFLECTIVITY
                , vec3${e.fSuffix}(0., 0., ${r})
                , vec4${e.fSuffix}(1.)
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                , aoOut.ambientOcclusionColor
            #endif
            #ifdef MICROSURFACEMAP
                , microSurfaceTexel <== not handled!
            #endif
            );

            ${e._declareLocalVar("microSurface",S.Float)} = reflectivityOut.microSurface;
            ${e._declareLocalVar("roughness",S.Float)} = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif
`,i}_buildBlock(e){var C,y,P,D,F,W,H,ue,ae,le,oe;super._buildBlock(e),this._scene=e.sharedData.scene;const t=e.shaderLanguage===1;this._environmentBRDFTexture||(this._environmentBRDFTexture=o_(this._scene));const i=this.reflection.isConnected?(C=this.reflection.connectedPoint)==null?void 0:C.ownerBlock:null;if(i&&(i.worldPositionConnectionPoint=this.worldPosition,i.cameraPositionConnectionPoint=this.cameraPosition,i.worldNormalConnectionPoint=this.worldNormal,i.viewConnectionPoint=this.view),e.target!==N.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const r=`//${this.name}`,s=this.perturbedNormal;let a=this.worldPosition.associatedVariableName,o=this.worldNormal.associatedVariableName;this.generateOnlyFragmentCode?(a=e._getFreeVariableName("globalWorldPos"),e.compilationString+=`${a} = ${this.worldPosition.associatedVariableName}.xyz;
`,o=e._getFreeVariableName("globalWorldNormal"),e.compilationString+=`${o} = ${this.worldNormal.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+=`#if DEBUGMODE > 0
`,e.compilationString+=`${e._declareLocalVar("vClipSpacePosition",S.Vector4)} = vec4${e.fSuffix}((vec2${e.fSuffix}(${t?"fragmentInputs.position":"gl_FragCoord.xy"}) / vec2${e.fSuffix}(1.0)) * 2.0 - 1.0, 0.0, 1.0);
`,e.compilationString+=`#endif
`):(a=(t?"input.":"")+"v_"+a,o=(t?"input.":"")+"v_"+o),this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",S.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",S.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("importanceSampling",r),e._emitFunctionFromInclude("pbrHelperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),e._emitFunctionFromInclude("shadowsFragmentFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",r),e._emitFunctionFromInclude("pbrBRDFFunctions",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFunctions",r),e._emitFunctionFromInclude("pbrIBLFunctions",r),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",r),e._emitFunctionFromInclude("pbrBlockReflectivity",r),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",r),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",r),e._emitFunctionFromInclude("pbrBlockAnisotropic",r),e._emitUniformFromString("vLightingIntensity",S.Vector4),i!=null&&i.generateOnlyFragmentCode&&(e.compilationString+=i.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`${e._declareLocalVar(this._vNormalWName,S.Vector4)} = normalize(${o});
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",S.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${a}.xyz);
`),e.compilationString+=`${e._declareLocalVar("geometricNormalW",S.Vector3)} = ${this._vNormalWName}.xyz;
`,e.compilationString+=`${e._declareLocalVar("normalW",S.Vector3)} = ${s.isConnected?"normalize("+s.associatedVariableName+".xyz)":"geometricNormalW"};
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,S.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",r,{replaceStrings:[{search:/vPositionW/g,replace:a+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(e),e.compilationString+=e._emitCodeFromInclude("depthPrePass",r),e.compilationString+=this._getAmbientOcclusionCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",r),e.compilationString+=`#ifdef UNLIT
                ${e._declareLocalVar("diffuseBase",S.Vector3)} = vec3${e.fSuffix}(1., 1., 1.);
            #else
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"}]});const l=this.anisotropy.isConnected?(y=this.anisotropy.connectedPoint)==null?void 0:y.ownerBlock:null;l&&(l.worldPositionConnectionPoint=this.worldPosition,l.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=l.getCode(e,!this.perturbedNormal.isConnected)),i&&i.hasTexture&&(e.compilationString+=i.getCode(e,l?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(i==null?void 0:i._defineOppositeZ)??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(i==null?void 0:i._defineProjectionName)??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(i==null?void 0:i._defineLODReflectionAlpha)??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(i==null?void 0:i._defineLinearSpecularReflection)??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(i==null?void 0:i._vReflectionFilteringInfoName)??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",r,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}]});const c=this.sheen.isConnected?(P=this.sheen.connectedPoint)==null?void 0:P.ownerBlock:null;c&&(e.compilationString+=c.getCode(i,e)),e._emitFunctionFromInclude("pbrBlockSheen",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(i==null?void 0:i._defineLODReflectionAlpha)??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(i==null?void 0:i._defineLinearSpecularReflection)??"LINEARSPECULARREFLECTION"}]});const u=this.iridescence.isConnected?(D=this.iridescence.connectedPoint)==null?void 0:D.ownerBlock:null;e.compilationString+=uc.GetCode(u,e),e._emitFunctionFromInclude("pbrBlockIridescence",r,{replaceStrings:[]});const h=this.clearcoat.isConnected?(F=this.clearcoat.connectedPoint)==null?void 0:F.ownerBlock:null,f=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,d=this.perturbedNormal.isConnected&&((H=((W=this.perturbedNormal.connectedPoint)==null?void 0:W.ownerBlock).worldTangent)==null?void 0:H.isConnected),p=this.anisotropy.isConnected&&((ue=this.anisotropy.connectedPoint)==null?void 0:ue.ownerBlock).worldTangent.isConnected;let _=d||!this.perturbedNormal.isConnected&&p;e.compilationString+=al.GetCode(e,h,i,a,f,_,o),f&&(_=(h==null?void 0:h.worldTangent.isConnected)??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(i==null?void 0:i._defineOppositeZ)??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(i==null?void 0:i._defineProjectionName)??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(i==null?void 0:i._defineLODReflectionAlpha)??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(i==null?void 0:i._defineLinearSpecularReflection)??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:_?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i==null?void 0:i._defineSkyboxName)??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"}]});const g=this.subsurface.isConnected?(ae=this.subsurface.connectedPoint)==null?void 0:ae.ownerBlock:null,E=this.subsurface.isConnected?(oe=((le=this.subsurface.connectedPoint)==null?void 0:le.ownerBlock).refraction.connectedPoint)==null?void 0:oe.ownerBlock:null;E&&(E.viewConnectionPoint=this.view,E.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=hc.GetCode(e,g,i,a),e._emitFunctionFromInclude("pbrBlockSubSurface",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(i==null?void 0:i._define3DName)??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(i==null?void 0:i._defineOppositeZ)??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(i==null?void 0:i._defineProjectionName)??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(E==null?void 0:E._define3DName)??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(E==null?void 0:E._defineLODRefractionAlpha)??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(E==null?void 0:E._defineLinearSpecularRefraction)??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(E==null?void 0:E._defineOppositeZ)??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",r),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:new RegExp(`${t?"fragmentInputs.":""}vPositionW`,"g"),replace:a+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`${t?"fragmentInputs.":""}vPositionW,${a}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",r),e.compilationString+=`#endif
`;const v=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:`vec3${e.fSuffix}(0., 0., 0.)`;let x=wt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();x.indexOf(".")===-1&&(x+=".");let A=[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:new RegExp(`${t?"uniforms.":""}vAmbientColor`,"g"),replace:v+` * ${t?"uniforms.":""}ambientFromScene`},{search:new RegExp(`${t?"uniforms.":""}vAmbientInfos.w`,"g"),replace:x}];t&&(A[0]={search:/var finalEmissive[\s\S]*?finalEmissive\*=uniforms.vLightingIntensity\.y;/g,replace:""}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",r,{replaceStrings:A}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",r,{replaceStrings:[{search:/finalEmissive/g,replace:`vec3${e.fSuffix}(0.)`}]}),t?A=[{search:/mesh.visibility/g,replace:"1."}]:A=[{search:/visibility/g,replace:"1."}],e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",r,{replaceStrings:A});const T=t?"fragmentOutputs.color":"gl_FragColor";A=[{search:new RegExp(`${t?"fragmentInputs.":""}vNormalW`,"g"),replace:this._vNormalWName},{search:new RegExp(`${t?"fragmentInputs.":""}vPositionW`,"g"),replace:a},{search:/albedoTexture\.rgb;/g,replace:`vec3${e.fSuffix}(1.);
${T}.rgb = toGammaSpace(${T}.rgb);
`}],e.compilationString+=e._emitCodeFromInclude("pbrDebug",r,{replaceStrings:A});for(const ge of this._outputs)if(ge.hasEndpoints){const Ee=jH[ge.name];if(Ee){const[ne,j]=Ee;j&&(e.compilationString+=`#if ${j}
`),e.compilationString+=`${e._declareOutput(ge)} = ${ne};
`,j&&(e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(ge)} = vec3${e.fSuffix}(0.);
`,e.compilationString+=`#endif
`)}else w.Error(`There's no remapping for the ${ge.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};
`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};
`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};
`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};
`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};
`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};
`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};
`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};
`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};
`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};
`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};
`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};
`,e+=`${this._codeVariableName}.unlit = ${this.unlit};
`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};
`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};
`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};
`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};
`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}I([Ne("Direct lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Zi.prototype,"directIntensity",void 0);I([Ne("Environment lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Zi.prototype,"environmentIntensity",void 0);I([Ne("Specular highlights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Zi.prototype,"specularIntensity",void 0);I([Ne("Light falloff",4,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:wt.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:wt.LIGHTFALLOFF_GLTF},{label:"Standard",value:wt.LIGHTFALLOFF_STANDARD}]})],Zi.prototype,"lightFalloff",void 0);I([Ne("Alpha Testing",0,"OPACITY")],Zi.prototype,"useAlphaTest",void 0);I([Ne("Alpha CutOff",1,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],Zi.prototype,"alphaTestCutoff",void 0);I([Ne("Alpha blending",0,"OPACITY")],Zi.prototype,"useAlphaBlending",void 0);I([Ne("Radiance over alpha",0,"RENDERING",{notifiers:{update:!0}})],Zi.prototype,"useRadianceOverAlpha",void 0);I([Ne("Specular over alpha",0,"RENDERING",{notifiers:{update:!0}})],Zi.prototype,"useSpecularOverAlpha",void 0);I([Ne("Specular anti-aliasing",0,"RENDERING",{notifiers:{update:!0}})],Zi.prototype,"enableSpecularAntiAliasing",void 0);I([Ne("Realtime filtering",0,"RENDERING",{notifiers:{update:!0}})],Zi.prototype,"realTimeFiltering",void 0);I([Ne("Realtime filtering quality",4,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],Zi.prototype,"realTimeFilteringQuality",void 0);I([Ne("Energy Conservation",0,"ADVANCED",{notifiers:{update:!0}})],Zi.prototype,"useEnergyConservation",void 0);I([Ne("Radiance occlusion",0,"ADVANCED",{notifiers:{update:!0}})],Zi.prototype,"useRadianceOcclusion",void 0);I([Ne("Horizon occlusion",0,"ADVANCED",{notifiers:{update:!0}})],Zi.prototype,"useHorizonOcclusion",void 0);I([Ne("Unlit",0,"ADVANCED",{notifiers:{update:!0}})],Zi.prototype,"unlit",void 0);I([Ne("Force normal forward",0,"ADVANCED",{notifiers:{update:!0}})],Zi.prototype,"forceNormalForward",void 0);I([Ne("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Zi._OnGenerateOnlyFragmentCodeChanged}})],Zi.prototype,"generateOnlyFragmentCode",void 0);I([Ne("Debug mode",4,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],Zi.prototype,"debugMode",void 0);I([Ne("Split position",1,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],Zi.prototype,"debugLimit",void 0);I([Ne("Output factor",1,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],Zi.prototype,"debugFactor",void 0);$("BABYLON.PBRMetallicRoughnessBlock",Zi);class qH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("left",S.AutoDetect),this.registerInput("right",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(S.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.shaderLanguage===0?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});
`,this}}$("BABYLON.ModBlock",qH);class ZH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("row0",S.Vector4),this.registerInput("row1",S.Vector4),this.registerInput("row2",S.Vector4),this.registerInput("row3",S.Vector4),this.registerOutput("output",S.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new _t("row0");e.value=new We(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new _t("row1");e.value=new We(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new _t("row2");e.value=new We(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new _t("row3");e.value=new We(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,r=this.row1,s=this.row2,a=this.row3,o=e.shaderLanguage===1?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${o}(${i.associatedVariableName}, ${r.associatedVariableName}, ${s.associatedVariableName}, ${a.associatedVariableName});
`,this}}$("BABYLON.MatrixBuilder",ZH);var er;(function(n){n[n.Equal=0]="Equal",n[n.NotEqual=1]="NotEqual",n[n.LessThan=2]="LessThan",n[n.GreaterThan=3]="GreaterThan",n[n.LessOrEqual=4]="LessOrEqual",n[n.GreaterOrEqual=5]="GreaterOrEqual",n[n.Xor=6]="Xor",n[n.Or=7]="Or",n[n.And=8]="And"})(er||(er={}));class fb extends ze{constructor(e){super(e,N.Neutral),this.condition=er.LessThan,this.registerInput("a",S.Float),this.registerInput("b",S.Float),this.registerInput("true",S.AutoDetect,!0),this.registerInput("false",S.AutoDetect,!0),this.registerOutput("output",S.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=S.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case er.Equal:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};
`;break}case er.NotEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};
`;break}case er.LessThan:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};
`;break}case er.LessOrEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};
`;break}case er.GreaterThan:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};
`;break}case er.GreaterOrEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};
`;break}case er.Xor:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};
`;break}case er.Or:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};
`;break}case er.And:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};
`;break}}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${er[this.condition]};
`}}I([Ne("Condition",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Equal",value:er.Equal},{label:"NotEqual",value:er.NotEqual},{label:"LessThan",value:er.LessThan},{label:"GreaterThan",value:er.GreaterThan},{label:"LessOrEqual",value:er.LessOrEqual},{label:"GreaterOrEqual",value:er.GreaterOrEqual},{label:"Xor",value:er.Xor},{label:"And",value:er.And},{label:"Or",value:er.Or}]})],fb.prototype,"condition",void 0);$("BABYLON.ConditionalBlock",fb);class db extends ze{constructor(e){super(e,N.Neutral),this.octaves=6,this.registerInput("seed",S.AutoDetect),this.registerInput("chaos",S.AutoDetect,!0),this.registerInput("offsetX",S.Float,!0),this.registerInput("offsetY",S.Float,!0),this.registerInput("offsetZ",S.Float,!0),this.registerOutput("output",S.Float),this._inputs[0].acceptedConnectionPointTypes.push(S.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(S.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var l,c,u;if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`

        float cloudRandom(float p) { 
            float temp = fract(p * 0.011); 
            temp *= temp + 7.5; 
            temp *= temp + temp; 
            return fract(temp); 
        }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise2(vec2 x, vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise3(vec3 x, vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,i=`
        float fbm2(vec2 st, vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            vec2 tempST = st;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise2(tempST, chaos);
                tempST *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm3(vec3 x, vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            vec3 tempX = x;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise3(tempX, chaos);
                tempX = tempX * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`;e.shaderLanguage===1&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));const r=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,r).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");const s=e._getFreeVariableName("st"),a=((l=this.seed.connectedPoint)==null?void 0:l.type)||S.Vector3;e.compilationString+=`${e._declareLocalVar(s,a)} = ${this.seed.associatedVariableName};
`,this.offsetX.isConnected&&(e.compilationString+=`${s}.x += 0.1 * ${this.offsetX.associatedVariableName};
`),this.offsetY.isConnected&&(e.compilationString+=`${s}.y += 0.1 * ${this.offsetY.associatedVariableName};
`),this.offsetZ.isConnected&&a===S.Vector3&&(e.compilationString+=`${s}.z += 0.1 * ${this.offsetZ.associatedVariableName};
`);let o="";if(this.chaos.isConnected)o=this.chaos.associatedVariableName;else{const h=e.fSuffix;o=((c=this.seed.connectedPoint)==null?void 0:c.type)===S.Vector2?`vec2${h}(0., 0.)`:`vec3${h}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${r}${((u=this.seed.connectedPoint)==null?void 0:u.type)===S.Vector2?"2":"3"}(${s}, ${o});
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};
`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}I([Ne("Octaves",2,void 0,{embedded:!0})],db.prototype,"octaves",void 0);$("BABYLON.CloudBlock",db);class QH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("seed",S.Vector2),this.registerInput("offset",S.Float),this.registerInput("density",S.Float),this.registerOutput("output",S.Float),this.registerOutput("cells",S.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t=`vec2 voronoiRandom(vec2 p){
            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));
            return fract(sin(p)*18.5453);
        }
        `;e.shaderLanguage===1&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 n = floor(seed * density);
            vec2 f = fract(seed * density);
            vec3 m = vec3( 8.0 );
            for( int j=-1; j<=1; j++ ){
                for( int i=-1; i<=1; i++ ){
                    vec2  g = vec2( float(i), float(j) );
                    vec2  o = voronoiRandom( n + g);
                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));
                    float d = dot( r, r );
                    if( d<m.x ){
                        m = vec3( d, o );
                        outValue = m.x;
                        cells = m.y;
                    }
                }
			}
        }
        `,e.shaderLanguage===1?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells"),s=e.shaderLanguage===1?"&":"";return e.compilationString+=`${e._declareLocalVar(i,S.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar(r,S.Float)} = 0.0;
`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${s}${i}, ${s}${r});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${r};
`),this}}$("BABYLON.VoronoiNoiseBlock",QH);class JH extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==N.VertexAndFragment)return t.target;if(e.connectedPoint.target!==N.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};
`,this}}$("BABYLON.ElbowBlock",JH);class A_ extends ze{get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)==null?void 0:e.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const t=(e==null?void 0:e.getScene())??$e.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}get textureY(){var e;return this.sourceY.isConnected?((e=this.sourceY.connectedPoint)==null?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return(e=this.sourceZ)!=null&&e.isConnected?((t=this.sourceY.connectedPoint)==null?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return e!=null&&e.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e;return((e=this._getImageSourceBlock(this.sourceY))==null?void 0:e.samplerName)??null}get samplerZName(){var e;return((e=this._getImageSourceBlock(this.sourceZ))==null?void 0:e.samplerName)??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const t=this.texture.getScene()??$e.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const t=this.texture.getScene()??$e.LastCreatedScene;t==null||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,N.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",S.AutoDetect,!1),this.registerInput("normal",S.AutoDetect,!1),this.registerInput("sharpness",S.Float,!0),this.registerInput("source",S.Object,!0,N.VertexAndFragment,new ti("source",this,0,us,"ImageSourceBlock")),this.registerInput("sourceY",S.Object,!0,N.VertexAndFragment,new ti("sourceY",this,0,us,"ImageSourceBlock")),t||this.registerInput("sourceZ",S.Object,!0,N.VertexAndFragment,new ti("sourceZ",this,0,us,"ImageSourceBlock")),this.registerOutput("rgba",S.Color4,N.Neutral),this.registerOutput("rgb",S.Color3,N.Neutral),this.registerOutput("r",S.Float,N.Neutral),this.registerOutput("g",S.Float,N.Neutral),this.registerOutput("b",S.Float,N.Neutral),this.registerOutput("a",S.Float,N.Neutral),this.registerOutput("level",S.Float,N.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(S.Color3|S.Vector3|S.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return e.shaderLanguage===1?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return i.shaderLanguage===1?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,s=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",a=e._getFreeVariableName("x"),o=e._getFreeVariableName("y"),l=e._getFreeVariableName("z"),c=e._getFreeVariableName("w"),u=e._getFreeVariableName("n"),h=e._getFreeVariableName("uvx"),f=e._getFreeVariableName("uvy"),d=e._getFreeVariableName("uvz");e.compilationString+=`
            ${e._declareLocalVar(u,S.Vector3)} = ${this.normal.associatedVariableName}.xyz;

            ${e._declareLocalVar(h,S.Vector2)} = ${this.position.associatedVariableName}.yz;
            ${e._declareLocalVar(f,S.Vector2)} = ${this.position.associatedVariableName}.zx;
            ${e._declareLocalVar(d,S.Vector2)} = ${this.position.associatedVariableName}.xy;
        `,this.projectAsCube&&(e.compilationString+=`
                ${h}.xy = ${h}.yx;

                if (${u}.x >= 0.0) {
                    ${h}.x = -${h}.x;
                }
                if (${u}.y < 0.0) {
                    ${f}.y = -${f}.y;
                }
                if (${u}.z < 0.0) {
                    ${d}.x = -${d}.x;
                }
            `);const p=e.fSuffix;e.compilationString+=`
            ${e._declareLocalVar(a,S.Vector4)} = ${this._generateTextureSample(t,h,e)};
            ${e._declareLocalVar(o,S.Vector4)} = ${this._generateTextureSample(i,f,e)};
            ${e._declareLocalVar(l,S.Vector4)} = ${this._generateTextureSample(r,d,e)};
           
            // blend weights
            ${e._declareLocalVar(c,S.Vector3)} = pow(abs(${u}), vec3${p}(${s}));

            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = (${a}*${c}.x + ${o}*${c}.y + ${l}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        
        `}_generateConversionCode(e,t,i){let r="";e.shaderLanguage===1&&(t.type===S.Vector3||t.type===S.Color3)&&(r="Vec3"),i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${e.shaderLanguage===1?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(e.shaderLanguage===1?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,S.Float),this._generateTextureLookup(e);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!Ci.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}}I([Ne("Project as cube",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],A_.prototype,"projectAsCube",void 0);$("BABYLON.TriPlanarBlock",A_);class eX extends A_{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return t.shaderLanguage===1?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return e.shaderLanguage===1?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",s=e._getFreeVariableName("dxValue"),a=e._getFreeVariableName("dyValue"),o=e._getFreeVariableName("n"),l=e._getFreeVariableName("ma"),c=e._getFreeVariableName("mi"),u=e._getFreeVariableName("me"),h=e._getFreeVariableName("x"),f=e._getFreeVariableName("y"),d=e._getFreeVariableName("w");let p="ivec3",_="dFdx",g="dFdy";const E=e.fSuffix;e.shaderLanguage===1&&(p="vec3<i32>",_="dpdx",g="dpdy"),e.compilationString+=`
            // grab coord derivatives for texturing
            ${e._declareLocalVar(s,S.Vector3)} = ${_}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(a,S.Vector3)} = ${g}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(o,S.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);
        
            // determine major axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(l,e)} = ${e._generateTernary(`${p}(0,1,2)`,`${e._generateTernary(`${p}(1,2,0)`,`${p}(2,0,1)`,`(${o}.y>${o}.z)`)}`,`(${o}.x>${o}.y && ${o}.x>${o}.z)`)};                    

            // determine minor axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(c,e)} =  ${e._generateTernary(`${p}(0,1,2)`,`${e._generateTernary(`${p}(1,2,0)`,`${p}(2,0,1)`,`(${o}.y<${o}.z)`)}`,`(${o}.x<${o}.y && ${o}.x<${o}.z)`)};  
                              
            // determine median axis (in x;  yz are following axis)
            ${this._declareLocalVarAsVec3I(u,e)} = ${p}(3) - ${c} - ${l};
            
            // project+fetch
            ${e._declareLocalVar(h,S.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${E}(${this.position.associatedVariableName}[${l}.y], ${this.position.associatedVariableName}[${l}.z]), 
                                    vec2${E}(${s}[${l}.y],${s}[${l}.z]), 
                                    vec2${E}(${a}[${l}.y],${a}[${l}.z]));
            ${e._declareLocalVar(f,S.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${E}(${this.position.associatedVariableName}[${u}.y], ${this.position.associatedVariableName}[${u}.z]), 
                                    vec2${E}(${s}[${u}.y],${s}[${u}.z]),
                                    vec2${E}(${a}[${u}.y],${a}[${u}.z]));
            
            // blend factors
            ${e._declareLocalVar(d,S.Vector2)} = vec2${E}(${o}[${l}.x],${o}[${u}.x]);
            // make local support
            ${d} = clamp( (${d}-0.5773)/(1.0-0.5773), vec2${E}(0.0), vec2${E}(1.0) );
            // shape transition
            ${d} = pow( ${d}, vec2${E}(${r}/8.0) );
            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,S.Vector4)} = (${h}*${d}.x + ${f}*${d}.y) / (${d}.x + ${d}.y);
        `}}$("BABYLON.BiPlanarBlock",eX);class tX extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.Matrix),this.registerOutput("output",S.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});
`,this}}$("BABYLON.MatrixDeterminantBlock",tX);class iX extends ze{constructor(e){super(e,N.Neutral),this.registerInput("input",S.Matrix),this.registerOutput("output",S.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});
`,this}}$("BABYLON.MatrixTransposeBlock",iX);var gv;(function(n){n[n.None=0]="None",n[n.Normal=1]="Normal",n[n.Tangent=2]="Tangent",n[n.VertexColor=3]="VertexColor",n[n.UV1=4]="UV1",n[n.UV2=5]="UV2",n[n.UV3=6]="UV3",n[n.UV4=7]="UV4",n[n.UV5=8]="UV5",n[n.UV6=9]="UV6"})(gv||(gv={}));class pb extends ze{constructor(e){super(e,N.Neutral),this.attributeType=0,this.registerInput("input",S.AutoDetect),this.registerInput("fallback",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add(t=>{var r;if(this.attributeType)return;const i=t.ownerBlock;if(i instanceof _t&&i.isAttribute)switch(i.name){case"color":this.attributeType=3;break;case"normal":this.attributeType=1;break;case"tangent":this.attributeType=2;break;case"uv":this.attributeType=4;break;case"uv2":this.attributeType=5;break;case"uv3":this.attributeType=6;break;case"uv4":this.attributeType=7;break;case"uv5":this.attributeType=8;break;case"uv6":this.attributeType=9;break}else if(i instanceof ab)switch((r=this.input.connectedPoint)==null?void 0:r.name){case"normalOutput":this.attributeType=1;break;case"tangentOutput":this.attributeType=2;break;case"uvOutput":this.attributeType=4;break}})}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case 3:t="VERTEXCOLOR_NME";break;case 1:t="NORMAL";break;case 2:t="TANGENT";break;case 4:t="UV1";break;case 5:t="UV2";break;case 6:t="UV3";break;case 7:t="UV4";break;case 8:t="UV5";break;case 9:t="UV6";break}const i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}
`),e.compilationString+=`${i} = ${this.input.associatedVariableName};
`,t&&(e.compilationString+=`#else
`,e.compilationString+=`${i} = ${this.fallback.associatedVariableName};
`,e.compilationString+=`#endif
`),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??0}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};
`,e}}I([Ne("Attribute lookup",4,void 0,{notifiers:{update:!0},embedded:!0,options:[{label:"(None)",value:0},{label:"Normal",value:1},{label:"Tangent",value:2},{label:"Vertex Color",value:3},{label:"UV1",value:4},{label:"UV2",value:5},{label:"UV3",value:6},{label:"UV4",value:7},{label:"UV5",value:8},{label:"UV6",value:9}]})],pb.prototype,"attributeType",void 0);$("BABYLON.MeshAttributeExistsBlock",pb);var gt;(function(n){n[n.EaseInSine=0]="EaseInSine",n[n.EaseOutSine=1]="EaseOutSine",n[n.EaseInOutSine=2]="EaseInOutSine",n[n.EaseInQuad=3]="EaseInQuad",n[n.EaseOutQuad=4]="EaseOutQuad",n[n.EaseInOutQuad=5]="EaseInOutQuad",n[n.EaseInCubic=6]="EaseInCubic",n[n.EaseOutCubic=7]="EaseOutCubic",n[n.EaseInOutCubic=8]="EaseInOutCubic",n[n.EaseInQuart=9]="EaseInQuart",n[n.EaseOutQuart=10]="EaseOutQuart",n[n.EaseInOutQuart=11]="EaseInOutQuart",n[n.EaseInQuint=12]="EaseInQuint",n[n.EaseOutQuint=13]="EaseOutQuint",n[n.EaseInOutQuint=14]="EaseInOutQuint",n[n.EaseInExpo=15]="EaseInExpo",n[n.EaseOutExpo=16]="EaseOutExpo",n[n.EaseInOutExpo=17]="EaseInOutExpo",n[n.EaseInCirc=18]="EaseInCirc",n[n.EaseOutCirc=19]="EaseOutCirc",n[n.EaseInOutCirc=20]="EaseInOutCirc",n[n.EaseInBack=21]="EaseInBack",n[n.EaseOutBack=22]="EaseOutBack",n[n.EaseInOutBack=23]="EaseInOutBack",n[n.EaseInElastic=24]="EaseInElastic",n[n.EaseOutElastic=25]="EaseOutElastic",n[n.EaseInOutElastic=26]="EaseInOutElastic"})(gt||(gt={}));class _b extends ze{constructor(e){super(e,N.Neutral),this.type=gt.EaseInOutSine,this.registerInput("input",S.AutoDetect),this.registerOutput("output",S.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(S.Matrix),this._inputs[0].excludedConnectionPointTypes.push(S.Object),this._inputs[0].excludedConnectionPointTypes.push(S.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if(t==="float"||t==="f32")return this._duplicateEntryDirect(e);const r=parseInt(t.replace("vec",""));let s=i?`
            var ret: vec${r}f = vec${r}f(0.0);
        `:`
            vec${r} ret = vec${r}(0.0);
        `;for(let a=1;a<=r;a++)s+=this._duplicateEntry(e,a===1?"x":a===2?"y":a===3?"z":"w")+`;
`;return s+=`return ret;
`,s}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",r="";const s=e._getShaderType(this.input.type),a=e.shaderLanguage===1;switch(r=gt[this.type]+"_"+s.replace("<","").replace(">",""),this.type){case gt.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case gt.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case gt.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case gt.EaseInQuad:i="return v * v";break;case gt.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case gt.EaseInOutQuad:{const o=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,s,a);break}case gt.EaseInCubic:i="return v * v * v";break;case gt.EaseOutCubic:{i=this._duplicateVector("1.0 - pow(1.0 - VAL, 3.0)",s,a);break}case gt.EaseInOutCubic:{const o=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,s,a);break}case gt.EaseInQuart:i="return v * v * v * v";break;case gt.EaseOutQuart:{i=this._duplicateVector("1.0 - pow(1.0 - VAL, 4.0)",s,a);break}case gt.EaseInOutQuart:{const o=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,s,a);break}case gt.EaseInQuint:i="return v * v * v * v * v";break;case gt.EaseOutQuint:{i=this._duplicateVector("1.0 - pow(1.0 - VAL, 5.0)",s,a);break}case gt.EaseInOutQuint:{const o=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,s,a);break}case gt.EaseInExpo:{const o=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(o,s,a);break}case gt.EaseOutExpo:{const o=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(o,s,a);break}case gt.EaseInOutExpo:{const o=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,s,a);break}case gt.EaseInCirc:{i=this._duplicateVector("1.0 - sqrt(1.0 - pow(VAL, 2.0))",s,a);break}case gt.EaseOutCirc:{i=this._duplicateVector("sqrt(1.0 - pow(VAL - 1.0, 2.0))",s,a);break}case gt.EaseInOutCirc:{const o=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,s,a);break}case gt.EaseInBack:{i="return 2.70158 * v * v * v - 1.70158 * v * v";break}case gt.EaseOutBack:{i=this._duplicateVector("2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)",s,a);break}case gt.EaseInOutBack:{const o=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(o,s,a);break}case gt.EaseInElastic:{const o=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,s,a);break}case gt.EaseOutElastic:{const o=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,s,a);break}case gt.EaseInOutElastic:{const o=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(o,s,a);break}}return a?e._emitFunction(r,`fn ${r}(v: ${s}) -> ${s}  {${i};}
`,""):e._emitFunction(r,`${s} ${r}(${s} v) {${i};}
`,""),e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${gt[this.type]};
`}}I([Ne("Type",4,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"EaseInSine",value:gt.EaseInSine},{label:"EaseOutSine",value:gt.EaseOutSine},{label:"EaseInOutSine",value:gt.EaseInOutSine},{label:"EaseInQuad",value:gt.EaseInQuad},{label:"EaseOutQuad",value:gt.EaseOutQuad},{label:"EaseInOutQuad",value:gt.EaseInOutQuad},{label:"EaseInCubic",value:gt.EaseInCubic},{label:"EaseOutCubic",value:gt.EaseOutCubic},{label:"EaseInOutCubic",value:gt.EaseInOutCubic},{label:"EaseInQuart",value:gt.EaseInQuart},{label:"EaseOutQuart",value:gt.EaseOutQuart},{label:"EaseInOutQuart",value:gt.EaseInOutQuart},{label:"EaseInQuint",value:gt.EaseInQuint},{label:"EaseOutQuint",value:gt.EaseOutQuint},{label:"EaseInOutQuint",value:gt.EaseInOutQuint},{label:"EaseInExpo",value:gt.EaseInExpo},{label:"EaseOutExpo",value:gt.EaseOutExpo},{label:"EaseInOutExpo",value:gt.EaseInOutExpo},{label:"EaseInCirc",value:gt.EaseInCirc},{label:"EaseOutCirc",value:gt.EaseOutCirc},{label:"EaseInOutCirc",value:gt.EaseInOutCirc},{label:"EaseInBack",value:gt.EaseInBack},{label:"EaseOutBack",value:gt.EaseOutBack},{label:"EaseInOutBack",value:gt.EaseInOutBack},{label:"EaseInElastic",value:gt.EaseInElastic},{label:"EaseOutElastic",value:gt.EaseOutElastic},{label:"EaseInOutElastic",value:gt.EaseInOutElastic}]})],_b.prototype,"type",void 0);$("BABYLON.CurveBlock",_b);class rX extends ze{constructor(e){super(e,N.Neutral),this.registerInput("rgb ",S.Color3,!0),this.registerInput("hsl ",S.Color3,!0),this.registerOutput("rgb",S.Color3),this.registerOutput("hsl",S.Color3)}getClassName(){return"ColorConverterBlock"}get rgbIn(){return this._inputs[0]}get hslIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get hslOut(){return this._outputs[1]}_inputRename(e){return e==="rgb "?"rgbIn":e==="hsl "?"hslIn":e}_buildBlock(e){super._buildBlock(e);const t=this.rgbIn,i=this.hslIn,r=this._outputs[0],s=this._outputs[1],a=e._getShaderType(S.Vector3);let o=`
            vec3 rgb2hsl(vec3 color) {
                float r = color.r;
                float g = color.g;
                float b = color.b;

                float maxc = max(r, max(g, b));
                float minc = min(r, min(g, b));
                float h = 0.0;
                float s = 0.0;
                float l = (maxc + minc) / 2.0;

                if (maxc != minc) {
                    float d = maxc - minc;
                    if (l > 0.5) {
                        s = d / (2.0 - maxc - minc);
                    } else {
                        s = d / (maxc + minc);
                    }

                    if (maxc == r) {
                        float add = 0.0;
                        if (g < b) {
                            add = 6.0;
                        }
                        h = (g - b) / d + add;
                    } else if (maxc == g) {
                        h = (b - r) / d + 2.0;
                    } else if (maxc == b) {
                        h = (r - g) / d + 4.0;
                    }
                    h /= 6.0;
                }

                return vec3(h, s, l);
            }`,l=`
            float hue2rgb(float p, float q, float tt) {
                float t = tt;
                if (t < 0.0) {
                    t += 1.0;
                }
                if (t > 1.0) {
                    t -= 1.0;
                }
                if (t < 1.0/6.0) {
                    return p + (q - p) * 6.0 * t;
                }
                if (t < 1.0/2.0) {
                    return q;
                }
                if (t < 2.0/3.0) {
                    return p + (q - p) * (2.0/3.0 - t) * 6.0;
                }
                return p;
            }`,c=`
            vec3 hsl2rgb(vec3 hsl) {
                float h = hsl.x;
                float s = hsl.y;
                float l = hsl.z;

                float r;
                float g;
                float b;

                if (s == 0.0) {
                    // Achromatic (grey)
                    r = l;
                    g = l;
                    b = l; 
                } else {
                    float q;
                
                    if (l < 0.5) {
                        q = l * (1.0 + s);
                    } else {
                        q = (l + s - l * s);
                    }

                    float p = 2.0 * l - q;

                    r = hue2rgb(p, q, h + 1.0/3.0);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1.0/3.0);
                }

                return vec3(r, g, b);
            }`;return e.shaderLanguage===1&&(o=e._babylonSLtoWGSL(o),l=e._babylonSLtoWGSL(l),c=e._babylonSLtoWGSL(c)),e._emitFunction("rgb2hsl",o,""),e._emitFunction("hue2rgb",l,""),e._emitFunction("hsl2rgb",c,""),t.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName};
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = rgb2hsl(${t.associatedVariableName});
`)):i.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = hsl2rgb(${i.associatedVariableName});
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${i.associatedVariableName};
`)):(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` =  ${a}(0.);
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` =  ${a}(0.);
`)),this}}$("BABYLON.ColorConverterBlock",rX);class vl extends ze{constructor(e){super(e,N.Neutral),this.iterations=4,this.registerInput("input",S.AutoDetect),this.registerInput("iterations",S.Float,!0),this.registerOutput("output",S.BasedOnInput),this.registerOutput("index",S.Float,N.Fragment),this.registerOutput("loopID",S.Object,void 0,new ti("loopID",this,1,vl,"LoopBlock")),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._forPostBuild=!0,this._outputs[2]._redirectedSource=this._inputs[0],this._outputs[1]._preventBubbleUp=!0,this._outputs[2]._preventBubbleUp=!0}getClassName(){return"LoopBlock"}get input(){return this._inputs[0]}get iterationsInput(){return this._inputs[1]}get output(){return this._outputs[0]}get index(){return this._outputs[1]}get loopID(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1],r=e._getFreeVariableName("index"),s=e.shaderLanguage===1?"var":"int",a=e.shaderLanguage===1?"f32":"float",o=e.shaderLanguage===1?"i32":"int";e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName};
`;const l=this.iterationsInput.isConnected?`${o}(${this.iterationsInput.associatedVariableName})`:this.iterations;return e.compilationString+=`for (${s} ${r} = 0; ${r} < ${l}; ${r}++){
`,e.compilationString+=`${e._declareOutput(i)} = ${a}(${r});
`,this}_postBuildBlock(e){return super._postBuildBlock(e),e.compilationString+=`}
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.iterations = ${this.iterations};
`}serialize(){const e=super.serialize();return e.iterations=this.iterations,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.iterations=e.iterations}}I([Ne("Iterations",2,void 0,{embedded:!0})],vl.prototype,"iterations",void 0);$("BABYLON.LoopBlock",vl);class sX extends ze{constructor(e){super(e,N.Neutral),this.registerInput("loopID",S.Object,!1,void 0,new ti("loopID",this,0,vl,"LoopBlock")),this.registerOutput("value",S.AutoDetect),this._outputs[0]._linkedConnectionSource=this._inputs[0]}getClassName(){return"StorageReadBlock"}get loopID(){return this._inputs[0]}get value(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=e._declareOutput(t)+` = ${i.output.associatedVariableName};
`,this}}$("BABYLON.StorageReadBlock",sX);class nX extends ze{constructor(e){super(e,N.Neutral),this.registerInput("loopID",S.Object,!1,void 0,new ti("loopID",this,0,vl,"LoopBlock")),this.registerInput("value",S.AutoDetect),this._linkConnectionTypes(0,1)}getClassName(){return"StorageWriteBlock"}get loopID(){return this._inputs[0]}get value(){return this._inputs[1]}isConnectedInFragmentShader(){return this.loopID.isConnected?this.loopID.connectedPoint.ownerBlock.output.isConnectedInFragmentShader:!1}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=`${i.output.associatedVariableName} = ${t.associatedVariableName};
`,this}}$("BABYLON.StorageWriteBlock",nX);const aX="gaussianSplattingVertexDeclaration",oX=`attribute position: vec2f;
`;V.IncludesShadersStoreWGSL[aX]=oX;var Ev;(function(n){n[n.Created=1]="Created",n[n.Disposed=2]="Disposed",n[n.GetDefineNames=4]="GetDefineNames",n[n.PrepareUniformBuffer=8]="PrepareUniformBuffer",n[n.IsReadyForSubMesh=16]="IsReadyForSubMesh",n[n.PrepareDefines=32]="PrepareDefines",n[n.BindForSubMesh=64]="BindForSubMesh",n[n.PrepareEffect=128]="PrepareEffect",n[n.GetAnimatables=256]="GetAnimatables",n[n.GetActiveTextures=512]="GetActiveTextures",n[n.HasTexture=1024]="HasTexture",n[n.FillRenderTargetTextures=2048]="FillRenderTargetTextures",n[n.HasRenderTargetTextures=4096]="HasRenderTargetTextures",n[n.HardBindForSubMesh=8192]="HardBindForSubMesh"})(Ev||(Ev={}));class lX extends Gr{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class Nc extends is{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DecalMap",150,new lX,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,r){const s=r.getMesh().decalMap;return!this._isEnabled||!(s!=null&&s.texture)||!_e.DecalMapEnabled||!t.texturesEnabled?!0:s.isReady()}prepareDefinesBeforeAttributes(e,t,i){const r=i.decalMap;!this._isEnabled||!(r!=null&&r.texture)||!_e.DecalMapEnabled||!t.texturesEnabled?(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1):((!e.DECAL||e.GAMMADECAL!==r.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=r.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,ai(r.texture,e,"DECAL"))}hardBindForSubMesh(e,t,i,r){const s=r.getMesh().decalMap;if(!this._isEnabled||!(s!=null&&s.texture)||!_e.DecalMapEnabled||!t.texturesEnabled)return;const a=this._material.isFrozen,o=s.texture;(!e.useUbo||!a||!e.isSync)&&(e.updateFloat4("vDecalInfos",o.coordinatesIndex,0,0,0),oi(o,e,"decal")),e.setTexture("decalSampler",o)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Nc.prototype,"isEnabled",void 0);I([M(),ie("_markAllSubMeshesAsTexturesDirty")],Nc.prototype,"smoothAlpha",void 0);$("BABYLON.DecalMapConfiguration",Nc);var vv;(function(n){n[n.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",n[n.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",n[n.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE"})(vv||(vv={}));var Sv;(function(n){n[n.COLOR_MODE_SET=0]="COLOR_MODE_SET",n[n.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",n[n.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY"})(Sv||(Sv={}));var Tv;(function(n){n[n.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",n[n.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"})(Tv||(Tv={}));const cX=`#if defined(DBG_ENABLED)
attribute float dbg_initialPass;
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;
#endif`,uX=`#if defined(DBG_ENABLED)
attribute dbg_initialPass: f32;
varying dbg_vBarycentric: vec3f;
varying dbg_vVertexWorldPos: vec3f;
varying dbg_vPass: f32;
#endif`,hX=`#if defined(DBG_ENABLED)
float dbg_vertexIndex = mod(float(gl_VertexID), 3.);
if (dbg_vertexIndex == 0.0) { 
    dbg_vBarycentric = vec3(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    dbg_vBarycentric = vec3(0.,1.,0.); 
}
else { 
    dbg_vBarycentric = vec3(0.,0.,1.); 
}

dbg_vVertexWorldPos = vPositionW;
dbg_vPass = dbg_initialPass;
#endif`,fX=`#if defined(DBG_ENABLED)
var dbg_vertexIndex = f32(input.vertexIndex) % 3.;
if (dbg_vertexIndex == 0.0) { 
    vertexOutputs.dbg_vBarycentric = vec3f(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    vertexOutputs.dbg_vBarycentric = vec3f(0.,1.,0.); 
}
else { 
    vertexOutputs.dbg_vBarycentric = vec3f(0.,0.,1.); 
}

vertexOutputs.dbg_vVertexWorldPos = vertexOutputs.vPositionW;
vertexOutputs.dbg_vPass = input.dbg_initialPass;
#endif`,dX=`#if defined(DBG_ENABLED)
uniform vec3 dbg_shadedDiffuseColor;
uniform vec4 dbg_shadedSpecularColorPower;
uniform vec3 dbg_thicknessRadiusScale;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform vec3 dbg_vertexColor;
#endif

#if DBG_MODE == 1
    uniform vec3 dbg_wireframeTrianglesColor;
#elif DBG_MODE == 3
    uniform vec3 dbg_wireframeVerticesColor;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform vec3 dbg_uvPrimaryColor;
    uniform vec3 dbg_uvSecondaryColor;
#elif DBG_MODE == 7
    uniform vec3 dbg_materialColor;
#endif
#endif`,pX=`#if defined(DBG_ENABLED)
uniform dbg_shadedDiffuseColor: vec3f;
uniform dbg_shadedSpecularColorPower: vec4f;
uniform dbg_thicknessRadiusScale: vec3f;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform dbg_vertexColor: vec3f;
#endif

#if DBG_MODE == 1
    uniform dbg_wireframeTrianglesColor: vec3f;
#elif DBG_MODE == 3
    uniform  dbg_wireframeVerticesColor: vec3f;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform dbg_uvPrimaryColor: vec3f;
    uniform dbg_uvSecondaryColor: vec3f;
#elif DBG_MODE == 7
    uniform dbg_materialColor: vec3f;
#endif
#endif`,_X=`#if defined(DBG_ENABLED)
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;

#if !defined(DBG_MULTIPLY)
    vec3 dbg_applyShading(vec3 color) {
        vec3 N = vNormalW.xyz;
        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);
        vec3 H = normalize(L + L);
        float LdotN = clamp(dot(L,N), 0., 1.);
        float HdotN = clamp(dot(H,N), 0., 1.);
        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);
        color *= (LdotN / PI);
        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return color;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    float dbg_edgeFactor() {
        vec3 d = fwidth(dbg_vBarycentric);
        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor() {
        vec3 worldPos = vPositionW;
        float dist = length(worldPos - dbg_vVertexWorldPos);
        float camDist = length(worldPos - vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    float dbg_checkerboardFactor(vec2 uv) {
        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,mX=`#if defined(DBG_ENABLED)
varying dbg_vBarycentric: vec3f;
varying dbg_vVertexWorldPos: vec3f;
varying dbg_vPass: f32;

#if !defined(DBG_MULTIPLY)
    fn dbg_applyShading(color: vec3f) -> vec3f {
        var N = fragmentInputs.vNormalW.xyz;
        var L = normalize(scene.vEyePosition.xyz - fragmentInputs.vPositionW.xyz);
        var H = normalize(L + L);
        var LdotN = clamp(dot(L,N), 0., 1.);
        var HdotN = clamp(dot(H,N), 0., 1.);
        var specTerm = pow(HdotN, uniforms.dbg_shadedSpecularColorPower.w);
        var result = color * (LdotN / PI);
        result += uniforms.dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return result;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    fn dbg_edgeFactor() -> f32 {
        var d = fwidth(fragmentInputs.dbg_vBarycentric);
        var a3 = smoothstep(vec3f(0.), d * uniforms.dbg_thicknessRadiusScale.x, fragmentInputs.dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    fn dbg_cornerFactor() -> f32 {
        var worldPos = fragmentInputs.vPositionW;
        float dist = length(worldPos - fragmentInputs.dbg_vVertexWorldPos);
        float camDist = length(worldPos - scene.vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((uniforms.dbg_thicknessRadiusScale.y * d), ((uniforms.dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    fn dbg_checkerboardFactor(uv: vec2f) -> f32 {
        var f = fract(uv * uniforms.dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,gX=`#if defined(DBG_ENABLED)
vec3 dbg_color = vec3(1.);
#if DBG_MODE == 1
    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor = dbg_cornerFactor();
    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    gl_FragColor *= vec4(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        gl_FragColor = vec4(dbg_color, 1.);
    #endif
#endif
#endif`,EX=`#if defined(DBG_ENABLED)
var dbg_color = vec3f(1.);
#if DBG_MODE == 1
    dbg_color = mix(uniforms.dbg_wireframeTrianglesColor, vec3f(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    var dbg_cornerFactor = dbg_cornerFactor();
    if (fragmentInputs.dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(uniforms.dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(uniforms.dbg_wireframeVerticesColor, vec3f(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = fragmentInputs.vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = uniforms.dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    fragmentOutputs.color *= vec4f(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        fragmentOutputs.color = vec4f(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        fragmentOutputs.color = vec4f(dbg_color, 1.);
    #endif
#endif
#endif`,mb=[new fe(.98,.26,.38),new fe(.47,.75,.3),new fe(0,.26,.77),new fe(.97,.6,.76),new fe(.19,.63,.78),new fe(.98,.8,.6),new fe(.65,.43,.15),new fe(.15,.47,.22),new fe(.67,.71,.86),new fe(.09,.46,.56),new fe(.8,.98,.02),new fe(.39,.29,.13),new fe(.53,.63,.06),new fe(.95,.96,.41),new fe(1,.72,.94),new fe(.63,.08,.31),new fe(.66,.96,.95),new fe(.22,.14,.19),new fe(.14,.65,.59),new fe(.93,1,.68),new fe(.93,.14,.44),new fe(.47,.86,.67),new fe(.85,.07,.78),new fe(.53,.64,.98),new fe(.43,.37,.56),new fe(.71,.65,.25),new fe(.66,.19,.01),new fe(.94,.53,.12),new fe(.41,.44,.44),new fe(.24,.71,.96),new fe(.57,.28,.56),new fe(.44,.98,.42)];var xv;(function(n){n[n.NONE=0]="NONE",n[n.TRIANGLES=1]="TRIANGLES",n[n.VERTICES=2]="VERTICES",n[n.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",n[n.UV0=4]="UV0",n[n.UV1=5]="UV1",n[n.VERTEXCOLORS=6]="VERTEXCOLORS",n[n.MATERIALIDS=7]="MATERIALIDS"})(xv||(xv={}));class vX extends Gr{constructor(){super(...arguments),this.DBG_MODE=0,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class sr extends is{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}constructor(e,t={}){const i=new vX;i.DBG_MODE=t.mode??i.DBG_MODE,i.DBG_MULTIPLY=t.multiply??i.DBG_MULTIPLY,super(e,"MeshDebug",200,i,!0,!0),this._mode=i.DBG_MODE,this._multiply=i.DBG_MULTIPLY,this.shadedDiffuseColor=t.shadedDiffuseColor??new fe(1,1,1),this.shadedSpecularColor=t.shadedSpecularColor??new fe(.8,.8,.8),this.shadedSpecularPower=t.shadedSpecularPower??10,this.wireframeThickness=t.wireframeThickness??.7,this.wireframeTrianglesColor=t.wireframeTrianglesColor??new fe(0,0,0),this.wireframeVerticesColor=t.wireframeVerticesColor??new fe(.8,.8,.8),this.vertexColor=t.vertexColor??new fe(0,0,0),this.vertexRadius=t.vertexRadius??1.2,this.uvScale=t.uvScale??20,this.uvPrimaryColor=t.uvPrimaryColor??new fe(1,1,1),this.uvSecondaryColor=t.uvSecondaryColor??new fe(.5,.5,.5),this._materialColor=sr.MaterialColors[sr._PluginCount++%sr.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&this._material.getScene().getEngine().version==1){w.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),this._isEnabled=!1;return}this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){(this._mode==2||this._mode==1||this._mode==3)&&!i.isVerticesDataPresent("dbg_initialPass")&&w.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(e=0){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:e===0?dX:pX}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e,t=0){return t===1?e==="vertex"?{CUSTOM_VERTEX_DEFINITIONS:uX,CUSTOM_VERTEX_MAIN_END:fX}:{CUSTOM_FRAGMENT_DEFINITIONS:mX,CUSTOM_FRAGMENT_MAIN_END:EX}:e==="vertex"?{CUSTOM_VERTEX_DEFINITIONS:cX,CUSTOM_VERTEX_MAIN_END:hX}:{CUSTOM_FRAGMENT_DEFINITIONS:_X,CUSTOM_FRAGMENT_MAIN_END:gX}}static Reset(){this._PluginCount=0,this.MaterialColors=mb}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(e.getTotalIndices()==0)return i;if(t){const u=e.getVerticesDataKinds(),h=e.getIndices(),f={};for(const d of u)f[d]=e.getVerticesData(d);i=function(){e.setIndices(h);for(const d of u){const p=e.getVertexBuffer(d).getStrideSize();e.setVerticesData(d,f[d],void 0,p)}e.removeVerticesData("dbg_initialPass")}}let r=Array.from(e.getIndices());const s=[];for(let u=0;u<r.length;u+=3)s.push(r[u+1],r[u+2],r[u+0]);e.setIndices(r.concat(s)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,r=Array.from(e.getIndices());const a=[];for(let u=r.length/2;u<r.length;u+=3)a.push(r[u+1],r[u+2],r[u+0]);e.setIndices(r.concat(a));const o=e.getTotalVertices(),l=o/2,c=new Array(o).fill(1,0,l).fill(0,l,o);return e.setVerticesData("dbg_initialPass",c,!1,1),i}}sr._PluginCount=0;sr.MaterialColors=mb;I([hi()],sr.prototype,"_materialColor",void 0);I([M()],sr.prototype,"_isEnabled",void 0);I([M(),ie("_markAllDefinesAsDirty")],sr.prototype,"mode",void 0);I([M(),ie("_markAllDefinesAsDirty")],sr.prototype,"multiply",void 0);I([hi()],sr.prototype,"shadedDiffuseColor",void 0);I([hi()],sr.prototype,"shadedSpecularColor",void 0);I([M()],sr.prototype,"shadedSpecularPower",void 0);I([M()],sr.prototype,"wireframeThickness",void 0);I([hi()],sr.prototype,"wireframeTrianglesColor",void 0);I([hi()],sr.prototype,"wireframeVerticesColor",void 0);I([hi()],sr.prototype,"vertexColor",void 0);I([M()],sr.prototype,"vertexRadius",void 0);I([M()],sr.prototype,"uvScale",void 0);I([hi()],sr.prototype,"uvPrimaryColor",void 0);I([hi()],sr.prototype,"uvSecondaryColor",void 0);$("BABYLON.MeshDebugPluginMaterial",sr);Object.defineProperty(Ie.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new Nc(this)}return this._decalMap},enumerable:!0,configurable:!0});Object.defineProperty(wt.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new Nc(this)}return this._decalMap},enumerable:!0,configurable:!0});const SX="defaultFragmentDeclaration",TX=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;V.IncludesShadersStore[SX]=TX;const xX="defaultUboDeclaration",CX=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;V.IncludesShadersStore[xX]=CX;const gb="defaultPixelShader",Eb=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;float aggShadow=0.;float numLights=0.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;V.ShadersStore[gb]=Eb;const AX={name:gb,shader:Eb},IX=Object.freeze(Object.defineProperty({__proto__:null,defaultPixelShader:AX},Symbol.toStringTag,{value:"Module"})),yX="defaultVertexDeclaration",bX=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;V.IncludesShadersStore[yX]=bX;const vb="defaultVertexShader",Sb=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;V.ShadersStore[vb]=Sb;const RX={name:vb,shader:Sb},PX=Object.freeze(Object.defineProperty({__proto__:null,defaultVertexShader:RX},Symbol.toStringTag,{value:"Module"})),MX="defaultUboDeclaration",DX=`uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;V.IncludesShadersStoreWGSL[MX]=DX;const Tb="defaultPixelShader",xb=`#include<defaultUboDeclaration>
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
var refractionCubeSamplerSampler: sampler;var refractionCubeSampler: texture_cube<f32>;
#else
var refraction2DSamplerSampler: sampler;var refraction2DSampler: texture_2d<f32>;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionCubeSamplerSampler: sampler;var reflectionCubeSampler: texture_cube<f32>;
#else
var reflection2DSamplerSampler: sampler;var reflection2DSampler: texture_2d<f32>;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-fragmentInputs.vPositionW);var baseColor: vec4f= vec4f(1.,1.,1.,1.);var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;var alpha: f32=uniforms.vDiffuseColor.a;
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f=normalize(-cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
#ifdef DIFFUSE
baseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<uniforms.alphaCutOff) {discard;}
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor=vec4f(baseColor.rgb*uniforms.vDiffuseInfos.y,baseColor.a);
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor=vec4f(baseColor.rgb*fragmentInputs.vColor.rgb,baseColor.a);
#endif
#ifdef DETAIL
baseColor=vec4f(baseColor.rgb*2.0*mix(0.5,detailColor.r,uniforms.vDetailInfos.y),baseColor.a);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
var baseAmbientColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb*uniforms.vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var glossiness: f32=uniforms.vSpecularColor.a;var specularColor: vec3f=uniforms.vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
var specularMapColor: vec4f=textureSample(specularSampler,specularSamplerSampler,fragmentInputs.vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
var diffuseBase: vec3f= vec3f(0.,0.,0.);var info: lightingInfo;
#ifdef SPECULARTERM
var specularBase: vec3f= vec3f(0.,0.,0.);
#endif
var shadow: f32=1.;var aggShadow: f32=0.;var numLights: f32=0.;
#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;var refractionColor: vec4f= vec4f(0.,0.,0.,1.);
#ifdef REFRACTION
var refractionVector: vec3f=normalize(refract(-viewDirectionW,normalW,uniforms.vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(fragmentInputs.vPositionW,refractionVector,uniforms.vRefractionSize,uniforms.vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*uniforms.vRefractionInfos.w;var refractionLookup: vec4f=textureSample(refractionCubeSampler,refractionCubeSamplerSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
var vRefractionUVW: vec3f= (uniforms.refractionMatrix*(scene.view* vec4f(fragmentInputs.vPositionW+refractionVector*uniforms.vRefractionInfos.z,1.0))).xyz;var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=textureSample(refraction2DSampler,refraction2DSamplerSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor=vec4f(fromRGBD(refractionColor),refractionColor.a);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor=vec4f(toGammaSpaceVec3(refractionColor.rgb),refractionColor.a);
#endif
refractionColor=vec4f(refractionColor.rgb*uniforms.vRefractionInfos.x,refractionColor.a);
#endif
var reflectionColor: vec4f= vec4f(0.,0.,0.,1.);
#ifdef REFLECTION
var vReflectionUVW: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW=vec3f(vReflectionUVW.x,vReflectionUVW.y,vReflectionUVW.z*-1.0);
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
var bias: f32=uniforms.vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureSampleLevel(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW,bias);
#else
reflectionColor=textureSample(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW);
#endif
#else
var coords: vec2f=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=textureSample(reflection2DSampler,reflection2DSamplerSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor),reflectionColor.a);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor=vec4f(toGammaSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#ifdef REFLECTIONFRESNEL
var reflectionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.reflectionRightColor.a,uniforms.reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor=vec4f(reflectionColor.rgb*specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#else
reflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#endif
#else
reflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
var refractionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.refractionRightColor.a,uniforms.refractionLeftColor.a);refractionColor=vec4f(refractionColor.rgb*uniforms.refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*uniforms.refractionRightColor.rgb,refractionColor.a);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* uniforms.vOpacityInfos.y;
#else
alpha*=opacityMap.a*uniforms.vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#ifdef OPACITYFRESNEL
var opacityFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.opacityParts.z,uniforms.opacityParts.w);alpha+=uniforms.opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*uniforms.opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<uniforms.alphaCutOff) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
var emissiveColor: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb*uniforms.vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
var emissiveFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.emissiveRightColor.a,uniforms.emissiveLeftColor.a);emissiveColor*=uniforms.emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*uniforms.emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
var diffuseFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.diffuseRightColor.a,uniforms.diffuseLeftColor.a);diffuseBase*=uniforms.diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*uniforms.diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
var finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
var finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#else
var finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular, vec3f(0.3,0.59,0.11)),0.0,1.0);
#endif
#else
var finalSpecular: vec3f= vec3f(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb, vec3f(0.3,0.59,0.11)),0.0,1.0);
#endif
#ifdef EMISSIVEASILLUMINATION
var color: vec4f= vec4f(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
var color: vec4f= vec4f(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color=vec4f(color.rgb*lightmapColor.rgb,color.a);
#else
color=vec4f(color.rgb+lightmapColor.rgb,color.a);
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color=vec4f(max(color.rgb,vec3f(0.)),color.a);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color=vec4f(toLinearSpaceVec3(color.rgb),color.a);
#else
#ifdef IMAGEPROCESSING
color=vec4f(toLinearSpaceVec3(color.rgb),color.a);color=applyImageProcessing(color);
#endif
#endif
color=vec4f(color.rgb,color.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb*color.a, color.a);
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
var writeGeometryInfo: f32=select(0.0,1.0,color.a>0.4);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]=vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec4(specularMapColor))*writeGeometryInfo; 
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec3(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+color.rgb*color.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-color.a));} else {fragmentOutputs.backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;V.ShadersStoreWGSL[Tb]=xb;const OX={name:Tb,shader:xb},NX=Object.freeze(Object.defineProperty({__proto__:null,defaultPixelShaderWGSL:OX},Symbol.toStringTag,{value:"Module"})),LX="lightVxFragmentDeclaration",FX=`#ifdef LIGHT{X}
uniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;
#ifdef SPECULARTERM
uniform vLightSpecular{X}: vec4f;
#else
var vLightSpecular{X}: vec4f= vec4f(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
uniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;
#endif
#ifdef SPOTLIGHT{X}
uniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;
#elif defined(POINTLIGHT{X})
uniform vLightFalloff{X}: vec4f;
#elif defined(HEMILIGHT{X})
uniform vLightGround{X}: vec3f;
#endif
#endif
`;V.IncludesShadersStoreWGSL[LX]=FX;const Cb="defaultVertexShader",Ab=`#include<defaultUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(positionUpdated,1.0);
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld* vec4f(positionUpdated,0.0)).xyz);
#endif
#ifndef UV1
var uvUpdated: vec2f=vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;V.ShadersStoreWGSL[Cb]=Ab;const wX={name:Cb,shader:Ab},BX=Object.freeze(Object.defineProperty({__proto__:null,defaultVertexShaderWGSL:wX},Symbol.toStringTag,{value:"Module"})),VX=(n,e)=>{const t=fl("worldBox",{size:e*2},n),i=new Ie("worldBox",n);return i.backFaceCulling=!1,i.reflectionTexture=new ir("/ColdEscape/TropicalSunnyDay/TropicalSunnyDay",n),i.reflectionTexture.coordinatesMode=Z.SKYBOX_MODE,i.diffuseColor=new fe(0,0,0),i.specularColor=new fe(0,0,0),t.material=i,t};class pa{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.minEmitBox=new m(-.5,-.5,-.5),this.maxEmitBox=new m(.5,.5,.5)}startDirectionFunction(e,t,i,r){const s=Qe(this.direction1.x,this.direction2.x),a=Qe(this.direction1.y,this.direction2.y),o=Qe(this.direction1.z,this.direction2.z);if(r){t.x=s,t.y=a,t.z=o;return}m.TransformNormalFromFloatsToRef(s,a,o,e,t)}startPositionFunction(e,t,i,r){const s=Qe(this.minEmitBox.x,this.maxEmitBox.x),a=Qe(this.minEmitBox.y,this.maxEmitBox.y),o=Qe(this.minEmitBox.z,this.maxEmitBox.z);if(r){t.x=s,t.y=a,t.z=o;return}m.TransformCoordinatesFromFloatsToRef(s,a,o,e,t)}clone(){const e=new pa;return cr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),m.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),m.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class Lc{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){r?B.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),B.Vector3[0]).normalize();const s=Qe(0,this.directionRandomizer),a=Qe(0,this.directionRandomizer),o=Qe(0,this.directionRandomizer);t.x=B.Vector3[0].x+s,t.y=B.Vector3[0].y+a,t.z=B.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,r){const s=Qe(0,Math.PI*2);let a;this.emitFromSpawnPointOnly?a=1e-4:(a=Qe(0,this.heightRange),a=1-a*a);let o=this._radius-Qe(0,this._radius*this.radiusRange);o=o*a;const l=o*Math.sin(s),c=o*Math.cos(s),u=a*this._height;if(r){t.x=l,t.y=u,t.z=c;return}m.TransformCoordinatesFromFloatsToRef(l,u,c,e,t)}clone(){const e=new Lc(this._radius,this._angle,this.directionRandomizer);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}}class Xh extends Lc{constructor(e=1,t=Math.PI,i=new m(0,1,0),r=new m(0,1,0)){super(e,t),this.direction1=i,this.direction2=r}startDirectionFunction(e,t){const i=Qe(this.direction1.x,this.direction2.x),r=Qe(this.direction1.y,this.direction2.y),s=Qe(this.direction1.z,this.direction2.z);m.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new Xh(this.radius,this.angle,this.direction1,this.direction2);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CONEEMITTER
#define DIRECTEDCONEEMITTER`}getClassName(){return"ConeDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class Fc{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=m.Zero()}startDirectionFunction(e,t,i,r,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),m.TransformNormalToRef(this._tempVector,s,this._tempVector);const a=Qe(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);if(o+=Qe(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=a,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),r){t.copyFrom(this._tempVector);return}m.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){const s=Qe(-this.height/2,this.height/2),a=Qe(0,2*Math.PI),o=Qe((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(o)*this.radius,c=l*Math.cos(a),u=l*Math.sin(a);if(r){t.copyFromFloats(c,s,u);return}m.TransformCoordinatesFromFloatsToRef(c,s,u,e,t)}clone(){const e=new Fc(this.radius,this.directionRandomizer);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Yh extends Fc{constructor(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=s}startDirectionFunction(e,t,i,r){const s=Qe(this.direction1.x,this.direction2.x),a=Qe(this.direction1.y,this.direction2.y),o=Qe(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,a,o);return}m.TransformNormalFromFloatsToRef(s,a,o,e,t)}clone(){const e=new Yh(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}}class $h{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),a=Qe(0,this.directionRandomizer),o=Qe(0,this.directionRandomizer),l=Qe(0,this.directionRandomizer);if(s.x+=a,s.y+=o,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-Qe(0,this.radius*this.radiusRange),a=Qe(0,1),o=Qe(0,2*Math.PI),l=Math.acos(2*a-1),c=s*Math.cos(o)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(o)*Math.sin(l);if(r){t.copyFromFloats(c,Math.abs(u),h);return}m.TransformCoordinatesFromFloatsToRef(c,Math.abs(u),h,e,t)}clone(){const e=new $h(this.radius,this.directionRandomizer);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Kh{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0)}startDirectionFunction(e,t,i,r){const s=Qe(this.direction1.x,this.direction2.x),a=Qe(this.direction1.y,this.direction2.y),o=Qe(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,a,o);return}m.TransformNormalFromFloatsToRef(s,a,o,e,t)}startPositionFunction(e,t,i,r){if(r){t.copyFromFloats(0,0,0);return}m.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new Kh;return cr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}}class wc{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){const s=i.position.subtract(e.getTranslation()).normalize(),a=Qe(0,this.directionRandomizer),o=Qe(0,this.directionRandomizer),l=Qe(0,this.directionRandomizer);if(s.x+=a,s.y+=o,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){const s=this.radius-Qe(0,this.radius*this.radiusRange),a=Qe(0,1),o=Qe(0,2*Math.PI),l=Math.acos(2*a-1),c=s*Math.cos(o)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(o)*Math.sin(l);if(r){t.copyFromFloats(c,u,h);return}m.TransformCoordinatesFromFloatsToRef(c,u,h,e,t)}clone(){const e=new wc(this.radius,this.directionRandomizer);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class jh extends wc{constructor(e=1,t=new m(0,1,0),i=new m(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=Qe(this.direction1.x,this.direction2.x),r=Qe(this.direction1.y,this.direction2.y),s=Qe(this.direction1.z,this.direction2.z);m.TransformNormalFromFloatsToRef(i,r,s,e,t)}clone(){const e=new jh(this.radius,this.direction1,this.direction2);return cr.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class _a{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,r){const s=B.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,s);const a=B.Vector3[1];s.subtractToRef(i.position,a),a.scaleToRef(1/i.lifeTime,s)}else s.set(0,0,0);if(r){t.copyFrom(s);return}m.TransformNormalToRef(s,e,t)}startPositionFunction(e,t,i,r){const s=B.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,s):s.set(0,0,0),r){t.copyFrom(s);return}m.TransformCoordinatesToRef(s,e,t)}clone(){const e=new _a;return cr.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.particlePositionGenerator=this.particlePositionGenerator,e.particleDestinationGenerator=this.particleDestinationGenerator,e}parse(e){e.particlePositionGenerator&&(this.particlePositionGenerator=e.particlePositionGenerator),e.particleDestinationGenerator&&(this.particleDestinationGenerator=e.particleDestinationGenerator)}}class I_{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(b.PositionKind),this._normals=e.getVerticesData(b.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=m.Zero(),this._mesh=null,this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,r){if(this.useMeshNormalsForDirection&&this._normals){m.TransformNormalToRef(this._storedNormal,e,t);return}const s=Qe(this.direction1.x,this.direction2.x),a=Qe(this.direction1.y,this.direction2.y),o=Qe(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,a,o);return}m.TransformNormalFromFloatsToRef(s,a,o,e,t)}startPositionFunction(e,t,i,r){if(!this._indices||!this._positions)return;const s=3*Math.random()*(this._indices.length/3)|0,a=Math.random(),o=Math.random()*(1-a),l=1-a-o,c=this._indices[s],u=this._indices[s+1],h=this._indices[s+2],f=B.Vector3[0],d=B.Vector3[1],p=B.Vector3[2],_=B.Vector3[3];m.FromArrayToRef(this._positions,c*3,f),m.FromArrayToRef(this._positions,u*3,d),m.FromArrayToRef(this._positions,h*3,p),_.x=a*f.x+o*d.x+l*p.x,_.y=a*f.y+o*d.y+l*p.y,_.z=a*f.z+o*d.z+l*p.z,r?t.copyFromFloats(_.x,_.y,_.z):m.TransformCoordinatesFromFloatsToRef(_.x,_.y,_.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(m.FromArrayToRef(this._normals,c*3,f),m.FromArrayToRef(this._normals,u*3,d),m.FromArrayToRef(this._normals,h*3,p),this._storedNormal.x=a*f.x+o*d.x+l*p.x,this._storedNormal.y=a*f.y+o*d.y+l*p.y,this._storedNormal.z=a*f.z+o*d.z+l*p.z)}clone(){const e=new I_(this.mesh);return cr.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var t;const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=(t=this.mesh)==null?void 0:t.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(e,t){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class Ib{_isUbo(e){return e.addUniform!==void 0}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}const UX="gpuUpdateParticlesPixelShader",kX=`#version 300 es
void main() {discard;}
`;V.ShadersStore[UX]=kX;const GX="gpuUpdateParticlesVertexShader",zX=`#version 300 es
#define PI 3.14159
uniform float currentCount;uniform float timeDelta;uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;uniform vec4 color2;
#endif
uniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;uniform float radiusRange;uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;uniform float height;uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;uniform float coneAngle;uniform vec2 height;
#ifdef DIRECTEDCONEEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;in float life;in vec4 seed;in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}
vec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}
void main() {float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); 
vec3 randoms3=getRandomVec3(seed.z);
#ifdef DIRECTEDCONEEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
if (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}
else {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}}`;V.ShadersStore[GX]=zX;class WX{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var e;return((e=this._updateEffect)==null?void 0:e.isReady())??!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof _a&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new ei("gpuUpdateParticles",this._updateEffectOptions,this._engine),new Ib(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof _a&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}}$("BABYLON.WebGL2ParticleSystem",WX);const HX="gpuUpdateParticlesComputeShader",XX=`struct Particle {position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
#ifdef DIRECTEDCONEEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}
@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}
let PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); 
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
#ifdef DIRECTEDCONEEMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
if (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}
else {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}}
`;V.ShadersStoreWGSL[HX]=XX;class YX{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e;return((e=this._updateComputeShader)==null?void 0:e.isReady())??!1}createUpdateBuffer(e){var i;const t={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(t.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(t.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(t.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(t.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(t.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(t.noiseTexture={group:1,binding:11}),this._updateComputeShader=new Gn("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:t,defines:e.split(`
`)}),(i=this._simParamsComputeShader)==null||i.dispose(),this._simParamsComputeShader=new ke(this._engine,void 0,void 0,"ComputeShaderParticleSystemUBO"),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new Ib(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new CV(this._engine,e.length*4,11,"ComputeShaderParticleSystemBuffer");return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[e^1]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let t=0;t<this._bufferComputeShader.length;++t)this._bufferComputeShader[t].dispose();this._bufferComputeShader.length=0,(e=this._simParamsComputeShader)==null||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}$("BABYLON.ComputeShaderParticleSystem",YX);class yb{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}Be.LerpToRef(this.color1,this.color2,Math.random(),e)}}class $X{constructor(e,t){this.gradient=e,this.color=t}}class bb{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class as{static GetCurrentGradient(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(let s=0;s<t.length-1;s++){const a=t[s],o=t[s+1];if(e>=a.gradient&&e<=o.gradient){const l=(e-a.gradient)/(o.gradient-a.gradient);i(a,o,l);return}}const r=t.length-1;i(t[r],t[r],1)}}class fc{constructor(e){this.particleSystem=e,this.position=m.Zero(),this.direction=m.Zero(),this.color=new Be(0,0,0,0),this.colorStep=new Be(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new se(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new Be(0,0,0,0),this._currentColor2=new Be(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=fc._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),t===0?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID+1;let r;this._initialSpriteCellLoop?r=vt(e*t%this.lifeTime/this.lifeTime):r=vt(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+r*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const i=B.Vector3[0];this.direction.normalizeToRef(i),t.setDirection(i,0,Math.PI/2)}}else e.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(e.inheritedVelocityAmount/2,B.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(B.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(e=>{this._inheritParticleInfoToSubEmitter(e)})}_reset(){this.age=0,this.id=fc._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new We(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}fc._Count=0;class $o extends qi{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}get shaderLanguage(){return this._shaderLanguage}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){var t;return((t=this._customWrappers[e])==null?void 0:t.effect)??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new ds(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Q),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,r=null,s=!1,a=.01){super(e),this._emitterInverseWorldMatrix=O.Identity(),this._inheritedVelocityOffset=new m,this.onDisposeObservable=new Q,this.onStoppedObservable=new Q,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new Be(0,0,0,0),this._colorDiff=new Be(0,0,0,0),this._scaledDirection=m.Zero(),this._scaledGravity=m.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this.isLocal=!1,this.isGPU=!1,this._shaderLanguage=0,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=l=>{},this.recycleParticle=l=>{const c=this._particles.pop();c!==l&&c.copyTo(l),this._stockParticles.push(c)},this._createParticle=()=>{let l;return this._stockParticles.length!==0?(l=this._stockParticles.pop(),l._reset()):l=new fc(this),this._prepareParticle(l),l},this._shadersLoaded=!1,this._capacity=t,this._epsilon=a,this._isAnimationSheetEnabled=s,!i||i.getClassName()==="Scene"?(this._scene=i||$e.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=O.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._initShaderSourceAsync(),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new ds(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new pa;let o=null;this.updateFunction=l=>{var h;let c=null;this.noiseTexture&&(c=this.noiseTexture.getSize(),(h=this.noiseTexture.getContent())==null||h.then(f=>{o=f}));const u=l===this._particles;for(let f=0;f<l.length;f++){const d=l[f];let p=this._scaledUpdateSpeed;const _=d.age;if(d.age+=p,d.age>d.lifeTime){const v=d.age-_;p=(d.lifeTime-_)*p/v,d.age=d.lifeTime}const g=d.age/d.lifeTime;this._colorGradients&&this._colorGradients.length>0?as.GetCurrentGradient(g,this._colorGradients,(v,x,A)=>{v!==d._currentColorGradient&&(d._currentColor1.copyFrom(d._currentColor2),x.getColorToRef(d._currentColor2),d._currentColorGradient=v),Be.LerpToRef(d._currentColor1,d._currentColor2,A,d.color)}):(d.colorStep.scaleToRef(p,this._scaledColorStep),d.color.addInPlace(this._scaledColorStep),d.color.a<0&&(d.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&as.GetCurrentGradient(g,this._angularSpeedGradients,(v,x,A)=>{v!==d._currentAngularSpeedGradient&&(d._currentAngularSpeed1=d._currentAngularSpeed2,d._currentAngularSpeed2=x.getFactor(),d._currentAngularSpeedGradient=v),d.angularSpeed=ar(d._currentAngularSpeed1,d._currentAngularSpeed2,A)}),d.angle+=d.angularSpeed*p;let E=p;if(this._velocityGradients&&this._velocityGradients.length>0&&as.GetCurrentGradient(g,this._velocityGradients,(v,x,A)=>{v!==d._currentVelocityGradient&&(d._currentVelocity1=d._currentVelocity2,d._currentVelocity2=x.getFactor(),d._currentVelocityGradient=v),E*=ar(d._currentVelocity1,d._currentVelocity2,A)}),d.direction.scaleToRef(E,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&as.GetCurrentGradient(g,this._limitVelocityGradients,(v,x,A)=>{v!==d._currentLimitVelocityGradient&&(d._currentLimitVelocity1=d._currentLimitVelocity2,d._currentLimitVelocity2=x.getFactor(),d._currentLimitVelocityGradient=v);const T=ar(d._currentLimitVelocity1,d._currentLimitVelocity2,A);d.direction.length()>T&&d.direction.scaleInPlace(this.limitVelocityDamping)}),this._dragGradients&&this._dragGradients.length>0&&as.GetCurrentGradient(g,this._dragGradients,(v,x,A)=>{v!==d._currentDragGradient&&(d._currentDrag1=d._currentDrag2,d._currentDrag2=x.getFactor(),d._currentDragGradient=v);const T=ar(d._currentDrag1,d._currentDrag2,A);this._scaledDirection.scaleInPlace(1-T)}),this.isLocal&&d._localPosition?(d._localPosition.addInPlace(this._scaledDirection),m.TransformCoordinatesToRef(d._localPosition,this._emitterWorldMatrix,d.position)):d.position.addInPlace(this._scaledDirection),o&&c&&d._randomNoiseCoordinates1){const v=this._fetchR(d._randomNoiseCoordinates1.x,d._randomNoiseCoordinates1.y,c.width,c.height,o),x=this._fetchR(d._randomNoiseCoordinates1.z,d._randomNoiseCoordinates2.x,c.width,c.height,o),A=this._fetchR(d._randomNoiseCoordinates2.y,d._randomNoiseCoordinates2.z,c.width,c.height,o),T=B.Vector3[0],C=B.Vector3[1];T.copyFromFloats((2*v-1)*this.noiseStrength.x,(2*x-1)*this.noiseStrength.y,(2*A-1)*this.noiseStrength.z),T.scaleToRef(p,C),d.direction.addInPlace(C)}if(this.gravity.scaleToRef(p,this._scaledGravity),d.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&as.GetCurrentGradient(g,this._sizeGradients,(v,x,A)=>{v!==d._currentSizeGradient&&(d._currentSize1=d._currentSize2,d._currentSize2=x.getFactor(),d._currentSizeGradient=v),d.size=ar(d._currentSize1,d._currentSize2,A)}),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&as.GetCurrentGradient(g,this._colorRemapGradients,(v,x,A)=>{const T=ar(v.factor1,x.factor1,A),C=ar(v.factor2,x.factor2,A);d.remapData.x=T,d.remapData.y=C-T}),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&as.GetCurrentGradient(g,this._alphaRemapGradients,(v,x,A)=>{const T=ar(v.factor1,x.factor1,A),C=ar(v.factor2,x.factor2,A);d.remapData.z=T,d.remapData.w=C-T})),this._isAnimationSheetEnabled&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime){this._emitFromParticle(d),d._attachedSubEmitters&&(d._attachedSubEmitters.forEach(v=>{v.particleSystem.disposeOnStop=!0,v.particleSystem.stop()}),d._attachedSubEmitters=null),this.recycleParticle(d),u&&f--;continue}}}}serialize(e){throw new Error("Method not implemented.")}clone(e,t,i=!1){throw new Error("Method not implemented.")}_addFactorGradient(e,t,i,r){const s=new bb(t,i,r);e.push(s),e.sort((a,o)=>a.gradient<o.gradient?-1:a.gradient>o.gradient?1:0)}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const r of e){if(r.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(this._rawTextureWidth*4),t=Ot.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;as.GetCurrentGradient(r,this._rampGradients,(s,a,o)=>{fe.LerpToRef(s.color,a.color,o,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=255})}this._rampGradientsTexture=ki.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new $X(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const r=new yb(e,t,i);return this._colorGradients.push(r),this._colorGradients.sort((s,a)=>s.gradient<a.gradient?-1:s.gradient>a.gradient?1:0),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)t==null||t.dispose();this._drawWrappers=[]}_fetchR(e,t,i,r,s){e=Math.abs(e)*.5+.5,t=Math.abs(t)*.5+.5;const a=e*i%i|0,o=t*r%r|0,l=(a+o*i)*4;return s[l]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new tr(e,this._vertexData,!0,t);let i=0;const r=this._vertexBuffer.createVertexBuffer(b.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[b.PositionKind]=r,i+=3;const s=this._vertexBuffer.createVertexBuffer(b.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[b.ColorKind]=s,i+=4;const a=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,i+=1;const o=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=o,i+=2,this._isAnimationSheetEnabled){const c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9){const c=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=c,i+=3}if(this._useRampGradients){const c=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=c,i+=4}let l;if(this._useInstancing){const c=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new tr(e,c,!1,2),l=this._spriteBuffer.createVertexBuffer("offset",0,2)}else l=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=l,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]));return}const e=[],t=[];let i=0;for(let r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(e=this.startDelay){var t;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((t=this.emitter)==null?void 0:t.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);const i=this.noiseTexture;if(i&&i.onGeneratedObservable)i.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let r=0;r<this.preWarmCycles;r++)this.animate(!0),i.render()})});else for(let r=0;r<this.preWarmCycles;r++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(e))}_postStop(e){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,r){let s=e*this._vertexBufferSize;if(this._vertexData[s++]=t.position.x+this.worldOffset.x,this._vertexData[s++]=t.position.y+this.worldOffset.y,this._vertexData[s++]=t.position.z+this.worldOffset.z,this._vertexData[s++]=t.color.r,this._vertexData[s++]=t.color.g,this._vertexData[s++]=t.color.b,this._vertexData[s++]=t.color.a,this._vertexData[s++]=t.angle,this._vertexData[s++]=t.scale.x*t.size,this._vertexData[s++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[s++]=t.cellIndex),this._isBillboardBased)(this.billboardMode===8||this.billboardMode===9)&&(this._vertexData[s++]=t.direction.x,this._vertexData[s++]=t.direction.y,this._vertexData[s++]=t.direction.z);else if(t._initialDirection){let a=t._initialDirection;this.isLocal&&(m.TransformNormalToRef(a,this._emitterWorldMatrix,B.Vector3[0]),a=B.Vector3[0]),a.x===0&&a.z===0&&(a.x=.001),this._vertexData[s++]=a.x,this._vertexData[s++]=a.y,this._vertexData[s++]=a.z}else{let a=t.direction;this.isLocal&&(m.TransformNormalToRef(a,this._emitterWorldMatrix,B.Vector3[0]),a=B.Vector3[0]),a.x===0&&a.z===0&&(a.x=.001),this._vertexData[s++]=a.x,this._vertexData[s++]=a.y,this._vertexData[s++]=a.z}this._useRampGradients&&t.remapData&&(this._vertexData[s++]=t.remapData.x,this._vertexData[s++]=t.remapData.y,this._vertexData[s++]=t.remapData.z,this._vertexData[s++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon)),this._vertexData[s++]=i,this._vertexData[s++]=r)}_prepareParticle(e){}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const i=this.emitter;this._emitterWorldMatrix=i.getWorldMatrix()}else{const i=this.emitter;this._emitterWorldMatrix=O.Translation(i.x,i.y,i.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);let t;for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const s=vt(this._actualFrame/this.targetStopDuration);as.GetCurrentGradient(s,this._lifeTimeGradients,(a,o)=>{const l=a,c=o,u=l.getFactor(),h=c.getFactor(),f=(s-l.gradient)/(c.gradient-l.gradient);t.lifeTime=ar(u,h,f)})}else t.lifeTime=Qe(this.minLifeTime,this.maxLifeTime);const r=Qe(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),m.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),r===0?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(r),!this._sizeGradients||this._sizeGradients.length===0?t.size=Qe(this.minSize,this.maxSize):(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1),t.scale.copyFromFloats(Qe(this.minScaleX,this.maxScaleX),Qe(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const s=this._actualFrame/this.targetStopDuration;as.GetCurrentGradient(s,this._startSizeGradients,(a,o,l)=>{a!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=o.getFactor(),this._currentStartSizeGradient=a);const c=ar(this._currentStartSize1,this._currentStartSize2,l);t.scale.scaleInPlace(c)})}if(!this._angularSpeedGradients||this._angularSpeedGradients.length===0?t.angularSpeed=Qe(this.minAngularSpeed,this.maxAngularSpeed):(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1),t.angle=Qe(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),!this._colorGradients||this._colorGradients.length===0){const s=Qe(0,1);Be.LerpToRef(this.color1,this.color2,s,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}else t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new We(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new m(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new m(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const r=[b.PositionKind,b.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){const r=["invView","view","projection","textureMask","translationPivot","eyePosition"];return Zn(r),e&&r.push("particlesInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t,i=!0){if(this._scene&&(xc(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==0&&e.push("#define FOG")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===qi.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case 2:e.push("#define BILLBOARDY");break;case 8:case 9:e.push("#define BILLBOARDSTRETCHED"),this.billboardMode===9&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:e.push("#define BILLBOARDMODE_ALL");break}i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...$o._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==8&&this.billboardMode!==9,this._useRampGradients)),e.push(...$o._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(PT(e,this._imageProcessingConfigurationDefines),MT(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);const r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let s=this._drawWrappers[r];s||(s=this._drawWrappers[r]=[]);let a=s[e];a||(a=new ds(this._engine),a.drawContext&&(a.drawContext.useInstancing=this._useInstancing),s[e]=a);const o=i.join(`
`);if(a.defines!==o){const l=[],c=[],u=[];this.fillUniformsAttributesAndSamplerNames(c,l,u),a.setEffect(this._engine.createEffect("particles",l,c,u,o,void 0,void 0,void 0,void 0,this._shaderLanguage),o)}return a}animate(e=!1){var i;if(!this._started)return;if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((i=this._scene)==null?void 0:i.getAnimationRatio())||1);let t;if(this.manualEmitCount>-1)t=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let r=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const s=this._actualFrame/this.targetStopDuration;as.GetCurrentGradient(s,this._emitRateGradients,(a,o,l)=>{a!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=o.getFactor(),this._currentEmitRateGradient=a),r=ar(this._currentEmitRate1,this._currentEmitRate2,l)})}t=r*this._scaledUpdateSpeed>>0,this._newPartsExcess+=r*this._scaledUpdateSpeed-t}if(this._newPartsExcess>1&&(t+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?t=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(t),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let r=0;for(let s=0;s<this._particles.length;s++){const a=this._particles[s];this._appendParticleVertices(r,a),r+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){var e;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(e=this._spriteBuffer)==null||e._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!$o.ForceGLSL?(this._shaderLanguage=1,await Promise.all([re(()=>Promise.resolve().then(()=>Xb),void 0),re(()=>Promise.resolve().then(()=>o5),void 0)])):await Promise.all([re(()=>Promise.resolve().then(()=>kb),void 0),re(()=>Promise.resolve().then(()=>s5),void 0)]),this._shadersLoaded=!0}isReady(){if(!this._shadersLoaded||!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==qi.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(qi.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(qi.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(e){var o,l,c,u,h,f;const t=this._getWrapper(e),i=t.effect,r=this._engine;r.enableEffect(t);const s=this.defaultViewMatrix??this._scene.getViewMatrix();if(i.setTexture("diffuseSampler",this.particleTexture),i.setMatrix("view",s),i.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const d=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/d.width,this.spriteCellHeight/d.height,this.spriteCellWidth/d.width)}if(i.setVector2("translationPivot",this.translationPivot),i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const d=this._scene.activeCamera;i.setVector3("eyePosition",d.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),i.setTexture("rampSampler",this._rampGradientsTexture));const a=i.defines;switch(this._scene&&(Sn(i,this,this._scene),this.applyFog&&uo(this._scene,void 0,i)),a.indexOf("#define BILLBOARDMODE_ALL")>=0&&(s.invertToRef(B.Matrix[0]),i.setMatrix("invView",B.Matrix[0])),this._vertexArrayObject!==void 0?(o=this._scene)!=null&&o.forceWireframe?r.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,i):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,null,i)),this._engine.bindVertexArrayObject(this._vertexArrayObject,(l=this._scene)!=null&&l.forceWireframe?this._linesIndexBufferUseInstancing:this._indexBuffer)):this._indexBuffer?r.bindBuffers(this._vertexBuffers,(u=this._scene)!=null&&u.forceWireframe?this._linesIndexBuffer:this._indexBuffer,i):r.bindBuffers(this._vertexBuffers,(c=this._scene)!=null&&c.forceWireframe?this._linesIndexBufferUseInstancing:null,i),this.useLogarithmicDepth&&this._scene&&Qn(a,i,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(i),e){case qi.BLENDMODE_ADD:r.setAlphaMode(1);break;case qi.BLENDMODE_ONEONE:r.setAlphaMode(6);break;case qi.BLENDMODE_STANDARD:r.setAlphaMode(2);break;case qi.BLENDMODE_MULTIPLY:r.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(i),this._useInstancing?(h=this._scene)!=null&&h.forceWireframe?r.drawElementsType(6,0,10,this._particles.length):r.drawArraysType(7,0,4,this._particles.length):(f=this._scene)!=null&&f.forceWireframe?r.drawElementsType(1,0,this._particles.length*10):r.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return this.blendMode===qi.BLENDMODE_MULTIPLYADD?t=this._render(qi.BLENDMODE_MULTIPLY)+this._render(qi.BLENDMODE_ADD):t=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}_onDispose(e=!1,t=!1){}dispose(e=!0,t=!1,i=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(t,i),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const r=this._scene.particleSystems.indexOf(this);r>-1&&this._scene.particleSystems.splice(r,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}}$o.ForceGLSL=!1;var Cv;(function(n){n[n.ATTACHED=0]="ATTACHED",n[n.END=1]="END"})(Cv||(Cv={}));class ma{constructor(e){if(this.particleSystem=e,this.type=1,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=Ai("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new m;else if(e instanceof m)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){const i=Ai("BABYLON.Mesh");e=new i("",e.getScene()),e.isVisible=!1}const t=new ma(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,r=!1){throw rt("ParseParticle")}static Parse(e,t,i){const r=e.particleSystem,s=new ma(ma._ParseParticleSystem(r,t,i,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s}dispose(){this.particleSystem.dispose()}}function Rb(n,e){const t=new Kh;return t.direction1=n,t.direction2=e,t}function Pb(n=1,e=1){return new $h(n,e)}function Mb(n=1,e=1){return new wc(n,e)}function Db(n=1,e=new m(0,1,0),t=new m(0,1,0)){return new jh(n,e,t)}function Ob(n=1,e=1,t=1,i=0){return new Fc(n,e,t,i)}function Nb(n=1,e=1,t=1,i=new m(0,1,0),r=new m(0,1,0)){return new Yh(n,e,t,i,r)}function Lb(n=1,e=Math.PI/4){return new Lc(n,e)}function Fb(n=1,e=Math.PI/4,t=new m(0,1,0),i=new m(0,1,0)){return new Xh(n,e,t,i)}class ni extends $o{constructor(){super(...arguments),this._disposeEmitterOnDispose=!1,this._emitFromParticle=e=>{if(!this._subEmitters||this._subEmitters.length===0)return;const t=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[t].forEach(i=>{if(i.type===1){const r=i.clone();e._inheritParticleInfoToSubEmitter(r),r.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(r.particleSystem),r.particleSystem.start()}})}}createPointEmitter(e,t){const i=Rb(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=Pb(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=Mb(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new m(0,1,0),i=new m(0,1,0)){const r=Db(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const s=Ob(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){const a=Nb(e,t,i,r,s);return this.particleEmitterType=a,a}createConeEmitter(e=1,t=Math.PI/4){const i=Lb(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new m(0,1,0),r=new m(0,1,0)){const s=Fb(e,t,i,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,i,r){const s=new pa;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(e=>{e instanceof ni?this._subEmitters.push([new ma(e)]):e instanceof ma?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)})}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach(e=>{e.stop(!0)}),this.activeSubSystems=[])}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_preStart(){this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=[])}_postStop(e){e&&this._stopSubEmitters()}_prepareParticle(e){if(this._subEmitters&&this._subEmitters.length>0){const t=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];e._attachedSubEmitters=[],t.forEach(i=>{if(i.type===0){const r=i.clone();e._attachedSubEmitters.push(r),r.particleSystem.start()}})}}_onDispose(e=!1,t=!1){var i;if(this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),e&&((i=this.particles)==null||i.forEach(r=>{if(r._attachedSubEmitters)for(let s=r._attachedSubEmitters.length-1;s>=0;s-=1)r._attachedSubEmitters[s].dispose()})),t&&this.activeSubSystems)for(let r=this.activeSubSystems.length-1;r>=0;r-=1)this.activeSubSystems[r].dispose();if(this._subEmitters&&this._subEmitters.length){for(let r=0;r<this._subEmitters.length;r++)for(const s of this._subEmitters[r])s.dispose();this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0)}static _Parse(e,t,i,r){let s;i instanceof q?s=null:s=i;const a=Ai("BABYLON.Texture");if(a&&s&&(e.texture?t.particleTexture=a.Parse(e.texture,s,r):e.textureName&&(t.particleTexture=new a(r+e.textureName,s,!1,e.invertY!==void 0?e.invertY:!0),t.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?t.emitter=m.Zero():e.emitterId&&s?t.emitter=s.getLastMeshById(e.emitterId):t.emitter=m.FromArray(e.emitter),t.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(t.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(t.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(t.billboardMode=e.billboardMode),e.useLogarithmicDepth!==void 0&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let l=0;l<e.animations.length;l++){const c=e.animations[l],u=Ai("BABYLON.Animation");u&&t.animations.push(u.Parse(c))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&s&&s.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=e.startDelay|0,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=m.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=m.FromArray(e.noiseStrength)),t.color1=Be.FromArray(e.color1),t.color2=Be.FromArray(e.color2),t.colorDead=Be.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const l of e.colorGradients)t.addColorGradient(l.gradient,Be.FromArray(l.color1),l.color2?Be.FromArray(l.color2):void 0);if(e.rampGradients){for(const l of e.rampGradients)t.addRampGradient(l.gradient,fe.FromArray(l.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const l of e.colorRemapGradients)t.addColorRemapGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.alphaRemapGradients)for(const l of e.alphaRemapGradients)t.addAlphaRemapGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.sizeGradients)for(const l of e.sizeGradients)t.addSizeGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.angularSpeedGradients)for(const l of e.angularSpeedGradients)t.addAngularSpeedGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.velocityGradients)for(const l of e.velocityGradients)t.addVelocityGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.dragGradients)for(const l of e.dragGradients)t.addDragGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.emitRateGradients)for(const l of e.emitRateGradients)t.addEmitRateGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.startSizeGradients)for(const l of e.startSizeGradients)t.addStartSizeGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.lifeTimeGradients)for(const l of e.lifeTimeGradients)t.addLifeTimeGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);if(e.limitVelocityGradients){for(const l of e.limitVelocityGradients)t.addLimitVelocityGradient(l.gradient,l.factor1!==void 0?l.factor1:l.factor,l.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&s){const l=Ai("BABYLON.ProceduralTexture");t.noiseTexture=l.Parse(e.noiseTexture,s,r)}let o;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":o=new wc;break;case"SphereDirectedParticleEmitter":o=new jh;break;case"ConeEmitter":case"ConeParticleEmitter":o=new Lc;break;case"ConeDirectedParticleEmitter":o=new Xh;break;case"CylinderParticleEmitter":o=new Fc;break;case"CylinderDirectedParticleEmitter":o=new Yh;break;case"HemisphericParticleEmitter":o=new $h;break;case"PointParticleEmitter":o=new Kh;break;case"MeshParticleEmitter":o=new I_;break;case"CustomParticleEmitter":o=new _a;break;case"BoxEmitter":case"BoxParticleEmitter":default:o=new pa;break}o.parse(e.particleEmitterType,s)}else o=new pa,o.parse(e,s);t.particleEmitterType=o,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=e.spriteCellLoop??!0,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=e.disposeOnStop??!1,t.manualEmitCount=e.manualEmitCount??-1}static Parse(e,t,i,r=!1,s){const a=e.name;let o=null,l=null,c,u;if(t instanceof q?c=t:(u=t,c=u.getEngine()),e.customShader&&c.createEffectForParticles){l=e.customShader;const f=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join(`
`):"";o=c.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,f)}const h=new ni(a,s||e.capacity,t,o,e.isAnimationSheetEnabled);if(h.customShader=l,h._rootUrl=i,e.id&&(h.id=e.id),e.subEmitters){h.subEmitters=[];for(const f of e.subEmitters){const d=[];for(const p of f)d.push(ma.Parse(p,t,i));h.subEmitters.push(d)}}return ni._Parse(e,h,t,i),e.textureMask&&(h.textureMask=Be.FromArray(e.textureMask)),e.worldOffset&&(h.worldOffset=m.FromArray(e.worldOffset)),e.preventAutoStart&&(h.preventAutoStart=e.preventAutoStart),!r&&!h.preventAutoStart&&h.start(),h}serialize(e=!1){const t={};if(ni._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,t.worldOffset=this.worldOffset.asArray(),this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const r=[];for(const s of i)r.push(s.serialize(e));t.subEmitters.push(r)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const g=t.emitter;e.emitterId=g.id}else{const g=t.emitter;e.emitter=g.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,Ke.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const r=t.getColorGradients();if(r){e.colorGradients=[];for(const g of r){const E={gradient:g.gradient,color1:g.color1.asArray()};g.color2?E.color2=g.color2.asArray():E.color2=g.color1.asArray(),e.colorGradients.push(E)}}const s=t.getRampGradients();if(s){e.rampGradients=[];for(const g of s){const E={gradient:g.gradient,color:g.color.asArray()};e.rampGradients.push(E)}e.useRampGradients=t.useRampGradients}const a=t.getColorRemapGradients();if(a){e.colorRemapGradients=[];for(const g of a){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.colorRemapGradients.push(E)}}const o=t.getAlphaRemapGradients();if(o){e.alphaRemapGradients=[];for(const g of o){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.alphaRemapGradients.push(E)}}const l=t.getSizeGradients();if(l){e.sizeGradients=[];for(const g of l){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.sizeGradients.push(E)}}const c=t.getAngularSpeedGradients();if(c){e.angularSpeedGradients=[];for(const g of c){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.angularSpeedGradients.push(E)}}const u=t.getVelocityGradients();if(u){e.velocityGradients=[];for(const g of u){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.velocityGradients.push(E)}}const h=t.getDragGradients();if(h){e.dragGradients=[];for(const g of h){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.dragGradients.push(E)}}const f=t.getEmitRateGradients();if(f){e.emitRateGradients=[];for(const g of f){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.emitRateGradients.push(E)}}const d=t.getStartSizeGradients();if(d){e.startSizeGradients=[];for(const g of d){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.startSizeGradients.push(E)}}const p=t.getLifeTimeGradients();if(p){e.lifeTimeGradients=[];for(const g of p){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.lifeTimeGradients.push(E)}}const _=t.getLimitVelocityGradients();if(_){e.limitVelocityGradients=[];for(const g of _){const E={gradient:g.gradient,factor1:g.factor1};g.factor2!==void 0?E.factor2=g.factor2:E.factor2=g.factor1,e.limitVelocityGradients.push(E)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}clone(e,t,i=!1){const r={...this._customWrappers};let s=null;const a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){s=this.customShader;const c=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"",u=a.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,c);r[0]?r[0].effect=u:this.setCustomEffect(u,0)}const o=this.serialize(i),l=ni.Parse(o,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=s,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,this.preventAutoStart||l.start(),l}}ni.BILLBOARDMODE_Y=2;ni.BILLBOARDMODE_ALL=7;ni.BILLBOARDMODE_STRETCHED=8;ni.BILLBOARDMODE_STRETCHED_LOCAL=9;ma._ParseParticleSystem=ni.Parse;const KX="clipPlaneFragmentDeclaration2",jX=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;V.IncludesShadersStore[KX]=jX;const qX="gpuRenderParticlesPixelShader",ZX=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#include<fogFragmentDeclaration>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#include<fogFragment>(color,gl_FragColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;V.ShadersStore[qX]=ZX;const QX="clipPlaneVertexDeclaration2",JX=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;out float fClipDistance6;
#endif
`;V.IncludesShadersStore[QX]=JX;const e5="gpuRenderParticlesVertexShader",t5=`precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;attribute float age;attribute float life;attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=min(1.0,age/life);
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x;
#ifdef BILLBOARD
vec4 rotatedCorner;rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}`;V.ShadersStore[e5]=t5;class Do extends qi{static get IsSupported(){if(!$e.LastCreatedEngine)return!1;const e=$e.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){const i=Rb(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=Pb(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=Mb(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new m(0,1,0),i=new m(0,1,0)){const r=Db(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){const s=Ob(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){const a=Nb(e,t,i,r,s);return this.particleEmitterType=a,a}createConeEmitter(e=1,t=Math.PI/4){const i=Lb(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new m(0,1,0),r=new m(0,1,0)){const s=Fb(e,t,i,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,i,r){const s=new pa;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==ni.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(ni.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(ni.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){var t;return((t=this._customWrappers[e])==null?void 0:t.effect)??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new ds(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new Q),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[this._targetIndex^1]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new yb(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){var e;for(const t in this._drawWrappers)(e=this._drawWrappers[t].drawContext)==null||e.reset()}_addFactorGradient(e,t,i){const r=new bb(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort((s,a)=>s.gradient<a.gradient?-1:s.gradient>a.gradient?1:0);const r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,s=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.onDisposeObservable=new Q,this.onStoppedObservable=new Q,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,!i||i.getClassName()==="Scene"?(this._scene=i||$e.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=O.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().supportComputeShaders){if(!Ai("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Ai("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!Ai("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Ai("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new ds(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new ds(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),t=t??{},t.randomTextureSize||delete t.randomTextureSize;const a={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},o=t;isFinite(o)&&(a.capacity=o),this._capacity=a.capacity,this._maxActiveParticleCount=a.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=s,this.particleEmitterType=new pa;const l=Math.min(this._engine.getCaps().maxTextureSize,a.randomTextureSize);let c=[];for(let u=0;u<l;++u)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture=new ki(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,c=[];for(let u=0;u<l;++u)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture2=new ki(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=t.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=t.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=t.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=1,s+=4,this.billboardMode===ni.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof _a&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=t.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof _a&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const r=this.particleEmitterType instanceof _a,s=B.Vector3[0];let a=0;for(let u=0;u<this._capacity;u++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(u,null,s),i.push(s.x),i.push(s.y),i.push(s.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),a+=16,r&&(this.particleEmitterType.particlePositionGenerator(u,null,s),i.push(s.x),i.push(s.y),i.push(s.z),this._platform.alignDataInBuffer&&i.push(0),a+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),a+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),a+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),a+=8),i.push(0),a+=1,this._angularSpeedGradientsTexture||(i.push(0),a+=1),this._isAnimationSheetEnabled&&(i.push(0),a+=1,this.spriteRandomStartCell&&(i.push(0),a+=1)),this._platform.alignDataInBuffer){let h=3-(a+3&3);for(a+=h;h-- >0;)i.push(0)}const o=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),c=this._platform.createParticleBuffer(i);this._buffer0=new tr(t,l,!1,this._attributesStrideSize),this._buffer1=new tr(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new tr(t,o,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e?this._platform.isUpdateBufferReady():(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||(r=new ds(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);const s=i.join(`
`);if(r.defines!==s){const a=[],o=[],l=[];this.fillUniformsAttributesAndSamplerNames(o,a,l),r.setEffect(this._engine.createEffect("gpuRenderParticles",a,o,l,s),s)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){const s=[b.PositionKind,"age","life","size","angle"];return e||s.push(b.ColorKind),t&&s.push("cellIndex"),i||s.push("initialDirection"),r&&s.push("direction"),s.push("offset",b.UVKind),s}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){const r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return Zn(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,i=!0){if(this._scene&&(xc(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==ht.FOGMODE_NONE&&e.push("#define FOG")),t===ni.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case ni.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case ni.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case ni.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...Do._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===ni.BILLBOARDMODE_STRETCHED)),e.push(...Do._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(It.PrepareUniforms(e,this._imageProcessingConfigurationDefines),It.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){var t;this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:((t=this._scene)==null?void 0:t.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){const i=this[t];if(!e||!e.length||i)return;const r=new Float32Array(this._rawTextureWidth);for(let s=0;s<this._rawTextureWidth;s++){const a=s/this._rawTextureWidth;as.GetCurrentGradient(a,e,(o,l,c)=>{r[s]=ar(o.factor1,l.factor1,c)})}this[t]=ki.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(this._rawTextureWidth*4),t=Ot.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const r=i/this._rawTextureWidth;as.GetCurrentGradient(r,this._colorGradients,(s,a,o)=>{Be.LerpToRef(s.color1,a.color1,o,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=t.a*255})}this._colorGradientsTexture=ki.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){var o,l,c,u;const i=this._getWrapper(e),r=i.effect;this._engine.enableEffect(i);const s=((o=this._scene)==null?void 0:o.getViewMatrix())||O.IdentityReadOnly;if(r.setMatrix("view",s),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot),r.setVector3("worldOffset",this.worldOffset),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const h=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/h.width,this.spriteCellHeight/h.height,h.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const h=this._scene.activeCamera;r.setVector3("eyePosition",h.globalPosition)}const a=r.defines;if(this._scene&&(Sn(r,this,this._scene),this.applyFog&&uo(this._scene,void 0,r)),a.indexOf("#define BILLBOARDMODE_ALL")>=0){const h=s.clone();h.invert(),r.setMatrix("invView",h)}switch(this.useLogarithmicDepth&&this._scene&&Qn(a,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),e){case ni.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case ni.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case ni.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case ni.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}return this._platform.bindDrawBuffers(this._targetIndex,r,(l=this._scene)!=null&&l.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),(c=this._scene)!=null&&c.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),(u=this._scene)!=null&&u.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer||!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{const i=this.emitter;e=B.Matrix[0],O.TranslationToRef(i.x,i.y,i.z,e)}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);const t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){if(!this._started||!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let a=0;a<this.preWarmCycles;a++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const a=this._accumulatedCount|0;this._accumulatedCount-=a,this._currentActiveCount+=a}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{const a=this.emitter;i=B.Matrix[0],O.TranslationToRef(a.x,a.y,a.z,i)}const r=this._engine;this.updateInAnimate||this._update(i);let s=0;return!e&&!t&&(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),this.blendMode===ni.BLENDMODE_MULTIPLYADD?s=this._render(ni.BLENDMODE_MULTIPLY,i)+this._render(ni.BLENDMODE_ADD,i):s=this._render(this.blendMode,i),this._engine.setAlphaMode(0)),s}rebuild(){const e=()=>{!this._recreateUpdateEffect()||!this._platform.isUpdateBufferReady()?setTimeout(e,10):(this._initialize(!0),this._rebuildingAfterContextLost=!1)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){const i=this._renderVertexBuffers[t];for(const r in i)i[r].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){const r={...this._customWrappers};let s=null;const a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){s=this.customShader;const c=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"";r[0]=a.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,c,void 0,void 0,void 0,this)}const o=this.serialize(i),l=Do.Parse(o,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=s,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,l}serialize(e=!1){const t={};return ni._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,r=!1,s){const a=e.name;let o,l;t instanceof q?o=t:(l=t,o=l.getEngine());const c=new Do(a,{capacity:s||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(c._rootUrl=i,e.customShader&&o.createEffectForParticles){const u=e.customShader,h=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join(`
`):"",f=o.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,h,void 0,void 0,void 0,c);c.setCustomEffect(f,0),c.customShader=u}return e.id&&(c.id=e.id),e.activeParticleCount&&(c.activeParticleCount=e.activeParticleCount),ni._Parse(e,c,t,i),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),!r&&!c.preventAutoStart&&c.start(),c}}Lp(we.NAME_PARTICLESYSTEM,(n,e,t,i)=>{const r=Sx(we.NAME_PARTICLESYSTEM);if(r&&n.particleSystems!==void 0&&n.particleSystems!==null)for(let s=0,a=n.particleSystems.length;s<a;s++){const o=n.particleSystems[s];t.particleSystems.push(r(o,e,i))}});GL(we.NAME_PARTICLESYSTEM,(n,e,t)=>n.activeParticleCount?Do.Parse(n,e,t):ni.Parse(n,e,t));q.prototype.createEffectForParticles=function(n,e=[],t=[],i="",r,s,a,o,l=0){let c=[],u=[];const h=[];return o?o.fillUniformsAttributesAndSamplerNames(u,c,h):(c=ni._GetAttributeNamesOrOptions(),u=ni._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),o!=null&&o.isAnimationSheetEnabled&&i.indexOf(" ANIMATESHEET")===-1&&(i+=`
#define ANIMATESHEET
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:(o==null?void 0:o.vertexShaderName)??"particles",fragmentElement:n},c,u.concat(e),h.concat(t),i,r,s,a,void 0,l,async()=>{l===0?await re(()=>Promise.resolve().then(()=>kb),void 0):await re(()=>Promise.resolve().then(()=>Xb),void 0)})};k.prototype.getEmittedParticleSystems=function(){const n=[];for(let e=0;e<this.getScene().particleSystems.length;e++){const t=this.getScene().particleSystems[e];t.emitter===this&&n.push(t)}return n};k.prototype.getHierarchyEmittedParticleSystems=function(){const n=[],e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t],r=i.emitter;r.position&&e.indexOf(r)!==-1&&n.push(i)}return n};class i5{constructor(e,t,i,r,s){this.idx=0,this.color=new Be(1,1,1,1),this.position=m.Zero(),this.rotation=m.Zero(),this.uv=new se(0,0),this.velocity=m.Zero(),this.pivot=m.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=m.Zero(),this.idx=e,this._group=t,this.groupId=i,this.idxInGroup=r,this._pcs=s}get size(){return this.size}set size(e){this.size=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e,t){if(!e.hasBoundingInfo)return!1;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(t)return e.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));const i=e.getBoundingInfo().boundingBox,r=i.maximumWorld.x,s=i.minimumWorld.x,a=i.maximumWorld.y,o=i.minimumWorld.y,l=i.maximumWorld.z,c=i.minimumWorld.z,u=this.position.x+this._pcs.mesh.position.x,h=this.position.y+this._pcs.mesh.position.y,f=this.position.z+this._pcs.mesh.position.z;return s<=u&&u<=r&&o<=h&&h<=a&&c<=f&&f<=l}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=B.Quaternion[0];const i=this.rotation;ce.RotationYawPitchRollToRef(i.y,i.x,i.z,t)}t.toRotationMatrix(e)}}class Uf{get groupID(){return this.groupId}set groupID(e){this.groupId=e}constructor(e,t){this.groupId=e,this._positionFunction=t}}var Av;(function(n){n[n.Color=2]="Color",n[n.UV=1]="UV",n[n.Random=0]="Random",n[n.Stated=3]="Stated"})(Av||(Av={}));class Y5{get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}constructor(e,t,i,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=e,this._size=t,this._scene=i||$e.LastCreatedScene,r&&r.updatable!==void 0?this._updatable=r.updatable:this._updatable=!0}buildMeshAsync(e){return Promise.all(this._promises).then(()=>(this._isReady=!0,this._buildMesh(e)))}_buildMesh(e){this.nbParticles===0&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);const t=new de;t.set(this._positions32,b.PositionKind),this._uvs32.length>0&&t.set(this._uvs32,b.UVKind);let i=0;this._colors32.length>0&&(i=1,t.set(this._colors32,b.ColorKind));const r=new k(this.name,this._scene);t.applyToMesh(r,this._updatable),this.mesh=r,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let s=e;return s||(s=new Ie("point cloud material",this._scene),s.emissiveColor=new fe(i,i,i),s.disableLighting=!0,s.pointsCloud=!0,s.pointSize=this._size),r.material=s,new Promise(a=>a(r))}_addParticle(e,t,i,r){const s=new i5(e,t,i,r,this);return this.particles.push(s),s}_randomUnitVector(e){e.position=new m(Math.random(),Math.random(),Math.random()),e.color=new Be(1,1,1,1)}_getColorIndicesForCoord(e,t,i,r){const s=e._groupImageData,a=i*(r*4)+t*4,o=[a,a+1,a+2,a+3],l=o[0],c=o[1],u=o[2],h=o[3],f=s[l],d=s[c],p=s[u],_=s[h];return new Be(f/255,d/255,p/255,_)}_setPointsColorOrUV(e,t,i,r,s,a,o,l){l=l??0,i&&e.updateFacetData();const u=2*e.getBoundingInfo().boundingSphere.radius;let h=e.getVerticesData(b.PositionKind);const f=e.getIndices(),d=e.getVerticesData(b.UVKind+(l?l+1:"")),p=e.getVerticesData(b.ColorKind),_=m.Zero();e.computeWorldMatrix();const g=e.getWorldMatrix();if(!g.isIdentity()){h=h.slice(0);for(let vr=0;vr<h.length/3;vr++)m.TransformCoordinatesFromFloatsToRef(h[3*vr],h[3*vr+1],h[3*vr+2],g,_),h[3*vr]=_.x,h[3*vr+1]=_.y,h[3*vr+2]=_.z}let E=0,v=0,x=0,A=0,T=0,C=0,y=0,P=0,D=0,F=0,W=0,H=0,ue=0;const ae=m.Zero(),le=m.Zero(),oe=m.Zero(),ge=m.Zero(),Ee=m.Zero();let ne=0,j=0,L=0,Y=0,te=0,De=0;const Ve=se.Zero(),ve=se.Zero(),Me=se.Zero(),Re=se.Zero(),Pe=se.Zero();let ft=0,Wt=0,xe=0,z=0,K=0,he=0,Ce=0,ye=0,be=0,Je=0,qe=0,Ge=0;const Le=We.Zero(),mt=We.Zero(),it=We.Zero(),dt=We.Zero(),xt=We.Zero();let bt=0,Ht=0;o=o||0;let Ut,yi,Ct=new We(0,0,0,0),Mi=m.Zero(),di=m.Zero(),Wr=m.Zero(),Ki=0,Di=m.Zero(),Pr=0,In=0;const Ma=new yt(m.Zero(),new m(1,0,0));let po,Da=m.Zero();for(let vr=0;vr<f.length/3;vr++){v=f[3*vr],x=f[3*vr+1],A=f[3*vr+2],T=h[3*v],C=h[3*v+1],y=h[3*v+2],P=h[3*x],D=h[3*x+1],F=h[3*x+2],W=h[3*A],H=h[3*A+1],ue=h[3*A+2],ae.set(T,C,y),le.set(P,D,F),oe.set(W,H,ue),le.subtractToRef(ae,ge),oe.subtractToRef(le,Ee),d&&(ne=d[2*v],j=d[2*v+1],L=d[2*x],Y=d[2*x+1],te=d[2*A],De=d[2*A+1],Ve.set(ne,j),ve.set(L,Y),Me.set(te,De),ve.subtractToRef(Ve,Re),Me.subtractToRef(ve,Pe)),p&&r&&(ft=p[4*v],Wt=p[4*v+1],xe=p[4*v+2],z=p[4*v+3],K=p[4*x],he=p[4*x+1],Ce=p[4*x+2],ye=p[4*x+3],be=p[4*A],Je=p[4*A+1],qe=p[4*A+2],Ge=p[4*A+3],Le.set(ft,Wt,xe,z),mt.set(K,he,Ce,ye),it.set(be,Je,qe,Ge),mt.subtractToRef(Le,dt),it.subtractToRef(mt,xt));let _o,Bc,Sl,Sr,Tl,ur,Ir,Oa;const Vc=new fe(0,0,0),Ys=new fe(0,0,0);let ea,Fr;for(let ns=0;ns<t._groupDensity[vr];ns++)E=this.particles.length,this._addParticle(E,t,this._groupCounter,vr+ns),Fr=this.particles[E],bt=Math.sqrt(Qe(0,1)),Ht=Qe(0,1),Ut=ae.add(ge.scale(bt)).add(Ee.scale(bt*Ht)),i&&(Mi=e.getFacetNormal(vr).normalize().scale(-1),di=ge.clone().normalize(),Wr=m.Cross(Mi,di),Ki=Qe(0,2*Math.PI),Di=di.scale(Math.cos(Ki)).add(Wr.scale(Math.sin(Ki))),Ki=Qe(.1,Math.PI/2),Da=Di.scale(Math.cos(Ki)).add(Mi.scale(Math.sin(Ki))),Ma.origin=Ut.add(Da.scale(1e-5)),Ma.direction=Da,Ma.length=u,po=Ma.intersectsMesh(e),po.hit&&(In=po.pickedPoint.subtract(Ut).length(),Pr=Qe(0,1)*In,Ut.addInPlace(Da.scale(Pr)))),Fr.position=Ut.clone(),this._positions.push(Fr.position.x,Fr.position.y,Fr.position.z),r!==void 0?d&&(yi=Ve.add(Re.scale(bt)).add(Pe.scale(bt*Ht)),r?s&&t._groupImageData!==null?(_o=t._groupImgWidth,Bc=t._groupImgHeight,ea=this._getColorIndicesForCoord(t,Math.round(yi.x*_o),Math.round(yi.y*Bc),_o),Fr.color=ea,this._colors.push(ea.r,ea.g,ea.b,ea.a)):p?(Ct=Le.add(dt.scale(bt)).add(xt.scale(bt*Ht)),Fr.color=new Be(Ct.x,Ct.y,Ct.z,Ct.w),this._colors.push(Ct.x,Ct.y,Ct.z,Ct.w)):(Ct=Le.set(Math.random(),Math.random(),Math.random(),1),Fr.color=new Be(Ct.x,Ct.y,Ct.z,Ct.w),this._colors.push(Ct.x,Ct.y,Ct.z,Ct.w)):(Fr.uv=yi.clone(),this._uvs.push(Fr.uv.x,Fr.uv.y))):(a?(Vc.set(a.r,a.g,a.b),Sl=Qe(-o,o),Sr=Qe(-o,o),Oa=Vc.toHSV(),Tl=Oa.r,ur=Oa.g+Sl,Ir=Oa.b+Sr,ur<0&&(ur=0),ur>1&&(ur=1),Ir<0&&(Ir=0),Ir>1&&(Ir=1),fe.HSVtoRGBToRef(Tl,ur,Ir,Ys),Ct.set(Ys.r,Ys.g,Ys.b,1)):Ct=Le.set(Math.random(),Math.random(),Math.random(),1),Fr.color=new Be(Ct.x,Ct.y,Ct.z,Ct.w),this._colors.push(Ct.x,Ct.y,Ct.z,Ct.w))}}_colorFromTexture(e,t,i){if(e.material===null){w.Warn(e.name+"has no material."),t._groupImageData=null,this._setPointsColorOrUV(e,t,i,!0,!1);return}const s=e.material.getActiveTextures();if(s.length===0){w.Warn(e.name+"has no usable texture."),t._groupImageData=null,this._setPointsColorOrUV(e,t,i,!0,!1);return}const a=e.clone();a.setEnabled(!1),this._promises.push(new Promise(o=>{jt.WhenAllReady(s,()=>{let l=t._textureNb;l<0&&(l=0),l>s.length-1&&(l=s.length-1);const c=()=>{t._groupImgWidth=s[l].getSize().width,t._groupImgHeight=s[l].getSize().height,this._setPointsColorOrUV(a,t,i,!0,!0,void 0,void 0,s[l].coordinatesIndex),a.dispose(),o()};t._groupImageData=null;const u=s[l].readPixels();u?u.then(h=>{t._groupImageData=h,c()}):c()})}))}_calculateDensity(e,t,i){let r,s,a,o,l,c,u,h,f,d,p,_;const g=m.Zero(),E=m.Zero(),v=m.Zero(),x=m.Zero(),A=m.Zero(),T=m.Zero();let C;const y=[];let P=0;const D=i.length/3;for(let H=0;H<D;H++)r=i[3*H],s=i[3*H+1],a=i[3*H+2],o=t[3*r],l=t[3*r+1],c=t[3*r+2],u=t[3*s],h=t[3*s+1],f=t[3*s+2],d=t[3*a],p=t[3*a+1],_=t[3*a+2],g.set(o,l,c),E.set(u,h,f),v.set(d,p,_),E.subtractToRef(g,x),v.subtractToRef(E,A),m.CrossToRef(x,A,T),C=.5*T.length(),P+=C,y[H]=P;const F=new Array(D);let W=e;for(let H=D-1;H>0;H--){const ue=y[H];if(ue===0)F[H]=0;else{const le=(ue-y[H-1])/ue*W,oe=Math.floor(le),ge=le-oe,Ee=+(Math.random()<ge),ne=oe+Ee;F[H]=ne,W-=ne}}return F[0]=W,F}addPoints(e,t=this._randomUnitVector){const i=new Uf(this._groupCounter,t);let r,s=this.nbParticles;for(let a=0;a<e;a++)r=this._addParticle(s,i,this._groupCounter,a),i&&i._positionFunction&&i._positionFunction(r,s,a),this._positions.push(r.position.x,r.position.y,r.position.z),r.color&&this._colors.push(r.color.r,r.color.g,r.color.b,r.color.a),r.uv&&this._uvs.push(r.uv.x,r.uv.y),s++;return this.nbParticles+=e,this._groupCounter++,this._groupCounter}addSurfacePoints(e,t,i,r,s){let a=i||0;(isNaN(a)||a<0||a>3)&&(a=0);const o=e.getVerticesData(b.PositionKind),l=e.getIndices();this._groups.push(this._groupCounter);const c=new Uf(this._groupCounter,null);switch(c._groupDensity=this._calculateDensity(t,o,l),a===2?c._textureNb=r||0:r=r||new Be(1,1,1,1),a){case 2:this._colorFromTexture(e,c,!1);break;case 1:this._setPointsColorOrUV(e,c,!1,!1,!1);break;case 0:this._setPointsColorOrUV(e,c,!1);break;case 3:this._setPointsColorOrUV(e,c,!1,void 0,void 0,r,s);break}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}addVolumePoints(e,t,i,r,s){let a=i||0;(isNaN(a)||a<0||a>3)&&(a=0);const o=e.getVerticesData(b.PositionKind),l=e.getIndices();this._groups.push(this._groupCounter);const c=new Uf(this._groupCounter,null);switch(c._groupDensity=this._calculateDensity(t,o,l),a===2?c._textureNb=r||0:r=r||new Be(1,1,1,1),a){case 2:this._colorFromTexture(e,c,!0);break;case 1:this._setPointsColorOrUV(e,c,!0,!1,!1);break;case 0:this._setPointsColorOrUV(e,c,!0);break;case 3:this._setPointsColorOrUV(e,c,!0,void 0,void 0,r,s);break}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}setParticles(e=0,t=this.nbParticles-1,i=!0){var x,A;if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(e,t,i);const r=B.Matrix[0],s=this.mesh,a=this._colors32,o=this._positions32,l=this._uvs32,c=B.Vector3,u=c[5].copyFromFloats(1,0,0),h=c[6].copyFromFloats(0,1,0),f=c[7].copyFromFloats(0,0,1),d=c[8].setAll(Number.MAX_VALUE),p=c[9].setAll(-Number.MAX_VALUE);O.IdentityToRef(r);let _=0;if((x=this.mesh)!=null&&x.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(e!=0||t!=this.nbParticles-1)){const T=(A=this.mesh)==null?void 0:A.getBoundingInfo();T&&(d.copyFrom(T.minimum),p.copyFrom(T.maximum))}_=0;let g=0,E=0,v=0;for(let T=e;T<=t;T++){const C=this.particles[T];_=C.idx,g=3*_,E=4*_,v=2*_,this.updateParticle(C);const y=C._rotationMatrix,P=C.position,D=C._globalPosition;if(this._computeParticleRotation&&C.getRotationMatrix(r),C.parentId!==null){const Y=this.particles[C.parentId],te=Y._rotationMatrix,De=Y._globalPosition,Ve=P.x*te[1]+P.y*te[4]+P.z*te[7],ve=P.x*te[0]+P.y*te[3]+P.z*te[6],Me=P.x*te[2]+P.y*te[5]+P.z*te[8];if(D.x=De.x+ve,D.y=De.y+Ve,D.z=De.z+Me,this._computeParticleRotation){const Re=r.m;y[0]=Re[0]*te[0]+Re[1]*te[3]+Re[2]*te[6],y[1]=Re[0]*te[1]+Re[1]*te[4]+Re[2]*te[7],y[2]=Re[0]*te[2]+Re[1]*te[5]+Re[2]*te[8],y[3]=Re[4]*te[0]+Re[5]*te[3]+Re[6]*te[6],y[4]=Re[4]*te[1]+Re[5]*te[4]+Re[6]*te[7],y[5]=Re[4]*te[2]+Re[5]*te[5]+Re[6]*te[8],y[6]=Re[8]*te[0]+Re[9]*te[3]+Re[10]*te[6],y[7]=Re[8]*te[1]+Re[9]*te[4]+Re[10]*te[7],y[8]=Re[8]*te[2]+Re[9]*te[5]+Re[10]*te[8]}}else if(D.x=0,D.y=0,D.z=0,this._computeParticleRotation){const Y=r.m;y[0]=Y[0],y[1]=Y[1],y[2]=Y[2],y[3]=Y[4],y[4]=Y[5],y[5]=Y[6],y[6]=Y[8],y[7]=Y[9],y[8]=Y[10]}const W=c[11];C.translateFromPivot?W.setAll(0):W.copyFrom(C.pivot);const H=c[0];H.copyFrom(C.position);const ue=H.x-C.pivot.x,ae=H.y-C.pivot.y,le=H.z-C.pivot.z;let oe=ue*y[0]+ae*y[3]+le*y[6],ge=ue*y[1]+ae*y[4]+le*y[7],Ee=ue*y[2]+ae*y[5]+le*y[8];oe+=W.x,ge+=W.y,Ee+=W.z;const ne=o[g]=D.x+u.x*oe+h.x*ge+f.x*Ee,j=o[g+1]=D.y+u.y*oe+h.y*ge+f.y*Ee,L=o[g+2]=D.z+u.z*oe+h.z*ge+f.z*Ee;if(this._computeBoundingBox&&(d.minimizeInPlaceFromFloats(ne,j,L),p.maximizeInPlaceFromFloats(ne,j,L)),this._computeParticleColor&&C.color){const Y=C.color,te=this._colors32;te[E]=Y.r,te[E+1]=Y.g,te[E+2]=Y.b,te[E+3]=Y.a}if(this._computeParticleTexture&&C.uv){const Y=C.uv,te=this._uvs32;te[v]=Y.x,te[v+1]=Y.y}}return s&&(i&&(this._computeParticleColor&&s.updateVerticesData(b.ColorKind,a,!1,!1),this._computeParticleTexture&&s.updateVerticesData(b.UVKind,l,!1,!1),s.updateVerticesData(b.PositionKind,o,!1,!1)),this._computeBoundingBox&&(s.hasBoundingInfo?s.getBoundingInfo().reConstruct(d,p,s._worldMatrix):s.buildBoundingInfo(d,p,s._worldMatrix))),this.afterUpdateParticles(e,t,i),this}dispose(){var e;(e=this.mesh)==null||e.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null}refreshVisibleSize(){var e;return this._isVisibilityBoxLocked||(e=this.mesh)==null||e.refreshBoundingInfo(),this}setVisibilityBox(e){if(!this.mesh)return;const t=e/2;this.mesh.buildBoundingInfo(new m(-t,-t,-t),new m(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this.mesh&&(this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e)}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(e){this._computeBoundingBox=e}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}const wb="particlesPixelShader",Bb=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;uniform sampler2D rampSampler;
#endif
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#include<logDepthFragment>
#include<fogFragment>(color,baseColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;V.ShadersStore[wb]=Bb;const r5={name:wb,shader:Bb},s5=Object.freeze(Object.defineProperty({__proto__:null,particlesPixelShader:r5},Symbol.toStringTag,{value:"Module"})),Vb="particlesVertexShader",Ub=`attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
vec3 row1=direction;
#else
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStore[Vb]=Ub;const n5={name:Vb,shader:Ub},kb=Object.freeze(Object.defineProperty({__proto__:null,particlesVertexShader:n5},Symbol.toStringTag,{value:"Module"})),Gb="particlesPixelShader",zb=`varying vUV: vec2f;varying vColor: vec4f;uniform textureMask: vec4f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying remapRanges: vec4f;var rampSamplerSampler: sampler;var rampSampler: texture_2d<f32>;
#endif
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var textureColor: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV);var baseColor: vec4f=(textureColor*uniforms.textureMask+( vec4f(1.,1.,1.,1.)-uniforms.textureMask))*input.vColor;
#ifdef RAMPGRADIENT
var alpha: f32=baseColor.a;var remappedColorIndex: f32=clamp((alpha-input.remapRanges.x)/input.remapRanges.y,0.0,1.0);var rampColor: vec4f=textureSample(rampSampler,rampSamplerSampler,vec2f(1.0-remappedColorIndex,0.));baseColor=vec4f(baseColor.rgb*rampColor.rgb,baseColor.a);var finalAlpha: f32=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-input.remapRanges.z)/input.remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
var sourceAlpha: f32=input.vColor.a*textureColor.a;baseColor=vec4f(baseColor.rgb*sourceAlpha+ vec3f(1.0)*(1.0-sourceAlpha),baseColor.a);
#endif
#include<logDepthFragment>
#include<fogFragment>(color,baseColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);
#else
#ifdef IMAGEPROCESSING
baseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);baseColor=applyImageProcessing(baseColor);
#endif
#endif
fragmentOutputs.color=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;V.ShadersStoreWGSL[Gb]=zb;const a5={name:Gb,shader:zb},o5=Object.freeze(Object.defineProperty({__proto__:null,particlesPixelShaderWGSL:a5},Symbol.toStringTag,{value:"Module"})),Wb="particlesVertexShader",Hb=`attribute position: vec3f;attribute color: vec4f;attribute angle: f32;attribute size: vec2f;
#ifdef ANIMATESHEET
attribute cellIndex: f32;
#endif
#ifndef BILLBOARD
attribute direction: vec3f;
#endif
#ifdef BILLBOARDSTRETCHED
attribute direction: vec3f;
#endif
#ifdef RAMPGRADIENT
attribute remapData: vec4f;
#endif
attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform translationPivot: vec2f;
#ifdef ANIMATESHEET
uniform particlesInfos: vec3f; 
#endif
varying vUV: vec2f;varying vColor: vec4f;varying vPositionW: vec3f;
#ifdef RAMPGRADIENT
varying remapRanges: vec4f;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform invView: mat4x4f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform eyePosition: vec3f;
#endif
fn rotate(yaxis: vec3f,rotatedCorner: vec3f)->vec3f {var xaxis: vec3f=normalize(cross( vec3f(0.,1.0,0.),yaxis));var zaxis: vec3f=normalize(cross(yaxis,xaxis));var row0: vec3f= vec3f(xaxis.x,xaxis.y,xaxis.z);var row1: vec3f= vec3f(yaxis.x,yaxis.y,yaxis.z);var row2: vec3f= vec3f(zaxis.x,zaxis.y,zaxis.z);var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
fn rotateAlign(toCamera: vec3f,rotatedCorner: vec3f)->vec3f {var normalizedToCamera: vec3f=normalize(toCamera);var normalizedCrossDirToCamera: vec3f=normalize(cross(normalize(vertexInputs.direction),normalizedToCamera));var row0: vec3f= vec3f(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);var row2: vec3f= vec3f(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
var row1: vec3f=vertexInputs.direction;
#else
var crossProduct: vec3f=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));var row1: vec3f= vec3f(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return input.position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var cornerPos: vec2f;cornerPos=( vec2f(input.offset.x-0.5,input.offset.y -0.5)-uniforms.translationPivot)*input.size;
#ifdef BILLBOARD
var rotatedCorner: vec3f;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=input.position-uniforms.eyePosition;yaxis.y=0.;vertexOutputs.vPositionW=rotate(normalize(yaxis),rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var toCamera: vec3f=input.position-uniforms.eyePosition;vertexOutputs.vPositionW=rotateAlign(toCamera,rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var viewPos: vec3f=(uniforms.view* vec4f(input.position,1.0)).xyz+rotatedCorner;vertexOutputs.vPositionW=(uniforms.invView* vec4f(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
vertexOutputs.remapRanges=input.remapData;
#endif
vertexOutputs.position=uniforms.projection* vec4f(viewPos,1.0);
#else
var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=normalize(vertexInputs.direction);vertexOutputs.vPositionW=rotate(yaxis,rotatedCorner);vertexOutputs.position=uniforms.projection*uniforms.view* vec4f(vertexOutputs.vPositionW,1.0);
#endif
vertexOutputs.vColor=input.color;
#ifdef ANIMATESHEET
var rowOffset: f32=floor(input.cellIndex*uniforms.particlesInfos.z);var columnOffset: f32=input.cellIndex-rowOffset/uniforms.particlesInfos.z;var uvScale: vec2f=uniforms.particlesInfos.xy;var uvOffset: vec2f= vec2f(input.offset.x ,1.0-input.offset.y);vertexOutputs.vUV=(uvOffset+ vec2f(columnOffset,rowOffset))*uvScale;
#else
vertexOutputs.vUV=input.offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
var worldPos: vec4f= vec4f(vertexOutputs.vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;V.ShadersStoreWGSL[Wb]=Hb;const l5={name:Wb,shader:Hb},Xb=Object.freeze(Object.defineProperty({__proto__:null,particlesVertexShaderWGSL:l5},Symbol.toStringTag,{value:"Module"})),c5=({scene:n,size:e=150,snowTexture:t="",snowCount:i=5e3,snowSpeed:r=.01,snowRate:s=700})=>{const a=fl("snowfall",{size:.2},n),o=new ni("snowParticles",i,n),l=new Ie("snowMaterial",n);if(l.alpha=0,a.material=l,t)o.particleTexture=new Z(t,n);else{const u="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFQAAABUCAMAAAArteDzAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAMAUExURQAAAAMDAQYFAQkIAgwKAw8MBBEOBBQRBRYTBhkVBhwXBx4ZCCAbCSMdCSUfCichCykjDCwlDC0mDTAoDjEqDzQsDzUtEDcvETkwEjoyEj00Ez42FEA3FUE4FUM6FkU7F0Y9GEg+GEk/GUtBGkxCG01DHE9FHVBGHVFHHlNIH1RJIFVLIFZMIVdNIlhOI1pPJFtQJVxRJV1SJl5TJ19UKGBVKWJXKWNYKmRZK2VaLGZbLWdcLmhdLmleL2pfMGtgMWxhMm1iM25jNG9kNXBlNXFmNnJnN3NoOHNoOXRpOnVqOnZrO3dsPHhtPXluPnpvP3twQHxxQX1yQn1zQ350RIB2RYF3RoJ4R4N5SIR5SYV6SoZ7S4d8TIh9TYl+TYl/ToqAT4uBUIyCUY2DUo2DU46EVI+FVZCGVpGHV5KIWJOJWZSKWpWLW5aMXJeNXZiOXpiPX5mQYJqRYZuSYpySY52TZJ6UZZ+VZp+WZ6CXaKGYaaKZaqKZa6OabKSbbaScbqWdb6aecKeecaifcqmgc6qhdKqhdauidqyjd6ykeK2lea6meq+me7CnfLGofbGpfrKqgLOrgbOrgrSsg7WthLauhbevhriwh7iwiLmxibmyirqzi7u0jLy0jb21jr62kL63kb+4kr+4k8C5lMG6lcK7lsO8l8S9mMS9mcW+m8W/nMbAncfBnsjBn8nCoMnDocrEosvFo8vFpMzGpc3Hp87IqM/Jqc/JqtDKq9DLrNHMrtLNr9LNsNPOsdTPstXQs9XQtNbRtdfSt9fTuNjUudnUutrVu9rWvNvXvtzYv9zYwN3Zwd7awt/bxN/bxeDcxuDdx+HeyOLfyePfy+TgzOThzeXizuXi0Obj0efk0ujl0+jl1Onm1enn1+ro2Ovp2ezp2u3q3O3r3e7s3u7s3+/t4fDu4vHv4/Hv5PLw5vLx5/Py6PPy6fTz6/X07Pb17fb17vf28Pf38fj48vn48/r59fr69vv79/v7+fz8+v39+/7+/P7+/v///wAAAAAAAFX2SBoAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuNWWFMmUAAAksSURBVFhH7ZhpWFNXGscNZCEJWQghCRAW2QKETQFZBBFRXCgKgqgIjFo3BHdcBm2p4zY6tk7dQGvVugzIdOrouNFSRQvZ9/3mXqBuiAsCBdl9njk3UuuHdhJlPvL/AIHk/PK+//Oec95zx4xqVKMa1R8KM6zhP0cuwLKzs7MHsrO3+7+AAdAei8XhHVAR8HgcFgUPv/lhAkgsjkAkUah0upOTE51KcSQR8NiRYDEYeyzBwZHGcGG7cT08PT24bhyWM51CJODsPxQLoiSQqAyWu5cvLyg0NCw8PCSY5+fNZTtTyR+IBWHiSRSGq6c/Pzw6LnHylJSUKZMT46IjQvy93JhUMmrC8EdtFsYORyAz2F4BoVEJKbPmZM/PXZSXOz97TtrUxJhwnhfHmULEvS8VMIlUJtcvNCZp5tzcpYXrS7aVlm7bvL7o40VZs5LjwgI8WDQisGD44zYJpE5huPmFxU3LzCss2Xnw+OkLVdX/rLp4pvyLXVuLCrKmT4wI4DIphPexAGOHd3Tm8sYnfbRw1dZ95Rcu36qrF4rFwvq6miv/OHGgtGhRenJUoAdKtRkKcgfMwKjkzMUbdpdX3bwnVeuNkNkMGfUaWX1N9cl9m5dlpUwI9mRS8DY7gME6OLnzoqZmL9926Pz1eqXBjLwVbFQLblUe2VGYMy0myMPZEW+jAaihbgGRKfNWfnrs2ztyA4zAZpNBD2QwATxsVN69fOIvRfOnRQdyGSTbDACGkpk+45KzVn5acaVBY0Zgk16rkstkUplcqdGbwHfohNdO7SqalxLp70q1LVSQPN09JGHOsh0VV4V6BIH0arlEJBQAgcmSqXQQghgkN07tXJWVFD7WhYSzAQoCpbB8YmYWbDlyWWhAEKNGIRY2AAkE6E+hWKY2IohJfK1i+9L0+GAulWBDqBgs0cmDPyVn7cFLP+nAaLUMIEGMEqlUIhYBsFCqAjYbBN99uSl3WqQvw5ZQQTmxfSPTl5edrVXDiEkpARyRVKHR6fU6jVIGsAKJElC1dRf3FGYm8F0p1l3F2DvQufyEBRsPX5VCIE7AFEoUWhPS/PP95kZIp5IKGwRi4IBZcaNiW15qpAeDaLUAMFgyc2zE1GU7z9XpELNWBphSjanp4ZNnz188a33UDGmBHQKpBkKM9VX7CjPi/Vhkq/nbESicgNj0tX+/IjMjBoUIANTQ/da2jq7u7q7OtqcPYJQqkuthWHnjWMmC5EA3mrWpwtgT6O78Sdmlp2q1iFkjaWgQq6EHzzq6e/v6+/t6X3U+f2hGLZGoIUR/91zZkhlhnk5EK2sVzD3DK2Lqot2VDUZLoCK58eennT39A0NAg/09vzy/DylFDUK5AYHE/zqwOiPSh2ltVWGwJBefyJlLP/+3DIZ1UkGDWIM8aX81MDj0GmhoaKCno7VRKxUIJFozorp+ZH12jD/b0YqpGByZ5R+TvvLoTRXIXoxGdP95V98gikQ11P/qxUOTHLiqghBt7cmtC+MDORSc3fDw3xeoUg4vPqP4BLDUhKaphB639wxY4kQ1NNDb0QKrwBsKI6KvO7M9PzHYzdqiAmvUNXDi3DVf39EjJgUaEPKks/dtoK9fD/b98rTpTQqI8afzZX9KCnGn/e/yx4CKcg1KyFp3pg6MQaHqxtbO37JH8+961qyVWKCmhoufLU7iu9McbIKuPW0b9IItUOApBXiauearH3UWT0UquKW9983cWzTY29naqAZQ4Knx3jefFCQGu1vbUzFgOwmInbO6/HsNYlYD6xSmh22v+t+ZqJ6Xj83otylNiP7O139elBDkCiZqePjvCyx9ll902vIvrylgGK1Hqa75KZipYerQYF/Xs/t6UFJitRnR1JRvyonjcRytlBQofmfvcakF+78VQ4jBUo/mR21dfWBBASRgdr9sgUH2ApkOhuVXDq2ZG+3LIltbUWDn8wxNXlB27i6oKZUYHY08ftnV2z8wODjQ39vd/qRJj+4oSmBpQ9We5R+N83a2ukzt8FS3oImZJcdvqmCzDh2u0De2vOjs7unt7XnV2dbSbASOCqRglWprT5XmTeNzaQRrhz+6Tn2jZhburxaYLKECqg552PqivaOjve3poyaDUiywBApJLh9akz0pgGN960e3Kc+wyQWlJ2tUMKyXiwBVroWaHjxuaXn8oAnSKVAmcBTR3j5b9vGsCWOZ1ixF8ydQXXkxWcX7q+v1iNlCFcqUWgNkhiGjVoUeg0IZuvGLvju0Lic53N169pb8mV7hM/K3HvuP1NQIDhRAFYgkMoVSpZBLRYApAsxGs+LWV9uXpMXyWKDzGR76xwLzT3PjJWas2Hm6RmFuNOuVEvTYFwpFIqEQPaHFCi3UCKtvX9i7OispzJvuYDV7IAyOxPAan5JT/NcLP6oA1aCWi1EaKnD+y1R60Alp6qoObliYGuXvSrapoUY3FXZgzIzcDQcu1spNCAz6HoVMLAISS+VqHWimIFVd9aEtBWlxwR4MB9uaSbRH8eTHp+VvPHC+RqIHDRlk0GpUKqVKrTWg/ZlBVlv5xZYlsxNDvV2s7fq/Cu2jWWNDE9Lz1+89ffWe0giD/tEMAZnRV0Z1w/Vv/layOCMp3Jdtbdf7TaBBpbF9wibOyi3+7GjlzXoFmvKblhfSKwXfV5fvWleQPinCz5VmvTt5K4w9kcYZGxo3fd7yzfsqKq/dFshUGq1Oo5KJ6m5cOnlg26oFMxPCfV3pJBuTR4XB4Ig0tjd/wpTZeau37j18uvLytVs//FBz48qls0f3lRYXZE6NDfHhoEybA0VtxTlQXTx44xJSM/NWbNix++Dh4xUnjh/5fM8nmwrzs6ZPigzyYoOL1PswLVQCxdnNhx+ZkDp7Xv6yonUbS0o2rSteUTB/zvTECSG+7kyqwwdc+cBtl+7i4csfH5eUmpaRNS9nfk52Rtr0yfFRIX6ebCfH92cCASweXKLZXB8ePyIyOiY2LnZCZHgIz8eDw6SR3+uy944s130SxcmFw/Xy8fMPCPD38/HmclycqKQRXPhRLA7vQKbSnZguLDabzWIy6FQyET8CJCr0EQqO4EAkkciOjo5kEpEAghzpQxQUC7josxkgLNbyWGakyDcCHJT95tfw/0Y1qlGNalTvasyY/wKvHdSvIHaxxwAAAABJRU5ErkJggg==";o.particleTexture=new Z("data:snowTexture",n,!0,!0,Z.BILINEAR_SAMPLINGMODE,null,null,u,!0)}return o.emitter=a,o.minEmitBox=new m(-e,250,e),o.maxEmitBox=new m(e,200,-e),o.color1=new Be(.7,.8,1,1),o.color2=new Be(.2,.5,1,1),o.colorDead=new Be(0,0,.2,0),o.minSize=.5,o.maxSize=1,o.minLifeTime=6,o.maxLifeTime=12,o.emitRate=s,o.blendMode=ni.BLENDMODE_ONEONE,o.direction1=new m(0,-10,-1),o.direction2=new m(0,-20,-5),o.minAngularSpeed=0,o.maxAngularSpeed=Math.PI,o.minEmitPower=1,o.maxEmitPower=3,o.updateSpeed=r,{snowSystem:o,changeSnowEmitterPosition:u=>{a.position.set(u.x,a.position.y,u.z)}}},u5=(n,e,t,i={})=>new Promise(r=>{const{world:s}=i,a=Ww.CreateGroundFromHeightMap("ground","heightMap.png",{width:e,height:e,subdivisions:500,minHeight:-30,maxHeight:200,onReady:()=>{const o=new Z("snow.jpg",n);o.vScale=800,o.uScale=800;const l=new Ie("groundMaterial",n);l.diffuseTexture=o,l.diffuseColor=fe.FromHexString("#FFFFFF"),l.specularColor=fe.FromHexString("#3c3c3c"),a.material=l,new tl(a,va.MESH,{mass:0,restitution:0,friction:.4},n);const c=f5(n,t),u=h5(n,e,s),{snowSystem:h,changeSnowEmitterPosition:f}=c5({scene:n,size:100,snowCount:400,snowSpeed:.02});h.start(),new Nr("Wind","cold_wind.mp3",n,null,{loop:!0,autoplay:!0,volume:.3}),r({ground:a,walls:c,ice:u,changeSnowEmitterPosition:f})}},n)}),h5=(n,e,t)=>{const i=new Z("ice.jpg",n);i.vScale=350,i.uScale=350;const r=new Uh("iceReflectionTexture",e,n,!0);r.mirrorPlane=new Vr(0,-1,0,-2),r.renderList=[t],r.level=.2;const s=new Ie("iceMaterial",n);s.diffuseTexture=i,s.reflectionTexture=r;const a=Jp("ice",{width:e,height:e},n);return a.position.set(0,0,0),a.material=s,new tl(a,va.MESH,{mass:0,restitution:0,friction:.01},n),a},f5=(n,e)=>{const t=new Ie("wallsMaterial",n);t.alpha=0,t.backFaceCulling=!0;const i=fl("walls",{width:e,height:500,depth:e},n);return i.position.set(0,0,0),i.material=t,i},d5=(n,e,t,i)=>{e.onKeyboardObservable.add(r=>{r.type===gn.KEYDOWN&&(n[r.event.key]=!0,t&&t()),r.type===gn.KEYUP&&(n[r.event.key]=!1,r.event.key==="Shift"&&(n.W=!1,n.S=!1,n.D=!1,n.A=!1),r.event.key==="W"&&(n.w=!1),r.event.key==="S"&&(n.s=!1),r.event.key==="D"&&(n.d=!1),r.event.key==="A"&&(n.a=!1),i&&i())})},Yb=.6,p5=async n=>{const e=n.getScene(),{meshes:t}=await wi.ImportMeshAsync("","/ColdEscape/","Dome.glb",e),i=t.find(o=>o.id==="Dome");i.position.set(0,0,230),i.position.y=n.getHeightAtCoordinates(i.position.x,i.position.z)+.1,new tl(i,va.MESH,{mass:0,friction:Yb},e).body.setMassProperties({mass:1,inertia:m.ZeroReadOnly});const s=fl("item1",{width:10,height:10,depth:10},e);return s.position.set(i.position.x,i.position.y+6,i.position.z+20),s.material=new Ie("item1Material",e),new tl(s,va.BOX,{mass:0},e).body.setMassProperties({mass:1,inertia:m.ZeroReadOnly}),i.addChild(s),i},_5=async n=>{const e=n.getScene(),{meshes:t}=await wi.ImportMeshAsync("","/ColdEscape/","ModuleLarge.glb",e),i=t.find(s=>s.id==="ModuleLarge");return i.position.set(250,0,100),i.position.y=n.getHeightAtCoordinates(i.position.x,i.position.z)+43,new tl(i,va.MESH,{mass:0,friction:Yb},e).body.setMassProperties({mass:1,inertia:m.ZeroReadOnly}),i},m5=n=>new Promise(async e=>{const t={};t.Dome=await p5(n),t.ModuleLarge=await _5(n),e({structures:t})});let g5=class extends D1{constructor({canvas:t,engine:i,onPointerDownCallback:r,onRenderingCallback:s,onRenderingLoopCallback:a,onOpenMainMenuCallback:o}){super({canvas:t,engine:i,onPointerDownCallback:r,onRenderingCallback:s,onRenderingLoopCallback:a});Fs(this,"_inputMap",{});Fs(this,"_onOpenMainMenuCallback");Fs(this,"_worldSize",5e3);Fs(this,"_worldAvailable",5e3);M1(),this._onOpenMainMenuCallback=o}async createGame(){this._scene=super.createScene(),this._scene.fogMode=ht.FOGMODE_LINEAR,this._scene.fogStart=0,this._scene.fogEnd=this._worldSize,this._scene.fogColor=fe.FromHexString("#cae2f6"),this._scene.fogDensity=.1,await EV(this._scene);const t=new Ic("light1",new m(0,1,0),this._scene);t.intensity=.8;const i=VX(this._scene,this._worldSize),{ground:r,walls:s,ice:a,changeSnowEmitterPosition:o}=await u5(this._scene,this._worldSize,this._worldAvailable,{world:i}),{structures:l}=await m5(r),{player:c,onPlayerCamera:u,mapPlayerMovements:h,mapPlayerStopMovements:f,onSwitchCameras:d}=await PV(this._scene,r,s,a,l);d5(this._inputMap,this._scene,()=>{d(this._inputMap)},()=>{f(this._scene)}),this._scene.onBeforeRenderObservable.add(async()=>{var p,_;h(this._inputMap),u(),o(c.position),this._inputMap.Tab&&this._onOpenMainMenuCallback&&(this._inputMap.Tab=!1,this._engine.stopRenderLoop(),await((_=(p=Se==null?void 0:Se.audioEngine)==null?void 0:p.audioContext)==null?void 0:_.suspend()),this._onOpenMainMenuCallback())})}async onPointerDown(){await super.onPointerDown()}async doRender(){var t,i;super.doRender(),await((i=(t=Se==null?void 0:Se.audioEngine)==null?void 0:t.audioContext)==null?void 0:i.resume()),this._engine.runRenderLoop(()=>{var r;this._onRenderingLoopCallback&&this._onRenderingLoopCallback(),(r=this._scene)==null||r.render()})}};const E5=n=>{document.addEventListener("pointerlockchange",n,!1)},v5=()=>!!document.pointerLockElement,S5=async(n,e)=>{n||await(e==null?void 0:e.requestPointerLock())},T5={id:"game-container"},x5={id:"game-web-wrapper"},C5=Yd({__name:"Game",setup(n){const e=ta(!0),t=ta(!1),i=ta(!1),r=ta("0"),s=ta(null),a=ta(null),o=ta(null),l=ta(null),c=async()=>{s.value&&await S5(i.value,s.value)},u=()=>{E5(()=>{i.value=v5()})},h=()=>{if(!o.value||!a.value)return;const p=o.value.getFps().toFixed();r.value!==p&&(r.value=p,a.value.innerHTML=`${r.value} fps`)};nS(async()=>{const{canvasElement:p,fpsMeterElement:_,gameEngine:g}=HN("cold-escape","cold-escape-fps-meter");s.value=p,a.value=_,o.value=g});const f=async()=>{l.value=new g5({canvas:s.value,engine:o.value,onPointerDownCallback:c,onRenderingCallback:u,onRenderingLoopCallback:h,onOpenMainMenuCallback:()=>{e.value=!0}}),await l.value.createGame(),d()},d=()=>{e.value=!1,t.value=!0,l.value.doRender()};return(p,_)=>(wo(),Ul("div",T5,[_[3]||(_[3]=Dn("div",null,"Press { TAB } to pause/resume the game",-1)),Dn("div",x5,[Dn("div",{id:"main-menu-background",class:Yl({"hide-main-menu":!e.value})},null,2),Dn("div",{id:"main-menu",class:Yl({"hide-main-menu":!e.value})},[_[0]||(_[0]=Dn("div",null,"Main Menu",-1)),t.value?J_("",!0):(wo(),Ul("div",{key:0,onClick:f,class:"start-continue-game"},"START GAME")),t.value?(wo(),Ul("div",{key:1,onClick:d,class:"start-continue-game"},"CONTINUE GAME")):J_("",!0)],2),_[1]||(_[1]=Dn("canvas",{id:"cold-escape"},null,-1)),_[2]||(_[2]=Dn("div",{id:"cold-escape-fps-meter"},null,-1))])]))}}),$b=(n,e)=>{const t=n.__vccOpts||n;for(const[i,r]of e)t[i]=r;return t},A5=$b(C5,[["__scopeId","data-v-cf6082ea"]]),I5={class:"hello-msg"},y5=Yd({__name:"HelloWorld",props:{msg:{}},setup(n){return(e,t)=>(wo(),Ul("h1",I5,Nv(e.msg),1))}}),b5=$b(y5,[["__scopeId","data-v-a925b7f3"]]),R5=Yd({__name:"App",setup(n){return(e,t)=>(wo(),Ul(tn,null,[zs(b5,{msg:"Vite + Vue + BabylonJS"}),zs(A5)],64))}});hM(R5).mount("#app");export{V as $,lw as A,F5 as B,fe as C,fi as D,sv as E,zy as F,dr as G,W5 as H,G5 as I,bd as J,dn as K,w as L,k as M,B5 as N,y1 as O,Y5 as P,V5 as Q,j1 as R,Ie as S,Z as T,TO as U,se as V,H5 as W,sW as X,Kr as Y,w5 as Z,zn as _,Be as a,ir as a0,O5 as a1,Ke as a2,ce as a3,O as a4,rc as a5,R1 as a6,li as a7,B as a8,oa as a9,$ as aA,We as aB,I as aC,M as aD,tt as aE,bs as aF,mh as aG,Tn as aH,Tt as aI,G as aJ,mr as aK,Nr as aL,L5 as aM,me as aa,M5 as ab,Q as ac,cE as ad,qc as ae,up as af,vn as ag,ya as ah,pe as ai,N5 as aj,$t as ak,ot as al,Un as am,Go as an,ac as ao,ui as ap,Cn as aq,He as ar,re as as,tr as at,at as au,cp as av,bu as aw,Jr as ax,Yr as ay,th as az,m as b,b as c,de as d,J as e,uE as f,bi as g,b1 as h,eo as i,iW as j,rW as k,SO as l,D5 as m,Z1 as n,si as o,uW as p,Yo as q,Dl as r,U5 as s,k5 as t,hW as u,T_ as v,z5 as w,X5 as x,nW as y,xd as z};
